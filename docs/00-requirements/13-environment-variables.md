# 環境変数管理

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 13.1 環境変数の分類

### 13.1.1 アプリケーション設定

| 変数名      | 用途                | 例                               | 環境   |
| ----------- | ------------------- | -------------------------------- | ------ |
| `NODE_ENV`  | 実行環境            | `development`, `production`      | 全環境 |
| `PORT`      | サーバーポート      | `3000`                           | Web    |
| `LOG_LEVEL` | ログレベル          | `debug`, `info`, `warn`, `error` | 全環境 |
| `APP_URL`   | アプリケーションURL | `https://yourapp.com`            | Web    |

### 13.1.2 データベース接続

| 変数名               | 用途              | 形式                        |
| -------------------- | ----------------- | --------------------------- |
| `TURSO_DATABASE_URL` | Turso接続URL      | `libsql://db-name.turso.io` |
| `TURSO_AUTH_TOKEN`   | Turso認証トークン | JWT形式のトークン           |

#### Turso環境変数の取得方法

1. Turso CLIでデータベースを作成
2. `turso db show <database-name>`で接続URLを確認
3. `turso db tokens create <database-name>`で認証トークンを生成

### 13.1.3 外部サービス認証情報

| サービス  | 変数名              | 用途              | 取得場所                   |
| --------- | ------------------- | ----------------- | -------------------------- |
| OpenAI    | `OPENAI_API_KEY`    | GPT-4o API        | OpenAIダッシュボード       |
| Anthropic | `ANTHROPIC_API_KEY` | Claude API        | Anthropicコンソール        |
| Google AI | `GOOGLE_AI_API_KEY` | Gemini API        | Google AI Studioコンソール |
| xAI       | `XAI_API_KEY`       | Grok API          | xAIダッシュボード          |
| Discord   | `DISCORD_TOKEN`     | Discord Bot       | Discord Developer Portal   |
| Discord   | `DISCORD_CLIENT_ID` | Discord Client ID | Discord Developer Portal   |

### 13.1.4 機能フラグ

| 変数名              | 用途               | 値              |
| ------------------- | ------------------ | --------------- |
| `FEATURE_NEW_UI`    | 新UIの有効化       | `true`, `false` |
| `FEATURE_ANALYTICS` | アナリティクス収集 | `true`, `false` |
| `MAINTENANCE_MODE`  | メンテナンスモード | `true`, `false` |

#### 機能フラグのベストプラクティス

- デフォルト値は安全側（機能無効）に設定する
- 命名規則を統一する（`FEATURE_*`）
- 不要になった機能フラグは削除して技術的負債を防ぐ
- 本番で有効化する前にステージングで十分にテストする

---

## 13.2 セキュリティベストプラクティス

### 13.2.1 機密情報の分類

| 分類   | 例                                    | 取り扱い             |
| ------ | ------------------------------------- | -------------------- |
| 高機密 | APIキー、シークレットキー、DB認証情報 | 暗号化必須、ログ禁止 |
| 中機密 | Webhook URL、サービスエンドポイント   | アクセス制限         |
| 非機密 | ログレベル、ポート番号、公開URL       | 特別な制限なし       |

### 13.2.2 管理原則

| 原則     | 説明                                         |
| -------- | -------------------------------------------- |
| 最小権限 | 必要なサービスのみにアクセス権を付与する     |
| 環境分離 | 開発/ステージング/本番で異なる認証情報を使用 |
| 暗号化   | 機密情報はSecrets管理サービスで保護する      |
| 監査     | アクセスログを記録して追跡可能にする         |

### 13.2.3 保存場所

| 環境              | 保存場所                           |
| ----------------- | ---------------------------------- |
| ローカル開発      | `.env.local`（Gitignore必須）      |
| ステージング/本番 | Railway Variables / GitHub Secrets |

#### 禁止事項

- `.env`ファイルをGitにコミットしない
- 認証情報をソースコード内にハードコードしない
- 公開リポジトリで機密情報を共有しない
- ログやエラーメッセージに機密情報を出力しない

### 13.2.4 ローテーション戦略

| 機密度            | ローテーション頻度 | トリガー          |
| ----------------- | ------------------ | ----------------- |
| 高機密（APIキー） | 3ヶ月ごと          | 定期 + 漏洩疑い時 |
| 中機密（Webhook） | 6ヶ月ごと          | 漏洩疑い時のみ    |
| 非機密            | ローテーション不要 | -                 |

#### ローテーション手順

1. サービスプロバイダーで新しいキーを発行する
2. 環境変数を新しい値に更新する（Railway、GitHub Secrets）
3. ステージング環境で動作確認する
4. ヘルスチェックで正常性を確認する
5. 旧認証情報を無効化する（確認後24時間以内）
6. ローテーション履歴を記録する

### 13.2.5 漏洩時の対応

#### 即座に実施（15分以内）

- 漏洩した認証情報を無効化する
- サービスプロバイダーに通知する
- アクセスログで不正使用の有無を確認する

#### 短期対応（1時間以内）

- 新しい認証情報を発行する
- 全環境で環境変数を更新する
- 影響範囲を調査する

#### 中期対応（24時間以内）

- 漏洩原因を分析する
- 再発防止策を実施する
- インシデントレポートを作成する

---

## 13.3 環境別設定

### 13.3.1 開発/ステージング/本番の違い

| 項目          | 開発             | ステージング   | 本番               |
| ------------- | ---------------- | -------------- | ------------------ |
| `NODE_ENV`    | development      | production     | production         |
| `LOG_LEVEL`   | debug            | info           | warn               |
| データベース  | ローカルファイル | 別インスタンス | 本番DB             |
| APIレート制限 | 緩い             | 本番同等       | 厳格               |
| エラー詳細    | 表示             | 表示           | 非表示（ログのみ） |
| キャッシュ    | 無効             | 有効           | 有効               |

### 13.3.2 ローカル開発での.envファイル管理

#### ファイル構成

| ファイル           | 用途         | Git管理    |
| ------------------ | ------------ | ---------- |
| `.env.example`     | テンプレート | Yes        |
| `.env.local`       | 個人設定     | No         |
| `.env.development` | 開発環境共通 | No         |
| `.env.test`        | テスト環境   | 場合による |

#### .env.example の役割

- 新規参加者のオンボーディングを容易にする
- 必須変数を明示する
- 設定例を提供する（実際の値は記載しない）

#### 記載時の注意点

- 実際の値ではなくプレースホルダーを使用する（例：`your-key-here`）
- コメントで取得方法を記載する
- 必須/任意を明記する

### 13.3.3 Railway CLI による環境変数同期

| コマンド                | 説明                                            |
| ----------------------- | ----------------------------------------------- |
| `railway variables`     | Railwayの環境変数一覧を表示                     |
| `railway run <command>` | Railwayの環境変数をロードした状態でコマンド実行 |

#### ローカル開発フロー

1. Railway CLIで環境変数を同期
2. `railway run pnpm dev`でローカルサーバー起動
3. `http://localhost:3000`で動作確認
4. Railwayの環境変数が自動的にロードされる（.envファイル不要）

---

## 13.4 Electron アプリでの環境変数

### 13.4.1 ビルド時 vs ランタイム

| 種類       | 用途                            | 変更タイミング     |
| ---------- | ------------------------------- | ------------------ |
| ビルド時   | アプリ設定、機能フラグ          | ビルド時に固定     |
| ランタイム | ユーザー設定、APIエンドポイント | 実行時に動的変更可 |

#### ビルド時環境変数の注意点

- ビルド後は変更できない
- 環境ごとにビルドが必要
- 機密情報を含めてはならない

#### ランタイム環境変数の設定方法

- ユーザー設定ファイル（設定ディレクトリ内のJSONファイル）
- アプリ内設定画面
- 起動引数

### 13.4.2 機密情報の埋め込み禁止

#### リスク

- ビルド成果物がユーザー端末に保存される
- リバースエンジニアリングで抽出可能
- Asarアーカイブも解凍可能

#### 禁止事項

- APIキーのハードコード
- データベース接続情報の埋め込み
- 暗号化キーの含有

#### 代替アプローチ

**サーバーサイド認証**

- Electronアプリ → バックエンドAPI（認証）→ 外部サービス
- 機密情報はサーバー側のみで管理
- APIキーローテーションが容易

**OAuth/トークンベース認証**

- ユーザーログイン時にトークンを取得
- トークンの有効期限を管理
- リフレッシュトークンを安全に保存

**安全な保存方法**

- OSのキーチェーン/Credential Managerを利用する
- 専用ライブラリ（keytar等）を使用する
- 暗号化オプション付きのストレージを検討する

---

## 13.5 トラブルシューティング

### 13.5.1 環境変数が読み込まれない場合

#### チェックリスト

**ファイル確認**

- [ ] `.env.local`が存在するか
- [ ] ファイル名が正確か（スペースや拡張子の誤りに注意）
- [ ] プロジェクトルートに配置されているか

**構文確認**

- [ ] `KEY=VALUE`形式になっているか（スペースなし）
- [ ] コメント行は`#`で開始しているか
- [ ] 改行コードが正しいか（LF推奨）

**読み込み確認**

- [ ] サーバーを再起動したか
- [ ] Next.jsは自動読み込みするため手動設定は不要

### 13.5.2 よくある原因と解決策

| 症状                   | 原因                  | 解決策                               |
| ---------------------- | --------------------- | ------------------------------------ |
| クライアントで読めない | `NEXT_PUBLIC_*`でない | プレフィックスを追加                 |
| 値が`undefined`        | 変数名のタイポ        | スペルチェック                       |
| 古い値が使われる       | キャッシュ            | サーバー再起動、ビルドキャッシュ削除 |
| Railwayで読めない      | 変数未設定            | ダッシュボードで設定                 |

### 13.5.3 型エラーへの対処

#### 問題

- TypeScriptでは`process.env.*`は`string | undefined`型
- 必須変数でもコンパイラは`undefined`を許容してしまう

#### 解決策

**型定義ファイルの作成**

- プロジェクトに`env.d.ts`ファイルを作成
- `ProcessEnv`インターフェースを拡張して型を定義
- 任意の変数には`?`を付ける

**起動時バリデーション**

- アプリ起動時に必須変数の存在をチェックする
- 不足している場合は明確なエラーメッセージを表示する
- `.env.example`へのリンクを提供する

**Zodスキーマによる検証**

- 環境変数をZodスキーマで定義
- 型と値の両方を検証
- 型安全な設定オブジェクトを生成

---

## 13.6 チーム開発での運用

### 13.6.1 オンボーディング

#### 新規メンバー向けドキュメントに含める内容

1. 環境変数のセットアップ手順
2. `.env.example`のコピー方法
3. 各変数の取得方法（リンク付き）
4. トラブルシューティングガイド

#### セットアップチェックリスト

- [ ] `.env.example`を`.env.local`にコピー
- [ ] 必須変数を設定
- [ ] `pnpm dev`で起動確認
- [ ] ヘルスチェック成功

### 13.6.2 変更管理

#### 環境変数追加時のフロー

1. `.env.example`に新しい変数を追加（コメント付き）
2. このドキュメントを更新（必須/任意、取得方法）
3. PRで変更を周知
4. チームに追加通知（Slack等）
5. ステージング環境で設定
6. 本番環境で設定（承認後）
7. GitHub Secretsを更新（CI/CD用）

#### 削除時の注意点

- 非推奨期間を設ける
- 警告ログで移行を促す
- 段階的に削除する

---

## 13.7 必須環境変数一覧

### Cloud環境（Railway + Turso）

| 変数名               | 説明                | 設定方法          | 必須 |
| -------------------- | ------------------- | ----------------- | ---- |
| `TURSO_DATABASE_URL` | Turso接続URL        | Railway Variables | Yes  |
| `TURSO_AUTH_TOKEN`   | Turso認証トークン   | Railway Secrets   | Yes  |
| `OPENAI_API_KEY`     | OpenAI APIキー      | Railway Secrets   | No   |
| `ANTHROPIC_API_KEY`  | Anthropic APIキー   | Railway Secrets   | No   |
| `GOOGLE_AI_API_KEY`  | Google AI APIキー   | Railway Secrets   | No   |
| `XAI_API_KEY`        | xAI APIキー         | Railway Secrets   | No   |
| `DISCORD_TOKEN`      | Discord Botトークン | Railway Secrets   | No   |
| `DISCORD_CLIENT_ID`  | Discord Client ID   | Railway Variables | No   |
| `AGENT_SECRET_KEY`   | Agent認証キー       | Railway Secrets   | Yes  |

### Local Agent

| 変数名             | 説明                                  | 必須 |
| ------------------ | ------------------------------------- | ---- |
| `API_BASE_URL`     | Railwayデプロイ先のURL                | Yes  |
| `AGENT_SECRET_KEY` | Cloudと同じ値                         | Yes  |
| `WATCH_DIR`        | 監視ディレクトリ（例: `./InputBox`）  | Yes  |
| `OUTPUT_DIR`       | 出力ディレクトリ（例: `./OutputBox`） | Yes  |

---

## 関連ドキュメント

- [デプロイメント](./12-deployment.md)
- [ローカルエージェント仕様](./09-local-agent.md)
- [テクノロジースタック](./03-technology-stack.md)
- [セキュリティガイドライン](./17-security-guidelines.md)
