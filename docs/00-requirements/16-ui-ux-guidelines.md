# UI/UX ガイドライン

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 16.1 デザインシステム概要

### 16.1.1 Design Tokens の3層構造

| 層                   | 説明                                                | 例                                     |
| -------------------- | --------------------------------------------------- | -------------------------------------- |
| **Primitive Tokens** | 生の値を定義する基礎層                              | `gray-900: #111827`, `spacing-4: 16px` |
| **Semantic Tokens**  | 意味を持つトークン。Primitiveを参照して用途を明確化 | `color-text-primary: gray-900`         |
| **Component Tokens** | コンポーネント固有のトークン。Semanticを参照        | `button-primary-bg: color-primary`     |

### 16.1.2 一貫性の原則

- 同じ意味を持つ要素には同じトークンを適用する
- デザイン決定は必ずトークンを通じて行い、ハードコードを避ける
- Tailwind CSSのユーティリティクラスを基盤とし、カスタムクラスは最小限に留める
- Web版とDesktop版で同一のトークンセットを共有する

### 16.1.3 拡張性の確保

- 新しいコンポーネント追加時は既存トークンの再利用を優先する
- 既存トークンで対応できない場合のみ新規トークンを定義する
- トークン命名は予測可能なパターンに従う（用途-状態-バリアント）
- バージョニングを考慮し、非推奨トークンの移行期間を設ける

---

## 16.2 Spatial Design Tokens（Knowledge Studio）

### 16.2.1 概要

Knowledge StudioデスクトップアプリではApple Human Interface GuidelinesのSpatial Design原則を取り入れたトークンを定義する。

### 16.2.2 Glass Panel効果

| トークン         | 値                         | 用途              |
| ---------------- | -------------------------- | ----------------- |
| `--glass-bg`     | rgba(30,30,30,0.7)         | パネル背景        |
| `--glass-border` | rgba(255,255,255,0.1)      | パネルボーダー    |
| `--glass-blur`   | 20px                       | backdrop-filter値 |
| `--glass-shadow` | 0 8px 32px rgba(0,0,0,0.3) | パネルシャドウ    |

### 16.2.3 Dynamic Island

| 要素       | 仕様                                   |
| ---------- | -------------------------------------- |
| 配置       | 画面上部中央                           |
| サイズ     | コンテンツに応じて動的に拡縮           |
| 状態       | idle, loading, success, error, warning |
| アニメ     | 300ms ease-in-out                      |
| 自動非表示 | 成功/エラー時3秒後、警告時5秒後        |

### 16.2.4 App Dock

| 要素       | 仕様                                     |
| ---------- | ---------------------------------------- |
| 配置       | 左端固定                                 |
| 幅         | 64px                                     |
| アイテム   | Dashboard, Editor, Chat, Graph, Settings |
| ホバー効果 | Tooltip表示（300ms delay）               |
| 選択状態   | 背景色変更 + 左ボーダーインジケータ      |

---

## 16.3 カラーシステム

### 16.3.1 テーマ切り替え機能

| 項目         | 仕様                                                         |
| ------------ | ------------------------------------------------------------ |
| テーマモード | light, dark, system の3種類                                  |
| 永続化       | electron-store による設定保存                                |
| システム連動 | `nativeTheme` API を使用してOS設定に自動追従（system選択時） |
| FOUC防止     | `data-theme` 属性による初期テーマ設定                        |

### 16.3.2 ライトモード / ダークモードの色定義

| 用途                   | ライトモード | ダークモード |
| ---------------------- | ------------ | ------------ |
| 背景（プライマリ）     | white        | slate-900    |
| 背景（セカンダリ）     | slate-50     | slate-800    |
| 背景（ターシャリ）     | slate-100    | slate-700    |
| テキスト（プライマリ） | slate-900    | slate-50     |
| テキスト（セカンダリ） | slate-600    | slate-400    |
| テキスト（ミュート）   | slate-400    | slate-500    |
| ボーダー               | slate-200    | slate-700    |
| ボーダー（強調）       | slate-300    | slate-600    |

### 16.3.3 セマンティックカラー

| 種別        | ベース色              | 用途                                 |
| ----------- | --------------------- | ------------------------------------ |
| **Primary** | blue-600 / blue-500   | 主要アクション、リンク、アクティブ   |
| **Success** | green-600 / green-500 | 成功状態、完了、肯定的フィードバック |
| **Warning** | amber-500 / amber-400 | 警告、注意喚起、保留状態             |
| **Error**   | red-600 / red-500     | エラー、危険、破壊的アクション       |
| **Info**    | sky-500 / sky-400     | 情報提供、ヒント、補足説明           |

### 16.3.4 アクセシビリティ対応（コントラスト比）

| 要件                       | 最低コントラスト比 | 対象                           |
| -------------------------- | ------------------ | ------------------------------ |
| 通常テキスト（14px未満）   | 4.5:1 以上         | 本文、ラベル、説明文           |
| 大きいテキスト（18px以上） | 3:1 以上           | 見出し、ボタンテキスト         |
| UIコンポーネント           | 3:1 以上           | アイコン、ボーダー、フォーカス |

**確認事項**

- ダークモードでも同等のコントラスト比を維持する
- 色覚多様性への配慮として、色だけでなく形状やテキストでも情報を伝達する
- コントラストチェッカーツールで定期的に検証する

---

## 16.4 タイポグラフィ

### 16.4.1 フォントファミリー（日本語対応）

| 用途                 | フォントスタック                                           |
| -------------------- | ---------------------------------------------------------- |
| UI全般（sans-serif） | Inter, Noto Sans JP, Hiragino Sans, sans-serif             |
| コード（monospace）  | JetBrains Mono, Source Code Pro, Noto Sans Mono, monospace |

**考慮事項**

- 日本語フォントは可変フォント対応のものを優先する
- system-uiフォールバックでOSネイティブフォントも活用する
- ウェブフォントの読み込みは`font-display: swap`を使用する

### 16.4.2 フォントサイズスケール

| トークン名 | サイズ          | 用途                 |
| ---------- | --------------- | -------------------- |
| text-xs    | 12px / 0.75rem  | キャプション、バッジ |
| text-sm    | 14px / 0.875rem | 補助テキスト、ラベル |
| text-base  | 16px / 1rem     | 本文、デフォルト     |
| text-lg    | 18px / 1.125rem | 小見出し、強調       |
| text-xl    | 20px / 1.25rem  | セクション見出し     |
| text-2xl   | 24px / 1.5rem   | ページ見出し         |
| text-3xl   | 30px / 1.875rem | 大見出し             |
| text-4xl   | 36px / 2.25rem  | ヒーロー、タイトル   |

### 16.4.3 行間・文字間隔

| 要素               | 行間（line-height）     | 文字間隔（letter-spacing） |
| ------------------ | ----------------------- | -------------------------- |
| 本文（日本語含む） | 1.75（leading-relaxed） | 0.025em                    |
| 見出し             | 1.25-1.4                | -0.025em                   |
| UI要素（ボタン等） | 1.25                    | 0.025em                    |
| コード             | 1.5                     | 0                          |

---

## 16.5 スペーシングとレイアウト

### 16.5.1 8pxグリッドシステム

- 全てのスペーシングは8pxの倍数を基本とする
- 微調整が必要な場合のみ4pxを許可する
- 1px, 2pxはボーダーやアウトライン専用とする

| トークン    | 値   | 主な用途                       |
| ----------- | ---- | ------------------------------ |
| spacing-0.5 | 2px  | ボーダー内側の微細な隙間       |
| spacing-1   | 4px  | アイコンとテキストの間隔       |
| spacing-2   | 8px  | コンパクトな内部パディング     |
| spacing-3   | 12px | 小要素間のギャップ             |
| spacing-4   | 16px | 標準パディング、要素間隔       |
| spacing-6   | 24px | セクション内のグループ間隔     |
| spacing-8   | 32px | カード・パネルの内部パディング |
| spacing-12  | 48px | セクション間のマージン         |
| spacing-16  | 64px | ページセクション間の大きな間隔 |

### 16.5.2 マージン・パディングの規則

| コンテキスト               | 推奨値                                           |
| -------------------------- | ------------------------------------------------ |
| ボタン内部パディング（横） | spacing-4〜spacing-6                             |
| ボタン内部パディング（縦） | spacing-2〜spacing-3                             |
| 入力フィールド内部         | spacing-3（縦）、spacing-4（横）                 |
| カード内部パディング       | spacing-6〜spacing-8                             |
| リスト項目間のギャップ     | spacing-2〜spacing-4                             |
| フォーム項目間のギャップ   | spacing-6                                        |
| ページのサイドパディング   | spacing-4（モバイル）〜spacing-8（デスクトップ） |

### 16.5.3 レスポンシブブレイクポイント

| ブレイクポイント | 値     | 対象デバイス                           |
| ---------------- | ------ | -------------------------------------- |
| sm               | 640px  | 大型スマートフォン（横向き）           |
| md               | 768px  | タブレット（縦向き）                   |
| lg               | 1024px | タブレット（横向き）、小型ラップトップ |
| xl               | 1280px | デスクトップ                           |
| 2xl              | 1536px | 大型デスクトップ                       |

**Electron固有の考慮事項**

- 最小ウィンドウサイズは800x600pxを推奨する
- サイドバーの表示/非表示はlg（1024px）を基準とする
- ウィンドウサイズ変更時のレイアウト崩れを防ぐ

---

## 16.6 コンポーネント設計原則

### 16.6.1 Atomic Design の適用

| 階層          | 説明                              | 配置場所                           |
| ------------- | --------------------------------- | ---------------------------------- |
| **Atoms**     | 最小単位の要素                    | `packages/shared/ui/atoms/`        |
| **Molecules** | Atomsを組み合わせた機能単位       | `packages/shared/ui/molecules/`    |
| **Organisms** | Moleculesを組み合わせたセクション | `packages/shared/ui/organisms/`    |
| **Templates** | ページのレイアウト構造            | 各アプリ内 `components/templates/` |
| **Pages**     | 具体的なコンテンツを持つ画面      | 各アプリの `app/` または `pages/`  |

**分類例**

| 分類      | コンポーネント例                           |
| --------- | ------------------------------------------ |
| Atoms     | Button, Input, Label, Icon, Badge, Spinner |
| Molecules | FormField, SearchBar, Dropdown, Tooltip    |
| Organisms | Header, Sidebar, DataTable, Modal, Card    |

### 16.6.2 コンポーネントの命名規則

| ルール                             | 例                                             |
| ---------------------------------- | ---------------------------------------------- |
| PascalCaseを使用する               | `Button`, `FormField`, `DataTable`             |
| 具体的で説明的な名前にする         | `UserAvatarCard`（○）、`Card1`（×）            |
| プレフィックスで用途を明示する     | `IconButton`, `PrimaryButton`, `FormInput`     |
| バリアントはPropsで管理する        | `variant="primary"`（○）、`PrimaryButton`（△） |
| ファイル名はコンポーネント名と一致 | `Button.tsx` exports `Button`                  |

### 16.6.3 Props設計のベストプラクティス

| 原則                                 | 説明                                  |
| ------------------------------------ | ------------------------------------- |
| 必須Propsは最小限に                  | 多くのPropsにデフォルト値を設ける     |
| Boolean Propsは肯定形で              | `isDisabled`（○）、`notEnabled`（×）  |
| イベントハンドラは`on`プレフィックス | `onClick`, `onChange`, `onSubmit`     |
| children Propsを活用する             | Compositionパターンで柔軟性を確保     |
| スプレッド演算子で拡張性を確保       | `...rest`でHTML属性を透過的に渡す     |
| Discriminated Unionsで型安全に       | バリアントごとに異なるPropsを型で表現 |

---

## 16.7 Apple HIG 準拠（Electron向け）

### 16.7.1 macOSネイティブな見た目と操作感

| 要素                 | 準拠事項                                         |
| -------------------- | ------------------------------------------------ |
| ウィンドウ外観       | 角丸（10px相当）、シャドウ、半透明背景のサポート |
| アニメーション       | 滑らかな300ms前後のイージング（ease-out）        |
| 視覚フィードバック   | ホバー、プレス状態の明確な変化                   |
| スクロール           | 慣性スクロール、スムーズなバウンス効果           |
| コンテキストメニュー | 右クリック・Ctrl+クリックで表示                  |

### 16.7.2 タイトルバー・トラフィックライト

| 項目                   | 推奨設定                                          |
| ---------------------- | ------------------------------------------------- |
| タイトルバースタイル   | `hidden`または`hiddenInset`でカスタムタイトルバー |
| トラフィックライト位置 | 左上（デフォルト）、または`titleBarOverlay`で調整 |
| ドラッグ可能領域       | `-webkit-app-region: drag`をヘッダー領域に適用    |
| ボタン非活性化         | ドラッグ領域内のボタンには`no-drag`を設定         |
| フルスクリーン対応     | トラフィックライトの表示切替に対応する            |

### 16.7.3 キーボードショートカット

| 操作       | macOS       | Windows/Linux |
| ---------- | ----------- | ------------- |
| 新規作成   | Cmd+N       | Ctrl+N        |
| 保存       | Cmd+S       | Ctrl+S        |
| 設定を開く | Cmd+,       | Ctrl+,        |
| 検索       | Cmd+F       | Ctrl+F        |
| 全選択     | Cmd+A       | Ctrl+A        |
| 取り消し   | Cmd+Z       | Ctrl+Z        |
| やり直し   | Cmd+Shift+Z | Ctrl+Y        |
| 閉じる     | Cmd+W       | Ctrl+W        |
| 終了       | Cmd+Q       | Alt+F4        |

**考慮事項**

- ショートカットはメニューバーのラベルに表示する
- カスタムショートカットはOS標準と競合しないようにする
- アクセシビリティのため、全機能はキーボードでアクセス可能にする

### 16.7.4 メニューバー設計

| メニュー         | 含めるべき項目                                       |
| ---------------- | ---------------------------------------------------- |
| アプリ名メニュー | About、環境設定、サービス、非表示、終了              |
| File             | 新規、開く、保存、閉じる                             |
| Edit             | 取り消し、やり直し、カット、コピー、ペースト、全選択 |
| View             | 表示切替、ズーム、サイドバー、フルスクリーン         |
| Window           | 最小化、ズーム、ウィンドウ切替                       |
| Help             | ヘルプを検索、ドキュメント、サポート                 |

---

## 16.8 インタラクション設計

### 16.8.1 ローディング状態の表示

| パターン             | 使用場面                         | 実装方針                         |
| -------------------- | -------------------------------- | -------------------------------- |
| インラインスピナー   | ボタン内、入力フィールド横       | 元の要素サイズを維持             |
| スケルトンスクリーン | リスト、カード、コンテンツ領域   | 実際のコンテンツと同じ形状で表示 |
| プログレスバー       | ファイルアップロード、長時間処理 | 進捗率を数値でも表示する         |
| オーバーレイ         | ページ全体、モーダル内           | 使用は最小限に                   |

**ベストプラクティス**

- 200ms以上かかる処理にのみローディング表示を行う
- 処理完了後は即座にローディングを非表示にする
- 可能であれば残り時間や進捗を表示する
- キャンセル可能な処理にはキャンセルボタンを提供する

### 16.8.2 エラー状態の表示

| 種類               | 表示方法                       | 例                                     |
| ------------------ | ------------------------------ | -------------------------------------- |
| フィールドエラー   | 入力フィールド直下に赤字で表示 | メールアドレスの形式が正しくありません |
| フォームエラー     | フォーム上部にまとめて表示     | エラー件数とリンク付きリスト           |
| トースト通知       | 画面端に一時的に表示           | API通信エラー、保存失敗                |
| インラインアラート | コンテンツ内に埋め込み         | 権限不足、機能制限の説明               |
| フルページエラー   | 画面全体をエラー表示に         | 404、500、ネットワークエラー           |

**メッセージの書き方**

- 何が起きたかを明確に伝える
- ユーザーが次に何をすべきかを示す
- 技術的な詳細は避け、平易な言葉を使う

### 16.8.3 Error Boundaryパターン

React Error Boundaryを使用して、コンポーネントツリー内のエラーをキャッチし、ユーザーフレンドリーなフォールバックUIを表示する。

| コンポーネント      | 配置場所                   | 用途                     |
| ------------------- | -------------------------- | ------------------------ |
| `AuthErrorBoundary` | 認証コンポーネントをラップ | 認証関連エラーのキャッチ |

**Error Boundaryの実装原則**

| 原則             | 説明                                                       |
| ---------------- | ---------------------------------------------------------- |
| 適切な粒度       | 機能単位でError Boundaryを配置（認証、チャット、グラフ等） |
| フォールバックUI | エラー内容を日本語で表示し、再試行ボタンを提供             |
| エラーログ       | `componentDidCatch`でエラー情報をログ出力                  |
| アクセシビリティ | `role="alert"`, `aria-live="assertive"`を適用              |

**フォールバックUIの構成**

| 要素             | 仕様                               |
| ---------------- | ---------------------------------- |
| アイコン         | `alert-triangle`（赤色、48px）     |
| タイトル         | 「エラーが発生しました」           |
| 説明文           | エラーの概要と次のアクションを案内 |
| アクションボタン | 「再試行」ボタンで状態をリセット   |
| スタイル         | GlassPanelでモーダル風に中央配置   |

### 16.8.4 アニメーション・トランジション

| 種類             | 継続時間  | イージング  | 用途                         |
| ---------------- | --------- | ----------- | ---------------------------- |
| 瞬時（Instant）  | 0-100ms   | -           | ホバー、ボタンプレス         |
| 高速（Fast）     | 100-200ms | ease-out    | ツールチップ、ドロップダウン |
| 標準（Normal）   | 200-300ms | ease-in-out | モーダル、パネル、ページ遷移 |
| 強調（Emphasis） | 300-500ms | ease-out    | オンボーディング、重要な変更 |

**原則**

- アニメーションは目的を持って使用する
- ユーザーの操作を妨げない速度にする
- `prefers-reduced-motion`で簡略化オプションを提供する
- CPUリソースへの影響を考慮し、`transform`と`opacity`を優先する

### 16.8.5 フィードバック原則

| 操作            | フィードバック         | タイミング               |
| --------------- | ---------------------- | ------------------------ |
| クリック/タップ | 視覚的な押下状態       | 即時                     |
| ホバー          | 色の変化、カーソル変更 | 即時                     |
| フォーカス      | フォーカスリング表示   | 即時                     |
| 入力            | バリデーション結果     | blur時またはリアルタイム |
| 送信            | 成功/失敗の通知        | 処理完了後               |
| ドラッグ        | ドラッグ中の視覚表現   | ドラッグ開始時           |

---

## 16.9 アクセシビリティ（WCAG 2.1 AA準拠）

### 16.9.1 キーボードナビゲーション

| 要件                             | 実装方針                                 |
| -------------------------------- | ---------------------------------------- |
| 全機能にキーボードでアクセス可能 | マウス専用の操作を作らない               |
| 論理的なタブ順序                 | DOMの順序を視覚的な順序と一致させる      |
| フォーカストラップ               | モーダル内でフォーカスを閉じ込める       |
| ショートカット                   | 主要操作に割り当て、ヘルプで一覧表示     |
| スキップリンク                   | メインコンテンツへのスキップリンクを提供 |

| キー      | 期待される動作                           |
| --------- | ---------------------------------------- |
| Tab       | 次のインタラクティブ要素へ移動           |
| Shift+Tab | 前のインタラクティブ要素へ移動           |
| Enter     | ボタンの実行、リンクの遷移               |
| Space     | チェックボックスのトグル、ボタン実行     |
| Escape    | モーダルを閉じる、ドロップダウンを閉じる |
| 矢印キー  | リスト内の移動、ラジオボタンの選択       |

### 16.9.2 スクリーンリーダー対応

| 要件                 | 実装方針                                         |
| -------------------- | ------------------------------------------------ |
| 適切なHTML要素を使用 | `<button>`, `<a>`, `<nav>`, `<main>`, `<header>` |
| 見出しの階層構造     | `<h1>`から順番に使用、レベルをスキップしない     |
| 代替テキスト         | 画像には`alt`属性、装飾画像は`alt=""`            |
| ライブリージョン     | 動的コンテンツには`aria-live`を使用              |
| フォームラベル       | 全入力フィールドに`<label>`を関連付け            |

### 16.9.3 フォーカス管理

| シナリオ         | フォーカス移動先                       |
| ---------------- | -------------------------------------- |
| モーダルを開く   | モーダル内の最初のインタラクティブ要素 |
| モーダルを閉じる | モーダルを開いたトリガー要素           |
| ページ遷移       | ページのメインコンテンツ領域           |
| エラー発生       | 最初のエラーフィールド                 |
| 要素の削除       | 削除された要素の前後の要素             |

**フォーカスインジケータ**

- 2px以上の太さで視認性を確保
- 背景とのコントラスト比3:1以上
- `outline-offset`で要素から離して表示
- `:focus-visible`で意図的なフォーカスのみ表示

### 16.9.4 色だけに頼らない情報伝達

| 情報           | 追加の伝達方法                          |
| -------------- | --------------------------------------- |
| エラー状態     | アイコン（警告マーク）+ テキストラベル  |
| 成功/失敗      | アイコン + 明確なメッセージ             |
| 必須フィールド | アスタリスク + テキスト「（必須）」     |
| リンク         | 下線 + ホバー時の色変化                 |
| 選択状態       | 背景色 + チェックマークアイコン         |
| ステータス     | 色 + テキストラベル（例：進行中、完了） |

---

## 16.10 フォーム設計

### 16.10.1 入力フィールドの設計

| 要素             | 推奨設定                                           |
| ---------------- | -------------------------------------------------- |
| 高さ             | 40px（標準）、36px（コンパクト）、44px（タッチ）   |
| パディング       | 縦12px、横16px                                     |
| 角丸             | 6-8px                                              |
| ボーダー         | 1px solid、hover/focusで色変化                     |
| プレースホルダー | 入力例を示す（ラベルの代用にはしない）             |
| 状態表示         | デフォルト、hover、focus、disabled、error、success |

**入力タイプ別の考慮事項**

| 入力タイプ | 考慮事項                                   |
| ---------- | ------------------------------------------ |
| テキスト   | 適切な`autocomplete`属性の設定             |
| メール     | `type="email"`で適切なキーボード表示       |
| 電話番号   | `type="tel"`、国際形式への対応             |
| パスワード | 表示/非表示トグル、強度インジケータ        |
| 数値       | `type="number"`または`inputmode="numeric"` |
| 日付       | ネイティブピッカーまたはカスタムピッカー   |
| 検索       | `type="search"`、クリアボタン              |

### 16.10.2 バリデーションメッセージ

| 原則             | 説明                                                 |
| ---------------- | ---------------------------------------------------- |
| タイミング       | blur時（フィールド離脱時）を基本                     |
| リアルタイム検証 | パスワード強度など即時フィードバックが有効な場合のみ |
| メッセージ配置   | フィールド直下、左揃え                               |
| 色               | エラーは赤系、成功は緑系                             |
| アイコン         | メッセージ冒頭にアイコンを付加                       |

**メッセージの書き方**

| 避けるべき例   | 推奨例                                 |
| -------------- | -------------------------------------- |
| 無効な入力です | メールアドレスの形式で入力してください |
| エラー         | 8文字以上で入力してください            |
| 必須           | この項目は入力必須です                 |

### 16.10.3 エラー表示パターン

| パターン         | 使用場面                                       |
| ---------------- | ---------------------------------------------- |
| インラインエラー | 各フィールドの直下に個別表示                   |
| サマリーエラー   | フォーム送信後にエラー一覧をフォーム上部に表示 |
| トースト         | サーバーエラーなど全体的な問題                 |

**エラー表示のタイミング**

| タイミング | 用途                                           |
| ---------- | ---------------------------------------------- |
| blur時     | 基本的なフィールド検証                         |
| submit時   | 最終確認、サーバーサイド検証                   |
| 入力中     | 文字数制限、フォーマット案内（過度に使わない） |

---

## 16.11 認証UI設計

### 16.11.1 認証ボタン表示

OAuth認証ボタンは「ログイン」ではなく「続ける」を使用し、新規登録とログインの区別をユーザーに意識させない。

| 要素   | 推奨表示                                       | 非推奨表示               |
| ------ | ---------------------------------------------- | ------------------------ |
| ボタン | 「〇〇で続ける」                               | 「〇〇でログイン」       |
| 見出し | 「アカウント登録・ログイン」                   | 「ログイン」             |
| 説明文 | 「アカウントを連携してデータを同期しましょう」 | 「ログインしてください」 |

**ボタン例**:

- 「Googleで続ける」
- 「GitHubで続ける」
- 「Discordで続ける」

### 16.11.2 認証完了フィードバック

認証完了後、新規登録かログインかを判定してメッセージを表示する。

| 状態     | 判定条件                                   | 表示メッセージ                   | スタイル                      |
| -------- | ------------------------------------------ | -------------------------------- | ----------------------------- |
| 新規登録 | created_at と last_sign_in_at の差 < 30秒  | 「アカウント登録が完了しました」 | 緑色パネル、user-plusアイコン |
| ログイン | created_at と last_sign_in_at の差 >= 30秒 | 「ログインしました」             | 青色パネル、log-inアイコン    |

- メッセージは5秒後に自動的に非表示になる
- フェードアウトアニメーションで自然に消える

### 16.11.3 連携済みプロバイダー表示

認証済み状態では、連携サービス一覧を視覚的に区別して表示する。

**登録済みプロバイダー**:

| 要素     | 仕様                                       |
| -------- | ------------------------------------------ |
| 背景     | `bg-green-500/10`（緑の半透明）            |
| ボーダー | `border-green-500/20`（緑の枠線）          |
| バッジ   | 「登録済み」+ check-circleアイコン（緑色） |
| 情報表示 | プロバイダー名 + 連携メールアドレス        |

**未連携プロバイダー**:

| 要素       | 仕様                             |
| ---------- | -------------------------------- |
| 背景       | デフォルト（白/グレー系）        |
| アクション | 「連携する」ボタン               |
| ホバー状態 | 背景色の変化でクリック可能を示す |

### 16.11.4 エラーメッセージの日本語化

認証関連のエラーメッセージは日本語で表示し、ユーザーが次のアクションを取りやすいようにする。

| エラー種別     | 表示メッセージ                                                 |
| -------------- | -------------------------------------------------------------- |
| ログイン失敗   | 「ログインに失敗しました」                                     |
| 初期化失敗     | 「認証の初期化に失敗しました」                                 |
| プロファイル   | 「プロフィールの更新に失敗しました」                           |
| アカウント連携 | 「アカウント連携に失敗しました」                               |
| トークンなし   | 「認証トークンが見つかりません」                               |
| 設定なし       | 「Supabaseが設定されていません」                               |
| セッション失敗 | 「セッションの設定に失敗しました」                             |
| 認証処理失敗   | 「認証処理に失敗しました」                                     |
| ネットワーク   | 「ネットワーク接続を確認してください」                         |
| タイムアウト   | 「接続がタイムアウトしました。再試行してください」             |
| セッション期限 | 「セッションの有効期限が切れました。再度ログインしてください」 |
| プロバイダー   | 「認証プロバイダーとの接続に失敗しました」                     |
| 不明           | 「予期しないエラーが発生しました」                             |

**エラーコード定義**（`AuthErrorCode`型）

```typescript
type AuthErrorCode =
  | "NETWORK_ERROR"
  | "AUTH_FAILED"
  | "TIMEOUT"
  | "SESSION_EXPIRED"
  | "PROVIDER_ERROR"
  | "PROFILE_UPDATE_FAILED"
  | "LINK_PROVIDER_FAILED"
  | "UNKNOWN";
```

### 16.11.5 ユーザー情報表示のフォールバック

ユーザー情報（表示名、アバター、メールアドレス）を表示する際は、データソースの優先順位とフォールバック値を定義する。

**データソースの優先順位**

| フィールド | 優先度1 | 優先度2  | フォールバック値 |
| ---------- | ------- | -------- | ---------------- |
| 表示名     | profile | authUser | 「User」         |
| メール     | profile | authUser | 空文字列         |
| アバター   | profile | authUser | ユーザーアイコン |

**フォールバック判定ルール**

- 空文字列（`""`）は無効値として扱い、次の優先度のデータソースまたはフォールバック値を使用する
- `null` / `undefined` も同様に無効値として扱う
- 論理OR演算子（`||`）を使用して空文字列も含めてフォールバックする

```typescript
// 正しい実装
const displayName = profile?.displayName || authUser?.displayName || "User";

// 誤った実装（空文字列がフォールバックされない）
const displayName = profile?.displayName ?? authUser?.displayName ?? "User";
```

**長いテキストの処理**

| フィールド | 処理方法                                        |
| ---------- | ----------------------------------------------- |
| 表示名     | `truncate`クラスで省略表示（max-width制限あり） |
| メール     | `truncate`クラスで省略表示                      |

### 16.11.6 アバターメニュー設計

アバター編集メニューは、連携プロバイダーのアバターオプションを動的に表示する。

**メニュー構成**:

| メニュー項目               | 表示条件                                                                           |
| -------------------------- | ---------------------------------------------------------------------------------- |
| アップロード               | 常に表示                                                                           |
| {Provider}のアバターを使用 | プロバイダーにアバターURLがあり、かつ現在使用中のアバターと異なる場合のみ表示      |
| アバターを削除             | 現在アバターが設定されている場合は有効、設定されていない場合は無効（disabled）状態 |

**プロバイダー名のローカライズ**:

プロバイダーIDから表示名への変換を行い、一貫性のある表示を提供する。

| プロバイダーID | 表示名  |
| -------------- | ------- |
| `google`       | Google  |
| `github`       | GitHub  |
| `discord`      | Discord |

**表示例**:

- 「Googleのアバターを使用」
- 「GitHubのアバターを使用」
- 「Discordのアバターを使用」

**動的表示ロジック**:

```typescript
// 現在使用中のアバターと異なるプロバイダーのみ表示
linkedProviders.filter((p) => p.avatarUrl && p.avatarUrl !== currentAvatarUrl);
```

| シナリオ                                        | 表示されるオプション                      |
| ----------------------------------------------- | ----------------------------------------- |
| Googleアバター使用中 + GitHub/Discord連携済み   | GitHubのアバターを使用、Discordのアバター |
| カスタムアバター使用中 + 全プロバイダー連携済み | 全プロバイダーのオプション                |
| プロバイダーにアバターURLがない                 | そのプロバイダーは非表示                  |

**z-index管理（Portal使用）**:

アバターメニューはCSS stacking contextの問題（`backdrop-filter: blur()`による新しいスタッキングコンテキスト作成）を回避するため、ReactのcreatePortalを使用して`document.body`直下にレンダリングする。

| 要素             | z-index値 | 理由                                 |
| ---------------- | --------- | ------------------------------------ |
| アバターメニュー | z-[9999]  | 他の要素より確実に前面に表示         |
| 確認ダイアログ   | z-[100]   | メニューより低く、コンテンツより高い |
| GlassPanel       | z-auto    | 通常のスタッキング順序に従う         |

**Portal実装のポイント**:

```typescript
// React Portalでdocument.body直下に描画
createPortal(
  <div
    role="menu"
    className="fixed w-48 z-[9999]"
    style={{ top: menuPosition.top, left: menuPosition.left }}
  >
    {/* メニュー項目 */}
  </div>,
  document.body
)
```

**位置計算**:

- `getBoundingClientRect()`でトリガーボタンの位置を取得
- `top`: `rect.bottom + 8`（ボタンの下に8pxスペース）
- `left`: `rect.left`（ボタンの左端に揃える）

**WAI-ARIA Menu Pattern準拠**:

| 要件                 | 実装                                       |
| -------------------- | ------------------------------------------ |
| role="menu"          | メニューコンテナに設定                     |
| role="menuitem"      | 各メニュー項目に設定                       |
| aria-label           | メニュー・ボタンに明確なラベル             |
| aria-expanded        | トリガーボタンにメニュー開閉状態を反映     |
| aria-haspopup="menu" | トリガーボタンに設定                       |
| フォーカス管理       | メニューopen時に最初の項目へ自動フォーカス |
| Escapeキー           | メニュークローズ＋トリガーボタンへ復帰     |
| アウトサイドクリック | メニュー・ボタン外クリックでクローズ       |

詳細な実装パターンは [16.16 Portal実装パターン](#1616-portal実装パターン) を参照。

---

## 16.12 APIキー設定UI設計

### 16.12.1 概要

設定画面内の「APIキー設定」セクションでは、AIプロバイダー（OpenAI、Anthropic、Google AI、xAI）のAPIキーを登録・管理する。

### 16.12.2 セクション構成

| 要素               | 仕様                                                |
| ------------------ | --------------------------------------------------- |
| セクションタイトル | 「APIキー設定」                                     |
| セクション説明     | 「AI機能を使用するためのAPIキーを登録してください」 |
| プロバイダーカード | 4つのプロバイダーをカード形式で表示                 |
| レイアウト         | 2カラムグリッド（レスポンシブ対応）                 |

### 16.12.3 プロバイダーカード

| 要素             | 仕様                                            |
| ---------------- | ----------------------------------------------- |
| アイコン         | 各プロバイダー専用SVGアイコン（AIProviderIcon） |
| プロバイダー名   | OpenAI / Anthropic / Google AI / xAI            |
| 説明テキスト     | 各サービスの簡潔な説明                          |
| ステータスバッジ | 「登録済み」（緑）/ 「未登録」（グレー）        |
| アクションボタン | 「登録」/「変更」/「削除」                      |

**プロバイダー説明文**:

| プロバイダー | 説明                         |
| ------------ | ---------------------------- |
| OpenAI       | GPT-4、DALL-E、Whisperなど   |
| Anthropic    | Claude 3.5 Sonnet、Haikuなど |
| Google AI    | Gemini Pro、Gemini Flashなど |
| xAI          | Grok-2、Grok-2-miniなど      |

### 16.12.4 APIキー登録モーダル

| 要素           | 仕様                                     |
| -------------- | ---------------------------------------- |
| タイトル       | 「{プロバイダー名} APIキーを登録」       |
| 入力フィールド | `type="password"`、マスク表示            |
| 表示/非表示    | 目のアイコンでトグル                     |
| 検証ボタン     | 「検証」ボタンでリアルタイム検証         |
| 保存ボタン     | 「保存」ボタン（検証成功後に有効化推奨） |
| キャンセル     | 「キャンセル」ボタンでモーダルを閉じる   |

### 16.12.5 検証ステータス表示

| ステータス    | アイコン       | 色  | メッセージ                                          |
| ------------- | -------------- | --- | --------------------------------------------------- |
| valid         | check-circle   | 緑  | APIキーは有効です                                   |
| invalid       | x-circle       | 赤  | APIキーが無効です。キーを確認して再入力してください |
| network_error | alert-circle   | 橙  | サーバーに接続できません                            |
| timeout       | clock          | 橙  | 接続がタイムアウトしました                          |
| unknown_error | alert-triangle | 橙  | 検証中にエラーが発生しました                        |
| validating    | spinner        | 青  | 検証中...                                           |

**アクセシビリティ属性**:

| 属性      | 値     | 用途                               |
| --------- | ------ | ---------------------------------- |
| role      | status | 検証結果の通知                     |
| aria-live | polite | 結果変更時のスクリーンリーダー通知 |

### 16.12.6 削除確認ダイアログ

| 要素           | 仕様                                          |
| -------------- | --------------------------------------------- |
| タイトル       | 「APIキーを削除」                             |
| 警告メッセージ | 「{プロバイダー名}のAPIキーを削除しますか？」 |
| 説明           | 「この操作は取り消せません。」                |
| 確認ボタン     | 「削除」（赤色、危険操作を示す）              |
| キャンセル     | 「キャンセル」（グレー）                      |

### 16.12.7 セキュリティ考慮事項

| 項目                   | 対応                                           |
| ---------------------- | ---------------------------------------------- |
| マスク表示             | デフォルトで`type="password"`                  |
| クリップボードペースト | 許可（ユーザビリティ優先）                     |
| 自動補完               | `autocomplete="off"`で無効化                   |
| フォーカス管理         | モーダルオープン時に入力フィールドにフォーカス |
| メモリクリア           | モーダルクローズ時に入力値をクリア             |

---

## 16.13 アイコンとイラスト

### 16.13.1 アイコンライブラリの選定

| 候補             | 特徴                                  | 推奨用途             |
| ---------------- | ------------------------------------- | -------------------- |
| Lucide Icons     | シンプル、一貫性、React対応、OSS      | 標準UIアイコン       |
| Heroicons        | Tailwind公式、シンプル                | Tailwindプロジェクト |
| Phosphor Icons   | 豊富なバリエーション、6種類のウェイト | 表現力が必要な場合   |
| カスタムアイコン | プロダクト固有                        | ブランドアイコン     |

**推奨**: **Lucide Icons** を標準採用する

### 16.13.2 サイズ規則

| 用途                       | サイズ    | 対応するテキストサイズ   |
| -------------------------- | --------- | ------------------------ |
| インラインアイコン（小）   | 16px      | text-sm（14px）          |
| インラインアイコン（標準） | 20px      | text-base（16px）        |
| ボタン内アイコン           | 20px      | ボタンテキストと同等     |
| ナビゲーションアイコン     | 24px      | text-lg（18px）          |
| 大きなアイコン             | 32px-48px | 見出し、強調表示         |
| イラスト的使用             | 64px以上  | 空状態、オンボーディング |

### 16.13.3 使用ガイドライン

| ルール           | 説明                                              |
| ---------------- | ------------------------------------------------- |
| 一貫したウェイト | 同一プロジェクト内でアウトライン/塗りつぶしを統一 |
| 意味の一貫性     | 同じ概念には同じアイコンを使用                    |
| テキストとの併用 | 重要な操作にはアイコン+テキストラベル             |
| アクセシビリティ | 意味を持つアイコンには`aria-label`を設定          |
| 色の適用         | `currentColor`で親要素の色を継承                  |
| ストローク幅     | 1.5px-2pxで視認性を確保                           |

---

## 16.14 検索・置換パネルUI設計

### 16.14.1 概要

エディタの検索・置換機能は、UnifiedSearchPanelとして3つの検索モードを統合したパネルで提供する。

| モード    | 機能                                 | ユースケース                       |
| --------- | ------------------------------------ | ---------------------------------- |
| file      | 現在開いているファイル内の検索・置換 | 特定ファイル内のテキスト操作       |
| workspace | ワークスペース全体の検索・置換       | プロジェクト横断のリファクタリング |
| filename  | ファイル名による検索（置換なし）     | ファイルの素早いナビゲーション     |

### 16.14.2 キーボードショートカット

| 操作               | macOS       | Windows/Linux | 備考                              |
| ------------------ | ----------- | ------------- | --------------------------------- |
| ファイル内検索     | Cmd+F       | Ctrl+F        | 検索パネルをfileモードで開く      |
| ファイル内置換     | Cmd+T       | Ctrl+T        | 置換行を表示した状態で開く        |
| ワークスペース検索 | Cmd+Shift+F | Ctrl+Shift+F  | 検索パネルをworkspaceモードで開く |
| ワークスペース置換 | Cmd+Shift+T | Ctrl+Shift+T  | 置換行を表示した状態で開く        |
| ファイル名検索     | Cmd+P       | Ctrl+P        | ファイル名モードで開く            |
| パネルを閉じる     | Escape      | Escape        | 全モード共通                      |
| 次の結果へ         | Enter / F3  | Enter / F3    | ファイル内検索時                  |
| 前の結果へ         | Shift+Enter | Shift+Enter   | ファイル内検索時                  |

### 16.14.3 タブバー設計

| 要素             | 仕様                                  |
| ---------------- | ------------------------------------- |
| 配置             | パネル上部、水平方向に並べて表示      |
| アクティブ表示   | 下線（2px、blue-500）+ テキスト色変更 |
| 非アクティブ表示 | ボーダーなし、slate-400のテキスト色   |
| ホバー状態       | テキスト色をslate-300に変更           |
| 閉じるボタン     | タブバー右端に配置（×アイコン）       |

**タブ構成**:

| タブ           | アイコン      | ショートカット表示 | 置換モードサポート |
| -------------- | ------------- | ------------------ | ------------------ |
| ファイル内検索 | file-text     | ⌘F / ⌘T            | ○                  |
| 全体検索       | folder-search | ⌘⇧F / ⌘⇧T          | ○                  |
| ファイル名     | file          | ⌘P                 | ×                  |

**置換モード時の表示**:

- タブラベルが「検索」から「置換」に変更される
- 置換をサポートしないタブ（ファイル名）は非表示になる

### 16.14.4 ファイル内検索パネル（FileSearchPanel）

#### 検索行

| 要素           | 仕様                                |
| -------------- | ----------------------------------- |
| 検索入力       | プレースホルダー「検索 / Search」   |
| 結果カウント   | 「X / Y 件」形式（現在位置 / 総数） |
| 検索オプション | 3つのトグルボタン（後述）           |
| ナビゲーション | ↑↓ボタンで前後の結果に移動          |

#### 検索オプションボタン

| ボタン           | ラベル | アイコン/表示 | 機能               |
| ---------------- | ------ | ------------- | ------------------ |
| 大文字小文字区別 | Aa     | テキスト      | Case Sensitive検索 |
| 単語単位         | Ab     | テキスト      | Whole Word検索     |
| 正規表現         | .\*    | テキスト      | Regex検索          |

**ボタン状態**:

| 状態   | 背景色    | テキスト色 |
| ------ | --------- | ---------- |
| 非選択 | 透明      | slate-400  |
| 選択中 | blue-600  | white      |
| ホバー | slate-700 | slate-300  |

#### 置換行（折りたたみ可能）

| 要素             | 仕様                               |
| ---------------- | ---------------------------------- |
| 置換入力         | プレースホルダー「置換 / Replace」 |
| 置換ボタン       | 現在のマッチを置換                 |
| すべて置換ボタン | 全マッチを一括置換                 |
| トグルボタン     | 検索行左端に配置、▼/▶アイコン      |

### 16.14.5 ワークスペース検索パネル（WorkspaceSearchPanel）

#### 検索行

| 要素         | 仕様                                       |
| ------------ | ------------------------------------------ |
| 検索入力     | プレースホルダー「ワークスペース内を検索」 |
| 結果カウント | 「X ファイル / Y 件」形式                  |
| 検索実行     | Enter押下またはデバウンス後に自動実行      |

#### 置換行（折りたたみ可能）

| 要素             | 仕様                                 |
| ---------------- | ------------------------------------ |
| 置換入力         | プレースホルダー「置換 / Replace」   |
| すべて置換ボタン | 全ファイルの全マッチを一括置換       |
| 確認ダイアログ   | 実行前に影響範囲を表示して確認を取る |

#### 結果リスト

| 要素         | 仕様                             |
| ------------ | -------------------------------- |
| グルーピング | ファイルパスでグループ化         |
| 折りたたみ   | ファイル単位で折りたたみ可能     |
| マッチ行表示 | 行番号 + マッチ部分をハイライト  |
| クリック動作 | ファイルを開き、該当行にジャンプ |
| 最大表示件数 | 1000件（パフォーマンス考慮）     |

### 16.14.6 ファイル名検索パネル（FileNameSearchPanel）

| 要素         | 仕様                                 |
| ------------ | ------------------------------------ |
| 検索入力     | プレースホルダー「ファイル名を検索」 |
| 結果カウント | 「X 件」形式                         |
| デバウンス   | 150msのデバウンス処理                |
| 最大表示件数 | 50件                                 |

#### 結果リスト

| 要素           | 仕様                                           |
| -------------- | ---------------------------------------------- |
| ファイル名表示 | 太字で表示                                     |
| パス表示       | ファイル名の下に薄いテキストで表示             |
| 選択状態       | 背景色をblue-600に変更                         |
| キーボード操作 | ↑↓で選択移動、Enterで開く                      |
| スクロール     | 選択アイテムが常に表示されるよう自動スクロール |

### 16.14.7 ハイライト表示

検索結果のハイライト表示はエディタ側で実装する。

| 要素           | 色               | 用途                       |
| -------------- | ---------------- | -------------------------- |
| 現在のマッチ   | yellow-400 (70%) | フォーカス中のマッチ       |
| その他のマッチ | yellow-300 (40%) | 他のマッチ位置             |
| 置換プレビュー | green-400 (30%)  | 置換後のテキストプレビュー |

### 16.14.8 アクセシビリティ対応

| 要件                   | 実装方針                               |
| ---------------------- | -------------------------------------- |
| キーボード完全対応     | 全操作がキーボードで実行可能           |
| フォーカス管理         | パネル表示時に検索入力にフォーカス     |
| aria-label             | 各ボタン・入力フィールドに適切なラベル |
| aria-selected          | リスト項目の選択状態を通知             |
| role="listbox"         | 結果リストに適用                       |
| role="option"          | 各結果項目に適用                       |
| 結果カウントの読み上げ | aria-liveで検索結果数を通知            |

### 16.14.9 エラー状態

| エラー種別     | 表示方法                                       |
| -------------- | ---------------------------------------------- |
| 検索エラー     | 結果エリアにエラーメッセージを表示             |
| 置換エラー     | トースト通知でエラー内容を表示                 |
| 権限エラー     | 該当ファイルの置換をスキップし、サマリーで報告 |
| 大量置換の警告 | 確認ダイアログで影響範囲を明示                 |

### 16.14.10 パフォーマンス考慮事項

| 項目                 | 対策                                                   |
| -------------------- | ------------------------------------------------------ |
| 検索デバウンス       | 150-300msのデバウンスで入力中の検索を抑制              |
| 結果の仮想化         | 大量結果時はvirtualizationで描画を最適化               |
| バックグラウンド検索 | Web Workerでメインスレッドをブロックしない             |
| キャンセル機能       | 検索中に新しい検索を開始した場合は前の検索をキャンセル |
| 結果上限             | 表示結果数に上限を設け、超過時は通知                   |

---

## 16.15 ファイルセレクターUI設計

### 16.15.1 概要

ファイル選択機能を提供するコンポーネント群。2つのモードを提供する：

| モード    | 説明                                                     |
| --------- | -------------------------------------------------------- |
| external  | OS標準のファイルダイアログ・D&Dによるファイル選択        |
| workspace | ワークスペース内のファイルツリーからの選択（デフォルト） |

### 16.15.2 コンポーネント構成

#### 共通コンポーネント

| コンポーネント      | 役割                                     |
| ------------------- | ---------------------------------------- |
| FileSelectorModal   | モーダルダイアログとして表示するラッパー |
| FileSelectorTrigger | モーダルを開くトリガーボタン             |

#### externalモード（従来）

| コンポーネント | 役割                                       |
| -------------- | ------------------------------------------ |
| FileSelector   | ドロップゾーン・ファイルリスト・フィルター |

#### workspaceモード（新規）

| コンポーネント         | 役割                                       |
| ---------------------- | ------------------------------------------ |
| WorkspaceFileSelector  | ワークスペースツリーベースのファイル選択UI |
| WorkspaceSearchInput   | ファイル名検索入力フィールド               |
| SelectableFileTreeItem | 選択可能なファイルツリーアイテム           |
| SelectedFilesPanel     | 選択されたファイルのリスト表示パネル       |

### 16.15.3 トリガーボタン

| プロパティ     | 値                                     |
| -------------- | -------------------------------------- |
| バリエーション | default, compact, icon-only            |
| サイズ         | sm, md, lg                             |
| 状態           | 通常, hover, active, disabled, loading |

| サイズ | パディング | フォントサイズ |
| ------ | ---------- | -------------- |
| sm     | px-2 py-1  | text-xs        |
| md     | px-3 py-2  | text-sm        |
| lg     | px-4 py-3  | text-base      |

### 16.15.4 モーダルダイアログ

| 項目         | 仕様                                     |
| ------------ | ---------------------------------------- |
| 幅           | max-w-[600px]（モバイル: 全画面）        |
| 高さ         | max-h-[80vh]（モバイル: 全画面）         |
| 背景         | bg-[var(--bg-glass)] backdrop-blur-xl    |
| ボーダー     | border-[var(--border-subtle)] rounded-lg |
| オーバーレイ | bg-black/60 backdrop-blur-sm             |

### 16.15.5 ドロップゾーン

| 状態         | スタイル                                 |
| ------------ | ---------------------------------------- |
| 通常         | 点線ボーダー、テキスト案内表示           |
| ドラッグ中   | ハイライトボーダー、視覚的フィードバック |
| ローディング | スピナー表示、操作無効化                 |
| エラー       | エラーメッセージ表示（閉じるボタン付き） |

### 16.15.6 ファイルリスト

| 項目           | 表示内容                          |
| -------------- | --------------------------------- |
| ファイル数     | 「N件のファイル」形式             |
| ファイル名     | file.name                         |
| ファイルサイズ | 自動単位変換（B, KB, MB, GB, TB） |
| 削除ボタン     | 各ファイル行に配置                |
| 全クリアボタン | ヘッダー右側に配置                |

### 16.15.7 フィルター機能

| フィルターカテゴリ | 対象             |
| ------------------ | ---------------- |
| all                | すべてのファイル |
| office             | オフィス文書     |
| text               | テキストファイル |
| media              | メディアファイル |
| image              | 画像ファイル     |

### 16.15.8 キーボード操作

| キー   | 動作                             |
| ------ | -------------------------------- |
| Escape | モーダルを閉じる                 |
| Tab    | フォーカス移動（モーダル内循環） |
| Enter  | ボタン実行                       |
| Space  | ボタン実行                       |

### 16.15.9 アニメーション

| トランジション   | duration | easing      |
| ---------------- | -------- | ----------- |
| モーダル開閉     | 200ms    | ease-out    |
| オーバーレイ     | 200ms    | linear      |
| ボタンホバー     | 200ms    | ease        |
| ボタンアクティブ | 即時     | scale(0.98) |

### 16.15.10 アクセシビリティ対応

| 要件               | 実装方針                           |
| ------------------ | ---------------------------------- |
| role="dialog"      | モーダルコンテナに適用             |
| aria-modal="true"  | モーダルであることを通知           |
| aria-labelledby    | タイトル要素のIDを参照             |
| aria-describedby   | 説明テキストのIDを参照             |
| aria-label         | ドロップゾーン、閉じるボタンに適用 |
| aria-busy          | ローディング状態を通知             |
| aria-live="polite" | 選択ファイル数の変更を読み上げ     |
| フォーカス管理     | 開閉時に適切なフォーカス移動       |
| スクリーンリーダー | sr-onlyで補足説明を提供            |

### 16.15.11 レスポンシブ対応

| ブレークポイント | 動作                     |
| ---------------- | ------------------------ |
| sm以上           | モーダル幅 max-w-[600px] |
| sm未満           | 全画面表示、角丸なし     |

### 16.15.12 WorkspaceFileSelectorモード

#### レイアウト構成

```
┌─────────────────────────────────────────────────┐
│ ファイルを選択                            [×]   │ ← ヘッダー
├─────────────────────────────────────────────────┤
│ [🔍 ファイル名で検索...]                        │ ← 検索バー
├─────────────────────────────────────────────────┤
│ 📁 フォルダ名            │ 選択されたファイル   │
│   📄 file1.ts  [☑]       │ 2件のファイルを選択中 │
│   📄 file2.ts  [ ]       │ ────────────────────  │
│   📁 subfolder           │ 📄 file1.ts      [×]  │
│     📄 nested.ts [ ]     │ 📄 file3.ts      [×]  │
│   📄 file3.ts  [☑]       │                       │
│                          │      [すべてクリア]   │
├──────────────────────────┴───────────────────────┤
│ 2件選択中           [キャンセル] [選択]         │ ← フッター
└─────────────────────────────────────────────────┘
```

#### 選択オプション

| オプション        | 型                     | デフォルト | 説明                    |
| ----------------- | ---------------------- | ---------- | ----------------------- |
| selectionMode     | "single" \| "multiple" | "multiple" | 選択モード              |
| allowedExtensions | string[]               | undefined  | 許可する拡張子（.ts等） |
| maxSelection      | number                 | 0          | 最大選択数（0=無制限）  |

#### カスタムフック

| フック名                  | 役割                           |
| ------------------------- | ------------------------------ |
| useWorkspaceFileSelection | ファイル選択状態の管理         |
| useFileSearch             | ファイル名検索・フィルタリング |

#### ファイルツリー表示

| 項目         | 仕様                                         |
| ------------ | -------------------------------------------- |
| データソース | Zustand workspaceスライスからfolderFileTrees |
| 展開状態     | ローカルステートで管理                       |
| 選択UI       | チェックボックスアイコン                     |
| フォルダ表示 | 展開/折りたたみ可能（選択不可）              |
| ファイル表示 | クリックで選択/選択解除                      |

#### 検索機能

| 項目     | 仕様                                     |
| -------- | ---------------------------------------- |
| 検索対象 | ファイル名（部分一致、大文字小文字無視） |
| フィルタ | 入力に応じてツリーを動的にフィルタリング |
| 空状態   | 「一致するファイルが見つかりません」表示 |

#### 選択パネル

| 項目   | 仕様                               |
| ------ | ---------------------------------- |
| 配置   | 右側固定幅（w-64）                 |
| 表示   | 選択中ファイル名リスト             |
| 操作   | 個別削除、すべてクリア             |
| 空状態 | 「ファイルを選択してください」表示 |

### 16.15.13 フォルダ一括選択機能

#### 概要

フォルダのチェックボックスをクリックすることで、配下の全ファイルを一括選択・解除できる機能。

#### チェックボックスの3状態

| 状態          | 説明                                     | 視覚表現                          |
| ------------- | ---------------------------------------- | --------------------------------- |
| unselected    | フォルダ配下のファイルが全て未選択       | 空のチェックボックス              |
| indeterminate | フォルダ配下のファイルが一部のみ選択済み | チェックボックス内に横線（─）表示 |
| selected      | フォルダ配下のファイルが全て選択済み     | チェックマーク（✓）表示           |

#### フォルダアイコンの視覚フィードバック

| 状態              | フォルダアイコン |
| ----------------- | ---------------- |
| 未選択            | 通常アイコン     |
| 一部選択/全選択時 | 塗りつぶし表示   |

#### チェックボックススタイル

| 状態          | 背景色         | ボーダー色      |
| ------------- | -------------- | --------------- |
| unselected    | 透明           | border-zinc-500 |
| indeterminate | bg-blue-600/50 | border-blue-600 |
| selected      | bg-blue-600    | border-blue-600 |

**ホバー時の色変化**:

- unselected: border-zinc-400
- indeterminate: bg-blue-600/60
- selected: bg-blue-700

#### 操作仕様

| 操作             | 動作                                                   |
| ---------------- | ------------------------------------------------------ |
| フォルダクリック | 配下の全ファイルを選択/解除（indeterminate時は全選択） |
| Spaceキー        | フォーカス中のフォルダでクリック操作と同じ動作         |
| 個別ファイル選択 | フォルダがindeterminate状態に変化（一部選択を反映）    |
| ネスト構造       | 親フォルダ選択時、子フォルダ・孫フォルダも含めて全選択 |

#### アクセシビリティ対応

| 属性         | 値                            |
| ------------ | ----------------------------- |
| aria-checked | "false" / "mixed" / "true"    |
| role         | "checkbox"                    |
| tabIndex     | 0（キーボードフォーカス可能） |
| aria-label   | "フォルダ名を一括選択"        |

**スクリーンリーダー通知**:

- フォルダ選択時: 「フォルダ名 を選択しました。N件のファイルを追加」
- フォルダ解除時: 「フォルダ名 の選択を解除しました。N件のファイルを削除」
- indeterminate状態: 「フォルダ名 の一部のファイルが選択されています」

---

## 16.16 Portal実装パターン

### 16.16.1 概要

React Portal（`createPortal`）を使用して、CSS stacking contextの制約から脱出し、要素を確実に最前面に表示するための実装パターン。

**適用場面**:

- ドロップダウンメニュー、ツールチップ、モーダルなど、親要素のstacking contextから独立させる必要がある要素
- `backdrop-filter: blur()`、`filter`、`transform`などstacking contextを作成するCSSプロパティを持つ親要素の子孫要素

### 16.16.2 Stacking Context問題の理解

**問題**: CSS stacking contextが作成されると、子要素の`z-index`は親のstacking context内でのみ有効になる。

```typescript
// 問題のあるパターン
<div className="backdrop-blur-xl"> {/* 新しいstacking context作成 */}
  <div className="z-[9999]"> {/* このz-indexは親context内でのみ有効 */}
    メニュー
  </div>
</div>
```

**Stacking Contextを作成するCSSプロパティ**:

- `backdrop-filter: blur()`
- `filter: blur()`, `filter: drop-shadow()` など
- `transform`（`translateZ(0)` 含む）
- `opacity < 1`
- `position: fixed` + `transform`
- `will-change: transform, opacity` など

**解決策**: React Portalで`document.body`直下にレンダリング

```typescript
// 解決パターン
createPortal(
  <div className="fixed z-[9999]">メニュー</div>,
  document.body
)
```

### 16.16.3 基本実装パターン

**必須要素**:

1. メニュー位置を保持するstate
2. メニュー表示状態のboolean state
3. トリガーボタンのref
4. メニュー要素のref（アウトサイドクリック判定用）

```typescript
// State管理
const [isMenuOpen, setIsMenuOpen] = useState(false);
const [menuPosition, setMenuPosition] = useState<MenuPosition | null>(null);
const triggerRef = useRef<HTMLDivElement>(null);
const menuRef = useRef<HTMLDivElement>(null);

// MenuPosition型定義
interface MenuPosition {
  top: number;
  left: number;
}
```

**位置計算ヘルパー関数**:

```typescript
const calculateMenuPosition = useCallback((): MenuPosition | null => {
  if (!triggerRef.current) return null;
  const rect = triggerRef.current.getBoundingClientRect();
  return {
    top: rect.bottom + 8, // トリガーの下に8pxスペース
    left: rect.left, // 左端を揃える
  };
}, []);
```

**メニュートグルハンドラー**:

```typescript
const handleToggleMenu = useCallback(() => {
  setIsMenuOpen((prev) => {
    if (!prev) {
      const position = calculateMenuPosition();
      setMenuPosition(position);
    } else {
      setMenuPosition(null);
    }
    return !prev;
  });
}, [calculateMenuPosition]);
```

**Portal描画**:

```typescript
{isMenuOpen && menuPosition && createPortal(
  <div
    ref={menuRef}
    role="menu"
    aria-label="メニュー"
    className="fixed w-48 bg-[var(--bg-secondary)] border border-white/10 rounded-lg shadow-lg z-[9999]"
    style={{ top: menuPosition.top, left: menuPosition.left }}
  >
    {/* メニュー項目 */}
  </div>,
  document.body
)}
```

### 16.16.4 イベントハンドリング

**アウトサイドクリックで閉じる**:

```typescript
useEffect(() => {
  const handleClickOutside = (event: MouseEvent) => {
    const target = event.target as Node;
    const isInsideTrigger = triggerRef.current?.contains(target);
    const isInsideMenu = menuRef.current?.contains(target);

    if (!isInsideTrigger && !isInsideMenu) {
      closeMenu();
    }
  };

  if (isMenuOpen) {
    document.addEventListener("mousedown", handleClickOutside);
  }

  return () => {
    document.removeEventListener("mousedown", handleClickOutside);
  };
}, [isMenuOpen, closeMenu]);
```

**Escapeキーで閉じる**:

```typescript
useEffect(() => {
  const handleKeyDown = (event: KeyboardEvent) => {
    if (event.key === "Escape" && isMenuOpen) {
      closeMenu(true); // フォーカスをトリガーに戻す
    }
  };

  if (isMenuOpen) {
    document.addEventListener("keydown", handleKeyDown);
  }

  return () => {
    document.removeEventListener("keydown", handleKeyDown);
  };
}, [isMenuOpen, closeMenu]);
```

**メニュークローズヘルパー**:

```typescript
const closeMenu = useCallback((returnFocus = false) => {
  setIsMenuOpen(false);
  setMenuPosition(null);
  if (returnFocus) {
    const button = triggerRef.current?.querySelector("button");
    button?.focus();
  }
}, []);
```

### 16.16.5 WAI-ARIA Menu Pattern実装

**必須ARIA属性**:

```typescript
// トリガーボタン
<button
  aria-label="メニューを開く"
  aria-expanded={isMenuOpen}
  aria-haspopup="menu"
  onClick={handleToggleMenu}
>
  トリガー
</button>

// メニューコンテナ
<div
  role="menu"
  aria-label="メニュー"
>
  <button role="menuitem" onClick={handleAction1}>
    アクション1
  </button>
  <button role="menuitem" onClick={handleAction2}>
    アクション2
  </button>
</div>
```

**フォーカス管理**:

```typescript
// メニューopen時に最初の項目へフォーカス移動
useEffect(() => {
  if (isMenuOpen && menuRef.current) {
    requestAnimationFrame(() => {
      const firstMenuItem = menuRef.current?.querySelector(
        '[role="menuitem"]',
      ) as HTMLElement;
      firstMenuItem?.focus();
    });
  }
}, [isMenuOpen]);
```

### 16.16.6 テスト設計

**必須テストケース**:

| カテゴリ             | テスト内容                           |
| -------------------- | ------------------------------------ |
| Portal描画           | `document.body`直下への描画確認      |
| z-index              | `z-[9999]`が適用されていることを確認 |
| 位置計算             | トリガーボタンの下に正しく配置       |
| アウトサイドクリック | メニュー外クリックで閉じる           |
| Escapeキー           | Escキーでクローズ＋フォーカス復帰    |
| ARIA属性             | role, aria-expanded, aria-label等    |
| フォーカス管理       | メニューopen時の自動フォーカス移動   |
| メモリリーク防止     | useEffect cleanupによるリスナー解除  |

**テスト例**:

```typescript
it('Portal要素がdocument.body直下に描画されること', async () => {
  render(<ComponentWithPortal />);
  const button = screen.getByRole('button', { name: /メニューを開く/i });
  await userEvent.click(button);

  const menu = document.body.querySelector('[role="menu"]');
  expect(menu).toBeInTheDocument();
  expect(menu?.parentElement).toBe(document.body);
});

it('z-index: 9999が適用されていること', async () => {
  render(<ComponentWithPortal />);
  await userEvent.click(screen.getByRole('button'));

  const menu = document.body.querySelector('[role="menu"]');
  expect(menu).toHaveClass('z-[9999]');
});
```

### 16.16.7 パフォーマンス最適化

**useCallbackによるメモ化**:

```typescript
// 位置計算関数のメモ化
const calculateMenuPosition = useCallback((): MenuPosition | null => {
  // ...
}, []);

// メニュークローズ関数のメモ化
const closeMenu = useCallback((returnFocus = false) => {
  // ...
}, []);
```

**requestAnimationFrameの使用**:

Portal要素のレンダリング完了を待ってからフォーカス移動を実行：

```typescript
useEffect(() => {
  if (isMenuOpen && menuRef.current) {
    requestAnimationFrame(() => {
      // Portalレンダリング後にフォーカス移動
      const firstMenuItem = menuRef.current?.querySelector('[role="menuitem"]');
      firstMenuItem?.focus();
    });
  }
}, [isMenuOpen]);
```

### 16.16.8 ベストプラクティス

| 原則                    | 説明                                                            |
| ----------------------- | --------------------------------------------------------------- |
| 最小限の使用            | Portalは必要な場合のみ使用（通常のDOM階層で解決できるなら不要） |
| メモリリーク防止        | useEffect cleanupでイベントリスナーを必ず解除                   |
| アクセシビリティ必須    | WAI-ARIA Patternに完全準拠                                      |
| 位置計算の最適化        | useCallbackでメモ化                                             |
| テストカバレッジ80%以上 | Portal機能は包括的にテスト                                      |
| TypeScript型安全性      | MenuPosition型など、明示的な型定義                              |

### 16.16.9 注意事項

**避けるべきパターン**:

- ❌ Portalを多用する（パフォーマンス低下）
- ❌ イベントリスナーのクリーンアップ忘れ（メモリリーク）
- ❌ ARIA属性の省略（アクセシビリティ違反）
- ❌ フォーカス管理の省略（キーボードナビゲーション不可）

**推奨パターン**:

- ✅ 必要最小限のPortal使用
- ✅ useEffect cleanupでリスナー解除
- ✅ WAI-ARIA Pattern完全準拠
- ✅ 包括的なテストカバレッジ（≥80%）

### 16.16.10 実装チェックリスト

Portal実装時に確認すべき項目：

- [ ] MenuPosition型を定義
- [ ] calculateMenuPosition()ヘルパー関数を実装
- [ ] closeMenu()ヘルパー関数を実装
- [ ] アウトサイドクリックハンドラーをuseEffectで実装
- [ ] EscapeキーハンドラーをuseEffectで実装
- [ ] フォーカス管理をuseEffectで実装（requestAnimationFrame使用）
- [ ] ARIA属性を完備（role, aria-expanded, aria-haspopup, aria-label）
- [ ] useEffect cleanupでイベントリスナー解除
- [ ] テストカバレッジ80%以上を達成
- [ ] axe-core自動テストでWCAG 2.1 AA違反0件

### 16.16.11 参考実装

**実装例**: `apps/desktop/src/renderer/components/organisms/AccountSection/index.tsx`
**テスト例**: `apps/desktop/src/renderer/components/organisms/AccountSection/AccountSection.portal.test.tsx`
**タスクドキュメント**: `docs/30-workflows/auth-ui-z-index-fix/`

---

## 関連ドキュメント

- [テクノロジースタック](./03-technology-stack.md)
- [アーキテクチャ設計](./05-architecture.md)
- [非機能要件](./02-non-functional-requirements.md)
