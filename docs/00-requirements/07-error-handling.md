# エラーハンドリング仕様

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 7.1 エラー分類

### 7.1.1 エラーカテゴリ

| カテゴリ               | エラーコード範囲 | リトライ | HTTPステータス | 例                                   |
| ---------------------- | ---------------- | -------- | -------------- | ------------------------------------ |
| Validation Error       | 1000-1999        | 不可     | 400/422        | 入力スキーマ不正、必須フィールド欠落 |
| Business Error         | 2000-2999        | 不可     | 403/404/409    | 権限不足、リソース不存在、重複作成   |
| External Service Error | 3000-3999        | 可能     | 502/503/504    | AI APIタイムアウト、レート制限       |
| Infrastructure Error   | 4000-4999        | 可能     | 500/503        | DB接続失敗、ファイルシステムエラー   |
| Internal Error         | 5000-5999        | 不可     | 500            | 実装バグ、予期しないエラー           |

### 7.1.2 主要エラーコード一覧

**Validation Error (1000-1999)**:

| コード   | 名称                   | 説明                              |
| -------- | ---------------------- | --------------------------------- |
| ERR_1001 | INVALID_INPUT          | 入力形式が不正                    |
| ERR_1002 | REQUIRED_FIELD_MISSING | 必須フィールドが欠落              |
| ERR_1003 | INVALID_TYPE           | 型が不正                          |
| ERR_1004 | VALUE_OUT_OF_RANGE     | 値が許容範囲外                    |
| ERR_1005 | INVALID_FORMAT         | フォーマットが不正（日付、URL等） |

**Business Error (2000-2999)**:

| コード   | 名称               | 説明                   |
| -------- | ------------------ | ---------------------- |
| ERR_2001 | RESOURCE_NOT_FOUND | リソースが存在しない   |
| ERR_2002 | PERMISSION_DENIED  | アクセス権限がない     |
| ERR_2003 | DUPLICATE_RESOURCE | 重複するリソースが存在 |
| ERR_2004 | INVALID_STATE      | 操作が現在の状態で不正 |
| ERR_2005 | QUOTA_EXCEEDED     | 利用上限を超過         |

**External Service Error (3000-3999)**:

| コード   | 名称                         | 説明                   |
| -------- | ---------------------------- | ---------------------- |
| ERR_3001 | AI_API_ERROR                 | AI APIの呼び出しエラー |
| ERR_3002 | AI_API_TIMEOUT               | AI APIのタイムアウト   |
| ERR_3003 | AI_RATE_LIMIT                | AI APIのレート制限     |
| ERR_3004 | DISCORD_API_ERROR            | Discord APIのエラー    |
| ERR_3005 | EXTERNAL_SERVICE_UNAVAILABLE | 外部サービスが利用不可 |

**Infrastructure Error (4000-4999)**:

| コード   | 名称                       | 説明                   |
| -------- | -------------------------- | ---------------------- |
| ERR_4001 | DATABASE_ERROR             | データベースエラー     |
| ERR_4002 | DATABASE_CONNECTION_FAILED | DB接続失敗             |
| ERR_4003 | FILE_SYSTEM_ERROR          | ファイルシステムエラー |
| ERR_4004 | NETWORK_ERROR              | ネットワークエラー     |
| ERR_4005 | SYNC_CONFLICT              | 同期コンフリクト       |

**Internal Error (5000-5999)**:

| コード   | 名称                | 説明       |
| -------- | ------------------- | ---------- |
| ERR_5001 | INTERNAL_ERROR      | 内部エラー |
| ERR_5002 | NOT_IMPLEMENTED     | 未実装機能 |
| ERR_5003 | CONFIGURATION_ERROR | 設定エラー |

---

## 7.2 リトライ戦略

### 7.2.1 基本設定

| 設定項目         | 値      | 説明                         |
| ---------------- | ------- | ---------------------------- |
| 最大リトライ回数 | 3回     | MAX_RETRY_COUNT              |
| 初期待機時間     | 1000ms  | 指数バックオフの基準値       |
| バックオフ係数   | 2       | 待機時間の増加率             |
| 最大待機時間     | 30000ms | 待機時間の上限               |
| ジッター         | ±20%    | 同時リトライ回避のランダム化 |

### 7.2.2 待機時間計算

| リトライ回数 | 基本待機時間 | ジッター後範囲 |
| ------------ | ------------ | -------------- |
| 1回目        | 1000ms       | 800-1200ms     |
| 2回目        | 2000ms       | 1600-2400ms    |
| 3回目        | 4000ms       | 3200-4800ms    |

### 7.2.3 リトライ対象判定

**リトライする（retryable: true）**:

| 条件               | 理由                     |
| ------------------ | ------------------------ |
| HTTP 429           | レート制限は一時的       |
| HTTP 500-503       | サーバー側の一時的な問題 |
| ネットワークエラー | 一時的な接続問題         |
| タイムアウト       | 一時的な遅延             |

**リトライしない（retryable: false）**:

| 条件                 | 理由                     |
| -------------------- | ------------------------ |
| HTTP 400-403         | クライアント側の問題     |
| HTTP 404             | リソースが存在しない     |
| バリデーションエラー | 入力を修正する必要がある |
| ビジネスエラー       | ロジック上の問題         |

---

## 7.3 サーキットブレーカー（将来対応）

### 7.3.1 状態

| 状態      | 説明                                   |
| --------- | -------------------------------------- |
| Closed    | 正常稼働、リクエストを通す             |
| Open      | 障害状態、リクエストを即座に失敗させる |
| Half-Open | 回復テスト中、一部リクエストを通す     |

### 7.3.2 設定

| 設定項目     | 値   | 説明                           |
| ------------ | ---- | ------------------------------ |
| 失敗閾値     | 5回  | 連続5回失敗で回路オープン      |
| タイムアウト | 30秒 | リクエストタイムアウト         |
| 復旧待機     | 60秒 | オープン状態の維持時間         |
| 成功閾値     | 3回  | Half-Openで3回成功したらClosed |

### 7.3.3 適用対象

| サービス    | 理由                           |
| ----------- | ------------------------------ |
| AI API      | レート制限、一時的な障害が多い |
| Discord API | 外部サービスへの依存           |

---

## 7.4 エラーレスポンス形式

### 7.4.1 基本構造

| フィールド | 型      | 必須 | 説明                   |
| ---------- | ------- | ---- | ---------------------- |
| success    | boolean | 必須 | 常にfalse              |
| error      | object  | 必須 | エラー詳細オブジェクト |
| request_id | string  | 必須 | リクエスト追跡ID       |

### 7.4.2 errorオブジェクト

| フィールド  | 型      | 必須 | 説明                                  |
| ----------- | ------- | ---- | ------------------------------------- |
| code        | string  | 必須 | エラーコード（例: ERR_3001）          |
| message     | string  | 必須 | ユーザー向けエラーメッセージ          |
| details     | object  | 任意 | デバッグ用の詳細情報                  |
| retryable   | boolean | 必須 | リトライ可能かどうか                  |
| retry_after | number  | 任意 | リトライまでの待機秒数（429エラー時） |

### 7.4.3 detailsオブジェクト（任意）

| フィールド | 型     | 説明                         |
| ---------- | ------ | ---------------------------- |
| field      | string | エラーが発生したフィールド名 |
| expected   | string | 期待される値/形式            |
| received   | string | 実際に受け取った値           |
| hint       | string | 修正のヒント                 |

---

## 7.5 エラーログ出力

### 7.5.1 ログ出力項目

| 項目        | 説明                                 |
| ----------- | ------------------------------------ |
| timestamp   | ISO8601形式のタイムスタンプ          |
| level       | error                                |
| error_code  | エラーコード                         |
| message     | エラーメッセージ                     |
| request_id  | リクエストID                         |
| workflow_id | ワークフローID（あれば）             |
| user_id     | ユーザーID（あれば）                 |
| stack_trace | スタックトレース（Internal Error時） |
| context     | 追加のコンテキスト情報               |

### 7.5.2 ログ出力レベル別

| エラー種別             | ログレベル | スタックトレース |
| ---------------------- | ---------- | ---------------- |
| Validation Error       | warn       | 出力しない       |
| Business Error         | warn       | 出力しない       |
| External Service Error | error      | 出力する         |
| Infrastructure Error   | error      | 出力する         |
| Internal Error         | error      | 出力する         |

### 7.5.3 機密情報の除外

以下の情報はログに出力しない:

- APIキー、トークン
- パスワード
- 個人を特定できる情報（メールアドレス等）
- リクエストボディの全文（サニタイズした要約のみ）

---

## 7.6 ユーザー向けエラーメッセージ

### 7.6.1 メッセージの原則

| 原則           | 説明                                   |
| -------------- | -------------------------------------- |
| 具体性         | 何が問題かを明確に伝える               |
| アクション可能 | ユーザーが次に何をすべきか示す         |
| 非技術的       | 専門用語を避け、分かりやすい言葉を使う |
| セキュア       | 内部実装の詳細を露出しない             |

### 7.6.2 メッセージ例

| エラーコード | 技術的メッセージ      | ユーザー向けメッセージ                                                 |
| ------------ | --------------------- | ---------------------------------------------------------------------- |
| ERR_1001     | Zod validation failed | 入力内容に誤りがあります。もう一度確認してください。                   |
| ERR_2001     | Resource not found    | 指定されたデータが見つかりませんでした。                               |
| ERR_3002     | AI API timeout        | AI処理に時間がかかっています。しばらくしてから再度お試しください。     |
| ERR_4002     | DB connection failed  | 一時的な問題が発生しました。しばらくしてから再度お試しください。       |
| ERR_5001     | Unexpected error      | 予期しないエラーが発生しました。問題が続く場合はお問い合わせください。 |

---

## 7.7 エラーハンドリングの実装指針

### 7.7.1 レイヤー別の責務

| レイヤー           | 責務                                             |
| ------------------ | ------------------------------------------------ |
| API層              | HTTPステータスコードの決定、レスポンス形式の統一 |
| アプリケーション層 | ビジネスエラーのスロー、リトライ判定             |
| インフラ層         | 外部サービスエラーのキャッチと変換               |
| ドメイン層         | ドメイン固有のエラー定義                         |

### 7.7.2 エラー変換の原則

| 原則         | 説明                                                   |
| ------------ | ------------------------------------------------------ |
| 早期キャッチ | エラーは発生した場所に近いところでキャッチする         |
| 適切な変換   | 低レベルのエラーを上位レイヤーのエラーに変換する       |
| 情報保持     | 原因となったエラーの情報は保持する（cause プロパティ） |
| ログ出力     | 変換時にログを出力し、追跡可能にする                   |

### 7.7.3 グローバルエラーハンドラー

| 対象              | 処理                                |
| ----------------- | ----------------------------------- |
| 未キャッチ例外    | Internal Error として処理、ログ出力 |
| Promise rejection | 同上                                |
| API Route エラー  | 適切なHTTPステータスで返却          |

---

## 関連ドキュメント

- [コアインターフェース仕様](./06-core-interfaces.md)
- [REST API 設計原則](./08-api-design.md)
- [非機能要件](./02-non-functional-requirements.md)
- [セキュリティガイドライン](./17-security-guidelines.md)
