# エラーハンドリング仕様 (Error Handling)

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

## 7.1 エラー分類

| カテゴリ | エラーコード範囲 | リトライ | 例 |
|----------|-----------------|----------|-----|
| Validation Error | 1000-1999 | 不可 | 入力スキーマ不正 |
| Business Error | 2000-2999 | 不可 | 権限不足、リソース不存在 |
| External Service Error | 3000-3999 | 可能 | AI API タイムアウト |
| Infrastructure Error | 4000-4999 | 可能 | DB 接続失敗 |
| Internal Error | 5000-5999 | 不可 | 実装バグ |

---

## 7.2 リトライ戦略

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| 最大リトライ回数 | 3回 | `MAX_RETRY_COUNT` |
| 初期待機時間 | 1000ms | 指数バックオフの基準値 |
| バックオフ係数 | 2 | 待機時間の増加率 |
| 最大待機時間 | 30000ms | 待機時間の上限 |
| ジッター | ±20% | 同時リトライ回避 |

### リトライ対象判定

- **リトライする（retryable: true）**: HTTP 429, 500-503, ネットワークエラー, タイムアウト
- **リトライしない（retryable: false）**: HTTP 400-403, バリデーションエラー, ビジネスエラー

### サーキットブレーカー（将来対応）

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| 失敗カウント | 5回 | 連続5回失敗で回路オープン |
| タイムアウト | 30秒 | リクエストタイムアウト |
| 復旧待機 | 60秒 | 60秒後に半開状態（Half-Open）へ遷移 |
| 適用対象 | 外部API | AI、Discord等 |

---

## 7.3 エラーレスポンス形式

標準エラーレスポンスの構造：

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `success` | boolean | 常に `false` |
| `error.code` | string | エラーコード（例: `ERR_3001`） |
| `error.message` | string | 人間が読めるエラーメッセージ |
| `error.details` | object | エラーの詳細情報（オプション） |
| `error.retryable` | boolean | リトライ可能かどうか |
| `request_id` | string | リクエスト追跡ID（ログと紐付け） |

### フィールド説明

- **success**: 常に false（エラーレスポンスのため）
- **error.code**: エラー分類コード（1000-5999の範囲、7.1 参照）
- **error.message**: ユーザー向けのエラーメッセージ（日本語）
- **error.details**: デバッグ用の詳細情報（オブジェクト形式）
- **error.retryable**: クライアントがリトライすべきかの判定フラグ
- **request_id**: ログとの紐付け用ID（トラブルシューティング用）

---

## 関連ドキュメント

- [コアインターフェース仕様](./06-core-interfaces.md)
- [REST API 設計原則](./08-api-design.md)
- [非機能要件](./02-non-functional-requirements.md)
