# 非機能要件 (Non-Functional Requirements)

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

## 2.1 基本要件（MVP）

| カテゴリ | 要件 | 実装方針 |
|----------|------|----------|
| 認証 | API キーベース認証 | 環境変数で管理、リクエストヘッダーで送信 |
| 通信暗号化 | TLS 1.3 | Railway がデフォルト対応 |
| 機密情報管理 | 環境変数による注入 | `.env`ファイルは `.gitignore` に含める |
| 入力検証 | Zod バリデーション | スキーマ定義を機能ごとに必須化 |
| ログ出力 | 構造化ログ（JSON形式） | Railway Logs（自動収集） |
| ファイル保存 | 一時ストレージ | Railway ボリューム or 外部ストレージ |

## 2.2 ロギング仕様

### ログフォーマット（JSON構造化ログ）

| フィールド | 説明 |
|------------|------|
| `level` | ログレベル（`error`, `warn`, `info`, `debug`） |
| `message` | ログメッセージ（人間が読める形式） |
| `timestamp` | ISO8601 形式のタイムスタンプ |
| `request_id` | リクエスト追跡ID（全ログに必須） |
| `workflow_id` | ワークフローID（該当する場合） |
| `user_id` | ユーザーID（該当する場合） |
| `context` | コンテキスト情報（機能名、処理ステップ等） |
| `error` | エラー情報（スタックトレース含む、エラー時のみ） |

### ログレベルの使い分け

| レベル | 用途 |
|--------|------|
| `error` | システムエラー、例外、障害（即座の対応が必要） |
| `warn` | 警告、リトライ、非推奨機能の使用 |
| `info` | 重要なイベント（ワークフロー開始/完了、デプロイ等） |
| `debug` | デバッグ情報（開発環境のみ） |

### ログ出力先

| 環境 | 出力先 |
|------|--------|
| 開発環境 | console（標準出力） |
| 本番環境 | Railway Logs（自動収集、7日間保持） |

## 2.3 ファイルストレージ戦略

### 一時ファイル保存

| 項目 | 仕様 |
|------|------|
| 保存先 | Railway の一時ボリューム（`/tmp` ディレクトリ） |
| 用途 | アップロードファイルの一時保存、AI処理中のファイル |
| 制約 | Railway の再デプロイ時に削除される（永続化不要） |
| 最大サイズ | 100MB per ファイル |

### 永続ストレージ（将来対応）

| 項目 | 仕様 |
|------|------|
| 保存先候補 | AWS S3、Google Cloud Storage、Cloudflare R2 |
| 用途 | 処理済みファイルの長期保存、ユーザーダウンロード |
| MVP方針 | 一時保存のみで開始、必要に応じて外部ストレージを追加 |

### ファイル命名規則

- **UUID ベース**: `{workflow_id}_{timestamp}_{original_filename}`
- **セキュリティ**: ファイル名のサニタイズ（パストラバーサル対策）

## 2.4 テスト戦略（Test-Driven Development）

### テストピラミッド

```
        /\
       /E2E\         少（遅い、高コスト、統合テスト）
      /------\
     /統合テスト\      中（API、DB統合）
    /----------\
   / ユニットテスト \   多（高速、低コスト、単体機能）
  /--------------\
 /   静的テスト    \  最多（型チェック、Lint、即座）
/------------------\
```

### 各レベルの目的とカバレッジ目標

| レベル | カバレッジ | 目的 |
|--------|-----------|------|
| 静的テスト | 100%必須 | 型エラー、未使用変数、コードスタイル違反の検出 |
| ユニットテスト | 60%以上 | 個別関数・クラスの正しさ、境界値テスト |
| 統合テスト | 主要フロー | API エンドポイント、DB操作、外部サービス連携 |
| E2Eテスト | クリティカルパス | ユーザーフロー、ブラウザ操作、実ファイル処理 |

### 静的テスト要件

#### TypeScript型チェック
- 実行タイミング: ファイル保存時、PR作成時、デプロイ前
- strict モード: 必須、`any` 型の使用を最小限に
- カバレッジ: すべての .ts/.tsx ファイル
- CI統合: `pnpm typecheck` で型エラーがあればPRマージ不可

#### ESLint
- 実行タイミング: ファイル保存時、PR作成時
- 必須ルール: 未使用変数、未使用インポート、console.log（warn）
- 境界チェック: `eslint-plugin-boundaries` で依存関係違反を検出
- 自動修正: 可能なものは `--fix` で自動修正

#### Prettier
- 実行タイミング: ファイル保存時
- 統一フォーマット: シングルクォート、セミコロンあり、タブ幅2
- 適用範囲: すべての .ts/.tsx/.json/.md ファイル

### ユニットテスト要件（Vitest）

#### テスト対象
- 全 Executor クラス（`features/*/executor.ts`）
- 全 スキーマバリデーション（`features/*/schema.ts`）
- ユーティリティ関数
- カスタムフック（React Hooks）

#### テストファイル配置
- `features/[機能名]/__tests__/executor.test.ts`
- `shared/core/__tests__/`（共通ロジック）
- `shared/infrastructure/__tests__/`（インフラ層、モック使用）

#### テスト原則（TDD）
1. **Red**: テストを先に書く（失敗を確認）
2. **Green**: 最小限の実装でテストをパスさせる
3. **Refactor**: コードをリファクタリング（テストは維持）

#### モック/スタブ方針
| 対象 | 方針 |
|------|------|
| 外部API | すべてモック化（AI API、Discord API等） |
| DB操作 | Repository をモック化、実DBは使用しない |
| ファイルシステム | メモリ内で完結、実ファイルI/O回避 |
| 時刻 | `vi.setSystemTime()` で固定 |

#### カバレッジ目標
| 対象 | 目標 |
|------|------|
| 全体 | 60%以上（MVP では努力目標、本番投入前は必達） |
| 重要ロジック（Executor） | 80%以上 |
| エラーハンドリング | 100% |

### 統合テスト要件

#### テスト対象
- API エンドポイント（`/api/v1/workflows` 等）
- DB との統合（実際の Neon 接続）
- ワークフロー全体の実行（Executor + Repository + AI Client）

#### テスト環境
| 項目 | 設定 |
|------|------|
| DB | Neon のテスト用データベース（本番とは別） |
| AI API | モックまたは低コストモデル使用 |
| Discord | Webhook テスト用チャンネル |

#### データ管理
- セットアップ: テスト前にシードデータ投入
- クリーンアップ: テスト後にデータ削除（トランザクションロールバック推奨）
- 分離: テストデータは本番データと完全分離

### E2Eテスト要件（Playwright）

#### テスト対象（クリティカルパスのみ）
- ユーザー登録・ログインフロー（将来）
- ワークフロー実行フロー（Discord → API → 完了通知）
- ファイルアップロードフロー（Local Agent → Cloud → 処理）

#### テスト環境
| 項目 | 設定 |
|------|------|
| ブラウザ | Chromium（Railway でも実行可能） |
| データ | E2E専用のテストユーザー・ワークフロー |
| クリーンアップ | テスト後に全データ削除 |

#### フレーキーテスト対策
- 明示的待機: `waitFor` で要素の出現を待つ
- リトライロジック: 不安定なテストは最大3回リトライ
- タイムアウト: 適切なタイムアウト設定（デフォルト30秒）

### TDD実践フロー（必須）

#### 新機能追加時の手順
1. 仕様書作成: `../20-specifications/features/[feature-name].md`
2. テスト作成: `features/新機能/__tests__/executor.test.ts` を先に書く
3. Red: テストを実行して失敗を確認
4. スキーマ定義: `schema.ts` で入出力定義
5. Executor実装: `executor.ts` で最小限の実装
6. Green: テストがパスすることを確認
7. Refactor: コードを改善、テストは維持
8. CI実行: PR作成時に全テストが自動実行

#### テスト命名規則
- describe: 機能名またはクラス名
- it: 「should + 動詞」形式（例: `should return summary when valid URL`）
- Given-When-Then: テストケース内のコメント

#### テスト実行
| タイミング | コマンド |
|------------|---------|
| 開発中 | `pnpm test --watch`（ファイル変更時に自動実行） |
| PR作成時 | CI で全テスト自動実行 |
| デプロイ前 | 全テスト + カバレッジチェック |

## 2.5 設定ファイル基本要件

### TypeScript設定（tsconfig.json）
- strict モード: 有効化必須（型安全性の最大化）
- ESM対応: `"module": "ESNext"`, `"moduleResolution": "bundler"`
- パスエイリアス: `@/*` で `src/*` を参照可能にする
- 型チェック: `noUnusedLocals`, `noUnusedParameters` を有効化

### ESLint設定（eslint.config.js）
- Flat Config: ESLint 9.x の新形式（`eslint.config.js`）を使用
- 必須ルール: `no-unused-vars`, `no-console`（warn）, `@typescript-eslint` ルール
- 境界チェック: `eslint-plugin-boundaries` で依存関係違反を検出
- 自動修正: `--fix` オプションで自動修正可能なルールを優先

### Prettier設定
- 統一フォーマット: シングルクォート、セミコロンあり、タブ幅2
- ESLint統合: `eslint-config-prettier` で競合回避
- 自動実行: 保存時に自動フォーマット

### Vitest設定
- グローバル設定: テストファイルパターン `/__tests__//*.test.ts`
- カバレッジ: 本番投入前に最低60%を目標
- モック: `vi.mock()` で外部依存をモック化
- 並列実行: 高速化のためテストを並列実行

### Drizzle設定（drizzle.config.ts）
- 接続先: 環境変数 `DATABASE_URL` から取得
- スキーマパス: `src/shared/infrastructure/database/schema.ts`
- マイグレーションディレクトリ: `drizzle/migrations/`

## 2.6 デスクトップアプリケーション要件

### 2.6.1 ログ収集・永続化

#### ログ収集対象
| 種別 | 説明 |
|------|------|
| アプリケーションログ | Electronアプリ内で発生するログ（Main/Rendererプロセス） |
| ワークフローログ | ローカルエージェントが実行したワークフローの実行ログ |
| システムログ | ファイル監視、ネットワーク同期、プロセス管理のログ |
| エラーログ | 例外、クラッシュ、警告などの異常ログ |

#### ログ収集方法
- **自動収集**: Electron IPC経由でMain/Rendererプロセスのログを自動収集
- **ファイル監視**: 指定ディレクトリのログファイルを監視し、新規行を自動収集
- **API経由**: ローカルエージェントからREST API経由でログを受信

#### ログデータベーススキーマ（SQLite）

**logsテーブル**:
- ログID、タイムスタンプ、ログレベル、ソース種別、メッセージ
- コンテキスト（JSON）、ワークフローID、ユーザーID
- エラースタック、クラウド同期時刻

**artifactsテーブル**:
- 成果物ID、作成時刻、成果物タイプ、名前、説明
- コンテンツ（JSON）、ファイルパス、元ログID配列
- クラウド同期時刻

#### ログ永続化戦略
| 戦略 | 説明 |
|------|------|
| ローカル優先 | SQLiteに即座に保存（オフライン対応） |
| バックグラウンド同期 | 定期的にクラウドDB（Neon PostgreSQL）へ同期 |
| 差分同期 | `synced_at`フィールドで未同期ログのみ送信 |
| 圧縮転送 | 大量ログは圧縮してから転送（gzip） |

### 2.6.2 成果物生成エンジン

#### 成果物タイプ
1. **統計レポート**: ログレベル別集計、エラー発生頻度、ワークフロー実行統計
2. **時系列グラフ**: ログ発生数の時系列推移、エラー率の推移
3. **エラー分析レポート**: エラーの根本原因分析、頻出エラーパターン
4. **ワークフロー分析**: 実行時間、成功率、ボトルネック特定

#### 生成プロセス
1. ログDBから集計クエリ実行
2. データ加工・整形
3. テンプレート適用
4. 成果物生成
5. プレビュー表示またはファイルエクスポート

#### 成果物生成ライブラリ
| 用途 | ライブラリ |
|------|-----------|
| PDF生成 | `jsPDF` または `Puppeteer`（HTML→PDF変換） |
| グラフ生成 | `Chart.js` または `D3.js` |
| CSV生成 | `csv-writer` |
| JSON生成 | ネイティブJSON |

#### 成果物テンプレート
- Markdown形式: `templates/reports/error-analysis.md`
- HTML形式: `templates/reports/statistics.html`
- カスタムテンプレート: ユーザー定義可能

### 2.6.3 オフライン対応

#### オフライン機能
| 機能 | 説明 |
|------|------|
| ログ収集 | インターネット接続なしでも継続 |
| 成果物生成 | ローカルDBのみで完結 |
| 基本的な分析 | SQLiteクエリによる集計・分析 |
| キュー管理 | 同期待ちデータをキューに保持 |

#### オンライン復帰時の動作
1. 未同期ログを検出（`synced_at IS NULL`）
2. バックグラウンドで段階的に同期
3. 同期完了後に`synced_at`を更新
4. UI上で同期状態を表示

### 2.6.4 リアルタイム監視・通知

#### 監視対象
| 対象 | 条件 |
|------|------|
| エラー率 | 直近1時間のエラー発生率が閾値を超えた場合 |
| ワークフロー失敗 | 連続して失敗した場合 |
| ディスク容量 | SQLiteデータベースサイズが閾値を超えた場合 |
| 同期遅延 | クラウドDBとの同期が長時間失敗している場合 |

#### 通知方法
| 方法 | 説明 |
|------|------|
| OS通知 | Electronの`Notification` APIでデスクトップ通知 |
| トレイアイコン | システムトレイのアイコン変化（赤色など） |
| アプリ内通知 | アプリ内のバナー表示 |

#### 閾値設定
| 項目 | 閾値 |
|------|------|
| エラー率閾値 | 10%以上で通知 |
| 連続失敗閾値 | 3回連続失敗で通知 |
| DB容量閾値 | 500MB超で通知 |
| 同期遅延閾値 | 1時間同期失敗で通知 |

### 2.6.5 成果物エクスポート

#### エクスポート形式
| 形式 | 説明 |
|------|------|
| PDF | レポート全体をPDF化 |
| CSV | 統計データをCSV形式で出力 |
| JSON | ログデータや成果物データをJSON形式で出力 |
| Markdown | レポートをMarkdown形式で出力 |

#### エクスポート先
| 出力先 | 説明 |
|--------|------|
| ローカルファイル | ユーザーが指定したディレクトリ |
| クリップボード | データをクリップボードにコピー |
| メール添付 | 将来的にメール送信機能（オプション） |

#### エクスポートAPI
- 成果物IDとエクスポートオプション（形式、出力先、ファイルパス、メールアドレス）を受け取る
- 指定された形式・出力先に成果物をエクスポート
- 非同期処理で完了を保証

---

## 関連ドキュメント

- [プロジェクト概要](./01-overview.md)
- [テクノロジースタック](./03-technology-stack.md)
- [エラーハンドリング仕様](./07-error-handling.md)
