# デプロイメント (Deployment)

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

## 12.1 Railway 自動デプロイ（MVP）

### Git統合による自動デプロイ

- `main` ブランチへのプッシュ → 自動デプロイ

### railway.json 設定項目

| カテゴリ | 設定項目          | 説明                                            |
| -------- | ----------------- | ----------------------------------------------- |
| build    | builder           | NIXPACKS（Railway標準ビルダー、Dockerfile不要） |
| build    | buildCommand      | 依存関係インストール → Next.jsビルド            |
| deploy   | startCommand      | Next.js本番サーバー起動                         |
| deploy   | restartPolicyType | ON_FAILURE（失敗時のみ自動再起動）              |

### 設定項目の説明

| 設定項目          | 説明                                                                 |
| ----------------- | -------------------------------------------------------------------- |
| builder           | Nixpacks を使用（Dockerfile 不要で自動コンテナ化）                   |
| buildCommand      | pnpm で依存関係をインストール後、Next.js をビルド                    |
| startCommand      | ビルド済みの Next.js アプリケーションを本番モードで起動              |
| restartPolicyType | プロセスが異常終了した場合のみ自動再起動（正常終了時は再起動しない） |

---

## 12.2 GitHub Actions ワークフロー要件

### ワークフロー構成

| ファイル         | 用途                                                |
| ---------------- | --------------------------------------------------- |
| `ci.yml`         | PR時のCI（Lint・型チェック・テスト・ビルド）        |
| `backend-ci.yml` | バックエンドCD（Railway自動デプロイ + Discord通知） |
| `web-cd.yml`     | WebアプリCD（Railway自動デプロイ + Discord通知）    |
| `README.md`      | ワークフロー全体の可視化（Mermaid図）               |

### ci.yml の要件（PR時のCI）

#### トリガー条件

- PRが main ブランチに作成されたとき

#### 実行内容（必須）

1. リポジトリコードの取得
2. pnpm のセットアップ（バージョン: 9.x）
3. Node.js のセットアップ（バージョン: 22.x LTS）
4. pnpm キャッシュの有効化
5. 依存関係のインストール（frozen-lockfile モード）
6. TypeScript 型チェックの実行
7. ESLint によるコード品質チェック
8. Next.js ビルドの確認
9. Vitest によるユニットテストの実行

#### 品質ゲート

- すべてのステップが成功しない限り、PR をマージできないようにする
- テストは前のステップが失敗しても必ず実行する

### deploy.yml の要件（mainマージ時）

#### トリガー条件

- main ブランチへのプッシュ（PR マージ時）

#### 実行内容（必須）

1. Railway の自動デプロイが開始されたことを確認
2. Discord Webhook への通知：
   - 成功時: デプロイ開始通知（コミット情報、ブランチ、作成者を含む）
   - 失敗時: エラー通知

#### 通知要件

| 項目           | 説明                                         |
| -------------- | -------------------------------------------- |
| 形式           | Discord Embed 形式で視認性を向上             |
| 内容           | コミットハッシュ、ブランチ名、作成者を含める |
| タイムスタンプ | 付与する                                     |

### 再利用可能ワークフローの要件

| パラメータ         | デフォルト | 説明                             |
| ------------------ | ---------- | -------------------------------- |
| Node.js バージョン | 22         | Node.js のバージョン             |
| 作業ディレクトリ   | '.'        | モノレポ対応、ルートディレクトリ |

### ワークフロー可視化の要件

Mermaid図で以下を可視化：

- ワークフロー全体図: PR作成 → CI → レビュー → マージ → デプロイ → 通知
- CI ワークフロー詳細図: 各ステップの実行順序

### GitHub Secrets の要件

| Secret名              | 用途                          | 必須 |
| --------------------- | ----------------------------- | ---- |
| `RAILWAY_TOKEN`       | Railway CLIデプロイ認証       | Yes  |
| `RAILWAY_DOMAIN`      | バックエンドヘルスチェックURL | Yes  |
| `RAILWAY_WEB_DOMAIN`  | Webヘルスチェック URL         | No   |
| `DISCORD_WEBHOOK_URL` | Discord通知用WebhookURL       | No   |

#### セキュリティ要件

| 要件       | 説明                                  |
| ---------- | ------------------------------------- |
| 設定場所   | GitHub リポジトリの Settings から設定 |
| 注入方法   | 環境変数として安全に注入              |
| マスク処理 | ログに出力されないようマスク処理      |

---

## 関連ドキュメント

- [環境変数](./13-environment-variables.md)
- [テクノロジースタック](./03-technology-stack.md)
- [非機能要件](./02-non-functional-requirements.md)
