# デプロイメント (Deployment)

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 12.1 デプロイメント戦略概要

### デプロイ対象

| 対象                  | プラットフォーム | 更新頻度                  | 優先度 |
| --------------------- | ---------------- | ------------------------- | ------ |
| Web バックエンド      | Railway          | 機能追加・修正のたび      | 高     |
| Electron デスクトップ | GitHub Releases  | メジャー/マイナーリリース | 中     |

### デプロイフロー

1. 開発者がコードをプッシュ
2. GitHub ActionsでCI（型チェック・Lint・テスト・ビルド）を実行
3. CIが成功したらmainブランチにマージ
4. Railwayが自動デプロイを開始
5. デプロイ完了後、ヘルスチェックで正常性を確認
6. 問題があれば即座にロールバック

### 品質ゲート

| チェック項目         | 基準                 | 必須 |
| -------------------- | -------------------- | ---- |
| TypeScript型チェック | エラーゼロ           | Yes  |
| ESLint               | エラーゼロ           | Yes  |
| ビルド               | 成功                 | Yes  |
| ユニットテスト       | カバレッジ60%以上    | Yes  |
| E2Eテスト            | クリティカルパス通過 | No   |

---

## 12.2 Railway デプロイ戦略

### 12.2.1 無料枠の制限と最適化

#### 無料枠の上限（2025年時点）

| リソース | 上限      | 個人開発での評価     |
| -------- | --------- | -------------------- |
| 実行時間 | 月500時間 | 常時稼働は不可       |
| メモリ   | 512MB     | Next.jsには十分      |
| ディスク | 1GB       | ビルドキャッシュ注意 |
| 帯域幅   | 100GB/月  | 小規模なら十分       |

#### 最適化戦略

**ビルドサイズ削減**

- Next.jsのstandaloneモードを使用する
- 本番環境で不要な開発依存関係を除外する
- 画像や静的アセットを圧縮する

**メモリ使用削減**

- Node.jsのヒープサイズを環境変数で制限する
- 接続プーリングでDB接続数を最小化する
- メモリリークを定期的に監視する

**実行時間削減**

- アイドル時のスリープを許可する（5分無通信でスリープ）
- ヘルスチェック間隔を適切に設定する（過度な起動を防止）
- 深夜帯はスリープを許容してコストを削減する

### 12.2.2 スリープモード対策

#### 問題点

- 無料枠ではアイドル時に自動でスリープ状態になる
- スリープ後の初回リクエストはコールドスタートで10〜30秒の遅延が発生
- ユーザー体験が悪化する

#### 対策

**定期的なウォームアップ**

- GitHub Actionsで5分ごとにヘルスチェックを実行（営業時間帯のみ）
- 対象エンドポイント：`/api/health`
- 深夜帯（0-6時）はスリープを許容してコストを削減

**コールドスタート最適化**

- ヘルスチェックエンドポイントは軽量に実装（DB接続を含まない）
- データベース接続はレイジーロードにする
- 起動時の初期化処理を最小限にする

**ユーザー体験の改善**

- フロントエンドでローディング状態を明示的に表示する
- タイムアウト時は自動リトライする
- エラーメッセージで「サーバー起動中」と説明する

### 12.2.3 カスタムドメイン設定

#### 設定手順

1. Railwayダッシュボード → Settings → Domains でカスタムドメインを追加
2. DNSプロバイダーでCNAMEレコードを設定（値はRailwayが提供するドメイン）
3. SSL証明書はLet's Encryptで自動発行される
4. DNSプロパゲーションは最大48時間かかる場合がある

#### 注意点

- サブドメインの使用を推奨（例：`api.yourdomain.com`）
- ルートドメインの場合はAレコードまたはALIASが必要
- 証明書更新は自動で行われる

### 12.2.4 環境分離

#### 環境構成

| 環境         | 用途         | ブランチ  | デプロイトリガー |
| ------------ | ------------ | --------- | ---------------- |
| 開発         | ローカル開発 | -         | 手動             |
| ステージング | 本番前検証   | `develop` | プッシュ時自動   |
| 本番         | ユーザー提供 | `main`    | プッシュ時自動   |

#### 各環境で分離すべき項目

- データベースインスタンス（別々のTursoデータベース）
- 環境変数（APIキー、シークレット）
- ログレベル（開発：debug、本番：warn）
- 機能フラグ（新機能の段階的リリース）

#### ステージング環境のベストプラクティス

- 本番と同じ構成（DBスキーマ、環境変数構造）を維持する
- 本番データのサブセットを使用する（個人情報は匿名化）
- 本番デプロイ前に必ずステージングで動作確認する

---

## 12.3 GitHub Actions CI/CD パイプライン

### 12.3.1 ワークフロー構成

| ファイル         | 用途                                                |
| ---------------- | --------------------------------------------------- |
| `ci.yml`         | PR時のCI（Lint・型チェック・テスト・ビルド）        |
| `backend-cd.yml` | バックエンドCD（Railway自動デプロイ + Discord通知） |
| `web-cd.yml`     | WebアプリCD（Railway自動デプロイ + Discord通知）    |

### 12.3.2 CI ワークフロー要件（PR時）

#### トリガー条件

- PRがmainブランチに対して作成されたとき
- PRに新しいコミットがプッシュされたとき

#### 実行ステップ

1. リポジトリコードの取得
2. pnpmのセットアップ（バージョン: 9.x）
3. Node.jsのセットアップ（バージョン: 22.x LTS）
4. pnpmキャッシュの有効化
5. 依存関係のインストール（frozen-lockfileモード）
6. TypeScript型チェックの実行
7. ESLintによるコード品質チェック
8. Next.jsビルドの確認
9. Vitestによるユニットテストの実行

#### 品質ゲート

- すべてのステップが成功しない限りPRをマージできないようにする
- テストは前のステップが失敗しても必ず実行する

### 12.3.3 キャッシュ戦略

#### pnpm キャッシュ

| 項目           | 設定                                  |
| -------------- | ------------------------------------- |
| 対象           | pnpmストア、node_modules              |
| キャッシュキー | OS + pnpm-lock.yamlのハッシュ         |
| フォールバック | OS のみでマッチ                       |
| 効果           | 初回3-5分 → キャッシュヒット時30-60秒 |

#### ビルドキャッシュ

| 項目           | 設定                               |
| -------------- | ---------------------------------- |
| 対象           | `.next/cache`、`.tsbuildinfo`      |
| キャッシュキー | OS + Git SHA                       |
| フォールバック | OS + ブランチ名                    |
| 注意点         | ブランチごとにキャッシュを分離する |

### 12.3.4 並列実行の活用

#### 並列実行可能なジョブ

- lintとtypecheckは依存関係がないため並列実行可能
- 複数パッケージのテストは`--filter`で分離して並列実行

#### 順次実行必須なジョブ

- build → test（テストはビルド成果物が必要）
- test → deploy（品質ゲート通過後のみデプロイ）

#### GitHub Actions無料枠

- パブリックリポジトリ：無制限
- プライベートリポジトリ：月2,000分

### 12.3.5 CD ワークフロー要件（mainマージ時）

#### トリガー条件

- mainブランチへのプッシュ（PRマージ時）

#### 実行内容

1. Railwayの自動デプロイが開始されたことを確認
2. ヘルスチェックエンドポイントで正常性を確認
3. Discord Webhookへの通知を送信

#### 通知要件

| 項目           | 説明                                         |
| -------------- | -------------------------------------------- |
| 形式           | Discord Embed形式で視認性を向上              |
| 内容           | コミットハッシュ、ブランチ名、作成者を含める |
| タイムスタンプ | 付与する                                     |
| 成功時         | 緑色のEmbedでデプロイ完了を通知              |
| 失敗時         | 赤色のEmbedでエラー内容を通知                |

---

## 12.4 Electron アプリのリリース

### 12.4.1 ビルドターゲット

| OS      | 形式                | 配布方法        |
| ------- | ------------------- | --------------- |
| macOS   | `.dmg`, `.zip`      | GitHub Releases |
| Windows | `.exe`, `.msi`      | GitHub Releases |
| Linux   | `.AppImage`, `.deb` | GitHub Releases |

### 12.4.2 リリースフロー

1. `package.json`のバージョン番号を更新
2. `CHANGELOG.md`を更新
3. ローカルで各OSのビルドをテスト
4. セマンティックバージョニングでタグを作成（例：`v1.2.3`）
5. タグをプッシュ → GitHub Actionsが自動ビルド
6. 各OSの成果物がGitHub Releasesに自動アップロード
7. リリースノートを編集して公開

### 12.4.3 リリースチェックリスト

- [ ] バージョン番号を更新（`package.json`）
- [ ] `CHANGELOG.md`を更新
- [ ] ローカルでビルドをテスト（各OS）
- [ ] 主要機能の動作確認
- [ ] タグを作成してプッシュ
- [ ] GitHub Actionsの成功を確認
- [ ] リリースノートを編集
- [ ] ユーザーに通知（Discord、X等）

### 12.4.4 自動更新（electron-updater）

#### 設定項目

| 項目               | 説明                          |
| ------------------ | ----------------------------- |
| 更新サーバー       | GitHub Releasesを使用（無料） |
| チェックタイミング | アプリ起動時に自動チェック    |
| ダウンロード       | バックグラウンドで実行        |
| インストール       | ユーザー確認後に実行          |

#### 更新戦略

| 種類         | 対応                           |
| ------------ | ------------------------------ |
| 強制更新     | セキュリティパッチは即座に適用 |
| 任意更新     | 機能追加は次回起動時に促す     |
| スキップ可能 | パッチバージョンのみの場合     |

#### ユーザー体験の最適化

- アイドル時に更新を促す（作業中は通知を控える）
- 更新失敗時は手動ダウンロードリンクを提供
- ロールバック機能を実装する

### 12.4.5 コードサイニング

#### 各OSでの必要性

| OS      | 必要性 | 理由                           |
| ------- | ------ | ------------------------------ |
| macOS   | 高     | Gatekeeperの警告を回避するため |
| Windows | 中     | SmartScreen警告を軽減するため  |
| Linux   | 低     | 通常は不要                     |

#### macOS コードサイニング要件

- Apple Developer Programアカウント（年間99ドル）
- Developer ID Application証明書
- 公証（Notarization）の実行

#### 個人開発者向けの現実的な対応

- **macOS**: 投資対効果が高いため、コードサイニングを推奨
- **Windows**: リリースノートで「詳細情報」→「実行」の手順を案内
- **Linux**: 特別な対応は不要

---

## 12.5 ロールバック戦略

### 12.5.1 Railway でのロールバック

#### ロールバック手順

**ダッシュボードから**

1. Railwayダッシュボード → Deploymentsを開く
2. 前のデプロイメントを選択
3. 「Redeploy」をクリック

**CLIから**

- `railway rollback`コマンドを実行

#### ロールバック判断基準

| 状況                     | 対応               | 理由             |
| ------------------------ | ------------------ | ---------------- |
| ヘルスチェック失敗       | 即座にロールバック | サービス停止     |
| エラー率 > 5%            | ロールバック検討   | 品質低下         |
| パフォーマンス劣化 > 30% | ロールバック検討   | ユーザー体験悪化 |
| マイナー不具合           | 次回修正で対応     | 影響範囲が限定的 |

### 12.5.2 データベースマイグレーションのロールバック

#### 破壊的変更の回避原則

- カラム削除は即座に実行しない（非推奨マーク → 数リリース後に削除）
- テーブル削除は複数ステップで段階的に実施
- インデックス追加は本番適用前に影響をテスト

#### ロールバック戦略

| 変更種別     | 推奨アプローチ                           |
| ------------ | ---------------------------------------- |
| カラム追加   | NULL許容またはデフォルト値を設定         |
| カラム名変更 | 新カラム追加 → データ移行 → 旧カラム削除 |
| 型変更       | 新カラム作成 → 段階的移行                |
| テーブル削除 | リネーム → 一定期間保持 → 完全削除       |

#### 本番デプロイ前のチェックリスト

- [ ] ステージング環境でマイグレーションをテスト済み
- [ ] ロールバック手順を確認済み
- [ ] バックアップを取得済み
- [ ] 想定実行時間を見積もり済み

---

## 12.6 モニタリングとアラート

### 12.6.1 ヘルスチェックエンドポイント設計

#### 基本ヘルスチェック（`/api/health`）

| 項目             | 仕様                                 |
| ---------------- | ------------------------------------ |
| ステータスコード | 200                                  |
| レスポンス       | ステータスとタイムスタンプを含むJSON |
| 実行時間         | 100ms以内                            |
| 内容             | サーバー稼働状況のみ                 |

#### 詳細ヘルスチェック（`/api/health/detailed`）

| チェック項目     | 説明                   |
| ---------------- | ---------------------- |
| データベース接続 | Tursoへの接続確認      |
| 外部API疎通      | 依存サービスの応答確認 |
| メモリ使用量     | 閾値超過の検出         |

### 12.6.2 監視すべきメトリクス（ゴールデンシグナル）

| シグナル         | 測定項目          | 目標値           |
| ---------------- | ----------------- | ---------------- |
| レイテンシ       | p50, p95, p99     | p95 < 500ms      |
| トラフィック     | リクエスト数/分   | ベースライン把握 |
| エラー           | エラー率          | < 1%             |
| サチュレーション | CPU、メモリ使用率 | < 80%            |

### 12.6.3 Discord通知

#### 通知レベル

| レベル   | トリガー                           | 対応期限   |
| -------- | ---------------------------------- | ---------- |
| Critical | サービスダウン、エラー率>10%       | 即座に対応 |
| Warning  | エラー率5-10%、パフォーマンス劣化  | 24時間以内 |
| Info     | デプロイ成功、定期バックアップ完了 | 記録のみ   |

#### 通知抑制

- 同じアラートの連続送信を防止（5分間隔）
- メンテナンスモード時は通知を停止

### 12.6.4 エラー追跡（Sentry推奨）

#### 導入メリット

- スタックトレースの自動収集
- ユーザー影響の可視化
- リリースバージョンとの紐付け
- 無料枠：月5,000イベント

#### 設定時の注意点

- DSNは環境変数で管理する
- 開発環境のエラーは送信しない
- 既知のエラー（404等）は除外する
- 機密情報はサニタイズする

---

## 12.7 デプロイチェックリスト

### 12.7.1 リリース前の確認事項

#### コード品質

- [ ] すべてのテストが通過
- [ ] 型エラーがない
- [ ] Lintエラーがない
- [ ] セキュリティ脆弱性がない

#### 機能検証

- [ ] ステージング環境で動作確認
- [ ] クリティカルパスのテスト
- [ ] パフォーマンステスト
- [ ] モバイルブラウザでの動作確認

#### ドキュメント

- [ ] CHANGELOGを更新
- [ ] READMEを必要に応じて更新
- [ ] APIドキュメントを更新（該当時）

### 12.7.2 本番デプロイ時の注意点

#### 推奨タイミング

- 平日10-16時（問題発生時に対応可能）
- トラフィックが比較的低い時間帯

#### 避けるべきタイミング

- 金曜日午後（週末に問題持ち越しリスク）
- 祝日前日
- 大規模キャンペーン中

#### デプロイ後の対応

**成功時**

- Discord/Slackで完了通知
- リリースノート公開
- 24時間は監視を継続

**失敗時**

- 即座にロールバック
- 失敗原因の分析
- 修正後の再デプロイ計画

---

## 12.8 GitHub Secrets の要件

| Secret名              | 用途                          | 必須 |
| --------------------- | ----------------------------- | ---- |
| `RAILWAY_TOKEN`       | Railway CLIデプロイ認証       | Yes  |
| `RAILWAY_DOMAIN`      | バックエンドヘルスチェックURL | Yes  |
| `DISCORD_WEBHOOK_URL` | Discord通知用WebhookURL       | No   |

### セキュリティ要件

| 要件       | 説明                               |
| ---------- | ---------------------------------- |
| 設定場所   | GitHubリポジトリのSettingsから設定 |
| 注入方法   | 環境変数として安全に注入           |
| マスク処理 | ログに出力されないようマスク処理   |

---

## 関連ドキュメント

- [環境変数](./13-environment-variables.md)
- [テクノロジースタック](./03-technology-stack.md)
- [非機能要件](./02-non-functional-requirements.md)
- [セキュリティガイドライン](./17-security-guidelines.md)
