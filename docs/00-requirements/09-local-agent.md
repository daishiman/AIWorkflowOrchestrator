# ローカルエージェント仕様

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 9.1 機能概要

### 9.1.1 ローカルエージェントの役割

| 役割           | 説明                                               |
| -------------- | -------------------------------------------------- |
| ファイル監視   | 指定ディレクトリを監視し、ファイル追加・変更を検知 |
| クラウド同期   | 検知したファイルをクラウドにアップロード           |
| ローカルDB同期 | Turso Embedded Replicas によるローカルDBの同期     |
| 成果物取得     | 完了したワークフローの成果物をダウンロード         |
| オフライン対応 | ネットワーク切断時もローカルで動作継続             |

### 9.1.2 アーキテクチャ構成

| コンポーネント | 役割                           | 技術                    |
| -------------- | ------------------------------ | ----------------------- |
| File Watcher   | ファイルシステムイベントの監視 | Chokidar                |
| Sync Client    | クラウドAPIとの通信            | Fetch API               |
| Local Database | オフラインデータ保存           | Turso Embedded Replicas |
| Queue Manager  | 同期タスクのキュー管理         | インメモリキュー        |
| Health Monitor | 接続状態・メモリ監視           | 内部実装                |

### 9.1.3 動作モード

| モード  | 状態                 | 動作                               |
| ------- | -------------------- | ---------------------------------- |
| Online  | ネットワーク接続あり | 即座にクラウド同期                 |
| Offline | ネットワーク切断     | ローカルキューに蓄積、復帰後に同期 |
| Syncing | 同期処理中           | プログレス表示、キャンセル可能     |
| Error   | エラー発生           | リトライ、エラー通知               |

---

## 9.2 設定項目

### 9.2.1 必須環境変数

| 環境変数         | 説明                               | 例                                |
| ---------------- | ---------------------------------- | --------------------------------- |
| API_BASE_URL     | クラウドAPIのベースURL             | https://api.example.com           |
| AGENT_SECRET_KEY | エージェント認証キー（32文字以上） | 暗号論的ランダム文字列            |
| WATCH_DIR        | 監視対象ディレクトリのパス         | /Users/user/Documents/AI-Workflow |
| OUTPUT_DIR       | 成果物保存ディレクトリのパス       | /Users/user/Documents/AI-Output   |

### 9.2.2 オプション環境変数

| 環境変数              | デフォルト | 説明                                     |
| --------------------- | ---------- | ---------------------------------------- |
| POLL_INTERVAL_MS      | 30000      | クラウドポーリング間隔（ミリ秒）         |
| MAX_FILE_SIZE_MB      | 100        | アップロード可能な最大ファイルサイズ     |
| DEBOUNCE_MS           | 300        | ファイルイベントのデバウンス間隔         |
| MAX_RETRY_COUNT       | 3          | アップロード失敗時の最大リトライ回数     |
| RETRY_DELAY_MS        | 1000       | リトライ待機時間（初回、指数バックオフ） |
| LOG_LEVEL             | info       | ログレベル（debug, info, warn, error）   |
| HEARTBEAT_INTERVAL_MS | 60000      | ハートビート送信間隔                     |

### 9.2.3 Turso 関連設定

| 環境変数               | 説明                                           |
| ---------------------- | ---------------------------------------------- |
| TURSO_DATABASE_URL     | Tursoデータベース接続URL                       |
| TURSO_AUTH_TOKEN       | Turso認証トークン                              |
| TURSO_SYNC_INTERVAL_MS | Embedded Replicas同期間隔（デフォルト: 60000） |

---

## 9.3 ファイル監視

### 9.3.1 監視対象

| 項目               | 値                                             |
| ------------------ | ---------------------------------------------- |
| 対象拡張子         | .mp3, .mp4, .wav, .pdf, .txt, .csv, .json, .md |
| 最大ファイルサイズ | MAX_FILE_SIZE_MB 設定値                        |
| ディレクトリ深度   | 無制限（再帰的監視）                           |

### 9.3.2 除外パターン

| パターン             | 説明                         |
| -------------------- | ---------------------------- |
| .で始まるファイル    | 隠しファイル（.gitignore等） |
| ~で終わるファイル    | 一時ファイル（backup~等）    |
| .tmpで終わるファイル | 一時ファイル                 |
| node_modules/        | 依存関係ディレクトリ         |
| .git/                | Gitディレクトリ              |
| **pycache**/         | Python キャッシュ            |
| .DS_Store            | macOSメタデータ              |
| Thumbs.db            | Windowsサムネイルキャッシュ  |

### 9.3.3 監視イベント

| イベント | トリガー         | 処理                                     |
| -------- | ---------------- | ---------------------------------------- |
| add      | 新規ファイル追加 | アップロードキューに追加                 |
| change   | ファイル内容変更 | 変更内容をアップロード（差分または全体） |
| unlink   | ファイル削除     | クラウド側に削除通知（オプション）       |
| error    | 監視エラー       | エラーログ出力、監視再起動               |

### 9.3.4 デバウンス処理

| 設定 | 説明                                   |
| ---- | -------------------------------------- |
| 目的 | 連続したファイル変更イベントをまとめる |
| 間隔 | DEBOUNCE_MS（デフォルト300ms）         |
| 動作 | 最後のイベントから間隔経過後に処理実行 |

---

## 9.4 クラウド同期

### 9.4.1 アップロードフロー

| 順序 | ステップ     | 説明                                           |
| ---- | ------------ | ---------------------------------------------- |
| 1    | ファイル検出 | Watcher がファイル追加/変更を検知              |
| 2    | 検証         | ファイルサイズ、拡張子、除外パターンをチェック |
| 3    | キュー追加   | アップロードキューにタスクを追加               |
| 4    | チャンク分割 | 大きなファイルは分割（10MB単位）               |
| 5    | アップロード | POST /api/v1/agent/sync でアップロード         |
| 6    | 完了確認     | サーバーからの応答を確認                       |
| 7    | ローカル更新 | 同期状態をローカルDBに記録                     |

### 9.4.2 ダウンロードフロー

| 順序 | ステップ       | 説明                                        |
| ---- | -------------- | ------------------------------------------- |
| 1    | ポーリング     | GET /api/v1/agent/status で完了タスクを確認 |
| 2    | メタデータ取得 | 成果物のメタデータを取得                    |
| 3    | ダウンロード   | 成果物ファイルをダウンロード                |
| 4    | 保存           | OUTPUT_DIR に保存                           |
| 5    | 通知           | デスクトップ通知を表示（Electron経由）      |

### 9.4.3 コンフリクト解決

| シナリオ                         | 解決方法                           |
| -------------------------------- | ---------------------------------- |
| ローカル変更とクラウド変更が競合 | タイムスタンプが新しい方を優先     |
| 同時編集                         | ユーザーに選択を促すダイアログ表示 |
| 削除とダウンロードが競合         | クラウド側の状態を優先             |

---

## 9.5 オフライン対応

### 9.5.1 Turso Embedded Replicas

| 項目             | 説明                                          |
| ---------------- | --------------------------------------------- |
| 機能             | ローカルにSQLiteレプリカを保持                |
| 同期方向         | 双方向（クラウド↔ローカル）                   |
| 同期タイミング   | TURSO_SYNC_INTERVAL_MS 間隔または手動トリガー |
| コンフリクト解決 | Last-Write-Wins（最終書き込み優先）           |

### 9.5.2 オフラインキュー

| 項目             | 説明                                   |
| ---------------- | -------------------------------------- |
| 保存場所         | ローカルDB（SQLite）                   |
| キュー項目       | ファイルパス、操作種別、タイムスタンプ |
| 最大キューサイズ | 1000件（超過時は古いものから破棄）     |
| 復帰時の動作     | キューを順次処理、失敗は再キュー       |

### 9.5.3 接続状態管理

| 状態         | 判定基準                | 動作                     |
| ------------ | ----------------------- | ------------------------ |
| Connected    | ハートビート応答あり    | 通常同期                 |
| Disconnected | ハートビート3回連続失敗 | オフラインモードに移行   |
| Reconnecting | 接続復旧試行中          | 指数バックオフでリトライ |

---

## 9.6 エラーハンドリング

### 9.6.1 リトライ戦略

| 設定             | 値                                 | 説明                  |
| ---------------- | ---------------------------------- | --------------------- |
| 最大リトライ回数 | MAX_RETRY_COUNT（デフォルト3）     |                       |
| 初期待機時間     | RETRY_DELAY_MS（デフォルト1000ms） |                       |
| バックオフ係数   | 2                                  | 待機時間を2倍ずつ増加 |
| 最大待機時間     | 30000ms                            |                       |

### 9.6.2 エラー種別と対応

| エラー種別             | リトライ | 対応                   |
| ---------------------- | -------- | ---------------------- |
| ネットワークエラー     | あり     | オフラインキューに追加 |
| 認証エラー（401）      | なし     | 設定確認を促す通知     |
| サーバーエラー（5xx）  | あり     | バックオフリトライ     |
| ファイル読み取りエラー | なし     | エラーログ、スキップ   |
| ディスク容量不足       | なし     | 警告通知、処理停止     |

### 9.6.3 エラー通知

| 通知先           | 条件           | 内容                               |
| ---------------- | -------------- | ---------------------------------- |
| デスクトップ通知 | 致命的エラー   | エラー概要、対処方法               |
| ログファイル     | すべてのエラー | 詳細なエラー情報、スタックトレース |
| クラウドログ     | オンライン時   | エラーサマリー（機密情報除外）     |

---

## 9.7 セキュリティ

### 9.7.1 認証

| 項目     | 説明                               |
| -------- | ---------------------------------- |
| 認証方式 | AGENT_SECRET_KEY によるAPI認証     |
| ヘッダー | X-Agent-Key: {AGENT_SECRET_KEY}    |
| キー要件 | 32文字以上の暗号論的ランダム文字列 |
| キー保存 | 環境変数またはシステムキーチェーン |

### 9.7.2 データ保護

| 項目       | 対策                               |
| ---------- | ---------------------------------- |
| 通信暗号化 | HTTPS必須（TLS 1.2以上）           |
| ローカルDB | ファイルシステム権限で保護         |
| 認証情報   | メモリ上で暗号化保持               |
| ログ出力   | 機密情報（キー、トークン）をマスク |

### 9.7.3 ファイルアクセス制限

| 制限               | 説明                             |
| ------------------ | -------------------------------- |
| 監視対象           | WATCH_DIR 配下のみ               |
| 出力先             | OUTPUT_DIR 配下のみ              |
| シンボリックリンク | フォローしない（セキュリティ上） |
| パストラバーサル   | 検証して拒否                     |

---

## 9.8 PM2 プロセス管理

### 9.8.1 ecosystem.config.js 設定

| 設定項目           | 値                | 説明                                 |
| ------------------ | ----------------- | ------------------------------------ |
| name               | ai-workflow-agent | プロセス識別名                       |
| script             | ./dist/index.js   | エントリーポイント                   |
| instances          | 1                 | シングルインスタンス（重複監視防止） |
| autorestart        | true              | クラッシュ時に自動再起動             |
| max_restarts       | 10                | 最大再起動回数（無限ループ防止）     |
| restart_delay      | 5000              | 再起動待機時間（5秒）                |
| max_memory_restart | 500M              | メモリ超過時に再起動                 |

### 9.8.2 ログ設定

| 設定項目        | 値                  | 説明                 |
| --------------- | ------------------- | -------------------- |
| log_date_format | YYYY-MM-DD HH:mm:ss | タイムスタンプ形式   |
| error_file      | ./logs/error.log    | エラーログ出力先     |
| out_file        | ./logs/out.log      | 標準出力ログ         |
| merge_logs      | true                | ログ統合             |
| log_type        | json                | JSON形式ログ（推奨） |

### 9.8.3 運用コマンド

| コマンド                      | 説明                     |
| ----------------------------- | ------------------------ |
| pm2 start ecosystem.config.js | エージェント起動         |
| pm2 stop ai-workflow-agent    | エージェント停止         |
| pm2 restart ai-workflow-agent | エージェント再起動       |
| pm2 logs ai-workflow-agent    | ログ表示                 |
| pm2 monit                     | リアルタイムモニタリング |

---

## 9.9 ヘルスチェック

### 9.9.1 内部ヘルスチェック

| チェック項目     | 正常条件   | チェック間隔 |
| ---------------- | ---------- | ------------ |
| メモリ使用量     | 500MB未満  | 60秒         |
| ファイルWatcher  | 動作中     | 60秒         |
| キューサイズ     | 1000件未満 | 60秒         |
| ディスク空き容量 | 1GB以上    | 300秒        |

### 9.9.2 外部ヘルスチェック

| エンドポイント               | メソッド | 説明                          |
| ---------------------------- | -------- | ----------------------------- |
| POST /api/v1/agent/heartbeat | POST     | エージェントの生存確認        |
| リクエスト内容               | -        | agent_id, status, metrics     |
| レスポンス                   | -        | last_sync_time, pending_tasks |

### 9.9.3 アラート条件

| 条件                | アラートレベル | アクション     |
| ------------------- | -------------- | -------------- |
| メモリ80%超過       | Warning        | ログ出力       |
| メモリ90%超過       | Critical       | 再起動         |
| キュー500件超過     | Warning        | ログ出力       |
| ハートビート失敗    | Warning        | リトライ開始   |
| ディスク空き1GB未満 | Critical       | 処理停止、通知 |

---

## 9.10 開発・デバッグ

### 9.10.1 開発モード設定

| 環境変数         | 開発時の値  | 説明               |
| ---------------- | ----------- | ------------------ |
| NODE_ENV         | development | 開発環境           |
| LOG_LEVEL        | debug       | 詳細ログ出力       |
| POLL_INTERVAL_MS | 5000        | 短いポーリング間隔 |

### 9.10.2 デバッグ方法

| 方法       | 説明                                  |
| ---------- | ------------------------------------- |
| ログ確認   | pm2 logs または logs/ディレクトリ参照 |
| 状態確認   | /api/v1/agent/status エンドポイント   |
| 手動同期   | 管理画面から同期トリガー              |
| キュー確認 | ローカルDBのsync_queueテーブル参照    |

---

## 関連ドキュメント

- [Electron デスクトップアプリ仕様](./15-electron-app.md)
- [環境変数](./13-environment-variables.md)
- [デプロイメント](./12-deployment.md)
- [REST API 設計原則](./08-api-design.md)
- [データベース設計](./03-database-design.md)
