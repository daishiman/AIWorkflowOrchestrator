# Claude Code 3層アーキテクチャ設計仕様書

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 18.1 概要

### 18.1.1 本仕様書の目的

本仕様書は、Claude Code の3層アーキテクチャ（Command / Agent / Skill）の設計仕様を定義する。本仕様書に従うことで、100人中100人が同一の構造・品質のコンポーネントを作成できることを目標とする。

### 18.1.2 適用範囲

| 対象         | パス                           | 責務                     |
| ------------ | ------------------------------ | ------------------------ |
| コマンド     | `.claude/commands/ai/*.md`     | ユーザーインターフェース |
| エージェント | `.claude/agents/*.md`          | ワークフロー実行         |
| スキル       | `.claude/skills/[skill-name]/` | 知識・スクリプト提供     |

### 18.1.3 設計思想

| 原則               | 説明                                                     |
| ------------------ | -------------------------------------------------------- |
| 責務の完全分離     | 各層は単一責務を持ち、他層の責務を侵犯しない             |
| 依存の一方向性     | Command → Agent → Skill の方向のみ依存を許可する         |
| 確実な実行の分離   | AIの不確実性を排除すべき処理はスクリプトに委譲する       |
| 軽量なコンテキスト | 必要な情報を必要な時にのみ取得する                       |
| 自己進化           | スキルは使用されるたびにフィードバックを蓄積し改善される |

---

## 18.2 3層アーキテクチャ

### 18.2.1 層の定義

| 層            | ディレクトリ           | 責務                                   | AI/確定             |
| ------------- | ---------------------- | -------------------------------------- | ------------------- |
| Interface層   | `.claude/commands/ai/` | ユーザー入力受付、エージェント起動指示 | AI                  |
| Application層 | `.claude/agents/`      | ワークフロー制御、判断、スキル参照     | AI                  |
| Domain層      | `.claude/skills/`      | 知識提供、確実な実行、出力テンプレート | 読取専用 + 確定実行 |

### 18.2.2 依存関係ルール

**依存の方向**（以下の方向のみ許可、逆方向は禁止）:

| 依存元  | 依存先                            |
| ------- | --------------------------------- |
| Command | Agent（起動指示のみ）             |
| Agent   | Skill（知識参照、スクリプト実行） |
| Skill   | なし（外部依存ゼロ）              |

**禁止事項**:

- Command が Skill を直接参照すること
- Agent が他の Agent に依存すること（Task ツール経由の協調は許可）
- Skill が Agent や Command を参照すること
- 循環依存の形成

### 18.2.3 各層の責務境界

**Command層が行うこと**:

- ユーザー向け説明の提供
- 引数の定義と受付
- 起動するエージェントの指定
- 期待される成果物の宣言

**Command層が行わないこと**:

- ワークフローの詳細定義
- ビジネスロジックの実装
- スキルの直接参照
- ファイル操作の実行

**Agent層が行うこと**:

- ワークフロー（Phase）の制御
- スキルの参照と知識の取得
- スクリプトの実行指示
- 判断と意思決定
- エラーハンドリング
- 他エージェントへのハンドオフ

**Agent層が行わないこと**:

- 詳細なドメイン知識の保持
- 知識の永続的な保存
- ユーザー入力の直接受付

**Skill層が行うこと**:

- ドメイン知識の提供
- 判断基準・ルールの定義
- スクリプトによる確実な実行
- テンプレートによる出力形式の標準化
- 変更履歴の記録
- 評価基準の定義

**Skill層が行わないこと**:

- ワークフローの制御
- 他スキルの実行
- エージェントへの指示

---

## 18.3 Command（コマンド）仕様

### 18.3.1 ファイル配置

| 配置場所               | 用途                             |
| ---------------------- | -------------------------------- |
| `.claude/commands/ai/` | プロジェクト共通のAI関連コマンド |
| `.claude/commands/`    | プロジェクト固有のコマンド       |
| `~/.claude/commands/`  | ユーザー個人のグローバルコマンド |

### 18.3.2 YAML Frontmatter 必須フィールド

| フィールド      | 型       | 必須 | 説明                                                       |
| --------------- | -------- | ---- | ---------------------------------------------------------- |
| `description`   | string   | 必須 | コマンドの説明（起動エージェント、利用スキル、設定を含む） |
| `allowed-tools` | string[] | 必須 | 使用許可するツールのリスト                                 |

### 18.3.3 YAML Frontmatter 任意フィールド

| フィールド      | 型     | 説明                                   |
| --------------- | ------ | -------------------------------------- |
| `argument-hint` | string | 引数のヒント（例: `"[command-name]"`） |
| `model`         | string | 使用モデル（sonnet/opus/haiku）        |

### 18.3.4 description フィールドの記述形式

```
description: |
  {{コマンドの目的（1-2行）}}

  🤖 起動エージェント:
  - `.claude/agents/{{agent-name}}.md`: {{エージェントの役割}}

  ⚙️ このコマンドの設定:
  - argument-hint: {{引数の説明}}
  - allowed-tools: {{ツールリストの説明}}
  - model: {{モデル選択理由}}

  トリガーキーワード: {{keyword1}}, {{keywordN}}
```

**記述規則**:

| 規則                 | 説明                                                     |
| -------------------- | -------------------------------------------------------- |
| エージェントのみ記述 | スキルはエージェントが参照するため、コマンドでは記述不要 |
| 相対パス必須         | `.claude/agents/{{agent-name}}.md` 形式で記述            |
| スキル参照は委譲     | スキル情報はエージェントの description で管理            |

### 18.3.5 allowed-tools の設定規則

**基本ツール（ファイル操作）**:

| パターン            | 説明                                                |
| ------------------- | --------------------------------------------------- |
| `Read`              | ファイル読み取り（画像、PDF、Jupyter Notebook対応） |
| `Write`             | ファイル書き込み（新規作成・上書き）                |
| `Write(.claude/**)` | パス制限付き書き込み                                |
| `Edit`              | ファイル編集（部分的な置換）                        |
| `Glob`              | ファイルパターンマッチング（ファイル一覧取得）      |
| `Grep`              | ファイル内容のパターン検索                          |
| `NotebookEdit`      | Jupyter Notebook のセル編集                         |

**実行ツール**:

| パターン           | 説明                                                   |
| ------------------ | ------------------------------------------------------ |
| `Bash`             | シェルコマンド実行                                     |
| `Bash(pnpm run *)` | 特定コマンドパターンに制限                             |
| `Task`             | サブエージェント起動（エージェント起動コマンドで必須） |
| `TaskOutput`       | バックグラウンドタスクの出力取得                       |
| `KillShell`        | バックグラウンドシェルの終了                           |
| `Skill`            | スキルの実行                                           |

**情報取得ツール**:

| パターン                  | 説明                      |
| ------------------------- | ------------------------- |
| `WebSearch`               | Web検索（最新情報の取得） |
| `WebFetch`                | Webページの取得           |
| `WebFetch(domain:docs.*)` | 特定ドメインに制限        |

**対話ツール**:

| パターン          | 説明                           |
| ----------------- | ------------------------------ |
| `AskUserQuestion` | ユーザーへの質問（選択肢提示） |
| `TodoWrite`       | タスクリストの管理             |

**MCPツール**（設定されている場合）:

| パターン                | 説明                            |
| ----------------------- | ------------------------------- |
| `mcp__[server]__[tool]` | MCPサーバー経由のツール呼び出し |
| `mcp__context7__*`      | Context7 ドキュメント検索       |
| `mcp__brave-search__*`  | Brave Search API                |

**パス制限の記法**:

| 記法                           | 説明                              |
| ------------------------------ | --------------------------------- |
| `Write(.claude/**)`            | .claude/ 以下のみ書き込み許可     |
| `Write(apps/**/src/**)`        | apps配下のsrcディレクトリのみ許可 |
| `Bash(git *)`                  | gitコマンドのみ許可               |
| `Bash(pnpm run *)`             | pnpm runコマンドのみ許可          |
| `WebFetch(domain:example.com)` | 特定ドメインのみ許可              |

**最小権限の原則**:

- コマンドの目的に必要最小限のツールのみ許可する
- パス制限（例: `Write(.claude/**)`）を可能な限り使用する
- 破壊的操作（削除、上書き）には明示的な確認を求める

### 18.3.6 本文の必須セクション

| セクション             | 必須 | 説明                    |
| ---------------------- | ---- | ----------------------- |
| 目的                   | 必須 | コマンドの目的（1-2文） |
| エージェント起動フロー | 必須 | Phase別の処理フロー     |

### 18.3.7 エージェント起動フローの記述形式

**フェーズテンプレート（各フェーズ共通）**:

```markdown
### Phase {{phase_number}}: {{phase_name}}

**目的**: {{phase_purpose}}

**背景**: {{phase_background}}

**ゴール**: {{phase_goal}}

**起動エージェント**: `.claude/agents/{{agent_name}}.md`

Task ツールで `.claude/agents/{{agent_name}}.md` を起動:

**コンテキスト**:

- {{context_item_1}}
- {{context_item_N}}

**依頼内容**:

- {{request_item_1}}
- {{request_item_N}}

**期待成果物**:

- {{artifact_1}}
- {{artifact_N}}

**完了条件**:

- [ ] {{completion_condition_1}}
- [ ] {{completion_condition_N}}
```

**テンプレート変数の説明**:

| 変数                         | 説明                                         |
| ---------------------------- | -------------------------------------------- |
| `{{phase_number}}`           | フェーズ番号（1, 2, 3, ...）                 |
| `{{phase_name}}`             | フェーズ名（例: 要件分析、設計、実装、検証） |
| `{{phase_purpose}}`          | このフェーズで何を達成するか                 |
| `{{phase_background}}`       | なぜこのフェーズが必要か                     |
| `{{phase_goal}}`             | このフェーズの具体的なゴール                 |
| `{{agent_name}}`             | 起動するエージェント名（ケバブケース）       |
| `{{context_item_N}}`         | エージェントに渡すコンテキスト情報           |
| `{{request_item_N}}`         | エージェントへの依頼内容                     |
| `{{artifact_N}}`             | このフェーズで生成される成果物               |
| `{{completion_condition_N}}` | フェーズ完了の判定条件                       |

**フェーズ構成パターン**:

| パターン | フェーズ構成                                                                        | 用途                   |
| -------- | ----------------------------------------------------------------------------------- | ---------------------- |
| シンプル | Phase 1（実行）→ Phase 2（検証）                                                    | 単一タスク             |
| 標準     | Phase 1（準備）→ Phase 2（実行）→ Phase 3（検証）                                   | 一般的なタスク         |
| 複合     | Phase 1（分析）→ Phase 2（設計）→ Phase 3（実装）→ Phase 4（検証）→ Phase 5（報告） | 複雑なタスク           |
| 並列     | Phase 1（準備）→ Phase 2a/2b（並列実行）→ Phase 3（統合）→ Phase 4（検証）          | 並列処理が必要なタスク |
| 条件分岐 | Phase 1（分析）→ Phase 2（条件判定）→ Phase 3a or 3b（分岐実行）→ Phase 4（統合）   | 条件による処理分岐     |

**エージェント起動の記述ルール**:

| ルール                 | 説明                                          |
| ---------------------- | --------------------------------------------- |
| 相対パス必須           | `.claude/agents/{{agent_name}}.md` 形式で記述 |
| 1フェーズ1エージェント | 各フェーズで起動するエージェントは1つ         |
| コンテキスト明示       | 前フェーズからの引き継ぎ情報を明記            |
| 成果物明示             | 生成されるファイルパスを具体的に記述          |
| 完了条件明示           | 次フェーズに進む条件を明確化                  |

### 18.3.8 model 選択基準

| モデル   | 選択基準                                   |
| -------- | ------------------------------------------ |
| `haiku`  | 単純なタスク、高速処理が必要な場合         |
| `sonnet` | 標準的なタスク、バランス重視（デフォルト） |
| `opus`   | 複雑な設計、高度な判断が必要な場合         |

### 18.3.9 コマンド設計原則

| 原則     | 説明                                                 |
| -------- | ---------------------------------------------------- |
| ハブ特化 | コマンドはエージェント・スキル呼び出しのハブに徹する |
| 詳細委譲 | 詳細な実装手順はエージェント・スキルに委譲する       |
| 単一責任 | 1コマンド = 1ユーザーアクション                      |
| 冪等性   | 同じ入力に対して同じ結果を返す                       |

### 18.3.10 命名規則

| 規則         | 説明                                                      |
| ------------ | --------------------------------------------------------- |
| 動詞ベース   | `create-`, `analyze-`, `review-`, `build-` で始める       |
| ケバブケース | 単語間はハイフンで接続（例: `create-agent`）              |
| 具体的       | 抽象的な名前を避ける（`do-task` ではなく `analyze-logs`） |

### 18.3.11 command_list.md 仕様

**目的**: 利用可能な全コマンドのインデックスを提供し、コマンドの発見性を向上させる。

**ファイル配置**: `.claude/commands/ai/command_list.md`

**必須セクション**:

| セクション       | 説明                                                                 |
| ---------------- | -------------------------------------------------------------------- |
| カテゴリ見出し   | コマンドをカテゴリ別にグループ化（例: プロジェクト初期化、要件定義） |
| コマンドエントリ | 各コマンドの詳細情報                                                 |

**コマンドエントリの記述形式**:

```markdown
### /ai:{{command-name}}

- 目的: {{コマンドの目的（1行）}}
- 引数: {{引数名}} - {{説明}}（オプション/必須）
- model: {{sonnet/opus/haiku}}
- トリガーキーワード: {{keyword1}}, {{keywordN}}, {{keyword3}}
```

**エントリに含める情報**:

| 項目               | 必須 | 説明                                           |
| ------------------ | ---- | ---------------------------------------------- |
| 目的               | 必須 | コマンドの目的（1行で簡潔に）                  |
| 引数               | 必須 | 引数の名前、説明、必須/オプションの区別        |
| model              | 必須 | 使用するモデル                                 |
| トリガーキーワード | 推奨 | 自動発動のためのキーワード（日本語・英語両方） |

**カテゴリ構成テンプレート**:

```markdown
## {{カテゴリ名}}

{{カテゴリの概要説明（1-2行）}}

### /ai:{{command-name-1}}

- 目的: {{目的}}
- 引数: {{引数}}
- model: {{model}}

### /ai:{{command-name-N}}

...
```

**カテゴリ設計規則**:

| 規則                   | 説明                                               |
| ---------------------- | -------------------------------------------------- |
| SDLC フェーズ対応      | ソフトウェア開発ライフサイクルの各フェーズに対応   |
| 動詞ベースのグループ   | create-, analyze-, review- などの動詞でグループ化  |
| メタ操作は別セクション | エージェント・スキル・コマンド作成は独立セクション |

---

## 18.4 Agent（エージェント）仕様

### 18.4.1 ファイル配置

| パス                           | 説明                             |
| ------------------------------ | -------------------------------- |
| `.claude/agents/*.md`          | プロジェクト固有のエージェント   |
| `.claude/agents/agent_list.md` | エージェント一覧（インデックス） |

### 18.4.2 YAML Frontmatter 必須フィールド

| フィールド    | 型       | 必須 | 説明                                       |
| ------------- | -------- | ---- | ------------------------------------------ |
| `name`        | string   | 必須 | エージェント識別子（ケバブケース）         |
| `description` | string   | 必須 | エージェントの説明（依存スキル一覧を含む） |
| `tools`       | string[] | 必須 | 使用可能ツールのリスト                     |

### 18.4.3 YAML Frontmatter 任意フィールド

| フィールド | 型     | 説明                            |
| ---------- | ------ | ------------------------------- |
| `model`    | string | 使用モデル（sonnet/opus/haiku） |

### 18.4.4 description フィールドの記述形式

```
description: |
  {{エージェントの目的と専門分野（2-3行）}}

  📚 依存スキル ({{N}}個):
  このエージェントは以下のスキルを読み込んでタスクを実行します:

  - `.claude/skills/{{skill-name}}/SKILL.md`: {{スキルの用途（20-40文字）}}

  Use proactively when {{英語での発動条件}}
```

**記述の原則**:

| 原則                   | 説明                                                       |
| ---------------------- | ---------------------------------------------------------- |
| SKILL.mdへの参照のみ   | スキルの相対パスと用途のみ記述                             |
| 内部詳細は不要         | スクリプト、リソース、テンプレートの情報は記述しない       |
| Progressive Disclosure | スキル内部の詳細はSKILL.mdを読めば分かるため、ここでは不要 |

### 18.4.5 依存スキルの記述規則

**目的**: エージェントがスキルを確実に参照し、タスクを実行できるようにする。

**スキルの役割**:

| 要素           | 説明                                                 |
| -------------- | ---------------------------------------------------- |
| 知識           | ドメイン固有の専門知識、判断基準、ベストプラクティス |
| 実行手順       | Phase別のステップバイステップの実行フロー            |
| 詳細な実行内容 | スクリプト、テンプレート、リソースファイル           |

**記述規則**:

| 規則                 | 説明                                                |
| -------------------- | --------------------------------------------------- |
| 相対パス必須         | `.claude/skills/{{skill-name}}/SKILL.md` 形式で記述 |
| スキル数明記         | `📚 依存スキル ({{N}}個):` で総数を明記             |
| 用途説明必須         | 各スキルに20-40文字の用途説明を付与                 |
| 知識・実行内容を明示 | スキルが提供する「知識」と「実行内容」を記述        |
| Phase別マッピング    | 本文でどのPhaseでどのスキルを読み込むか明記         |

**エージェントとスキルの関係**:

```
エージェント（タスク実行者）
    │
    ├── スキルA を読み込み
    │   ├── 知識を取得（判断基準、ベストプラクティス）
    │   ├── 実行手順に従う（Phase別フロー）
    │   └── scripts/ を実行（確実な処理）
    │
    └── スキルB を読み込み
        └── ...
```

### 18.4.6 本文の必須セクション

| セクション         | 必須 | 説明                                 |
| ------------------ | ---- | ------------------------------------ |
| 役割定義           | 必須 | エージェントの役割と起動時の動作原則 |
| スキル読み込み指示 | 必須 | Phase別スキルマッピング              |
| 専門分野           | 必須 | 詳細な専門分野の説明                 |
| 責任範囲           | 必須 | 担当するファイルパス、操作           |
| 制約               | 必須 | やってはいけないこと                 |
| ワークフロー       | 必須 | Phase別の実行フロー                  |
| 品質基準           | 推奨 | 完了条件、成功の定義                 |
| エラーハンドリング | 推奨 | 失敗時の対応方法                     |

### 18.4.7 役割定義セクションの記述形式

```markdown
## 役割定義

{{Agent Nameの概要説明を記述}}

**🔴 MANDATORY - 起動時の動作原則**:

このエージェントが起動されたら、**以下の原則に従ってください**:

**原則1: スキルを読み込んでタスクを実行する**

このエージェントは以下のスキルを参照してタスクを実行します:

| Phase | 読み込むスキル | スキルの相対パス                      | 取得する内容       |
| ----- | -------------- | ------------------------------------- | ------------------ |
| 1     | {{skill-1}}    | `.claude/skills/{{skill-1}}/SKILL.md` | {{知識・実行手順}} |
| N     | {{skill-N}}    | `.claude/skills/{{skill-N}}/SKILL.md` | {{知識・実行手順}} |

**原則2: スキルから知識と実行手順を取得**

各スキルを読み込んだら:

1. SKILL.md の概要と参照書籍から知識を取得
2. ワークフローセクションから実行手順を取得
3. 必要に応じて scripts/ を実行
```

**役割定義の記述規則**:

| 規則                       | 説明                                           |
| -------------------------- | ---------------------------------------------- |
| スキルパスをテーブルで明示 | Phase別に読み込むスキルと相対パスを記述        |
| 取得内容を明記             | そのスキルから何を取得するかを記述             |
| 実行手順を参照             | スキルのワークフローに従って実行することを明記 |

### 18.4.8 ワークフローセクションの記述形式

```markdown
## ワークフロー

### Phase {{phase_number}}: {{phase_name}}

**目的**: {{このフェーズで何を達成するか}}

**背景**: {{なぜこのフェーズが必要か}}

**ゴール**: {{このフェーズの具体的な完了状態}}

**読み込むスキル**:

- `.claude/skills/{{skill-name}}/SKILL.md`

**スキル参照の原則**:

1. まず SKILL.md のみを読み込む
2. SKILL.md 内の description で必要なリソース（resources/, scripts/, templates/ など）を確認
3. 必要に応じて該当するリソースのみを追加で読み込む

**アクション**:

1. {{アクション1}}
2. {{アクションN}}

**期待成果物**:

- {{成果物1}}
- {{成果物N}}

**完了条件**:

- [ ] {{条件1}}
- [ ] {{条件N}}
```

**ワークフロー設計規則**:

| 規則                   | 説明                                                               |
| ---------------------- | ------------------------------------------------------------------ |
| 目的・背景・ゴール必須 | 各フェーズで何を達成するか明確に記述                               |
| スキル参照は段階的     | SKILL.md → 必要なリソースの順で Progressive Disclosure             |
| 成果物を明示           | 各フェーズで生成されるファイルパスを具体的に記述                   |
| 完了条件はチェック可能 | 自動または手動で検証可能な条件を設定                               |
| 最終フェーズは記録     | 最終Phaseに「記録と評価」を含め、使用スキルの`log_usage.mjs`を実行 |

**記録フェーズの組み込み**:

すべてのエージェントのワークフローは、最終Phaseで使用したスキルの実行記録を保存する。
詳細は 18.12.3「エージェントワークフローへの組み込み」を参照。

### 18.4.9 行数制約

| 項目             | 制約                       |
| ---------------- | -------------------------- |
| エージェント本文 | 450-550行を目標            |
| 超過時の対応     | 詳細知識をスキルに分離する |
| 最大行数         | 800行を超えないこと        |

### 18.4.10 ペルソナ設計

| 要素         | 説明                                     |
| ------------ | ---------------------------------------- |
| モデル人物   | 実在する専門家または著名な方法論の提唱者 |
| 参照書籍     | モデル人物の著作または関連書籍           |
| 専門分野     | モデル人物の専門知識を反映               |
| 思考パターン | モデル人物のアプローチを模倣             |

### 18.4.11 ツール権限設定

| ツール  | 用途                         | 注意事項                 |
| ------- | ---------------------------- | ------------------------ |
| `Read`  | スキル・ドキュメント読み取り | ほぼ全エージェントで必要 |
| `Write` | ファイル生成                 | パス制限を検討           |
| `Grep`  | パターン検索                 | 既存コード調査時         |
| `Glob`  | ファイル一覧取得             | 構造把握時               |
| `Bash`  | スクリプト実行               | 検証スクリプト実行時     |
| `Task`  | サブエージェント起動         | マルチエージェント協調時 |

### 18.4.12 エージェント間協調

| 協調パターン               | 説明                                             |
| -------------------------- | ------------------------------------------------ |
| 委譲（Delegation）         | 上位エージェントが下位エージェントにタスクを委譲 |
| 連鎖（Chaining）           | エージェントが順次処理を引き継ぐ                 |
| 並行（Parallel）           | 複数エージェントが独立して並行実行               |
| フィードバック（Feedback） | 後続エージェントが前段に結果をフィードバック     |

### 18.4.13 ハンドオフプロトコル

| フィールド   | 型       | 説明                     |
| ------------ | -------- | ------------------------ |
| `from_agent` | string   | 送信元エージェント名     |
| `to_agent`   | string   | 送信先エージェント名     |
| `status`     | string   | completed/partial/failed |
| `summary`    | string   | 実施内容サマリー         |
| `artifacts`  | string[] | 生成したファイルパス     |
| `context`    | object   | 引き継ぎコンテキスト     |

### 18.4.14 agent_list.md 仕様

**目的**: 利用可能な全エージェントのインデックスを提供し、エージェントの発見性と役割理解を向上させる。

**ファイル配置**: `.claude/agents/agent_list.md`

**必須セクション**:

| セクション            | 説明                             |
| --------------------- | -------------------------------- |
| チーム/カテゴリ見出し | エージェントを役割別にグループ化 |
| エージェントエントリ  | 各エージェントの詳細情報         |

**エージェントエントリの記述形式**:

```markdown
#### {{番号}}. {{役割名}}

- エージェント名: `@{{agent-name}}`
- エージェントの配置: `.claude/agents/{{agent-name}}.md`
- モデル: {{sonnet/opus/haiku}}
- モデル人物: {{実在する専門家名}} - {{専門分野}}
- 目的: {{エージェントの目的（1行）}}
- 背景: {{なぜこのエージェントが必要か}}
- 責務: {{具体的な責務（カンマ区切り）}}
```

**エントリに含める情報**:

| 項目               | 必須 | 説明                           |
| ------------------ | ---- | ------------------------------ |
| エージェント名     | 必須 | `@` プレフィックス付きの識別子 |
| エージェントの配置 | 必須 | ファイルパス（相対パス）       |
| モデル             | 必須 | 使用するモデル                 |
| モデル人物         | 推奨 | ペルソナの参照人物             |
| 目的               | 必須 | エージェントの目的             |
| 背景               | 推奨 | 存在理由の説明                 |
| 責務               | 必須 | 具体的な責務リスト             |

**チーム/カテゴリ構成テンプレート**:

```markdown
## {{チーム名}}

{{チームの責務概要（1-2行）}}

#### {{番号}}. {{役割名}}

- エージェント名: `@{{agent-name}}`
- エージェントの配置: `.claude/agents/{{agent-name}}.md`
- モデル: {{sonnet/opus/haiku}}
- モデル人物: {{実在する専門家名}} - {{専門分野}}
- 目的: {{目的}}
- 背景: {{背景}}
- 責務: {{責務}}
```

**チーム設計規則**:

| 規則                   | 説明                                                     |
| ---------------------- | -------------------------------------------------------- |
| SDLC フェーズ対応      | ソフトウェア開発ライフサイクルの各フェーズに対応         |
| 専門分野でグループ化   | フロントエンド、バックエンド、インフラ等で分類           |
| モデル人物は実在専門家 | 各分野の著名な専門家（例: Robert C. Martin）を参照       |
| メタ操作は別チーム     | エージェント・スキル・コマンド作成は独立チームとして管理 |

---

## 18.5 Skill（スキル）仕様

### 18.5.1 標準フォルダ構造

| パス                    | 必須 | 説明                                           |
| ----------------------- | ---- | ---------------------------------------------- |
| `SKILL.md`              | 必須 | メインファイル（500行以内）                    |
| `EVALS.json`            | 必須 | 評価指標・レベルアップ条件                     |
| `CHANGELOG.md`          | 必須 | セマンティックバージョニングによる履歴管理     |
| `LOGS.md`               | 必須 | 実行記録とログ（log_usage.mjsが書き込む）      |
| `scripts/log_usage.mjs` | 必須 | 標準ログスクリプト（フィードバックループの核） |
| `scripts/`              | 推奨 | その他の確実な実行を保証するスクリプト         |
| `resources/`            | 推奨 | レベル別詳細ガイド                             |
| `templates/`            | 任意 | 出力フォーマットテンプレート                   |

**scripts/log_usage.mjs の役割**:

すべてのスキルに必須の標準スクリプト。エージェントの最終Phaseで呼び出され、以下を自動実行：

- LOGS.md への実行記録追記
- EVALS.json のメトリクス更新
- レベルアップ条件の評価と自動昇格
- CHANGELOG.md への変更記録

詳細は 18.12.4 を参照。

### 18.5.2 YAML Frontmatter 必須フィールド

| フィールド     | 型       | 必須 | 説明                                         |
| -------------- | -------- | ---- | -------------------------------------------- |
| `name`         | string   | 必須 | スキル識別子（ケバブケース）                 |
| `description`  | string   | 必須 | スキルの概要（書籍参照・リソース参照を含む） |
| `version`      | string   | 必須 | セマンティックバージョン                     |
| `level`        | number   | 必須 | スキルレベル（1-4）                          |
| `last_updated` | string   | 必須 | 最終更新日（YYYY-MM-DD形式）                 |
| `references`   | object[] | 必須 | 参照書籍リスト（下記参照）                   |

### 18.5.3 references フィールドの構造

**目的**: 書籍名は「圧縮された知識体系への参照」として機能し、AIが実装方針を理解するためのアンカーとなる。

```yaml
references:
  - book: "{{書籍名}}"
    author: "{{著者名}}"
    concepts:
      - "{{適用するコンセプト1}}"
      - "{{適用するコンセプトN}}"
```

**記述規則**:

| 規則                 | 説明                                                       |
| -------------------- | ---------------------------------------------------------- |
| 書籍名で大枠を掴む   | 細かな記述ではなく、書籍名で知識体系全体を参照             |
| 適用コンセプトを明示 | その書籍の中で何を適用するかを明記                         |
| 著名な書籍を優先     | 業界で広く認知された書籍を選択（AIの学習データに含まれる） |
| 1スキル1-3冊         | 過度に多くの書籍を参照しない                               |

**書籍参照の効果**:

| 効果               | 説明                                                             |
| ------------------ | ---------------------------------------------------------------- |
| 知識の圧縮         | 数百ページの内容を書籍名1行で参照可能                            |
| 実装方針の明確化   | AIが書籍の内容を理解しているため、詳細な説明が不要               |
| 一貫性の確保       | 同じ書籍を参照することで、プロジェクト全体の設計思想が統一される |
| メンテナンス性向上 | 細かな記述を更新する必要がなく、書籍参照のみで知識が維持される   |

### 18.5.4 YAML Frontmatter 任意フィールド

| フィールド     | 型       | 説明             |
| -------------- | -------- | ---------------- |
| `author`       | string   | 作成者           |
| `tags`         | string[] | 検索用タグ       |
| `dependencies` | string[] | 依存スキルのパス |

### 18.5.5 description フィールドの記述形式

```
description: |
  {{スキルの概要説明（1-3行）}}

  📖 参照書籍:
  - 『{{書籍名}}』（{{著者名}}）: {{適用コンセプト}}

  📚 リソース参照:
  - `resources/{{file}}.md`: {{用途}}
  - `scripts/{{file}}.mjs`: {{用途}}
  - `templates/{{file}}.md`: {{用途}}

  Use proactively when {{英語での発動条件}}
```

**記述の優先順位**:

| 優先度 | 項目         | 説明                                             |
| ------ | ------------ | ------------------------------------------------ |
| 1      | 参照書籍     | 書籍名で知識体系全体を参照（最重要）             |
| 2      | リソース参照 | スキル配下のファイルへの相対パス                 |
| 3      | 発動条件     | このスキルを使用すべきタイミング（英語で簡潔に） |

### 18.5.6 本文の必須セクション

| セクション           | 必須 | 説明                                 |
| -------------------- | ---- | ------------------------------------ |
| 概要                 | 必須 | スキルの目的と主要な価値             |
| ワークフロー         | 必須 | Phase ベースの実行フロー             |
| ベストプラクティス   | 必須 | すべきこと/避けるべきことのリスト    |
| 関連スキル           | 推奨 | 他スキルとの関係（フルパスで記述）   |
| コマンドリファレンス | 推奨 | スクリプト・リソースへのアクセス方法 |
| 変更履歴             | 必須 | バージョン・日付・変更内容のテーブル |

### 18.5.7 行数制約

| 項目          | 制約                         |
| ------------- | ---------------------------- |
| SKILL.md 本文 | 500行以内                    |
| 超過時の対応  | 詳細を resources/ に分離する |

### 18.5.8 skill_list.md 仕様

**目的**: 利用可能な全スキルのインデックスを提供し、スキルの発見性とエージェントへの割り当てを効率化する。

**ファイル配置**: `.claude/skills/skill_list.md`

**必須セクション**:

| セクション         | 説明                                               |
| ------------------ | -------------------------------------------------- |
| エージェント見出し | スキルを使用するエージェント別にグループ化         |
| スキルエントリ     | 各スキルの詳細情報（テーブル形式）                 |
| 共通スキル         | 複数エージェントで使用されるスキル（別セクション） |

**スキルエントリの記述形式**:

```markdown
## {{番号}}. {{エージェント役割名}}

- **エージェント名:** `@{{agent-name}}`
- **エージェントの配置:** `.claude/agents/{{agent-name}}.md`

| スキル名           | パス                                     | 概要                |
| ------------------ | ---------------------------------------- | ------------------- |
| **{{skill-name}}** | `.claude/skills/{{skill-name}}/SKILL.md` | {{20-40文字の概要}} |
```

**エントリに含める情報**:

| 項目                | 必須 | 説明                                 |
| ------------------- | ---- | ------------------------------------ |
| スキル名            | 必須 | ケバブケースの識別子                 |
| パス                | 必須 | SKILL.md までのフルパス              |
| 概要                | 必須 | 20-40文字でスキルの用途を説明        |
| リソース/スクリプト | 任意 | 含まれる resources/, scripts/ の詳細 |

**カテゴリ構成パターン**:

| 構成パターン           | 説明                                               |
| ---------------------- | -------------------------------------------------- |
| エージェント別グループ | 各エージェントが使用するスキルを見出しでグループ化 |
| 共通スキルセクション   | 複数エージェントで共有されるスキルを別セクションに |
| 新規追加セクション     | 日付別に追加されたスキルを時系列で記録             |

**更新ルール**:

| ルール             | 説明                                                 |
| ------------------ | ---------------------------------------------------- |
| スキル作成時       | 対応するエージェントセクションにエントリを追加       |
| エージェント作成時 | 新規見出しセクションを追加                           |
| 共有スキル追加時   | 共通スキルセクションに追加し、使用エージェントを明記 |
| 陳腐化スキル削除時 | エントリを削除し、CHANGELOG に記録                   |

---

## 18.6 .claude/skills/{{skill-name}}/resources/ ディレクトリ仕様

### 18.6.1 目的

Progressive Disclosure に基づき、レベル別の詳細ガイドを提供する。

### 18.6.2 標準ファイル構成

| ファイル                 | レベル | 対象   | 内容                                             |
| ------------------------ | ------ | ------ | ------------------------------------------------ |
| `Level1_basics.md`       | 基礎   | 初学者 | SKILL.md のみで完結するシンプルな使用法          |
| `Level2_intermediate.md` | 中級   | 実務者 | scripts/、resources/、templates/ の活用法        |
| `Level3_advanced.md`     | 上級   | 熟練者 | Progressive Disclosure 設計、トークン最適化      |
| `Level4_expert.md`       | 専門   | 設計者 | 自己進化するスキル設計、フィードバックループ構築 |

### 18.6.3 各レベルファイルの必須セクション

| セクション     | 説明                           |
| -------------- | ------------------------------ |
| 概要           | このレベルで学べること         |
| 前提条件       | 必要な前提知識・前レベルの完了 |
| 詳細ガイド     | 本題の詳細説明                 |
| 実践手順       | ステップバイステップの手順     |
| チェックリスト | 理解度確認用のチェック項目     |

### 18.6.4 追加リソースファイル

| ファイル種別           | 命名規則                     | 説明                    |
| ---------------------- | ---------------------------- | ----------------------- |
| 概念説明               | `[concept-name].md`          | 特定概念の詳細説明      |
| パターン集             | `[pattern-type]-patterns.md` | 実装パターンのカタログ  |
| リファレンス           | `[topic]-reference.md`       | APIや仕様のリファレンス |
| トラブルシューティング | `troubleshooting.md`         | よくある問題と解決策    |

### 18.6.5 行数制約

| 項目                   | 制約                      |
| ---------------------- | ------------------------- |
| Level1_basics.md       | 200行以内                 |
| Level2_intermediate.md | 300行以内                 |
| Level3_advanced.md     | 400行以内                 |
| Level4_expert.md       | 500行以内                 |
| その他リソース         | 300行以内（超過時は分割） |

---

## 18.7 .claude/skills/{{skill-name}}/scripts/ ディレクトリ仕様

### 18.7.1 目的

AIの不確実性を排除し、確実な実行を保証する処理をスクリプトに委譲する。

### 18.7.2 スクリプトの分類概念

**性質による分類**:

| 性質               | 説明                                                 | 命名パターン            |
| ------------------ | ---------------------------------------------------- | ----------------------- |
| 参照系（読み取り） | 状態を変更せず、情報を取得・検証・分析するスクリプト | `{{動詞}}_{{対象}}.mjs` |
| 更新系（書き込み） | 状態を変更する処理を実行するスクリプト               | `{{動詞}}_{{対象}}.mjs` |

**実行の確実性による分類**:

| 性質               | 説明                                       | 設計上の要求           |
| ------------------ | ------------------------------------------ | ---------------------- |
| 冪等性あり         | 何度実行しても同じ結果になる処理           | 推奨（可能な限り）     |
| 冪等性なし         | 実行のたびに状態が変化する処理             | 明示的なドキュメント化 |
| トランザクション性 | 全成功または全失敗を保証する必要がある処理 | ロールバック機構を実装 |

**責務範囲による分類**:

| 責務範囲   | 説明                                                            |
| ---------- | --------------------------------------------------------------- |
| 環境準備   | 実行環境の初期化、依存関係のセットアップ                        |
| データ操作 | データの作成・更新・削除、永続化                                |
| 外部連携   | API呼び出し、外部サービスとの連携                               |
| 成果物生成 | ファイル・コード・リソースの生成                                |
| 状態管理   | アプリケーション状態の変更、マイグレーション                    |
| 記録・評価 | 実行記録の追記、メトリクス更新、レベル評価（`log_usage.mjs`等） |

### 18.7.3 スクリプト実装要件

| 要件       | 説明                                          |
| ---------- | --------------------------------------------- |
| 冪等性     | 何度実行しても同じ結果になること              |
| エラー出力 | stderr に詳細なエラーメッセージを出力すること |
| 引数検証   | 必須引数の存在を確認すること                  |
| ヘルプ     | `-h` または `--help` でヘルプを表示すること   |
| 終了コード | 成功時は0、失敗時は非0を返すこと              |

### 18.7.4 終了コード規則

| 終了コード | 意味           |
| ---------- | -------------- |
| 0          | 成功           |
| 1          | 一般的なエラー |
| 2          | 引数エラー     |
| 3          | ファイル不在   |
| 4          | 検証失敗       |
| 5          | 依存関係エラー |

### 18.7.5 スクリプトの標準構造（Node.js/mjs）

```javascript
#!/usr/bin/env node

// 1. インポート
import { ... } from '...';

// 2. 定数定義
const EXIT_SUCCESS = 0;
const EXIT_ERROR = 1;
const EXIT_ARGS_ERROR = 2;

// 3. ヘルプ表示関数
function showHelp() {
  console.log(`
Usage: node ${process.argv[1]} [options] <arguments>

Options:
  -h, --help    Show this help message
  ...
  `);
}

// 4. メイン処理
async function main() {
  // 引数解析
  // バリデーション
  // 処理実行
  // 結果出力
}

// 5. エラーハンドリング付き実行
main().catch(err => {
  console.error(err.message);
  process.exit(EXIT_ERROR);
});
```

### 18.7.6 スクリプトで実行可能な処理の概念

**処理の性質による分類**:

| 性質                 | 説明                                        | 確実性                       |
| -------------------- | ------------------------------------------- | ---------------------------- |
| 同期的処理           | 順序が保証され、結果が即座に得られる処理    | 高                           |
| 非同期処理           | 並行実行、コールバック、Promiseベースの処理 | 中（適切な実装で高）         |
| ファイルシステム操作 | 読み書き、検証、メタデータ取得              | 高（OSレベル）               |
| 外部システム連携     | API、データベース、ネットワーク通信         | 中（エラーハンドリング必須） |

**実装レイヤーによる分類**:

| レイヤー                 | 説明                                          |
| ------------------------ | --------------------------------------------- |
| システムレイヤー         | OS機能、ファイルシステム、プロセス管理        |
| アプリケーションレイヤー | ビジネスロジック、データ変換、状態管理        |
| 連携レイヤー             | 外部API、データベース、サードパーティサービス |

**データの永続性による分類**:

| 永続性             | 説明                                       |
| ------------------ | ------------------------------------------ |
| 揮発的             | メモリ内処理、一時ファイル、セッション情報 |
| 永続的             | データベース、ファイル保存、外部ストレージ |
| トランザクション的 | ACID特性を持つ操作、ロールバック可能な処理 |

---

## 18.8 .claude/skills/{{skill-name}}/templates/ ディレクトリ仕様

### 18.8.1 目的

出力形式を標準化し、一貫性のある成果物を生成する。

### 18.8.2 テンプレートの分類概念

**出力形式による分類**:

| 形式         | 用途                                       | 命名パターン                |
| ------------ | ------------------------------------------ | --------------------------- |
| テキスト形式 | ドキュメント、設定ファイル、人間が読む出力 | `{{name}}-template.{{ext}}` |
| データ形式   | 構造化データ、マシンリーダブルな出力       | `{{name}}-template.{{ext}}` |
| コード形式   | プログラムコード、実行可能なスクリプト     | `{{name}}-template.{{ext}}` |

**テンプレートの性質による分類**:

| 性質   | 説明                                               |
| ------ | -------------------------------------------------- |
| 静的   | 変数置換のみで完結するテンプレート                 |
| 動的   | 条件分岐・繰り返しを含むテンプレート               |
| 部分的 | 他のテンプレートから参照されるパーシャル           |
| 複合的 | 複数のパーシャルを組み合わせて構成するテンプレート |

### 18.8.3 テンプレート変数の記法概念

**変数の役割による分類**:

| 役割           | 説明                                             |
| -------------- | ------------------------------------------------ |
| 単純置換       | 値をそのまま埋め込む変数                         |
| 制御構造       | 条件分岐や繰り返しなどのロジック制御             |
| 部分参照       | 他のテンプレート片を参照・埋め込み               |
| 変換・フィルタ | 値を変換してから埋め込む（大文字化、日付形式等） |

### 18.8.4 テンプレートファイルの構造

**必須要素**:

| 要素             | 説明                         |
| ---------------- | ---------------------------- |
| ヘッダーコメント | テンプレートの目的、使用方法 |
| 変数一覧         | 使用する変数の説明           |
| テンプレート本文 | 変数を用いた出力構造         |

**テンプレート記述形式**:

```markdown
<!--
テンプレート名: {{template_name}}
目的: {{template_purpose}}

変数一覧:
- {{variable_1}}: {{variable_1_description}}
- {{variable_2}}: {{variable_2_description}}
-->

{{header_section}}

{{#if condition_variable}}
{{conditional_content}}
{{/if}}

{{#each collection_variable}}

- {{item_property_1}}: {{item_property_2}}
  {{/each}}

{{footer_section}}
```

**記述規則**:

| 規則             | 説明                                                 |
| ---------------- | ---------------------------------------------------- |
| 変数のみ使用     | 具体的な値は記述せず、すべて`{{variable}}`形式で記述 |
| 構造を明示       | セクション構造、階層構造を変数で示す                 |
| 制御構造を活用   | 条件分岐・繰り返しで柔軟性を確保                     |
| コメントで説明   | 各セクションの役割をコメントで明記                   |
| 具体例を含めない | 具体的な値の例は記述しない（AIが状況に応じて選択）   |

---

## 18.9 .claude/skills/{{skill-name}}/EVALS.json 仕様

### 18.9.1 目的

スキルの品質評価とレベルアップ条件を定義する。

### 18.9.2 構造

| フィールド      | 型     | 説明                |
| --------------- | ------ | ------------------- |
| `skill_name`    | string | スキル識別子        |
| `current_level` | number | 現在のレベル（1-4） |
| `levels`        | object | レベル別の条件定義  |
| `metrics`       | object | 評価メトリクス      |

### 18.9.3 levels オブジェクトの構造

| フィールド         | 型       | 説明                            |
| ------------------ | -------- | ------------------------------- |
| `level`            | number   | レベル番号                      |
| `name`             | string   | レベル名（基礎/中級/上級/専門） |
| `requirements`     | object   | 昇格条件                        |
| `success_criteria` | string[] | 成功基準のリスト                |

### 18.9.4 requirements オブジェクトの構造

| フィールド               | 型       | 説明                        |
| ------------------------ | -------- | --------------------------- |
| `min_usage_count`        | number   | 最小使用回数                |
| `min_success_rate`       | number   | 最小成功率（0.0-1.0）       |
| `min_satisfaction_score` | number   | 最小満足度スコア（0.0-1.0） |
| `required_resources`     | string[] | 必要なリソースファイル      |

### 18.9.5 metrics オブジェクトの構造

| フィールド             | 型     | 説明                       |
| ---------------------- | ------ | -------------------------- |
| `total_usage_count`    | number | 累計使用回数               |
| `success_count`        | number | 成功回数                   |
| `failure_count`        | number | 失敗回数                   |
| `average_satisfaction` | number | 平均満足度                 |
| `last_evaluated`       | string | 最終評価日（ISO 8601形式） |

---

## 18.10 .claude/skills/{{skill-name}}/CHANGELOG.md 仕様

### 18.10.1 目的

スキルの変更履歴をセマンティックバージョニングで管理する。

### 18.10.2 セマンティックバージョニング規則

| バージョン要素 | 変更時                                 |
| -------------- | -------------------------------------- |
| MAJOR（X.0.0） | 後方互換性のない変更（構造変更、削除） |
| MINOR（0.X.0） | 後方互換性のある機能追加               |
| PATCH（0.0.X） | バグ修正、軽微な改善                   |

### 18.10.3 記述形式

| フィールド | 形式                              | 説明                     |
| ---------- | --------------------------------- | ------------------------ |
| バージョン | `## [X.Y.Z]`                      | セマンティックバージョン |
| 日付       | `- YYYY-MM-DD`                    | 変更日                   |
| 変更種別   | `### Added/Changed/Fixed/Removed` | 変更の種類               |
| 変更内容   | `- [内容]`                        | 具体的な変更内容         |

### 18.10.4 変更種別の定義

| 種別       | 使用場面                               |
| ---------- | -------------------------------------- |
| Added      | 新機能、新リソース、新スクリプトの追加 |
| Changed    | 既存機能の変更、改善                   |
| Fixed      | バグ修正、誤記訂正                     |
| Removed    | 機能、リソースの削除                   |
| Deprecated | 将来削除予定の機能                     |
| Security   | セキュリティ関連の修正                 |

---

## 18.11 .claude/skills/{{skill-name}}/LOGS.md 仕様

### 18.11.1 目的

スキルの実行記録を保存し、フィードバックループの基盤とする。

### 18.11.2 記録対象

| 項目           | 必須 | 説明                   |
| -------------- | ---- | ---------------------- |
| 実行日時       | 必須 | ISO 8601形式           |
| 実行者         | 任意 | 実行したエージェント名 |
| 入力パラメータ | 推奨 | 主要な入力値           |
| 実行結果       | 必須 | 成功/失敗              |
| 満足度         | 推奨 | 1-5のスケール          |
| フィードバック | 推奨 | 改善提案、問題点       |

### 18.11.3 ログローテーション

| 項目       | 規則                                |
| ---------- | ----------------------------------- |
| 保持期間   | 最新100件を保持                     |
| アーカイブ | 古いログは `logs/archive/` に移動   |
| 集計       | 月次で metrics を EVALS.json に反映 |

---

## 18.12 フィードバックループ

### 18.12.1 目的

スキルが使用されるたびにフィードバックを収集し、継続的に改善する仕組みを提供する。

### 18.12.2 実装方式

**採用方式**: エージェント責務方式（明示的な記録フェーズ）

**理由**:

- 確実性が最も高い（ワークフローに組み込むため記録漏れがない）
- AIの不確実性を排除（スクリプトで確実に実行）
- メンテナンス性が高い（エージェントテンプレートで標準化）

### 18.12.3 エージェントワークフローへの組み込み

**必須Phase**: すべてのエージェントの最終Phaseに「記録と評価」を追加

````markdown
### Phase {{N}}: 記録と評価

**目的**: スキル使用実績を記録し、継続的改善に貢献する

**背景**: スキルの成長には使用データの蓄積が不可欠

**ゴール**: 実行記録が保存され、メトリクスが更新された状態

**読み込むスキル**: なし

**アクション**:

1. 使用したスキルの `scripts/log_usage.mjs` を実行
   ```bash
   node .claude/skills/{{skill-name}}/scripts/log_usage.mjs \
     --result {{success|failure}} \
     --phase "{{phase_name}}" \
     --agent "{{agent_name}}"
   ```
````

2. スクリプトが自動的に以下を実行:
   - LOGS.md に実行記録を追記
   - EVALS.json のメトリクスを更新
   - レベルアップ条件をチェック
   - 条件充足時に SKILL.md の level を更新
   - CHANGELOG.md に記録

**期待成果物**:

- 更新された LOGS.md
- 更新された EVALS.json
- （条件充足時）更新された SKILL.md と CHANGELOG.md

**完了条件**:

- [ ] log_usage.mjs が exit code 0 で終了
- [ ] LOGS.md に新規エントリが追記されている

```

### 18.12.4 標準ログスクリプトの仕様

**ファイル名**: `scripts/log_usage.mjs`

**責務**:

| 処理             | 説明                                       |
| ---------------- | ------------------------------------------ |
| 実行記録の追記   | LOGS.md にタイムスタンプ付きエントリを追加 |
| メトリクス更新   | EVALS.json の使用回数・成功率を更新        |
| レベル評価       | 現在のメトリクスがレベルアップ条件を満たすかチェック |
| 自動レベルアップ | 条件充足時に SKILL.md の level を更新      |
| 変更履歴記録     | レベルアップ時に CHANGELOG.md に追記       |

**引数**:

| 引数       | 必須 | 説明                        |
| ---------- | ---- | --------------------------- |
| `--result` | 必須 | `success` または `failure`  |
| `--phase`  | 任意 | 実行したフェーズ名          |
| `--agent`  | 任意 | 実行したエージェント名      |
| `--notes`  | 任意 | 追加のフィードバックメモ    |

**処理フロー**:

```

1. 引数を解析
2. LOGS.md に新規エントリを追記
3. EVALS.json を読み込み
4. メトリクス（total_usage_count, success_count等）を更新
5. 現在のレベルの requirements をチェック
6. 条件充足時:
   - SKILL.md の level と last_updated を更新
   - CHANGELOG.md に新バージョンを追記
7. EVALS.json を保存
8. exit 0

```

### 18.12.5 エージェントテンプレートへの標準化

**meta-agent-designer の責務**:

新規エージェント作成時、ワークフローテンプレートに「記録と評価」Phaseを自動的に含める。

**既存エージェントの更新**:

一度だけ、全エージェントに「記録と評価」Phaseを追加する移行作業を実施。

---

## 18.13 Progressive Disclosure

### 18.13.1 目的

トークン効率を最適化し、必要な情報を必要な時にのみ読み込む。

### 18.13.2 開示レベル

| レベル  | 読み込み対象                                | トークン目安  |
| ------- | ------------------------------------------- | ------------- |
| Level 0 | YAML Frontmatter のみ                       | 最小          |
| Level 1 | SKILL.md 本文                               | 500行以内     |
| Level 2 | resources/Level1_basics.md                  | 追加200行程度 |
| Level 3 | resources/Level2_intermediate.md + scripts/ | 追加300行程度 |
| Level 4 | すべてのリソース                            | 最大          |

### 18.13.3 読み込み判断基準

| 条件                 | 読み込むレベル |
| -------------------- | -------------- |
| スキルの存在確認のみ | Level 0        |
| 基本的な使用         | Level 1        |
| 詳細な使用法が必要   | Level 2        |
| スクリプト実行が必要 | Level 3        |
| スキル設計・改善     | Level 4        |

---

## 18.14 品質基準

### 18.14.1 コマンド作成時のチェックリスト

| チェック項目                                   | 検証方法            |
| ---------------------------------------------- | ------------------- |
| YAML Frontmatter が有効である                  | YAML パーサーで検証 |
| description に起動エージェントが明記されている | grep で検証         |
| allowed-tools が最小権限になっている           | 手動確認            |
| 本文にエージェント起動フローがある             | 構造確認            |

### 18.14.2 エージェント作成時のチェックリスト

| チェック項目                             | 検証方法            |
| ---------------------------------------- | ------------------- |
| YAML Frontmatter が有効である            | YAML パーサーで検証 |
| name がケバブケースである                | 正規表現で検証      |
| description に依存スキルが列挙されている | grep で検証         |
| 依存スキルがフルパス形式である           | grep で検証         |
| 本文が450-550行範囲内である              | `wc -l`             |
| Phase別スキルマッピングがある            | 構造確認            |

### 18.14.3 スキル作成時のチェックリスト

| チェック項目                                 | 検証方法            |
| -------------------------------------------- | ------------------- |
| SKILL.md が500行以内である                   | `wc -l SKILL.md`    |
| YAML Frontmatter が有効である                | YAML パーサーで検証 |
| 必須フィールドがすべて存在する               | スクリプトで検証    |
| version がセマンティックバージョン形式である | 正規表現で検証      |
| EVALS.json が有効な JSON である              | JSON パーサーで検証 |
| CHANGELOG.md が存在する                      | ファイル存在確認    |
| 関連スキル参照がフルパス形式である           | grep で検証         |

### 18.14.4 レベル別品質要件

| レベル  | 要件                                                  |
| ------- | ----------------------------------------------------- |
| Level 1 | SKILL.md + EVALS.json + CHANGELOG.md が存在する       |
| Level 2 | Level 1 + scripts/ または resources/ が存在する       |
| Level 3 | Level 2 + Progressive Disclosure 設計が適用されている |
| Level 4 | Level 3 + フィードバックループが機能している          |

---

## 18.15 エラーハンドリング

### 18.15.1 エラー回復の確実性

| 回復方法                    | 確実性 | 備考                       |
| --------------------------- | ------ | -------------------------- |
| Git操作によるロールバック   | 確実   | `git restore`、`git reset` |
| スクリプトの exit code 確認 | 確実   | 失敗検知が可能             |
| リトライ                    | 部分的 | 同じ結果になるとは限らない |
| AI による自動診断           | 不確実 | 誤診断の可能性あり         |

### 18.15.2 推奨されるエラー対応

| 状況             | 対応                                             |
| ---------------- | ------------------------------------------------ |
| スクリプト失敗   | exit code を確認し、エラーメッセージに従って対応 |
| 検証失敗         | 検証スクリプトの出力を確認し、問題箇所を修正     |
| ロールバック必要 | Git操作で直前の状態に戻す                        |

---

## 18.16 状態管理

### 18.16.1 設計方針

Claude Code はセッションベースで動作するため、永続的な状態管理は行わない。

### 18.16.2 状態の受け渡し方法

| 方法                | 使用場面                     |
| ------------------- | ---------------------------- |
| Task ツールの戻り値 | エージェント間の情報受け渡し |
| ファイル生成        | 成果物の永続化               |
| LOGS.md への追記    | 実行記録の保存               |

### 18.16.3 禁止される状態管理

| 方法               | 理由                               |
| ------------------ | ---------------------------------- |
| 専用の状態ファイル | 複雑性の増加、コンテキストの肥大化 |
| メモリ内状態       | セッション間で保持されない         |
| 外部データベース   | Claude Code の設計思想に反する     |

---

## 18.17 命名規則

### 18.17.1 コマンド名

| 規則         | 説明                                      |
| ------------ | ----------------------------------------- |
| 動詞ベース   | `create-`, `analyze-`, `review-` で始める |
| ケバブケース | 単語間はハイフンで接続                    |
| 具体的       | 抽象的な名前を避ける                      |

### 18.17.2 エージェント名

| 規則         | 説明                                       |
| ------------ | ------------------------------------------ |
| 役割ベース   | 役割を表す名前（`{{role}}-{{specialty}}`） |
| ケバブケース | 単語間はハイフンで接続                     |
| 単数形       | 複数形は避ける                             |

### 18.17.3 スキル名

| 規則                       | パターン                                                          |
| -------------------------- | ----------------------------------------------------------------- |
| ケバブケース               | `{{domain}}-{{topic}}`                                            |
| 具体的で明確               | 曖昧な単語（optimization, utils）を避け、具体的なドメインを含める |
| 動詞+名詞 または 名詞+名詞 | `{{verb}}-{{noun}}` または `{{noun}}-{{noun}}`                    |

### 18.17.4 ファイル名

| ファイル種別 | 命名規則                                           |
| ------------ | -------------------------------------------------- |
| スクリプト   | `[動詞]_[対象].mjs`                                |
| リソース     | `Level[1-4]_[内容].md` または `[topic].md`         |
| テンプレート | `[対象]-template.md` または `[対象]-template.json` |

---

## 18.18 バージョン管理

### 18.18.1 更新時の手順

| ステップ | 処理内容                                       |
| -------- | ---------------------------------------------- |
| 1        | 変更内容を実装する                             |
| 2        | CHANGELOG.md に変更を記録する                  |
| 3        | SKILL.md の version と last_updated を更新する |
| 4        | 検証スクリプトを実行する                       |
| 5        | Git にコミットする                             |

### 18.18.2 陳腐化防止

| 項目                 | 頻度         |
| -------------------- | ------------ |
| 使用状況の確認       | 月次         |
| 内容の妥当性確認     | 四半期       |
| 依存スキルの更新確認 | スキル更新時 |

---

## 18.19 ファイル参照形式

### 18.19.1 相対パスの記述規則

**必須形式**: プロジェクトルートからの相対パス（`.claude/` で始まる形式）

| 参照対象     | パス形式                                              |
| ------------ | ----------------------------------------------------- |
| エージェント | `.claude/agents/{{agent-name}}.md`                    |
| スキル       | `.claude/skills/{{skill-name}}/SKILL.md`              |
| コマンド     | `.claude/commands/ai/{{command-name}}.md`             |
| リソース     | `.claude/skills/{{skill-name}}/resources/{{file}}.md` |
| スクリプト   | `.claude/skills/{{skill-name}}/scripts/{{file}}.mjs`  |

### 18.19.2 各ファイルでの参照記述形式

| 記述場所            | 参照対象     | 形式                                                            |
| ------------------- | ------------ | --------------------------------------------------------------- |
| Command description | エージェント | `- \`.claude/agents/{{agent-name}}.md\`: {{役割}}`              |
| Agent description   | スキル       | `- \`.claude/skills/{{skill-name}}/SKILL.md\`: {{用途}}`        |
| SKILL.md 関連スキル | スキル       | `**{{name}}** (\`.claude/skills/{{name}}/SKILL.md\`): {{説明}}` |
| agent_list.md       | エージェント | テーブル形式で相対パスを記述                                    |
| skill_list.md       | スキル       | テーブル形式で相対パスを記述                                    |

### 18.19.3 禁止される参照形式

| 形式                        | 問題点                                      |
| --------------------------- | ------------------------------------------- |
| スキル名/エージェント名のみ | パスが不明確で読み込みできない              |
| 絶対パス                    | 環境依存（ユーザーごとにパスが異なる）      |
| `../` を含む相対パス        | 曖昧さが生じ、正確なパス解決ができない      |
| コマンドからスキル参照      | 依存の方向性違反（Command → Agent → Skill） |

---

## 18.20 用語定義

| 用語                         | 定義                                                  |
| ---------------------------- | ----------------------------------------------------- |
| Command                      | ユーザーがスラッシュ（/）で起動するエントリーポイント |
| Agent                        | タスクを実行する専門家エージェント                    |
| Skill                        | エージェントが参照する知識とスクリプトの集合体        |
| Progressive Disclosure       | 必要に応じて段階的に情報を開示する設計手法            |
| フィードバックループ         | 実行結果を評価し改善につなげる仕組み                  |
| セマンティックバージョニング | MAJOR.MINOR.PATCH 形式のバージョン管理                |
| ハンドオフ                   | エージェント間の処理引き継ぎ                          |
| Phase                        | ワークフローの段階                                    |

---

## 18.21 参照

### 18.21.1 関連ドキュメント

| ドキュメント       | パス                                             |
| ------------------ | ------------------------------------------------ |
| ディレクトリ構造   | `docs/00-requirements/04-directory-structure.md` |
| アーキテクチャ設計 | `docs/00-requirements/05-architecture.md`        |

### 18.21.2 関連スキル

| スキル                         | パス                                                     | 用途                   |
| ------------------------------ | -------------------------------------------------------- | ---------------------- |
| knowledge-management           | `.claude/skills/knowledge-management/SKILL.md`           | SECIモデル、知識変換   |
| progressive-disclosure         | `.claude/skills/progressive-disclosure/SKILL.md`         | 3層開示モデル          |
| documentation-architecture     | `.claude/skills/documentation-architecture/SKILL.md`     | ドキュメント構造設計   |
| skill-creation-workflow        | `.claude/skills/skill-creation-workflow/SKILL.md`        | スキル作成ワークフロー |
| command-structure-fundamentals | `.claude/skills/command-structure-fundamentals/SKILL.md` | コマンド基本構造       |
| agent-structure-design         | `.claude/skills/agent-structure-design/SKILL.md`         | エージェント構造設計   |

### 18.21.3 関連エージェント

| エージェント        | パス                                    | 用途             |
| ------------------- | --------------------------------------- | ---------------- |
| skill-librarian     | `.claude/agents/skill-librarian.md`     | スキル作成       |
| meta-agent-designer | `.claude/agents/meta-agent-designer.md` | エージェント作成 |
| command-arch        | `.claude/agents/command-arch.md`        | コマンド作成     |

---

## 18.22 変更履歴

| バージョン | 日付       | 変更内容                                                                                                                                |
| ---------- | ---------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| 1.0.0      | 2025-12-23 | 初版作成（スキル仕様）                                                                                                                  |
| 2.0.0      | 2025-12-23 | Agent仕様、Command仕様、ディレクトリ詳細を追加                                                                                          |
| 3.0.0      | 2025-12-23 | skill_list.md仕様追加、全例をテンプレート形式に変換、ワークフローに目的/背景/ゴール/成果物を追加、Progressive Disclosure原則の明確化    |
| 3.1.0      | 2025-12-23 | Commandのdescriptionからスキル参照を削除（エージェントのみ記述）、全ファイル参照を相対パス形式に統一、18.19を「ファイル参照形式」に改訂 |
| 3.2.0      | 2025-12-23 | スキルに参照書籍（references）フィールドを必須追加、書籍名による知識圧縮パターンを導入                                                  |
| 3.3.0      | 2025-12-23 | エージェントのスキル参照を強化（相対パス・知識・実行内容の明示）、役割定義にスキルマッピングテーブルを追加                              |
| 4.0.0      | 2025-12-23 | 全具体例を抽象化した概念に変更（scripts/を性質・確実性・責務で分類、templates/を形式・性質で分類、実行可能処理を概念化）                |
| 4.1.0      | 2025-12-23 | 18.8.4にテンプレート記述形式を追加（変数のみを使用、具体例を含めない原則を明記）                                                        |
| 5.0.0      | 2025-12-23 | フィードバックループ実装方式を確定（18.12）、18.5.1にlog_usage.mjs必須化、18.4.4を簡潔化（スキル内部詳細を削除）                       |
```
