# セキュリティガイドライン

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 17.1 セキュリティ設計原則

### 17.1.1 基本原則

| 原則             | 説明                               | 適用場面                          |
| ---------------- | ---------------------------------- | --------------------------------- |
| 最小権限         | 必要最小限のアクセス権のみ付与する | API認証、ファイルアクセス、DB権限 |
| 多層防御         | 単一の防御に依存しない             | 認証+認可+暗号化の組み合わせ      |
| フェイルセキュア | 障害時は安全側に倒す               | エラー時はアクセス拒否            |
| 完全な仲介       | すべてのアクセスを検証する         | ミドルウェアでの認証チェック      |
| 経済的設計       | シンプルな設計で攻撃面を減らす     | 不要な機能の削除                  |

### 17.1.2 個人開発での優先順位

**必須（リリース前に対応）**:

- APIキーの環境変数管理
- HTTPS通信の強制
- 入力値のバリデーション
- 認証・認可の実装
- セキュアなセッション管理

**推奨（段階的に対応）**:

- 依存関係の脆弱性監査
- Content Security Policy（CSP）設定
- レート制限の実装
- 監査ログの記録

**将来対応（ユーザー増加時）**:

- 侵入検知システム
- セキュリティ監査の自動化
- ペネトレーションテスト

---

## 17.2 認証・認可

### 17.2.1 認証方式

| 方式             | 用途                | 推奨ライブラリ |
| ---------------- | ------------------- | -------------- |
| OAuth 2.0        | Discord連携ログイン | NextAuth.js    |
| APIキー          | Local Agent認証     | カスタム実装   |
| セッションCookie | Web UI認証          | NextAuth.js    |

**Discord OAuth設定の注意点**:

- リダイレクトURLは本番・開発環境それぞれ登録する
- スコープは必要最小限（identify, guilds）に限定する
- Client Secretは環境変数で管理し、クライアントサイドに露出しない
- トークンの有効期限を適切に設定する

### 17.2.2 セッション管理

| 項目                 | 推奨値                            | 理由                                     |
| -------------------- | --------------------------------- | ---------------------------------------- |
| セッション有効期限   | 30日                              | 個人利用の利便性とセキュリティのバランス |
| アイドルタイムアウト | 7日                               | 長期放置への対策                         |
| Cookie属性           | HttpOnly, Secure, SameSite=Strict | XSS・CSRF防止                            |
| セッションID         | 暗号学的乱数生成                  | 推測攻撃の防止                           |

**セッションストレージの選択肢**:

| 方式                | メリット                       | デメリット       |
| ------------------- | ------------------------------ | ---------------- |
| JWT（ステートレス） | サーバー負荷軽減、スケーラブル | 即時無効化が困難 |
| DBセッション        | 即時無効化可能、細かい制御     | DBアクセス必須   |
| Redis               | 高速、即時無効化可能           | 追加インフラ必要 |

個人開発では、NextAuth.jsのデフォルトJWTセッションを推奨する。無効化が必要な場合はDBセッションに切り替える。

### 17.2.3 Local Agent認証

**認証フロー**:

1. Local AgentはCloud APIに対してAGENT_SECRET_KEYを含めてリクエストする
2. Cloud APIはキーを検証し、一致しない場合は401エラーを返す
3. 認証成功時はリクエストを処理する

**セキュリティ考慮事項**:

- AGENT_SECRET_KEYは32文字以上のランダム文字列とする
- キーは環境変数でのみ管理し、ログに出力しない
- 定期的なキーローテーションを行う（3ヶ月ごと推奨）
- 不正アクセス検知のため、認証失敗をログに記録する

---

## 17.3 データ保護

### 17.3.1 機密情報の分類

| 分類 | 例                                     | 保護要件                                 |
| ---- | -------------------------------------- | ---------------------------------------- |
| 極秘 | APIキー、OAuthシークレット、DB認証情報 | 暗号化必須、アクセスログ、ローテーション |
| 機密 | ユーザー設定、ワークフロー内容         | 暗号化推奨、アクセス制御                 |
| 内部 | ログ、メトリクス                       | アクセス制御                             |
| 公開 | 公開ドキュメント                       | 制限なし                                 |

### 17.3.2 暗号化

**通信の暗号化**:

| 対象            | 方式    | 設定                               |
| --------------- | ------- | ---------------------------------- |
| Web通信         | TLS 1.3 | RailwayのHTTPS自動設定             |
| Local Agent通信 | HTTPS   | 自己署名証明書または Let's Encrypt |
| WebSocket       | WSS     | 同上                               |

**保存データの暗号化**:

| 対象              | 方式                     | 実装場所                         |
| ----------------- | ------------------------ | -------------------------------- |
| APIキー（DB保存） | AES-256-GCM              | アプリケーション層で暗号化後保存 |
| ローカルファイル  | Electron safeStorage API | デスクトップアプリ               |
| バックアップ      | GPG暗号化                | CI/CDパイプライン                |

**暗号化キーの管理**:

- マスターキーは環境変数で管理する
- キーの導出にはPBKDF2またはArgon2を使用する
- 暗号化キーとデータを同じ場所に保存しない
- キーローテーション時は古いキーでの復号→新しいキーでの暗号化を行う

### 17.3.3 Electronでの機密情報管理

**safeStorage APIの使用**:

- OSのキーチェーン（macOS）/Credential Manager（Windows）を活用する
- 認証トークン、APIキーの保存に使用する
- アプリアンインストール時に自動削除される

**禁止事項**:

- ソースコード内への機密情報ハードコード
- localStorage/IndexedDBへの機密情報保存
- Electronアプリのasarアーカイブ内への機密情報埋め込み
- コンソールログへの機密情報出力

---

## 17.4 入力バリデーション

### 17.4.1 バリデーション原則

| 原則               | 説明                                                 |
| ------------------ | ---------------------------------------------------- |
| サーバーサイド必須 | クライアントバリデーションは補助的なもの             |
| ホワイトリスト方式 | 許可するパターンを定義する（ブラックリストは避ける） |
| 型の強制           | 文字列で受け取った数値は明示的に変換する             |
| 長さ制限           | すべての入力に最大長を設定する                       |
| サニタイズ         | HTML/SQLエスケープを適切に行う                       |

### 17.4.2 入力タイプ別バリデーション

| 入力タイプ           | バリデーション項目                                   |
| -------------------- | ---------------------------------------------------- |
| ユーザー名           | 英数字のみ、3-30文字、予約語チェック                 |
| メールアドレス       | RFC 5322準拠、ドメイン存在確認（任意）               |
| URL                  | プロトコル制限（http/https）、ドメインホワイトリスト |
| ファイルパス         | パストラバーサル防止、許可ディレクトリ内チェック     |
| JSON                 | スキーマバリデーション、最大サイズ制限               |
| ファイルアップロード | MIMEタイプ、拡張子、サイズ、マジックバイトチェック   |

### 17.4.3 SQLインジェクション対策

**必須対策**:

- パラメータ化クエリを使用する（Drizzle ORMは標準で対応）
- ユーザー入力を直接SQL文字列に結合しない
- ORDER BY句の動的生成には列名のホワイトリストを使用する
- LIMIT/OFFSET値は数値型に変換してから使用する

**Drizzle ORM使用時の注意点**:

- rawクエリの使用は最小限に抑える
- 動的なカラム名やテーブル名には検証済みの値のみ使用する
- トランザクション内でのユーザー入力処理は特に注意する

### 17.4.4 XSS対策

**React標準の保護**:

- JSXでの変数展開は自動的にエスケープされる
- dangerouslySetInnerHTMLは原則使用禁止

**追加対策**:

- Content Security Policyヘッダーの設定
- HTTPOnlyクッキーの使用
- ユーザー入力のサニタイズ（DOMPurify等）
- URLスキームの検証（javascript:の拒否）

---

## 17.5 API セキュリティ

### 17.5.1 認証・認可フロー

**APIエンドポイント分類**:

| 分類     | 認証要件     | 例                             |
| -------- | ------------ | ------------------------------ |
| 公開     | 不要         | ヘルスチェック、公開情報取得   |
| 認証必須 | ログイン済み | ユーザー情報、ワークフロー操作 |
| 管理者   | 管理者権限   | システム設定、ユーザー管理     |
| 内部     | Agent認証    | Local Agent通信                |

**認証チェックの実装場所**:

- Next.js Middlewareでルート全体の認証チェック
- API Routeハンドラーでの詳細な認可チェック
- データアクセス層でのオーナーシップ検証

### 17.5.2 レート制限

| エンドポイント種別   | 制限値        | 単位           |
| -------------------- | ------------- | -------------- |
| 一般API              | 100リクエスト | 1分間/IP       |
| 認証API              | 10リクエスト  | 1分間/IP       |
| AI処理API            | 10リクエスト  | 1分間/ユーザー |
| ファイルアップロード | 5リクエスト   | 1分間/ユーザー |

**実装方針**:

- メモリベースのレート制限（Redis不要で開始可能）
- 429ステータスコードと Retry-After ヘッダーの返却
- レート超過のログ記録
- 正当なユーザーへの影響を考慮した緩やかな制限

### 17.5.3 CORS設定

| 環境 | 許可オリジン                   |
| ---- | ------------------------------ |
| 開発 | localhost:3000, localhost:3001 |
| 本番 | 本番ドメインのみ               |

**設定項目**:

- Access-Control-Allow-Origin: 明示的なオリジン指定（ワイルドカード禁止）
- Access-Control-Allow-Methods: 必要なメソッドのみ
- Access-Control-Allow-Headers: 必要なヘッダーのみ
- Access-Control-Allow-Credentials: 認証Cookie使用時はtrue

---

## 17.6 依存関係セキュリティ

### 17.6.1 脆弱性管理

**監査ツール**:

| ツール     | 用途                 | 実行タイミング     |
| ---------- | -------------------- | ------------------ |
| pnpm audit | 依存関係の脆弱性検出 | CI/CD、週次        |
| Dependabot | 自動PR作成           | 常時（GitHub設定） |
| Snyk       | 詳細な脆弱性分析     | 任意（無料枠あり） |

**対応フロー**:

1. 脆弱性検出時は重大度を確認する
2. Critical/Highは即時対応（24時間以内）
3. Mediumは次回リリースまでに対応
4. Lowは定期メンテナンスで対応
5. 修正不可能な場合は代替パッケージを検討する

### 17.6.2 依存関係の選定基準

| 基準             | 確認項目                                     |
| ---------------- | -------------------------------------------- |
| メンテナンス状況 | 最終更新日、Issue対応状況、メンテナー数      |
| セキュリティ     | 過去の脆弱性履歴、セキュリティポリシーの有無 |
| ライセンス       | MIT、Apache 2.0等の許容ライセンス            |
| 人気度           | GitHub Stars、npm週次ダウンロード数          |
| 依存の深さ       | 間接依存の数、依存関係の複雑さ               |

### 17.6.3 lock ファイルの管理

- pnpm-lock.yamlは必ずコミットする
- lock ファイルの手動編集は禁止
- CI/CDでは`pnpm install --frozen-lockfile`を使用
- 依存更新は個別PRで管理し、変更内容を明確化する

---

## 17.7 Electron セキュリティ

### 17.7.1 セキュリティ設定

**BrowserWindow設定の必須項目**:

| 設定                        | 推奨値 | 理由                               |
| --------------------------- | ------ | ---------------------------------- |
| nodeIntegration             | false  | Rendererからのシステムアクセス防止 |
| contextIsolation            | true   | preloadスクリプトの分離            |
| sandbox                     | true   | Chromiumサンドボックスの有効化     |
| webSecurity                 | true   | Same-Originポリシーの強制          |
| allowRunningInsecureContent | false  | HTTP上のコンテンツ実行防止         |

### 17.7.2 IPC通信のセキュリティ

**preloadスクリプトでのAPI公開**:

- contextBridgeを使用して限定的なAPIのみ公開する
- チャンネル名はホワイトリストで管理する
- 引数のバリデーションをMain側で実施する
- センシティブな操作にはユーザー確認ダイアログを表示する

**禁止事項**:

- ipcRenderer全体の公開
- nodeモジュールの直接公開
- ファイルシステムへの無制限アクセス
- シェルコマンドの無制限実行

### 17.7.3 自動更新のセキュリティ

| 項目         | 要件                         |
| ------------ | ---------------------------- |
| 更新ソース   | HTTPS経由のみ                |
| 署名検証     | コード署名の検証必須         |
| ロールバック | 失敗時の自動ロールバック機能 |
| 通知         | 更新内容のユーザーへの明示   |

---

## 17.8 ログ・監査

### 17.8.1 セキュリティログ

**記録すべきイベント**:

| カテゴリ | イベント                                          |
| -------- | ------------------------------------------------- |
| 認証     | ログイン成功/失敗、ログアウト、セッション期限切れ |
| 認可     | アクセス拒否、権限変更                            |
| データ   | 機密データアクセス、データ変更、削除              |
| システム | 設定変更、エラー、異常検知                        |

**ログに含めるべき情報**:

- タイムスタンプ（UTC）
- イベント種別
- ユーザー識別子（匿名化済み）
- IPアドレス
- User-Agent
- リクエストID
- 成功/失敗

**ログに含めてはいけない情報**:

- パスワード、APIキー等の機密情報
- 完全なクレジットカード番号
- 個人を特定できる詳細情報（必要な場合は匿名化）

### 17.8.2 ログの保管

| 環境     | 保管先           | 保管期間 |
| -------- | ---------------- | -------- |
| 開発     | ローカルファイル | 7日      |
| 本番     | Railway Logs     | 30日     |
| 監査ログ | 専用ストレージ   | 1年      |

---

## 17.9 インシデント対応

### 17.9.1 インシデント分類

| レベル     | 定義                           | 対応時間     |
| ---------- | ------------------------------ | ------------ |
| P1（緊急） | サービス停止、データ漏洩       | 即時         |
| P2（高）   | 一部機能の障害、脆弱性発見     | 24時間以内   |
| P3（中）   | パフォーマンス低下、軽微なバグ | 1週間以内    |
| P4（低）   | 改善要望、軽微な問題           | 次回リリース |

### 17.9.2 データ漏洩時の対応

**即時対応（1時間以内）**:

- 漏洩経路の特定と遮断
- 該当APIキー/認証情報の無効化
- 影響範囲の初期調査
- サービス一時停止の判断

**短期対応（24時間以内）**:

- 詳細な影響範囲の調査
- 新しい認証情報の発行
- 全環境の認証情報更新
- 不正アクセスの有無確認

**中期対応（1週間以内）**:

- 原因分析と根本対策の実施
- 再発防止策の導入
- インシデントレポートの作成
- 必要に応じてユーザーへの通知

### 17.9.3 APIキー漏洩時の対応

**漏洩元別対応**:

| 漏洩元       | 対応                                                                    |
| ------------ | ----------------------------------------------------------------------- |
| Git履歴      | キー無効化、履歴の書き換え（git filter-branch）、GitHub Secret Scanning |
| ログファイル | キー無効化、ログのローテーション、ログ出力の修正                        |
| クライアント | キー無効化、コードの修正、サーバーサイド認証への移行                    |

---

## 17.10 セキュリティチェックリスト

### 17.10.1 開発時

- [ ] 機密情報が環境変数で管理されているか
- [ ] 入力バリデーションが実装されているか
- [ ] SQLインジェクション対策（パラメータ化クエリ）が行われているか
- [ ] XSS対策が行われているか
- [ ] 認証・認可が適切に実装されているか
- [ ] エラーメッセージに機密情報が含まれていないか
- [ ] ログに機密情報が出力されていないか

### 17.10.2 リリース前

- [ ] pnpm auditで脆弱性がないか確認
- [ ] HTTPSが有効になっているか
- [ ] Cookie属性（HttpOnly, Secure, SameSite）が設定されているか
- [ ] CSPヘッダーが設定されているか
- [ ] レート制限が設定されているか
- [ ] CORS設定が適切か
- [ ] 不要なエンドポイントが公開されていないか

### 17.10.3 Electronリリース前

- [ ] nodeIntegration: falseか
- [ ] contextIsolation: trueか
- [ ] sandbox: trueか
- [ ] 不要なパーミッションを要求していないか
- [ ] 自動更新の署名検証が有効か
- [ ] コード署名が適用されているか

### 17.10.4 定期確認（月次）

- [ ] 依存関係の脆弱性スキャン
- [ ] アクセスログの異常確認
- [ ] 不要なAPIキーの棚卸し
- [ ] 認証失敗ログの確認
- [ ] バックアップの復元テスト

---

## 関連ドキュメント

- [環境変数管理](./13-environment-variables.md)
- [非機能要件](./02-non-functional-requirements.md)
- [デプロイメント](./12-deployment.md)
- [エラーハンドリング](./07-error-handling.md)
- [ローカルエージェント仕様](./09-local-agent.md)
