# 機能プラグイン追加手順

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 11.1 プラグインアーキテクチャ概要

### 11.1.1 設計思想

| 原則                 | 説明                                                              |
| -------------------- | ----------------------------------------------------------------- |
| 単一責任             | 1つのプラグインは1つの機能のみを担当する                          |
| 自己完結             | プラグインは独自のフォルダ内で完結し、他のプラグインに依存しない  |
| 統一インターフェース | すべてのプラグインは IWorkflowExecutor インターフェースを実装する |
| スキーマ駆動         | 入出力は Zod スキーマで厳密に定義し、型安全性を保証する           |
| テスト必須           | すべてのプラグインにユニットテストを作成する                      |

### 11.1.2 プラグインの構成要素

| 要素           | ファイル         | 責務                                     |
| -------------- | ---------------- | ---------------------------------------- |
| スキーマ定義   | schema.ts        | 入力・出力の型定義と検証ルール           |
| 実行ロジック   | executor.ts      | IWorkflowExecutor 実装、ビジネスロジック |
| テスト         | executor.test.ts | ユニットテスト、エッジケースの検証       |
| APIハンドラー  | api.ts           | API Routes 用ハンドラー（任意）          |
| フック         | hooks/           | 機能固有の React フック（任意）          |
| コンポーネント | components/      | 機能固有の UI コンポーネント（任意）     |

---

## 11.2 プラグイン追加フロー

### 11.2.1 開発ステップ一覧

| 順序 | ステップ       | 内容                                      | 成果物                                    |
| ---- | -------------- | ----------------------------------------- | ----------------------------------------- |
| 1    | 仕様書作成     | 機能要件、入出力仕様、エラーケースを定義  | docs/20-specifications/features/機能名.md |
| 2    | フォルダ作成   | apps/web/src/features/ 配下にフォルダ作成 | 機能名/                                   |
| 3    | スキーマ定義   | Zod で入出力スキーマを定義                | schema.ts                                 |
| 4    | Executor 実装  | IWorkflowExecutor インターフェースを実装  | executor.ts                               |
| 5    | テスト作成     | 正常系・異常系のユニットテスト            | executor.test.ts                          |
| 6    | Registry 登録  | ExecutorRegistry に1行追加                | registry.ts の更新                        |
| 7    | API Route 作成 | Next.js API Route を作成                  | app/api/v1/機能名/route.ts                |
| 8    | 動作確認       | E2E テストまたは手動確認                  | テスト結果                                |

### 11.2.2 フォルダ構成

| パス                                          | 役割              | 必須/任意 |
| --------------------------------------------- | ----------------- | --------- |
| apps/web/src/features/機能名/                 | プラグインルート  | 必須      |
| apps/web/src/features/機能名/schema.ts        | 入出力スキーマ    | 必須      |
| apps/web/src/features/機能名/executor.ts      | 実行ロジック      | 必須      |
| apps/web/src/features/機能名/executor.test.ts | ユニットテスト    | 必須      |
| apps/web/src/features/機能名/api.ts           | API ハンドラー    | 任意      |
| apps/web/src/features/機能名/hooks/           | カスタムフック    | 任意      |
| apps/web/src/features/機能名/components/      | UI コンポーネント | 任意      |

---

## 11.3 IWorkflowExecutor 実装ガイド

### 11.3.1 必須プロパティ

| プロパティ   | 型        | 説明                                           | 例                                  |
| ------------ | --------- | ---------------------------------------------- | ----------------------------------- |
| type         | string    | プラグインの一意識別子（大文字スネークケース） | YOUTUBE_SUMMARIZE                   |
| displayName  | string    | ユーザー向け表示名                             | YouTube動画要約                     |
| description  | string    | 機能の説明文                                   | YouTube動画の内容を要約します       |
| inputSchema  | ZodSchema | 入力バリデーションスキーマ                     | z.object({ url: z.string().url() }) |
| outputSchema | ZodSchema | 出力バリデーションスキーマ                     | z.object({ summary: z.string() })   |

### 11.3.2 必須メソッド

| メソッド | 引数                                     | 戻り値           | 説明                 |
| -------- | ---------------------------------------- | ---------------- | -------------------- |
| execute  | input: TInput, context: ExecutionContext | Promise<TOutput> | メインの実行ロジック |

### 11.3.3 任意メソッド

| メソッド | 引数                      | 戻り値                        | 説明                             |
| -------- | ------------------------- | ----------------------------- | -------------------------------- |
| validate | input: TInput             | Result<void, ValidationError> | スキーマ以上のカスタム検証       |
| canRetry | error: Error              | boolean                       | エラーに応じたリトライ可否判定   |
| onCancel | context: ExecutionContext | Promise<void>                 | キャンセル時のクリーンアップ処理 |

### 11.3.4 ExecutionContext の利用

| フィールド  | 型          | 用途                                    |
| ----------- | ----------- | --------------------------------------- |
| workflowId  | string      | ログ出力、進捗追跡に使用                |
| userId      | string      | ユーザー固有の設定参照に使用            |
| logger      | Logger      | 構造化ログ出力（workflowId が自動付与） |
| abortSignal | AbortSignal | キャンセル検知、外部API呼び出しに渡す   |
| retryCount  | number      | リトライ回数に応じた処理分岐            |
| startedAt   | Date        | 実行時間の計測、タイムアウト判定        |

---

## 11.4 スキーマ定義ガイド

### 11.4.1 入力スキーマの設計原則

| 原則                   | 説明                                         |
| ---------------------- | -------------------------------------------- |
| 最小限の必須フィールド | ユーザーの入力負担を軽減                     |
| 適切なデフォルト値     | オプショナルフィールドにはデフォルト値を設定 |
| 明確なエラーメッセージ | バリデーションエラー時に何が問題かを伝える   |
| 型の厳密化             | string ではなく email、url、uuid などを使用  |

### 11.4.2 よく使うバリデーション

| 用途         | Zod メソッド             | 説明                           |
| ------------ | ------------------------ | ------------------------------ |
| URL 検証     | z.string().url()         | 有効な URL 形式か確認          |
| メール検証   | z.string().email()       | 有効なメールアドレス形式か確認 |
| 文字数制限   | z.string().min(n).max(m) | 文字数の範囲を制限             |
| 数値範囲     | z.number().min(n).max(m) | 数値の範囲を制限               |
| 列挙型       | z.enum(['A', 'B', 'C'])  | 許容値を限定                   |
| オブジェクト | z.object({...})          | オブジェクト構造を定義         |
| 配列         | z.array(schema)          | 配列の要素スキーマを定義       |
| オプショナル | z.optional()             | 必須ではないフィールド         |
| デフォルト値 | z.default(value)         | 未指定時のデフォルト値         |

### 11.4.3 出力スキーマの設計原則

| 原則             | 説明                                           |
| ---------------- | ---------------------------------------------- |
| 完全性           | 呼び出し元が必要とする情報をすべて含める       |
| 一貫性           | 成功時・部分成功時も同じ構造を維持             |
| メタデータ       | 処理時間、トークン使用量などのメタ情報を含める |
| シリアライズ可能 | JSON にシリアライズ可能な型のみを使用          |

---

## 11.5 共通インフラストラクチャの使用

### 11.5.1 AI クライアント

| 項目             | 説明                                        |
| ---------------- | ------------------------------------------- |
| 取得元           | packages/shared/infrastructure/ai/client.ts |
| 取得方法         | createAIClient(provider) 関数を呼び出す     |
| 対応プロバイダー | openai, anthropic, google, xai              |
| 主要メソッド     | chat(), complete(), stream()                |
| 必須オプション   | model, maxTokens                            |
| 推奨オプション   | temperature, systemPrompt, abortSignal      |

### 11.5.2 データベースアクセス

| 項目             | 説明                                           |
| ---------------- | ---------------------------------------------- |
| 取得元           | packages/shared/infrastructure/database/       |
| ORM              | Drizzle ORM（型安全なクエリビルダー）          |
| Repository       | 各エンティティ用の Repository クラスを使用     |
| トランザクション | withTransaction() メソッドで複数操作をまとめる |

### 11.5.3 利用可能な Repository

| Repository             | 用途             | 主要メソッド                     |
| ---------------------- | ---------------- | -------------------------------- |
| WorkflowRepository     | ワークフロー管理 | create, findById, update, delete |
| UserSettingsRepository | ユーザー設定管理 | get, update, getApiKey           |
| ExecutionLogRepository | 実行ログ管理     | create, findByWorkflowId         |

### 11.5.4 Discord 通知

| 項目         | 説明                                             |
| ------------ | ------------------------------------------------ |
| 取得元       | packages/shared/infrastructure/discord/client.ts |
| 使用メソッド | sendDiscordMessage(channelId, message)           |
| 用途         | ワークフロー完了通知、エラー通知                 |
| 注意事項     | ユーザーが Discord 連携済みの場合のみ送信        |

### 11.5.5 ロガー

| 項目       | 説明                                              |
| ---------- | ------------------------------------------------- |
| 取得方法   | ExecutionContext から logger を取得               |
| ログレベル | debug, info, warn, error                          |
| 自動付与   | workflowId, userId, timestamp                     |
| 注意事項   | 機密情報（APIキー、パスワード）をログに出力しない |

---

## 11.6 エラーハンドリング

### 11.6.1 スローすべきエラー

| エラー種別           | 使用場面                      | リトライ |
| -------------------- | ----------------------------- | -------- |
| ValidationError      | 入力バリデーション失敗        | 不可     |
| BusinessError        | ビジネスルール違反            | 不可     |
| ExternalServiceError | AI API や外部サービスのエラー | 可能     |
| InternalError        | 予期しないエラー              | 不可     |

### 11.6.2 エラー処理の原則

| 原則       | 説明                                         |
| ---------- | -------------------------------------------- |
| 早期失敗   | 問題を検出したら即座にエラーをスロー         |
| 情報保持   | 原因エラーを cause プロパティに保持          |
| 適切な分類 | エラーの種類に応じた適切なエラークラスを使用 |
| ログ出力   | エラー発生時は必ずログを出力                 |

### 11.6.3 canRetry メソッドの実装指針

| 条件                     | リトライ可否 | 理由                     |
| ------------------------ | ------------ | ------------------------ |
| AI API タイムアウト      | 可能         | 一時的な遅延             |
| レート制限エラー（429）  | 可能         | 待機後に再試行可能       |
| 入力バリデーションエラー | 不可         | 入力を修正しない限り失敗 |
| 認証エラー（401）        | 不可         | 認証情報の問題           |
| リソース不存在（404）    | 不可         | リソースが存在しない     |

---

## 11.7 テスト作成ガイド

### 11.7.1 テストの種類

| 種類           | 対象                | 配置場所                      |
| -------------- | ------------------- | ----------------------------- |
| ユニットテスト | executor のロジック | 同フォルダ内 executor.test.ts |
| 統合テスト     | API エンドポイント  | 同フォルダ内 api.test.ts      |
| E2E テスト     | ユーザーフロー全体  | tests/e2e/                    |

### 11.7.2 テストケースの分類

| カテゴリ     | テスト内容                           |
| ------------ | ------------------------------------ |
| 正常系       | 有効な入力で期待される出力が得られる |
| 境界値       | 最小値、最大値、空配列などの境界条件 |
| 異常系       | 不正な入力でバリデーションエラー     |
| エラー系     | 外部サービスエラー時の適切な処理     |
| キャンセル系 | 処理中のキャンセルが正しく動作       |

### 11.7.3 モックの使用

| 対象                 | モック方法                   | 注意点                    |
| -------------------- | ---------------------------- | ------------------------- |
| AI クライアント      | vi.mock() でモジュールモック | 実際のAPI呼び出しを避ける |
| データベース         | インメモリDBまたはモック     | テスト間の独立性を確保    |
| Discord クライアント | vi.fn() でスパイ             | 送信内容を検証            |
| 外部API              | MSW または vi.mock()         | ネットワーク依存を排除    |

### 11.7.4 テストの命名規則

| パターン                     | 説明                         |
| ---------------------------- | ---------------------------- |
| describe('Executor名')       | テスト対象の Executor を明示 |
| describe('execute')          | テスト対象のメソッドを明示   |
| it('should...')              | 期待される動作を説明         |
| it('should throw...when...') | エラー系は条件を明示         |

---

## 11.8 Registry 登録

### 11.8.1 登録手順

| 順序 | 内容                                     |
| ---- | ---------------------------------------- |
| 1    | apps/web/src/features/registry.ts を開く |
| 2    | 新しい Executor をインポート             |
| 3    | executors 配列に追加                     |
| 4    | 型チェックが通ることを確認               |

### 11.8.2 Registry の役割

| 機能            | 説明                                     |
| --------------- | ---------------------------------------- |
| Executor の管理 | すべての Executor を一元管理             |
| 型の取得        | type から対応する Executor を取得        |
| 一覧の提供      | 利用可能なワークフロータイプの一覧を提供 |
| バリデーション  | 未登録の type が指定された場合にエラー   |

---

## 11.9 実装チェックリスト

### 11.9.1 開発前チェック

- [ ] 仕様書を作成したか
- [ ] 既存の類似プラグインを確認したか
- [ ] 必要な外部APIのドキュメントを確認したか
- [ ] APIキーなどの設定方法を確認したか

### 11.9.2 実装チェック

- [ ] IWorkflowExecutor インターフェースを正しく実装したか
- [ ] 入出力スキーマを Zod で定義したか
- [ ] エラーは適切なエラークラスを使用しているか
- [ ] logger を使用してログを出力しているか
- [ ] abortSignal を適切にチェックしているか
- [ ] 長時間処理にタイムアウトを設定したか

### 11.9.3 テストチェック

- [ ] 正常系のテストを作成したか
- [ ] 異常系（バリデーションエラー）のテストを作成したか
- [ ] エラー系（外部サービスエラー）のテストを作成したか
- [ ] 境界値のテストを作成したか
- [ ] モックを適切に使用しているか

### 11.9.4 品質チェック

- [ ] TypeScript の型エラーがないか
- [ ] ESLint のエラー・警告がないか
- [ ] テストがすべてパスするか
- [ ] Registry に登録したか
- [ ] API Route を作成したか（必要な場合）

---

## 11.10 サンプルプラグイン仕様

### 11.10.1 YouTube 動画要約プラグイン

| 項目         | 内容                                                     |
| ------------ | -------------------------------------------------------- |
| type         | YOUTUBE_SUMMARIZE                                        |
| displayName  | YouTube動画要約                                          |
| 入力         | url（YouTube URL）、language（要約言語、デフォルト: ja） |
| 出力         | title、summary、keyPoints（配列）、duration              |
| 処理フロー   | URL解析 → 字幕取得 → AI要約 → 結果返却                   |
| 使用インフラ | AI クライアント（要約生成）                              |
| エラーケース | 無効なURL、字幕なし動画、AI APIエラー                    |

### 11.10.2 テキスト翻訳プラグイン

| 項目         | 内容                                                 |
| ------------ | ---------------------------------------------------- |
| type         | TEXT_TRANSLATE                                       |
| displayName  | テキスト翻訳                                         |
| 入力         | text（翻訳対象）、sourceLang、targetLang             |
| 出力         | translatedText、detectedLang（ソース言語自動検出時） |
| 処理フロー   | 言語検出 → AI翻訳 → 結果返却                         |
| 使用インフラ | AI クライアント（翻訳生成）                          |
| エラーケース | 空テキスト、未対応言語、AI APIエラー                 |

---

## 11.11 個人開発における注意点

### 11.11.1 スコープの制限

| 指針                     | 説明                                   |
| ------------------------ | -------------------------------------- |
| 小さく始める             | 最初は最小限の機能で実装し、徐々に拡張 |
| 過度な汎用化を避ける     | 現時点で必要な機能のみを実装           |
| リファクタリングは後回し | 動作するコードを優先、完璧を求めない   |

### 11.11.2 優先度の判断

| 優先度 | 内容                                       |
| ------ | ------------------------------------------ |
| 高     | コア機能の実装、基本的なエラーハンドリング |
| 中     | エッジケースの対応、ログ出力の充実         |
| 低     | パフォーマンス最適化、詳細なメトリクス収集 |

### 11.11.3 技術的負債の管理

| 方針           | 説明                                             |
| -------------- | ------------------------------------------------ |
| TODO コメント  | 後で改善が必要な箇所にコメントを残す             |
| 定期的な見直し | 月1回程度、技術的負債をレビュー                  |
| 段階的改善     | 大規模リファクタリングより小さな改善を積み重ねる |

---

## 関連ドキュメント

- [コアインターフェース仕様](./06-core-interfaces.md)
- [エラーハンドリング仕様](./07-error-handling.md)
- [アーキテクチャ設計](./05-architecture.md)
- [ディレクトリ構造](./04-directory-structure.md)
- [タスク実行仕様書生成ガイド](./14-task-workflow-specification.md)
