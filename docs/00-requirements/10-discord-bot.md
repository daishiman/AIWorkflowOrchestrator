# Discord Bot 仕様

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

---

## 10.1 機能概要

### 10.1.1 Discord Bot の役割

| 役割             | 説明                                                 |
| ---------------- | ---------------------------------------------------- |
| ワークフロー起動 | ユーザーのメッセージやコマンドからワークフローを起動 |
| 進捗通知         | ワークフローの進捗状況をリアルタイムで通知           |
| 結果配信         | 完了したワークフローの成果物をDiscordに投稿          |
| ユーザー認証     | Discord OAuth2 によるユーザー認証・紐付け            |

### 10.1.2 対応ワークフロータイプ

| タイプ            | トリガー           | 説明                 |
| ----------------- | ------------------ | -------------------- |
| YOUTUBE_SUMMARIZE | YouTube URL        | 動画の要約を生成     |
| TEXT_TRANSLATE    | テキスト投稿       | テキストを翻訳       |
| FILE_ANALYZE      | ファイル添付       | 添付ファイルを分析   |
| CUSTOM            | スラッシュコマンド | カスタムワークフロー |

---

## 10.2 イベントハンドリング

### 10.2.1 対応イベント

| イベント          | トリガー条件                               | 処理内容                         |
| ----------------- | ------------------------------------------ | -------------------------------- |
| messageCreate     | Bot メンションまたは指定チャンネルへの投稿 | メッセージ解析、ワークフロー起動 |
| interactionCreate | スラッシュコマンド実行                     | コマンド処理                     |
| guildCreate       | Bot がサーバーに追加                       | 初期設定、ウェルカムメッセージ   |
| guildDelete       | Bot がサーバーから削除                     | 関連データのクリーンアップ       |

### 10.2.2 メッセージ処理条件

| 条件                       | 処理                   |
| -------------------------- | ---------------------- |
| Bot 自身のメッセージ       | 無視                   |
| DM（ダイレクトメッセージ） | 無視（将来対応予定）   |
| Bot メンション             | ワークフロー起動を試行 |
| 指定チャンネルへの投稿     | ワークフロー起動を試行 |
| その他のメッセージ         | 無視                   |

---

## 10.3 スラッシュコマンド

### 10.3.1 コマンド一覧

| コマンド   | 説明                   | パラメータ                                         |
| ---------- | ---------------------- | -------------------------------------------------- |
| /summarize | YouTube動画を要約      | url（必須）: 動画URL、language（任意）: 要約言語   |
| /translate | テキストを翻訳         | text（必須）: 翻訳対象、target（必須）: 翻訳先言語 |
| /status    | ワークフロー状態確認   | id（必須）: ワークフローID                         |
| /cancel    | ワークフローキャンセル | id（必須）: ワークフローID                         |
| /history   | 実行履歴表示           | limit（任意）: 表示件数（デフォルト5）             |
| /help      | ヘルプ表示             | command（任意）: 特定コマンドのヘルプ              |
| /settings  | ユーザー設定           | なし                                               |

### 10.3.2 コマンドオプション

| オプション種別   | 説明                 | 例                            |
| ---------------- | -------------------- | ----------------------------- |
| 必須オプション   | 指定しないとエラー   | url                           |
| 任意オプション   | 省略時はデフォルト値 | language（デフォルト: ja）    |
| 選択式オプション | 候補から選択         | target（en, ja, zh, ko など） |

### 10.3.3 コマンドレスポンス

| 状況                 | レスポンス形式                      |
| -------------------- | ----------------------------------- |
| 受付成功             | Embed: ワークフローID、推定処理時間 |
| バリデーションエラー | Ephemeral: エラー内容、修正方法     |
| 処理中               | Embed更新: 進捗バー、現在のステップ |
| 完了                 | Embed: 結果サマリー、詳細リンク     |
| エラー               | Embed: エラー概要、対処方法         |

---

## 10.4 メッセージ解析

### 10.4.1 解析優先順位

| 順位 | 解析方法                 | 説明                                   |
| ---- | ------------------------ | -------------------------------------- |
| 1    | URLパターンマッチ        | YouTube、Google Drive、その他の対応URL |
| 2    | ファイル添付の拡張子     | .pdf、.txt、.csv などの対応拡張子      |
| 3    | 自然言語解析（AI推論）   | メッセージ内容から意図を推論           |
| 4    | デフォルトフォールバック | 汎用テキスト処理                       |

### 10.4.2 URLパターン

| サービス     | パターン                     | ワークフロータイプ |
| ------------ | ---------------------------- | ------------------ |
| YouTube      | youtube.com/watch, youtu.be/ | YOUTUBE_SUMMARIZE  |
| Google Drive | drive.google.com/file        | FILE_ANALYZE       |
| その他URL    | http://, https://            | URL_ANALYZE        |

### 10.4.3 ファイル添付

| 拡張子      | ワークフロータイプ | 最大サイズ |
| ----------- | ------------------ | ---------- |
| .pdf        | PDF_ANALYZE        | 10MB       |
| .txt, .md   | TEXT_ANALYZE       | 1MB        |
| .csv, .json | DATA_ANALYZE       | 5MB        |
| .mp3, .wav  | AUDIO_TRANSCRIBE   | 25MB       |
| .mp4        | VIDEO_ANALYZE      | 100MB      |

---

## 10.5 レート制限

### 10.5.1 制限設定

| スコープ         | 制限            | リセット間隔 |
| ---------------- | --------------- | ------------ |
| グローバル       | 50リクエスト/秒 | 1秒          |
| チャンネルごと   | 5メッセージ/5秒 | 5秒          |
| ユーザーごと     | 5コマンド/30秒  | 30秒         |
| ワークフロー起動 | 3回/分/ユーザー | 60秒         |

### 10.5.2 制限超過時の動作

| 状況               | 動作                                       |
| ------------------ | ------------------------------------------ |
| ユーザー制限超過   | Ephemeral メッセージで通知、待機時間を表示 |
| チャンネル制限超過 | リクエストをキュー、順次処理               |
| グローバル制限超過 | Discord API の指示に従い待機               |

### 10.5.3 Discord API レート制限対応

| 項目           | 対応                               |
| -------------- | ---------------------------------- |
| 429 レスポンス | Retry-After ヘッダーに従って待機   |
| バケット管理   | エンドポイントごとのバケットを追跡 |
| グローバル制限 | 全リクエストを一時停止             |

---

## 10.6 通知システム

### 10.6.1 進捗通知

| タイミング         | 通知内容                           |
| ------------------ | ---------------------------------- |
| ワークフロー開始   | ワークフローID、タイプ、推定時間   |
| 処理中（30秒ごと） | 現在のステップ、進捗率             |
| ステップ完了       | 完了したステップ名、次のステップ   |
| 完了               | 結果サマリー、詳細リンク、実行時間 |
| エラー             | エラー概要、原因、対処方法         |

### 10.6.2 Embed フォーマット

| フィールド | 内容                                               |
| ---------- | -------------------------------------------------- |
| タイトル   | ワークフロータイプの表示名                         |
| 説明       | ステータスメッセージ                               |
| カラー     | 状態に応じた色（青: 処理中、緑: 成功、赤: エラー） |
| フィールド | 詳細情報（ID、タイプ、時間など）                   |
| フッター   | タイムスタンプ、ユーザー情報                       |

### 10.6.3 メッセージ更新

| 方針       | 説明                               |
| ---------- | ---------------------------------- |
| 初回       | 新規メッセージとして投稿           |
| 更新       | 同じメッセージを編集（スパム防止） |
| 完了後     | 最終結果で更新、リアクション追加   |
| 長時間処理 | 5分以上は別メッセージで通知        |

---

## 10.7 認証・認可

### 10.7.1 Discord OAuth2

| 項目         | 説明                     |
| ------------ | ------------------------ |
| 認証フロー   | Authorization Code Grant |
| スコープ     | identify, email, guilds  |
| トークン保存 | 暗号化してDBに保存       |
| リフレッシュ | 有効期限切れ前に自動更新 |

### 10.7.2 ユーザー紐付け

| 項目         | 説明                              |
| ------------ | --------------------------------- |
| 初回利用時   | Discord ID でユーザーレコード作成 |
| 既存ユーザー | Discord ID で検索、紐付け         |
| 連携解除     | /settings から連携解除可能        |

### 10.7.3 権限チェック

| 権限                 | 必要な場面                     |
| -------------------- | ------------------------------ |
| Send Messages        | 結果通知、エラー通知           |
| Embed Links          | リッチな結果表示               |
| Attach Files         | 成果物の添付                   |
| Read Message History | コンテキスト理解（オプション） |
| Use Slash Commands   | コマンド実行                   |

---

## 10.8 エラーハンドリング

### 10.8.1 エラー種別

| エラー種別     | 原因                  | 対応                               |
| -------------- | --------------------- | ---------------------------------- |
| 入力エラー     | 不正なURL、未対応形式 | ユーザーにエラー内容を通知         |
| 認証エラー     | 未認証、権限不足      | 認証リンクを案内                   |
| 処理エラー     | ワークフロー実行失敗  | エラー詳細と再試行方法を通知       |
| システムエラー | Bot 内部エラー        | 一般的なエラーメッセージ、ログ記録 |

### 10.8.2 エラーメッセージ

| 場面               | メッセージ例                                                         |
| ------------------ | -------------------------------------------------------------------- |
| 未対応URL          | 指定されたURLは対応していません。対応サービス: YouTube, Google Drive |
| ファイルサイズ超過 | ファイルサイズが上限（10MB）を超えています                           |
| レート制限         | リクエストが多すぎます。30秒後に再試行してください                   |
| 処理失敗           | 処理中にエラーが発生しました。時間をおいて再試行してください         |

---

## 10.9 設定項目

### 10.9.1 環境変数

| 環境変数              | 必須   | 説明                            |
| --------------------- | ------ | ------------------------------- |
| DISCORD_BOT_TOKEN     | はい   | Bot トークン                    |
| DISCORD_CLIENT_ID     | はい   | アプリケーションID              |
| DISCORD_CLIENT_SECRET | はい   | OAuth2 クライアントシークレット |
| DISCORD_GUILD_ID      | いいえ | 開発用サーバーID（開発時のみ）  |

### 10.9.2 Bot 設定

| 設定項目               | デフォルト      | 説明                             |
| ---------------------- | --------------- | -------------------------------- |
| コマンドプレフィックス | /（スラッシュ） | スラッシュコマンドを使用         |
| 通知チャンネル         | 元のチャンネル  | 結果を投稿するチャンネル         |
| 進捗更新間隔           | 30秒            | 進捗通知の間隔                   |
| Embed カラー           | 状態別          | 処理中: 青、成功: 緑、エラー: 赤 |

### 10.9.3 サーバーごとの設定

| 設定項目       | 説明                             |
| -------------- | -------------------------------- |
| 有効チャンネル | Bot が反応するチャンネルのリスト |
| 管理者ロール   | 設定変更可能なロール             |
| 通知設定       | 進捗通知のオン/オフ              |
| 言語設定       | レスポンスの言語（ja, en）       |

---

## 10.10 デプロイ・運用

### 10.10.1 デプロイ方法

| 方法         | 説明                          |
| ------------ | ----------------------------- |
| Railway      | Webアプリと同じインフラで運用 |
| 独立サーバー | 別プロセスとして起動          |
| PM2          | プロセス管理、自動再起動      |

### 10.10.2 ヘルスチェック

| チェック項目    | 正常条件              |
| --------------- | --------------------- |
| Discord Gateway | 接続状態: READY       |
| API 応答        | レイテンシ 500ms 未満 |
| メモリ使用量    | 500MB 未満            |

### 10.10.3 監視項目

| 項目         | 閾値    | アラート |
| ------------ | ------- | -------- |
| Gateway 切断 | 発生時  | 即時通知 |
| エラー率     | 5% 以上 | Warning  |
| 応答遅延     | 1秒以上 | Warning  |

---

## 10.11 開発ガイドライン

### 10.11.1 コマンド追加手順

| 順序 | 内容                                         |
| ---- | -------------------------------------------- |
| 1    | コマンド定義を追加（名前、説明、オプション） |
| 2    | ハンドラー関数を実装                         |
| 3    | 権限チェックを追加                           |
| 4    | エラーハンドリングを実装                     |
| 5    | テストを作成                                 |
| 6    | コマンドをデプロイ（開発サーバー → 本番）    |

### 10.11.2 テスト

| テスト種別     | 対象                               |
| -------------- | ---------------------------------- |
| ユニットテスト | コマンドハンドラー、メッセージ解析 |
| 統合テスト     | Discord API モックを使用           |
| E2E テスト     | 開発サーバーで実際に実行           |

### 10.11.3 デバッグ

| 方法         | 説明                                    |
| ------------ | --------------------------------------- |
| ログ確認     | discord.js のデバッグログを有効化       |
| 開発サーバー | DISCORD_GUILD_ID を設定して高速デプロイ |
| エラー追跡   | エラーイベントをキャッチしてログ出力    |

---

## 関連ドキュメント

- [REST API 設計原則](./08-api-design.md)
- [プラグイン開発手順](./11-plugin-development.md)
- [環境変数](./13-environment-variables.md)
- [エラーハンドリング仕様](./07-error-handling.md)
- [セキュリティガイドライン](./17-security-guidelines.md)
