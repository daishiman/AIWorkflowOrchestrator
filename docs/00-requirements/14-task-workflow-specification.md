# タスク実行仕様書生成ガイド

> 本ドキュメントは統合システム設計仕様書の一部です。
> マスタードキュメント: [master_system_design.md](./master_system_design.md)

## 14.1 概要

本ドキュメントは、複雑なタスクを単一責務の原則に基づいて分解し、各サブタスクに最適なスラッシュコマンド・エージェント・スキルの組み合わせを選定するためのガイドラインを定義する。

### 目的

ユーザーから与えられた複雑なタスクを分解し、以下を実現する：

- 単一責務の原則に基づいたサブタスク分割
- 各サブタスクに最適なコマンド・エージェント・スキルの選定
- そのまま実行可能な仕様書ドキュメントの生成
- TDDサイクル（Red→Green→Refactor）の組み込み
- 品質ゲートの明確化

### 成果物配置

生成された仕様書は以下のパスに配置する：

```
docs/30-workflows/{{機能名}}/task-step{{N}}-{{機能名}}.md
```

---

## 14.2 フェーズ構造

すべてのタスクは以下のフェーズ構造に従う。各フェーズ内で責務が複数ある場合は、サブタスク番号を分岐させる（例: T-00-1, T-00-2, T-00-3）。

### Phase 0: 要件定義

| 項目     | 内容                                                            |
| -------- | --------------------------------------------------------------- |
| ID接頭辞 | `T-00`                                                          |
| 目的     | タスクの目的、スコープ、受け入れ基準を明文化                    |
| 分割基準 | 機能領域ごと / ステークホルダーごと / 非機能要件ごと            |
| 成果物   | `docs/30-workflows/{{機能名}}/task-step{{N}}-{{要件定義名}}.md` |
| 参照     | `.claude/agents/agent_list.md` から要件分析系エージェントを選定 |

#### Phase 0 サブタスク出力テンプレート

````markdown
### {{ID}}: {{名称}}

#### 目的

{{目的の詳細説明}}

#### 背景

{{このサブタスクが必要な背景}}

#### 責務（単一責務）

{{このサブタスクが担う唯一の責務}}

#### 実行コマンド

```bash
{{コマンド}} {{オプション}}
```
````

#### 使用エージェント

- **エージェント**: {{エージェント名}}
- **選定理由**: {{選定理由}}
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名     | 活用方法     |
| ------------ | ------------ |
| {{スキル名}} | {{活用方法}} |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物   | パス     | 内容     |
| -------- | -------- | -------- |
| {{名称}} | {{パス}} | {{内容}} |

#### 完了条件

- [ ] {{条件}}

#### 依存関係

- **前提**: {{前提サブタスク}}
- **後続**: {{後続サブタスク}}

````

### Phase 1: 設計

| 項目 | 内容 |
|------|------|
| ID接頭辞 | `T-01` |
| 目的 | 要件を実現可能な構造に落とし込む |
| 分割基準 | 設計領域ごと / コンポーネントごと / レイヤーごと |
| 成果物 | `docs/30-workflows/{{機能名}}/task-step{{N+1}}-{{設計名}}.md` |
| 参照 | `.claude/agents/agent_list.md` から設計系エージェントを選定 |

#### Phase 1 サブタスク出力テンプレート

```markdown
### {{ID}}: {{名称}}

#### 目的
{{目的の詳細説明}}

#### 背景
{{このサブタスクが必要な背景}}

#### 責務（単一責務）
{{このサブタスクが担う唯一の責務}}

#### 実行コマンド
```bash
{{コマンド}} {{オプション}}
````

#### 使用エージェント

- **エージェント**: {{エージェント名}}
- **選定理由**: {{選定理由}}
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名     | 活用方法     |
| ------------ | ------------ |
| {{スキル名}} | {{活用方法}} |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物   | パス     | 内容     |
| -------- | -------- | -------- |
| {{名称}} | {{パス}} | {{内容}} |

#### 完了条件

- [ ] {{条件}}

#### 依存関係

- **前提**: {{前提サブタスク}}
- **後続**: {{後続サブタスク}}

````

### Phase 2: テスト作成 (TDD: Red)

| 項目 | 内容 |
|------|------|
| ID接頭辞 | `T-02` |
| 目的 | 期待される動作を検証するテストを実装より先に作成 |
| 分割基準 | テスト種別ごと / 機能ごと / レイヤーごと |
| 検証 | テストを実行してRed（失敗）を確認 |
| 成果物 | `docs/30-workflows/{{機能名}}/task-step{{N+2}}-{{テスト設計名}}.md` |
| 参照 | `.claude/agents/agent_list.md` からテスト系エージェントを選定 |

#### Phase 2 サブタスク出力テンプレート

```markdown
### {{ID}}: {{名称}}

#### 目的
{{目的の詳細説明}}

#### 背景
{{このサブタスクが必要な背景}}

#### 責務（単一責務）
{{このサブタスクが担う唯一の責務}}

#### 実行コマンド
```bash
{{コマンド}} {{オプション}}
````

#### 使用エージェント

- **エージェント**: {{エージェント名}}
- **選定理由**: {{選定理由}}
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名     | 活用方法     |
| ------------ | ------------ |
| {{スキル名}} | {{活用方法}} |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物   | パス     | 内容     |
| -------- | -------- | -------- |
| {{名称}} | {{パス}} | {{内容}} |

#### TDD検証: Red状態確認

```bash
{{テスト実行コマンド}}
```

- [ ] テストが失敗することを確認（Red状態）

#### 完了条件

- [ ] {{条件}}

#### 依存関係

- **前提**: {{前提サブタスク}}
- **後続**: {{後続サブタスク}}

````

### Phase 3: 実装 (TDD: Green)

| 項目 | 内容 |
|------|------|
| ID接頭辞 | `T-03` |
| 目的 | テストを通すための最小限の実装を行う |
| 分割基準 | 機能ごと / レイヤーごと / コンポーネントごと |
| 検証 | テストを実行してGreen（成功）を確認 |
| 成果物 | `docs/30-workflows/{{機能名}}/task-step{{N+3}}-{{実装名}}.md` |
| 参照 | `.claude/agents/agent_list.md` から実装系エージェントを選定 |

#### Phase 3 サブタスク出力テンプレート

```markdown
### {{ID}}: {{名称}}

#### 目的
{{目的の詳細説明}}

#### 背景
{{このサブタスクが必要な背景}}

#### 責務（単一責務）
{{このサブタスクが担う唯一の責務}}

#### 実行コマンド
```bash
{{コマンド}} {{オプション}}
````

#### 使用エージェント

- **エージェント**: {{エージェント名}}
- **選定理由**: {{選定理由}}
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名     | 活用方法     |
| ------------ | ------------ |
| {{スキル名}} | {{活用方法}} |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物   | パス     | 内容     |
| -------- | -------- | -------- |
| {{名称}} | {{パス}} | {{内容}} |

#### TDD検証: Green状態確認

```bash
{{テスト実行コマンド}}
```

- [ ] テストが成功することを確認（Green状態）

#### 完了条件

- [ ] {{条件}}

#### 依存関係

- **前提**: {{前提サブタスク}}
- **後続**: {{後続サブタスク}}

````

### Phase 4: リファクタリング (TDD: Refactor)

| 項目 | 内容 |
|------|------|
| ID接頭辞 | `T-04` |
| 目的 | 動作を変えずにコード品質を改善 |
| 分割基準 | 改善領域ごと / レイヤーごと / コンポーネントごと |
| 検証 | テストを再実行して継続成功を確認 |
| 成果物 | `docs/30-workflows/{{機能名}}/task-step{{N+4}}-{{リファクタリング名}}.md` |
| 参照 | `.claude/agents/agent_list.md` から品質系エージェントを選定 |

#### Phase 4 サブタスク出力テンプレート

```markdown
### {{ID}}: {{名称}}

#### 目的
{{目的の詳細説明}}

#### 背景
{{このサブタスクが必要な背景}}

#### 責務（単一責務）
{{このサブタスクが担う唯一の責務}}

#### 実行コマンド
```bash
{{コマンド}} {{オプション}}
````

#### 使用エージェント

- **エージェント**: {{エージェント名}}
- **選定理由**: {{選定理由}}
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名     | 活用方法     |
| ------------ | ------------ |
| {{スキル名}} | {{活用方法}} |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物   | パス     | 内容     |
| -------- | -------- | -------- |
| {{名称}} | {{パス}} | {{内容}} |

#### TDD検証: 継続Green確認

```bash
{{テスト実行コマンド}}
```

- [ ] リファクタリング後もテストが成功することを確認

#### 完了条件

- [ ] {{条件}}

#### 依存関係

- **前提**: {{前提サブタスク}}
- **後続**: {{後続サブタスク}}

````

### Phase 5: 品質保証

| 項目 | 内容 |
|------|------|
| ID接頭辞 | `T-05` |
| 目的 | 定義された品質基準をすべて満たすことを検証 |
| 分割基準 | 検証種別ごと（テスト実行、Lint、型チェック、セキュリティ等） |
| 成果物 | `docs/30-workflows/{{機能名}}/task-step{{N+5}}-{{レポート名}}.md` |
| 参照 | `.claude/agents/agent_list.md` からQA/セキュリティ系エージェントを選定 |

#### Phase 5 サブタスク出力テンプレート

```markdown
### {{ID}}: {{名称}}

#### 目的
{{目的の詳細説明}}

#### 背景
{{このサブタスクが必要な背景}}

#### 責務（単一責務）
{{このサブタスクが担う唯一の責務}}

#### 実行コマンド
```bash
{{コマンド}} {{オプション}}
````

#### 使用エージェント

- **エージェント**: {{エージェント名}}
- **選定理由**: {{選定理由}}
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名     | 活用方法     |
| ------------ | ------------ |
| {{スキル名}} | {{活用方法}} |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物   | パス     | 内容     |
| -------- | -------- | -------- |
| {{名称}} | {{パス}} | {{内容}} |

#### 完了条件

- [ ] {{条件}}

#### 依存関係

- **前提**: {{前提サブタスク}}
- **後続**: {{後続サブタスク}}

````

### Phase 6: ドキュメント更新

| 項目 | 内容 |
|------|------|
| ID接頭辞 | `T-06` |
| 目的 | 実装内容をシステム要件ドキュメントに反映（概要のみ） |
| 前提条件 | Phase 5の品質ゲートをすべて通過していること |
| 更新対象 | `docs/00-requirements/` 配下の関連ドキュメント |
| 成果物 | 更新されたシステム要件ドキュメント |
| 実行コマンド | `/ai:update-all-docs` |
| 参照 | `.claude/agents/agent_list.md` からtechnical-writerエージェントを選定 |

#### 更新判断基準

| 変更内容 | 更新対象ドキュメント |
|----------|---------------------|
| 新しいエンティティ/テーブルの追加 | 05-architecture.md |
| 新しいAPIエンドポイントの追加 | 08-api-design.md |
| 新しい機能プラグインの追加 | 11-plugin-development.md |
| 新しい環境変数の追加 | 13-environment-variables.md |
| アーキテクチャの変更 | 05-architecture.md |
| ディレクトリ構造の変更 | 04-directory-structure.md |
| 非機能要件の変更 | 02-non-functional-requirements.md |

#### 更新原則

- **概要のみ記載**: 詳細な実装説明は不要
- **必要十分**: システム構築に必要不可欠な情報のみ追記
- **構造維持**: 既存ドキュメントの構造・フォーマットを維持
- **Single Source of Truth**: 重複記載禁止

#### Phase 6 サブタスク出力テンプレート

```markdown
### {{ID}}: {{名称}}

#### 目的
実装した{{機能名}}の概要をシステム要件ドキュメントに反映

#### 前提条件
- [ ] Phase 5の品質ゲートをすべて通過
- [ ] すべてのテストが成功

#### 更新対象ドキュメント
| ドキュメント | 更新内容（概要のみ） |
|-------------|---------------------|
| {{ドキュメントパス}} | {{更新概要}} |

#### 実行コマンド
```bash
/ai:update-all-docs
````

#### 使用エージェント

- **エージェント**: technical-writer
- **選定理由**: ドキュメント更新に特化
- **参照**: `.claude/agents/agent_list.md`

#### 完了条件

- [ ] 関連ドキュメントが更新されている
- [ ] 更新内容が概要レベルである
- [ ] 既存ドキュメントとの整合性が保たれている

````

### フェーズ遷移図

```mermaid
graph LR
    P0[Phase 0: 要件定義] --> P1[Phase 1: 設計]
    P1 --> P2[Phase 2: テスト作成]
    P2 --> P3[Phase 3: 実装]
    P3 --> P4[Phase 4: リファクタリング]
    P4 --> P5[Phase 5: 品質保証]
    P5 --> |品質ゲート通過| P6[Phase 6: ドキュメント更新]
    P5 --> |品質ゲート未通過| P4
    P6 --> DONE[完了]
````

---

## 14.3 品質ゲート

次フェーズに進む前に満たすべき品質基準。すべての基準をクリアしなければ次へ進めない。

### 品質ゲートチェックリスト

#### 機能検証

- [ ] 全ユニットテスト成功
- [ ] 全統合テスト成功
- [ ] 全E2Eテスト成功

#### コード品質

- [ ] Lintエラーなし
- [ ] 型エラーなし
- [ ] コードフォーマット適用済み

#### テスト網羅性

- [ ] カバレッジ基準達成（60%以上）

#### セキュリティ

- [ ] 脆弱性スキャン完了
- [ ] 重大な脆弱性なし

---

## 14.4 コマンド・エージェント・スキル選定ルール

### 参照ファイル

コマンド・エージェント・スキルの選定は以下のファイルを参照して行う：

| ファイル         | パス                                           | 用途                                         |
| ---------------- | ---------------------------------------------- | -------------------------------------------- |
| システム要件     | `docs/00-requirements/master_system_design.md` | システム全体の要件・アーキテクチャ方針を確認 |
| コマンド定義     | `.claude/commands/ai/command_list.md`          | 利用可能な全/ai:コマンドとオプションを参照   |
| エージェント定義 | `.claude/agents/agent_list.md`                 | 各エージェントの専門性・責務を参照           |
| スキル定義       | `.claude/skills/skill_list.md`                 | 各スキルの詳細定義と適用方法を参照           |

### 選定基準

#### エージェント選定マトリクス

| フェーズ | 推奨エージェント種別                                    | 選定基準                         |
| -------- | ------------------------------------------------------- | -------------------------------- |
| Phase 0  | requirements-analyst                                    | 要件探索と構造化分析             |
| Phase 1  | system-architect, backend-architect, frontend-architect | 設計領域に応じて選択             |
| Phase 2  | quality-engineer, unit-tester, e2e-tester               | テスト種別に応じて選択           |
| Phase 3  | python-expert, frontend-architect, backend-architect    | 実装領域に応じて選択             |
| Phase 4  | refactoring-expert, code-quality                        | リファクタリング対象に応じて選択 |
| Phase 5  | security-engineer, quality-engineer                     | 検証種別に応じて選択             |
| Phase 6  | technical-writer                                        | ドキュメント更新                 |

#### スラッシュコマンド選定マトリクス（/ai:プレフィックス）

| タスク種別         | 推奨コマンド                   | 用途                   |
| ------------------ | ------------------------------ | ---------------------- |
| 要件分析           | `/ai:gather-requirements`      | 要件収集               |
| ユーザーストーリー | `/ai:create-user-stories`      | ユーザーストーリー作成 |
| 設計               | `/ai:design-architecture`      | アーキテクチャ設計     |
| API設計            | `/ai:design-api`               | API設計                |
| DB設計             | `/ai:design-database`          | データベース設計       |
| コンポーネント作成 | `/ai:create-component`         | UIコンポーネント作成   |
| ユニットテスト     | `/ai:generate-unit-tests`      | ユニットテスト生成     |
| E2Eテスト          | `/ai:generate-e2e-tests`       | E2Eテスト生成          |
| 実装               | `/ai:full-feature-development` | 機能実装               |
| リファクタリング   | `/ai:refactor`                 | コードリファクタリング |
| コード品質         | `/ai:analyze-code-quality`     | コード品質分析         |
| セキュリティ       | `/ai:security-audit`           | セキュリティ監査       |
| テスト実行         | `/ai:run-all-tests`            | テスト実行             |
| ビルド             | `/ai:fix-build-error`          | ビルドエラー修正       |
| Git操作            | `/ai:commit`                   | コミット作成           |
| PR作成             | `/ai:create-pr`                | PR作成                 |
| ドキュメント更新   | `/ai:update-all-docs`          | 全ドキュメント更新     |

### 選定プロセス

1. **タスク分析**: タスクの目的と成果物を明確化
2. **フェーズ特定**: 該当するフェーズを特定
3. **エージェント選定**: フェーズに適したエージェントを選択
4. **コマンド選定**: 具体的な操作に対応するコマンドを選択
5. **スキル特定**: 必要なスキルを特定し、活用方法を記述

---

## 14.5 タスク分解ルール

### 単一責務の原則

| ルールID           | 内容                                                                 | 優先度 |
| ------------------ | -------------------------------------------------------------------- | ------ |
| SRP_PHASE          | 各フェーズ内でも、責務が複数ある場合は必ず複数のサブタスクに分割する | 必須   |
| SRP_IMPLEMENTATION | 実装フェーズでも、異なる機能・レイヤーは別サブタスクとする           | 必須   |

### プロセス制約

| 制約ID               | 内容                                                           | 優先度 |
| -------------------- | -------------------------------------------------------------- | ------ |
| CONST_PHASE_ORDER    | Phase 0→1→2→3→4→5→6の順序を厳守すること                        | 必須   |
| CONST_TDD_FIRST      | 実装前に必ずテストを作成すること（Phase 2 → Phase 3）          | 必須   |
| CONST_QUALITY_GATE   | 品質ゲート未通過でPhase 6に進んではならない                    | 必須   |
| CONST_DOC_UPDATE     | Phase 6でdocs/00-requirements/配下のドキュメントを更新すること | 必須   |
| CONST_SINGLE_COMMAND | 1サブタスク = 1コマンドの対応を原則とする                      | 推奨   |

---

## 14.6 出力テンプレート

### ファイル配置

```
docs/30-workflows/{{機能名}}/task-step{{N}}-{{機能名}}.md
```

### テンプレート構造

タスク実行仕様書は以下の構造を持つ：

1. **ユーザーからの元の指示** - 元の指示文をそのまま記載
2. **タスク概要** - 目的、背景、最終ゴール、成果物一覧
3. **参照ファイル** - コマンド・エージェント・スキル選定の参照先
4. **タスク分解サマリー** - 全サブタスクの一覧表
5. **実行フロー図** - Mermaidによるフロー可視化
6. **各フェーズの詳細** - Phase 0〜5の各サブタスク詳細
7. **品質ゲートチェックリスト** - 完了条件のチェック項目
8. **リスクと対策** - リスク分析と対応方針
9. **前提条件** - タスク実行の前提
10. **備考** - 技術的制約、参考資料

---

## 14.7 ドキュメント更新ルール

### 既存ドキュメント更新時のルール

| ルール                 | 説明                                 |
| ---------------------- | ------------------------------------ |
| Single Source of Truth | 各情報は1箇所にのみ記載              |
| 相対パスリンク         | ドキュメント間の参照は相対パスを使用 |
| 変更追跡               | 重要な変更は更新履歴に記録           |
| 整合性確認             | 関連ドキュメントとの整合性を確認     |

### 新規ドキュメント作成時の手順

1. **既存ドキュメント確認**: 類似内容の既存ドキュメントがないか確認
2. **配置先決定**: `docs/00-requirements/` または `docs/30-workflows/` の適切な場所を選択
3. **番号付与**: 連番を付与（例: 14-task-workflow-specification.md）
4. **マスター更新**: `master_system_design.md` の目次に追加
5. **相互リンク**: 関連ドキュメントからのリンクを追加

---

## 14.8 実行時のコマンド・エージェント・スキル

### 本ドキュメント作成に使用するコマンド

| コマンド       | 用途                                                            |
| -------------- | --------------------------------------------------------------- |
| `/sc:workflow` | PRDと機能要件から構造化された実装ワークフローを生成             |
| `/sc:document` | コンポーネント、関数、API、機能の重点的文書生成                 |
| `/sc:design`   | システムアーキテクチャ、API、コンポーネントインターフェース設計 |

### 本ドキュメント作成に使用するエージェント

| エージェント           | 用途                                                   |
| ---------------------- | ------------------------------------------------------ |
| `technical-writer`     | 使いやすさとアクセシビリティに重点を置いた技術文書作成 |
| `requirements-analyst` | 曖昧なプロジェクトアイデアを具体的な仕様に変換         |
| `system-architect`     | スケーラブルシステムアーキテクチャ設計                 |

### 本ドキュメント作成に使用するスキル

タスク実行仕様書の生成には、プロジェクト固有のスキル定義（`.claude/skills/skill_list.md`）を参照する。

---

## 関連ドキュメント

- [プロジェクト概要](./01-overview.md)
- [非機能要件](./02-non-functional-requirements.md)
- [アーキテクチャ設計](./05-architecture.md)
- [プラグイン開発手順](./11-plugin-development.md)
