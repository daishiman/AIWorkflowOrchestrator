# 検索パネルレンダリング不具合 - 要件定義書

## ドキュメント情報

| 項目       | 内容           |
| ---------- | -------------- |
| タスクID   | BUG-SEARCH-001 |
| ステップID | T-00-1         |
| 作成日     | 2025-12-24     |
| 分類       | バグ修正       |
| 優先度     | 高             |

---

## 1. 目的

ファイル選択状態でキーボードショートカット（Cmd+F / Cmd+T）を押下した際に、ファイル内検索/置換パネルが正しく表示されない不具合を修正し、ユーザーがシームレスにファイル内検索機能を利用できるようにする。

### 1.1 ビジネス価値

- **ユーザー体験の向上**: 標準的なキーボードショートカットが期待通りに動作することで、開発者の生産性を維持
- **機能の完全性**: 設計されたUI/UX仕様に準拠した動作を実現
- **品質保証**: リグレッションを防ぎ、検索機能の信頼性を確保

---

## 2. スコープ

### 2.1 含む（In Scope）

| 項目               | 詳細                                                                    |
| ------------------ | ----------------------------------------------------------------------- |
| 対象コンポーネント | `UnifiedSearchPanel.tsx`, `FileSearchPanel.tsx`, `EditorView/index.tsx` |
| 対象ストア         | `searchStore.ts`（`setMode`, `openSearchPanel`, `currentFilePath`関連） |
| 対象機能           | ファイル内検索モード（`mode: 'file'`）のレンダリング条件                |
| 対象ショートカット | Cmd+F（検索）、Cmd+T（置換）                                            |

### 2.2 含まない（Out of Scope）

| 項目                              | 理由                                                                      |
| --------------------------------- | ------------------------------------------------------------------------- |
| ワークスペース検索（Cmd+Shift+F） | 今回の不具合とは無関係であり、別のモード（`mode: 'workspace'`）として独立 |
| ファイル名検索（Cmd+P）           | 今回の不具合とは無関係であり、別のモード（`mode: 'filename'`）として独立  |
| 検索ロジック本体                  | レンダリング条件の修正のみが対象、検索アルゴリズムの変更は不要            |
| EditorViewの構造変更              | 既存のコンポーネント構造を維持                                            |

---

## 3. 受け入れ基準

### 3.1 正常系シナリオ

#### AC-001: ファイル選択状態でのCmd+F動作

```gherkin
Given ファイルツリーでファイルが選択されている
  And EditorViewにファイル内容が表示されている
When ユーザーがCmd+Fを押下する
Then UnifiedSearchPanelが表示される
  And モードが"file"に設定される
  And 検索入力フィールドにフォーカスが当たる
  And 検索オプションボタン（Aa, Ab, .*）が表示される
  And ナビゲーションボタン（上矢印、下矢印）が表示される
```

#### AC-002: ファイル選択状態でのCmd+T動作

```gherkin
Given ファイルツリーでファイルが選択されている
  And EditorViewにファイル内容が表示されている
When ユーザーがCmd+Tを押下する
Then UnifiedSearchPanelが表示される
  And モードが"file"に設定される
  And 検索入力フィールドが表示される
  And 置換入力フィールドが表示される
  And 検索オプションボタン（Aa, Ab, .*）が表示される
```

#### AC-003: 検索パネル内でのUI要素表示

```gherkin
Given UnifiedSearchPanelがfileモードで表示されている
When ユーザーがパネルを確認する
Then FileSearchPanelコンポーネントがレンダリングされている
  And 結果カウント表示エリアが存在する
  And 大文字小文字区別ボタン（Aa）が表示される
  And 単語単位検索ボタン（Ab）が表示される
  And 正規表現ボタン（.*）が表示される
  And 前へボタン（上矢印）が表示される
  And 次へボタン（下矢印）が表示される
```

### 3.2 異常系シナリオ

#### AC-004: ファイル未選択状態での動作

```gherkin
Given ファイルが選択されていない
  And currentFilePathがnullまたはundefined
When ユーザーがCmd+Fを押下する
Then ファイル内検索パネルは表示されない
  Or 適切なフォールバック動作が実行される
```

#### AC-005: モード切り替え時の状態保持

```gherkin
Given UnifiedSearchPanelがworkspaceモードで表示されている
When ユーザーがファイルを選択してCmd+Fを押下する
Then モードがfileに切り替わる
  And 以前の検索クエリは適切にリセットまたは保持される
```

### 3.3 境界値シナリオ

#### AC-006: 連続したショートカット操作

```gherkin
Given ファイルが選択されている
When ユーザーがCmd+Fを連続して押下する
Then パネルの表示/非表示が正しくトグルされる
  And UIがちらつかない
```

---

## 4. 影響範囲

### 4.1 直接影響を受けるコンポーネント

| ファイル                                                                            | 影響内容                                              |
| ----------------------------------------------------------------------------------- | ----------------------------------------------------- |
| `apps/desktop/src/renderer/components/organisms/SearchPanel/UnifiedSearchPanel.tsx` | モード判定ロジック、FileSearchPanelのレンダリング条件 |
| `apps/desktop/src/renderer/components/organisms/SearchPanel/FileSearchPanel.tsx`    | propsの受け取り、表示条件                             |
| `apps/desktop/src/renderer/store/slices/searchSlice.ts`                             | `currentFilePath`の状態管理、`setMode`のロジック      |
| `apps/desktop/src/renderer/views/EditorView/index.tsx`                              | 検索パネルへの`currentFilePath`伝播                   |

### 4.2 間接影響を受ける可能性があるコンポーネント

| ファイル                                                                              | 確認ポイント                               |
| ------------------------------------------------------------------------------------- | ------------------------------------------ |
| `apps/desktop/src/renderer/store/slices/workspaceSlice.ts`                            | `currentFilePath`の取得元として整合性確認  |
| `apps/desktop/src/renderer/components/organisms/SearchPanel/WorkspaceSearchPanel.tsx` | 影響がないことの確認（リグレッション防止） |
| `apps/desktop/src/renderer/components/organisms/SearchPanel/FilenameSearchPanel.tsx`  | 影響がないことの確認（リグレッション防止） |

### 4.3 影響を受けないコンポーネント（確認必須）

- ワークスペース検索機能
- ファイル名検索機能
- ファイルツリー表示機能
- エディタ本体の編集機能

---

## 5. 前提条件

### 5.1 技術的前提

| 項目               | 内容                                                                          |
| ------------------ | ----------------------------------------------------------------------------- |
| デバッグ行         | `UnifiedSearchPanel.tsx`に`DEBUG: mode=xxx, filePath=xxx`のログ出力が追加済み |
| 状態管理           | Zustandによる状態管理が正常に動作している                                     |
| キーボードイベント | `useHotkeys`フックによるショートカット検出が機能している                      |

### 5.2 環境前提

| 項目              | 内容                                 |
| ----------------- | ------------------------------------ |
| OS                | macOS（Cmd+F/Cmd+Tのショートカット） |
| ブラウザ/Electron | Electronレンダラープロセス内で動作   |
| React             | React 18.x/19.x + TypeScript 5.x     |

### 5.3 データ前提

- ファイルが正常に読み込まれ、`workspaceSlice`に`currentFilePath`が設定されていること
- `searchSlice`の初期状態が適切に設定されていること

---

## 6. 制約条件

### 6.1 技術的制約

| 制約                                 | 理由                         |
| ------------------------------------ | ---------------------------- |
| Zustand状態管理パターンを維持        | 既存アーキテクチャとの整合性 |
| コンポーネント構造を大幅に変更しない | 影響範囲の最小化             |
| TypeScript strict modeを維持         | プロジェクト品質基準         |
| 既存のprops interfaceを極力維持      | 破壊的変更の回避             |

### 6.2 品質制約

| 制約               | 基準                                                 |
| ------------------ | ---------------------------------------------------- |
| リグレッション禁止 | ワークスペース検索、ファイル名検索が正常動作すること |
| パフォーマンス維持 | パネル表示に200ms以上の遅延を発生させないこと        |
| テスト可能性       | 修正後のコードがユニットテスト可能であること         |

### 6.3 プロセス制約

| 制約                   | 内容                                     |
| ---------------------- | ---------------------------------------- |
| コード修正前に設計承認 | 次ステップ（T-01-1）で設計を確定後に実装 |
| 既存テストの維持       | 既存テストが失敗しないこと               |
| Prettier/ESLint準拠    | コードスタイルガイドラインの遵守         |

---

## 7. 根本原因の仮説

コード調査に基づく原因候補:

### 7.1 仮説1: currentFilePathの伝播問題

`UnifiedSearchPanel`が`currentFilePath`を受け取る経路で、値が正しく伝播されていない可能性。

- `currentFilePath`がsearchSlice/workspaceSliceから取得されているが、同期が取れていない可能性

### 7.2 仮説2: レンダリング条件の問題

`FileSearchPanel`のレンダリング条件が厳しすぎる、または不適切な可能性。

- `mode === 'file'`は満たされているが、`FileSearchPanel`内部で追加の条件チェックがある可能性

### 7.3 仮説3: ストア状態の更新タイミング

`setMode('file')`と`currentFilePath`の設定が非同期で、レンダリング時に不整合が発生している可能性。

---

## 8. 検証方法

### 8.1 デバッグ手順

1. Cmd+F押下時のconsole.logを確認
2. `mode`の値が`'file'`になっているか確認
3. `filePath`の値が空文字でないか確認
4. `FileSearchPanel`がDOMに存在するか確認（DevTools）

### 8.2 テストケース（実装フェーズで作成）

| テストID | テスト内容                                     |
| -------- | ---------------------------------------------- |
| TEST-001 | ファイル選択 -> Cmd+F -> パネル表示確認        |
| TEST-002 | ファイル選択 -> Cmd+T -> パネル+置換行表示確認 |
| TEST-003 | ファイル未選択 -> Cmd+F -> 適切な動作確認      |
| TEST-004 | モード切り替え -> 状態整合性確認               |

---

## 9. 次ステップ

本要件定義書の完了後、以下のステップに進む:

| ステップ | 内容                           | 担当         |
| -------- | ------------------------------ | ------------ |
| T-01-1   | 設計（原因特定と修正方針策定） | 設計担当     |
| T-02-1   | 設計レビュー                   | レビュー担当 |
| T-03-1   | テスト作成（TDD: Red）         | テスト担当   |
| T-04-1   | 実装（TDD: Green）             | 実装担当     |

---

## 10. 承認

| 役割         | 承認者               | 日付       |
| ------------ | -------------------- | ---------- |
| 要件定義     | Requirements Analyst | 2025-12-24 |
| 技術レビュー | -                    | -          |
| 最終承認     | -                    | -          |
