# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†è¦ä»¶å®šç¾©æ›¸

## 1. æ¦‚è¦

### 1.1 ç›®çš„

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆè¡¨ç¤ºåã€ãƒ¡ãƒ¼ãƒ«ã€ã‚¢ãƒã‚¿ãƒ¼ï¼‰ã‚’ç®¡ç†ã§ãã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã€Supabaseï¼ˆèªè¨¼ï¼‰ã¨Tursoï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ï¼‰ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ§‹æˆã§æ°¸ç¶šåŒ–ã™ã‚‹ã€‚

### 1.2 ã‚¹ã‚³ãƒ¼ãƒ—

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®CRUDæ“ä½œ
- ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®ç®¡ç†
- Supabaseï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰ã¨Tursoï¼ˆè¨­å®šï¼‰ã®é€£æº
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### 1.3 ã‚¹ã‚³ãƒ¼ãƒ—å¤–

- ç®¡ç†è€…ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆä¸è¦ã¨ç¢ºèªæ¸ˆã¿ï¼‰
- ãƒãƒ¼ãƒ /çµ„ç¹”æ©Ÿèƒ½ï¼ˆå°†æ¥æ‹¡å¼µï¼‰
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šï¼ˆå°†æ¥æ‹¡å¼µï¼‰

---

## 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

### 2.1 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º

```
As a ãƒ¦ãƒ¼ã‚¶ãƒ¼
I want to è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ç¢ºèªã™ã‚‹
So that ç¾åœ¨ã®ç™»éŒ²æƒ…å ±ã‚’æŠŠæ¡ã§ãã‚‹

Acceptance Criteria:
- [ ] è¨­å®šç”»é¢ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è¡¨ç¤ºåã€ãƒ¡ãƒ¼ãƒ«ã€ã‚¢ãƒã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] é€£æºä¸­ã®OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ—ãƒ©ãƒ³ï¼ˆfree/pro/enterpriseï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### 2.2 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†

```
As a ãƒ¦ãƒ¼ã‚¶ãƒ¼
I want to è¡¨ç¤ºåã‚’å¤‰æ›´ã™ã‚‹
So that ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¡¨ç¤ºåã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹

Acceptance Criteria:
- [ ] è¡¨ç¤ºåå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ç·¨é›†ã§ãã‚‹
- [ ] 3ã€œ30æ–‡å­—ã®ç¯„å›²ã§å…¥åŠ›ã§ãã‚‹
- [ ] ä¿å­˜ãƒœã‚¿ãƒ³ã§å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹
- [ ] ä¿å­˜æˆåŠŸæ™‚ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### 2.3 ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†

```
As a ãƒ¦ãƒ¼ã‚¶ãƒ¼
I want to ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’è¨­å®šã™ã‚‹
So that è‡ªåˆ†ã‚’è¦–è¦šçš„ã«è­˜åˆ¥ã§ãã‚‹

Acceptance Criteria:
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹
- [ ] OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹
- [ ] ã‚¢ãƒã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã›ã‚‹
- [ ] ã‚µãƒãƒ¼ãƒˆå½¢å¼: PNG, JPG, GIF, WebP
- [ ] æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 5MB
```

### 2.4 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ

```
As a ãƒ¦ãƒ¼ã‚¶ãƒ¼
I want to ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç¢ºèªãƒ»ç·¨é›†ã™ã‚‹
So that ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã«é–¢ä¿‚ãªãä½œæ¥­ã‚’ç¶™ç¶šã§ãã‚‹

Acceptance Criteria:
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ç·¨é›†ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹
- [ ] ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«è‡ªå‹•åŒæœŸã•ã‚Œã‚‹
- [ ] åŒæœŸç«¶åˆæ™‚ã¯æœ€çµ‚æ›´æ–°æ—¥æ™‚ã§è§£æ±ºã•ã‚Œã‚‹
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### 3.1 UserProfileï¼ˆSupabaseï¼‰

```typescript
// Supabaseã«ä¿å­˜ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±
interface UserProfile {
  id: string;              // Supabase user_id (PK)
  displayName: string;     // è¡¨ç¤ºå (3-30æ–‡å­—)
  email: string;           // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (read-only from OAuth)
  avatarUrl: string | null; // ã‚¢ãƒã‚¿ãƒ¼URL (Supabase Storage or OAuth)
  plan: 'free' | 'pro' | 'enterprise'; // ãƒ—ãƒ©ãƒ³
  createdAt: Date;         // ä½œæˆæ—¥æ™‚
  updatedAt: Date;         // æ›´æ–°æ—¥æ™‚
}

// Supabase ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name VARCHAR(30) NOT NULL,
  email VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  plan VARCHAR(20) DEFAULT 'free',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å‚ç…§ãƒ»æ›´æ–°å¯èƒ½
CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = id);
```

### 3.2 UserSettingsï¼ˆTursoï¼‰

```typescript
// Tursoã«ä¿å­˜ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
interface UserSettings {
  id: string; // UUID (PK)
  userId: string; // Supabase user_id (FK)
  themeMode: "light" | "dark" | "system";
  language: string; // 'ja' | 'en'
  notificationsEnabled: boolean;
  autoSyncEnabled: boolean;
  createdAt: Date;
  updatedAt: Date;
}

// Drizzle ORM ã‚¹ã‚­ãƒ¼ãƒ (Turso)
import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";

export const userSettings = sqliteTable("user_settings", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().unique(),
  themeMode: text("theme_mode").default("system"),
  language: text("language").default("ja"),
  notificationsEnabled: integer("notifications_enabled", {
    mode: "boolean",
  }).default(true),
  autoSyncEnabled: integer("auto_sync_enabled", { mode: "boolean" }).default(
    true,
  ),
  createdAt: text("created_at").default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text("updated_at").default(sql`CURRENT_TIMESTAMP`),
});
```

### 3.3 AuthProviderï¼ˆSupabaseï¼‰

```typescript
// OAuthé€£æºæƒ…å ±ï¼ˆSupabase auth.identitiesã‹ã‚‰å–å¾—ï¼‰
interface AuthProvider {
  type: "google" | "github" | "discord";
  providerId: string; // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  email: string;
  displayName: string | null;
  avatarUrl: string | null;
  connectedAt: Date;
}
```

### 3.4 ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆelectron-storeï¼‰

```typescript
// ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±
interface CachedProfile {
  profile: UserProfile;
  settings: UserSettings;
  providers: AuthProvider[];
  cachedAt: Date;
  pendingChanges: PendingChange[];
}

interface PendingChange {
  field: string;
  oldValue: unknown;
  newValue: unknown;
  changedAt: Date;
}
```

---

## 4. CRUDæ“ä½œ

### 4.1 Createï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆï¼‰

OAuthèªè¨¼æˆåŠŸæ™‚ã«è‡ªå‹•ä½œæˆã•ã‚Œã‚‹ã€‚

```typescript
// Supabase Function (ãƒˆãƒªã‚¬ãƒ¼)
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_profiles (id, display_name, email, avatar_url)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'name', NEW.email),
    NEW.email,
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### 4.2 Readï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ï¼‰

```typescript
// IPC Handler
async function getProfile(userId: string): Promise<UserProfile> {
  // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
  const cached = await getCachedProfile(userId);

  if (!navigator.onLine) {
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã™
    return cached?.profile ?? createDefaultProfile(userId);
  }

  try {
    // 2. Supabaseã‹ã‚‰æœ€æ–°ã‚’å–å¾—
    const { data, error } = await supabase
      .from("user_profiles")
      .select("*")
      .eq("id", userId)
      .single();

    if (error) throw error;

    // 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    await updateCachedProfile(data);

    return data;
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    return cached?.profile ?? createDefaultProfile(userId);
  }
}
```

### 4.3 Updateï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ï¼‰

```typescript
// IPC Handler
async function updateProfile(
  userId: string,
  updates: Partial<UserProfile>,
): Promise<UserProfile> {
  // 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  validateProfileUpdates(updates);

  if (!navigator.onLine) {
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ä¿ç•™å¤‰æ›´ã¨ã—ã¦ä¿å­˜
    await savePendingChange(userId, updates);
    return getLocalProfile(userId);
  }

  try {
    // 2. Supabaseã‚’æ›´æ–°
    const { data, error } = await supabase
      .from("user_profiles")
      .update({
        ...updates,
        updated_at: new Date().toISOString(),
      })
      .eq("id", userId)
      .select()
      .single();

    if (error) throw error;

    // 3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    await updateCachedProfile(data);

    return data;
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¿ç•™å¤‰æ›´ã¨ã—ã¦ä¿å­˜
    await savePendingChange(userId, updates);
    throw error;
  }
}
```

### 4.4 Deleteï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼‰

```typescript
// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã¯å°†æ¥å®Ÿè£…
// ç¾æ™‚ç‚¹ã§ã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–
```

---

## 5. ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†

### 5.1 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI         â”‚     â”‚  Main Process  â”‚     â”‚   Supabase    â”‚
â”‚   (Renderer) â”‚     â”‚                â”‚     â”‚   Storage     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                      â”‚
       â”‚ 1. Select file      â”‚                      â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                      â”‚
       â”‚                     â”‚                      â”‚
       â”‚ 2. Validate &       â”‚                      â”‚
       â”‚    Resize           â”‚                      â”‚
       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                      â”‚
       â”‚                     â”‚                      â”‚
       â”‚ 3. Upload to        â”‚                      â”‚
       â”‚    Storage          â”‚                      â”‚
       â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚                     â”‚                      â”‚
       â”‚                     â”‚ 4. Return public URL â”‚
       â”‚                     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚                     â”‚                      â”‚
       â”‚ 5. Update profile   â”‚                      â”‚
       â”‚    with URL         â”‚                      â”‚
       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                      â”‚
       â”‚                     â”‚                      â”‚
```

### 5.2 ç”»åƒå‡¦ç†ä»•æ§˜

| é …ç›®               | å€¤                       |
| ------------------ | ------------------------ |
| ã‚µãƒãƒ¼ãƒˆå½¢å¼       | PNG, JPG, GIF, WebP      |
| æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º | 5MB                      |
| ãƒªã‚µã‚¤ã‚ºå¾Œã‚µã‚¤ã‚º   | 256x256px                |
| ä¿å­˜å½¢å¼           | WebP (å“è³ª80%)           |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‘ã‚¹     | `avatars/{user_id}.webp` |

### 5.3 å®Ÿè£…

```typescript
// Main Process
async function uploadAvatar(userId: string, filePath: string): Promise<string> {
  // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  const fileBuffer = await fs.readFile(filePath);

  // 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const fileSize = fileBuffer.length;
  if (fileSize > 5 * 1024 * 1024) {
    throw new Error("File size exceeds 5MB limit");
  }

  // 3. ç”»åƒãƒªã‚µã‚¤ã‚ºï¼ˆsharpä½¿ç”¨ï¼‰
  const resizedBuffer = await sharp(fileBuffer)
    .resize(256, 256, { fit: "cover" })
    .webp({ quality: 80 })
    .toBuffer();

  // 4. Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const fileName = `${userId}.webp`;
  const { data, error } = await supabase.storage
    .from("avatars")
    .upload(fileName, resizedBuffer, {
      contentType: "image/webp",
      upsert: true,
    });

  if (error) throw error;

  // 5. å…¬é–‹URLã‚’å–å¾—
  const { data: urlData } = supabase.storage
    .from("avatars")
    .getPublicUrl(fileName);

  // 6. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°
  await updateProfile(userId, { avatarUrl: urlData.publicUrl });

  return urlData.publicUrl;
}
```

### 5.4 OAuthã‚¢ãƒã‚¿ãƒ¼ä½¿ç”¨

```typescript
// OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼ã‚’ä½¿ç”¨
async function useProviderAvatar(
  userId: string,
  provider: "google" | "github" | "discord",
): Promise<string> {
  // 1. èªè¨¼æƒ…å ±ã‹ã‚‰ã‚¢ãƒã‚¿ãƒ¼URLã‚’å–å¾—
  const {
    data: { user },
  } = await supabase.auth.getUser();
  const identity = user?.identities?.find((i) => i.provider === provider);

  if (!identity?.identity_data?.avatar_url) {
    throw new Error("Provider avatar not available");
  }

  const avatarUrl = identity.identity_data.avatar_url;

  // 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°
  await updateProfile(userId, { avatarUrl });

  return avatarUrl;
}
```

---

## 6. åŒæœŸæ–¹å¼

### 6.1 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Flow                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Renderer   â”‚â—„â”€â”€â–ºâ”‚    IPC      â”‚â—„â”€â”€â–ºâ”‚    Main     â”‚     â”‚
â”‚  â”‚  (Zustand)  â”‚    â”‚  (Bridge)   â”‚    â”‚  (Handler)  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                                      â”‚            â”‚
â”‚         â”‚ UI State                    DB Operations        â”‚
â”‚         â”‚                                      â”‚            â”‚
â”‚         â–¼                                      â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Local      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Supabase   â”‚     â”‚
â”‚  â”‚  Cache      â”‚     Sync on           â”‚  (Profile)  â”‚     â”‚
â”‚  â”‚  (store)    â”‚     online            â”‚             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                â”‚            â”‚
â”‚                                                â”‚            â”‚
â”‚                                                â–¼            â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                                        â”‚   Turso     â”‚     â”‚
â”‚                                        â”‚  (Settings) â”‚     â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 åŒæœŸæˆ¦ç•¥

| ã‚·ãƒŠãƒªã‚ª                   | æˆ¦ç•¥                                            |
| -------------------------- | ----------------------------------------------- |
| **ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã®èª­ã¿è¾¼ã¿** | Supabase/Tursoã‹ã‚‰å–å¾— â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–° |
| **ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã®æ›¸ãè¾¼ã¿** | Supabase/Tursoæ›´æ–° â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°     |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®èª­ã¿è¾¼ã¿** | ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¿”å´                      |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®æ›¸ãè¾¼ã¿** | ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–° + ä¿ç•™å¤‰æ›´ã«è¿½åŠ          |
| **ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚**       | ä¿ç•™å¤‰æ›´ã‚’Supabase/Tursoã«åŒæœŸ                  |

### 6.3 ç«¶åˆè§£æ±º

```typescript
// Last Write Wins æˆ¦ç•¥
async function resolveConflict(
  local: UserProfile,
  remote: UserProfile,
): Promise<UserProfile> {
  if (new Date(local.updatedAt) > new Date(remote.updatedAt)) {
    // ãƒ­ãƒ¼ã‚«ãƒ«ãŒæ–°ã—ã„å ´åˆã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚’æ›´æ–°
    await updateRemoteProfile(local);
    return local;
  } else {
    // ãƒªãƒ¢ãƒ¼ãƒˆãŒæ–°ã—ã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚’æ›´æ–°
    await updateLocalCache(remote);
    return remote;
  }
}
```

---

## 7. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### 7.1 è¡¨ç¤ºå

```typescript
const displayNameSchema = z
  .string()
  .min(3, "è¡¨ç¤ºåã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„")
  .max(30, "è¡¨ç¤ºåã¯30æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
  .regex(
    /^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s_-]+$/,
    "ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™",
  );
```

### 7.2 ã‚¢ãƒã‚¿ãƒ¼

```typescript
const avatarSchema = z.object({
  file: z
    .instanceof(File)
    .refine(
      (f) => f.size <= 5 * 1024 * 1024,
      "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„",
    )
    .refine(
      (f) =>
        ["image/png", "image/jpeg", "image/gif", "image/webp"].includes(f.type),
      "PNG, JPG, GIF, WebPå½¢å¼ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™",
    ),
});
```

---

## 8. å—ã‘å…¥ã‚ŒåŸºæº–

### 8.1 æ©Ÿèƒ½è¦ä»¶

- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆè¡¨ç¤ºåã€ãƒ¡ãƒ¼ãƒ«ã€ã‚¢ãƒã‚¿ãƒ¼ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è¡¨ç¤ºåã‚’ç·¨é›†ã§ãã‚‹
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¢ãƒã‚¿ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹
- [ ] OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹
- [ ] ã‚¢ãƒã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã›ã‚‹
- [ ] é€£æºä¸­ã®OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ç·¨é›†ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°å¾Œã«åŒæœŸã•ã‚Œã‚‹

### 8.2 éæ©Ÿèƒ½è¦ä»¶

- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã¯500msä»¥å†…ã«å®Œäº†ã™ã‚‹
- [ ] ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯5ç§’ä»¥å†…ã«å®Œäº†ã™ã‚‹
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã¯å³åº§ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã•ã‚Œã‚‹
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚‚1ç§’ä»¥å†…ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### 8.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å‚ç…§ãƒ»ç·¨é›†å¯èƒ½ï¼ˆRLSï¼‰
- [ ] ã‚¢ãƒã‚¿ãƒ¼ã¯Supabase Storageã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã‚‹
- [ ] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆOAuthçµŒç”±ã®ã¿å¤‰æ›´å¯èƒ½ï¼‰

---

## 9. UIè¦ä»¶

### 9.1 è¨­å®šç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š                                   â”‚
â”‚ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨é€£æºã‚µãƒ¼ãƒ“ã‚¹ã‚’ç®¡ç†ã—ã¾ã™           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ ğŸ‘¤  â”‚  [ç”»åƒã‚’å¤‰æ›´] [å‰Šé™¤]                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                  â”‚
â”‚ è¡¨ç¤ºå                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ 3ã€œ30æ–‡å­—                                        â”‚
â”‚                                                  â”‚
â”‚ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ user@example.com                   (èª­å–å°‚ç”¨)â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â”‚ ãƒ—ãƒ©ãƒ³                                           â”‚
â”‚ ğŸ†“ Free                              [ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰]
â”‚                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚ é€£æºã‚µãƒ¼ãƒ“ã‚¹                                     â”‚
â”‚                                                  â”‚
â”‚ ğŸŸ¢ Google: user@gmail.com                       â”‚
â”‚    é€£æºæ—¥: 2024/01/15                            â”‚
â”‚                                                  â”‚
â”‚ âšª GitHub                           [é€£æºã™ã‚‹]  â”‚
â”‚                                                  â”‚
â”‚ âšª Discord                          [é€£æºã™ã‚‹]  â”‚
â”‚                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚              [å¤‰æ›´ã‚’ä¿å­˜]                        â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ã‚¢ãƒã‚¿ãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’é¸æŠ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ â”‚           â”‚  â”‚           â”‚             â”‚
â”‚ â”‚  ğŸ“       â”‚  â”‚  Google   â”‚             â”‚
â”‚ â”‚ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰â”‚  â”‚  ã‚¢ãƒã‚¿ãƒ¼ â”‚             â”‚
â”‚ â”‚é¸æŠ       â”‚  â”‚  ã‚’ä½¿ç”¨   â”‚             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ â”‚           â”‚  â”‚           â”‚             â”‚
â”‚ â”‚  GitHub   â”‚  â”‚  Discord  â”‚             â”‚
â”‚ â”‚  ã‚¢ãƒã‚¿ãƒ¼ â”‚  â”‚  ã‚¢ãƒã‚¿ãƒ¼ â”‚             â”‚
â”‚ â”‚  ã‚’ä½¿ç”¨   â”‚  â”‚  ã‚’ä½¿ç”¨   â”‚             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                          â”‚
â”‚              [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]                 â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 10.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡

| ã‚¨ãƒ©ãƒ¼               | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                       | å¯¾å‡¦                   |
| -------------------- | -------------------------------- | ---------------------- |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | å…·ä½“çš„ãªå•é¡Œã‚’è¡¨ç¤º               | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼   | ã€Œä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€         | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ä¿ç•™ |
| ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼   | ã€Œç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã€     | ãƒªãƒˆãƒ©ã‚¤ã‚’ææ¡ˆ         |
| æ¨©é™ã‚¨ãƒ©ãƒ¼           | ã€Œã“ã®æ“ä½œã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€ | å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã™       |

---

## 11. å‚è€ƒè³‡æ–™

- [Supabase Storage](https://supabase.com/docs/guides/storage)
- [Supabase Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Sharp Image Processing](https://sharp.pixelplumbing.com/)
- [Zod Validation](https://zod.dev/)
