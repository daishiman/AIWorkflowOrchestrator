# フォルダ一括選択機能 - 要件定義書

## メタ情報

| 項目             | 内容                  |
| ---------------- | --------------------- |
| タスクID         | TASK-DT-001           |
| ドキュメントID   | REQ-001               |
| バージョン       | 1.0.0                 |
| ステータス       | Draft                 |
| 作成日           | 2025-12-18            |
| 作成エージェント | @req-analyst          |
| 対象機能         | WorkspaceFileSelector |

---

## 1. プロジェクト概要

### 1.1 目的

WorkspaceFileSelectorコンポーネントに**フォルダ一括選択機能**を追加し、ユーザーがフォルダをクリックするだけで配下の全ファイルを選択/解除できるようにする。

### 1.2 背景

| 項目   | 内容                                                                                                           |
| ------ | -------------------------------------------------------------------------------------------------------------- |
| 現状   | WorkspaceFileSelectorはファイル個別選択のみ対応（`toggleFile`関数）。フォルダは展開/折りたたみ機能のみ         |
| 課題   | 大量ファイル選択時、ユーザーは1ファイルずつ選択する必要があり操作負担が大きい                                  |
| 影響   | RAGデータ変換ワークフローなど、複数ファイルを扱う機能において操作効率が著しく低下                              |
| 解決策 | フォルダクリックで配下ファイルを一括選択/解除する機能を追加し、部分選択状態（indeterminate）を視覚的に表現する |

### 1.3 スコープ

#### スコープ内（含むもの）

| 項目                  | 説明                                                      |
| --------------------- | --------------------------------------------------------- |
| フォルダ一括選択      | フォルダクリックで配下全ファイルを選択                    |
| フォルダ一括解除      | 選択済みフォルダ再クリックで配下全ファイルを解除          |
| 部分選択状態表示      | indeterminateチェックボックスで一部選択状態を視覚的に表現 |
| 全選択/未選択状態表示 | チェックボックスで全選択・未選択状態を表現                |
| ネストフォルダ対応    | 深い階層のフォルダも一括選択対象                          |
| 既存機能との共存      | 個別ファイル選択機能との整合性維持                        |
| ユニットテスト        | toggleFolder/getSelectionState関数のテスト追加            |
| アクセシビリティ対応  | ARIA属性（aria-checked="mixed"）の実装                    |

#### スコープ外（含まないもの）

| 項目                  | 説明                               | 管理先                                                                             |
| --------------------- | ---------------------------------- | ---------------------------------------------------------------------------------- |
| ドラッグ&ドロップ選択 | 範囲選択のためのドラッグ操作       | docs/30-workflows/unassigned-task/task-file-selector-drag-drop.md                  |
| アクセシビリティ改善  | スクリーンリーダー対応の高度な改善 | docs/30-workflows/unassigned-task/task-file-selector-accessibility-improvements.md |
| IPC API追加           | 新規IPC通信の追加                  | 既存workspaceストアを使用                                                          |
| パフォーマンス監視    | メトリクス収集・監視ダッシュボード | 将来タスク                                                                         |

### 1.4 ステークホルダー

| ステークホルダー | 役割                     | 関心事                                   |
| ---------------- | ------------------------ | ---------------------------------------- |
| エンドユーザー   | アプリケーション利用者   | 操作効率、直感的なUI、一貫した動作       |
| 開発者（自分）   | 実装者・保守者           | 保守性、テスト容易性、既存機能との整合性 |
| @arch-police     | アーキテクチャレビュアー | Clean Architecture準拠、SOLID原則        |

---

## 2. 機能要件（Functional Requirements）

### 2.1 FR-001: フォルダ一括選択

| 項目   | 内容                                                                                 |
| ------ | ------------------------------------------------------------------------------------ |
| ID     | FR-001                                                                               |
| 名称   | フォルダ一括選択                                                                     |
| 説明   | フォルダのチェックボックスをクリックすると、そのフォルダ配下の全ファイルが選択される |
| 優先度 | **Must（必須）**                                                                     |
| 根拠   | 大量ファイル選択時の操作効率向上が主目的であるため                                   |

**振る舞いの詳細:**

1. フォルダのチェックボックスクリック
2. `getAllFilesInFolder`関数で配下の全ファイルを再帰的に取得
3. 各ファイルに対して`toggleFile`関数を呼び出し選択状態に変更
4. 選択されたファイルが`selectedFiles`配列に追加される

**制約:**

- ファイルのみ選択対象（フォルダ自体は選択対象外）
- 既存の`allowedExtensions`フィルターは引き続き適用
- 既存の`maxSelection`制限は引き続き適用

### 2.2 FR-002: フォルダ一括解除

| 項目   | 内容                                                                                           |
| ------ | ---------------------------------------------------------------------------------------------- |
| ID     | FR-002                                                                                         |
| 名称   | フォルダ一括解除                                                                               |
| 説明   | 全ファイルが選択済みのフォルダのチェックボックスを再クリックすると、配下全ファイルが解除される |
| 優先度 | **Must（必須）**                                                                               |
| 根拠   | 一括選択の逆操作として必須                                                                     |

**振る舞いの詳細:**

1. 全選択状態のフォルダのチェックボックスクリック
2. `getAllFilesInFolder`関数で配下の全ファイルを取得
3. 各ファイルに対して`removeFile`関数を呼び出し選択解除
4. 解除されたファイルが`selectedFiles`配列から削除される

### 2.3 FR-003: 部分選択状態の切り替え

| 項目   | 内容                                                                                            |
| ------ | ----------------------------------------------------------------------------------------------- |
| ID     | FR-003                                                                                          |
| 名称   | 部分選択状態の切り替え                                                                          |
| 説明   | 一部ファイルが選択されている状態（indeterminate）でフォルダをクリックすると、全選択に変更される |
| 優先度 | **Must（必須）**                                                                                |
| 根拠   | 直感的な操作フローのため                                                                        |

**振る舞いの詳細:**

1. indeterminate状態のフォルダのチェックボックスクリック
2. 未選択のファイルのみを追加選択
3. 全ファイルが選択された状態に遷移

### 2.4 FR-004: 選択状態の計算（getSelectionState）

| 項目   | 内容                                                       |
| ------ | ---------------------------------------------------------- |
| ID     | FR-004                                                     |
| 名称   | 選択状態の計算                                             |
| 説明   | フォルダ配下のファイル選択状況に基づき、選択状態を計算する |
| 優先度 | **Must（必須）**                                           |
| 根拠   | UIでの視覚的表現に必要                                     |

**状態定義:**

| 状態          | 条件                                | 視覚表現      |
| ------------- | ----------------------------------- | ------------- |
| unselected    | 配下ファイルが0件選択               | ☐（空）       |
| indeterminate | 配下ファイルが1件以上〜全件未満選択 | ☑（ハイフン） |
| selected      | 配下ファイルが全件選択              | ☑（チェック） |

**境界値:**

| ケース           | 配下ファイル数 | 選択数 | 結果          |
| ---------------- | -------------- | ------ | ------------- |
| 空フォルダ       | 0              | 0      | unselected    |
| 1ファイル未選択  | 1              | 0      | unselected    |
| 1ファイル選択    | 1              | 1      | selected      |
| 5ファイル中1選択 | 5              | 1      | indeterminate |
| 5ファイル中5選択 | 5              | 5      | selected      |

### 2.5 FR-005: ネストフォルダ対応

| 項目   | 内容                                                     |
| ------ | -------------------------------------------------------- |
| ID     | FR-005                                                   |
| 名称   | ネストフォルダ対応                                       |
| 説明   | 親フォルダの選択操作は、全階層の子孫ファイルに適用される |
| 優先度 | **Must（必須）**                                         |
| 根拠   | 実際のファイルツリーは深い階層構造を持つため             |

**例:**

```
📁 parent/
  ├── 📄 file1.txt
  ├── 📁 child/
  │   ├── 📄 file2.txt
  │   └── 📁 grandchild/
  │       └── 📄 file3.txt
  └── 📄 file4.txt
```

- `parent/`を一括選択 → `file1.txt`, `file2.txt`, `file3.txt`, `file4.txt` の4ファイルが選択

### 2.6 FR-006: 既存個別選択との共存

| 項目   | 内容                                      |
| ------ | ----------------------------------------- |
| ID     | FR-006                                    |
| 名称   | 既存個別選択との共存                      |
| 説明   | 一括選択後も個別ファイルの選択/解除が可能 |
| 優先度 | **Must（必須）**                          |
| 根拠   | 柔軟なファイル選択操作のため              |

**シナリオ:**

1. フォルダを一括選択（全5ファイル選択）
2. 個別ファイル1つを解除
3. フォルダはindeterminate状態に変化
4. 個別ファイルを再選択
5. フォルダはselected状態に戻る

---

## 3. 非機能要件（Non-Functional Requirements）

### 3.1 NFR-001: パフォーマンス

| 項目     | 内容                                               |
| -------- | -------------------------------------------------- |
| ID       | NFR-001                                            |
| 名称     | パフォーマンス                                     |
| 説明     | フォルダ一括選択操作がユーザー体感で即座に完了する |
| 優先度   | **Should（推奨）**                                 |
| 測定基準 | 1000ファイル配下のフォルダ選択が200ms以内に完了    |

**対策:**

- `setState`呼び出しをバッチ処理
- `getAllFilesInFolder`の結果をメモ化（必要に応じて）
- 再帰処理の最適化（末尾再帰または反復処理）

### 3.2 NFR-002: アクセシビリティ

| 項目     | 内容                                          |
| -------- | --------------------------------------------- |
| ID       | NFR-002                                       |
| 名称     | アクセシビリティ                              |
| 説明     | WCAG 2.1 AA基準を満たすアクセシビリティを提供 |
| 優先度   | **Should（推奨）**                            |
| 測定基準 | axe-coreによる自動検証でエラー0件             |

**要件:**

| 項目               | 実装内容                                        |
| ------------------ | ----------------------------------------------- |
| ARIA属性           | indeterminate状態で`aria-checked="mixed"`を設定 |
| キーボード操作     | Spaceキーでフォルダ選択切り替え                 |
| フォーカス管理     | Tab/Shift+Tabで適切にフォーカス移動             |
| スクリーンリーダー | 選択状態の変化が読み上げられる                  |

### 3.3 NFR-003: 保守性

| 項目     | 内容                                                 |
| -------- | ---------------------------------------------------- |
| ID       | NFR-003                                              |
| 名称     | 保守性                                               |
| 説明     | コードの可読性と変更容易性を維持                     |
| 優先度   | **Should（推奨）**                                   |
| 測定基準 | Cyclomatic Complexity < 10、テストカバレッジ 80%以上 |

**要件:**

- 単一責務原則に従った関数設計
- 明確な命名規則（`toggleFolder`, `getSelectionState`）
- 既存の`useWorkspaceFileSelection`フックへの追加
- JSDocによるドキュメンテーション

### 3.4 NFR-004: 互換性

| 項目     | 内容                                                      |
| -------- | --------------------------------------------------------- |
| ID       | NFR-004                                                   |
| 名称     | 互換性                                                    |
| 説明     | 既存APIとの後方互換性を維持                               |
| 優先度   | **Must（必須）**                                          |
| 測定基準 | 既存のuseWorkspaceFileSelection呼び出し元が変更なしで動作 |

**要件:**

- 既存の`UseWorkspaceFileSelectionReturn`型を拡張
- 新規関数（`toggleFolder`, `getSelectionState`）は追加形式
- 既存の`toggleFile`, `removeFile`, `clearSelection`は変更なし

---

## 4. UI/UX要件

### 4.1 UI-001: チェックボックス3状態表示

| 項目   | 内容                                                        |
| ------ | ----------------------------------------------------------- |
| ID     | UI-001                                                      |
| 名称   | チェックボックス3状態表示                                   |
| 説明   | フォルダのチェックボックスが3つの選択状態を視覚的に表現する |
| 優先度 | **Must（必須）**                                            |

**視覚デザイン:**

| 状態          | 外観                           | HTMLプロパティ                         |
| ------------- | ------------------------------ | -------------------------------------- |
| unselected    | ☐ 空のチェックボックス         | `checked=false`, `indeterminate=false` |
| indeterminate | ☑ ハイフン付きチェックボックス | `checked=false`, `indeterminate=true`  |
| selected      | ☑ チェック付きチェックボックス | `checked=true`, `indeterminate=false`  |

**実装方法:**

```tsx
<input
  type="checkbox"
  ref={(el) => {
    if (el) el.indeterminate = selectionState === "indeterminate";
  }}
  checked={selectionState === "selected"}
  onChange={() => onFolderToggle(folderPath, folder)}
  aria-checked={
    selectionState === "indeterminate" ? "mixed" : selectionState === "selected"
  }
/>
```

### 4.2 UI-002: フォルダ行のクリック領域

| 項目   | 内容                                             |
| ------ | ------------------------------------------------ |
| ID     | UI-002                                           |
| 名称   | フォルダ行のクリック領域                         |
| 説明   | チェックボックス領域とフォルダ名領域で動作を分離 |
| 優先度 | **Should（推奨）**                               |

**動作分離:**

| クリック領域         | 動作                    |
| -------------------- | ----------------------- |
| チェックボックス     | フォルダ一括選択/解除   |
| フォルダ名・アイコン | フォルダ展開/折りたたみ |
| Chevronアイコン      | フォルダ展開/折りたたみ |

### 4.3 UI-003: 状態遷移のフィードバック

| 項目   | 内容                                     |
| ------ | ---------------------------------------- |
| ID     | UI-003                                   |
| 名称   | 状態遷移のフィードバック                 |
| 説明   | 選択状態の変化が即座に視覚的に反映される |
| 優先度 | **Should（推奨）**                       |

**要件:**

- チェックボックスの状態変化は遅延なく反映
- SelectedFilesPanelの選択ファイル一覧も即座に更新
- 選択数のカウンター（ある場合）も即座に更新

---

## 5. ユースケース

### 5.1 UC-001: フォルダを一括選択する

**アクター:** エンドユーザー

**事前条件:**

- WorkspaceFileSelectorが表示されている
- 対象フォルダにファイルが1つ以上存在する
- 対象フォルダのファイルは未選択状態

**基本フロー:**

1. ユーザーがフォルダのチェックボックスをクリック
2. システムが配下の全ファイルを取得
3. システムが各ファイルを選択状態に変更
4. チェックボックスが「selected」状態に変化
5. SelectedFilesPanelに選択ファイルが表示

**代替フロー:**

- **A1**: フォルダが空の場合
  1. システムは何も選択しない
  2. チェックボックスは「unselected」状態のまま

- **A2**: 一部ファイルがallowedExtensionsフィルターで除外される場合
  1. システムはフィルターを通過したファイルのみ選択
  2. 全ファイルが除外された場合、チェックボックスは「unselected」状態のまま

**事後条件:**

- 対象フォルダ配下の全ファイル（フィルター通過分）が選択状態
- フォルダのチェックボックスは「selected」状態

### 5.2 UC-002: フォルダを一括解除する

**アクター:** エンドユーザー

**事前条件:**

- WorkspaceFileSelectorが表示されている
- 対象フォルダ配下の全ファイルが選択状態
- フォルダのチェックボックスは「selected」状態

**基本フロー:**

1. ユーザーがフォルダのチェックボックスをクリック
2. システムが配下の全ファイルを取得
3. システムが各ファイルを選択解除
4. チェックボックスが「unselected」状態に変化
5. SelectedFilesPanelから選択ファイルが削除

**事後条件:**

- 対象フォルダ配下の全ファイルが未選択状態
- フォルダのチェックボックスは「unselected」状態

### 5.3 UC-003: 部分選択状態から全選択に変更する

**アクター:** エンドユーザー

**事前条件:**

- 対象フォルダ配下のファイルが一部のみ選択状態
- フォルダのチェックボックスは「indeterminate」状態

**基本フロー:**

1. ユーザーがフォルダのチェックボックスをクリック
2. システムが未選択のファイルを特定
3. システムが未選択ファイルを選択状態に変更
4. チェックボックスが「selected」状態に変化

**事後条件:**

- 対象フォルダ配下の全ファイルが選択状態
- フォルダのチェックボックスは「selected」状態

---

## 6. 受け入れ基準（Acceptance Criteria）

### 6.1 AC-001: フォルダ一括選択

```gherkin
Scenario: フォルダをクリックして配下ファイルを一括選択する
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" 配下に3つのファイルが存在する
    And いずれのファイルも選択されていない
  When ユーザーがフォルダ "project" のチェックボックスをクリックする
  Then 3つのファイルすべてが選択状態になる
    And フォルダ "project" のチェックボックスは "selected" 状態になる
    And SelectedFilesPanelに3つのファイルが表示される
```

### 6.2 AC-002: フォルダ一括解除

```gherkin
Scenario: 選択済みフォルダをクリックして配下ファイルを一括解除する
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" 配下の全3ファイルが選択状態
    And フォルダ "project" のチェックボックスは "selected" 状態
  When ユーザーがフォルダ "project" のチェックボックスをクリックする
  Then 3つのファイルすべてが未選択状態になる
    And フォルダ "project" のチェックボックスは "unselected" 状態になる
    And SelectedFilesPanelからファイルが削除される
```

### 6.3 AC-003: 部分選択状態の表示

```gherkin
Scenario: 一部ファイルのみ選択時にindeterminate状態を表示する
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" 配下に3つのファイルが存在する
  When ユーザーが1つのファイルのみを個別選択する
  Then フォルダ "project" のチェックボックスは "indeterminate" 状態になる
    And チェックボックスの aria-checked 属性が "mixed" になる
```

### 6.4 AC-004: 部分選択状態から全選択への遷移

```gherkin
Scenario: indeterminate状態のフォルダをクリックして全選択にする
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" 配下に3つのファイルが存在する
    And 1つのファイルのみが選択状態（indeterminate）
  When ユーザーがフォルダ "project" のチェックボックスをクリックする
  Then 3つのファイルすべてが選択状態になる
    And フォルダ "project" のチェックボックスは "selected" 状態になる
```

### 6.5 AC-005: ネストフォルダの一括選択

```gherkin
Scenario: 親フォルダの選択が子孫フォルダのファイルにも適用される
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "parent" 配下に以下の構造がある:
      | parent/file1.txt           |
      | parent/child/file2.txt     |
      | parent/child/grandchild/file3.txt |
  When ユーザーがフォルダ "parent" のチェックボックスをクリックする
  Then 3つのファイルすべて（file1.txt, file2.txt, file3.txt）が選択状態になる
    And フォルダ "parent" のチェックボックスは "selected" 状態になる
```

### 6.6 AC-006: 空フォルダの選択

```gherkin
Scenario: 空フォルダをクリックしてもエラーにならない
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "empty" は空である
  When ユーザーがフォルダ "empty" のチェックボックスをクリックする
  Then エラーが発生しない
    And フォルダ "empty" のチェックボックスは "unselected" 状態のままである
```

### 6.7 AC-007: 個別選択との共存

```gherkin
Scenario: 一括選択後に個別ファイルを解除できる
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" 配下の全3ファイルが選択状態
  When ユーザーが1つのファイルを個別に解除する
  Then 2つのファイルが選択状態になる
    And フォルダ "project" のチェックボックスは "indeterminate" 状態になる
```

### 6.8 AC-008: キーボード操作

```gherkin
Scenario: キーボードでフォルダを一括選択できる
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" にフォーカスがある
    And フォルダ "project" 配下のファイルは未選択状態
  When ユーザーがSpaceキーを押下する
  Then フォルダ "project" 配下の全ファイルが選択状態になる
```

### 6.9 AC-009: アクセシビリティ（ARIA属性）

```gherkin
Scenario: indeterminate状態でaria-checked="mixed"が設定される
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "project" がindeterminate状態である
  Then フォルダ "project" のチェックボックスに aria-checked="mixed" が設定される
```

### 6.10 AC-010: パフォーマンス

```gherkin
Scenario: 大量ファイルの一括選択が高速に完了する
  Given WorkspaceFileSelectorが表示されている
    And フォルダ "large" 配下に1000ファイルが存在する
  When ユーザーがフォルダ "large" のチェックボックスをクリックする
  Then 200ms以内に全ファイルが選択状態になる
```

---

## 7. 用語集

| 用語                  | 定義                                                                  |
| --------------------- | --------------------------------------------------------------------- |
| フォルダ一括選択      | フォルダをクリックして配下の全ファイルを選択する機能                  |
| indeterminate状態     | 部分選択状態。配下ファイルの一部のみが選択されている状態              |
| selected状態          | 全選択状態。配下ファイルの全てが選択されている状態                    |
| unselected状態        | 未選択状態。配下ファイルが1つも選択されていない状態                   |
| toggleFolder          | フォルダの選択状態を切り替える関数                                    |
| getSelectionState     | フォルダの選択状態（unselected/indeterminate/selected）を計算する関数 |
| getAllFilesInFolder   | フォルダ配下の全ファイルを再帰的に取得するヘルパー関数                |
| WorkspaceFileSelector | ワークスペースのファイルを選択するためのUIコンポーネント              |

---

## 8. アーキテクチャ制約

### 8.1 Clean Architecture準拠

| 項目         | 制約                                              |
| ------------ | ------------------------------------------------- |
| 依存方向     | 外→内（UI → Hooks → Types）                       |
| レイヤー分離 | `useWorkspaceFileSelection`フックにロジックを集約 |
| 機能間依存   | 他機能（features/）への依存禁止                   |
| 共通インフラ | 共通型は`types.ts`に定義                          |

### 8.2 TDD必須

| 項目       | 制約                                                 |
| ---------- | ---------------------------------------------------- |
| 順序       | 仕様書 → テスト → 実装（Red-Green-Refactorサイクル） |
| カバレッジ | 新規関数は80%以上のテストカバレッジ必須              |
| テスト種別 | ユニットテスト必須、統合テストは任意                 |

### 8.3 技術スタック制約

| 項目             | 制約                                          |
| ---------------- | --------------------------------------------- |
| フレームワーク   | React 19.x                                    |
| 状態管理         | React Hooks（useState, useCallback, useMemo） |
| 型システム       | TypeScript 5.x、厳格モード                    |
| テスト           | Vitest、React Testing Library                 |
| プラットフォーム | Electron（Chromiumベース）                    |

---

## 9. 依存関係

### 9.1 先行タスク

なし（本タスクが最初のPhase）

### 9.2 後続タスク

| タスクID | タスク名                                | 依存内容                           |
| -------- | --------------------------------------- | ---------------------------------- |
| T-01-1   | データ構造・アルゴリズム設計            | 本要件定義に基づきアルゴリズム設計 |
| T-01-2   | UI設計（チェックボックスindeterminate） | 本要件定義に基づきUI設計           |

---

## 10. 品質検証

### 10.1 要件品質スコア

| 指標         | 目標値 | 現在値 | 状態 |
| ------------ | ------ | ------ | ---- |
| 明確性       | 90%    | -      | -    |
| 完全性       | 85%    | -      | -    |
| 一貫性       | 100%   | -      | -    |
| 検証可能性   | 100%   | -      | -    |
| 曖昧性スコア | 0%     | -      | -    |

### 10.2 検証チェックリスト

- [ ] 全ての機能要件（FR）にIDと優先度が付与されている
- [ ] 全ての非機能要件（NFR）に測定可能な基準がある
- [ ] 全ての受け入れ基準がGiven-When-Then形式である
- [ ] スコープ（含む/含まない）が明確に定義されている
- [ ] 用語集に必要な用語が全て定義されている
- [ ] 依存関係が明記されている
- [ ] アーキテクチャ制約が明記されている

---

## 11. 更新履歴

| バージョン | 日付       | 更新者       | 更新内容 |
| ---------- | ---------- | ------------ | -------- |
| 1.0.0      | 2025-12-18 | @req-analyst | 初版作成 |
