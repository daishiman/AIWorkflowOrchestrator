# 認証UI改善タスク - タスク指示書

## メタ情報

| 項目             | 内容                      |
| ---------------- | ------------------------- |
| タスクID         | AUTH-UI-001               |
| タスク名         | 認証UI改善タスク          |
| 分類             | バグ修正/改善             |
| 対象機能         | AccountSection, AuthGuard |
| 優先度           | 高                        |
| 見積もり規模     | 中規模                    |
| ステータス       | 完了                      |
| 発見元           | Phase 5.5 最終レビュー    |
| 発見日           | 2025-12-10                |
| 発見エージェント | ユーザーフィードバック    |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

認証機能（login-only-auth）の実装完了後、実際の動作確認で以下の問題が報告された。

### 1.2 問題点・課題

#### 問題1: z-index問題

- **現象**: ホバーやクリックで表示されるメニュー・ツールチップが他の要素に隠れて見えない
- **影響箇所**: アバター編集メニュー、ツールチップなど
- **現状の対応**: アバターメニューはz-50、確認ダイアログはz-[100]に設定済み

#### 問題2: 名前変更時のデータベースエラー

- **現象**: 名前を変更して保存すると「Could not find the table 'public.user_profiles' in the schema cache」エラーが発生
- **原因**: Supabaseデータベースに`user_profiles`テーブルが存在しない
- **現状の対応**: user_metadataへのフォールバック処理を追加済みだが、動作していない可能性

#### 問題3: 連携サービス解除後のUI更新問題

- **現象**: 連携サービスを解除しても表示が「解除済み」に変わらない
- **確認事項**:
  - データベース側で本当に解除されているか
  - バックエンドとの連携が正しく機能しているか
- **現状の対応**:
  - `unlinkProvider`成功後に`fetchLinkedProviders()`を呼び出すよう修正済み
  - profileHandlers.tsで解除成功後に最新のユーザー情報を取得して通知するよう修正済み

### 1.3 放置した場合の影響

- ユーザーがプロフィール編集機能を使用できない
- 連携サービスの管理が正しく行えない
- ユーザー体験が著しく低下する

---

## 2. 何を達成するか（What）

### 2.1 目的

報告された3つの問題を完全に解決し、認証UIが正しく動作することを確認する。

### 2.2 最終ゴール

1. ホバー/クリックで表示される要素が常に最前面に表示される
2. 名前変更が正しく保存される（エラーなし）
3. 連携サービス解除後にUIが即座に更新される

### 2.3 スコープ

#### 含むもの

- AccountSectionコンポーネントのUI修正
- profileHandlers.tsのバックエンド処理確認・修正
- authSlice.tsの状態管理確認・修正
- 実機での動作確認

#### 含まないもの

- 新機能の追加
- 他のコンポーネントの修正

### 2.4 成果物

- 修正されたソースコード
- 動作確認結果

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- Supabaseプロジェクトが設定済み
- 開発環境が構築済み

### 3.2 依存タスク

- なし（独立したバグ修正タスク）

### 3.3 必要な知識・スキル

- React/TypeScript
- Zustand状態管理
- Electron IPC通信
- Supabase Auth API

### 3.4 推奨アプローチ

1. 各問題を個別に調査・修正
2. 実機での動作確認を重視
3. コンソールログを活用してデバッグ

---

## 4. 実行手順

### Phase 1: 問題の詳細調査

#### 目的

各問題の根本原因を特定する

#### 実行手順

1. アプリを起動してDevToolsを開く
2. 各操作を実行してコンソールログを確認
3. ネットワークタブでAPIリクエスト/レスポンスを確認
4. Supabaseダッシュボードでデータ状態を確認

#### 調査項目

- [ ] z-index問題: どの要素が重なっているか特定
- [ ] 名前変更: IPCレスポンスの内容確認
- [ ] 連携解除: Supabaseのidentitiesが実際に削除されているか確認

---

### Phase 2: z-index問題の修正

#### 目的

ポップアップメニュー、ツールチップが常に最前面に表示されるようにする

#### 確認箇所

- `AccountSection/index.tsx` のアバターメニュー（現在z-50）
- 確認ダイアログ（現在z-[100]）
- 他にz-indexを設定している箇所

#### 修正方針

1. アプリ全体のz-index階層を定義
2. ポップアップ系は高いz-index値（z-[9999]など）を使用
3. 他のコンポーネントとの競合を確認

---

### Phase 3: 名前変更エラーの修正

#### 目的

名前変更が正しく保存されるようにする

#### 確認箇所

- `profileHandlers.ts` のフォールバック処理
- `authSlice.ts` の`updateProfile`関数
- Supabase Auth APIの`updateUser`呼び出し

#### 修正方針

1. フォールバック処理が正しくトリガーされているか確認
2. エラーメッセージの検出条件を見直し
3. user_metadataの更新が成功しているか確認

---

### Phase 4: 連携解除UI更新問題の修正

#### 目的

連携解除後にUIが即座に更新されるようにする

#### 確認箇所

- `profileHandlers.ts` の`PROFILE_UNLINK_PROVIDER`ハンドラー
- `authSlice.ts` の`unlinkProvider`関数
- `authSlice.ts` の`fetchLinkedProviders`関数

#### 修正方針

1. Supabaseの`unlinkIdentity`が成功しているか確認
2. 成功後の状態更新が正しく行われているか確認
3. AUTH_STATE_CHANGEDイベントが正しく送信されているか確認

---

### Phase 5: 動作確認

#### 確認項目

- [ ] アバター編集メニューが正しく表示される
- [ ] 名前を変更して保存できる
- [ ] 連携サービスを解除するとUIが即座に更新される
- [ ] エラーメッセージが日本語で表示される

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] ポップアップメニューが他の要素に隠れない
- [ ] 名前変更がエラーなく完了する
- [ ] 連携解除後にUIが即座に更新される

### 品質要件

- [ ] 全テスト（1245件）が通過
- [ ] TypeScript型チェックが通過
- [ ] Lintエラーなし

### ドキュメント要件

- [ ] 修正内容を記録

---

## 6. 検証方法

### テストケース

1. アバターアイコンをクリック→編集メニューが最前面に表示される
2. 名前を「テスト」に変更→保存→エラーなしで反映される
3. GitHubとの連携を解除→即座に「連携する」ボタンに変わる

### 検証手順

1. `pnpm --filter @repo/desktop dev` でアプリを起動
2. ログイン
3. 各機能を手動で確認

---

## 7. リスクと対策

| リスク             | 影響度 | 発生確率 | 対策                          |
| ------------------ | ------ | -------- | ----------------------------- |
| Supabaseの仕様変更 | 中     | 低       | 公式ドキュメントを確認        |
| z-index競合        | 低     | 中       | グローバルなz-index階層を定義 |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/30-workflows/login-only-auth/`
- `apps/desktop/src/renderer/components/organisms/AccountSection/`
- `apps/desktop/src/main/ipc/profileHandlers.ts`
- `apps/desktop/src/renderer/store/slices/authSlice.ts`

### 関連ファイル

- `apps/desktop/src/renderer/components/organisms/AccountSection/index.tsx`
- `apps/desktop/src/main/ipc/profileHandlers.ts`
- `apps/desktop/src/main/ipc/avatarHandlers.ts`
- `apps/desktop/src/renderer/store/slices/authSlice.ts`

---

## 9. 備考

### ユーザーからの報告（原文）

```
- ホバーしたりクリックしたりして表示されるものに関しては、一番レイヤーが表側に来るようにしてください。じゃないと表示が見えないです。表示が隠れてしまっています。
- 名前を変更して保存するとエラーが出ます。「Could not find the table 'public.user_profiles' in the schema cache」
- 連携サービスを解除しても表示が解除済みに変わらないです。データベースの方はどうなっているか確認してください。本当に解除されているのか、バックエンドとの連携もどうなっているか確認しておいてください。
```

### 補足事項

- 現在のコードベースには修正が入っているが、実機では動作していないとの報告
- 実機でのデバッグ・確認が必要
