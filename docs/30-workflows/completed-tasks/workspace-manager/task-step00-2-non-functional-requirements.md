# ワークスペースマネージャー - 非機能要件定義書

## メタ情報

| 項目           | 内容         |
| -------------- | ------------ |
| ドキュメントID | NFR-WS-001   |
| バージョン     | 1.0.0        |
| 作成日         | 2025-12-11   |
| 作成者         | .claude/agents/req-analyst.md |
| ステータス     | ドラフト     |
| レビュー状態   | 未レビュー   |
| 関連文書       | FR-WS-001    |

---

## 1. 概要

### 1.1 目的

本ドキュメントは、ワークスペースマネージャー機能の非機能要件をFURPS+品質モデルに基づいて定義する。機能要件定義書（FR-WS-001）と合わせて、システムの品質特性を明確化し、実装・テストの基準を提供する。

### 1.2 スコープ

- パフォーマンス（Performance）
- セキュリティ（Security）
- 信頼性（Reliability）
- ユーザビリティ（Usability）
- 保守性（Supportability）
- 制約条件（Constraints）

### 1.3 品質特性マトリクス

| カテゴリ       | 要件数 | 重要度分布                              |
| -------------- | ------ | --------------------------------------- |
| パフォーマンス | 4      | Critical: 1, High: 2, Medium: 1         |
| セキュリティ   | 3      | Critical: 2, High: 1                    |
| 信頼性         | 3      | Critical: 1, High: 2                    |
| ユーザビリティ | 3      | High: 2, Medium: 1                      |
| 保守性         | 3      | High: 2, Medium: 1                      |
| 制約条件       | 2      | Critical: 1, High: 1                    |
| **合計**       | **18** | Critical: 5, High: 9, Medium: 4, Low: 0 |

---

## 2. パフォーマンス要件（Performance）

### NFR-001: ファイルツリー読み込み時間

| 項目     | 内容                                                  |
| -------- | ----------------------------------------------------- |
| ID       | NFR-001                                               |
| カテゴリ | パフォーマンス                                        |
| 指標     | フォルダ追加時のファイルツリー表示までの時間          |
| 目標値   | 1000ファイル以下: 1秒以内、10000ファイル以下: 3秒以内 |
| 測定方法 | Electron DevTools Performance タブによる計測          |
| 測定頻度 | 各リリース前                                          |
| 重要度   | **High**                                              |
| 根拠     | ユーザー体験調査で3秒超過で離脱率上昇                 |
| 関連要件 | FR-001, FR-003                                        |

**詳細要件**:

- ファイルツリーは遅延読み込み（Lazy Loading）を採用
- 初期表示は第1階層のみ、展開時に子要素を読み込む
- 10000ファイルを超えるフォルダには警告を表示

**受け入れ基準**:

```gherkin
Given: 1000ファイルを含むフォルダが存在する
When: ユーザーがそのフォルダをワークスペースに追加する
Then: ファイルツリーが1秒以内に表示される
```

---

### NFR-002: ファイル読み込み時間

| 項目     | 内容                                         |
| -------- | -------------------------------------------- |
| ID       | NFR-002                                      |
| カテゴリ | パフォーマンス                               |
| 指標     | ファイル選択からエディター表示までの時間     |
| 目標値   | 1MB以下: 500ms以内、10MB以下: 2秒以内        |
| 測定方法 | Electron DevTools Performance タブによる計測 |
| 測定頻度 | 各リリース前                                 |
| 重要度   | **High**                                     |
| 根拠     | エディター操作の応答性はUXに直結             |
| 関連要件 | FR-004                                       |

**詳細要件**:

- ファイル読み込みは非同期で実行
- 読み込み中はスケルトンローダーを表示
- 10MBを超えるファイルには警告を表示し、部分読み込みを提案

**受け入れ基準**:

```gherkin
Given: 500KBのTypeScriptファイルが存在する
When: ユーザーがそのファイルをクリックする
Then: エディターにファイル内容が500ms以内に表示される
  And: シンタックスハイライトが適用される
```

---

### NFR-003: ファイル保存時間

| 項目     | 内容                                     |
| -------- | ---------------------------------------- |
| ID       | NFR-003                                  |
| カテゴリ | パフォーマンス                           |
| 指標     | 保存コマンド実行から完了までの時間       |
| 目標値   | 1MB以下: 300ms以内                       |
| 測定方法 | IPC通信のラウンドトリップタイム計測      |
| 測定頻度 | 各リリース前                             |
| 重要度   | **Critical**                             |
| 根拠     | 保存操作の遅延はユーザーの作業効率に影響 |
| 関連要件 | FR-006                                   |

**詳細要件**:

- 保存は即座に開始され、バックグラウンドで完了
- 保存完了までUI操作はブロックしない
- 保存失敗時は即座にエラー通知

**受け入れ基準**:

```gherkin
Given: 100KBのファイルがエディターで編集されている
When: ユーザーが Cmd+S を押す
Then: 保存が300ms以内に完了する
  And: 保存中もエディター操作が可能である
```

---

### NFR-004: メモリ使用量

| 項目     | 内容                                        |
| -------- | ------------------------------------------- |
| ID       | NFR-004                                     |
| カテゴリ | パフォーマンス                              |
| 指標     | ワークスペースマネージャーのメモリ使用量    |
| 目標値   | ベースライン +200MB以内（10フォルダ追加時） |
| 測定方法 | Electron DevTools Memory タブによる計測     |
| 測定頻度 | 各リリース前                                |
| 重要度   | **Medium**                                  |
| 根拠     | Electronアプリのメモリ効率は重要            |
| 関連要件 | FR-001, FR-009                              |

**詳細要件**:

- 開いていないファイルの内容はメモリに保持しない
- ファイルツリーは最小限のメタデータのみ保持
- 長時間使用でのメモリリークがないこと

**受け入れ基準**:

```gherkin
Given: アプリが起動直後の状態
When: 10個のフォルダ（各1000ファイル）を追加する
Then: メモリ使用量の増加は200MB以内である
  And: 24時間経過後もメモリ使用量が安定している
```

---

## 3. セキュリティ要件（Security）

### NFR-005: ファイルシステムアクセス制御

| 項目     | 内容                                               |
| -------- | -------------------------------------------------- |
| ID       | NFR-005                                            |
| カテゴリ | セキュリティ                                       |
| 指標     | ファイルシステムアクセスの安全性                   |
| 目標値   | ユーザーが明示的に選択したフォルダのみアクセス可能 |
| 測定方法 | セキュリティレビュー、ペネトレーションテスト       |
| 測定頻度 | 各リリース前                                       |
| 重要度   | **Critical**                                       |
| 根拠     | 任意のファイルアクセスはセキュリティリスク         |
| 関連要件 | FR-001, FR-004, FR-006                             |

**詳細要件**:

- Renderer プロセスから直接ファイルシステムにアクセスしない
- すべてのファイル操作は Main プロセス経由の IPC 通信で実行
- アクセス可能なパスはワークスペースに登録されたフォルダに限定
- パストラバーサル攻撃（`../`）を防止

**受け入れ基準**:

```gherkin
Given: ワークスペースに /Users/user/projects が追加されている
When: Renderer プロセスが /Users/user/.ssh/id_rsa へのアクセスを試みる
Then: アクセスが拒否される
  And: エラーログが記録される
```

---

### NFR-006: IPC通信のセキュリティ

| 項目     | 内容                                        |
| -------- | ------------------------------------------- |
| ID       | NFR-006                                     |
| カテゴリ | セキュリティ                                |
| 指標     | IPC通信チャネルの安全性                     |
| 目標値   | contextBridge による安全な API 公開のみ     |
| 測定方法 | コードレビュー、Electron Security Checklist |
| 測定頻度 | 各リリース前                                |
| 重要度   | **Critical**                                |
| 根拠     | Electron公式セキュリティガイドライン準拠    |
| 関連要件 | FR-001, FR-004, FR-006                      |

**詳細要件**:

- `nodeIntegration: false` を維持
- `contextIsolation: true` を維持
- `contextBridge.exposeInMainWorld()` で最小限の API のみ公開
- IPC チャネル名は定数として管理し、動的生成を禁止

**受け入れ基準**:

```gherkin
Given: Renderer プロセスが実行中
When: window オブジェクトを検査する
Then: 公開された API のみがアクセス可能
  And: Node.js API（require, fs等）は利用不可
```

---

### NFR-007: 入力バリデーション

| 項目     | 内容                                       |
| -------- | ------------------------------------------ |
| ID       | NFR-007                                    |
| カテゴリ | セキュリティ                               |
| 指標     | ユーザー入力とファイルパスのバリデーション |
| 目標値   | すべての入力に対してバリデーション実施     |
| 測定方法 | コードレビュー、セキュリティテスト         |
| 測定頻度 | 各リリース前                               |
| 重要度   | **High**                                   |
| 根拠     | インジェクション攻撃の防止                 |
| 関連要件 | FR-001, FR-006                             |

**詳細要件**:

- ファイルパスは正規化してからバリデーション
- パス区切り文字の統一（macOS: `/`）
- 許可されたファイル拡張子のホワイトリスト検証
- Zodスキーマによる型安全なバリデーション

**受け入れ基準**:

```gherkin
Given: ユーザーがファイルを保存しようとしている
When: ファイルパスに "../../../etc/passwd" が含まれる
Then: パスが正規化され、ワークスペース外へのアクセスが拒否される
```

---

## 4. 信頼性要件（Reliability）

### NFR-008: 状態永続化の整合性

| 項目     | 内容                                 |
| -------- | ------------------------------------ |
| ID       | NFR-008                              |
| カテゴリ | 信頼性                               |
| 指標     | ワークスペース状態の永続化成功率     |
| 目標値   | 99.9%（1000回の保存で1回以下の失敗） |
| 測定方法 | ユニットテスト、統合テスト           |
| 測定頻度 | 各リリース前                         |
| 重要度   | **High**                             |
| 根拠     | 状態損失はユーザー体験を大きく損なう |
| 関連要件 | FR-007, FR-008                       |

**詳細要件**:

- 保存前に現在の状態をバックアップ
- 書き込み失敗時は前回の状態を復元
- JSON パースエラー時はデフォルト状態にフォールバック
- 状態ファイルの破損検知（チェックサム）

**受け入れ基準**:

```gherkin
Given: ワークスペースに5つのフォルダが追加されている
When: 状態保存中にアプリが強制終了する
Then: 次回起動時に前回保存された状態が復元される
  Or: 状態ファイルが破損している場合はデフォルト状態で起動し、ユーザーに通知される
```

---

### NFR-009: エラーリカバリー

| 項目     | 内容                                                   |
| -------- | ------------------------------------------------------ |
| ID       | NFR-009                                                |
| カテゴリ | 信頼性                                                 |
| 指標     | エラー発生時の復旧能力                                 |
| 目標値   | ユーザー操作を中断させないグレースフルデグラデーション |
| 測定方法 | 異常系テスト、カオスエンジニアリング                   |
| 測定頻度 | 各リリース前                                           |
| 重要度   | **High**                                               |
| 根拠     | 単一のエラーがアプリ全体をクラッシュさせてはならない   |
| 関連要件 | FR-004, FR-006                                         |

**詳細要件**:

- ファイル読み込みエラーは該当ファイルのみに影響
- ファイル保存エラーは明確なメッセージと再試行オプションを提供
- IPC 通信エラーは自動リトライ（3回、指数バックオフ）
- 予期せぬエラーはエラーバウンダリーでキャッチ

**受け入れ基準**:

```gherkin
Given: ワークスペースに複数のフォルダが追加されている
When: 1つのフォルダへのアクセス権限が失われる
Then: そのフォルダに警告アイコンが表示される
  And: 他のフォルダは正常に操作可能
  And: ユーザーにエラーの詳細と対処法が通知される
```

---

### NFR-010: データ整合性

| 項目     | 内容                                             |
| -------- | ------------------------------------------------ |
| ID       | NFR-010                                          |
| カテゴリ | 信頼性                                           |
| 指標     | ファイル編集・保存時のデータ整合性               |
| 目標値   | データ損失・破損ゼロ                             |
| 測定方法 | 統合テスト、ハッシュ比較テスト                   |
| 測定頻度 | 各リリース前                                     |
| 重要度   | **Critical**                                     |
| 根拠     | ユーザーのファイルを破損させることは許容されない |
| 関連要件 | FR-005, FR-006                                   |

**詳細要件**:

- 保存前後のファイル内容のハッシュ検証
- 部分書き込みの防止（アトミック書き込み）
- 文字エンコーディングの一貫性（UTF-8）
- 改行コードの保持（元のファイルの改行コードを維持）

**受け入れ基準**:

```gherkin
Given: UTF-8エンコーディングのファイルが開かれている
  And: 改行コードは LF である
When: ユーザーが内容を編集して保存する
Then: エンコーディングはUTF-8のまま保持される
  And: 改行コードは LF のまま保持される
  And: 保存されたファイルの内容がエディターの内容と一致する
```

---

## 5. ユーザビリティ要件（Usability）

### NFR-011: 操作の直感性

| 項目     | 内容                                     |
| -------- | ---------------------------------------- |
| ID       | NFR-011                                  |
| カテゴリ | ユーザビリティ                           |
| 指標     | 操作の習得しやすさ                       |
| 目標値   | 基本操作を5分以内に習得可能              |
| 測定方法 | ユーザーテスト、タスク完了時間測定       |
| 測定頻度 | メジャーリリース前                       |
| 重要度   | **High**                                 |
| 根拠     | VSCode等の既存エディターと同様のUXを期待 |
| 関連要件 | FR-001, FR-003, FR-004                   |

**詳細要件**:

- VSCode/Finder と同様の操作パターンを採用
- フォルダ追加: クリック操作のみで完結
- ファイル操作: ダブルクリックで開く、シングルクリックでプレビュー
- コンテキストメニュー: 右クリックで表示
- ショートカット: Cmd+S（保存）、Cmd+O（開く）等

**受け入れ基準**:

```gherkin
Given: ユーザーが初めてワークスペースマネージャーを使用する
When: 「フォルダを追加してファイルを編集・保存する」タスクを実行する
Then: 5分以内にタスクを完了できる
  And: ヘルプドキュメントを参照せずに完了できる
```

---

### NFR-012: フィードバックの明確性

| 項目     | 内容                                          |
| -------- | --------------------------------------------- |
| ID       | NFR-012                                       |
| カテゴリ | ユーザビリティ                                |
| 指標     | システム状態のフィードバック品質              |
| 目標値   | すべての操作に対して200ms以内のフィードバック |
| 測定方法 | ユーザーテスト、UI/UXレビュー                 |
| 測定頻度 | 各リリース前                                  |
| 重要度   | **High**                                      |
| 根拠     | ユーザーは操作の結果を即座に知る必要がある    |
| 関連要件 | FR-005, FR-006                                |

**詳細要件**:

- ローディング状態: スピナーまたはスケルトン表示
- 成功状態: トースト通知（3秒で自動消去）
- エラー状態: 赤色のトースト通知（手動消去）
- 未保存状態: タブに●インジケーター表示
- ホバー状態: ファイル名のハイライト

**受け入れ基準**:

```gherkin
Given: ユーザーがファイルを保存する
When: 保存が成功する
Then: 「保存しました」のトースト通知が200ms以内に表示される
  And: 未保存インジケーターが消える
```

---

### NFR-013: アクセシビリティ

| 項目     | 内容                                   |
| -------- | -------------------------------------- |
| ID       | NFR-013                                |
| カテゴリ | ユーザビリティ                         |
| 指標     | キーボード操作とスクリーンリーダー対応 |
| 目標値   | 基本操作がキーボードのみで完結可能     |
| 測定方法 | アクセシビリティ監査（axe-core）       |
| 測定頻度 | 各リリース前                           |
| 重要度   | **Medium**                             |
| 根拠     | アクセシビリティは基本的な品質要件     |
| 関連要件 | FR-013                                 |

**詳細要件**:

- Tab キーでフォーカス移動可能
- Enter/Space でアクション実行可能
- 矢印キーでツリーナビゲーション可能
- ARIA ラベルの適切な設定
- フォーカスリングの視認性確保

**受け入れ基準**:

```gherkin
Given: キーボードのみでアプリを操作する
When: ファイルを選択して開く操作を行う
Then: Tab と矢印キーでファイルを選択できる
  And: Enter キーでファイルを開ける
  And: フォーカスが視覚的に確認できる
```

---

## 6. 保守性要件（Supportability）

### NFR-014: コードカバレッジ

| 項目     | 内容                                           |
| -------- | ---------------------------------------------- |
| ID       | NFR-014                                        |
| カテゴリ | 保守性                                         |
| 指標     | ユニットテストのカバレッジ                     |
| 目標値   | 行カバレッジ 80% 以上、分岐カバレッジ 70% 以上 |
| 測定方法 | Vitest coverage レポート                       |
| 測定頻度 | 各プルリクエスト                               |
| 重要度   | **High**                                       |
| 根拠     | TDD 必須のプロジェクト方針                     |
| 関連要件 | すべての FR                                    |

**詳細要件**:

- 新規コードは必ずテストを伴う（TDD）
- クリティカルパス（保存、読み込み）は 90% 以上のカバレッジ
- E2E テストでユーザーフローをカバー

**受け入れ基準**:

```gherkin
Given: ワークスペースマネージャーの実装が完了している
When: テストスイートを実行する
Then: 行カバレッジが 80% 以上である
  And: 分岐カバレッジが 70% 以上である
```

---

### NFR-015: モジュール性

| 項目     | 内容                                 |
| -------- | ------------------------------------ |
| ID       | NFR-015                              |
| カテゴリ | 保守性                               |
| 指標     | コードの分離度と再利用性             |
| 目標値   | Clean Architecture 原則に準拠        |
| 測定方法 | アーキテクチャレビュー、依存関係分析 |
| 測定頻度 | 設計レビュー時                       |
| 重要度   | **High**                             |
| 根拠     | 長期的な保守コストの削減             |
| 関連要件 | すべての FR                          |

**詳細要件**:

- UI層、ビジネスロジック層、インフラ層の明確な分離
- 状態管理は Zustand スライスで分離
- IPC ハンドラーは単一責任の原則に従う
- 共通コンポーネントは再利用可能な形で設計

**受け入れ基準**:

```gherkin
Given: ワークスペースマネージャーの実装が完了している
When: ファイルツリー表示ロジックを変更する
Then: UI コンポーネントのみの変更で完結する
  And: IPC 通信やストア層に影響しない
```

---

### NFR-016: ログとデバッグ

| 項目     | 内容                                     |
| -------- | ---------------------------------------- |
| ID       | NFR-016                                  |
| カテゴリ | 保守性                                   |
| 指標     | デバッグとトラブルシューティングの容易さ |
| 目標値   | エラー発生時に原因特定が5分以内          |
| 測定方法 | インシデント対応訓練                     |
| 測定頻度 | 四半期ごと                               |
| 重要度   | **Medium**                               |
| 根拠     | 運用時の問題解決効率向上                 |
| 関連要件 | すべての FR                              |

**詳細要件**:

- エラーログにはスタックトレースと関連コンテキストを含む
- IPC 通信のリクエスト/レスポンスをログ出力（開発モード）
- ユーザー操作のタイムスタンプ付きログ
- ログレベルの動的切り替え（info, debug, error）

**受け入れ基準**:

```gherkin
Given: ファイル保存でエラーが発生した
When: ログを確認する
Then: エラーメッセージ、発生箇所、ファイルパス、タイムスタンプが記録されている
  And: 原因特定に必要な情報が揃っている
```

---

## 7. 制約条件（Constraints）

### NFR-017: 技術スタック制約

| 項目     | 内容                               |
| -------- | ---------------------------------- |
| ID       | NFR-017                            |
| カテゴリ | 制約条件                           |
| 指標     | 使用技術の制約                     |
| 目標値   | プロジェクト標準技術スタックに準拠 |
| 測定方法 | コードレビュー                     |
| 重要度   | **Critical**                       |
| 関連要件 | すべての FR                        |

**技術スタック**:

- フレームワーク: Electron + React
- 言語: TypeScript（strict mode）
- 状態管理: Zustand
- バリデーション: Zod
- テスト: Vitest（ユニット）、Playwright（E2E）
- パッケージマネージャー: pnpm

**禁止事項**:

- npm / yarn の使用禁止
- any 型の使用禁止（型安全性確保）
- eval() の使用禁止（セキュリティ）
- require() の Renderer プロセスでの使用禁止

---

### NFR-018: プラットフォーム制約

| 項目     | 内容                     |
| -------- | ------------------------ |
| ID       | NFR-018                  |
| カテゴリ | 制約条件                 |
| 指標     | 対応プラットフォーム     |
| 目標値   | macOS 12 (Monterey) 以降 |
| 測定方法 | 実機テスト               |
| 重要度   | **High**                 |
| 関連要件 | すべての FR              |

**詳細要件**:

- 対応 OS: macOS 12.0 以降
- アーキテクチャ: Apple Silicon (arm64) および Intel (x64)
- 将来的な Windows/Linux 対応を考慮した設計（パス処理の抽象化）

**受け入れ基準**:

```gherkin
Given: macOS 12 以降の環境
When: アプリケーションを起動する
Then: すべての機能が正常に動作する
  And: Apple Silicon と Intel 両方で動作する
```

---

## 8. 品質検証スコア

| 指標          | スコア | 目標 |
| ------------- | ------ | ---- |
| 定量化率      | 100%   | 100% |
| 測定可能性    | 100%   | 100% |
| 検証可能性    | 94%    | 90%  |
| 分類完全性    | 100%   | 100% |
| NFRカバレッジ | 95%    | 80%  |

---

## 9. NFR-FR トレーサビリティマトリクス

| NFR ID  | 関連 FR                | 品質特性       |
| ------- | ---------------------- | -------------- |
| NFR-001 | FR-001, FR-003         | パフォーマンス |
| NFR-002 | FR-004                 | パフォーマンス |
| NFR-003 | FR-006                 | パフォーマンス |
| NFR-004 | FR-001, FR-009         | パフォーマンス |
| NFR-005 | FR-001, FR-004, FR-006 | セキュリティ   |
| NFR-006 | FR-001, FR-004, FR-006 | セキュリティ   |
| NFR-007 | FR-001, FR-006         | セキュリティ   |
| NFR-008 | FR-007, FR-008         | 信頼性         |
| NFR-009 | FR-004, FR-006         | 信頼性         |
| NFR-010 | FR-005, FR-006         | 信頼性         |
| NFR-011 | FR-001, FR-003, FR-004 | ユーザビリティ |
| NFR-012 | FR-005, FR-006         | ユーザビリティ |
| NFR-013 | FR-013                 | ユーザビリティ |
| NFR-014 | すべて                 | 保守性         |
| NFR-015 | すべて                 | 保守性         |
| NFR-016 | すべて                 | 保守性         |
| NFR-017 | すべて                 | 制約条件       |
| NFR-018 | すべて                 | 制約条件       |

---

## 10. 次フェーズへの引き継ぎ事項

### 10.1 設計フェーズへの入力

- NFR に基づくアーキテクチャ制約の反映
- パフォーマンス目標に基づく設計判断
- セキュリティ要件に基づく IPC 設計

### 10.2 テストフェーズへの入力

- 各 NFR の受け入れ基準に基づくテストケース
- パフォーマンステストのシナリオ
- セキュリティテストの観点

### 10.3 オープンな課題

1. 大量ファイル（10万件以上）の取り扱い方針
2. ネットワークドライブへの対応可否
3. ファイル監視（変更検知）の実装方針

---

## 変更履歴

| バージョン | 日付       | 変更者       | 変更内容                           |
| ---------- | ---------- | ------------ | ---------------------------------- |
| 1.0.0      | 2025-12-11 | .claude/agents/req-analyst.md | 初版作成（18件の非機能要件を定義） |
