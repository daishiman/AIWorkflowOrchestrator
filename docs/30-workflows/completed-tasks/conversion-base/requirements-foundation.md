# ファイル変換基盤 - 要件定義書

## 1. 概要

### 1.1 目的

RAGシステムにおけるファイル変換処理の共通基盤を確立し、以下を実現する：

- 多様なファイル形式（テキスト、Markdown、PDF、画像等）の統一的な処理
- 拡張可能で保守性の高いコンバーターアーキテクチャの構築
- エラーハンドリングとパフォーマンス管理の一元化
- テスト容易性の確保

### 1.2 背景

現状の課題：

- 各コンバーターが独自実装されると、以下の問題が発生する：
  - エラーハンドリングの一貫性欠如
  - テストの困難さ
  - 新しいコンバーター追加時の学習コスト増大
  - パフォーマンス最適化の困難さ
  - コードの重複

共通基盤を構築することで：

- 実装の一貫性を確保
- 品質の標準化
- 開発効率の向上
- 保守コストの削減

### 1.3 スコープ

#### 含むもの

- コンバーターインターフェースの定義
- 抽象基底クラスの実装
- コンバーターレジストリの実装
- 変換サービスの実装
- メタデータ抽出ユーティリティの実装
- 単体テストの作成

#### 含まないもの

- 具体的なコンバーター実装（CONV-02-02, CONV-02-03で実装）
- UI層との統合
- データベースへの永続化
- 変換結果のキャッシュ機構（将来拡張）

---

## 2. 機能要件

### FR-1: コンバーターインターフェース

**要件ID**: FR-CONV-BASE-001
**優先度**: 必須

#### 説明

すべてのコンバーター実装が準拠すべき共通インターフェースを提供する。

#### 詳細要件

- **FR-1.1**: コンバーターIDと名称の識別子を持つこと
- **FR-1.2**: サポートするMIMEタイプのリストを提供すること
- **FR-1.3**: 優先度（priority）を設定可能にすること
- **FR-1.4**: 変換可能性の判定メソッド（`canConvert`）を提供すること
- **FR-1.5**: 変換実行メソッド（`convert`）を提供すること
- **FR-1.6**: 推定処理時間の取得メソッドを提供すること

#### 受け入れ基準

##### AC-FR-1.1: IConverterインターフェース定義

- **Given**: TypeScript 5.x環境とstrictモードが有効
- **When**: `packages/shared/src/services/conversion/types.ts`から`IConverter`をインポート
- **Then**: `id`, `name`, `supportedMimeTypes`, `priority`, `canConvert`, `convert`, `estimateProcessingTime`がすべて型定義されている

##### AC-FR-1.2: 型チェック成功

- **Given**: IConverterを実装したクラスが存在
- **When**: `pnpm --filter @repo/shared typecheck`を実行
- **Then**: 型エラーなしで成功する

##### AC-FR-1.3: 単体テスト存在

- **Given**: テストファイル`types.test.ts`が存在
- **When**: テストを実行
- **Then**: IConverterインターフェースの型定義テストがPASSする

---

### FR-2: 抽象コンバータークラス

**要件ID**: FR-CONV-BASE-002
**優先度**: 必須

#### 説明

コンバーター実装の共通処理を提供する抽象基底クラスを実装する。

#### 詳細要件

- **FR-2.1**: テンプレートメソッドパターンを適用すること
- **FR-2.2**: 前処理フック（`preprocess`）を提供すること
- **FR-2.3**: 後処理フック（`postprocess`）を提供すること
- **FR-2.4**: 実変換処理（`doConvert`）を抽象メソッドとすること
- **FR-2.5**: エラーハンドリングを共通化すること
- **FR-2.6**: 処理時間の計測を自動化すること
- **FR-2.7**: メタデータ取得メソッドを提供すること

#### 受け入れ基準

##### AC-FR-2.1: BaseConverterクラス実装

- **Given**: TypeScript環境
- **When**: `packages/shared/src/services/conversion/base-converter.ts`から`BaseConverter`をインポート
- **Then**: 抽象クラスとして定義され、IConverterを実装している

##### AC-FR-2.2: テンプレートメソッド動作

- **Given**: BaseConverterを継承したテスト用コンバーター
- **When**: `convert()`メソッドを呼び出す
- **Then**: preprocess → doConvert → postprocess の順で実行される

##### AC-FR-2.3: フック呼び出し

- **Given**: preprocess/postprocessをオーバーライドしたコンバーター
- **When**: `convert()`を実行
- **Then**: オーバーライドしたメソッドが呼び出される

##### AC-FR-2.4: エラーハンドリング

- **Given**: doConvert()で例外が発生
- **When**: `convert()`を実行
- **Then**: Result.errorとしてRAGErrorが返される（例外はスローされない）

##### AC-FR-2.5: 処理時間自動計測

- **Given**: 変換処理を実行
- **When**: `convert()`が完了
- **Then**: `ConverterOutput.processingTime`に実測値が設定されている

---

### FR-3: コンバーターレジストリ

**要件ID**: FR-CONV-BASE-003
**優先度**: 必須

#### 説明

利用可能なコンバーターを管理し、適切なコンバーターを選択する機能を提供する。

#### 詳細要件

- **FR-3.1**: コンバーターの登録機能を提供すること
- **FR-3.2**: コンバーターの登録解除機能を提供すること
- **FR-3.3**: IDによるコンバーター取得機能を提供すること
- **FR-3.4**: 入力に対する最適なコンバーター検索機能を提供すること
- **FR-3.5**: 優先度順でソートされた候補リストを返すこと
- **FR-3.6**: MIMEタイプによる検索機能を提供すること
- **FR-3.7**: サポートMIMEタイプ一覧の取得機能を提供すること
- **FR-3.8**: グローバルインスタンスを提供すること

#### 受け入れ基準

##### AC-FR-3.1: ConverterRegistryクラス実装

- **Given**: TypeScript環境
- **When**: `ConverterRegistry`をインポート
- **Then**: クラスが定義され、register/unregister/findConverterメソッドが存在

##### AC-FR-3.2: 登録・登録解除動作

- **Given**: コンバーターを登録
- **When**: 同じIDのコンバーターを登録解除
- **Then**: registry.sizeが0になる

##### AC-FR-3.3: 優先度順選択

- **Given**: 同じMIMEタイプで異なる優先度のコンバーター3つを登録
- **When**: findConverter()で検索
- **Then**: 最高優先度のコンバーターが返される

##### AC-FR-3.4: 未対応MIMEタイプエラー

- **Given**: 登録されていないMIMEタイプの入力
- **When**: findConverter()を実行
- **Then**: CONVERTER_NOT_FOUNDエラーが返される

##### AC-FR-3.5: グローバルインスタンス

- **Given**: アプリケーション起動
- **When**: `globalConverterRegistry`をインポート
- **Then**: シングルトンインスタンスが利用可能

---

### FR-4: 変換サービス

**要件ID**: FR-CONV-BASE-004
**優先度**: 必須

#### 説明

ファイル変換処理を統括し、タイムアウト・同時実行制御等の高度な機能を提供する。

#### 詳細要件

- **FR-4.1**: 単一ファイル変換機能を提供すること
- **FR-4.2**: バッチ変換機能を提供すること
- **FR-4.3**: タイムアウト機能を実装すること
- **FR-4.4**: 同時実行数制限機能を実装すること
- **FR-4.5**: 変換可能性の確認機能を提供すること
- **FR-4.6**: 推定処理時間の取得機能を提供すること
- **FR-4.7**: レジストリとの統合を実現すること

#### 受け入れ基準

##### AC-FR-4.1: ConversionServiceクラス実装

- **Given**: TypeScript環境とConverterRegistry
- **When**: `ConversionService`をインスタンス化
- **Then**: convert/convertBatch/canConvertメソッドが利用可能

##### AC-FR-4.2: 単一変換動作

- **Given**: 登録済みコンバーターとConverterInput
- **When**: convert()を実行
- **Then**: Result<ConverterOutput>が返される

##### AC-FR-4.3: バッチ変換の同時実行制限

- **Given**: maxConcurrentConversions=2、3件の入力
- **When**: convertBatch()を実行
- **Then**: 同時に実行されるのは最大2件まで

##### AC-FR-4.4: タイムアウト機能

- **Given**: 処理に10秒かかるモックコンバーター、timeout=100ms
- **When**: convert()を実行
- **Then**: 100ms後にTIMEOUTエラーが返される

##### AC-FR-4.5: 同時実行数超過エラー

- **Given**: maxConcurrentConversions=2、既に2件実行中
- **When**: 3件目のconvert()を実行
- **Then**: RESOURCE_EXHAUSTEDエラーが即座に返される

---

### FR-5: メタデータ抽出

**要件ID**: FR-CONV-BASE-005
**優先度**: 必須

#### 説明

テキストから各種メタデータを抽出するユーティリティを提供する。

#### 詳細要件

- **FR-5.1**: タイトル抽出機能を提供すること
- **FR-5.2**: 見出し抽出機能を提供すること
- **FR-5.3**: コードブロック数のカウント機能を提供すること
- **FR-5.4**: リンク抽出機能を提供すること
- **FR-5.5**: 言語検出機能を提供すること（簡易版）
- **FR-5.6**: 単語数・行数・文字数のカウント機能を提供すること

#### 受け入れ基準

##### AC-FR-5.1: MetadataExtractorクラス実装

- **Given**: TypeScript環境
- **When**: `MetadataExtractor`をインポート
- **Then**: すべてのstaticメソッド（extractTitle, extractHeaders, extractLinks等）が利用可能

##### AC-FR-5.2: タイトル抽出動作

- **Given**: "# Main Title"を含むテキスト
- **When**: extractTitle()を実行
- **Then**: "Main Title"が返される

##### AC-FR-5.3: 言語検出動作

- **Given**: 日本語文字を含むテキストと英語のみのテキスト
- **When**: それぞれでdetectLanguage()を実行
- **Then**: 日本語は"ja"、英語は"en"が返される

##### AC-FR-5.4: 見出し抽出動作

- **Given**: "# H1\n## H2\n### H3"を含むテキスト
- **When**: extractHeaders()を実行
- **Then**: 3つの見出しが level と text の配列として返される

---

## 3. 非機能要件

### NFR-1: パフォーマンス

**要件ID**: NFR-CONV-BASE-001
**優先度**: 高

#### 詳細要件

- **NFR-1.1**: 1KB あたり 1ms 以内の変換処理時間（デフォルト見積もり）
- **NFR-1.2**: タイムアウトのデフォルト値は 60秒
- **NFR-1.3**: 同時実行数のデフォルト値は 5
- **NFR-1.4**: バッチ処理時の効率的なリソース管理

#### 受け入れ基準

- [ ] パフォーマンステストが実施されている
- [ ] デフォルト設定での動作が確認されている
- [ ] メモリリークがない

---

### NFR-2: 拡張性

**要件ID**: NFR-CONV-BASE-002
**優先度**: 必須

#### 詳細要件

- **NFR-2.1**: 新しいコンバーターを簡単に追加できる設計
- **NFR-2.2**: プラグイン形式での拡張をサポート
- **NFR-2.3**: 既存コードの変更なしで機能追加可能
- **NFR-2.4**: カスタムオプションの追加が可能

#### 受け入れ基準

- [ ] 新規コンバーター追加の手順がドキュメント化されている
- [ ] サンプルコンバーター実装が存在する
- [ ] Open/Closed原則に準拠している

---

### NFR-3: 保守性

**要件ID**: NFR-CONV-BASE-003
**優先度**: 必須

#### 詳細要件

- **NFR-3.1**: コード品質: Lintエラーなし
- **NFR-3.2**: 型安全性: TypeScript strict モード準拠
- **NFR-3.3**: テストカバレッジ: 80%以上
- **NFR-3.4**: ドキュメント: 主要APIのドキュメント完備
- **NFR-3.5**: コーディング規約: Prettier/ESLint準拠

#### 受け入れ基準

- [ ] Lintエラーがゼロ
- [ ] 型エラーがゼロ
- [ ] テストカバレッジ80%以上達成
- [ ] API仕様書が存在する

---

### NFR-4: 信頼性

**要件ID**: NFR-CONV-BASE-004
**優先度**: 高

#### 詳細要件

- **NFR-4.1**: エラーハンドリング: 例外をResult型でラップ
- **NFR-4.2**: フェイルセーフ: 変換失敗時の適切なエラーメッセージ
- **NFR-4.3**: 入力検証: 不正な入力の検出と拒否
- **NFR-4.4**: リソース管理: メモリリークの防止

#### 受け入れ基準

- [ ] すべてのエラーがResult型で返される
- [ ] エラーメッセージが明確
- [ ] 異常系テストが網羅されている
- [ ] メモリリークテストが実施されている

---

### NFR-5: テスト容易性

**要件ID**: NFR-CONV-BASE-005
**優先度**: 必須

#### 詳細要件

- **NFR-5.1**: 依存性注入: レジストリをコンストラクタで受け取る
- **NFR-5.2**: モック可能: すべての依存関係がモック可能
- **NFR-5.3**: テストヘルパー: テスト用のユーティリティ提供
- **NFR-5.4**: テストデータ: サンプルデータの提供

#### 受け入れ基準

- [ ] 依存性注入が実装されている
- [ ] モックを使ったテストが存在する
- [ ] テストヘルパーが提供されている

---

## 4. 制約条件

### 4.1 技術的制約

- **TC-1**: TypeScript 5.x を使用すること
- **TC-2**: Node.js 18.x 以上で動作すること
- **TC-3**: pnpmパッケージマネージャーを使用すること
- **TC-4**: Vitest をテストフレームワークとして使用すること
- **TC-5**: クリーンアーキテクチャの原則に準拠すること

### 4.2 依存関係制約

- **DC-1**: CONV-01（ファイル選択機能）が完了していること
- **DC-2**: CONV-03-02（ファイル・変換スキーマ定義）が完了していること
- **DC-3**: packages/shared/src/types/rag/ に基本型定義が存在すること

---

## 5. 受け入れ基準（総合）

### 5.1 機能面

- [ ] すべての機能要件（FR-1 ~ FR-5）が実装されている
- [ ] すべての単体テストが成功する
- [ ] すべての統合テストが成功する（該当する場合）
- [ ] 手動テストが完了している

### 5.2 品質面

- [ ] テストカバレッジが80%以上
- [ ] Lintエラーがゼロ
- [ ] 型エラーがゼロ
- [ ] セキュリティスキャンで重大な脆弱性なし

### 5.3 ドキュメント面

- [ ] API仕様書が作成されている
- [ ] 使用例が提供されている
- [ ] システムドキュメントが更新されている

---

## 6. 依存タスクとの関係

### 6.1 前提タスク

| タスクID   | タスク名                   | 提供される成果物                       |
| ---------- | -------------------------- | -------------------------------------- |
| CONV-01    | ファイル選択機能           | ファイル選択UI・ファイルエンティティ   |
| CONV-03-02 | ファイル・変換スキーマ定義 | FileEntity、ConversionResult等の型定義 |

### 6.2 後続タスク

| タスクID   | タスク名                        | 本タスクの成果物を利用                       |
| ---------- | ------------------------------- | -------------------------------------------- |
| CONV-02-02 | テキスト系コンバーター実装      | BaseConverter、IConverter、ConverterRegistry |
| CONV-02-03 | Markdown/コードコンバーター実装 | BaseConverter、IConverter、ConverterRegistry |

---

## 7. リスクと対策

| リスク                           | 影響度 | 発生確率 | 対策                                   |
| -------------------------------- | ------ | -------- | -------------------------------------- |
| CONV-03-02の遅延による型定義不足 | 高     | 中       | 型定義を仮定して先行実装、後で調整     |
| パフォーマンス要件未達           | 中     | 低       | 早期プロファイリングとボトルネック特定 |
| テストカバレッジ不足             | 中     | 中       | Phase 3でテスト設計を十分に行う        |
| 抽象化の過度な複雑化             | 中     | 低       | シンプルさを優先、YAGNI原則を適用      |

---

## 8. 変更履歴

| 日付       | バージョン | 変更者 | 変更内容 |
| ---------- | ---------- | ------ | -------- |
| 2025-12-20 | 1.0.0      | AI     | 初版作成 |
