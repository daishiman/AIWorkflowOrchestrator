# アバター編集メニュー表示要件定義書

## ドキュメント情報

| 項目     | 内容                                  |
| -------- | ------------------------------------- |
| 文書ID   | REQ-AUTH-UI-002                       |
| 作成日   | 2025-12-20                            |
| 作成者   | @req-analyst                          |
| 対象機能 | AccountSection - アバター編集メニュー |
| 優先度   | MoSCoW: Must Have                     |

---

## 1. 概要

### 1.1 目的

本文書は、AccountSectionコンポーネントにおけるアバター編集メニューの表示要件とアクセシビリティ要件を定義し、実装およびテストの基準となる受け入れ条件を確立することを目的とする。

### 1.2 背景

AUTH-UI-001でz-index値を`z-[9999]`に修正したが、以下の技術的制約により問題が解決しなかった：

- **問題**: アバター編集メニューがProfile CardのGlassPanel内にある
- **原因**: GlassPanelコンポーネントが`backdrop-blur`を使用しており、これがCSSのスタッキングコンテキストを作成する
- **結果**: 子要素のz-indexは親GlassPanel内でしか効果を持たず、連携サービスセクション（別のGlassPanel）の下にメニューが隠れる
- **影響**: ユーザーがアバターメニュー内のボタン（アップロード、プロバイダーアバター使用、削除）をクリックできない

### 1.3 スコープ

#### スコープ内

- アバター編集メニューの表示位置要件
- メニュー操作の機能要件
- WCAG 2.1 AA準拠のアクセシビリティ要件
- 受け入れ基準の定義

#### スコープ外

- GlassPanelコンポーネント自体の修正
- 他のポップアップ・モーダル・メニューの修正
- 認証機能の変更

---

## 2. 用語集

| 用語                     | 定義                                                                                           |
| ------------------------ | ---------------------------------------------------------------------------------------------- |
| スタッキングコンテキスト | CSS要素がz軸方向に積み重なる際の独立した階層。backdrop-blur等の特定のCSS属性により作成される。 |
| Portal                   | ReactのcreatePortal APIを使用して、コンポーネントツリーとは別のDOM階層にレンダリングする機能。 |
| GlassPanel               | 本プロジェクトのUIコンポーネント。backdrop-blurを使用したすりガラス風のパネル。                |
| AccountSection           | ユーザーのアカウント情報表示・編集を行うコンポーネント。                                       |
| アバター編集メニュー     | アバター画像のアップロード・変更・削除を行うドロップダウンメニュー。                           |

---

## 3. 機能要件

### FR-001: メニュー表示位置

**優先度**: Must Have

**説明**: アバター編集メニューは、ページ内の他のすべての要素の上に表示されなければならない。

**詳細要件**:

- FR-001-1: メニューは連携サービスセクション（GlassPanel）の上に表示されること
- FR-001-2: メニューはアバター編集ボタンの直下（8px間隔）に配置されること
- FR-001-3: メニューは画面スクロールに影響されず、固定位置（fixed position）で表示されること
- FR-001-4: メニューの幅は48px（w-48）であること

**測定基準**:

- メニューのz-indexが他のGlassPanelより高い値を持つ
- `position: fixed`が適用されている
- `getBoundingClientRect()`で計算された位置に表示される

---

### FR-002: メニュー開閉動作

**優先度**: Must Have

**説明**: アバター編集メニューは、適切なユーザー操作によって開閉できなければならない。

**詳細要件**:

- FR-002-1: アバター編集ボタンをクリックするとメニューが開くこと
- FR-002-2: メニューが開いている状態でアバター編集ボタンをクリックするとメニューが閉じること
- FR-002-3: メニュー外の領域をクリックするとメニューが閉じること
- FR-002-4: メニュー内のアクションを実行するとメニューが閉じること

**測定基準**:

- `isAvatarMenuOpen`状態が正しく切り替わる
- `mousedown`イベントでメニュー外クリックが検出される

---

### FR-003: メニュー機能

**優先度**: Must Have

**説明**: アバター編集メニューは以下の機能を提供しなければならない。

**詳細要件**:

- FR-003-1: 「アップロード」ボタン - ローカルファイルからアバター画像をアップロード
- FR-003-2: プロバイダーアバター使用ボタン - 連携サービス（Google, GitHub, Discord）のアバターを使用
- FR-003-3: 「アバターを削除」ボタン - 現在のアバターを削除（アバターが設定されている場合のみ有効）

**測定基準**:

- 各ボタンがクリック可能であること
- 各ボタンが適切なハンドラーを呼び出すこと

---

## 4. 非機能要件

### NFR-001: アクセシビリティ - WCAG 2.1 AA準拠

**優先度**: Must Have

**説明**: アバター編集メニューはWCAG 2.1 AAレベルのアクセシビリティ基準を満たさなければならない。

**詳細要件**:

| ID        | 要件                       | WCAG基準                | 実装方法                                 |
| --------- | -------------------------- | ----------------------- | ---------------------------------------- |
| NFR-001-1 | キーボード操作可能         | 2.1.1 Keyboard          | Tabキーでフォーカス移動、Enterで選択     |
| NFR-001-2 | フォーカス可視             | 2.4.7 Focus Visible     | フォーカスインジケータの表示             |
| NFR-001-3 | 名前、役割、値の提供       | 4.1.2 Name, Role, Value | role="menu", role="menuitem", aria-label |
| NFR-001-4 | メニュー展開状態の通知     | 4.1.2 Name, Role, Value | aria-expanded属性の使用                  |
| NFR-001-5 | Escキーでメニューを閉じる  | 2.1.1 Keyboard          | keydownイベントハンドラー                |
| NFR-001-6 | 色のみに依存しない状態表示 | 1.4.1 Use of Color      | アイコン併用、テキスト表示               |

---

### NFR-002: パフォーマンス

**優先度**: Should Have

**説明**: メニューの表示・操作は遅延なく実行されなければならない。

**詳細要件**:

- NFR-002-1: メニュー表示までの遅延は50ms以下であること
- NFR-002-2: メニュー閉じるまでの遅延は50ms以下であること
- NFR-002-3: 位置計算によるレイアウトシフトが発生しないこと

---

### NFR-003: 視覚的一貫性

**優先度**: Should Have

**説明**: メニューのスタイルはプロジェクトのデザインシステムに準拠しなければならない。

**詳細要件**:

- NFR-003-1: 背景色は`var(--bg-secondary)`を使用
- NFR-003-2: ボーダーは`border-white/10`を使用
- NFR-003-3: 角丸は`rounded-lg`を使用
- NFR-003-4: ホバー時の背景色は`bg-white/10`を使用
- NFR-003-5: 削除ボタンは赤色（`text-red-400`）で表示

---

## 5. 受け入れ基準

### AC-001: メニュー表示位置

```gherkin
Feature: アバター編集メニューの表示位置

  Scenario: メニューが連携サービスセクションの上に表示される
    Given ユーザーがログイン済みである
    And AccountSectionが表示されている
    And 連携サービスセクションが表示されている
    When アバター編集ボタンをクリックする
    Then アバター編集メニューが表示される
    And メニューは連携サービスセクションの上に表示される
    And メニュー内のすべてのボタンがクリック可能である

  Scenario: メニューがアバターボタンの下に配置される
    Given ユーザーがログイン済みである
    When アバター編集ボタンをクリックする
    Then メニューはアバター編集ボタンの直下に表示される
    And メニューの上端とボタンの下端の間隔は8pxである
```

---

### AC-002: メニュー開閉動作

```gherkin
Feature: アバター編集メニューの開閉動作

  Scenario: メニューを開く
    Given ユーザーがログイン済みである
    And アバター編集メニューは閉じている
    When アバター編集ボタンをクリックする
    Then アバター編集メニューが表示される

  Scenario: メニューを閉じる（ボタンクリック）
    Given アバター編集メニューが開いている
    When アバター編集ボタンをクリックする
    Then アバター編集メニューが閉じる

  Scenario: メニューを閉じる（外部クリック）
    Given アバター編集メニューが開いている
    When メニュー外の領域をクリックする
    Then アバター編集メニューが閉じる

  Scenario: メニュー内アクション実行後に閉じる
    Given アバター編集メニューが開いている
    When 「アップロード」ボタンをクリックする
    Then ファイル選択が開始される
    And アバター編集メニューが閉じる
```

---

### AC-003: アクセシビリティ - キーボード操作

```gherkin
Feature: アバター編集メニューのキーボード操作

  Scenario: Tabキーでメニューボタンにフォーカス
    Given ユーザーがログイン済みである
    When Tabキーを押してアバター編集ボタンにフォーカスを移動する
    Then アバター編集ボタンにフォーカスインジケータが表示される

  Scenario: Enterキーでメニューを開く
    Given アバター編集ボタンにフォーカスがある
    When Enterキーを押す
    Then アバター編集メニューが表示される
    And メニューの最初の項目にフォーカスが移動する

  Scenario: Escキーでメニューを閉じる
    Given アバター編集メニューが開いている
    When Escキーを押す
    Then アバター編集メニューが閉じる
    And フォーカスがアバター編集ボタンに戻る

  Scenario: Tabキーでメニュー項目間を移動
    Given アバター編集メニューが開いている
    When Tabキーを押す
    Then 次のメニュー項目にフォーカスが移動する
```

---

### AC-004: ARIA属性

```gherkin
Feature: アバター編集メニューのARIA属性

  Scenario: メニューコンテナのrole属性
    Given アバター編集メニューが開いている
    Then メニューコンテナにrole="menu"が設定されている

  Scenario: メニュー項目のrole属性
    Given アバター編集メニューが開いている
    Then 各メニュー項目にrole="menuitem"が設定されている

  Scenario: アバター編集ボタンのaria-label
    Given ユーザーがログイン済みである
    Then アバター編集ボタンにaria-label="アバターを編集"が設定されている
```

---

### AC-005: 削除ボタンの状態

```gherkin
Feature: アバター削除ボタンの状態制御

  Scenario: アバターが設定されている場合
    Given ユーザーがログイン済みである
    And アバター画像が設定されている
    When アバター編集メニューを開く
    Then 「アバターを削除」ボタンは有効である
    And ボタンの色はtext-red-400である

  Scenario: アバターが設定されていない場合
    Given ユーザーがログイン済みである
    And アバター画像が設定されていない
    When アバター編集メニューを開く
    Then 「アバターを削除」ボタンは無効である
    And ボタンの色はtext-white/30である
```

---

## 6. 技術的制約

### 6.1 CSSスタッキングコンテキストの制約

以下のCSS属性は新しいスタッキングコンテキストを作成するため、子要素のz-indexがそのコンテキスト内でのみ有効になる：

- `position: fixed` または `position: sticky`
- `opacity` が1未満
- `transform` プロパティ
- `filter` プロパティ
- `backdrop-filter` プロパティ（GlassPanelで使用）

### 6.2 推奨される解決策

ReactのcreatePortalを使用して、メニューを`document.body`直下にレンダリングすることで、親要素のスタッキングコンテキストから脱出する。

```typescript
// 推奨実装パターン
import { createPortal } from "react-dom";

{isAvatarMenuOpen && menuPosition && createPortal(
  <div
    role="menu"
    className="fixed w-48 bg-[var(--bg-secondary)] border border-white/10 rounded-lg shadow-lg z-[9999]"
    style={{ top: menuPosition.top, left: menuPosition.left }}
  >
    {/* メニュー内容 */}
  </div>,
  document.body
)}
```

---

## 7. テスト可能性

### 7.1 ユニットテストで検証可能な要件

| 要件ID    | テスト方法                                                   |
| --------- | ------------------------------------------------------------ |
| FR-001    | `document.body.querySelector('[role="menu"]')`でPortal確認   |
| FR-002    | `userEvent.click()`でメニュー開閉をテスト                    |
| FR-003    | 各ボタンのクリックイベントと対応するハンドラーの呼び出し確認 |
| NFR-001-3 | `role="menu"`, `role="menuitem"`属性の存在確認               |

### 7.2 手動テストで検証すべき要件

| 要件ID    | テスト方法                                           |
| --------- | ---------------------------------------------------- |
| FR-001-1  | 視覚的に連携サービスセクションの上に表示されるか確認 |
| NFR-001-1 | キーボードのみでメニュー操作を完了できるか確認       |
| NFR-001-2 | フォーカスインジケータが視認できるか確認             |
| NFR-002   | メニュー表示の遅延を体感的に確認                     |

---

## 8. 参照情報

### 8.1 関連ドキュメント

- [タスク実行仕様書](./task-auth-ui-z-index-fix-specification.md)
- [React Portal公式ドキュメント](https://react.dev/reference/react-dom/createPortal)
- [CSS Stacking Context - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_positioned_layout/Understanding_z-index/Stacking_context)

### 8.2 アクセシビリティ参照

- [WCAG 2.1 Guidelines](https://www.w3.org/TR/WCAG21/)
- [WAI-ARIA Menu Pattern](https://www.w3.org/WAI/ARIA/apg/patterns/menu/)

### 8.3 関連ファイル

- `apps/desktop/src/renderer/components/organisms/AccountSection/index.tsx`
- `apps/desktop/src/renderer/components/organisms/GlassPanel/index.tsx`

---

## 9. 承認

| 役割           | 名前             | 日付                | 署名 |
| -------------- | ---------------- | ------------------- | ---- |
| 要件アナリスト | @req-analyst     | 2025-12-20          | ✓    |
| 設計レビュアー | @ui-designer     | _（Phase 2で記入）_ |      |
| QAレビュアー   | @frontend-tester | _（Phase 2で記入）_ |      |
