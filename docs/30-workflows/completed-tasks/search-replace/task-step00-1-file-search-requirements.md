# T-00-1: ファイル内検索要件定義書

## メタ情報

| 項目             | 内容                                                      |
| ---------------- | --------------------------------------------------------- |
| サブタスクID     | T-00-1                                                    |
| サブタスク名     | ファイル内検索要件定義                                    |
| 親タスクID       | TASK-SEARCH-REPLACE-001                                   |
| フェーズ         | Phase 0: 要件定義                                         |
| ステータス       | 完了                                                      |
| 担当エージェント | @req-analyst                                              |
| 作成日           | 2025-12-12                                                |
| 参照タスク仕様書 | `docs/30-workflows/search-replace/task-search-replace.md` |

---

## 1. 概要

### 1.1 目的

エディターで開いているファイル内でテキスト検索を行う機能の要件を定義する。本ドキュメントでは**検索機能のみ**を扱い、置換機能は T-00-2 で別途定義する。

### 1.2 背景

テキストエディターの基本機能として、ファイル内検索は必須である。現在、ファイル内での文字検索ができず、外部エディターを使用する必要がある。VS Code 等の標準的なエディターと同等の検索体験を提供する。

### 1.3 スコープ

#### 含むもの

- 単一ファイル内での文字列検索
- インクリメンタル検索（入力に応じたリアルタイム検索）
- 検索結果のハイライト表示
- 検索結果間のナビゲーション
- 検索オプション（大文字/小文字区別、正規表現、単語単位）
- 検索履歴

#### 含まないもの

- 置換機能（T-00-2 で定義）
- ワークスペース全体の検索（T-00-3 で定義）
- セマンティック検索（RAG機能で対応予定）
- シンボル検索（Go to Definition 等）

---

## 2. 機能要件（Functional Requirements）

### 2.1 FR-001: 検索パネルの表示・非表示

#### 要件ID: FR-001

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given エディターでファイルが開かれている状態で
When ユーザーが Cmd+F（macOS）または Ctrl+F（Windows/Linux）を押下する
Then 検索パネルがエディター上部に表示される
And 検索入力フィールドにフォーカスが移動する

Given 検索パネルが表示されている状態で
When ユーザーが Escape キーを押下する
Then 検索パネルが非表示になる
And フォーカスがエディターに戻る

Given 検索パネルが表示されている状態で
When ユーザーが Cmd+F / Ctrl+F を再度押下する
Then 検索入力フィールドのテキストが全選択される
```

**補足仕様**:

- 検索パネルの表示/非表示はアニメーション付き（200-300ms ease-in-out）
- エディター上部にオーバーレイ表示（エディターコンテンツを押し下げない）

---

### 2.2 FR-002: インクリメンタル検索

#### 要件ID: FR-002

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索パネルが表示されている状態で
When ユーザーが検索フィールドに文字を入力する
Then 入力に応じてリアルタイムで検索が実行される
And マッチした箇所がすべてハイライト表示される
And 最初のマッチ箇所にカーソルが移動する
And 検索結果数が「N/M」形式で表示される（N: 現在位置、M: 総数）

Given 検索フィールドに文字が入力されている状態で
When ユーザーが検索フィールドを空にする
Then すべてのハイライトが解除される
And 検索結果数の表示が「0件」になる
```

**補足仕様**:

- デバウンス: 150ms（高速タイピング時のパフォーマンス最適化）
- 最小検索文字数: 1文字以上

---

### 2.3 FR-003: 検索結果のハイライト表示

#### 要件ID: FR-003

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索文字列にマッチする箇所が存在する場合
When 検索が実行される
Then すべてのマッチ箇所が背景色でハイライト表示される
And 現在選択中のマッチ箇所は異なる強調色で表示される

Given 検索文字列にマッチする箇所が存在しない場合
When 検索が実行される
Then 検索フィールドに視覚的なエラー状態が表示される（赤枠など）
And 検索結果数が「0件」と表示される
```

**補足仕様**:

- 全マッチハイライト色: `bg-yellow-200/50`（ライト）/ `bg-yellow-500/30`（ダーク）
- 現在選択ハイライト色: `bg-orange-400/70`（ライト）/ `bg-orange-500/50`（ダーク）
- エラー状態: `border-red-500`

---

### 2.4 FR-004: 検索結果間のナビゲーション

#### 要件ID: FR-004

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が複数存在する状態で
When ユーザーが「次へ」ボタンをクリックするか F3 / Enter を押下する
Then カーソルが次のマッチ箇所に移動する
And 該当箇所がビューポート内に表示される（自動スクロール）
And 現在位置のカウンターが更新される

Given 検索結果が複数存在する状態で
When ユーザーが「前へ」ボタンをクリックするか Shift+F3 / Shift+Enter を押下する
Then カーソルが前のマッチ箇所に移動する
And 該当箇所がビューポート内に表示される（自動スクロール）
And 現在位置のカウンターが更新される

Given 最後のマッチ箇所が選択されている状態で
When ユーザーが「次へ」操作を行う
Then カーソルが最初のマッチ箇所に循環移動する

Given 最初のマッチ箇所が選択されている状態で
When ユーザーが「前へ」操作を行う
Then カーソルが最後のマッチ箇所に循環移動する
```

---

### 2.5 FR-005: 大文字/小文字区別オプション

#### 要件ID: FR-005

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索パネルが表示されている状態で
When ユーザーが「大文字/小文字を区別」オプションを有効にする
Then 検索が大文字/小文字を区別して実行される
And オプションボタンがアクティブ状態で表示される

Given 「大文字/小文字を区別」オプションが無効（デフォルト）の状態で
When ユーザーが "Test" を検索する
Then "test", "TEST", "Test" すべてがマッチする
```

**補足仕様**:

- デフォルト: 区別しない（OFF）
- トグルボタン形式で表示
- キーボードショートカット: Alt+C（macOS/Windows共通）

---

### 2.6 FR-006: 正規表現検索オプション

#### 要件ID: FR-006

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索パネルが表示されている状態で
When ユーザーが「正規表現」オプションを有効にする
Then 検索文字列が正規表現パターンとして解釈される
And オプションボタンがアクティブ状態で表示される

Given 「正規表現」オプションが有効な状態で
When ユーザーが "\d+" を検索する
Then 連続する数字がすべてマッチする

Given 「正規表現」オプションが有効な状態で
When ユーザーが無効な正規表現パターンを入力する
Then 検索フィールドにエラー状態が表示される
And エラーメッセージ「無効な正規表現です」が表示される
```

**補足仕様**:

- デフォルト: 無効（OFF）
- キーボードショートカット: Alt+R（macOS/Windows共通）
- ReDoS 対策: パターン実行タイムアウト 100ms

---

### 2.7 FR-007: 単語単位検索オプション

#### 要件ID: FR-007

**優先度**: Should Have

**受け入れ基準**:

```gherkin
Given 検索パネルが表示されている状態で
When ユーザーが「単語単位」オプションを有効にする
Then 単語境界でのみマッチする検索が実行される
And オプションボタンがアクティブ状態で表示される

Given 「単語単位」オプションが有効な状態で
When ユーザーが "test" を検索する
Then "test" はマッチする
And "testing" はマッチしない
And "attest" はマッチしない
```

**補足仕様**:

- デフォルト: 無効（OFF）
- キーボードショートカット: Alt+W（macOS/Windows共通）
- 単語境界の定義: `\b` (word boundary)

---

### 2.8 FR-008: 検索履歴

#### 要件ID: FR-008

**優先度**: Could Have

**受け入れ基準**:

```gherkin
Given 検索を実行した後
When 検索パネルを閉じて再度開く
Then 前回の検索文字列が検索フィールドに復元される

Given 検索フィールドにフォーカスがある状態で
When ユーザーが上矢印キーを押下する
Then 過去の検索履歴がドロップダウンで表示される
And 履歴から選択すると検索フィールドに入力される
```

**補足仕様**:

- 履歴保存数: 最大20件
- 永続化: electron-store による保存
- セッション間で履歴を維持

---

### 2.9 FR-009: 選択テキストの自動入力

#### 要件ID: FR-009

**優先度**: Should Have

**受け入れ基準**:

```gherkin
Given エディターでテキストが選択されている状態で
When ユーザーが Cmd+F / Ctrl+F を押下する
Then 選択されているテキストが検索フィールドに自動入力される
And そのテキストで検索が実行される
```

---

## 3. 非機能要件（Non-Functional Requirements）

### 3.1 NFR-001: パフォーマンス

| 要件                 | 基準                                      |
| -------------------- | ----------------------------------------- |
| 検索レスポンス時間   | 1MB以下のファイルで 100ms 以内            |
| 大規模ファイル対応   | 10MB以下のファイルで 500ms 以内           |
| インクリメンタル検索 | デバウンス 150ms で入力体験を阻害しない   |
| ハイライト描画       | 1000件以下のマッチで 60fps を維持         |
| メモリ使用量         | 検索中のメモリ増加量は元ファイルの2倍以内 |

**大規模マッチ数への対応**:

- 1000件以上のマッチがある場合、ビューポート内のハイライトのみ描画
- 仮想化によるパフォーマンス最適化

---

### 3.2 NFR-002: アクセシビリティ（WCAG 2.1 AA準拠）

| 要件                     | 基準                                          |
| ------------------------ | --------------------------------------------- |
| キーボードナビゲーション | すべての操作がキーボードのみで完結可能        |
| フォーカス管理           | 検索パネル開閉時の適切なフォーカス移動        |
| スクリーンリーダー対応   | 検索結果数、現在位置を `aria-live` で通知     |
| コントラスト比           | ハイライト色は背景とのコントラスト比 3:1 以上 |
| 色に依存しない情報伝達   | エラー状態はアイコン + テキストで併記         |

**ARIA属性の使用**:

| 要素               | 属性                                              |
| ------------------ | ------------------------------------------------- |
| 検索入力フィールド | `role="searchbox"`, `aria-label="ファイル内検索"` |
| 検索結果カウンター | `aria-live="polite"`, `role="status"`             |
| オプションボタン   | `aria-pressed="true/false"`                       |
| 次へ/前へボタン    | `aria-label="次の検索結果"` 等                    |

---

### 3.3 NFR-003: ユーザビリティ

| 要件                 | 基準                                       |
| -------------------- | ------------------------------------------ |
| 学習容易性           | 標準的なショートカット（Cmd/Ctrl+F）を採用 |
| 一貫性               | VS Code 等の標準エディターと同様の動作     |
| エラー回復           | 無効な正規表現でも入力を消去しない         |
| 視覚的フィードバック | 検索実行中のスピナー表示                   |
| 設定の永続化         | 検索オプション状態をセッション間で保持     |

---

### 3.4 NFR-004: セキュリティ

| 要件             | 対策                                           |
| ---------------- | ---------------------------------------------- |
| ReDoS 攻撃対策   | 正規表現実行タイムアウト 100ms                 |
| 入力値サニタイズ | 通常検索時の特殊文字エスケープ                 |
| XSS 対策         | 検索文字列のHTMLエスケープ（ハイライト表示時） |

---

## 4. キーボードショートカット一覧

| 操作                    | macOS                  | Windows/Linux          |
| ----------------------- | ---------------------- | ---------------------- |
| 検索パネルを開く        | Cmd+F                  | Ctrl+F                 |
| 検索パネルを閉じる      | Escape                 | Escape                 |
| 次の検索結果            | F3 / Enter             | F3 / Enter             |
| 前の検索結果            | Shift+F3 / Shift+Enter | Shift+F3 / Shift+Enter |
| 大文字/小文字区別トグル | Alt+C                  | Alt+C                  |
| 正規表現トグル          | Alt+R                  | Alt+R                  |
| 単語単位トグル          | Alt+W                  | Alt+W                  |
| 検索履歴表示            | 上矢印                 | 上矢印                 |

---

## 5. UI構成要素

### 5.1 検索パネル構成

```
┌─────────────────────────────────────────────────────────────────┐
│ [🔍] [検索フィールド                    ] [Aa] [.*] [Ab] │ 3/42 │
│      [←] [→] [×]                                               │
└─────────────────────────────────────────────────────────────────┘
```

| 要素           | 説明                          |
| -------------- | ----------------------------- |
| 🔍 アイコン    | 検索を示すアイコン（search）  |
| 検索フィールド | テキスト入力（type="search"） |
| [Aa]           | 大文字/小文字区別トグル       |
| [.*]           | 正規表現トグル                |
| [Ab]           | 単語単位トグル                |
| 3/42           | 現在位置/総マッチ数           |
| [←] [→]        | 前へ/次へナビゲーションボタン |
| [×]            | 検索パネルを閉じるボタン      |

### 5.2 状態別表示

| 状態           | 表示内容                              |
| -------------- | ------------------------------------- |
| 初期状態       | カウンター非表示                      |
| 検索中         | スピナー表示                          |
| マッチあり     | "N/M" 形式でカウンター表示            |
| マッチなし     | "0件" + 検索フィールド赤枠            |
| 正規表現エラー | エラーメッセージ + 検索フィールド赤枠 |

---

## 6. データ構造

### 6.1 検索オプション

```typescript
interface FileSearchOptions {
  /** 検索文字列 */
  query: string;
  /** 大文字/小文字を区別するか */
  caseSensitive: boolean;
  /** 正規表現として検索するか */
  useRegex: boolean;
  /** 単語単位で検索するか */
  wholeWord: boolean;
}
```

### 6.2 検索結果

```typescript
interface SearchMatch {
  /** マッチ開始位置（行番号、0始まり） */
  line: number;
  /** マッチ開始位置（列番号、0始まり） */
  column: number;
  /** マッチした文字列の長さ */
  length: number;
  /** マッチした文字列 */
  text: string;
}

interface FileSearchResult {
  /** 総マッチ数 */
  totalMatches: number;
  /** マッチ箇所のリスト */
  matches: SearchMatch[];
  /** 検索実行時間（ms） */
  executionTime: number;
}
```

---

## 7. エラーケース

| エラー種別         | トリガー               | ユーザー向けメッセージ                                   |
| ------------------ | ---------------------- | -------------------------------------------------------- |
| 無効な正規表現     | 正規表現構文エラー     | 「無効な正規表現です」                                   |
| 検索タイムアウト   | 100ms超過（ReDoS対策） | 「検索がタイムアウトしました」                           |
| 大規模ファイル警告 | 10MB超のファイル       | 「大きなファイルのため検索に時間がかかる場合があります」 |

---

## 8. テスト観点

### 8.1 単体テスト観点

- [ ] 検索オプション組み合わせ（8パターン: 2^3）
- [ ] 境界値: 空文字列、1文字、長い文字列（1000文字）
- [ ] 特殊文字: `.*+?^${}()[]|\`
- [ ] 正規表現: 有効パターン、無効パターン、ReDoSパターン
- [ ] マルチバイト文字: 日本語、絵文字

### 8.2 コンポーネントテスト観点

- [ ] キーボードショートカットの動作
- [ ] フォーカス管理（開閉時）
- [ ] オプションボタンのトグル動作
- [ ] 検索結果ナビゲーション
- [ ] エラー状態の表示

### 8.3 E2Eテスト観点

- [ ] ファイルオープン → 検索 → ナビゲーション の一連のフロー
- [ ] 検索オプション変更時の再検索
- [ ] 検索履歴の保存と復元

---

## 9. 依存関係

### 9.1 前提サブタスク

なし

### 9.2 後続サブタスク

| サブタスクID | サブタスク名           | 関係                               |
| ------------ | ---------------------- | ---------------------------------- |
| T-00-2       | ファイル内置換要件定義 | 検索要件に基づいて置換要件を定義   |
| T-01-1       | ファイル内検索UI設計   | 本要件に基づいてUI設計を実施       |
| T-01-5       | 検索エンジン設計       | 本要件に基づいてアーキテクチャ設計 |

---

## 10. 参照ドキュメント

- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン
- `docs/30-workflows/search-replace/task-search-replace.md` - 親タスク仕様書
- [VS Code Search and Replace](https://code.visualstudio.com/docs/editor/codebasics#_search-and-replace)

---

## 11. 変更履歴

| 日付       | 版  | 変更内容 | 担当         |
| ---------- | --- | -------- | ------------ |
| 2025-12-12 | 1.0 | 初版作成 | @req-analyst |
