# T-00-4: ワークスペース置換要件定義書

## メタ情報

| 項目             | 内容                                                      |
| ---------------- | --------------------------------------------------------- |
| サブタスクID     | T-00-4                                                    |
| サブタスク名     | ワークスペース置換要件定義                                |
| 親タスクID       | TASK-SEARCH-REPLACE-001                                   |
| フェーズ         | Phase 0: 要件定義                                         |
| ステータス       | 完了                                                      |
| 担当エージェント | @req-analyst                                              |
| 作成日           | 2025-12-12                                                |
| 参照タスク仕様書 | `docs/30-workflows/search-replace/task-search-replace.md` |
| 前提サブタスク   | T-00-3（ワークスペース検索要件定義）                      |

---

## 1. 概要

### 1.1 目的

ワークスペース（プロジェクト）全体で複数ファイルを横断してテキスト置換を行う機能の要件を定義する。本ドキュメントでは**置換機能のみ**を扱い、検索機能は T-00-3 で定義済みとする。

### 1.2 背景

複数ファイルの一括置換は、リファクタリングや命名変更時に非常に強力な機能だが、誤操作によるリスクも高い。複数ファイルへの影響が大きいため、確認ダイアログ、プレビュー、元に戻す機能などの安全機構が必須である。

### 1.3 スコープ

#### 含むもの

- 検索結果に対する複数ファイル一括置換
- 置換対象ファイルの選択的除外
- 置換前の確認ダイアログ
- 置換結果のプレビュー
- 一括Undo機能
- 置換進捗の表示
- 正規表現キャプチャグループを使用した置換

#### 含まないもの

- ワークスペース検索機能（T-00-3 で定義済み）
- ファイル内の単一置換（T-00-2 で定義済み）
- ファイルのリネーム（別機能として検討）
- シンボルリファクタリング（LSP連携機能として別途検討）

---

## 2. 機能要件（Functional Requirements）

### 2.1 FR-301: 置換パネルの表示（ワークスペース検索拡張）

#### 要件ID: FR-301

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given ワークスペース検索パネルが表示されている状態で
When 検索結果が存在する場合
Then 置換入力フィールドが検索フィールドの下に表示される
And 「すべて置換」ボタンが有効化される

Given ワークスペース検索パネルが表示されている状態で
When 検索結果が存在しない場合
Then 「すべて置換」ボタンが無効化される（グレーアウト）
```

**補足仕様**:

- ワークスペース検索パネルに置換フィールドを統合
- ファイル内検索の置換UIとは別（サイドバー vs エディター上部）

---

### 2.2 FR-302: 置換対象の選択的除外

#### 要件ID: FR-302

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が複数ファイルに存在する状態で
When 各ファイルグループのチェックボックスをオフにする
Then そのファイルは置換対象から除外される
And 除外されたファイルは視覚的に区別される（グレーアウト）

Given 検索結果内の個別マッチ行が表示されている状態で
When マッチ行のチェックボックスをオフにする
Then そのマッチ箇所のみが置換対象から除外される

Given すべてのファイルが選択されている状態で
When ユーザーが「すべて選択解除」をクリックする
Then すべてのチェックボックスがオフになる
And 「すべて置換」ボタンが無効化される

Given ファイルが選択解除されている状態で
When ユーザーが「すべて選択」をクリックする
Then すべてのチェックボックスがオンになる
```

**補足仕様**:

- デフォルト: すべて選択状態
- ファイル単位の選択/選択解除
- 個別マッチ単位の選択/選択解除
- 選択状態は検索結果表示中維持

---

### 2.3 FR-303: 置換プレビュー

#### 要件ID: FR-303

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が表示され、置換文字列が入力されている状態で
When ユーザーが「プレビュー」ボタンをクリックする
Then 置換後の結果がプレビューモードで表示される
And 各マッチ箇所で変更前→変更後の差分が表示される

Given プレビューモードが表示されている状態で
When ユーザーが置換文字列を変更する
Then プレビューがリアルタイムで更新される

Given 正規表現キャプチャグループを使用している状態で
When プレビューが表示される
Then キャプチャグループが展開された結果が表示される
```

**補足仕様**:

- 差分表示形式: インライン差分（削除=取り消し線+赤、追加=下線+緑）
- プレビューはリアルタイム更新（デバウンス 200ms）
- 大量の結果がある場合は最初の100件のみプレビュー表示

---

### 2.4 FR-304: 置換前確認ダイアログ

#### 要件ID: FR-304

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が存在する状態で
When ユーザーが「すべて置換」ボタンをクリックする
Then 確認ダイアログが表示される
And ダイアログには置換件数、対象ファイル数が表示される
And 「置換する」「キャンセル」ボタンが表示される

Given 確認ダイアログが表示されている状態で
When ユーザーが「置換する」をクリックする
Then 置換処理が開始される

Given 確認ダイアログが表示されている状態で
When ユーザーが「キャンセル」をクリックするか Escape を押下する
Then ダイアログが閉じられ、置換は実行されない

Given 置換対象が10ファイル以上の場合
When 確認ダイアログが表示される
Then より目立つ警告スタイルで表示される（アイコン、背景色）
And 「この操作は Cmd+Z で取り消すことができます」が表示される
```

**補足仕様**:

- 常に確認ダイアログを表示（スキップオプションなし）
- ダイアログ内に影響範囲のサマリーを表示
- 危険度に応じた視覚的警告レベル

---

### 2.5 FR-305: 一括置換の実行

#### 要件ID: FR-305

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 確認ダイアログで「置換する」を選択した後
When 置換処理が開始される
Then プログレスバーが表示される
And 処理中のファイル名が表示される
And 置換済み件数/総件数が表示される

Given 置換処理が実行中の状態で
When ユーザーが「キャンセル」ボタンをクリックする
Then 処理が中断される
And それまでに置換されたファイルは変更済み状態になる
And 未処理のファイルは変更されない

Given 置換処理が完了した場合
When 結果サマリーが表示される
Then 「N件のファイル内 M件を置換しました」と表示される
And 置換されたファイルは「変更あり」状態になる
```

**補足仕様**:

- 置換は非同期で実行
- プログレス表示（ファイル単位）
- 処理中もUIは応答性を維持
- 各ファイルへの置換は個別のファイル変更として扱う

---

### 2.6 FR-306: 正規表現キャプチャグループ置換

#### 要件ID: FR-306

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 正規表現検索オプションが有効な状態で
And 検索パターンにキャプチャグループが含まれている
When 置換文字列に「$1」「$2」等を使用して一括置換を実行する
Then すべてのマッチ箇所でキャプチャグループが展開される

Given 正規表現検索オプションが無効な状態で
When 置換文字列に「$1」を入力して一括置換を実行する
Then 「$1」がリテラル文字列として置換される
```

**補足仕様**:

- T-00-2 で定義した正規表現置換と同様の動作
- プレビューでもキャプチャグループ展開結果を確認可能

---

### 2.7 FR-307: 一括Undo機能

#### 要件ID: FR-307

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 一括置換を実行した後
When ユーザーが Cmd+Z / Ctrl+Z を押下する
Then 一括置換が取り消され、すべてのファイルが元の状態に戻る
And 各ファイルのUndo履歴にも反映される

Given 一括置換をUndoした後
When ユーザーが Cmd+Shift+Z / Ctrl+Y を押下する
Then 一括置換が再適用される（Redo）

Given 一括置換後に個別ファイルで編集を行った後
When ユーザーが一括置換のUndoを試みる
Then 警告ダイアログが表示される
And 「置換後に編集されたファイルがあります。続行しますか？」
And 続行を選択すると、編集済みファイルも含めてすべてUndoされる
```

**補足仕様**:

- 一括置換は1つのUndoグループとして記録
- Undoは全ファイルに対して一括で適用
- 部分的なUndoは不可（全部戻すか、戻さないか）
- 後続の編集がある場合は警告を表示

---

### 2.8 FR-308: 置換結果のサマリー表示

#### 要件ID: FR-308

**優先度**: Should Have

**受け入れ基準**:

```gherkin
Given 一括置換が完了した後
When 結果サマリーが表示される
Then 以下の情報が表示される:
  - 置換されたファイル数
  - 置換された総マッチ数
  - スキップされたファイル数（エラー等）
  - 処理時間

Given 置換中にエラーが発生したファイルがある場合
When 結果サマリーが表示される
Then エラーが発生したファイルのリストが表示される
And 各エラーの詳細（ファイルパス、エラー理由）が確認可能
```

**補足仕様**:

- サマリーはトースト通知として表示
- 詳細は検索パネル内にも表示
- エラー詳細はクリックで展開可能

---

### 2.9 FR-309: 保存されていないファイルの扱い

#### 要件ID: FR-309

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 置換対象のファイルが既にエディターで開かれていて未保存の変更がある状態で
When 一括置換を実行しようとする
Then 警告ダイアログが表示される
And 「保存されていない変更があるファイルがあります」
And オプション: 「すべて保存して続行」「スキップして続行」「キャンセル」

Given 「すべて保存して続行」を選択した場合
When 置換処理が開始される前に
Then 未保存のファイルがすべて保存される
And その後、置換処理が実行される

Given 「スキップして続行」を選択した場合
When 置換処理が実行される
Then 未保存の変更があるファイルは置換対象から除外される
```

**補足仕様**:

- 未保存ファイルの検出はエディター状態から取得
- スキップされたファイルは結果サマリーで報告

---

## 3. 非機能要件（Non-Functional Requirements）

### 3.1 NFR-301: パフォーマンス

| 要件                      | 基準                             |
| ------------------------- | -------------------------------- |
| 小規模置換（10ファイル）  | 2秒以内                          |
| 中規模置換（100ファイル） | 10秒以内                         |
| 大規模置換（500ファイル） | 30秒以内                         |
| UI応答性                  | 置換中もUIがブロックされない     |
| Undo実行                  | 置換規模に関わらず 5秒以内で完了 |
| プレビュー生成            | 100件以下で 500ms 以内           |

**パフォーマンス最適化戦略**:

- ファイル単位でのバッチ処理
- 並列ファイル書き込み（5ファイル同時、I/O負荷考慮）
- プログレス表示による体感速度の改善

---

### 3.2 NFR-302: データ整合性

| 要件                         | 基準                                     |
| ---------------------------- | ---------------------------------------- |
| 置換の原子性（ファイル単位） | 各ファイルの置換は成功/失敗が一括        |
| Undo の確実性                | 一括置換は常にUndoで元に戻せることを保証 |
| ファイル破損防止             | 置換中のクラッシュでもファイル破損を防ぐ |
| 同時アクセス                 | 外部で変更されたファイルの検出と警告     |

**安全策**:

- 置換前のファイルバックアップ（メモリ内）
- アトミックなファイル書き込み（一時ファイル経由）
- エラー発生時の部分ロールバック

---

### 3.3 NFR-303: アクセシビリティ（WCAG 2.1 AA準拠）

| 要件                     | 基準                                       |
| ------------------------ | ------------------------------------------ |
| キーボードナビゲーション | すべての置換操作がキーボードのみで完結可能 |
| 確認ダイアログ           | フォーカストラップ、Escapeで閉じる         |
| 危険操作の警告           | 視覚的警告 + 明確なテキスト説明            |
| プログレス通知           | スクリーンリーダーで進捗状況を読み上げ     |

**ARIA属性の使用**:

| 要素               | 属性                                      |
| ------------------ | ----------------------------------------- |
| 置換入力フィールド | `aria-label="置換文字列"`                 |
| すべて置換ボタン   | `aria-label="すべてのマッチを置換"`       |
| 確認ダイアログ     | `role="alertdialog"`, `aria-modal="true"` |
| プログレスバー     | `role="progressbar"`, `aria-valuenow`     |
| 結果通知           | `aria-live="polite"`, `role="status"`     |
| チェックボックス   | `aria-checked`, `aria-label`              |

---

### 3.4 NFR-304: セキュリティ

| 要件             | 対策                                         |
| ---------------- | -------------------------------------------- |
| 入力値サニタイズ | 置換文字列の特殊文字は適切に処理             |
| ファイル権限     | 書き込み権限のないファイルは検出してスキップ |
| パス検証         | ワークスペース外へのファイル操作を防止       |
| ReDoS 対策       | 正規表現置換のタイムアウト                   |

---

## 4. キーボードショートカット一覧

| 操作                             | macOS                 | Windows/Linux  |
| -------------------------------- | --------------------- | -------------- |
| すべて置換（確認ダイアログ表示） | Cmd+Alt+Enter         | Ctrl+Alt+Enter |
| 置換をキャンセル                 | Escape                | Escape         |
| 一括Undo                         | Cmd+Z                 | Ctrl+Z         |
| 一括Redo                         | Cmd+Shift+Z           | Ctrl+Y         |
| すべて選択                       | Cmd+A（結果リスト内） | Ctrl+A         |
| プレビュー表示                   | Alt+P                 | Alt+P          |

---

## 5. UI構成要素

### 5.1 ワークスペース置換パネル構成

```
┌──────────────────────────────────────────────────┐
│  🔍 ワークスペース検索                   [×]    │
├──────────────────────────────────────────────────┤
│  [検索フィールド              ] [Aa] [.*] [Ab]  │
│  [置換フィールド              ]                  │
│  ───────────────────────────────────────────── │
│  対象: [*.ts, *.tsx                          ]  │
│  除外: [node_modules, dist                   ]  │
│  [☑] .gitignore を使用                          │
│  ───────────────────────────────────────────── │
│  [プレビュー] [すべて置換]                      │
│  42件のファイル内 156件のマッチ     [クリア]    │
├──────────────────────────────────────────────────┤
│  [☑] ▼ src/components/Button.tsx (5)            │
│       [☑] 12: const <mark>Button</mark> → Bar   │
│       [☑] 24: export const <mark>Button</mark>  │
│       ...                                       │
│  [☑] ▼ src/hooks/useButton.ts (3)               │
│       [☑] 8:  const { <mark>Button</mark> }     │
│       ...                                       │
│  [☐] ▶ src/types/button.ts (2)  ← 除外         │
│  ...                                            │
└──────────────────────────────────────────────────┘
```

| 要素           | 説明                             |
| -------------- | -------------------------------- |
| 置換フィールド | 置換文字列入力                   |
| [プレビュー]   | 置換プレビューの表示切替         |
| [すべて置換]   | 確認ダイアログを表示して一括置換 |
| [☑]/[☐]        | 置換対象の選択チェックボックス   |
| → Bar          | プレビュー時の置換後テキスト     |

### 5.2 確認ダイアログ

```
┌─────────────────────────────────────────────────────┐
│  ⚠️  すべて置換                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  42件のファイル内 156件のマッチを置換しますか？     │
│                                                     │
│  検索: "Button"                                     │
│  置換: "Component"                                  │
│                                                     │
│  ℹ️ この操作は Cmd+Z で取り消すことができます。     │
│                                                     │
│                        [キャンセル] [置換する]      │
└─────────────────────────────────────────────────────┘
```

### 5.3 プログレスダイアログ

```
┌─────────────────────────────────────────────────────┐
│  置換処理中...                                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ████████████░░░░░░░░  35/42 ファイル               │
│                                                     │
│  処理中: src/components/Layout.tsx                  │
│                                                     │
│  完了: 120件 / エラー: 0件                          │
│                                                     │
│                                    [キャンセル]     │
└─────────────────────────────────────────────────────┘
```

### 5.4 結果サマリートースト

```
┌─────────────────────────────────────────────────┐
│  ✅ 置換完了                                    │
│                                                 │
│  42件のファイル内 156件を置換しました            │
│  処理時間: 2.3秒                                │
│                                                 │
│  [元に戻す]                        [詳細] [×]   │
└─────────────────────────────────────────────────┘
```

---

## 6. データ構造

### 6.1 置換リクエスト

```typescript
interface WorkspaceReplaceRequest {
  /** 検索クエリ（T-00-3で定義） */
  searchQuery: WorkspaceSearchQuery;
  /** 置換文字列 */
  replaceString: string;
  /** 置換対象のマッチ（選択されたもののみ） */
  selectedMatches: SelectedMatch[];
}

interface SelectedMatch {
  /** ファイルパス */
  filePath: string;
  /** マッチ位置（行番号、列番号） */
  position: { line: number; column: number };
  /** マッチした文字列の長さ */
  length: number;
}
```

### 6.2 置換結果

```typescript
interface WorkspaceReplaceResult {
  /** 置換されたファイル数 */
  replacedFileCount: number;
  /** 置換された総マッチ数 */
  totalReplacedCount: number;
  /** 処理時間（ms） */
  executionTime: number;
  /** Undoグループ識別子 */
  undoGroupId: string;
  /** ファイル別の結果 */
  fileResults: FileReplaceResult[];
  /** スキップされたファイル */
  skippedFiles: SkippedFile[];
}

interface FileReplaceResult {
  /** ファイルパス */
  filePath: string;
  /** 置換件数 */
  replacedCount: number;
  /** 成功/失敗 */
  status: "success" | "error";
  /** エラーメッセージ（エラー時のみ） */
  errorMessage?: string;
}

interface SkippedFile {
  /** ファイルパス */
  filePath: string;
  /** スキップ理由 */
  reason: "unsaved_changes" | "read_only" | "external_change" | "user_excluded";
}
```

---

## 7. エラーケース

| エラー種別             | トリガー                     | ユーザー向けメッセージ                        |
| ---------------------- | ---------------------------- | --------------------------------------------- |
| 検索結果なし           | 置換対象がない               | 「置換対象が見つかりません」                  |
| 選択なし               | すべてのチェックが外れている | 「置換対象を選択してください」                |
| ファイル書き込みエラー | 権限エラー等                 | 「{ファイル名}への書き込みに失敗しました」    |
| 外部変更検出           | 置換対象ファイルが外部で変更 | 「{ファイル名}は外部で変更されています」      |
| Undo失敗               | Undoデータ破損               | 「置換を元に戻せませんでした」                |
| 置換処理タイムアウト   | 処理時間超過（5分）          | 「置換処理がタイムアウトしました」            |
| メモリ不足             | 大量ファイルでメモリ超過     | 「メモリ不足のため処理を中断しました」        |
| 部分失敗               | 一部ファイルでエラー         | 「N件のファイルで置換に失敗しました（詳細）」 |

---

## 8. テスト観点

### 8.1 単体テスト観点

- [ ] 選択的置換（チェックボックス制御）
- [ ] 正規表現キャプチャグループ置換
- [ ] 置換プレビュー生成
- [ ] Undoグループの作成と適用

### 8.2 コンポーネントテスト観点

- [ ] チェックボックスの選択/選択解除
- [ ] 確認ダイアログの表示と操作
- [ ] プログレス表示の更新
- [ ] 結果サマリーの表示
- [ ] キーボードナビゲーション

### 8.3 統合テスト観点

- [ ] 一括置換 → 一括Undo → 一括Redo の一連のフロー
- [ ] 未保存ファイルがある場合の警告と処理
- [ ] 置換中のキャンセル処理
- [ ] エラーファイルのスキップと継続
- [ ] 大規模置換のパフォーマンス

### 8.4 E2Eテスト観点

- [ ] 検索 → 選択 → プレビュー → 確認 → 置換 → Undo の完全フロー
- [ ] 複数ファイルへの実際の置換と確認
- [ ] エディターとの連携（ファイルオープン、変更状態）

---

## 9. 依存関係

### 9.1 前提サブタスク

| サブタスクID | サブタスク名               | 依存内容                             |
| ------------ | -------------------------- | ------------------------------------ |
| T-00-3       | ワークスペース検索要件定義 | 検索機能の要件を前提として置換を定義 |

### 9.2 後続サブタスク

| サブタスクID | サブタスク名             | 関係                               |
| ------------ | ------------------------ | ---------------------------------- |
| T-01-4       | ワークスペース置換UI設計 | 本要件に基づいてUI設計を実施       |
| T-01-6       | 置換エンジン設計         | 本要件に基づいてアーキテクチャ設計 |

---

## 10. 参照ドキュメント

- `docs/30-workflows/search-replace/task-step00-3-workspace-search-requirements.md` - ワークスペース検索要件定義（前提）
- `docs/30-workflows/search-replace/task-step00-2-file-replace-requirements.md` - ファイル内置換要件定義（参考）
- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン
- `docs/30-workflows/search-replace/task-search-replace.md` - 親タスク仕様書
- [VS Code Search and Replace](https://code.visualstudio.com/docs/editor/codebasics#_search-and-replace)

---

## 11. 変更履歴

| 日付       | 版  | 変更内容 | 担当         |
| ---------- | --- | -------- | ------------ |
| 2025-12-12 | 1.0 | 初版作成 | @req-analyst |
