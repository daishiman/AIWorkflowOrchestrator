# T-00-2: ファイル内置換要件定義書

## メタ情報

| 項目             | 内容                                                      |
| ---------------- | --------------------------------------------------------- |
| サブタスクID     | T-00-2                                                    |
| サブタスク名     | ファイル内置換要件定義                                    |
| 親タスクID       | TASK-SEARCH-REPLACE-001                                   |
| フェーズ         | Phase 0: 要件定義                                         |
| ステータス       | 完了                                                      |
| 担当エージェント | .claude/agents/req-analyst.md                                              |
| 作成日           | 2025-12-12                                                |
| 参照タスク仕様書 | `docs/30-workflows/search-replace/task-search-replace.md` |
| 前提サブタスク   | T-00-1（ファイル内検索要件定義）                          |

---

## 1. 概要

### 1.1 目的

エディターで開いているファイル内でテキスト置換を行う機能の要件を定義する。本ドキュメントでは**置換機能のみ**を扱い、検索機能は T-00-1 で定義済みとする。

### 1.2 背景

置換機能は検索機能と密接に関連するが、独自の要件（単一置換、全置換、正規表現キャプチャグループ対応、Undo連携等）を持つ。誤操作による意図しない変更を防ぐため、プレビューや確認機能も重要である。

### 1.3 スコープ

#### 含むもの

- 検索結果に対する単一置換
- 検索結果に対する全置換
- 正規表現キャプチャグループ（$1, $2等）を使用した置換
- 置換プレビュー機能
- Undo/Redo との連携
- 置換履歴

#### 含まないもの

- 検索機能（T-00-1 で定義済み）
- ワークスペース全体の置換（T-00-4 で定義）
- ファイル保存処理（既存機能を利用）

---

## 2. 機能要件（Functional Requirements）

### 2.1 FR-101: 置換パネルの表示・非表示

#### 要件ID: FR-101

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索パネルが表示されている状態で
When ユーザーが置換展開ボタンをクリックするか Cmd+H（macOS）/ Ctrl+H（Windows）を押下する
Then 検索パネルが展開され、置換入力フィールドが表示される
And 置換入力フィールドにフォーカスが移動する

Given 置換パネルが展開されている状態で
When ユーザーが置換展開ボタンを再度クリックする
Then 置換パネルが折りたたまれ、検索パネルのみの表示に戻る

Given エディターでファイルが開かれている状態で
When ユーザーが直接 Cmd+H / Ctrl+H を押下する
Then 検索パネルが展開状態で表示される（置換フィールド含む）
And 検索入力フィールドにフォーカスが移動する
```

**補足仕様**:

- 検索パネルの拡張として実装（独立したパネルではない）
- 展開/折りたたみはアニメーション付き（200-300ms ease-in-out）

---

### 2.2 FR-102: 単一置換

#### 要件ID: FR-102

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が存在し、置換文字列が入力されている状態で
When ユーザーが「置換」ボタンをクリックするか Cmd+Shift+1 / Ctrl+Shift+1 を押下する
Then 現在選択されているマッチ箇所が置換文字列に置換される
And カーソルが次のマッチ箇所に自動的に移動する
And 検索結果カウンターが更新される

Given 最後のマッチ箇所が選択されている状態で
When ユーザーが単一置換を実行する
Then 置換が実行される
And カーソルが最初のマッチ箇所に循環移動する
And 検索結果カウンターが更新される

Given 検索結果が1件のみの状態で
When ユーザーが単一置換を実行する
Then 置換が実行される
And 検索結果カウンターが「0件」になる
And 「マッチなし」状態の表示になる
```

**補足仕様**:

- 置換後、変更箇所は一時的にハイライト表示（1秒間）
- 置換文字列が空の場合は削除（マッチ箇所を空文字列に置換）

---

### 2.3 FR-103: 全置換

#### 要件ID: FR-103

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が複数存在し、置換文字列が入力されている状態で
When ユーザーが「すべて置換」ボタンをクリックするか Cmd+Shift+Enter / Ctrl+Shift+Enter を押下する
Then すべてのマッチ箇所が置換文字列に一括置換される
And 置換件数が通知される（例：「12件を置換しました」）
And 検索結果カウンターが「0件」になる

Given 検索結果が100件以上存在する状態で
When ユーザーが全置換を実行する
Then 確認ダイアログが表示される（「100件を置換しますか？」）
And ユーザーが「置換」を選択した場合のみ置換が実行される
```

**補足仕様**:

- 全置換は単一のUndo操作で取り消し可能（アトミック）
- 大量置換（100件以上）の場合は確認ダイアログを表示
- 置換中はプログレス表示（件数が多い場合）

---

### 2.4 FR-104: 正規表現キャプチャグループ置換

#### 要件ID: FR-104

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 正規表現検索オプションが有効な状態で
And 検索パターンにキャプチャグループ「(\w+)@(\w+)\.com」が入力されている
When 置換文字列に「$2 ($1)」を入力して置換を実行する
Then "john@example.com" が "example (john)" に置換される

Given 正規表現検索オプションが有効な状態で
When 置換文字列に「$0」を使用する
Then マッチした文字列全体が参照される

Given 正規表現検索オプションが無効な状態で
When 置換文字列に「$1」を入力して置換を実行する
Then 「$1」がリテラル文字列として置換される（キャプチャ展開されない）
```

**補足仕様**:

- サポートするキャプチャ参照: `$0`（全体）, `$1`〜`$9`（グループ）
- `$$` でリテラルの `$` をエスケープ
- 存在しないグループ参照（例: `$5` でグループが4つの場合）は空文字列に展開

---

### 2.5 FR-105: 置換プレビュー

#### 要件ID: FR-105

**優先度**: Should Have

**受け入れ基準**:

```gherkin
Given 検索結果が存在し、置換文字列が入力されている状態で
When ユーザーが置換フィールドに入力する（または変更する）
Then 現在選択されているマッチ箇所の置換後の結果がプレビュー表示される
And プレビューは元のテキストと置換後のテキストを並べて表示する

Given 正規表現キャプチャグループを使用している状態で
When 置換プレビューが表示される
Then キャプチャグループが展開された結果が表示される
```

**補足仕様**:

- プレビュー表示形式: インライン差分表示（削除部分は取り消し線、追加部分は下線）
- プレビューはリアルタイム更新（デバウンス 100ms）
- 複数行にまたがる置換もプレビュー可能

---

### 2.6 FR-106: 置換とUndo/Redoの連携

#### 要件ID: FR-106

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 単一置換を実行した後
When ユーザーが Cmd+Z / Ctrl+Z を押下する
Then 置換が取り消され、元のテキストに戻る
And 検索結果のハイライトが復元される

Given 全置換を実行した後
When ユーザーが Cmd+Z / Ctrl+Z を押下する
Then すべての置換が一括で取り消される（単一のUndo操作）
And 検索結果のハイライトが復元される

Given 置換をUndoした後
When ユーザーが Cmd+Shift+Z / Ctrl+Y を押下する
Then 置換が再適用される（Redo）
```

**補足仕様**:

- 置換操作はエディターのUndoスタックに統合
- 全置換は1つのUndoグループとして記録
- Undo後も検索状態（検索文字列、オプション）は維持

---

### 2.7 FR-107: 置換履歴

#### 要件ID: FR-107

**優先度**: Could Have

**受け入れ基準**:

```gherkin
Given 置換を実行した後
When 置換パネルを閉じて再度開く
Then 前回の置換文字列が置換フィールドに復元される

Given 置換フィールドにフォーカスがある状態で
When ユーザーが上矢印キーを押下する
Then 過去の置換履歴がドロップダウンで表示される
And 履歴から選択すると置換フィールドに入力される
```

**補足仕様**:

- 履歴保存数: 最大20件
- 検索履歴とは別に管理
- 永続化: electron-store による保存

---

### 2.8 FR-108: 保持機能（Preserve Case）

#### 要件ID: FR-108

**優先度**: Could Have

**受け入れ基準**:

```gherkin
Given 「大文字/小文字を保持」オプションが有効な状態で
When "foo" を "bar" に置換する
Then "Foo" は "Bar" に置換される（先頭大文字を保持）
And "FOO" は "BAR" に置換される（全大文字を保持）
And "foo" は "bar" に置換される（全小文字を保持）
```

**補足仕様**:

- デフォルト: 無効（OFF）
- 大文字/小文字区別オプションが無効の場合のみ有効
- 正規表現モードでは無効

---

## 3. 非機能要件（Non-Functional Requirements）

### 3.1 NFR-101: パフォーマンス

| 要件                 | 基準                                    |
| -------------------- | --------------------------------------- |
| 単一置換レスポンス   | 50ms 以内                               |
| 全置換（100件以下）  | 200ms 以内                              |
| 全置換（1000件以下） | 1000ms 以内                             |
| プレビュー更新       | デバウンス 100ms で入力体験を阻害しない |
| Undo/Redo            | 置換規模に関わらず 100ms 以内で完了     |

**大規模置換への対応**:

- 1000件以上の置換はバッチ処理（100件単位）
- プログレスバーで進捗表示
- キャンセル可能

---

### 3.2 NFR-102: データ整合性

| 要件             | 基準                                     |
| ---------------- | ---------------------------------------- |
| 置換の原子性     | 全置換は成功/失敗が一括（部分成功なし）  |
| Undo の確実性    | 置換後は常にUndoで元に戻せることを保証   |
| ファイル変更検出 | 置換後、ファイルは「変更あり」状態になる |
| 同時編集の考慮   | 置換中に他の編集操作は待機               |

---

### 3.3 NFR-103: アクセシビリティ（WCAG 2.1 AA準拠）

| 要件                     | 基準                                         |
| ------------------------ | -------------------------------------------- |
| キーボードナビゲーション | すべての置換操作がキーボードのみで完結可能   |
| スクリーンリーダー対応   | 置換結果を `aria-live` で通知                |
| 確認ダイアログ           | フォーカストラップ、Escapeで閉じる           |
| 危険操作の警告           | 全置換前に確認（色だけでなくテキストで警告） |

**ARIA属性の使用**:

| 要素               | 属性                                      |
| ------------------ | ----------------------------------------- |
| 置換入力フィールド | `aria-label="置換文字列"`                 |
| 置換ボタン         | `aria-label="現在のマッチを置換"`         |
| 全置換ボタン       | `aria-label="すべてのマッチを置換"`       |
| 置換結果通知       | `aria-live="polite"`, `role="status"`     |
| 確認ダイアログ     | `role="alertdialog"`, `aria-modal="true"` |

---

### 3.4 NFR-104: セキュリティ

| 要件             | 対策                                           |
| ---------------- | ---------------------------------------------- |
| 入力値サニタイズ | 置換文字列の特殊文字は適切に処理               |
| XSS 対策         | プレビュー表示時のHTMLエスケープ               |
| ReDoS 対策       | 正規表現置換のタイムアウト（検索と同様 100ms） |

---

## 4. キーボードショートカット一覧

| 操作                    | macOS                     | Windows/Linux             |
| ----------------------- | ------------------------- | ------------------------- |
| 置換パネルを開く/展開   | Cmd+H                     | Ctrl+H                    |
| 単一置換                | Cmd+Shift+1               | Ctrl+Shift+1              |
| 全置換                  | Cmd+Shift+Enter           | Ctrl+Shift+Enter          |
| 置換して次へ            | Enter（置換フィールドで） | Enter（置換フィールドで） |
| 検索フィールドへ移動    | Tab（置換フィールドから） | Tab                       |
| 大文字/小文字保持トグル | Alt+P                     | Alt+P                     |

---

## 5. UI構成要素

### 5.1 置換パネル構成（展開時）

```
┌─────────────────────────────────────────────────────────────────────┐
│ [v] [🔍] [検索フィールド                    ] [Aa] [.*] [Ab] │ 3/42 │
│     [➡️] [置換フィールド                    ] [Pp]                   │
│                              [置換] [すべて置換] [←] [→] [×]        │
└─────────────────────────────────────────────────────────────────────┘
```

| 要素           | 説明                            |
| -------------- | ------------------------------- |
| [v]            | 置換パネル展開/折りたたみトグル |
| 置換フィールド | 置換文字列入力（type="text"）   |
| [Pp]           | 大文字/小文字保持トグル         |
| [置換]         | 単一置換ボタン                  |
| [すべて置換]   | 全置換ボタン                    |

### 5.2 置換プレビュー表示

```
置換プレビュー:
  変更前: "john@example.com"
  変更後: "example (john)"
```

| 要素     | スタイル                               |
| -------- | -------------------------------------- |
| 削除部分 | 取り消し線 + 赤背景（`bg-red-100/50`） |
| 追加部分 | 下線 + 緑背景（`bg-green-100/50`）     |

### 5.3 確認ダイアログ（大量置換時）

```
┌─────────────────────────────────────────────┐
│  ⚠️  すべて置換                             │
├─────────────────────────────────────────────┤
│  123件のマッチを置換しますか？              │
│                                             │
│  この操作は Cmd+Z で取り消すことができます。│
│                                             │
│                    [キャンセル] [置換する]  │
└─────────────────────────────────────────────┘
```

---

## 6. データ構造

### 6.1 置換オプション

```typescript
interface FileReplaceOptions {
  /** 検索オプション（T-00-1で定義） */
  searchOptions: FileSearchOptions;
  /** 置換文字列 */
  replaceString: string;
  /** 大文字/小文字を保持するか */
  preserveCase: boolean;
}
```

### 6.2 置換結果

```typescript
interface ReplaceResult {
  /** 置換件数 */
  replacedCount: number;
  /** 置換実行時間（ms） */
  executionTime: number;
  /** Undoグループ識別子 */
  undoGroupId: string;
}

interface ReplacePreview {
  /** 元のテキスト */
  originalText: string;
  /** 置換後のテキスト */
  replacedText: string;
  /** マッチ位置（行番号、列番号） */
  position: { line: number; column: number };
}
```

---

## 7. エラーケース

| エラー種別           | トリガー               | ユーザー向けメッセージ                 |
| -------------------- | ---------------------- | -------------------------------------- |
| 検索結果なし         | 置換対象がない         | 「置換対象が見つかりません」           |
| 置換タイムアウト     | 大量置換で処理超過     | 「置換処理がタイムアウトしました」     |
| 無効なキャプチャ参照 | 存在しないグループ参照 | （警告なし、空文字列に展開）           |
| ファイル書き込み失敗 | 権限エラー等           | 「ファイルへの書き込みに失敗しました」 |
| Undo失敗             | Undoスタック破損       | 「変更を元に戻せませんでした」         |

---

## 8. テスト観点

### 8.1 単体テスト観点

- [ ] 単一置換の基本動作
- [ ] 全置換の基本動作
- [ ] 正規表現キャプチャグループ置換（$0〜$9）
- [ ] 空文字列への置換（削除）
- [ ] 置換文字列が検索文字列を含む場合の無限ループ防止
- [ ] 大文字/小文字保持機能
- [ ] 特殊文字（改行、タブ等）を含む置換

### 8.2 コンポーネントテスト観点

- [ ] 置換パネルの展開/折りたたみ
- [ ] 置換ボタン、全置換ボタンの動作
- [ ] 置換プレビューの表示更新
- [ ] 確認ダイアログの表示と操作
- [ ] キーボードショートカットの動作

### 8.3 統合テスト観点

- [ ] 置換 → Undo → Redo の一連のフロー
- [ ] 全置換 → 一括Undo の動作
- [ ] 検索オプション変更時の置換動作
- [ ] 置換履歴の保存と復元

---

## 9. 依存関係

### 9.1 前提サブタスク

| サブタスクID | サブタスク名           | 依存内容                             |
| ------------ | ---------------------- | ------------------------------------ |
| T-00-1       | ファイル内検索要件定義 | 検索機能の要件を前提として置換を定義 |

### 9.2 後続サブタスク

| サブタスクID | サブタスク名         | 関係                               |
| ------------ | -------------------- | ---------------------------------- |
| T-01-2       | ファイル内置換UI設計 | 本要件に基づいてUI設計を実施       |
| T-01-6       | 置換エンジン設計     | 本要件に基づいてアーキテクチャ設計 |

---

## 10. 参照ドキュメント

- `docs/30-workflows/search-replace/task-step00-1-file-search-requirements.md` - ファイル内検索要件定義（前提）
- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン
- `docs/30-workflows/search-replace/task-search-replace.md` - 親タスク仕様書
- [VS Code Search and Replace](https://code.visualstudio.com/docs/editor/codebasics#_search-and-replace)

---

## 11. 変更履歴

| 日付       | 版  | 変更内容 | 担当         |
| ---------- | --- | -------- | ------------ |
| 2025-12-12 | 1.0 | 初版作成 | .claude/agents/req-analyst.md |
