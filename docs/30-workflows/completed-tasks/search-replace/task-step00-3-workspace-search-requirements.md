# T-00-3: ワークスペース検索要件定義書

## メタ情報

| 項目             | 内容                                                      |
| ---------------- | --------------------------------------------------------- |
| サブタスクID     | T-00-3                                                    |
| サブタスク名     | ワークスペース検索要件定義                                |
| 親タスクID       | TASK-SEARCH-REPLACE-001                                   |
| フェーズ         | Phase 0: 要件定義                                         |
| ステータス       | 完了                                                      |
| 担当エージェント | @req-analyst                                              |
| 作成日           | 2025-12-12                                                |
| 参照タスク仕様書 | `docs/30-workflows/search-replace/task-search-replace.md` |

---

## 1. 概要

### 1.1 目的

ワークスペース（プロジェクト）全体で複数ファイルを横断してテキスト検索を行う機能の要件を定義する。本ドキュメントでは**検索機能のみ**を扱い、置換機能は T-00-4 で別途定義する。

### 1.2 背景

複数ファイルにまたがる検索は、リファクタリングや一括変更時に必須の機能である。大規模プロジェクトでも実用的なパフォーマンスを維持しつつ、除外パターンやファイルタイプフィルタなどの柔軟なフィルタリングを提供する必要がある。

### 1.3 スコープ

#### 含むもの

- ワークスペース内の全ファイルを対象とした検索
- 検索結果のファイル別グルーピング表示
- 検索結果からファイルへのジャンプ
- 除外パターン設定（.gitignore連携含む）
- ファイルタイプフィルタ
- 検索結果のコンテキスト表示（前後の行）
- 検索結果の折りたたみ/展開

#### 含まないもの

- ファイル内検索（T-00-1 で定義済み）
- 置換機能（T-00-4 で定義）
- セマンティック検索（RAG機能で対応予定）
- ファイル名のみの検索（ファイル検索機能として別途検討）

---

## 2. 機能要件（Functional Requirements）

### 2.1 FR-201: ワークスペース検索パネルの表示

#### 要件ID: FR-201

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given ワークスペースが開かれている状態で
When ユーザーが Cmd+Shift+F（macOS）または Ctrl+Shift+F（Windows/Linux）を押下する
Then ワークスペース検索パネルがサイドバーに表示される
And 検索入力フィールドにフォーカスが移動する

Given ワークスペース検索パネルが表示されている状態で
When ユーザーが Escape キーを押下する
Then ワークスペース検索パネルが非表示になる（サイドバーが閉じる）
And フォーカスがエディターに戻る

Given サイドバーで他のパネル（ファイルツリー等）が表示されている状態で
When ユーザーが Cmd+Shift+F / Ctrl+Shift+F を押下する
Then サイドバーがワークスペース検索パネルに切り替わる
```

**補足仕様**:

- サイドバー内に専用パネルとして表示
- パネル幅は調整可能（最小幅: 250px）
- 検索パネルの状態（展開/折りたたみ）は永続化

---

### 2.2 FR-202: ワークスペース全体検索の実行

#### 要件ID: FR-202

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given ワークスペース検索パネルが表示されている状態で
When ユーザーが検索フィールドに文字を入力して Enter を押下する
Then ワークスペース内の全対象ファイルで検索が実行される
And 検索結果がファイル別にグルーピングされて表示される
And 検索中はプログレスインジケーターが表示される

Given 検索が実行中の状態で
When ユーザーが検索フィールドの内容を変更する
Then 現在の検索がキャンセルされる
And 新しい検索クエリで検索が開始される

Given 検索が実行中の状態で
When ユーザーが「キャンセル」ボタンをクリックする
Then 検索が中断される
And それまでに見つかった結果が表示される
```

**補足仕様**:

- インクリメンタル検索ではなく、Enter押下またはボタンクリックで検索開始
- 検索は非同期で実行され、結果はストリーミング表示

---

### 2.3 FR-203: 検索結果のグルーピング表示

#### 要件ID: FR-203

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が存在する場合
When 検索が完了する
Then 検索結果がファイルパスでグルーピングされて表示される
And 各ファイルグループはデフォルトで展開状態
And 各ファイルグループにはファイル名とマッチ件数が表示される

Given ファイルグループが展開されている状態で
When ユーザーがファイルグループのヘッダーをクリックする
Then ファイルグループが折りたたまれる
And マッチ行が非表示になる

Given 検索結果が多数存在する場合（例: 100ファイル以上）
When 検索が完了する
Then 最初の20ファイルのみ展開状態で表示される
And 残りのファイルは折りたたまれた状態で表示される
```

**補足仕様**:

- ファイルパスはワークスペースルートからの相対パスで表示
- 各マッチ行には行番号とコンテキスト（前後1行）が表示可能
- 全展開/全折りたたみボタンを提供

---

### 2.4 FR-204: 検索結果からファイルへのジャンプ

#### 要件ID: FR-204

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果のマッチ行が表示されている状態で
When ユーザーがマッチ行をクリックする
Then 該当ファイルがエディターで開かれる
And カーソルが該当行・該当列に移動する
And 該当箇所がビューポート中央に表示される
And マッチ箇所がハイライト表示される

Given 検索結果のマッチ行が表示されている状態で
When ユーザーがマッチ行をダブルクリックする
Then 該当ファイルがエディターで開かれる
And 検索パネルが閉じられる（サイドバーが前の状態に戻る）

Given 検索結果のファイルヘッダーが表示されている状態で
When ユーザーがファイル名をクリックする
Then 該当ファイルがエディターで開かれる
And ファイルの先頭が表示される
```

**補足仕様**:

- 既にエディターで開いているファイルの場合は、該当箇所にジャンプのみ
- ジャンプ後のハイライトは3秒で自動消去

---

### 2.5 FR-205: 除外パターン設定

#### 要件ID: FR-205

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given ワークスペース検索パネルが表示されている状態で
When ユーザーが「除外パターン」フィールドにパターンを入力する
Then 指定されたパターンにマッチするファイル/ディレクトリが検索対象から除外される

Given .gitignore ファイルがワークスペースに存在する場合
When 「.gitignore を使用」オプションが有効（デフォルト）の状態で検索を実行する
Then .gitignore に記載されたパターンにマッチするファイルが自動的に除外される

Given 除外パターンに "node_modules, dist, *.log" が設定されている状態で
When 検索を実行する
Then node_modules ディレクトリ、dist ディレクトリ、*.log ファイルが検索対象から除外される
```

**補足仕様**:

- デフォルト除外パターン: `node_modules, .git, dist, build, *.log`
- glob パターンをサポート（例: `**/*.test.ts`）
- .gitignore との併用が可能
- 除外パターンは設定として永続化

---

### 2.6 FR-206: ファイルタイプフィルタ

#### 要件ID: FR-206

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given ワークスペース検索パネルが表示されている状態で
When ユーザーが「対象ファイル」フィールドに "*.ts, *.tsx" を入力する
Then TypeScript/TSX ファイルのみが検索対象となる

Given ファイルタイプフィルタが空の状態で
When 検索を実行する
Then すべてのテキストファイルが検索対象となる

Given ファイルタイプフィルタに "src/**/*.ts" が設定されている状態で
When 検索を実行する
Then src ディレクトリ以下の TypeScript ファイルのみが検索対象となる
```

**補足仕様**:

- glob パターンをサポート
- よく使うパターンのプリセット提供（例: 「TypeScript」「JavaScript」「すべて」）
- バイナリファイルは自動的に除外

---

### 2.7 FR-207: 検索オプション（ファイル内検索と共通）

#### 要件ID: FR-207

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given ワークスペース検索パネルが表示されている状態で
When 「大文字/小文字を区別」オプションを有効にして検索を実行する
Then 大文字/小文字を区別した検索が実行される

Given ワークスペース検索パネルが表示されている状態で
When 「正規表現」オプションを有効にして検索を実行する
Then 検索文字列が正規表現パターンとして解釈される

Given ワークスペース検索パネルが表示されている状態で
When 「単語単位」オプションを有効にして検索を実行する
Then 単語境界でのみマッチする検索が実行される
```

**補足仕様**:

- T-00-1 で定義した検索オプションと同様の動作
- オプション状態はファイル内検索と独立して管理

---

### 2.8 FR-208: 検索結果のコンテキスト表示

#### 要件ID: FR-208

**優先度**: Should Have

**受け入れ基準**:

```gherkin
Given 検索結果が表示されている状態で
When 「コンテキスト表示」オプションが有効の場合
Then 各マッチ行の前後1行が薄い色で表示される

Given コンテキスト表示が有効な状態で
When コンテキスト行をクリックする
Then 該当ファイルの該当行にジャンプする

Given 検索結果が表示されている状態で
When 「コンテキスト表示」オプションを無効にする
Then マッチ行のみが表示される（前後の行は非表示）
```

**補足仕様**:

- デフォルト: コンテキスト表示無効（コンパクト表示）
- コンテキスト行数は設定可能（0〜3行、デフォルト1行）

---

### 2.9 FR-209: 検索結果のカウンター表示

#### 要件ID: FR-209

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索が完了した状態で
When 検索結果が存在する場合
Then 「N件のファイル内 M件のマッチ」形式でカウンターが表示される

Given 検索が実行中の状態で
When 結果がストリーミングで到着する
Then カウンターがリアルタイムで更新される

Given 検索結果が存在しない場合
When 検索が完了する
Then 「マッチなし」と表示される
```

---

### 2.10 FR-210: 検索結果のクリア

#### 要件ID: FR-210

**優先度**: Must Have

**受け入れ基準**:

```gherkin
Given 検索結果が表示されている状態で
When ユーザーが「クリア」ボタンをクリックする
Then 検索結果がクリアされる
And 検索フィールドは維持される

Given 検索フィールドに文字が入力されている状態で
When ユーザーが検索フィールドのクリアボタン（×）をクリックする
Then 検索フィールドがクリアされる
And 検索結果もクリアされる
```

---

## 3. 非機能要件（Non-Functional Requirements）

### 3.1 NFR-201: パフォーマンス

| 要件                   | 基準                              |
| ---------------------- | --------------------------------- |
| 小規模プロジェクト検索 | 1000ファイル以下で 2秒以内        |
| 中規模プロジェクト検索 | 10000ファイル以下で 5秒以内       |
| 大規模プロジェクト検索 | 50000ファイル以下で 15秒以内      |
| 結果表示開始           | 最初の結果は 500ms 以内に表示開始 |
| UI応答性               | 検索中もUIがブロックされない      |
| メモリ使用量           | 検索中のメモリ増加は 500MB 以内   |

**パフォーマンス最適化戦略**:

- ストリーミング結果表示（結果が見つかり次第表示）
- 並列ファイル読み込み（10ファイル同時）
- 大きなファイル（10MB超）はスキップまたは警告
- 検索インデックスの活用（将来的な最適化）

---

### 3.2 NFR-202: スケーラビリティ

| 要件               | 基準                                        |
| ------------------ | ------------------------------------------- |
| 最大ファイル数     | 100,000ファイルまで対応                     |
| 最大結果数         | 10,000件まで表示（超過時は警告 + 打ち切り） |
| 最大ファイルサイズ | 10MB超のファイルはデフォルトでスキップ      |
| 検索キャンセル     | 検索中いつでもキャンセル可能                |

---

### 3.3 NFR-203: アクセシビリティ（WCAG 2.1 AA準拠）

| 要件                     | 基準                                            |
| ------------------------ | ----------------------------------------------- |
| キーボードナビゲーション | 検索結果リストをキーボードで操作可能            |
| フォーカス管理           | Tab/Shift+Tabで検索フィールドと結果リスト間移動 |
| スクリーンリーダー対応   | 検索結果数、ファイル名を適切に読み上げ          |
| 高コントラスト           | 検索結果ハイライトは十分なコントラスト確保      |

**ARIA属性の使用**:

| 要素               | 属性                                                  |
| ------------------ | ----------------------------------------------------- |
| 検索入力フィールド | `role="searchbox"`, `aria-label="ワークスペース検索"` |
| 検索結果リスト     | `role="tree"`, `aria-label="検索結果"`                |
| ファイルグループ   | `role="treeitem"`, `aria-expanded`                    |
| マッチ行           | `role="treeitem"`, `aria-level="2"`                   |
| 検索ステータス     | `aria-live="polite"`, `role="status"`                 |

**キーボード操作**:

| キー          | 動作                             |
| ------------- | -------------------------------- |
| 上矢印/下矢印 | 検索結果リスト内を移動           |
| Enter         | 選択した結果の該当箇所にジャンプ |
| 左矢印        | ファイルグループを折りたたむ     |
| 右矢印        | ファイルグループを展開           |
| Home/End      | 結果リストの先頭/末尾に移動      |

---

### 3.4 NFR-204: 信頼性

| 要件       | 基準                                           |
| ---------- | ---------------------------------------------- |
| エラー回復 | 個別ファイルの読み込みエラーは検索を継続       |
| 部分結果   | 検索キャンセル時も途中結果を保持               |
| 状態復元   | アプリ再起動後も検索条件を復元可能             |
| 同時実行   | 複数の検索を同時に実行しない（新規検索で置換） |

---

## 4. キーボードショートカット一覧

| 操作                           | macOS                     | Windows/Linux |
| ------------------------------ | ------------------------- | ------------- |
| ワークスペース検索パネルを開く | Cmd+Shift+F               | Ctrl+Shift+F  |
| 検索を実行                     | Enter                     | Enter         |
| 検索をキャンセル               | Escape                    | Escape        |
| 次の結果に移動                 | F4                        | F4            |
| 前の結果に移動                 | Shift+F4                  | Shift+F4      |
| 結果リストにフォーカス         | Tab（検索フィールドから） | Tab           |
| 大文字/小文字区別トグル        | Alt+C                     | Alt+C         |
| 正規表現トグル                 | Alt+R                     | Alt+R         |
| 単語単位トグル                 | Alt+W                     | Alt+W         |

---

## 5. UI構成要素

### 5.1 ワークスペース検索パネル構成

```
┌──────────────────────────────────────────────────┐
│  🔍 ワークスペース検索                   [×]    │
├──────────────────────────────────────────────────┤
│  [検索フィールド              ] [Aa] [.*] [Ab]  │
│  ───────────────────────────────────────────── │
│  対象: [*.ts, *.tsx                          ]  │
│  除外: [node_modules, dist                   ]  │
│  [☑] .gitignore を使用                          │
│  ───────────────────────────────────────────── │
│  42件のファイル内 156件のマッチ     [クリア]    │
├──────────────────────────────────────────────────┤
│  ▼ src/components/Button.tsx (5)                │
│     12: const <mark>Button</mark> = ({ ...      │
│     24: export const <mark>Button</mark>Props   │
│     ...                                         │
│  ▼ src/hooks/useButton.ts (3)                   │
│     8:  const { <mark>Button</mark> } = ...     │
│     ...                                         │
│  ▶ src/types/button.ts (2)                      │
│  ▶ tests/Button.test.tsx (8)                    │
│  ...                                            │
└──────────────────────────────────────────────────┘
```

| 要素                | 説明                           |
| ------------------- | ------------------------------ |
| 検索フィールド      | 検索文字列入力                 |
| [Aa] [.*] [Ab]      | 検索オプショントグル           |
| 対象フィールド      | ファイルタイプフィルタ（glob） |
| 除外フィールド      | 除外パターン（glob）           |
| .gitignore チェック | .gitignore パターンの使用有無  |
| カウンター          | ファイル数/マッチ数            |
| 結果リスト          | ファイル別グルーピング表示     |
| ▼/▶                 | 折りたたみ/展開トグル          |

### 5.2 マッチ行の表示形式

```
  12: const <mark>Button</mark> = ({ label, onClick }) => {
       │                │
       │                └─ マッチ箇所（ハイライト）
       └─ 行番号
```

- 行番号は右寄せ、固定幅
- マッチ箇所は背景色でハイライト
- 長い行は省略表示（...）

---

## 6. データ構造

### 6.1 検索クエリ

```typescript
interface WorkspaceSearchQuery {
  /** 検索文字列 */
  query: string;
  /** 大文字/小文字を区別 */
  caseSensitive: boolean;
  /** 正規表現として検索 */
  useRegex: boolean;
  /** 単語単位で検索 */
  wholeWord: boolean;
  /** 対象ファイルパターン（glob） */
  includePattern: string;
  /** 除外パターン（glob） */
  excludePattern: string;
  /** .gitignoreを使用 */
  useGitignore: boolean;
}
```

### 6.2 検索結果

```typescript
interface WorkspaceSearchResult {
  /** 検索対象ファイル総数 */
  totalFilesSearched: number;
  /** マッチしたファイル数 */
  matchedFileCount: number;
  /** 総マッチ数 */
  totalMatchCount: number;
  /** ファイル別の検索結果 */
  fileResults: FileSearchResult[];
  /** 検索実行時間（ms） */
  executionTime: number;
  /** 検索が完了したか（キャンセル時はfalse） */
  isComplete: boolean;
  /** スキップされたファイル（大きすぎる等） */
  skippedFiles: SkippedFile[];
}

interface FileSearchResult {
  /** ファイルパス（相対パス） */
  filePath: string;
  /** ファイル内のマッチ一覧 */
  matches: SearchMatch[];
}

interface SearchMatch {
  /** 行番号（1始まり） */
  line: number;
  /** 列番号（1始まり） */
  column: number;
  /** マッチした文字列の長さ */
  length: number;
  /** マッチした行全体のテキスト */
  lineText: string;
  /** 前の行（コンテキスト） */
  beforeContext?: string[];
  /** 後の行（コンテキスト） */
  afterContext?: string[];
}

interface SkippedFile {
  /** ファイルパス */
  filePath: string;
  /** スキップ理由 */
  reason: "too_large" | "binary" | "read_error";
}
```

---

## 7. エラーケース

| エラー種別             | トリガー                       | ユーザー向けメッセージ                      |
| ---------------------- | ------------------------------ | ------------------------------------------- |
| ワークスペースなし     | ワークスペースが開かれていない | 「ワークスペースを開いてください」          |
| 無効な正規表現         | 正規表現構文エラー             | 「無効な正規表現です」                      |
| 無効なglobパターン     | 不正なglobパターン             | 「無効なパターンです: {パターン}」          |
| 検索タイムアウト       | 検索時間超過                   | 「検索がタイムアウトしました（結果: N件）」 |
| 結果数上限超過         | 10000件超                      | 「結果が多すぎます（10000件で打ち切り）」   |
| ファイル読み込みエラー | 権限エラー等                   | （スキップして継続、最後にサマリー表示）    |
| メモリ不足             | 大量の結果でメモリ超過         | 「メモリ不足のため検索を中断しました」      |

---

## 8. テスト観点

### 8.1 単体テスト観点

- [ ] glob パターンのマッチング
- [ ] .gitignore パターンの解析
- [ ] 検索オプションの組み合わせ
- [ ] 大きなファイルのスキップ判定
- [ ] バイナリファイルの検出

### 8.2 コンポーネントテスト観点

- [ ] 検索パネルの表示/非表示
- [ ] 検索結果リストの展開/折りたたみ
- [ ] ファイルジャンプ動作
- [ ] キーボードナビゲーション
- [ ] 検索オプションの状態管理

### 8.3 統合テスト観点

- [ ] 小〜大規模プロジェクトでの検索パフォーマンス
- [ ] 検索キャンセルと部分結果表示
- [ ] ストリーミング結果表示
- [ ] ファイル変更時の再検索

---

## 9. 依存関係

### 9.1 前提サブタスク

なし（T-00-1とは独立して定義可能）

### 9.2 後続サブタスク

| サブタスクID | サブタスク名               | 関係                                       |
| ------------ | -------------------------- | ------------------------------------------ |
| T-00-4       | ワークスペース置換要件定義 | 検索要件に基づいて置換要件を定義           |
| T-01-3       | ワークスペース検索UI設計   | 本要件に基づいてUI設計を実施               |
| T-01-5       | 検索エンジン設計           | 本要件に基づいてアーキテクチャ設計（共有） |

---

## 10. 参照ドキュメント

- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン
- `docs/30-workflows/search-replace/task-search-replace.md` - 親タスク仕様書
- [VS Code Search](https://code.visualstudio.com/docs/editor/codebasics#_search-across-files)
- [ripgrep](https://github.com/BurntSushi/ripgrep) - 高速検索ツールの参考実装

---

## 11. 変更履歴

| 日付       | 版  | 変更内容 | 担当         |
| ---------- | --- | -------- | ------------ |
| 2025-12-12 | 1.0 | 初版作成 | @req-analyst |
