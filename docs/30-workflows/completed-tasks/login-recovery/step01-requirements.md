# ログイン機能復旧 - 要件定義書

## メタ情報

| 項目             | 内容                               |
| ---------------- | ---------------------------------- |
| ドキュメントID   | REQ-AUTH-RECOVERY-001              |
| バージョン       | 1.0                                |
| 作成日           | 2025-12-20                         |
| ステータス       | レビュー待ち                       |
| 担当エージェント | @req-analyst                       |
| 関連タスク       | T-00-1（ログイン機能復旧要件定義） |

---

## 1. プロジェクト概要

### 1.1 目的

本ドキュメントは、AIWorkflowOrchestratorアプリケーションにおけるログイン機能の復旧要件を定義する。

### 1.2 スコープ

| 項目                 | 内容                                              |
| -------------------- | ------------------------------------------------- |
| 対象機能             | AuthGuard、OAuth認証フロー、カスタムプロトコル    |
| 対象プラットフォーム | Electronデスクトップアプリ（macOS/Windows/Linux） |
| 対象ユーザー         | 全アプリケーションユーザー                        |

### 1.3 ステークホルダー

| ステークホルダー | 関心事項                                |
| ---------------- | --------------------------------------- |
| エンドユーザー   | OAuth認証によるシームレスなログイン体験 |
| 開発者           | 安全で保守性の高い認証実装              |
| セキュリティ担当 | 認証認可の適切な実装、機密情報の保護    |

---

## 2. 現状分析

### 2.1 根本原因

**直接原因**: `apps/desktop/src/renderer/App.tsx` において、AuthGuardコンポーネントがコメントアウトされている。

```typescript
// TEMPORARY: AuthGuard disabled for manual testing of WorkspaceFileSelector (T-08-1)
// import { AuthGuard } from "./components/AuthGuard";
// ...
// <AuthGuard>
<div className="h-screen w-screen overflow-hidden bg-[var(--bg-primary)]">
// </AuthGuard>
```

**経緯**: TASK-DT-001（フォルダ一括選択機能）のPhase 8手動テスト準備時に、テストのためにAuthGuardを一時的にコメントアウト。その後、再有効化が完了していなかった。

### 2.2 影響範囲

| 影響               | 詳細                                              |
| ------------------ | ------------------------------------------------- |
| 認証バイパス       | 未認証ユーザーがアプリ全機能にアクセス可能        |
| セキュリティリスク | ユーザーデータ・APIキー等の機密情報が保護されない |
| ユーザー体験       | 新規/既存ユーザーがログインできない               |

### 2.3 既存実装の状態

| コンポーネント    | 実装状態                    | 備考                    |
| ----------------- | --------------------------- | ----------------------- |
| AuthGuard         | **無効化** (コメントアウト) | 復旧対象                |
| authSlice.ts      | 実装完了                    | 認証状態管理            |
| authHandlers.ts   | 実装完了                    | IPCハンドラー           |
| customProtocol.ts | 実装完了                    | aiworkflow://プロトコル |
| AuthView          | 実装完了                    | ログイン画面UI          |
| LoadingScreen     | 実装完了                    | ローディング画面        |
| AuthErrorBoundary | 実装完了                    | エラーハンドリング      |

---

## 3. 機能要件

### 3.1 AuthGuard表示制御

#### FR-001: 未認証時のログイン画面表示

| 項目   | 内容                                                                          |
| ------ | ----------------------------------------------------------------------------- |
| 優先度 | **Must（必須）**                                                              |
| 説明   | アプリ起動時、未認証状態の場合はAuthGuardのログイン画面（AuthView）を表示する |

**詳細仕様**:

- `isAuthenticated === false` かつ `isLoading === false` の場合、AuthViewを表示
- ダッシュボード等のメインコンテンツにはアクセスさせない

#### FR-002: 認証済み時のコンテンツ表示

| 項目   | 内容                                                                  |
| ------ | --------------------------------------------------------------------- |
| 優先度 | **Must（必須）**                                                      |
| 説明   | 認証済み状態の場合、AuthGuardのchildren（ダッシュボード等）を表示する |

**詳細仕様**:

- `isAuthenticated === true` の場合、childrenを表示
- ログイン画面は表示しない

#### FR-003: ローディング状態の表示

| 項目   | 内容                                    |
| ------ | --------------------------------------- |
| 優先度 | **Must（必須）**                        |
| 説明   | 認証状態確認中はLoadingScreenを表示する |

**詳細仕様**:

- `isLoading === true` の場合、LoadingScreenを表示
- セッション確認完了後に適切な画面に遷移

### 3.2 OAuth認証フロー

#### FR-004: Google OAuth認証

| 項目   | 内容                                                               |
| ------ | ------------------------------------------------------------------ |
| 優先度 | **Must（必須）**                                                   |
| 説明   | 「Googleで続ける」ボタンクリックでGoogle OAuth認証フローを開始する |

**詳細仕様**:

1. ボタンクリックで `authSlice.login("google")` を呼び出し
2. IPCハンドラー経由で `supabase.auth.signInWithOAuth()` を実行
3. 外部ブラウザでGoogle認証画面を開く
4. 認証成功後、`aiworkflow://auth/callback` にリダイレクト

#### FR-005: GitHub OAuth認証

| 項目   | 内容                                                               |
| ------ | ------------------------------------------------------------------ |
| 優先度 | **Must（必須）**                                                   |
| 説明   | 「GitHubで続ける」ボタンクリックでGitHub OAuth認証フローを開始する |

**詳細仕様**: FR-004と同様のフロー（provider = "github"）

#### FR-006: Discord OAuth認証

| 項目   | 内容                                                                 |
| ------ | -------------------------------------------------------------------- |
| 優先度 | **Must（必須）**                                                     |
| 説明   | 「Discordで続ける」ボタンクリックでDiscord OAuth認証フローを開始する |

**詳細仕様**: FR-004と同様のフロー（provider = "discord"）

### 3.3 カスタムプロトコルコールバック

#### FR-007: 認証コールバック処理

| 項目   | 内容                                                             |
| ------ | ---------------------------------------------------------------- |
| 優先度 | **Must（必須）**                                                 |
| 説明   | `aiworkflow://auth/callback` URLを受信し、認証トークンを処理する |

**詳細仕様**:

1. カスタムプロトコルURL（`aiworkflow://auth/callback?access_token=...`）を受信
2. `parseAuthCallback()` でトークンを抽出
3. `supabase.auth.setSession()` でセッションを設定
4. リフレッシュトークンをSecure Storageに保存
5. `AUTH_STATE_CHANGED` イベントをRendererに送信

#### FR-008: マルチプラットフォーム対応

| 項目   | 内容                                                    |
| ------ | ------------------------------------------------------- |
| 優先度 | **Must（必須）**                                        |
| 説明   | macOS/Windows/Linuxで認証コールバックが正常に処理される |

**詳細仕様**:

- macOS: `app.on("open-url")` イベントで処理
- Windows/Linux: `app.on("second-instance")` イベントで処理
- 起動時引数: `process.argv` からURLを検出して処理

### 3.4 認証状態管理

#### FR-009: セッション永続化

| 項目   | 内容                                               |
| ------ | -------------------------------------------------- |
| 優先度 | **Must（必須）**                                   |
| 説明   | ログイン後、アプリ再起動時もセッションが維持される |

**詳細仕様**:

1. 起動時に `initializeAuth()` を実行
2. `auth.getSession()` でセッションを確認
3. 有効なセッションがあれば `isAuthenticated = true` に設定
4. ログイン画面をスキップしてダッシュボードを表示

#### FR-010: ログアウト

| 項目   | 内容                             |
| ------ | -------------------------------- |
| 優先度 | **Must（必須）**                 |
| 説明   | ログアウト後、ログイン画面に戻る |

**詳細仕様**:

1. `authSlice.logout()` を実行
2. IPCハンドラー経由で `supabase.auth.signOut()` を実行
3. Secure Storageからトークンを削除
4. `clearAuth()` で認証状態をリセット
5. AuthGuardがAuthViewを表示

---

## 4. 非機能要件

### 4.1 パフォーマンス

#### NFR-001: 認証状態確認の応答時間

| 項目     | 内容                                        |
| -------- | ------------------------------------------- |
| 優先度   | **Should（重要）**                          |
| 基準     | 起動時の認証状態確認: < 2秒（オンライン時） |
| 測定方法 | `initializeAuth()` の実行時間を計測         |

#### NFR-002: OAuth認証開始の応答時間

| 項目     | 内容                                                     |
| -------- | -------------------------------------------------------- |
| 優先度   | **Should（重要）**                                       |
| 基準     | ログインボタンクリックからブラウザ起動まで: < 500ms      |
| 測定方法 | ボタンクリックから `shell.openExternal()` 完了までの時間 |

### 4.2 セキュリティ

#### NFR-003: トークンの安全な保存

| 項目   | 内容                                                                      |
| ------ | ------------------------------------------------------------------------- |
| 優先度 | **Must（必須）**                                                          |
| 基準   | リフレッシュトークンはSecure Storage（Keychain/Credential Manager）に保存 |
| 備考   | アクセストークンはメモリ上のみで管理                                      |

#### NFR-004: IPC通信のセキュリティ

| 項目   | 内容                                                           |
| ------ | -------------------------------------------------------------- |
| 優先度 | **Must（必須）**                                               |
| 基準   | IPC通信でトークンを平文で送信しない                            |
| 備考   | 認証状態はイベント通知で伝達、トークン取得は専用ハンドラー経由 |

#### NFR-005: エラーメッセージのサニタイズ

| 項目   | 内容                                                     |
| ------ | -------------------------------------------------------- |
| 優先度 | **Must（必須）**                                         |
| 基準   | エラーログに機密情報（トークン、パスワード等）を含めない |
| 備考   | `sanitizeErrorMessage()` で自動サニタイズ                |

### 4.3 信頼性

#### NFR-006: オフライン対応

| 項目   | 内容                                                   |
| ------ | ------------------------------------------------------ |
| 優先度 | **Should（重要）**                                     |
| 基準   | オフライン時でも既存セッションがあればアプリを使用可能 |
| 備考   | `isOffline` 状態を適切に管理                           |

#### NFR-007: エラーハンドリング

| 項目   | 内容                                                       |
| ------ | ---------------------------------------------------------- |
| 優先度 | **Must（必須）**                                           |
| 基準   | 認証エラー時にユーザーフレンドリーなエラーメッセージを表示 |
| 備考   | AuthErrorBoundaryでエラーをキャッチ                        |

### 4.4 テスト可能性

#### NFR-008: ユニットテスト可能性

| 項目   | 内容                                   |
| ------ | -------------------------------------- |
| 優先度 | **Must（必須）**                       |
| 基準   | 認証ロジックのユニットテストが実行可能 |
| 備考   | モック可能なIPC通信設計                |

---

## 5. 受け入れ基準

### AC-001: 未認証時のAuthGuard表示

```gherkin
Given アプリケーションが未認証状態である
When アプリケーションを起動する
Then AuthGuardのログイン画面（AuthView）が表示される
And Google/GitHub/Discordのログインボタンが表示される
And ダッシュボードは表示されない
```

### AC-002: 認証済み時のダッシュボード表示

```gherkin
Given ユーザーが認証済みである
When アプリケーションを起動する
Then ダッシュボードが表示される
And ログイン画面は表示されない
```

### AC-003: Google OAuth認証フロー

```gherkin
Given ユーザーがログイン画面にいる
When 「Googleで続ける」ボタンをクリックする
Then 外部ブラウザでGoogle認証画面が開く
And ブラウザで認証を許可すると
Then Electronアプリに戻る
And ダッシュボードが表示される
And ユーザー情報が正しく表示される
```

### AC-004: GitHub OAuth認証フロー

```gherkin
Given ユーザーがログイン画面にいる
When 「GitHubで続ける」ボタンをクリックする
Then 外部ブラウザでGitHub認証画面が開く
And ブラウザで認証を許可すると
Then Electronアプリに戻る
And ダッシュボードが表示される
And ユーザー情報が正しく表示される
```

### AC-005: Discord OAuth認証フロー

```gherkin
Given ユーザーがログイン画面にいる
When 「Discordで続ける」ボタンをクリックする
Then 外部ブラウザでDiscord認証画面が開く
And ブラウザで認証を許可すると
Then Electronアプリに戻る
And ダッシュボードが表示される
And ユーザー情報が正しく表示される
```

### AC-006: セッション永続化

```gherkin
Given ユーザーが認証済みである
When アプリケーションを終了して再起動する
Then ログイン画面をスキップしてダッシュボードが表示される
And セッションが維持されている
```

### AC-007: ログアウト

```gherkin
Given ユーザーが認証済みでダッシュボードにいる
When ログアウト操作を実行する
Then ログイン画面（AuthView）が表示される
And セッションがクリアされている
And 再度認証が必要になる
```

### AC-008: ローディング状態

```gherkin
Given アプリケーションが起動中である
When 認証状態を確認している
Then LoadingScreenが表示される
And 確認完了後に適切な画面に遷移する
```

### AC-009: 認証エラー時の表示

```gherkin
Given ユーザーがログイン画面にいる
When OAuth認証がエラーになる
Then エラーメッセージがログイン画面に表示される
And 再試行が可能である
And 機密情報がエラーメッセージに含まれない
```

### AC-010: オフライン時の動作

```gherkin
Given ユーザーが認証済みである
And ネットワークがオフラインである
When アプリケーションを起動する
Then 既存セッションでアプリを使用できる
And オフライン状態が表示される
```

---

## 6. 環境別動作要件

### 6.1 開発環境

| 項目               | 要件                                                       |
| ------------------ | ---------------------------------------------------------- |
| カスタムプロトコル | `setAsDefaultProtocolClient` は開発モードで制限あり        |
| 代替手段           | `devInjectAuthCallback` による開発環境用認証フロー実装済み |
| 環境変数           | `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`              |

### 6.2 本番環境

| 項目               | 要件                                         |
| ------------------ | -------------------------------------------- |
| カスタムプロトコル | `aiworkflow://` がシステムに登録される       |
| パッケージング     | Electronアプリとしてビルド時にプロトコル登録 |
| 環境変数           | 本番用Supabase認証情報                       |

---

## 7. 用語集

| 用語               | 定義                                                                       |
| ------------------ | -------------------------------------------------------------------------- |
| AuthGuard          | 認証状態に応じてコンテンツ表示を制御するReactコンポーネント                |
| AuthView           | ログイン画面を表示するReactコンポーネント                                  |
| authSlice          | Zustand storeにおける認証状態管理のスライス                                |
| カスタムプロトコル | `aiworkflow://` 形式のURLを処理する仕組み                                  |
| OAuth              | Open Authorization - 外部サービス経由の認証プロトコル                      |
| IPC                | Inter-Process Communication - Electron Main/Renderer間通信                 |
| Secure Storage     | OS提供のセキュアなストレージ（macOS Keychain、Windows Credential Manager） |

---

## 8. 制約事項

### 8.1 技術的制約

| 制約                       | 詳細                                                                      |
| -------------------------- | ------------------------------------------------------------------------- |
| 開発モードのプロトコル登録 | macOSでは `setAsDefaultProtocolClient` が開発モードで機能しない場合がある |
| ブラウザ連携               | OAuth認証は外部ブラウザを使用（アプリ内WebViewは使用しない）              |
| トークン保存場所           | Rendererプロセスにトークンを保存しない（Main Processのみ）                |

### 8.2 前提条件

| 前提         | 詳細                                                            |
| ------------ | --------------------------------------------------------------- |
| Supabase設定 | OAuth プロバイダー（Google/GitHub/Discord）がSupabaseに登録済み |
| 環境変数     | `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY` が設定済み        |
| ネットワーク | 初回ログイン時はオンライン接続が必要                            |

---

## 9. 品質スコア

| 評価項目   | スコア | 基準値 | 状態    |
| ---------- | ------ | ------ | ------- |
| 明確性     | 95%    | ≥90%   | ✅ PASS |
| 完全性     | 90%    | ≥85%   | ✅ PASS |
| 一貫性     | 100%   | 100%   | ✅ PASS |
| 検証可能性 | 100%   | 100%   | ✅ PASS |

---

## 10. 次フェーズへの引き継ぎ

### 10.1 後続タスク

| タスクID | 名称                       | 概要                     |
| -------- | -------------------------- | ------------------------ |
| T-01-1   | ワークツリー修復・環境復旧 | 開発環境の正常化         |
| T-01-2   | ログイン機能復旧設計       | 復旧方針と実装設計の策定 |

### 10.2 主要な復旧ポイント

1. **App.tsx**: AuthGuardのコメントアウトを解除
2. **動作確認**: 認証フロー全体のテスト実行
3. **回帰テスト**: 既存テストの成功確認

### 10.3 テスト対象ファイル

| ファイル                                                            | 説明                    |
| ------------------------------------------------------------------- | ----------------------- |
| `apps/desktop/src/renderer/components/AuthGuard/AuthGuard.test.tsx` | AuthGuardユニットテスト |
| `apps/desktop/src/renderer/store/slices/authSlice.test.ts`          | 認証状態管理テスト      |
| `apps/desktop/src/main/ipc/authHandlers.test.ts`                    | IPCハンドラーテスト     |

---

## 付録A: 既存実装の参照先

| コンポーネント    | ファイルパス                                                           |
| ----------------- | ---------------------------------------------------------------------- |
| AuthGuard         | `apps/desktop/src/renderer/components/AuthGuard/index.tsx`             |
| LoadingScreen     | `apps/desktop/src/renderer/components/AuthGuard/LoadingScreen.tsx`     |
| AuthErrorBoundary | `apps/desktop/src/renderer/components/AuthGuard/AuthErrorBoundary.tsx` |
| AuthView          | `apps/desktop/src/renderer/views/AuthView/index.tsx`                   |
| authSlice         | `apps/desktop/src/renderer/store/slices/authSlice.ts`                  |
| authHandlers      | `apps/desktop/src/main/ipc/authHandlers.ts`                            |
| customProtocol    | `apps/desktop/src/main/protocol/customProtocol.ts`                     |
| App.tsx           | `apps/desktop/src/renderer/App.tsx`                                    |

---

**文書作成完了**: 2025-12-20
**次のステップ**: T-01-1（ワークツリー修復・環境復旧）
