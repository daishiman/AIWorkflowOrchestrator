# チャット履歴永続化機能 - 非機能要件定義書

## メタ情報

| 項目         | 内容                       |
| ------------ | -------------------------- |
| ドキュメント | 非機能要件定義書           |
| タスクID     | TASK-CHAT-HISTORY-001      |
| バージョン   | 1.0.0                      |
| 作成日       | 2025-12-20                 |
| 対象         | チャット履歴永続化機能     |
| 分類方法     | FURPS+ (ISO/IEC 25010準拠) |

---

## 1. 概要

### 1.1 目的

チャット履歴永続化機能の非機能要件（Performance, Reliability, Usability, Security, Maintainability, Compatibility）を定義し、システムの品質特性を明確にする。

### 1.2 品質モデル

ISO/IEC 25010（SQuaRE）に基づくFURPS+モデルを採用:

- **F**unctionality: 機能要件定義書を参照
- **U**sability: ユーザビリティ要件
- **R**eliability: 信頼性要件
- **P**erformance: パフォーマンス要件
- **S**ecurity: セキュリティ要件
- **+** (Plus): 保守性、互換性、拡張性

---

## 2. パフォーマンス要件 (Performance)

### NFR-P-001: セッション一覧の表示速度

| 項目     | 内容                                                                                            |
| -------- | ----------------------------------------------------------------------------------------------- |
| 要件ID   | NFR-P-001                                                                                       |
| カテゴリ | Performance - Response Time                                                                     |
| 優先度   | Must Have                                                                                       |
| 説明     | セッション一覧を高速に表示                                                                      |
| 目標値   | 100セッション未満: 100ms以内<br>1,000セッション未満: 300ms以内<br>10,000セッション未満: 1秒以内 |
| 測定方法 | アプリ起動からサイドバー初回レンダリング完了までの時間                                          |
| 制約     | 仮想スクロール、遅延ロードを使用                                                                |

**詳細仕様**:

- 初回表示は最新50件のみロード
- スクロール時に追加で50件ずつ遅延ロード
- インデックス最適化（created_atカラム）

### NFR-P-002: メッセージ保存の応答時間

| 項目     | 内容                                               |
| -------- | -------------------------------------------------- |
| 要件ID   | NFR-P-002                                          |
| カテゴリ | Performance - Latency                              |
| 優先度   | Must Have                                          |
| 説明     | メッセージ保存処理を低遅延で実行                   |
| 目標値   | 1メッセージあたり50ms以内（P95）                   |
| 測定方法 | ユーザーメッセージ送信からDB保存完了までの時間     |
| 制約     | バッチ保存、非同期書き込み、トランザクション最適化 |

**詳細仕様**:

- 非同期書き込み（Write-Ahead Logging）
- バッチサイズ: 最大10メッセージ/バッチ
- トランザクション分離レベル: READ COMMITTED

### NFR-P-003: 検索クエリの応答時間

| 項目     | 内容                                                                              |
| -------- | --------------------------------------------------------------------------------- |
| 要件ID   | NFR-P-003                                                                         |
| カテゴリ | Performance - Query Performance                                                   |
| 優先度   | Should Have                                                                       |
| 説明     | キーワード検索を高速に実行                                                        |
| 目標値   | 10,000メッセージ未満: 200ms以内（P95）<br>100,000メッセージ未満: 500ms以内（P95） |
| 測定方法 | 検索クエリ実行から結果表示までの時間                                              |
| 制約     | FTS5インデックス、クエリ最適化                                                    |

**詳細仕様**:

- SQLite FTS5（Full-Text Search）インデックス使用
- ランキングアルゴリズム: BM25
- 検索対象: セッションタイトル、メッセージ内容（全文）

### NFR-P-004: ストレージ効率

| 項目     | 内容                                                   |
| -------- | ------------------------------------------------------ |
| 要件ID   | NFR-P-004                                              |
| カテゴリ | Performance - Storage Efficiency                       |
| 優先度   | Should Have                                            |
| 説明     | ディスク使用量を効率的に管理                           |
| 目標値   | 1,000メッセージあたり平均5MB以下（テキストのみの場合） |
| 測定方法 | データベースファイルサイズ / メッセージ総数            |
| 制約     | VACUUM定期実行、添付ファイルの外部保存                 |

**詳細仕様**:

- 週次で自動VACUUM実行（ディスク断片化解消）
- 添付ファイルは別ディレクトリに保存、DBにはパス参照のみ
- JSON圧縮（LLMメタデータ）

---

## 3. 信頼性要件 (Reliability)

### NFR-R-001: データ整合性保証

| 項目     | 内容                                       |
| -------- | ------------------------------------------ |
| 要件ID   | NFR-R-001                                  |
| カテゴリ | Reliability - Data Integrity               |
| 優先度   | Must Have                                  |
| 説明     | トランザクション保証によるデータ整合性確保 |
| 目標値   | データ損失率: 0%                           |
| 測定方法 | トランザクションロールバック率、破損検出率 |
| 制約     | ACID準拠、外部キー制約、定期バックアップ   |

**詳細仕様**:

- トランザクション境界: セッション作成 + 初期メッセージ保存
- 外部キー制約有効化（`PRAGMA foreign_keys = ON`）
- データベース整合性チェック（`PRAGMA integrity_check`）を起動時に実行
- 自動バックアップ: 日次でローカルバックアップ作成

### NFR-R-002: エラーハンドリング

| 項目     | 内容                                           |
| -------- | ---------------------------------------------- |
| 要件ID   | NFR-R-002                                      |
| カテゴリ | Reliability - Error Handling                   |
| 優先度   | Must Have                                      |
| 説明     | エラー発生時の適切なハンドリングとリトライ機構 |
| 目標値   | エラー回復率: 95%以上（一時的エラーの場合）    |
| 測定方法 | エラー回復成功数 / 総エラー発生数              |
| 制約     | リトライ戦略、フォールバック処理、エラーログ   |

**詳細仕様**:

- **リトライ戦略**:
  - Database Locked: 最大3回リトライ（Exponential Backoff）
  - Disk Full: ディスク容量確保後に再試行
  - Network Error (同期時): オフラインキューに追加
- **エラーレベル分類**:
  - `ERROR`: データ保存失敗、トランザクションエラー
  - `WARNING`: リトライ成功、一部データ欠落
  - `INFO`: 正常終了、ユーザー操作ログ
- エラーメッセージはユーザーに分かりやすく翻訳（技術詳細は非表示）

### NFR-R-003: 可用性

| 項目     | 内容                                            |
| -------- | ----------------------------------------------- |
| 要件ID   | NFR-R-003                                       |
| カテゴリ | Reliability - Availability                      |
| 優先度   | Must Have                                       |
| 説明     | オフライン環境でも履歴機能を利用可能            |
| 目標値   | 稼働率: 99.9%（ローカルアプリケーションとして） |
| 測定方法 | 利用可能時間 / 総稼働時間                       |
| 制約     | Embedded Replicas、ローカルストレージ           |

**詳細仕様**:

- Turso Embedded Replicas使用（ローカルSQLite + クラウド同期）
- オフライン時もローカルDBで全機能利用可能
- ネットワーク復帰時に自動同期（バックグラウンド）

---

## 4. ユーザビリティ要件 (Usability)

### NFR-U-001: アクセシビリティ

| 項目     | 内容                                               |
| -------- | -------------------------------------------------- |
| 要件ID   | NFR-U-001                                          |
| カテゴリ | Usability - Accessibility                          |
| 優先度   | Should Have                                        |
| 説明     | WCAG 2.1レベルAA準拠                               |
| 目標値   | WCAG 2.1 AA準拠率: 100%                            |
| 測定方法 | 自動アクセシビリティテスト（axe-core）             |
| 制約     | キーボード操作、スクリーンリーダー対応、色覚多様性 |

**詳細仕様**:

- **キーボード操作**:
  - `Cmd/Ctrl + K`: 検索ボックスにフォーカス
  - `↑/↓`: セッション一覧のナビゲーション
  - `Enter`: セッション選択
  - `Delete`: セッション削除（確認あり）
- **ARIAラベル**: すべてのインタラクティブ要素に適切な`aria-label`
- **コントラスト比**: 4.5:1以上（テキストと背景）
- **フォーカスインジケーター**: 視覚的に明確なフォーカスリング

### NFR-U-002: レスポンシブUI

| 項目     | 内容                                     |
| -------- | ---------------------------------------- |
| 要件ID   | NFR-U-002                                |
| カテゴリ | Usability - Responsive Design            |
| 優先度   | Should Have                              |
| 説明     | 様々なウィンドウサイズに対応             |
| 目標値   | 最小ウィンドウサイズ: 800x600px          |
| 測定方法 | UI崩れ発生率（視覚的回帰テスト）         |
| 制約     | サイドバー折りたたみ、リキッドレイアウト |

**詳細仕様**:

- **ブレークポイント**:
  - < 800px: サイドバー自動非表示（ハンバーガーメニュー化）
  - 800px - 1280px: 標準レイアウト
  - \> 1280px: ワイドレイアウト（サイドバー固定幅300px）
- **テキストサイズ**: ユーザー設定（小/中/大）
- **ダークモード**: システム設定に連動

### NFR-U-003: 学習容易性

| 項目     | 内容                             |
| -------- | -------------------------------- |
| 要件ID   | NFR-U-003                        |
| カテゴリ | Usability - Learnability         |
| 優先度   | Could Have                       |
| 説明     | 初回利用時のオンボーディング     |
| 目標値   | 5分以内に基本操作を習得          |
| 測定方法 | ユーザーテスト（タスク完了時間） |
| 制約     | ツールチップ、初回ガイドツアー   |

**詳細仕様**:

- 初回起動時にウォークスルーガイド表示（スキップ可）
- 主要機能にツールチップ（ホバー時に説明表示）
- 空状態メッセージ（履歴がない場合の案内）

---

## 5. セキュリティ要件 (Security)

### NFR-S-001: データ保護

| 項目     | 内容                               |
| -------- | ---------------------------------- |
| 要件ID   | NFR-S-001                          |
| カテゴリ | Security - Data Protection         |
| 優先度   | Must Have                          |
| 説明     | ローカルデータの保護               |
| 目標値   | 不正アクセス検出率: 100%           |
| 測定方法 | セキュリティ監査ログの確認         |
| 制約     | ファイルシステム権限、アクセス制御 |

**詳細仕様**:

- データベースファイルのパーミッション: `600`（所有者のみ読み書き）
- Electronセキュリティベストプラクティス適用:
  - `nodeIntegration: false`
  - `contextIsolation: true`
  - `sandbox: true`
  - CSP（Content Security Policy）設定
- メモリダンプ対策: 機密データは即座にクリア
- エクスポートファイルサイズ制限: 100MB以内（メモリ枯渇防止）
- ファイルパス検証: パストラバーサル攻撃対策を実施

**注**: データ暗号化はフェーズ1では対象外（Won't Have）ですが、ファイルシステムレベルの保護は実施

### NFR-S-002: 監査ログ

| 項目     | 内容                                     |
| -------- | ---------------------------------------- |
| 要件ID   | NFR-S-002                                |
| カテゴリ | Security - Audit Logging                 |
| 優先度   | Should Have                              |
| 説明     | 重要操作の監査ログ記録                   |
| 目標値   | 100%の重要操作をログ記録                 |
| 測定方法 | ログカバレッジ率                         |
| 制約     | ログローテーション、個人情報のマスキング |

**詳細仕様**:

- **記録対象操作**:
  - セッション作成・削除
  - メッセージ保存
  - エクスポート実行
  - エラー発生
- **ログ形式**: JSON Lines（構造化ログ）
- **ログローテーション**: 日次、最大7日分保持
- **個人情報マスキング**: メッセージ内容は記録せず、メタデータのみ

---

## 6. 保守性要件 (Maintainability)

### NFR-M-001: コードカバレッジ

| 項目     | 内容                                               |
| -------- | -------------------------------------------------- |
| 要件ID   | NFR-M-001                                          |
| カテゴリ | Maintainability - Testability                      |
| 優先度   | Must Have                                          |
| 説明     | ユニットテストのカバレッジ目標                     |
| 目標値   | Line Coverage: 80%以上<br>Branch Coverage: 70%以上 |
| 測定方法 | Vitest + Istanbul                                  |
| 制約     | テスト自動実行（CI/CD）                            |

**詳細仕様**:

- 全リポジトリクラスに対してユニットテスト作成
- TDDサイクル（Red-Green-Refactor）準拠
- モック・スタブを使用した依存関係の分離

### NFR-M-002: ログ可視性

| 項目     | 内容                                         |
| -------- | -------------------------------------------- |
| 要件ID   | NFR-M-002                                    |
| カテゴリ | Maintainability - Observability              |
| 優先度   | Should Have                                  |
| 説明     | デバッグ・トラブルシューティングのためのログ |
| 目標値   | 問題調査時間を50%短縮                        |
| 測定方法 | 平均問題解決時間（MTTR）                     |
| 制約     | ログレベル設定、構造化ログ                   |

**詳細仕様**:

- **ログレベル**:
  - `DEBUG`: 開発環境のみ（詳細トレース）
  - `INFO`: 通常操作ログ
  - `WARNING`: リトライ成功、非クリティカルエラー
  - `ERROR`: 致命的エラー、データ損失リスク
- ログ出力先: ファイル（`logs/app.log`）+ コンソール（開発時）
- エラースタックトレース自動記録

### NFR-M-003: データマイグレーション

| 項目     | 内容                                         |
| -------- | -------------------------------------------- |
| 要件ID   | NFR-M-003                                    |
| カテゴリ | Maintainability - Evolvability               |
| 優先度   | Must Have                                    |
| 説明     | データベーススキーマ変更時のマイグレーション |
| 目標値   | マイグレーション成功率: 100%                 |
| 測定方法 | マイグレーションテスト（各バージョン）       |
| 制約     | バックアップ自動作成、ロールバック可能       |

**詳細仕様**:

- Drizzle ORM マイグレーション機能使用
- マイグレーション前に自動バックアップ作成（`db.backup.YYYYMMDD_HHmmss`）
- スキーマバージョン管理（`schema_version`テーブル）
- マイグレーション失敗時は自動ロールバック

---

## 7. 互換性要件 (Compatibility)

### NFR-C-001: プラットフォーム互換性

| 項目     | 内容                            |
| -------- | ------------------------------- |
| 要件ID   | NFR-C-001                       |
| カテゴリ | Compatibility - Platform        |
| 優先度   | Must Have                       |
| 説明     | マルチプラットフォーム対応      |
| 目標値   | macOS, Windows, Linuxで100%動作 |
| 測定方法 | プラットフォーム別の自動テスト  |
| 制約     | Electron、Node.js               |

**詳細仕様**:

- **対象OS**:
  - macOS: 11.0 (Big Sur) 以降
  - Windows: 10 (64-bit) 以降
  - Linux: Ubuntu 20.04 LTS 以降
- Electron 28.x 以降
- Node.js 20.x 以降

### NFR-C-002: データフォーマット互換性

| 項目     | 内容                                |
| -------- | ----------------------------------- |
| 要件ID   | NFR-C-002                           |
| カテゴリ | Compatibility - Data Format         |
| 優先度   | Should Have                         |
| 説明     | エクスポート形式の標準準拠          |
| 目標値   | 他ツールでの読み込み成功率: 95%以上 |
| 測定方法 | 各種ツールでのインポートテスト      |
| 制約     | Markdown標準、JSON Schema           |

**詳細仕様**:

- **Markdown**: CommonMark仕様準拠
- **JSON**: JSON Schema Draft 2020-12準拠
- 文字エンコーディング: UTF-8（BOM無し）
- 改行コード: LF（`\n`）

### NFR-C-003: データベース互換性

| 項目     | 内容                                 |
| -------- | ------------------------------------ |
| 要件ID   | NFR-C-003                            |
| カテゴリ | Compatibility - Database             |
| 優先度   | Must Have                            |
| 説明     | Turso libSQLとの互換性維持           |
| 目標値   | SQLite 3.35.0以降との完全互換        |
| 測定方法 | データベーステスト（CRUD操作）       |
| 制約     | Turso Embedded Replicas、Drizzle ORM |

**詳細仕様**:

- libSQL バージョン: 0.3.x 以降
- SQLite互換モード有効化
- 拡張機能: FTS5（Full-Text Search）

---

## 8. 非機能要件サマリー

| カテゴリ        | 優先度      | 要件ID                          | 概要                                       |
| --------------- | ----------- | ------------------------------- | ------------------------------------------ |
| Performance     | Must Have   | NFR-P-001, NFR-P-002            | 高速表示、低遅延保存                       |
| Performance     | Should Have | NFR-P-003, NFR-P-004            | 高速検索、ストレージ効率                   |
| Reliability     | Must Have   | NFR-R-001, NFR-R-002, NFR-R-003 | データ整合性、エラーハンドリング、可用性   |
| Usability       | Should Have | NFR-U-001, NFR-U-002            | アクセシビリティ、レスポンシブUI           |
| Usability       | Could Have  | NFR-U-003                       | 学習容易性                                 |
| Security        | Must Have   | NFR-S-001                       | データ保護                                 |
| Security        | Should Have | NFR-S-002                       | 監査ログ                                   |
| Maintainability | Must Have   | NFR-M-001, NFR-M-003            | コードカバレッジ、データマイグレーション   |
| Maintainability | Should Have | NFR-M-002                       | ログ可視性                                 |
| Compatibility   | Must Have   | NFR-C-001, NFR-C-003            | プラットフォーム互換性、データベース互換性 |
| Compatibility   | Should Have | NFR-C-002                       | データフォーマット互換性                   |

---

## 9. 測定基準とKPI

| KPI                    | 目標値           | 測定頻度   | ツール                  |
| ---------------------- | ---------------- | ---------- | ----------------------- |
| セッション一覧表示時間 | 300ms以内（P95） | 毎リリース | Performance API         |
| メッセージ保存遅延     | 50ms以内（P95）  | 毎リリース | Custom Metrics          |
| 検索クエリ応答時間     | 500ms以内（P95） | 毎リリース | Query Profiling         |
| データ損失率           | 0%               | 継続的     | Integrity Check         |
| エラー回復率           | 95%以上          | 継続的     | Error Logs              |
| コードカバレッジ       | Line: 80%以上    | 毎PR       | Vitest + Istanbul       |
| WCAG準拠率             | AA: 100%         | 毎リリース | axe-core                |
| プラットフォーム動作率 | 100%             | 毎リリース | E2Eテスト（Playwright） |

---

## 10. 制約事項と前提条件

### 10.1 制約事項

| 制約ID | 内容                                                              |
| ------ | ----------------------------------------------------------------- |
| C-001  | データ暗号化はフェーズ1では実装しない（将来対応）                 |
| C-002  | クラウド同期はTurso Embedded Replicasの自動同期に依存             |
| C-003  | ストレージ容量は無制限ではなく、ディスク空き容量に依存            |
| C-004  | LLM APIの応答時間は外部サービスに依存（保存遅延に影響する可能性） |

### 10.2 前提条件

| 前提ID | 内容                                                         |
| ------ | ------------------------------------------------------------ |
| P-001  | ユーザーのデバイスに十分なディスク空き容量がある（最低10GB） |
| P-002  | Electronアプリケーションとして動作                           |
| P-003  | Turso Embedded Replicasが正常に動作する環境                  |
| P-004  | Node.js 20.x以降がインストールされている                     |

---

## 11. 次のステップ

- [ ] 受け入れ基準ドキュメントの作成
- [ ] パフォーマンステスト計画の策定
- [ ] セキュリティレビューの実施
- [ ] アクセシビリティテスト計画の策定
