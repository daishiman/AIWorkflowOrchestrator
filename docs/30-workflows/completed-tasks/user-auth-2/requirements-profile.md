# プロフィール管理要件定義書

## メタ情報

| 項目       | 内容                 |
| ---------- | -------------------- |
| タスクID   | T-00-1               |
| 参照元     | FR-UA-001, FR-UA-004 |
| 作成日     | 2025-12-09           |
| ステータス | 完了                 |

---

## 1. 概要

### 1.1 目的

ユーザーの基本情報（表示名、メールアドレス、アバター）を管理・永続化する機能の要件を定義する。

### 1.2 スコープ

| 含む                             | 含まない                                        |
| -------------------------------- | ----------------------------------------------- |
| 表示名の編集・保存               | OAuth連携によるプロフィール同期（T-00-2で定義） |
| メールアドレスの編集・保存       | 認証・認可機能（T-00-2, T-00-3で定義）          |
| アバター画像のアップロード・削除 | プラン管理（将来機能）                          |
| プロフィールの永続化             | 課金情報管理（将来機能）                        |

---

## 2. 機能要件

### 2.1 プロフィール表示（FR-PROFILE-001）

#### 説明

ユーザーが現在のプロフィール情報を確認できる。

#### 優先度

**Must Have**

#### 受け入れ基準

```gherkin
Feature: プロフィール表示
  ユーザーとして
  自分のプロフィール情報を確認したい
  設定画面で正確な情報が表示されることを期待する

  Scenario: プロフィール情報の表示
    Given ユーザーがアプリを起動している
    When 設定画面の「アカウント」セクションを開く
    Then 以下の情報が表示される
      | フィールド | 表示内容 |
      | 表示名 | 現在の表示名 |
      | メールアドレス | 現在のメールアドレス |
      | アバター | 現在のアバター画像またはデフォルトアイコン |
      | プラン | 現在のプラン（free/pro/enterprise） |
```

---

### 2.2 表示名編集（FR-PROFILE-002）

#### 説明

ユーザーが自分の表示名を編集できる。

#### 優先度

**Must Have**

#### 制約条件

- 最小文字数: 1文字
- 最大文字数: 50文字
- 使用可能文字: Unicode文字（絵文字含む）

#### 受け入れ基準

```gherkin
Feature: 表示名編集
  ユーザーとして
  自分の表示名を変更したい
  他のユーザーに表示される名前をカスタマイズできることを期待する

  Scenario: 表示名を正常に変更する
    Given ユーザーが設定画面を開いている
    And 現在の表示名が「旧ユーザー名」である
    When 表示名入力フィールドに「新ユーザー名」と入力する
    And フォーカスを外す（または保存ボタンをクリックする）
    Then 表示名が「新ユーザー名」に更新される
    And 成功通知「プロフィールを更新しました」が表示される
    And 変更が永続化される

  Scenario: 空の表示名を入力する
    Given ユーザーが設定画面を開いている
    When 表示名入力フィールドを空にする
    Then バリデーションエラー「表示名は必須です」が表示される
    And 変更は保存されない

  Scenario: 最大文字数を超える表示名を入力する
    Given ユーザーが設定画面を開いている
    When 51文字以上の表示名を入力する
    Then バリデーションエラー「表示名は50文字以内で入力してください」が表示される
    And 変更は保存されない
```

---

### 2.3 メールアドレス編集（FR-PROFILE-003）

#### 説明

ユーザーが自分のメールアドレスを編集できる。

#### 優先度

**Must Have**

#### 制約条件

- 有効なメールアドレス形式であること
- 最大文字数: 254文字（RFC 5321準拠）

#### 受け入れ基準

```gherkin
Feature: メールアドレス編集
  ユーザーとして
  自分のメールアドレスを変更したい
  連絡先情報を最新に保てることを期待する

  Scenario: メールアドレスを正常に変更する
    Given ユーザーが設定画面を開いている
    And 現在のメールアドレスが「old@example.com」である
    When メールアドレス入力フィールドに「new@example.com」と入力する
    And フォーカスを外す
    Then メールアドレスが「new@example.com」に更新される
    And 成功通知が表示される
    And 変更が永続化される

  Scenario: 無効なメールアドレスを入力する
    Given ユーザーが設定画面を開いている
    When メールアドレス入力フィールドに「invalid-email」と入力する
    Then バリデーションエラー「有効なメールアドレスを入力してください」が表示される
    And 変更は保存されない

  Scenario: 空のメールアドレスを入力する
    Given ユーザーが設定画面を開いている
    When メールアドレス入力フィールドを空にする
    Then バリデーションエラー「メールアドレスは必須です」が表示される
    And 変更は保存されない
```

---

### 2.4 アバター画像アップロード（FR-PROFILE-004）

#### 説明

ユーザーがローカルファイルからアバター画像をアップロードできる。

#### 優先度

**Must Have**

#### 制約条件

- 対応形式: PNG, JPG, GIF, WebP
- 最大ファイルサイズ: 5MB
- 保存時リサイズ: 128x128px

#### 受け入れ基準

```gherkin
Feature: アバター画像アップロード
  ユーザーとして
  自分のアバター画像を設定したい
  プロフィールを個性的にカスタマイズできることを期待する

  Scenario: 有効な画像をアップロードする
    Given ユーザーが設定画面を開いている
    When 「画像を変更」ボタンをクリックする
    And ファイル選択ダイアログで有効なPNG画像（2MB）を選択する
    Then 画像が128x128pxにリサイズされる
    And アバターが新しい画像に更新される
    And 成功通知が表示される
    And 画像がuserData/avatars/{userId}.pngに保存される

  Scenario: サポートされていない形式のファイルを選択する
    Given ユーザーが設定画面を開いている
    When 「画像を変更」ボタンをクリックする
    And ファイル選択ダイアログでPDFファイルを選択する
    Then エラー「PNG, JPG, GIF, WebP形式のみ対応しています」が表示される
    And アバターは変更されない

  Scenario: ファイルサイズ制限を超える画像を選択する
    Given ユーザーが設定画面を開いている
    When 「画像を変更」ボタンをクリックする
    And ファイル選択ダイアログで6MBの画像を選択する
    Then エラー「ファイルサイズは5MB以下にしてください」が表示される
    And アバターは変更されない
```

---

### 2.5 アバター画像削除（FR-PROFILE-005）

#### 説明

ユーザーがアバター画像を削除してデフォルトアイコンに戻せる。

#### 優先度

**Should Have**

#### 受け入れ基準

```gherkin
Feature: アバター画像削除
  ユーザーとして
  設定したアバター画像を削除したい
  デフォルトアイコンに戻せることを期待する

  Scenario: アバター画像を削除する
    Given ユーザーが設定画面を開いている
    And カスタムアバター画像が設定されている
    When 「アバターを削除」ボタンをクリックする
    And 確認ダイアログで「削除」を選択する
    Then アバターがデフォルトアイコンに戻る
    And 保存されていた画像ファイルが削除される
    And 成功通知が表示される

  Scenario: アバター削除をキャンセルする
    Given ユーザーが設定画面を開いている
    And カスタムアバター画像が設定されている
    When 「アバターを削除」ボタンをクリックする
    And 確認ダイアログで「キャンセル」を選択する
    Then アバターは変更されない
```

---

### 2.6 OAuth連携アバター使用（FR-PROFILE-006）

#### 説明

OAuth連携プロバイダーのアバター画像を使用できる。

#### 優先度

**Should Have**

#### 受け入れ基準

```gherkin
Feature: OAuth連携アバター使用
  ユーザーとして
  連携したGoogle/GitHubアカウントのアバターを使いたい
  既存のプロフィール画像を流用できることを期待する

  Scenario: 連携プロバイダーのアバターを使用する
    Given ユーザーが設定画面を開いている
    And Googleアカウントが連携済みである
    And Googleアカウントにアバター画像がある
    When 「Googleのアバターを使用」を選択する
    Then GoogleプロフィールのアバターURLがavatarUrlに設定される
    And アバターが更新される
```

---

## 3. データモデル要件

### 3.1 UserProfile型

```typescript
interface UserProfile {
  id: string; // UUID v4
  displayName: string; // 1-50文字
  email: string; // RFC 5321準拠
  avatarUrl: string | null; // 外部URL（OAuth連携時）
  avatarLocal: string | null; // ローカルパス
  plan: "free" | "pro" | "enterprise";
  createdAt: Date;
  updatedAt: Date;
}
```

### 3.2 永続化要件

| 項目       | 要件                              |
| ---------- | --------------------------------- |
| 保存先     | Electron userData ディレクトリ    |
| 形式       | JSON（electron-store使用推奨）    |
| 画像保存先 | `userData/avatars/{userId}.{ext}` |
| 同期       | ローカルのみ（クラウド同期なし）  |

---

## 4. UI/UX要件

### 4.1 レイアウト

```
┌─────────────────────────────────────────────────┐
│ アカウント設定                                   │
│ プロフィールを管理します                         │
├─────────────────────────────────────────────────┤
│                                                  │
│ プロフィール                                     │
│ ┌─────┐                                          │
│ │ 👤  │  [画像を変更] [削除]                     │
│ └─────┘                                          │
│                                                  │
│ 表示名                                           │
│ ┌─────────────────────────────────────────────┐ │
│ │ ユーザー名                                  │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ メールアドレス                                   │
│ ┌─────────────────────────────────────────────┐ │
│ │ user@example.com                            │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 4.2 インタラクション要件

| 操作                             | 動作                             |
| -------------------------------- | -------------------------------- |
| 入力フィールドのフォーカスアウト | 自動保存                         |
| 保存成功                         | トースト通知（3秒で自動消去）    |
| バリデーションエラー             | フィールド下部に赤字でエラー表示 |
| 画像選択                         | OSネイティブのファイルダイアログ |

### 4.3 アクセシビリティ要件

- すべての入力フィールドにラベルが関連付けられていること
- キーボードのみで全操作が可能であること
- エラーメッセージがスクリーンリーダーに通知されること
- コントラスト比がWCAG 2.1 AA基準を満たすこと

---

## 5. 非機能要件

### 5.1 パフォーマンス

| 項目             | 基準      |
| ---------------- | --------- |
| プロフィール保存 | 100ms以内 |
| アバターリサイズ | 500ms以内 |
| 画面表示         | 200ms以内 |

### 5.2 エラーハンドリング

| エラー種別       | 対応                               |
| ---------------- | ---------------------------------- |
| 保存失敗         | リトライボタン付きエラー通知       |
| 画像処理失敗     | エラーメッセージ表示、元の状態維持 |
| ディスク容量不足 | 警告メッセージ表示                 |

---

## 6. 依存関係

### 6.1 前提となるコンポーネント

- electron-store（永続化ライブラリ）
- sharp または Jimp（画像リサイズ）
- Zustand（状態管理）

### 6.2 後続タスク

- T-01-1: データモデル設計
- T-01-4: UI設計

---

## 7. 完了チェックリスト

- [x] 表示名・メール・アバターの編集要件が定義されている
- [x] 永続化の要件（保存先、形式）が定義されている
- [x] 受け入れ基準がGiven-When-Then形式で記述されている
