# AIプロバイダーAPIキー管理 - 機能要件定義書

> **ドキュメント種別**: 要件定義書
> **対象タスク**: T-00-1: 機能要件定義
> **作成日**: 2025-12-10
> **ステータス**: ドラフト

---

## 1. プロジェクト概要

### 1.1 目的

ユーザーが各AIプロバイダー（OpenAI、Anthropic、Google、xAI）のAPIキーを安全に登録・管理し、ワークフロー実行時に自動的に利用できるようにする。

### 1.2 背景

AIWorkflowOrchestratorは複数のAIプロバイダーと連携してワークフローを実行する。現在、APIキーの永続化機構が未実装のため、以下の問題が発生している：

- セッションごとにAPIキーの再入力が必要
- APIキーの安全な保存場所が定義されていない
- 複数プロバイダーのキーを一元管理できない
- キーの有効性検証機能がない

### 1.3 スコープ

#### 1.3.1 含むもの（In Scope）

| カテゴリ     | 項目                                                |
| ------------ | --------------------------------------------------- |
| 機能         | APIキーの登録（新規保存）                           |
| 機能         | APIキーの取得（復号化して利用）                     |
| 機能         | APIキーの削除                                       |
| 機能         | APIキーの有効性検証                                 |
| 機能         | 登録済みAPIキーの一覧表示                           |
| UI           | 設定画面内のAPIキー管理セクション                   |
| ストレージ   | Electron safeStorage APIによる暗号化保存            |
| プロバイダー | OpenAI、Anthropic、Google AI（Gemini）、xAI（Grok） |

#### 1.3.2 含まないもの（Out of Scope）

| 項目                         | 理由                         |
| ---------------------------- | ---------------------------- |
| サーバーサイドでのキー管理   | ローカルファースト設計のため |
| APIキーの自動ローテーション  | 複雑性回避、将来対応         |
| 課金管理・使用量トラッキング | 別機能として切り出し         |
| APIキーの共有機能            | セキュリティリスク回避       |

### 1.4 ステークホルダー

| 役割           | 関心事項                             |
| -------------- | ------------------------------------ |
| エンドユーザー | 簡単にAPIキーを登録・管理できること  |
| 開発者         | 既存アーキテクチャと整合性のある実装 |
| セキュリティ   | APIキーの安全な保存・漏洩防止        |

---

## 2. 対応AIプロバイダー

| プロバイダー | APIキー形式         | 検証エンドポイント | 備考                       |
| ------------ | ------------------- | ------------------ | -------------------------- |
| OpenAI       | `sk-...` (51文字〜) | `/v1/models`       | GPT-4, GPT-3.5-turbo等     |
| Anthropic    | `sk-ant-...`        | `/v1/messages`     | Claude 3.5, Claude 3等     |
| Google AI    | APIキー文字列       | Gemini API         | Gemini Pro, Gemini Flash等 |
| xAI          | `xai-...`           | Grok API           | Grok-1, Grok-2等           |

---

## 3. 機能要件（FR: Functional Requirements）

### FR-001: APIキー登録

**概要**: ユーザーがUIからAIプロバイダーのAPIキーを登録する

**優先度**: Must have

**詳細**:

- システムは、ユーザーがプロバイダーを選択し、APIキーを入力したとき、そのキーを暗号化して保存する
- 入力: プロバイダー種別（enum）、APIキー（文字列）
- 処理: Zodバリデーション → 有効性検証（オプション） → safeStorage暗号化 → electron-store保存
- 出力: 保存成功/失敗の結果

**ビジネスルール**:

- 同一プロバイダーに対しては1つのAPIキーのみ保存可能（上書き更新）
- APIキーは空文字列や空白のみの入力は拒否
- 保存前の検証はユーザーが選択可能（検証なしでの保存も可）

**受け入れ基準**:

```gherkin
Scenario: 有効なAPIキーの登録（正常系）
  Given ユーザーがSettings画面のAPIキー管理セクションを開いている
  And OpenAIプロバイダーが選択されている
  When ユーザーが有効なAPIキー "sk-test1234567890abcdef" を入力する
  And 「保存」ボタンをクリックする
  Then APIキーが暗号化されて保存される
  And 「保存しました」のトースト通知が表示される
  And 一覧にOpenAIが「登録済み」と表示される

Scenario: 空のAPIキーで登録を試みる（異常系）
  Given ユーザーがSettings画面のAPIキー管理セクションを開いている
  When ユーザーが空のAPIキーを入力する
  And 「保存」ボタンをクリックする
  Then 「APIキーを入力してください」のエラーメッセージが表示される
  And APIキーは保存されない

Scenario: 既存APIキーの上書き更新
  Given OpenAIのAPIキーが既に登録されている
  When ユーザーが新しいAPIキーを入力して保存する
  Then 古いAPIキーが削除される
  And 新しいAPIキーが保存される
```

---

### FR-002: APIキー取得

**概要**: システムがワークフロー実行時に保存されたAPIキーを取得する

**優先度**: Must have

**詳細**:

- システムは、プロバイダー種別を指定されたとき、対応するAPIキーを復号化して返す
- 入力: プロバイダー種別（enum）
- 処理: electron-store読み取り → safeStorage復号化
- 出力: APIキー（文字列）または null（未登録の場合）

**ビジネスルール**:

- 復号化したAPIキーはメモリ上でのみ保持し、ログ出力は禁止
- 取得失敗時はnullを返し、例外は発生させない

**受け入れ基準**:

```gherkin
Scenario: 登録済みAPIキーの取得（正常系）
  Given OpenAIのAPIキーが登録されている
  When システムがOpenAIのAPIキーを要求する
  Then 復号化されたAPIキーが返される

Scenario: 未登録プロバイダーのAPIキー取得
  Given xAIのAPIキーが登録されていない
  When システムがxAIのAPIキーを要求する
  Then nullが返される

Scenario: APIキーがログに出力されない
  Given 任意のAPIキーが登録されている
  When システムがAPIキーを取得する
  Then コンソールログにAPIキーの値が出力されない
```

---

### FR-003: APIキー削除

**概要**: ユーザーがUIから登録済みのAPIキーを削除する

**優先度**: Must have

**詳細**:

- システムは、ユーザーが削除を確認したとき、指定プロバイダーのAPIキーを削除する
- 入力: プロバイダー種別（enum）
- 処理: 確認ダイアログ表示 → electron-storeからエントリ削除
- 出力: 削除成功/失敗の結果

**ビジネスルール**:

- 削除前に確認ダイアログを表示する
- 削除操作は元に戻せない（アンドゥ不可）

**受け入れ基準**:

```gherkin
Scenario: APIキーの削除（正常系）
  Given OpenAIのAPIキーが登録されている
  When ユーザーがOpenAIの「削除」ボタンをクリックする
  And 確認ダイアログで「削除」を選択する
  Then OpenAIのAPIキーが削除される
  And 一覧からOpenAIが「未登録」に変わる
  And 「削除しました」のトースト通知が表示される

Scenario: 削除のキャンセル
  Given OpenAIのAPIキーが登録されている
  When ユーザーがOpenAIの「削除」ボタンをクリックする
  And 確認ダイアログで「キャンセル」を選択する
  Then APIキーは削除されない
  And 一覧に変更はない
```

---

### FR-004: APIキー有効性検証

**概要**: ユーザーがAPIキーの有効性を検証する

**優先度**: Should have

**詳細**:

- システムは、ユーザーが検証を要求したとき、各プロバイダーのAPIを呼び出して有効性を確認する
- 入力: プロバイダー種別（enum）、APIキー（文字列）
- 処理: プロバイダー固有のエンドポイントにリクエスト → 応答を解析
- 出力: 有効/無効/検証失敗（ネットワークエラー等）

**プロバイダー別検証方法**:
| プロバイダー | 検証方法 | 成功判定 |
|-------------|---------|---------|
| OpenAI | GET /v1/models | HTTP 200 |
| Anthropic | POST /v1/messages（最小リクエスト） | HTTP 200 |
| Google AI | models.list API | HTTP 200 |
| xAI | models エンドポイント | HTTP 200 |

**ビジネスルール**:

- 検証中はローディング状態を表示
- タイムアウトは10秒
- ネットワークエラー時は「検証できませんでした」と表示し、保存は許可する

**受け入れ基準**:

```gherkin
Scenario: 有効なAPIキーの検証（正常系）
  Given ユーザーがOpenAIの有効なAPIキーを入力している
  When 「検証」ボタンをクリックする
  Then ローディング状態が表示される
  And 3秒以内に「有効なAPIキーです」と表示される
  And チェックマークアイコンが表示される

Scenario: 無効なAPIキーの検証（異常系）
  Given ユーザーがOpenAIの無効なAPIキーを入力している
  When 「検証」ボタンをクリックする
  Then 「無効なAPIキーです」とエラーメッセージが表示される
  And バツ印アイコンが表示される

Scenario: ネットワークエラー時の検証
  Given ネットワーク接続がない状態
  When ユーザーが「検証」ボタンをクリックする
  Then 「検証できませんでした。ネットワーク接続を確認してください」と表示される
  And 「検証せずに保存」ボタンが表示される

Scenario: 検証タイムアウト
  Given APIサーバーが応答しない状態
  When ユーザーが「検証」ボタンをクリックする
  And 10秒経過する
  Then 「検証がタイムアウトしました」と表示される
```

---

### FR-005: APIキー一覧表示

**概要**: ユーザーが登録済みのAPIキー状態を一覧で確認する

**優先度**: Must have

**詳細**:

- システムは、Settings画面を表示したとき、全プロバイダーの登録状態を一覧表示する
- 入力: なし（画面表示トリガー）
- 処理: 全プロバイダーの登録状態を取得
- 出力: プロバイダー一覧（各プロバイダーの登録有無）

**ビジネスルール**:

- APIキーの値自体は表示しない（マスク表示も不要、登録有無のみ）
- 4つのプロバイダーを固定で表示（登録/未登録を明示）

**受け入れ基準**:

```gherkin
Scenario: 一覧表示（正常系）
  Given OpenAIとAnthropicのAPIキーが登録されている
  And GoogleとxAIのAPIキーは未登録
  When ユーザーがSettings画面のAPIキー管理セクションを開く
  Then 以下の一覧が表示される:
    | プロバイダー | 状態 |
    | OpenAI | 登録済み |
    | Anthropic | 登録済み |
    | Google AI | 未登録 |
    | xAI | 未登録 |

Scenario: 全て未登録の状態
  Given いずれのAPIキーも登録されていない
  When ユーザーがSettings画面のAPIキー管理セクションを開く
  Then 全プロバイダーが「未登録」と表示される
  And 「APIキーを登録してワークフローを実行しましょう」のガイドメッセージが表示される
```

---

## 4. 用語集

| 用語             | 定義                                              |
| ---------------- | ------------------------------------------------- |
| APIキー          | AIプロバイダーが発行する認証用の秘密文字列        |
| プロバイダー     | AIサービスを提供する事業者（OpenAI、Anthropic等） |
| safeStorage      | ElectronのOS提供キーチェーンを使用した暗号化API   |
| electron-store   | Electronアプリ向けの永続化ストレージライブラリ    |
| IPC              | Inter-Process Communication（プロセス間通信）     |
| Main Process     | Electronのメインプロセス（Node.js環境）           |
| Renderer Process | ElectronのレンダラープロセスI（Chromium環境）     |

---

## 5. 制約条件

### 5.1 技術的制約

| 制約                                  | 理由                                           |
| ------------------------------------- | ---------------------------------------------- |
| Electron Main Processでのみ暗号化処理 | safeStorage APIはMain Processでのみ利用可能    |
| electron-store使用                    | 既存実装（secureStorage.ts）との一貫性         |
| IPC経由でのアクセス                   | Rendererからの直接アクセスはセキュリティ上禁止 |
| TypeScript strict mode                | プロジェクト標準                               |
| Zodバリデーション                     | プロジェクト標準                               |

### 5.2 セキュリティ制約

| 制約                            | 理由                        |
| ------------------------------- | --------------------------- |
| APIキーのログ出力禁止           | 漏洩防止                    |
| Renderer側でのAPIキー値表示禁止 | XSS等の攻撃対策             |
| contextIsolation: true          | preloadスクリプトの分離必須 |

---

## 6. 依存関係

### 6.1 既存実装への依存

| 既存実装                                                | 参照目的                     |
| ------------------------------------------------------- | ---------------------------- |
| `apps/desktop/src/main/infrastructure/secureStorage.ts` | 暗号化パターンの踏襲         |
| `apps/desktop/src/main/ipc/authHandlers.ts`             | IPCハンドラーパターンの踏襲  |
| `apps/desktop/src/main/ipc/validation.ts`               | withValidationパターンの活用 |

### 6.2 外部依存

| ライブラリ     | バージョン | 用途             |
| -------------- | ---------- | ---------------- |
| electron       | ^33.x      | safeStorage API  |
| electron-store | ^8.x       | 永続化ストレージ |
| zod            | ^3.x       | バリデーション   |

---

## 7. 次フェーズへの引き継ぎ

### 7.1 設計フェーズ（T-01-1）への入力

- 本要件定義書の全機能要件（FR-001〜FR-005）
- プロバイダー列挙型の定義
- IPC チャネル設計の方針

### 7.2 テストフェーズ（T-03-\*）への入力

- 各受け入れ基準（Given-When-Then形式）
- 境界値テストケースの候補
- エラーケースのパターン

---

## 8. 品質メトリクス

| メトリクス   | 目標値  | 測定方法                         |
| ------------ | ------- | -------------------------------- |
| 要件の明確性 | 90%以上 | 曖昧な表現の除去率               |
| 要件の完全性 | 100%    | 全FR/NFRにIDと受け入れ基準がある |
| 要件の一貫性 | 100%    | 要件間の矛盾がゼロ               |
| テスト変換率 | 100%    | 受け入れ基準からテストへの変換率 |

---

## 変更履歴

| バージョン | 日付       | 変更内容 | 作成者       |
| ---------- | ---------- | -------- | ------------ |
| 1.0.0      | 2025-12-10 | 初版作成 | .claude/agents/req-analyst.md |
