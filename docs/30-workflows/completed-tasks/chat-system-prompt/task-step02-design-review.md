# システムプロンプト設定機能 - 設計レビューレポート

## メタ情報

| 項目           | 内容                  |
| -------------- | --------------------- |
| ドキュメントID | DR-CHAT-SYSPROMPT-001 |
| 作成日         | 2025-12-25            |
| レビュー担当   | Claude (Architect)    |
| 関連タスク     | T-02-1                |

---

## 1. レビュー対象

| ドキュメント           | パス                                 | ステータス |
| ---------------------- | ------------------------------------ | ---------- |
| 要件定義書             | `task-step00-requirements.md`        | レビュー済 |
| UI設計書               | `task-step01-ui-design.md`           | レビュー済 |
| 状態管理設計書         | `task-step01-state-management.md`    | レビュー済 |
| テンプレート管理設計書 | `task-step01-template-management.md` | レビュー済 |

---

## 2. レビュー結果サマリー

| 判定   | **PASS** |
| ------ | -------- |
| 重大度 | なし     |

**総評**: 設計は全体的に妥当であり、既存システムとの整合性も取れている。軽微な改善提案はあるが、実装を阻害するものではない。Phase 3（テスト作成）へ進行可能。

---

## 3. レビューチェックリスト

### 3.1 要件の妥当性

| チェック項目                   | 結果 | コメント                                           |
| ------------------------------ | ---- | -------------------------------------------------- |
| 要件が明確で曖昧さがない       | ✅   | 5つのユーザーストーリーが明確に定義されている      |
| スコープが適切に定義されている | ✅   | スコープ内/外が明確に区別されている                |
| 受け入れ基準が検証可能である   | ✅   | 各ユーザーストーリーに検証可能な受け入れ基準がある |

**要件評価**: 要件定義書は十分な詳細度を持ち、実装の指針として適切。

### 3.2 設計の妥当性

| チェック項目                     | 結果 | コメント                                                     |
| -------------------------------- | ---- | ------------------------------------------------------------ |
| UI設計が要件を満たしている       | ✅   | 全ての機能要件（FR-001〜FR-017）に対応するUIが設計されている |
| 状態管理設計が適切である         | ✅   | ChatSlice拡張とSystemPromptTemplateSlice分離は適切           |
| テンプレート管理設計が適切である | ✅   | 既存のelectron-store基盤を活用した設計は妥当                 |
| 既存システムとの整合性がある     | ✅   | 既存のZustand Sliceパターン、Atomic Design原則に準拠         |

**設計評価**:

1. **UI設計**: Atomic Designパターンに従い、既存コンポーネント（GlassPanel, Button, Input）を再利用。新規コンポーネントの責務分離も適切。

2. **状態管理設計**:
   - ChatSlice拡張（systemPrompt, selectedTemplateId）は妥当
   - SystemPromptTemplateSlice分離による関心の分離は良い設計
   - Selector Hooksの追加によりパフォーマンス最適化を考慮

3. **テンプレート管理設計**:
   - 既存の `store:get/set` IPCチャンネルを活用し、新規IPC追加を回避
   - Date型のシリアライズ/デシリアライズ処理が明確

### 3.3 実装可能性

| チェック項目                 | 結果 | コメント                                             |
| ---------------------------- | ---- | ---------------------------------------------------- |
| 技術的に実装可能である       | ✅   | 使用技術は全て既存プロジェクトで実績あり             |
| パフォーマンス要件を満たせる | ✅   | NFR-001〜003（100ms/200ms/50ms）は十分達成可能       |
| セキュリティリスクがない     | ✅   | テンプレートは平文保存（機密性低）、警告UIも設計済み |

**実装可能性評価**: 全ての技術要件は既存のコードベースとスキルセットで対応可能。

### 3.4 保守性

| チェック項目                   | 結果 | コメント                                                |
| ------------------------------ | ---- | ------------------------------------------------------- |
| コードが保守しやすい構造である | ✅   | Atomic Design + Sliceパターンで保守性を確保             |
| テストが書きやすい設計である   | ✅   | 各Slice、サービス、バリデーション関数が独立しテスト容易 |

**保守性評価**: 既存の設計パターンを踏襲しており、チーム（または個人開発者）が容易に理解・保守できる。

---

## 4. 指摘事項

### 4.1 MINOR（軽微な改善提案）

#### M-001: ファイル名の統一

**対象**: テンプレート管理設計書

**現状**:

- タスク仕様書では `task-step01-template-design.md` と記載
- 実際のファイル名は `task-step01-template-management.md`

**提案**: ファイル名を統一する（どちらかに合わせる）

**対応**: 実装時に統一する（軽微なため設計変更不要）

---

#### M-002: systemPromptUpdatedAt の null 許容

**対象**: 状態管理設計書

**現状**: `systemPromptUpdatedAt: Date | null` と定義

**考慮点**: 初回ロード時に `null` の場合、UI表示で「更新日時: なし」等の表示が必要になる可能性

**提案**: 初期値を設定する（例: アプリインストール日時）か、UIで適切にハンドリング

**対応**: UI実装時に「最終更新日時なし」のケースをハンドリング

---

#### M-003: テンプレート削除の確認ダイアログ

**対象**: UI設計書

**現状**: テンプレート削除時の確認ダイアログが明示的に設計されていない

**提案**: 既存の `DeleteConfirmDialog` パターンを参考に、テンプレート削除確認を追加

**対応**: UI実装時に追加（既存パターンを再利用）

---

### 4.2 MAJOR/CRITICAL（重大な問題）

**なし**

---

## 5. 設計決定の記録

### 5.1 状態管理の分離方針

**決定**: システムプロンプト状態はChatSliceに統合、テンプレート管理は別Sliceに分離

**理由**:

- systemPromptは現在のチャットセッションに密接に関連するためChatSliceが適切
- テンプレートはセッション横断で管理されるため独立Sliceが適切
- 関心の分離（Separation of Concerns）の原則に従う

### 5.2 永続化層の選択

**決定**:

- システムプロンプト → Zustand persist (localStorage)
- テンプレート → electron-store (JSON file)

**理由**:

- システムプロンプトはセッション間で復元が望ましい（persist）
- テンプレートはユーザーデータであり、electron-storeで確実に永続化

### 5.3 プリセットテンプレートの管理

**決定**: プリセットはコード内定数として管理（DBやファイルではない）

**理由**:

- プリセットは開発者が管理するため、バージョン管理対象
- 変更時はアプリアップデートで反映
- ユーザーによる編集・削除を防止

---

## 6. リスクアセスメント

| リスク                                | 可能性 | 影響度 | 対策                                    |
| ------------------------------------- | ------ | ------ | --------------------------------------- |
| テンプレートデータ破損                | 低     | 中     | フォールバック戦略を設計済み            |
| システムプロンプトが長すぎる          | 中     | 低     | 4000文字制限と警告UIを設計済み          |
| LLMプロバイダー間のプロンプト形式差異 | 低     | 低     | 各プロバイダーは標準的なsystem role対応 |

**総合評価**: リスクは全て許容範囲内。設計段階で適切な対策が講じられている。

---

## 7. 次フェーズへの推奨事項

### 7.1 実装優先順位

1. **状態管理（ChatSlice拡張）** - 他コンポーネントの基盤
2. **定数・型定義** - 型安全性の確保
3. **テンプレートストレージサービス** - 永続化層
4. **UIコンポーネント（Atom → Molecule → Organism）** - ボトムアップ
5. **ChatView統合** - 最終統合

### 7.2 テスト戦略

1. **単体テスト（Red-Green-Refactor）**:
   - Sliceの各アクション
   - バリデーション関数
   - ストレージサービス

2. **コンポーネントテスト**:
   - 各UIコンポーネントのレンダリング
   - ユーザーインタラクション

3. **統合テスト**:
   - テンプレート保存→読み込み→適用フロー
   - システムプロンプト→LLM送信フロー

---

## 8. 結論

| 項目           | 結果                             |
| -------------- | -------------------------------- |
| **判定**       | **PASS**                         |
| **次フェーズ** | Phase 3: テスト作成 (TDD: Red)   |
| **条件**       | なし（軽微な指摘は実装時に対応） |

設計レビューは完了し、実装フェーズへ進行可能です。

---

## 更新履歴

| 日付       | 版  | 変更内容 | 作成者 |
| ---------- | --- | -------- | ------ |
| 2025-12-25 | 1.0 | 初版作成 | Claude |
