# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¢ãƒã‚¿ãƒ¼æ©Ÿèƒ½å®Œå…¨å®Ÿè£… - ã‚¿ã‚¹ã‚¯å®Ÿè¡Œä»•æ§˜æ›¸

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…ƒã®æŒ‡ç¤º

```
@docs/30-workflows/unassigned-task/task-00-profile-persistence-bugfix.md ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
@.kamui/prompt/custom-prompt.txt ã«è½ã¨ã—è¾¼ã‚“ã§ã€‚
CRUDã®ä¸€é€£ã®å‡¦ç†ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã»ã—ã„ã€‚ç”»é¢ã‚‚å«ã‚ã¦ã€‚
```

## ãƒ¡ã‚¿æƒ…å ±

| é …ç›®         | å†…å®¹                                   |
| ------------ | -------------------------------------- |
| ã‚¿ã‚¹ã‚¯ID     | TASK-PROFILE-CRUD-00                   |
| ã‚¿ã‚¹ã‚¯å     | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¢ãƒã‚¿ãƒ¼æ©Ÿèƒ½å®Œå…¨å®Ÿè£…     |
| åˆ†é¡         | ãƒã‚°ä¿®æ­£ + æ©Ÿèƒ½æ‹¡å¼µ                    |
| å¯¾è±¡æ©Ÿèƒ½     | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« CRUD + ãƒ‡ãƒ¼ã‚¿åŒæœŸ |
| å„ªå…ˆåº¦       | æœ€é«˜ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰                     |
| è¦‹ç©ã‚‚ã‚Šè¦æ¨¡ | ä¸­è¦æ¨¡                                 |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹   | å®Ÿæ–½ä¸­                                 |
| ç™ºè¦‹å…ƒ       | ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Š + ã‚³ãƒ¼ãƒ‰èª¿æŸ»              |
| ç™ºè¦‹æ—¥       | 2025-12-10                             |

---

## 1. ãªãœã“ã®ã‚¿ã‚¹ã‚¯ãŒå¿…è¦ã‹ï¼ˆWhyï¼‰

### 1.1 èƒŒæ™¯

ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¢ãƒã‚¿ãƒ¼ç®¡ç†æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚‹ï¼š

1. **æ°¸ç¶šåŒ–ãƒã‚°**: `user_profiles`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨`user_metadata`ï¼ˆSupabase Authï¼‰ã®åŒæœŸãŒå–ã‚Œã¦ã„ãªã„
2. **CRUDä¸å®Œå…¨**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å‰Šé™¤ï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼‰æ©Ÿèƒ½ãŒæœªå®Ÿè£…
3. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: 2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒç‹¬ç«‹ã—ã¦æ›´æ–°ã•ã‚Œã¦ãŠã‚Šã€ä¸€è²«æ€§ãŒãªã„

### 1.2 ç¾çŠ¶ã®å®Ÿè£…çŠ¶æ³

| æ“ä½œ       | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«                 | ã‚¢ãƒã‚¿ãƒ¼                               | UI          |
| ---------- | ---------------------------- | -------------------------------------- | ----------- |
| **Create** | âš ï¸ è‡ªå‹•ä½œæˆã®ã¿              | N/A                                    | âœ… å®Ÿè£…æ¸ˆã¿ |
| **Read**   | âœ… å®Ÿè£…æ¸ˆã¿                  | âœ… å®Ÿè£…æ¸ˆã¿                            | âœ… å®Ÿè£…æ¸ˆã¿ |
| **Update** | âœ… å®Ÿè£…æ¸ˆã¿ **ï¼ˆåŒæœŸãƒã‚°ï¼‰** | âœ… å®Ÿè£…æ¸ˆã¿ **ï¼ˆåŒæœŸãƒã‚°ï¼‰**           | âœ… å®Ÿè£…æ¸ˆã¿ |
| **Delete** | âŒ æœªå®Ÿè£…                    | âš ï¸ å®Ÿè£…æ¸ˆã¿ **ï¼ˆåŒæœŸãƒã‚°: åŠ¹ã‹ãªã„ï¼‰** | âš ï¸ éƒ¨åˆ†å®Ÿè£… |

### 1.3 å•é¡Œç®‡æ‰€

```
profileHandlers.ts:256-328
  - profile:update ãŒ user_profiles ã®ã¿æ›´æ–°
  - user_metadata ã‚’æ›´æ–°ã—ãªã„ â†’ æ°¸ç¶šåŒ–ã•ã‚Œãªã„

avatarHandlers.ts:162-178, 266-282, 354-359
  - avatar:upload/use-provider/remove ãŒ user_metadata ã®ã¿æ›´æ–°
  - user_profiles.avatar_url ã‚’æ›´æ–°ã—ãªã„ â†’ ä¸æ•´åˆç™ºç”Ÿ

avatarHandlers.ts:305-387 (avatar:remove)
  â˜… ç‰¹ã«é‡è¦ãªå•é¡Œ â˜…
  - user_metadata.avatar_url = null ã®ã¿æ›´æ–°
  - user_profiles.avatar_url ã¯æ›´æ–°ã•ã‚Œãªã„
  - â†’ å‰Šé™¤ã—ã¦ã‚‚ user_profiles ã‹ã‚‰å¤ã„URLãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
  - â†’ ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤ãŒåŠ¹ã‹ãªã„åŸå› 
```

### 1.4 è¿½åŠ è¦ä»¶ï¼ˆ2025-12-10ï¼‰

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è¿½åŠ æŒ‡ç¤º:**

1. **ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼ˆè«–ç†å‰Šé™¤ï¼‰**: å®Œå…¨å‰Šé™¤ã§ã¯ãªãå¾©å…ƒå¯èƒ½ã«ï¼ˆç®¡ç†è€…ç”¨ãƒ¡ãƒ¼ãƒ«å¯¾å¿œã®ãŸã‚ï¼‰
2. **ProfileCache = UserProfile å‹çµ±ä¸€**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨å‹ã‚’å®Œå…¨åŒæœŸ
3. **ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤ã®ä¿®æ­£**: å…¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆuser_profiles, user_metadata, cacheï¼‰ã‚’åŒæœŸ

### 1.5 æ”¾ç½®ã—ãŸå ´åˆã®å½±éŸ¿

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¤‰æ›´ãŒä¿å­˜ã•ã‚Œãšã€ä¿¡é ¼æ€§ãŒè‘—ã—ãä½ä¸‹
- ã‚¢ãƒ—ãƒªå†èµ·å‹•ã§å¤‰æ›´ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹
- ä»–ã®ã‚¿ã‚¹ã‚¯ï¼ˆTASK-01ã€œ04ï¼‰ã®å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œãªã„

---

## 2. ä½•ã‚’é”æˆã™ã‚‹ã‹ï¼ˆWhatï¼‰

### 2.1 ç›®çš„

1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®å¤‰æ›´ãŒæ­£ã—ãæ°¸ç¶šåŒ–ã•ã‚Œã‚‹ã‚ˆã†ã€ãƒ‡ãƒ¼ã‚¿åŒæœŸå•é¡Œã‚’ä¿®æ­£
2. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€CRUDæ“ä½œã‚’å®Œå…¨åŒ–
3. UIã«å‰Šé™¤ç¢ºèªæ©Ÿèƒ½ã‚’è¿½åŠ 

### 2.2 æœ€çµ‚ã‚´ãƒ¼ãƒ«

1. **Create**: åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ­£ã—ãä½œæˆã•ã‚Œã‚‹ï¼ˆæ—¢å­˜ï¼‰
2. **Read**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¢ãƒã‚¿ãƒ¼æƒ…å ±ãŒæ­£ã—ãå–å¾—ã•ã‚Œã‚‹ï¼ˆæ—¢å­˜ï¼‰
3. **Update**: å¤‰æ›´ãŒ`user_profiles`ã¨`user_metadata`ã®ä¸¡æ–¹ã«åŒæœŸã•ã‚Œã‚‹
4. **Delete**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ãŒå‹•ä½œã—ã€UIã‹ã‚‰å®Ÿè¡Œå¯èƒ½

### 2.3 ã‚¹ã‚³ãƒ¼ãƒ—

#### å«ã‚€ã‚‚ã®

- `profileHandlers.ts`ã®ä¿®æ­£ï¼ˆuser_metadataåŒæœŸè¿½åŠ ï¼‰
- `avatarHandlers.ts`ã®ä¿®æ­£ï¼ˆuser_profilesåŒæœŸè¿½åŠ ï¼‰
- åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®ä½œæˆ
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ–°è¦å®Ÿè£…
- AccountSectionã¸ã®å‰Šé™¤UIè¿½åŠ 
- æ—¢å­˜ãƒ†ã‚¹ãƒˆã®ä¿®æ­£ãƒ»è¿½åŠ 
- å›å¸°ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

#### å«ã¾ãªã„ã‚‚ã®

- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é€£æºè¿½åŠ ï¼ˆElectronåˆ¶ç´„ã§åˆ¥ã‚¿ã‚¹ã‚¯ï¼‰
- Tursoï¼ˆãƒ­ãƒ¼ã‚«ãƒ«DBï¼‰ã¸ã®ç§»è¡Œ
- æ–°è¦ç”»é¢ã®ä½œæˆï¼ˆæ—¢å­˜AccountSectionã‚’æ‹¡å¼µï¼‰

### 2.4 æˆæœç‰©ä¸€è¦§

| ç¨®åˆ¥           | æˆæœç‰©               | é…ç½®å…ˆ                                                           |
| -------------- | -------------------- | ---------------------------------------------------------------- |
| è¨­è¨ˆæ›¸         | ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­è¨ˆ       | `docs/30-workflows/profile-persistence-bugfix/design/`           |
| ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ | profileSync.ts       | `apps/desktop/src/main/infrastructure/profileSync.ts`            |
| ä¿®æ­£ã‚³ãƒ¼ãƒ‰     | profileHandlers.ts   | `apps/desktop/src/main/ipc/profileHandlers.ts`                   |
| ä¿®æ­£ã‚³ãƒ¼ãƒ‰     | avatarHandlers.ts    | `apps/desktop/src/main/ipc/avatarHandlers.ts`                    |
| æ–°è¦ã‚³ãƒ¼ãƒ‰     | deleteAccountHandler | `apps/desktop/src/main/ipc/profileHandlers.ts`å†…                 |
| UIä¿®æ­£         | AccountSection       | `apps/desktop/src/renderer/components/organisms/AccountSection/` |
| ãƒ†ã‚¹ãƒˆ         | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ       | `apps/desktop/src/main/ipc/*.test.ts`                            |

---

## 3. ã©ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã‹ï¼ˆHowï¼‰

### 3.1 å‰ææ¡ä»¶

- Supabaseèªè¨¼ãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨
- æ—¢å­˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¢ãƒã‚¿ãƒ¼æ©Ÿèƒ½ãŒãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã“ã¨
- desktopãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒãŒå‹•ä½œã™ã‚‹ã“ã¨

### 3.2 ä¾å­˜ã‚¿ã‚¹ã‚¯

- ãªã—ï¼ˆã“ã®ã‚¿ã‚¹ã‚¯ãŒä»–ã®ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã®ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰

### 3.3 å¿…è¦ãªçŸ¥è­˜ãƒ»ã‚¹ã‚­ãƒ«

- Supabase Auth APIï¼ˆ`updateUser`, `getUser`, `admin.deleteUser`ï¼‰
- Supabase PostgreSQLï¼ˆ`user_profiles`ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œï¼‰
- Electron IPC ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- React / Redux Toolkit
- TypeScript

### 3.4 æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

1. **è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º**: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»åŒæœŸæˆ¦ç•¥ã‚’è¨­è¨ˆ
2. **TDDã‚µã‚¤ã‚¯ãƒ«**: ãƒ†ã‚¹ãƒˆä½œæˆ â†’ å®Ÿè£… â†’ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
3. **æ®µéšçš„å®Ÿè£…**: åŒæœŸä¿®æ­£ â†’ å‰Šé™¤æ©Ÿèƒ½ â†’ UI

---

## 4. å®Ÿè¡Œæ‰‹é †

### Phaseæ§‹æˆ

```
Phase 0: è¦ä»¶å®šç¾©ï¼ˆå®Œäº†ï¼‰
  â†“
Phase 1: è¨­è¨ˆ
  â†“
Phase 1.5: è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒˆ
  â†“
Phase 2: ãƒ†ã‚¹ãƒˆä½œæˆ (TDD: Red)
  â†“
Phase 3: å®Ÿè£… (TDD: Green)
  â†“
Phase 4: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (TDD: Refactor)
  â†“
Phase 5: å“è³ªä¿è¨¼
  â†“
Phase 5.5: æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒˆ
  â†“
Phase 6: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
```

---

## Phase 1: è¨­è¨ˆ

### T-01-1: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»åŒæœŸæˆ¦ç•¥è¨­è¨ˆ

#### ç›®çš„

`user_profiles`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨`user_metadata`ã®åŒæ–¹å‘åŒæœŸæˆ¦ç•¥ã‚’è¨­è¨ˆã™ã‚‹ã€‚

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:design-architecture profile-sync
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/arch-police.md`
- **é¸å®šç†ç”±**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã®å°‚é–€å®¶
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### æ´»ç”¨ã‚¹ã‚­ãƒ«

| ã‚¹ã‚­ãƒ«å                      | æ´»ç”¨æ–¹æ³•                     |
| ----------------------------- | ---------------------------- |
| .claude/skills/clean-architecture-principles/SKILL.md | ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã€ä¾å­˜æ–¹å‘ã®è¨­è¨ˆ |
| .claude/skills/solid-principles/SKILL.md              | å˜ä¸€è²¬å‹™ã€ä¾å­˜æ€§é€†è»¢         |

- **å‚ç…§**: `.claude/skills/skill_list.md`

#### è¨­è¨ˆå†…å®¹

##### 4.1.1 ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è²¬å‹™åˆ†é›¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      user_profiles          â”‚        user_metadata          â”‚
â”‚    (PostgreSQL DB)          â”‚      (Supabase Auth)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - display_name              â”‚ - display_name                â”‚
â”‚ - email                     â”‚ - avatar_url                  â”‚
â”‚ - avatar_url                â”‚ - avatar_source               â”‚
â”‚ - plan                      â”‚ - name (OAuthç”±æ¥)            â”‚
â”‚ - created_at                â”‚ - full_name (OAuthç”±æ¥)       â”‚
â”‚ - updated_at                â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 4.1.2 åŒæœŸæˆ¦ç•¥

```
ã€ãƒ—ãƒ©ã‚¤ãƒãƒªã‚½ãƒ¼ã‚¹ã€‘
- user_profiles ãƒ†ãƒ¼ãƒ–ãƒ« = Primary Source of Truth
- user_metadata = ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥

ã€åŒæœŸãƒ«ãƒ¼ãƒ«ã€‘
1. profile:update æ™‚
   â†’ user_profiles æ›´æ–° (Primary)
   â†’ user_metadata åŒæœŸ (Secondary)
   â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°

2. avatar:* æ“ä½œæ™‚
   â†’ user_metadata æ›´æ–° (èªè¨¼æƒ…å ±)
   â†’ user_profiles.avatar_url åŒæœŸ (DB)
   â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°

3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
   â†’ user_profiles ä¸åœ¨æ™‚ã¯ user_metadata ã‹ã‚‰å¾©å…ƒ
```

##### 4.1.3 åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£è¨­è¨ˆ

```typescript
// apps/desktop/src/main/infrastructure/profileSync.ts

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * - user_profiles ã¨ user_metadata ã®åŒæ–¹å‘åŒæœŸã‚’ç®¡ç†
 */

interface SyncResult {
  success: boolean;
  error?: { code: string; message: string };
}

/**
 * user_profiles â†’ user_metadata ã¸ã®åŒæœŸ
 * profile:update æ™‚ã«å‘¼ã³å‡ºã—
 */
export async function syncProfileToMetadata(
  supabase: SupabaseClient,
  updates: {
    display_name?: string;
    avatar_url?: string | null;
  },
): Promise<SyncResult>;

/**
 * user_metadata â†’ user_profiles ã¸ã®åŒæœŸ
 * avatar:* æ“ä½œæ™‚ã«å‘¼ã³å‡ºã—
 */
export async function syncMetadataToProfile(
  supabase: SupabaseClient,
  userId: string,
  updates: {
    avatar_url?: string | null;
  },
): Promise<SyncResult>;

/**
 * åŒæ–¹å‘åŒæœŸï¼ˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
 */
export async function ensureProfileConsistency(
  supabase: SupabaseClient,
  userId: string,
): Promise<SyncResult>;
```

#### æˆæœç‰©

| æˆæœç‰©     | ãƒ‘ã‚¹                                                                 | å†…å®¹                   |
| ---------- | -------------------------------------------------------------------- | ---------------------- |
| åŒæœŸè¨­è¨ˆæ›¸ | `docs/30-workflows/profile-persistence-bugfix/design/sync-design.md` | ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»åŒæœŸæˆ¦ç•¥ |

#### å®Œäº†æ¡ä»¶

- [ ] ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è²¬å‹™ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] åŒæœŸã®æ–¹å‘ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

---

### T-01-2: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½è¨­è¨ˆ

#### ç›®çš„

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ã®ãƒ•ãƒ­ãƒ¼ãƒ»UIãƒ»å®‰å…¨æ€§ã‚’è¨­è¨ˆã™ã‚‹ã€‚

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/domain-modeler.md`
- **é¸å®šç†ç”±**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®è¨­è¨ˆå°‚é–€å®¶
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### è¨­è¨ˆå†…å®¹

##### 4.2.1 å‰Šé™¤ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    UI       â”‚    â”‚    IPC      â”‚    â”‚  Supabase   â”‚
â”‚ AccountSection   â”‚    â”‚  Handler    â”‚    â”‚   Auth/DB   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â”‚ 1. å‰Šé™¤ãƒœã‚¿ãƒ³     â”‚                   â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
       â”‚                   â”‚                   â”‚
       â”‚ 2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° â”‚                   â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
       â”‚                   â”‚                   â”‚
       â”‚ 3. ç¢ºèªå…¥åŠ›       â”‚                   â”‚
       â”‚ (ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)  â”‚                   â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
       â”‚                   â”‚                   â”‚
       â”‚                   â”‚ 4. user_profileså‰Šé™¤
       â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                   â”‚                   â”‚
       â”‚                   â”‚ 5. Storageå‰Šé™¤    â”‚
       â”‚                   â”‚  (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã‚¢ãƒã‚¿ãƒ¼)
       â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                   â”‚                   â”‚
       â”‚                   â”‚ 6. Authå‰Šé™¤       â”‚
       â”‚                   â”‚  (signOut + deleteUser)
       â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                   â”‚                   â”‚
       â”‚ 7. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ     â”‚                   â”‚
       â”‚  â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢   â”‚                   â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
```

##### 4.2.2 IPC ãƒãƒ£ãƒãƒ«è¿½åŠ 

```typescript
// apps/desktop/src/preload/channels.ts ã«è¿½åŠ 
PROFILE_DELETE: 'profile:delete',

// apps/desktop/src/preload/types.ts ã«è¿½åŠ 
interface ProfileDeleteRequest {
  confirmEmail: string; // ç¢ºèªç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
}

interface ProfileDeleteResponse {
  success: boolean;
  error?: { code: string; message: string };
}
```

##### 4.2.3 UIè¨­è¨ˆï¼ˆAccountSectionæ‹¡å¼µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚ [æ—¢å­˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†UI]                              â”‚
â”‚                                                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                        â”‚
â”‚ âš ï¸ å±é™ºãªæ“ä½œ                                          â”‚
â”‚                                                        â”‚
â”‚ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒ               â”‚
â”‚ å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€å¾©å…ƒã§ãã¾ã›ã‚“ã€‚                       â”‚
â”‚                                                        â”‚
â”‚ [ğŸ—‘ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤]  â† èµ¤ã„ãƒœã‚¿ãƒ³                    â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼š â”‚
â”‚                                                        â”‚
â”‚ ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±                                     â”‚
â”‚ ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚¢ãƒã‚¿ãƒ¼ç”»åƒ                         â”‚
â”‚ ãƒ»ã™ã¹ã¦ã®è¨­å®š                                         â”‚
â”‚                                                        â”‚
â”‚ ç¢ºèªã®ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š         â”‚
â”‚                                                        â”‚
â”‚ [                                  ]                   â”‚
â”‚                                                        â”‚
â”‚        [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]    [å‰Šé™¤ã™ã‚‹] â† èµ¤ã€disabled       â”‚
â”‚                                    (ãƒ¡ãƒ¼ãƒ«ä¸€è‡´ã§æœ‰åŠ¹åŒ–) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æˆæœç‰©

| æˆæœç‰©       | ãƒ‘ã‚¹                                                                   | å†…å®¹                   |
| ------------ | ---------------------------------------------------------------------- | ---------------------- |
| å‰Šé™¤æ©Ÿèƒ½è¨­è¨ˆ | `docs/30-workflows/profile-persistence-bugfix/design/delete-design.md` | ãƒ•ãƒ­ãƒ¼ãƒ»UIãƒ»å®‰å…¨æ€§è¨­è¨ˆ |

#### å®Œäº†æ¡ä»¶

- [ ] å‰Šé™¤ãƒ•ãƒ­ãƒ¼ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®UIè¨­è¨ˆãŒå®Œäº†
- [ ] IPCãƒãƒ£ãƒãƒ«ãƒ»å‹å®šç¾©ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] å‰Šé™¤é †åºï¼ˆDB â†’ Storage â†’ Authï¼‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹

---

## Phase 1.5: è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒˆ

### T-01R: è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼

#### ç›®çš„

å®Ÿè£…é–‹å§‹å‰ã«è¨­è¨ˆã®å¦¥å½“æ€§ã‚’è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§æ¤œè¨¼ã™ã‚‹ã€‚

#### ãƒ¬ãƒ“ãƒ¥ãƒ¼å‚åŠ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ    | ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹         | é¸å®šç†ç”±                     |
| --------------- | -------------------- | ---------------------------- |
| .claude/agents/arch-police.md    | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ•´åˆæ€§ | ãƒ¬ã‚¤ãƒ¤ãƒ¼é•åã€ä¾å­˜é–¢ä¿‚ã®æ¤œè¨¼ |
| .claude/agents/sec-auditor.md    | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ     | å‰Šé™¤æ“ä½œã®å®‰å…¨æ€§ã€èªè¨¼ãƒ»èªå¯ |
| .claude/agents/domain-modeler.md | ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å¦¥å½“æ€§ | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ |

- **å‚ç…§**: `.claude/agents/agent_list.md`

#### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ•´åˆæ€§** (.claude/agents/arch-police.md)

- [ ] åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒinfrastructureãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é©åˆ‡ã«é…ç½®
- [ ] ä¾å­˜é–¢ä¿‚é€†è»¢ã®åŸå‰‡(DIP)ãŒå®ˆã‚‰ã‚Œã¦ã„ã‚‹
- [ ] æ—¢å­˜ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã®æ•´åˆæ€§ãŒã‚ã‚‹

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ** (.claude/agents/sec-auditor.md)

- [ ] å‰Šé™¤æ“ä½œã«é©åˆ‡ãªç¢ºèªãŒå®Ÿè£…ã•ã‚Œã‚‹
- [ ] èªè¨¼çŠ¶æ…‹ã®æ¤œè¨¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- [ ] å‰Šé™¤é †åºãŒå®‰å…¨ï¼ˆAuthå‰Šé™¤ã¯æœ€å¾Œï¼‰

**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å¦¥å½“æ€§** (.claude/agents/domain-modeler.md)

- [ ] ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è²¬å‹™ãŒæ˜ç¢º
- [ ] åŒæœŸãƒ«ãƒ¼ãƒ«ãŒãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã‚’æº€ãŸã™
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ¯ã‚‹èˆã„ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹

#### ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœåˆ¤å®š

- **PASS**: å…¨è¦³ç‚¹ã§å•é¡Œãªã— â†’ Phase 2ã¸é€²è¡Œ
- **MINOR**: è»½å¾®ãªæŒ‡æ‘˜ã‚ã‚Š â†’ æŒ‡æ‘˜å¯¾å¿œå¾ŒPhase 2ã¸é€²è¡Œ
- **MAJOR**: é‡å¤§ãªå•é¡Œã‚ã‚Š â†’ Phase 1ã¸æˆ»ã‚‹

#### å®Œäº†æ¡ä»¶

- [ ] å…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã§å•é¡Œãªã—ã€ã¾ãŸã¯MINORæŒ‡æ‘˜ã®ã¿
- [ ] MINORæŒ‡æ‘˜ãŒã‚ã‚Œã°å¯¾å¿œå®Œäº†

---

## Phase 2: ãƒ†ã‚¹ãƒˆä½œæˆ (TDD: Red)

### T-02-1: åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆä½œæˆ

#### ç›®çš„

profileSync.tsã®åŒæœŸé–¢æ•°ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã€‚

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:generate-unit-tests apps/desktop/src/main/infrastructure/profileSync.ts
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/unit-tester.md`
- **é¸å®šç†ç”±**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆã®å°‚é–€å®¶ã€TDDã‚µã‚¤ã‚¯ãƒ«ã«ç²¾é€š
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### æ´»ç”¨ã‚¹ã‚­ãƒ«

| ã‚¹ã‚­ãƒ«å                | æ´»ç”¨æ–¹æ³•                     |
| ----------------------- | ---------------------------- |
| .claude/skills/test-doubles/SKILL.md            | Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¢ãƒƒã‚¯ |
| .claude/skills/tdd-principles/SKILL.md          | Red-Green-Refactorã‚µã‚¤ã‚¯ãƒ«   |
| .claude/skills/boundary-value-analysis/SKILL.md | æˆåŠŸ/å¤±æ•—ã®å¢ƒç•Œãƒ†ã‚¹ãƒˆ        |

- **å‚ç…§**: `.claude/skills/skill_list.md`

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```typescript
describe("profileSync", () => {
  describe("syncProfileToMetadata", () => {
    it("display_nameã‚’æ­£ã—ãåŒæœŸã™ã‚‹");
    it("avatar_urlã‚’æ­£ã—ãåŒæœŸã™ã‚‹");
    it("éƒ¨åˆ†æ›´æ–°ï¼ˆdisplay_nameã®ã¿ï¼‰ãŒå‹•ä½œã™ã‚‹");
    it("Supabase Auth APIã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™");
  });

  describe("syncMetadataToProfile", () => {
    it("avatar_urlã‚’user_profilesã«åŒæœŸã™ã‚‹");
    it("avatar_url=nullã§å‰Šé™¤åŒæœŸã™ã‚‹");
    it("DBæ›´æ–°ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™");
    it("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†");
  });

  describe("ensureProfileConsistency", () => {
    it("ä¸æ•´åˆã‚’æ¤œå‡ºã—ã¦ä¿®æ­£ã™ã‚‹");
    it("æ•´åˆã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„");
  });
});
```

#### TDDæ¤œè¨¼: RedçŠ¶æ…‹ç¢ºèª

```bash
pnpm --filter @repo/desktop test:run profileSync
```

- [ ] ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆRedçŠ¶æ…‹ï¼‰

#### å®Œäº†æ¡ä»¶

- [ ] syncProfileToMetadataã®ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] syncMetadataToProfileã®ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] ensureProfileConsistencyã®ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«Redï¼ˆå¤±æ•—ï¼‰çŠ¶æ…‹ã‚’ç¢ºèª

---

### T-02-2: profile:updateåŒæœŸãƒ†ã‚¹ãƒˆä½œæˆ

#### ç›®çš„

profile:updateæ™‚ã«user_profilesã¨user_metadataã®ä¸¡æ–¹ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã€‚

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/unit-tester.md`
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```typescript
describe("profile:update åŒæœŸãƒ†ã‚¹ãƒˆ", () => {
  it("displayNameæ›´æ–°æ™‚ã«user_metadataã‚‚åŒæœŸã•ã‚Œã‚‹");
  it("avatarUrlæ›´æ–°æ™‚ã«user_metadataã‚‚åŒæœŸã•ã‚Œã‚‹");
  it("user_metadataåŒæœŸå¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™");
  it("user_profilesæ›´æ–°æˆåŠŸå¾Œã®user_metadataåŒæœŸå¤±æ•—æ™‚ã®æŒ¯ã‚‹èˆã„");
});
```

#### TDDæ¤œè¨¼: RedçŠ¶æ…‹ç¢ºèª

```bash
pnpm --filter @repo/desktop test:run profileHandlers
```

- [ ] ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆRedçŠ¶æ…‹ï¼‰

#### å®Œäº†æ¡ä»¶

- [ ] åŒæœŸãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] RedçŠ¶æ…‹ç¢ºèª

---

### T-02-3: avataræ“ä½œåŒæœŸãƒ†ã‚¹ãƒˆä½œæˆ

#### ç›®çš„

avatar:upload/use-provider/removeæ™‚ã«user_profiles.avatar_urlã‚‚æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã€‚

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```typescript
describe("avataræ“ä½œ åŒæœŸãƒ†ã‚¹ãƒˆ", () => {
  describe("avatar:upload", () => {
    it("user_metadataã¨user_profiles.avatar_urlã®ä¸¡æ–¹ãŒæ›´æ–°ã•ã‚Œã‚‹");
    it("user_profilesåŒæœŸå¤±æ•—æ™‚ã®æŒ¯ã‚‹èˆã„");
  });

  describe("avatar:use-provider", () => {
    it("user_metadataã¨user_profiles.avatar_urlã®ä¸¡æ–¹ãŒæ›´æ–°ã•ã‚Œã‚‹");
  });

  describe("avatar:remove", () => {
    it("user_metadataã¨user_profiles.avatar_urlã®ä¸¡æ–¹ãŒnullã«æ›´æ–°ã•ã‚Œã‚‹");
  });
});
```

#### å®Œäº†æ¡ä»¶

- [ ] avatar:uploadãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] avatar:use-providerãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] avatar:removeãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] RedçŠ¶æ…‹ç¢ºèª

---

### T-02-4: profile:delete ãƒ†ã‚¹ãƒˆä½œæˆ

#### ç›®çš„

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã€‚

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```typescript
describe("profile:delete", () => {
  it("æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å‰Šé™¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹");
  it("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸ä¸€è‡´ã§æ‹’å¦ã•ã‚Œã‚‹");
  it("èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼");
  it("user_profiles â†’ Storage â†’ Auth ã®é †åºã§å‰Šé™¤ã•ã‚Œã‚‹");
  it("é€”ä¸­ã§å¤±æ•—ã—ãŸå ´åˆã®æŒ¯ã‚‹èˆã„");
});
```

#### å®Œäº†æ¡ä»¶

- [ ] æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] å‰Šé™¤é †åºæ¤œè¨¼ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] RedçŠ¶æ…‹ç¢ºèª

---

## Phase 3: å®Ÿè£… (TDD: Green)

### T-03-1: åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å®Ÿè£…

#### ç›®çš„

profileSync.tsã‚’å®Ÿè£…ã—ã€T-02-1ã®ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã•ã›ã‚‹ã€‚

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:implement-business-logic profile-sync
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/logic-dev.md`
- **é¸å®šç†ç”±**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ã®å°‚é–€å®¶
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### æˆæœç‰©

| æˆæœç‰©             | ãƒ‘ã‚¹                                                  | å†…å®¹           |
| ------------------ | ----------------------------------------------------- | -------------- |
| åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ | `apps/desktop/src/main/infrastructure/profileSync.ts` | åŒæ–¹å‘åŒæœŸé–¢æ•° |

#### TDDæ¤œè¨¼: GreençŠ¶æ…‹ç¢ºèª

```bash
pnpm --filter @repo/desktop test:run profileSync
```

- [ ] å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆGreençŠ¶æ…‹ï¼‰

#### å®Œäº†æ¡ä»¶

- [ ] syncProfileToMetadataå®Ÿè£…
- [ ] syncMetadataToProfileå®Ÿè£…
- [ ] ensureProfileConsistencyå®Ÿè£…
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆãŒGreen

---

### T-03-2: profileHandlers.tsä¿®æ­£

#### ç›®çš„

profile:updateã§user_metadataã‚‚åŒæœŸã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚

#### ä¿®æ­£ç®‡æ‰€

```
apps/desktop/src/main/ipc/profileHandlers.ts:256-328
```

#### ä¿®æ­£å†…å®¹

```typescript
// profile:update ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…
// 1. user_profiles æ›´æ–°ï¼ˆæ—¢å­˜ï¼‰
// 2. user_metadata åŒæœŸï¼ˆè¿½åŠ ï¼‰
const syncResult = await syncProfileToMetadata(supabase, {
  display_name: updates.displayName,
  avatar_url: updates.avatarUrl,
});
if (!syncResult.success) {
  console.warn("[ProfileHandlers] user_metadataåŒæœŸå¤±æ•—:", syncResult.error);
  // è­¦å‘Šãƒ­ã‚°ã®ã¿ã€å‡¦ç†ã¯ç¶šè¡Œï¼ˆuser_profilesãŒæ­£ï¼‰
}
// 3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
```

#### TDDæ¤œè¨¼: GreençŠ¶æ…‹ç¢ºèª

```bash
pnpm --filter @repo/desktop test:run profileHandlers
```

- [ ] profile:updateåŒæœŸãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆGreençŠ¶æ…‹ï¼‰

#### å®Œäº†æ¡ä»¶

- [ ] user_metadataåŒæœŸè¿½åŠ 
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆè­¦å‘Šãƒ­ã‚°ï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ç¢ºèª
- [ ] ãƒ†ã‚¹ãƒˆãŒGreen

---

### T-03-3: avatarHandlers.tsä¿®æ­£

#### ç›®çš„

avataræ“ä½œæ™‚ã«user_profiles.avatar_urlã‚‚åŒæœŸã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚

#### ä¿®æ­£ç®‡æ‰€

```
apps/desktop/src/main/ipc/avatarHandlers.ts:162-178 (avatar:upload)
apps/desktop/src/main/ipc/avatarHandlers.ts:266-282 (avatar:use-provider)
apps/desktop/src/main/ipc/avatarHandlers.ts:354-359 (avatar:remove)
```

#### ä¿®æ­£å†…å®¹

```typescript
// å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å†…ã§ user_metadata æ›´æ–°å¾Œã«è¿½åŠ 
await syncMetadataToProfile(supabase, userId, { avatar_url: avatarUrl });
```

#### TDDæ¤œè¨¼: GreençŠ¶æ…‹ç¢ºèª

```bash
pnpm --filter @repo/desktop test:run avatarHandlers
```

- [ ] avataråŒæœŸãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆGreençŠ¶æ…‹ï¼‰

#### å®Œäº†æ¡ä»¶

- [ ] avatar:uploadã§user_profilesåŒæœŸ
- [ ] avatar:use-providerã§user_profilesåŒæœŸ
- [ ] avatar:removeã§user_profilesåŒæœŸï¼ˆnullè¨­å®šï¼‰
- [ ] ãƒ†ã‚¹ãƒˆãŒGreen

---

### T-03-4: profile:delete ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…

#### ç›®çš„

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½ã®IPCãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã€‚

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/logic-dev.md`
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### å®Ÿè£…å†…å®¹

```typescript
// profileHandlers.ts ã«è¿½åŠ 

ipcMain.handle(
  IPC_CHANNELS.PROFILE_DELETE,
  withValidation(
    IPC_CHANNELS.PROFILE_DELETE,
    async (
      _event,
      { confirmEmail }: { confirmEmail: string },
    ): Promise<IPCResponse<void>> => {
      // 1. èªè¨¼ç¢ºèª
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) {
        return {
          success: false,
          error: {
            code: "profile/delete-failed",
            message: "Not authenticated",
          },
        };
      }

      // 2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª
      if (user.email !== confirmEmail) {
        return {
          success: false,
          error: {
            code: "profile/delete-confirm-mismatch",
            message: "Email mismatch",
          },
        };
      }

      // 3. user_profiles å‰Šé™¤
      await supabase.from("user_profiles").delete().eq("id", user.id);

      // 4. Storageå‰Šé™¤ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã‚¢ãƒã‚¿ãƒ¼ï¼‰
      // ... æ—¢å­˜ã®ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯æµç”¨

      // 5. Authå‰Šé™¤ï¼ˆã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ + å‰Šé™¤ï¼‰
      await supabase.auth.signOut();
      // Note: Supabase Admin APIã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å¿…è¦
      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã¯signOutã®ã¿å®Ÿè¡Œ

      return { success: true };
    },
    { getAllowedWindows: () => [mainWindow] },
  ),
);
```

#### TDDæ¤œè¨¼: GreençŠ¶æ…‹ç¢ºèª

```bash
pnpm --filter @repo/desktop test:run profileHandlers
```

- [ ] profile:deleteãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼ˆGreençŠ¶æ…‹ï¼‰

#### å®Œäº†æ¡ä»¶

- [ ] IPCãƒãƒ£ãƒãƒ«è¿½åŠ 
- [ ] å‰Šé™¤ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…
- [ ] ç¢ºèªãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯å®Ÿè£…
- [ ] å‰Šé™¤é †åºï¼ˆDB â†’ Storage â†’ Authï¼‰å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆãŒGreen

---

### T-03-5: AccountSection UIä¿®æ­£

#### ç›®çš„

å‰Šé™¤æ©Ÿèƒ½ã®UIã‚’AccountSectionã«è¿½åŠ ã€‚

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:create-component DeleteAccountSection molecule
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/ui-designer.md`
- **é¸å®šç†ç”±**: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã®å°‚é–€å®¶
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### æ´»ç”¨ã‚¹ã‚­ãƒ«

| ã‚¹ã‚­ãƒ«å              | æ´»ç”¨æ–¹æ³•             |
| --------------------- | -------------------- |
| .claude/skills/accessibility-wcag/SKILL.md    | ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ |
| .claude/skills/tailwind-css-patterns/SKILL.md | ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°         |

- **å‚ç…§**: `.claude/skills/skill_list.md`

#### å®Ÿè£…å†…å®¹

- ã€Œå±é™ºãªæ“ä½œã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
- å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆèµ¤è‰²ã€è­¦å‘Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰
- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ã«ã‚ˆã‚‹ç¢ºèª
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãƒ»ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

#### å®Œäº†æ¡ä»¶

- [ ] å‰Šé™¤ãƒœã‚¿ãƒ³UIå®Ÿè£…
- [ ] ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°å®Ÿè£…
- [ ] ãƒ¡ãƒ¼ãƒ«ç¢ºèªå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®Ÿè£…
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹å®Ÿè£…
- [ ] authSliceã«deleteAccount thunkè¿½åŠ 

---

### T-03-6: authSlice ä¿®æ­£

#### ç›®çš„

å‰Šé™¤æ©Ÿèƒ½ã®Redux Thunkã‚’è¿½åŠ ã€‚

#### å®Ÿè£…å†…å®¹

```typescript
// authSlice.ts ã«è¿½åŠ 

export const deleteAccount = createAsyncThunk(
  'auth/deleteAccount',
  async (confirmEmail: string, { rejectWithValue }) => {
    const result = await window.electronAPI.profile.delete({ confirmEmail });
    if (!result.success) {
      return rejectWithValue(result.error);
    }
    return result;
  }
);

// reducerã«è¿½åŠ 
.addCase(deleteAccount.pending, (state) => {
  state.deleteLoading = true;
  state.deleteError = null;
})
.addCase(deleteAccount.fulfilled, (state) => {
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
  return initialState;
})
.addCase(deleteAccount.rejected, (state, action) => {
  state.deleteLoading = false;
  state.deleteError = action.payload as AuthError;
})
```

#### å®Œäº†æ¡ä»¶

- [ ] deleteAccount thunkå®Ÿè£…
- [ ] çŠ¶æ…‹ç®¡ç†ï¼ˆloading, errorï¼‰è¿½åŠ 
- [ ] preload/types.tsã«å‹è¿½åŠ 

---

## Phase 4: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (TDD: Refactor)

### T-04-1: ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:refactor apps/desktop/src/main/ipc/profileHandlers.ts
/ai:refactor apps/desktop/src/main/ipc/avatarHandlers.ts
/ai:refactor apps/desktop/src/main/infrastructure/profileSync.ts
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### ä½¿ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: `.claude/agents/code-quality.md`
- **å‚ç…§**: `.claude/agents/agent_list.md`

#### TDDæ¤œè¨¼: ç¶™ç¶šGreenç¢ºèª

```bash
pnpm --filter @repo/desktop test:run
```

- [ ] ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ

#### å®Œäº†æ¡ä»¶

- [ ] é‡è¤‡ã‚³ãƒ¼ãƒ‰æ’é™¤
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€
- [ ] å‹å®šç¾©ã®æ•´ç†
- [ ] ãƒ†ã‚¹ãƒˆãŒç¶™ç¶šGreen

---

## Phase 5: å“è³ªä¿è¨¼

### T-05-1: å›å¸°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:run-all-tests --coverage
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### å®Œäº†æ¡ä»¶

- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸ
- [ ] æ–°è¦ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦æˆåŠŸ
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ä½ä¸‹ãªã—

---

## å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ©Ÿèƒ½æ¤œè¨¼

- [ ] å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] profile:updateåŒæœŸãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] avataræ“ä½œåŒæœŸãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] profile:delete ãƒ†ã‚¹ãƒˆæˆåŠŸ

### ã‚³ãƒ¼ãƒ‰å“è³ª

- [ ] Lintã‚¨ãƒ©ãƒ¼ãªã—
- [ ] å‹ã‚¨ãƒ©ãƒ¼ãªã—
- [ ] ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé©ç”¨æ¸ˆã¿

### ãƒ†ã‚¹ãƒˆç¶²ç¾…æ€§

- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸åŸºæº–é”æˆ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- [ ] å‰Šé™¤æ“ä½œã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚ã‚Š
- [ ] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªã«ã‚ˆã‚‹èª¤æ“ä½œé˜²æ­¢

---

## Phase 5.5: æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒˆ

### T-05R: æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼

#### ãƒ¬ãƒ“ãƒ¥ãƒ¼å‚åŠ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ  | ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹       | é¸å®šç†ç”±                   |
| ------------- | ------------------ | -------------------------- |
| .claude/agents/code-quality.md | ã‚³ãƒ¼ãƒ‰å“è³ª         | ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã€å¯èª­æ€§   |
| .claude/agents/arch-police.md  | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£éµå®ˆ | ãƒ¬ã‚¤ãƒ¤ãƒ¼é•åã€ä¾å­˜é–¢ä¿‚     |
| .claude/agents/unit-tester.md  | ãƒ†ã‚¹ãƒˆå“è³ª         | ã‚«ãƒãƒ¬ãƒƒã‚¸ã€ãƒ†ã‚¹ãƒˆè¨­è¨ˆ     |
| .claude/agents/sec-auditor.md  | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£       | å…¥åŠ›æ¤œè¨¼ã€å‰Šé™¤æ“ä½œã®å®‰å…¨æ€§ |
| .claude/agents/ui-designer.md  | UIå“è³ª             | ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã€UX       |

- **å‚ç…§**: `.claude/agents/agent_list.md`

#### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**ã‚³ãƒ¼ãƒ‰å“è³ª** (.claude/agents/code-quality.md)

- [ ] ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¸ã®æº–æ‹ 
- [ ] å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ã®ç¢ºä¿
- [ ] é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£éµå®ˆ** (.claude/agents/arch-police.md)

- [ ] åŒæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒinfrastructureãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é©åˆ‡é…ç½®
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®ä¾å­˜é–¢ä¿‚ãŒé©åˆ‡

**ãƒ†ã‚¹ãƒˆå“è³ª** (.claude/agents/unit-tester.md)

- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒååˆ†
- [ ] å¢ƒç•Œå€¤ãƒ»ç•°å¸¸ç³»ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** (.claude/agents/sec-auditor.md)

- [ ] å‰Šé™¤ç¢ºèªãŒé©åˆ‡ã«å®Ÿè£…
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ©Ÿå¯†æƒ…å ±ãªã—

**UIå“è³ª** (.claude/agents/ui-designer.md)

- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£åŸºæº–æº–æ‹ 
- [ ] ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¡¨ç¤º

#### å®Œäº†æ¡ä»¶

- [ ] å…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã§å•é¡Œãªã—ã€ã¾ãŸã¯MINORæŒ‡æ‘˜ã®ã¿
- [ ] MINORæŒ‡æ‘˜ãŒã‚ã‚Œã°å¯¾å¿œå®Œäº†

---

## Phase 6: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

### T-06-1: ã‚·ã‚¹ãƒ†ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:update-all-docs
```

- **å‚ç…§**: `.claude/commands/ai/command_list.md`

#### æ›´æ–°å¯¾è±¡

- `docs/00-requirements/08-api-design.md` - profile:delete ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
- å¿…è¦ã«å¿œã˜ã¦ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

#### å®Œäº†æ¡ä»¶

- [ ] å¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¿ã‚¹ã‚¯å®Œäº†å ±å‘Šä½œæˆ

---

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯                 | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | å¯¾ç­–                   | å¯¾å¿œã‚µãƒ–ã‚¿ã‚¹ã‚¯ |
| ---------------------- | ------ | -------- | ---------------------- | -------------- |
| éƒ¨åˆ†çš„ãªåŒæœŸå¤±æ•—       | é«˜     | ä¸­       | è­¦å‘Šãƒ­ã‚° + Primaryå„ªå…ˆ | T-03-1         |
| æ—¢å­˜æ©Ÿèƒ½ã®ãƒ‡ã‚°ãƒ¬ãƒ¼ãƒ‰   | é«˜     | ä½       | å›å¸°ãƒ†ã‚¹ãƒˆã®å¾¹åº•       | T-05-1         |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¸æ•´åˆ     | ä¸­     | ä¸­       | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–æˆ¦ç•¥   | T-03-2, T-03-3 |
| å‰Šé™¤æ“ä½œã®èª¤å®Ÿè¡Œ       | é«˜     | ä½       | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª     | T-03-4, T-03-5 |
| Supabase Admin APIåˆ¶é™ | ä¸­     | ä¸­       | ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã®ã¿ã§å¯¾å¿œ | T-03-4         |

---

## å‰ææ¡ä»¶

- Supabaseèªè¨¼ãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨
- æ—¢å­˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¢ãƒã‚¿ãƒ¼æ©Ÿèƒ½ãŒãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã“ã¨
- desktopãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒãŒå‹•ä½œã™ã‚‹ã“ã¨

---

## å‚™è€ƒ

### æŠ€è¡“çš„åˆ¶ç´„

- Supabase Admin APIï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®Œå…¨å‰Šé™¤ï¼‰ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿åˆ©ç”¨å¯èƒ½
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã¯signOutã®ã¿å®Ÿè¡Œã—ã€å®Œå…¨å‰Šé™¤ã¯å¾Œç¶šã‚¿ã‚¹ã‚¯ã§å¯¾å¿œ
- Tursoï¼ˆãƒ­ãƒ¼ã‚«ãƒ«DBï¼‰ã¸ã®ç§»è¡Œã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–

### å‚è€ƒè³‡æ–™

- [Supabase Auth - updateUser](https://supabase.com/docs/reference/javascript/auth-updateuser)
- [Supabase Database - Update](https://supabase.com/docs/reference/javascript/update)
- [Supabase Auth - signOut](https://supabase.com/docs/reference/javascript/auth-signout)

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `apps/desktop/src/main/ipc/profileHandlers.ts` - ä¿®æ­£å¯¾è±¡
- `apps/desktop/src/main/ipc/avatarHandlers.ts` - ä¿®æ­£å¯¾è±¡
- `apps/desktop/src/main/infrastructure/profileCache.ts` - ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
- `apps/desktop/src/main/infrastructure/supabaseClient.ts` - Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `apps/desktop/src/renderer/components/organisms/AccountSection/` - UIä¿®æ­£å¯¾è±¡
- `apps/desktop/src/renderer/store/slices/authSlice.ts` - Reduxä¿®æ­£å¯¾è±¡
