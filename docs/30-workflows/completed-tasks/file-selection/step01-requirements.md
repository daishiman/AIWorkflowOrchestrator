# ファイル選択機能 - 要件定義書

> **ドキュメントID**: CONV-01-REQ
> **作成日**: 2025-12-16
> **作成者**: .claude/agents/req-analyst.md
> **ステータス**: 承認待ち

---

## 1. プロジェクト概要

### 1.1 目的

ユーザーがローカルファイルシステムからファイルを選択し、後続の変換処理に渡すためのインターフェースを提供する。

### 1.2 スコープ

| 含むもの                         | 含まないもの             |
| -------------------------------- | ------------------------ |
| ファイル選択UIコンポーネント     | ファイルの実際の読み込み |
| ネイティブダイアログ呼び出し     | 変換処理                 |
| ドラッグ&ドロップ対応            | データベースへの保存     |
| ファイルメタ情報の取得           | 変換結果の表示           |
| ファイル情報の状態管理           | プレビュー機能           |
| 対応ファイル形式のフィルタリング |                          |

### 1.3 ステークホルダー

| ステークホルダー | 役割                     | 関心事                       |
| ---------------- | ------------------------ | ---------------------------- |
| エンドユーザー   | ファイル選択操作の実行者 | 直感的なUI、高速なレスポンス |
| 開発者           | 後続機能との連携         | 明確なAPI、型安全性          |
| システム         | 変換パイプラインの入口   | 信頼性、セキュリティ         |

---

## 2. 機能要件

### 2.1 ファイル選択ダイアログ（FR-001）

| 項目   | 内容                                                           |
| ------ | -------------------------------------------------------------- |
| 要件ID | FR-001                                                         |
| 優先度 | Must                                                           |
| 説明   | ネイティブのファイル選択ダイアログを開き、ファイルを選択できる |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーがファイル選択画面を表示している
When ユーザーが「ファイルを選択」ボタンをクリックする
Then OSネイティブのファイル選択ダイアログが開く
And ダイアログにはファイルフィルタが適用されている
```

### 2.2 複数ファイル選択（FR-002）

| 項目   | 内容                                                            |
| ------ | --------------------------------------------------------------- |
| 要件ID | FR-002                                                          |
| 優先度 | Must                                                            |
| 説明   | Ctrl/Cmd+クリックまたはShift+クリックで複数ファイルを選択できる |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーがファイル選択ダイアログを開いている
When ユーザーがCtrl/Cmdキーを押しながら複数ファイルをクリックする
Then 選択したすべてのファイルがリストに追加される
And 各ファイルのメタ情報が取得される
```

### 2.3 ドラッグ&ドロップ対応（FR-003）

| 項目   | 内容                                                  |
| ------ | ----------------------------------------------------- |
| 要件ID | FR-003                                                |
| 優先度 | Must                                                  |
| 説明   | ファイルをウィンドウにドラッグ&ドロップして選択できる |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーがファイル選択画面を表示している
When ユーザーがファイルをドロップゾーンにドラッグする
Then ドロップゾーンがハイライト表示される
And ユーザーがファイルをドロップする
Then ファイルが選択リストに追加される
```

### 2.4 ファイルメタ情報取得（FR-004）

| 項目   | 内容                                                               |
| ------ | ------------------------------------------------------------------ |
| 要件ID | FR-004                                                             |
| 優先度 | Must                                                               |
| 説明   | 選択されたファイルのメタ情報（パス、名前、サイズ、拡張子等）を取得 |

#### 取得するメタ情報

| 項目         | 型     | 説明                     |
| ------------ | ------ | ------------------------ |
| id           | string | ユニークID（UUID）       |
| path         | string | ファイルの絶対パス       |
| name         | string | ファイル名（拡張子含む） |
| extension    | string | 拡張子（.pdf等）         |
| size         | number | ファイルサイズ（バイト） |
| mimeType     | string | MIMEタイプ               |
| lastModified | Date   | 最終更新日時             |
| createdAt    | Date   | 選択日時                 |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーがファイルを選択した
When ファイル情報が処理される
Then 上記すべてのメタ情報が取得される
And 情報は状態管理ストアに保存される
```

### 2.5 選択キャンセル処理（FR-005）

| 項目   | 内容                                                     |
| ------ | -------------------------------------------------------- |
| 要件ID | FR-005                                                   |
| 優先度 | Must                                                     |
| 説明   | ダイアログをキャンセルした場合、エラーなく元の状態に戻る |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーがファイル選択ダイアログを開いている
When ユーザーがキャンセルボタンをクリックまたはEscキーを押す
Then ダイアログが閉じる
And エラーは発生しない
And 既存の選択状態は維持される
```

### 2.6 ファイル形式フィルタリング（FR-006）

| 項目   | 内容                                               |
| ------ | -------------------------------------------------- |
| 要件ID | FR-006                                             |
| 優先度 | Should                                             |
| 説明   | 対応ファイル形式のみを選択可能にするフィルタを提供 |

#### 対応ファイル形式

| カテゴリ              | 拡張子                                      |
| --------------------- | ------------------------------------------- |
| オフィス文書          | .pdf, .docx, .xlsx, .pptx, .doc, .xls, .ppt |
| テキスト/マークダウン | .txt, .md, .csv, .json, .xml, .yaml, .yml   |
| メディア              | .mp3, .mp4, .wav, .webm, .ogg, .m4a         |
| 画像                  | .png, .jpg, .jpeg, .gif, .webp, .svg        |
| すべて                | 上記すべて + その他                         |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーがファイル選択ダイアログを開いている
When フィルタが「オフィス文書」に設定されている
Then .pdf, .docx, .xlsx, .pptxファイルのみ表示される
```

### 2.7 選択ファイルの削除（FR-007）

| 項目   | 内容                                                 |
| ------ | ---------------------------------------------------- |
| 要件ID | FR-007                                               |
| 優先度 | Must                                                 |
| 説明   | 選択済みファイルリストから個別にファイルを削除できる |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーが3つのファイルを選択している
When ユーザーが2番目のファイルの削除ボタンをクリックする
Then 2番目のファイルがリストから削除される
And 残り2つのファイルは維持される
```

### 2.8 全選択クリア（FR-008）

| 項目   | 内容                                 |
| ------ | ------------------------------------ |
| 要件ID | FR-008                               |
| 優先度 | Should                               |
| 説明   | 選択済みファイルをすべてクリアできる |

#### 受け入れ基準（Given-When-Then）

```gherkin
Given ユーザーが複数のファイルを選択している
When ユーザーが「すべてクリア」ボタンをクリックする
Then すべてのファイルが選択リストから削除される
And 状態がリセットされる
```

---

## 3. 非機能要件

### 3.1 パフォーマンス（NFR-001）

| 項目   | 内容                                    |
| ------ | --------------------------------------- |
| 要件ID | NFR-001                                 |
| 優先度 | Must                                    |
| 基準   | ファイル選択ダイアログの表示: 200ms以内 |

| 測定項目                     | 目標値  |
| ---------------------------- | ------- |
| ダイアログ表示時間           | < 200ms |
| ファイルメタ情報取得（1件）  | < 50ms  |
| 100ファイル選択時の処理      | < 2秒   |
| ドロップゾーンハイライト表示 | < 100ms |

### 3.2 ユーザビリティ（NFR-002）

| 項目   | 内容                                 |
| ------ | ------------------------------------ |
| 要件ID | NFR-002                              |
| 優先度 | Must                                 |
| 基準   | Apple Human Interface Guidelines準拠 |

| 要件                     | 説明                                   |
| ------------------------ | -------------------------------------- |
| キーボードナビゲーション | Tab/Enter/Escでの操作が可能            |
| 視覚的フィードバック     | ホバー、フォーカス、ドラッグ状態の表示 |
| エラー表示               | 明確なエラーメッセージ表示             |
| レスポンシブデザイン     | ウィンドウサイズ変更に追従             |

### 3.3 セキュリティ（NFR-003）

| 項目   | 内容                                       |
| ------ | ------------------------------------------ |
| 要件ID | NFR-003                                    |
| 優先度 | Must                                       |
| 基準   | Electronセキュリティベストプラクティス準拠 |

| 要件                 | 対策                                     |
| -------------------- | ---------------------------------------- |
| IPC通信の安全性      | contextBridge使用、nodeIntegration無効化 |
| パス検証             | パストラバーサル攻撃防止                 |
| ファイルアクセス制限 | 許可されたディレクトリのみアクセス可能   |
| 入力検証             | すべてのIPC引数をZodでバリデーション     |

### 3.4 可用性（NFR-004）

| 項目   | 内容                   |
| ------ | ---------------------- |
| 要件ID | NFR-004                |
| 優先度 | Should                 |
| 基準   | オフライン状態でも動作 |

| 要件           | 説明                                   |
| -------------- | -------------------------------------- |
| オフライン対応 | ネットワーク接続なしで完全動作         |
| エラー回復     | 異常終了後もファイル選択状態を復元可能 |

### 3.5 互換性（NFR-005）

| 項目   | 内容                       |
| ------ | -------------------------- |
| 要件ID | NFR-005                    |
| 優先度 | Must                       |
| 基準   | クロスプラットフォーム対応 |

| 対応OS  | バージョン            |
| ------- | --------------------- |
| macOS   | 12.0 (Monterey) 以降  |
| Windows | 10 (21H2) 以降        |
| Linux   | Ubuntu 20.04 LTS 以降 |

### 3.6 保守性（NFR-006）

| 項目   | 内容                    |
| ------ | ----------------------- |
| 要件ID | NFR-006                 |
| 優先度 | Must                    |
| 基準   | テストカバレッジ80%以上 |

| 要件             | 説明                       |
| ---------------- | -------------------------- |
| テストカバレッジ | 80%以上                    |
| TypeScript型定義 | 厳格モード（strict: true） |
| ESLint準拠       | エラー0、警告0             |
| JSDoc記述        | すべての公開API            |

### 3.7 ファイルサイズ制限（NFR-007）

| 項目   | 内容                                                           |
| ------ | -------------------------------------------------------------- |
| 要件ID | NFR-007                                                        |
| 優先度 | Should                                                         |
| 基準   | 個別ファイルのサイズ制限なし（OSのファイルシステム上限に依存） |

| 要件               | 説明                                                                |
| ------------------ | ------------------------------------------------------------------- |
| 個別ファイルサイズ | 制限なし（後続の変換処理で必要に応じて制限を設ける）                |
| 合計サイズ         | メモリ使用量100MB以内を推奨（step02-nfr.md NFR-PERF-002参照）       |
| ファイル数         | UIの応答性を維持するため100件を推奨上限（制限ではなくガイドライン） |

#### 設計決定の根拠

- ファイル選択機能自体はメタ情報のみを扱うため、ファイルサイズによる制限は不要
- 実際のファイル読み込みは後続の変換処理で行うため、制限はそちらで実装
- ユーザーの利便性を優先し、選択段階での制限は最小限に

---

## 4. ユースケース

### UC-001: ダイアログからファイルを選択

```
アクター: エンドユーザー
前提条件: アプリケーションが起動している
基本フロー:
  1. ユーザーが「ファイルを選択」ボタンをクリック
  2. システムがネイティブファイルダイアログを表示
  3. ユーザーがファイルを選択して「開く」をクリック
  4. システムがファイルメタ情報を取得
  5. システムが選択ファイルリストにファイルを追加
  6. システムがUIにファイル情報を表示
事後条件: ファイルが選択リストに追加されている

代替フロー:
  3a. ユーザーがキャンセル
      3a1. システムがダイアログを閉じる
      3a2. 選択状態は変更されない

例外フロー:
  4a. ファイルメタ情報取得失敗
      4a1. システムがエラーメッセージを表示
      4a2. ファイルは追加されない
```

### UC-002: ドラッグ&ドロップでファイルを選択

```
アクター: エンドユーザー
前提条件: アプリケーションが起動している
基本フロー:
  1. ユーザーがファイルをドロップゾーンにドラッグ
  2. システムがドロップゾーンをハイライト表示
  3. ユーザーがファイルをドロップ
  4. システムがファイルメタ情報を取得
  5. システムが選択ファイルリストにファイルを追加
事後条件: ファイルが選択リストに追加されている

代替フロー:
  1a. ドロップゾーン外にドラッグ
      1a1. ハイライト表示されない
      1a2. ドロップしても何も起きない
```

### UC-003: 複数ファイルを一括選択

```
アクター: エンドユーザー
前提条件: ファイル選択ダイアログが開いている
基本フロー:
  1. ユーザーがCtrl/Cmdキーを押しながら複数ファイルをクリック
  2. システムが選択状態を更新
  3. ユーザーが「開く」をクリック
  4. システムがすべてのファイルのメタ情報を取得
  5. システムが選択ファイルリストに全ファイルを追加
事後条件: 選択したすべてのファイルがリストに追加されている
```

### UC-004: 選択ファイルを削除

```
アクター: エンドユーザー
前提条件: 1つ以上のファイルが選択されている
基本フロー:
  1. ユーザーが削除したいファイルの削除ボタンをクリック
  2. システムが確認なしでファイルをリストから削除
  3. システムがUIを更新
事後条件: 指定したファイルがリストから削除されている
```

---

## 5. データモデル

### 5.1 SelectedFile型

```typescript
// packages/shared/src/types/file.ts

interface SelectedFile {
  /** ユニークID（UUID v4） */
  id: string;
  /** ファイルの絶対パス */
  path: string;
  /** ファイル名（拡張子含む） */
  name: string;
  /** 拡張子（.pdf形式） */
  extension: string;
  /** ファイルサイズ（バイト） */
  size: number;
  /** MIMEタイプ */
  mimeType: string;
  /** ファイルの最終更新日時 */
  lastModified: Date;
  /** 選択日時 */
  createdAt: Date;
}
```

### 5.2 FileSelectionState型

```typescript
// apps/desktop/src/renderer/store/file-store.ts

interface FileSelectionState {
  /** 選択されたファイルのリスト */
  files: SelectedFile[];
  /** 現在のフィルタ設定 */
  filter: FileFilter;
  /** ドラッグ中かどうか */
  isDragging: boolean;
  /** ローディング状態 */
  isLoading: boolean;
  /** エラー情報 */
  error: string | null;
}
```

### 5.3 FileFilter型

```typescript
type FileFilter =
  | "all" // すべてのファイル
  | "office" // オフィス文書
  | "text" // テキスト/マークダウン
  | "media" // メディアファイル
  | "image"; // 画像ファイル
```

---

## 6. インターフェース仕様

### 6.1 IPC通信チャネル

| チャネル名         | 方向          | 説明                         |
| ------------------ | ------------- | ---------------------------- |
| file:open-dialog   | Renderer→Main | ファイル選択ダイアログを開く |
| file:get-metadata  | Renderer→Main | ファイルメタ情報を取得       |
| file:validate-path | Renderer→Main | パスの検証                   |

### 6.2 file:open-dialog

**リクエスト**:

```typescript
interface OpenDialogRequest {
  /** ダイアログタイトル */
  title?: string;
  /** 複数選択を許可するか */
  multiSelections?: boolean;
  /** ファイルフィルタ */
  filters?: Array<{
    name: string;
    extensions: string[];
  }>;
}
```

**レスポンス**:

```typescript
interface OpenDialogResponse {
  /** キャンセルされたか */
  canceled: boolean;
  /** 選択されたファイルパスの配列 */
  filePaths: string[];
}
```

### 6.3 file:get-metadata

**リクエスト**:

```typescript
interface GetMetadataRequest {
  /** ファイルパス */
  filePath: string;
}
```

**レスポンス**:

```typescript
interface GetMetadataResponse {
  /** 成功したか */
  success: boolean;
  /** ファイルメタ情報（成功時） */
  data?: SelectedFile;
  /** エラーメッセージ（失敗時） */
  error?: string;
}
```

---

## 7. UI仕様

### 7.1 コンポーネント構成

```
FileSelector (コンテナ)
├── FileSelectorHeader
│   ├── Title
│   └── FilterDropdown
├── DropZone
│   └── DropZoneContent
├── FileList
│   └── FileListItem (複数)
│       ├── FileIcon
│       ├── FileInfo
│       └── RemoveButton
└── ActionBar
    ├── SelectButton
    └── ClearAllButton
```

### 7.2 状態表示

| 状態             | 表示内容                            |
| ---------------- | ----------------------------------- |
| 初期状態         | ドロップゾーン + 選択ボタン         |
| ドラッグ中       | ハイライト + 「ここにドロップ」表示 |
| ファイル選択済み | ファイルリスト + 追加選択ボタン     |
| ローディング中   | スピナー表示                        |
| エラー           | エラーメッセージ + 再試行ボタン     |

---

## 8. 制約事項

### 8.1 アーキテクチャ制約

| 制約                 | 説明                                                      |
| -------------------- | --------------------------------------------------------- |
| Clean Architecture   | 依存関係は外から内へ（Infrastructure→Application→Domain） |
| TDD必須              | 仕様書 → テスト → 実装の順序                              |
| Specification-Driven | 本仕様書を正とし、実装はその変換結果                      |

### 8.2 技術制約

| 制約           | 内容                      |
| -------------- | ------------------------- |
| Electron IPC   | contextBridge経由のみ許可 |
| 状態管理       | Zustand使用               |
| バリデーション | Zodスキーマ使用           |
| 型定義         | TypeScript strict mode    |

---

## 9. 用語集

| 用語           | 定義                                                         |
| -------------- | ------------------------------------------------------------ |
| ファイル選択   | ユーザーがローカルファイルシステムからファイルを指定する操作 |
| ドロップゾーン | ドラッグ&ドロップを受け付けるUI領域                          |
| メタ情報       | ファイルの名前、サイズ、拡張子等の属性情報                   |
| IPC            | Inter-Process Communication（プロセス間通信）                |
| contextBridge  | Electron Rendererプロセスに安全にAPIを公開する仕組み         |

---

## 10. 承認

| 役割       | 名前         | 日付       | 承認状況 |
| ---------- | ------------ | ---------- | -------- |
| 要件定義者 | .claude/agents/req-analyst.md | 2025-12-16 | 作成済み |
| レビュアー |              |            | 未承認   |
| 承認者     |              |            | 未承認   |

---

## 更新履歴

| バージョン | 日付       | 変更内容 | 変更者       |
| ---------- | ---------- | -------- | ------------ |
| 1.0        | 2025-12-16 | 初版作成 | .claude/agents/req-analyst.md |
