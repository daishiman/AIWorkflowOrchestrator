# データ暗号化機能実装 - タスク指示書

## メタ情報

| 項目             | 内容                           |
| ---------------- | ------------------------------ |
| タスクID         | SECURITY-002                   |
| タスク名         | チャット履歴データの暗号化実装 |
| 分類             | セキュリティ                   |
| 対象機能         | chat-history（データ保存）     |
| 優先度           | 中                             |
| 見積もり規模     | 中規模                         |
| ステータス       | 未実施                         |
| 発見元           | Phase 6 - セキュリティ監査     |
| 発見日           | 2024-12-23                     |
| 発見エージェント | @sec-auditor                   |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

セキュリティ監査（T-06-2）で、チャット履歴データの暗号化に関する以下の課題が発見されました：

**検出箇所**:

```typescript
// packages/shared/src/db/schema/chat-history.ts

// データベース保存時の暗号化なし
content: text("content").notNull(),      // 平文で保存
llmMetadata: text("llm_metadata"),       // 平文で保存
systemPrompt: text("system_prompt"),     // 平文で保存（将来対応）
```

現在の実装では、すべてのチャット内容が平文でSQLiteデータベースに保存されています。

### 1.2 問題点・課題

**OWASP A02: Cryptographic Failures** に関連する脆弱性：

1. **データ漏洩リスク**: データベースファイルが漏洩した場合、チャット内容が平文で露出
2. **機密情報の保護不足**: LLMメタデータ、システムプロンプトも平文保存
3. **規制対応の不備**: GDPR、個人情報保護法等への準拠が不十分

### 1.3 放置した場合の影響

**セキュリティ影響度**: Low（CVSS 3.1）

- **機密性侵害**: デバイス紛失・盗難時にチャット履歴が露出
- **コンプライアンスリスク**: データ保護規制への違反可能性
- **レピュテーションリスク**: セキュリティインシデント発生時の信頼損失

**緩和要因**（現時点）:

- デスクトップアプリのローカルストレージ（外部アクセスなし）
- OSレベルのアクセス制御で保護（ユーザー権限必要）
- FileVault/BitLocker等のディスク暗号化による二重保護（環境依存）

**将来リスク**:

- クラウド同期機能実装時に暗号化が必須
- マルチユーザー環境では重大なセキュリティリスク

---

## 2. 何を達成するか（What）

### 2.1 目的

チャット履歴の機密フィールド（content, llmMetadata, systemPrompt）に対して、適切な暗号化方式を選定・実装し、OWASP A02: Cryptographic Failuresのリスクを低減する。

### 2.2 最終ゴール

- ✅ 暗号化方式が選定されている（SQLCipher vs フィールドレベル暗号化）
- ✅ 機密フィールドが暗号化されて保存される
- ✅ 復号化処理が正しく実装されている
- ✅ 既存データのマイグレーションが完了している
- ✅ パフォーマンス劣化が許容範囲内である
- ✅ すべてのテストが成功している

### 2.3 スコープ

#### 含むもの

- 暗号化方式の技術選定（SQLCipher vs フィールドレベル暗号化）
- 暗号化キー管理方式の設計
- 機密フィールドの暗号化・復号化実装
- 既存データのマイグレーション
- パフォーマンステスト

#### 含まないもの

- ネットワーク通信の暗号化（TLS/SSL）
- ディスク全体の暗号化（OS機能）
- メモリ暗号化
- エンドツーエンド暗号化（E2EE）

### 2.4 成果物

| 種別             | 成果物                 | 配置先                                                            |
| ---------------- | ---------------------- | ----------------------------------------------------------------- |
| 機能             | 暗号化ユーティリティ   | `packages/shared/src/lib/encryption.ts`                           |
| 機能             | 暗号化対応リポジトリ   | `packages/shared/src/repositories/`                               |
| マイグレーション | データ暗号化スクリプト | `packages/shared/drizzle/migrations/`                             |
| テスト           | 暗号化テストケース     | `packages/shared/src/lib/__tests__/encryption.test.ts`            |
| ドキュメント     | 暗号化設計書           | `docs/30-workflows/chat-history-persistence/encryption-design.md` |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- セキュリティ監査（T-06-2）が完了していること
- アクセス制御強化（SECURITY-001）が完了していること（推奨）
- Node.js crypto モジュールが利用可能であること

### 3.2 依存タスク

- T-06-2: セキュリティ監査（完了）
- SECURITY-001: アクセス制御強化（推奨）

### 3.3 必要な知識・スキル

- 暗号化アルゴリズム（AES-256-GCM推奨）
- キー管理（Key Derivation Function: PBKDF2, Argon2）
- SQLite暗号化（SQLCipher）
- Drizzle ORM
- データマイグレーション

### 3.4 推奨アプローチ

**技術選定の判断基準**:

| 方式                   | メリット               | デメリット                   | 推奨シナリオ             |
| ---------------------- | ---------------------- | ---------------------------- | ------------------------ |
| SQLCipher              | DB全体暗号化、実装簡単 | ライセンス懸念、依存追加     | 全フィールド暗号化必要   |
| フィールドレベル暗号化 | 柔軟性高、選択的暗号化 | 実装複雑、パフォーマンス影響 | 一部フィールドのみ暗号化 |

**推奨**: フィールドレベル暗号化（content, llmMetadata, systemPrompt のみ）

- 理由: ライセンス懸念なし、必要最小限の暗号化で性能影響を抑制

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件定義（暗号化要件、キー管理要件）
Phase 1: 設計（暗号化方式選定、キー管理設計）
Phase 2: 設計レビューゲート
Phase 3: テスト作成（TDD: Red）
Phase 4: 実装（TDD: Green）
Phase 5: リファクタリング
Phase 6: 品質保証（パフォーマンステスト含む）
Phase 7: 最終レビューゲート
Phase 8: 手動テスト検証
Phase 9: ドキュメント更新
```

---

### Phase 0: 要件定義

#### T-00-1: 暗号化機能要件定義

##### 目的

暗号化対象フィールド、暗号化強度、キー管理方針を明確化する。

##### 背景

OWASP A02対策として、適切な暗号化要件を定義する必要がある。

##### 責務（単一責務）

暗号化機能の要件を定義する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:define-requirements security-encryption
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@sec-auditor`
- **選定理由**: 暗号化要件・NIST/FIPS基準に精通
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                      | 活用方法                   |
| ----------------------------- | -------------------------- |
| cryptographic-practices       | 暗号化アルゴリズム選定     |
| security-configuration-review | キー管理ベストプラクティス |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物       | パス                                                                    | 内容                           |
| ------------ | ----------------------------------------------------------------------- | ------------------------------ |
| 暗号化要件書 | `docs/30-workflows/chat-history-persistence/requirements-encryption.md` | 暗号化機能の要件・キー管理要件 |

##### 完了条件

- [ ] 暗号化対象フィールドが明確である
- [ ] 暗号化アルゴリズムの要件が定義されている
- [ ] キー管理方針が明確である
- [ ] パフォーマンス要件が定義されている

##### 依存関係

- **前提**: T-06-2
- **後続**: T-01-1

---

### Phase 1: 設計

#### T-01-1: 暗号化方式・キー管理設計

##### 目的

暗号化方式（SQLCipher vs フィールドレベル）を技術選定し、キー管理方法を設計する。

##### 背景

要件を満たしつつ、実装複雑性とパフォーマンスのバランスを取る必要がある。

##### 責務（単一責務）

暗号化アーキテクチャを設計する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:design-architecture encryption-system
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@sec-auditor`
- **選定理由**: 暗号化アーキテクチャ設計の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                | 活用方法                |
| ----------------------- | ----------------------- |
| cryptographic-practices | AES-256-GCM、PBKDF2設計 |
| architectural-patterns  | 暗号化レイヤーの設計    |
| dependency-management   | SQLCipherライセンス評価 |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物       | パス                                                              | 内容                   |
| ------------ | ----------------------------------------------------------------- | ---------------------- |
| 暗号化設計書 | `docs/30-workflows/chat-history-persistence/design-encryption.md` | 方式選定、キー管理設計 |

##### 完了条件

- [ ] 暗号化方式が選定されている（SQLCipher or フィールドレベル）
- [ ] 選定理由が明確である
- [ ] キー管理方法が設計されている（PBKDF2 or Argon2）
- [ ] パフォーマンス影響が評価されている

##### 依存関係

- **前提**: T-00-1
- **後続**: T-02-1

---

### Phase 2: 設計レビューゲート

#### T-02-1: 暗号化設計レビュー

##### 目的

実装前に暗号化方式・キー管理設計の妥当性を検証する。

##### 背景

暗号化実装のミスはセキュリティを無効化するため、設計段階で専門家レビューを実施する。

##### レビュー参加エージェント

| エージェント  | レビュー観点           | 選定理由                               |
| ------------- | ---------------------- | -------------------------------------- |
| @sec-auditor  | 暗号化強度確認         | NIST/FIPS基準への準拠確認              |
| @db-architect | DB設計影響評価         | SQLCipher導入時のDB設計への影響確認    |
| @sre-observer | パフォーマンス影響評価 | 暗号化・復号化のパフォーマンス影響確認 |

- **参照**: `.claude/agents/agent_list.md`

##### レビューチェックリスト

**暗号化強度** (@sec-auditor)

- [ ] アルゴリズムが現代の標準に準拠しているか（AES-256-GCM推奨）
- [ ] キー導出関数が適切か（PBKDF2 100,000回以上、またはArgon2）
- [ ] IVが適切に生成されているか（暗号学的安全な乱数）
- [ ] 認証タグが検証されているか（GCMモード）

**データベース設計** (@db-architect)

- [ ] スキーマ変更が最小限か
- [ ] 既存データのマイグレーション方法が明確か
- [ ] インデックス設計への影響がないか

**パフォーマンス** (@sre-observer)

- [ ] 暗号化・復号化のオーバーヘッドが許容範囲か
- [ ] 大量データ処理時の性能劣化が評価されているか
- [ ] メモリ使用量の増加が許容範囲か

##### 完了条件

- [ ] 全レビュー観点で問題なし、またはMINOR指摘のみ
- [ ] Phase 3（テスト作成）へ進行可能

##### 依存関係

- **前提**: T-01-1
- **後続**: T-03-1

---

### Phase 3: テスト作成（TDD: Red）

#### T-03-1: 暗号化ユニットテスト作成

##### 目的

暗号化・復号化・キー管理機能のテストを実装前に作成する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:generate-unit-tests encryption-module
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@unit-tester`
- **選定理由**: TDD原則に基づくテスト設計の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                | 活用方法                   |
| ----------------------- | -------------------------- |
| tdd-principles          | Red-Green-Refactorサイクル |
| boundary-value-analysis | 暗号化境界値テスト         |
| test-doubles            | 暗号化モジュールのモック化 |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物         | パス                                                   | 内容               |
| -------------- | ------------------------------------------------------ | ------------------ |
| ユニットテスト | `packages/shared/src/lib/__tests__/encryption.test.ts` | 暗号化テストケース |

##### TDD検証: Red状態確認

```bash
pnpm --filter @repo/shared test:run encryption
```

- [ ] テストが失敗することを確認（Red状態）

##### 完了条件

- [ ] 以下のテストケースが実装されている：
  - [ ] 暗号化: 平文→暗号文変換が成功する
  - [ ] 復号化: 暗号文→平文変換が成功する
  - [ ] ラウンドトリップ: encrypt→decrypt で元の値に戻る
  - [ ] キー誤り: 異なるキーで復号化すると失敗する
  - [ ] 改ざん検出: データ改ざん時に検証失敗する（GCM）
- [ ] テストがRed状態（失敗）である

##### 依存関係

- **前提**: T-02-1
- **後続**: T-04-1

---

### Phase 4: 実装（TDD: Green）

#### T-04-1: 暗号化ユーティリティ実装

##### 目的

暗号化・復号化・キー管理のコア機能を実装する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:implement encryption-core
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@sec-auditor`
- **選定理由**: 暗号化実装のベストプラクティス知識
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                | 活用方法              |
| ----------------------- | --------------------- |
| cryptographic-practices | AES-256-GCM実装       |
| type-safety-patterns    | 型安全な暗号化API設計 |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物           | パス                                    | 内容                              |
| ---------------- | --------------------------------------- | --------------------------------- |
| 暗号化モジュール | `packages/shared/src/lib/encryption.ts` | encrypt(), decrypt(), deriveKey() |

##### TDD検証: Green状態確認

```bash
pnpm --filter @repo/shared test:run encryption
```

- [ ] すべてのテストが成功することを確認（Green状態）

##### 完了条件

- [ ] 暗号化関数が実装されている
- [ ] 復号化関数が実装されている
- [ ] キー導出関数が実装されている
- [ ] すべてのユニットテストが成功している

##### 依存関係

- **前提**: T-03-1
- **後続**: T-04-2

---

#### T-04-2: リポジトリ層への暗号化統合

##### 目的

リポジトリのsave()、findById()等に暗号化・復号化を組み込む。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:implement encryption-integration
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@repo-dev`
- **選定理由**: リポジトリパターン実装の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                      | 活用方法             |
| ----------------------------- | -------------------- |
| repository-pattern            | 暗号化レイヤーの統合 |
| clean-architecture-principles | レイヤー分離の維持   |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物               | パス                                                          | 内容                  |
| -------------------- | ------------------------------------------------------------- | --------------------- |
| 暗号化対応リポジトリ | `packages/shared/src/repositories/chat-message-repository.ts` | 暗号化save/復号化find |

##### TDD検証: Green状態確認

```bash
pnpm --filter @repo/shared test:run chat-history
```

- [ ] すべてのchat-historyテストが成功することを確認

##### 完了条件

- [ ] save()で暗号化されて保存される
- [ ] find系メソッドで復号化されて取得される
- [ ] 既存テストが全て成功している

##### 依存関係

- **前提**: T-04-1
- **後続**: T-04-3

---

#### T-04-3: データマイグレーション実装

##### 目的

既存の平文データを暗号化する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:implement data-migration
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@dba-mgr`
- **選定理由**: データマイグレーションの専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名              | 活用方法                       |
| --------------------- | ------------------------------ |
| database-migration    | バックアップ・ロールバック戦略 |
| data-integrity-checks | マイグレーション後の整合性検証 |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物                     | パス                                                      | 内容             |
| -------------------------- | --------------------------------------------------------- | ---------------- |
| マイグレーションスクリプト | `packages/shared/drizzle/migrations/encrypt-chat-data.ts` | データ暗号化処理 |

##### 完了条件

- [ ] マイグレーションスクリプトが実装されている
- [ ] バックアップ機能が含まれている
- [ ] ロールバック機能が含まれている
- [ ] データ整合性検証が実装されている

##### 依存関係

- **前提**: T-04-2
- **後続**: T-05-1

---

### Phase 5: リファクタリング

#### T-05-1: 暗号化コードのリファクタリング

##### 目的

暗号化ロジックの重複を排除し、保守性を向上させる。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:refactor encryption-logic
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@code-quality`
- **選定理由**: Clean Code実践の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名               | 活用方法                |
| ---------------------- | ----------------------- |
| refactoring-techniques | Extract Method、DRY原則 |
| clean-code-practices   | 可読性向上              |

- **参照**: `.claude/skills/skill_list.md`

##### 完了条件

- [ ] コードの重複が排除されている
- [ ] 可読性が向上している
- [ ] すべてのテストが継続成功している

##### 依存関係

- **前提**: T-04-3
- **後続**: T-06-1

---

### Phase 6: 品質保証

#### T-06-1: 暗号化機能の品質・パフォーマンステスト

##### 目的

暗号化機能の品質基準達成と、パフォーマンス劣化が許容範囲内であることを検証する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:run-all-tests --coverage
/ai:benchmark encryption-performance
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@unit-tester`（テスト実行）、`@sre-observer`（パフォーマンス）
- **選定理由**: テスト実行とパフォーマンス分析の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                 | 活用方法           |
| ------------------------ | ------------------ |
| tdd-principles           | TDD品質基準の検証  |
| performance-benchmarking | パフォーマンス測定 |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物                 | パス                                                                   | 内容         |
| ---------------------- | ---------------------------------------------------------------------- | ------------ |
| テストレポート         | `docs/30-workflows/chat-history-persistence/encryption-test-report.md` | テスト結果   |
| パフォーマンスレポート | `docs/30-workflows/chat-history-persistence/encryption-performance.md` | 性能測定結果 |

##### 完了条件

- [ ] 全ユニットテストが成功している
- [ ] 暗号化機能のカバレッジが100%である
- [ ] パフォーマンス劣化が10%以内である（基準値設定）
- [ ] Lintエラーがゼロである
- [ ] 型エラーがゼロである

##### 依存関係

- **前提**: T-05-1
- **後続**: T-07-1

---

### Phase 7: 最終レビューゲート

#### T-07-1: 暗号化実装の最終レビュー

##### 目的

暗号化実装の安全性・パフォーマンスを最終検証する。

##### レビュー参加エージェント

| エージェント  | レビュー観点   | 選定理由                         |
| ------------- | -------------- | -------------------------------- |
| @sec-auditor  | 暗号化実装検証 | 暗号化ベストプラクティス準拠確認 |
| @code-quality | コード品質確認 | Clean Code原則準拠確認           |
| @sre-observer | 本番稼働性確認 | 性能・信頼性の最終確認           |

- **参照**: `.claude/agents/agent_list.md`

##### レビューチェックリスト

**暗号化実装** (@sec-auditor)

- [ ] OWASP A02が完全に解消されているか
- [ ] キー管理が安全か
- [ ] 暗号化強度が十分か

**コード品質** (@code-quality)

- [ ] エラーハンドリングが適切か
- [ ] 可読性・保守性が確保されているか

**本番稼働性** (@sre-observer)

- [ ] パフォーマンスが許容範囲か
- [ ] メモリリークがないか

##### 完了条件

- [ ] 全レビュー観点で問題なし
- [ ] Phase 8（手動テスト）へ進行可能

##### 依存関係

- **前提**: T-06-1
- **後続**: T-08-1

---

### Phase 8: 手動テスト検証

#### T-08-1: 暗号化機能の手動検証

##### 目的

実環境で暗号化・復号化が正しく動作することを確認する。

##### テスト分類

統合テスト

##### 使用エージェント

- **エージェント**: `@e2e-tester`
- **選定理由**: 実環境動作確認の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 手動テストケース

| No  | カテゴリ         | テスト項目       | 前提条件           | 操作手順                                               | 期待結果                            | 実行結果 | 備考 |
| --- | ---------------- | ---------------- | ------------------ | ------------------------------------------------------ | ----------------------------------- | -------- | ---- |
| 1   | 暗号化           | メッセージ保存   | アプリ起動         | 1. チャットでメッセージ送信<br>2. DBファイルを直接確認 | contentが暗号化されて保存されている |          |      |
| 2   | 復号化           | メッセージ表示   | 暗号化データ存在   | 1. チャット履歴を開く<br>2. メッセージを表示           | 正しく復号化されて表示される        |          |      |
| 3   | マイグレーション | 既存データ暗号化 | 平文データ存在     | 1. マイグレーション実行<br>2. DBファイル確認           | 既存データが暗号化される            |          |      |
| 4   | 異常系           | 復号化失敗時     | 暗号化データ改ざん | データ改ざんして読み込み                               | エラーメッセージ表示                |          |      |

##### 成果物

| 成果物         | パス                                                                   | 内容               |
| -------------- | ---------------------------------------------------------------------- | ------------------ |
| 手動テスト結果 | `docs/30-workflows/chat-history-persistence/manual-test-encryption.md` | 手動テスト実行結果 |

##### 完了条件

- [ ] すべての手動テストケースがPASS
- [ ] DBファイルで暗号化が確認できる
- [ ] 復号化エラーが適切にハンドリングされる

##### 依存関係

- **前提**: T-07-1
- **後続**: T-09-1

---

### Phase 9: ドキュメント更新

#### T-09-1: システムドキュメント更新

##### 目的

暗号化機能をシステム要件ドキュメントに反映する。

##### 更新対象ドキュメント

| ドキュメント                                     | 更新内容                         |
| ------------------------------------------------ | -------------------------------- |
| `docs/00-requirements/17-security-guidelines.md` | 暗号化機能の概要を追記           |
| `docs/00-requirements/15-database-design.md`     | 暗号化フィールドの追記           |
| `docs/00-requirements/03-technology-stack.md`    | 暗号化ライブラリ（crypto）を追記 |

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:update-all-docs
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@spec-writer`
- **選定理由**: システムドキュメント更新の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 完了条件

- [ ] 全対象ドキュメントが更新されている
- [ ] 暗号化方式が概要レベルで記載されている

##### 依存関係

- **前提**: T-08-1
- **後続**: なし（完了）

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] 機密フィールドが暗号化されて保存される
- [ ] 復号化処理が正しく実装されている
- [ ] 既存データのマイグレーションが完了している

### 品質要件

- [ ] 全ユニットテスト成功
- [ ] 暗号化機能のカバレッジ100%
- [ ] パフォーマンス劣化10%以内
- [ ] 手動テスト全件PASS

### セキュリティ要件

- [ ] OWASP A02が解消されている
- [ ] キー管理が安全である
- [ ] 改ざん検出機能が実装されている

### ドキュメント要件

- [ ] システムドキュメントが更新されている
- [ ] 暗号化設計書が作成されている

---

## 6. 検証方法

### テストケース

**ユニットテスト**:

```bash
pnpm --filter @repo/shared test:run encryption
pnpm --filter @repo/shared test:run chat-history
```

**パフォーマンステスト**:

```bash
pnpm --filter @repo/shared test:benchmark encryption
```

### 検証手順

1. ユニットテストを実行し、全テスト成功を確認
2. パフォーマンステストで劣化が10%以内であることを確認
3. DBファイルを直接確認し、暗号化されていることを確認
4. 手動テストで実際の動作を確認
5. セキュリティ監査を再実行し、OWASP A02が解消されたことを確認

---

## 7. リスクと対策

| リスク                       | 影響度 | 発生確率 | 対策                                 |
| ---------------------------- | ------ | -------- | ------------------------------------ |
| キー紛失によるデータ復旧不能 | 高     | 低       | キーバックアップ機能の実装           |
| パフォーマンス劣化           | 中     | 中       | ベンチマーク測定、許容範囲の事前設定 |
| マイグレーション失敗         | 高     | 低       | 自動バックアップ、ロールバック機能   |
| 既存コードの互換性破壊       | 中     | 中       | 段階的な導入、deprecation警告        |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/30-workflows/chat-history-persistence/security-audit-report.md` - セキュリティ監査レポート
- `docs/00-requirements/17-security-guidelines.md` - セキュリティガイドライン
- `.claude/agents/sec-auditor.md` - セキュリティ監査エージェント
- `.claude/skills/cryptographic-practices/SKILL.md` - 暗号化実践スキル

### 参考資料

- [OWASP A02: Cryptographic Failures](https://owasp.org/Top10/A02_2021-Cryptographic_Failures/)
- [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
- [Node.js Crypto Module](https://nodejs.org/api/crypto.html)
- [SQLCipher](https://www.zetetic.net/sqlcipher/)

---

## 9. 備考

### レビュー指摘の原文

```
### 2. A02: 暗号化の不備（Low）

**重大度**: Low
**CVSS**: 3.1 (AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

**検出箇所**:
packages/shared/src/db/schema/chat-history.ts
- content: text("content").notNull() // 平文保存
- llmMetadata: text("llm_metadata") // 平文保存

**リスク**: データベースファイルが漏洩した場合、チャット内容が平文で露出

**推奨対策**:
1. SQLCipher導入: SQLiteレベルでの暗号化
2. フィールドレベル暗号化: 機密フィールド（content）の暗号化
3. Turso組み込み暗号化: クラウド移行時にTursoの暗号化機能を活用
```

### 補足事項

**暗号化方式の選定ポイント**:

1. **SQLCipher**: DB全体暗号化、実装簡単、ライセンス（BSD-style）要確認
2. **フィールドレベル暗号化**: Node.js crypto使用、柔軟性高、ライセンス懸念なし

**キー管理の選択肢**:

1. **PBKDF2**: NIST推奨、互換性高、100,000回以上反復
2. **Argon2**: 最新推奨、メモリハード関数、GPU攻撃耐性

**推奨**: フィールドレベル暗号化（AES-256-GCM）+ PBKDF2（簡潔性重視）
