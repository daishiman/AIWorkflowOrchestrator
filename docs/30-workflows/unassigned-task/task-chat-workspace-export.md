# チャット成果物のワークスペース連携機能 - タスク指示書

## メタ情報

| 項目             | 内容                                   |
| ---------------- | -------------------------------------- |
| タスクID         | TASK-CHAT-WS-EXPORT-001                |
| タスク名         | チャット成果物のワークスペース連携機能 |
| 分類             | 新規機能                               |
| 対象機能         | チャット履歴 / ワークスペース          |
| 優先度           | 中                                     |
| 見積もり規模     | 大規模                                 |
| ステータス       | 未実施                                 |
| 発見元           | Phase 7（最終レビューゲート）          |
| 発見日           | 2025-12-23                             |
| 発見エージェント | @product-manager                       |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

チャット履歴永続化機能により、ユーザーとAIの会話履歴をデータベースに保存し、Markdown/JSON形式でエクスポートできるようになった。しかし、現状ではエクスポートされた成果物（Markdownファイル、JSONファイル）はファイルシステムに保存されるだけで、アプリケーション内のワークスペース機能と連携していない。

AIWorkflowOrchestratorの主要機能の一つである「ワークスペース」は、プロジェクト関連のファイルやドキュメントを一元管理する機能である。チャットから生成されたコードスニペット、設計ドキュメント、技術メモなどの成果物をワークスペースで管理できるようにすることで、ユーザーの生産性が向上する。

### 1.2 問題点・課題

1. **成果物の散逸**
   - チャットで生成した有用なコンテンツがローカルファイルに埋もれる
   - 後から必要な情報を探すのに時間がかかる
   - コピー&ペーストでの手動移動が必要

2. **コンテキストの喪失**
   - エクスポートしたファイルとチャットセッションの関連性が失われる
   - どの会話から生成された成果物か追跡できない

3. **再利用性の低下**
   - 類似のプロジェクトで過去の成果物を活用しにくい
   - ワークフローが断片化している

### 1.3 放置した場合の影響

- ユーザーがチャット機能とワークスペース機能を別々に使い続け、一貫した作業フローが確立されない
- チャットから得られた知見が蓄積されず、同じ質問を繰り返すことになる
- 将来のAI機能（RAG検索、自動提案など）でチャット成果物を活用できない

---

## 2. 何を達成するか（What）

### 2.1 目的

チャットセッションから生成された成果物（エクスポートファイル、コードスニペット、ドキュメント）をワークスペースのアセットとして保存・管理できる機能を実装する。

### 2.2 最終ゴール

1. チャットエクスポート時に「ワークスペースに保存」オプションが選択できる
2. コードブロックを直接ワークスペースに保存できる
3. 保存された成果物はワークスペースのファイルブラウザに表示される
4. 成果物から元のチャットセッションへのリンクが維持される
5. ワークスペース内で成果物を検索・フィルタリングできる

### 2.3 スコープ

#### 含むもの

**コードブロック保存**

- コードブロックの「保存」ボタン
- 保存先パスの選択ダイアログ
- 新規ファイル作成
- 既存ファイルへの追記/上書き選択
- 言語に応じた拡張子の自動設定

**チャット履歴保存**

- 会話全体をMarkdownとしてワークスペースに保存
- 選択範囲のみの保存
- メタデータ（日時、LLM、トークン使用量）の含める/含めない選択

**ワークスペース連携**

- 保存先フォルダの指定
- プロジェクト構造に沿った保存
- 保存後のファイルをエディターで開く
- 成果物とチャットセッション間の相互リンク

#### 含まないもの

- リアルタイムのチャット内容同期
- チャット中の自動保存機能
- Git連携（別タスク）
- 外部ストレージへの保存
- マルチユーザー間の成果物共有

### 2.4 成果物

| 種別           | 成果物                        | 配置先                                                     |
| -------------- | ----------------------------- | ---------------------------------------------------------- |
| 設計書         | ワークスペース連携設計書      | `docs/30-workflows/chat-workspace-export/`                 |
| スキーマ       | workspace_assets テーブル拡張 | `packages/shared/src/db/schema/workspace.ts`               |
| コンポーネント | エクスポートダイアログ拡張    | `apps/desktop/src/components/chat/ChatHistoryExport.tsx`   |
| コンポーネント | コードブロック保存UI          | `apps/desktop/src/components/chat/CodeBlockSaveButton.tsx` |
| サービス       | ワークスペース連携サービス    | `packages/shared/src/features/workspace/`                  |
| テスト         | ユニット/統合テスト           | `packages/shared/src/**/__tests__/`                        |
| E2Eテスト      | ワークスペース連携E2Eテスト   | `apps/desktop/e2e/chat-workspace-export.spec.ts`           |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- チャット履歴永続化機能が完了していること
- ワークスペース基本機能が実装されていること
- Electron IPCによるファイルシステム操作が可能であること

### 3.2 依存タスク

| タスクID                 | タスク名               | 状態   |
| ------------------------ | ---------------------- | ------ |
| chat-history-persistence | チャット履歴永続化     | 完了   |
| workspace-basic-features | ワークスペース基本機能 | 要確認 |

### 3.3 必要な知識・スキル

- Drizzle ORMによるスキーマ設計・マイグレーション
- React/TypeScriptによるUIコンポーネント実装
- Electron IPCによるメイン/レンダラープロセス間通信
- ファイルシステム操作（Node.js fs API）
- Apple HIGに準拠したダイアログ設計

### 3.4 推奨アプローチ

1. **段階的実装**: まずエクスポート→ワークスペース保存の基本フローを実装し、後からコードブロック保存、検索・リンク機能を追加
2. **既存UIの拡張**: ChatHistoryExportコンポーネントにオプションを追加する形で実装
3. **メタデータファースト**: ファイル本体の保存より先に、メタデータ管理の設計を固める

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件定義
  T-00-1: 機能要件定義
  T-00-2: 非機能要件定義
Phase 1: 設計
  T-01-1: データベーススキーマ設計
  T-01-2: UI/UX設計
  T-01-3: API/IPC設計
Phase 2: 設計レビューゲート
Phase 3: テスト作成 (TDD: Red)
  T-03-1: サービス層テスト
  T-03-2: UIコンポーネントテスト
Phase 4: 実装 (TDD: Green)
  T-04-1: スキーマ・マイグレーション
  T-04-2: サービス層実装
  T-04-3: UIコンポーネント実装
Phase 5: リファクタリング
Phase 6: 品質保証
Phase 7: 最終レビューゲート
Phase 8: 手動テスト検証
Phase 9: ドキュメント更新
```

### Phase 0: 要件定義

#### T-00-1: 機能要件定義

##### 目的

ワークスペース連携機能の機能要件を明確化する。

##### Claude Code スラッシュコマンド

> 以下はClaude Code内で実行するスラッシュコマンドです

```
/ai:analyze-requirements --target=chat-workspace-export --type=functional
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェントリスト

- **エージェント**: @req-analyst
- **選定理由**: 要件の明確化、ユースケース分析に精通
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキルリスト

| スキル名                    | 活用方法           | 選定理由                   |
| --------------------------- | ------------------ | -------------------------- |
| use-case-modeling           | ユースケース図作成 | ユーザー操作フローの可視化 |
| acceptance-criteria-writing | 受け入れ基準定義   | 検証可能な基準の策定       |

##### 成果物

- `docs/30-workflows/chat-workspace-export/requirements-functional.md`

##### 完了条件

- [ ] 機能要件が定義されている
- [ ] ユースケースが文書化されている
- [ ] 受け入れ基準が明確である

---

### Phase 1: 設計

#### T-01-1: データベーススキーマ設計

##### 目的

workspace_assetsテーブルを拡張し、チャット成果物を管理できるようにする。

##### Claude Code スラッシュコマンド

```
/ai:design-schema --target=workspace-assets --extend=chat-source
```

##### 使用エージェントリスト

- **エージェント**: @db-architect
- **選定理由**: テーブル拡張、外部キー制約、インデックス設計に精通
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキルリスト

| スキル名                | 活用方法                    | 選定理由                   |
| ----------------------- | --------------------------- | -------------------------- |
| database-normalization  | アセットテーブル設計        | 正規化と非正規化のバランス |
| foreign-key-constraints | セッション-アセット関連付け | 参照整合性の確保           |
| indexing-strategies     | 検索最適化インデックス      | クエリパフォーマンス向上   |

##### 成果物

- `docs/30-workflows/chat-workspace-export/schema-design.md`
- マイグレーションSQL設計

##### 完了条件

- [ ] workspace_assets テーブル拡張スキーマが設計されている
- [ ] chat_sessionsとの外部キー関係が定義されている
- [ ] 検索用インデックスが設計されている

---

#### T-01-2: UI/UX設計

##### 目的

エクスポートダイアログとコードブロック保存UIを設計する。

##### Claude Code スラッシュコマンド

```
/ai:design-ui --target=chat-workspace-export --style=apple-hig
```

##### 使用エージェントリスト

- **エージェント**: @ui-designer
- **選定理由**: Apple HIG準拠のUI設計、アクセシビリティ対応に精通
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキルリスト

| スキル名               | 活用方法               | 選定理由            |
| ---------------------- | ---------------------- | ------------------- |
| apple-hig-guidelines   | ダイアログUI設計       | macOSネイティブ体験 |
| accessibility-wcag     | アクセシブルな操作設計 | WCAG 2.1 AA準拠     |
| progressive-disclosure | 段階的な情報表示       | 情報過多の防止      |

##### 成果物

- `docs/30-workflows/chat-workspace-export/ui-design.md`
- ワイヤーフレーム

##### 完了条件

- [ ] エクスポートダイアログ拡張のワイヤーフレームが作成されている
- [ ] コードブロック保存UIのワイヤーフレームが作成されている
- [ ] アクセシビリティ要件が定義されている

---

### Phase 2: 設計レビューゲート

#### 目的

実装前に設計の妥当性を複数エージェントで検証する。

#### レビュー参加エージェント

| エージェント  | レビュー観点             | 選定理由                   |
| ------------- | ------------------------ | -------------------------- |
| @arch-police  | アーキテクチャ整合性     | 既存設計との整合性確認     |
| @db-architect | データベース設計の妥当性 | スキーマ品質検証           |
| @sec-auditor  | セキュリティ考慮事項     | ファイル操作のセキュリティ |

#### 完了条件

- [ ] 設計レビューがPASSまたはMINOR判定

---

### Phase 3: テスト作成 (TDD: Red)

#### T-03-1: サービス層テスト

##### 目的

ワークスペース保存サービスのテストを先行作成する。

##### Claude Code スラッシュコマンド

```
/ai:generate-unit-tests --target=workspace-asset-service --pattern=tdd
```

##### 使用エージェントリスト

- **エージェント**: @unit-tester
- **選定理由**: TDDパターン、モック設計に精通
- **参照**: `.claude/agents/agent_list.md`

##### 成果物

- `packages/shared/src/features/workspace/__tests__/asset-service.test.ts`

##### 完了条件

- [ ] ワークスペース保存のユニットテストが存在
- [ ] テストがRed状態（失敗）であることを確認

---

### Phase 4: 実装 (TDD: Green)

#### T-04-1: スキーマ・マイグレーション

##### Claude Code スラッシュコマンド

```
/ai:implement-schema --target=workspace-assets
```

##### 使用エージェントリスト

- **エージェント**: @db-architect
- **選定理由**: Drizzle ORM、マイグレーション実装に精通

##### 成果物

- `packages/shared/drizzle/migrations/XXXX_extend_workspace_assets.sql`
- `packages/shared/src/db/schema/workspace.ts` 更新

---

#### T-04-2: サービス層実装

##### Claude Code スラッシュコマンド

```
/ai:implement --target=workspace-asset-service
```

##### 使用エージェントリスト

- **エージェント**: @logic-dev
- **選定理由**: ドメインロジック、サービス層実装に精通

##### 成果物

- `packages/shared/src/features/workspace/workspace-asset-service.ts`

---

#### T-04-3: UIコンポーネント実装

##### Claude Code スラッシュコマンド

```
/ai:implement-ui --target=chat-workspace-export
```

##### 使用エージェントリスト

- **エージェント**: @ui-designer
- **選定理由**: Reactコンポーネント実装、Apple HIG準拠に精通

##### 成果物

- `apps/desktop/src/components/chat/ChatHistoryExport.tsx` 拡張
- `apps/desktop/src/components/chat/CodeBlockSaveButton.tsx` 新規

##### 完了条件

- [ ] テストがGreen状態（成功）であることを確認

---

### Phase 5-9

（Phase 5〜9は標準的なTDDサイクル、品質保証、レビュー、手動テスト、ドキュメント更新のフローに従う）

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] エクスポートダイアログに「ワークスペースに保存」チェックボックスが表示される
- [ ] チェック時にワークスペース/フォルダ選択UIが表示される
- [ ] コードブロックに「保存」ボタンが表示される
- [ ] 保存実行後、ワークスペースのファイル一覧に成果物が表示される
- [ ] 既存ファイルへの追記/上書きが選択できる
- [ ] 成果物からチャットセッションへのリンクが機能する
- [ ] 保存後にエディターでファイルを開ける

### 品質要件

- [ ] Lintエラーなし
- [ ] 型エラーなし
- [ ] ユニットテスト成功（カバレッジ80%以上）
- [ ] E2Eテスト成功

### ドキュメント要件

- [ ] API設計ドキュメントが更新されている
- [ ] データベース設計ドキュメントが更新されている

---

## 6. 検証方法

### テストケース

| No  | カテゴリ       | テスト項目         | 操作                                     | 期待結果                                 |
| --- | -------------- | ------------------ | ---------------------------------------- | ---------------------------------------- |
| 1   | エクスポート   | オプション表示     | エクスポートダイアログを開く             | 「ワークスペースに保存」オプションが表示 |
| 2   | エクスポート   | ワークスペース選択 | オプションをチェック                     | ワークスペース選択ドロップダウンが表示   |
| 3   | エクスポート   | 保存実行           | エクスポートを実行                       | ワークスペースに成果物が保存される       |
| 4   | コードブロック | 保存ボタン表示     | コードブロックにホバー                   | 「保存」ボタンが表示される               |
| 5   | コードブロック | 新規ファイル保存   | 保存ボタン→新規ファイル選択              | 指定パスに新規ファイルが作成される       |
| 6   | コードブロック | 既存ファイル追記   | 保存ボタン→既存ファイル選択→追記         | ファイル末尾にコードが追加される         |
| 7   | ワークスペース | 成果物表示         | ワークスペースを開く                     | 保存した成果物がファイル一覧に表示される |
| 8   | リンク         | リンク機能         | 成果物の「元のチャット」リンクをクリック | 対応するチャットセッションが開く         |

### 検証手順

1. デスクトップアプリを起動
2. チャットでコードを含む会話を実施
3. エクスポートダイアログを開き「ワークスペースに保存」をチェック
4. 保存先ワークスペースを選択してエクスポート実行
5. ワークスペースを開き、保存されたファイルを確認
6. ファイルの「元のチャット」リンクをクリックし、セッションが開くことを確認

---

## 7. リスクと対策

| リスク                     | 影響度 | 発生確率 | 対策                                         |
| -------------------------- | ------ | -------- | -------------------------------------------- |
| ワークスペース機能が未完成 | 高     | 中       | 依存関係を事前に確認、必要に応じてスタブ実装 |
| ファイルサイズ制限         | 中     | 中       | 大きなエクスポートの分割保存を検討           |
| パフォーマンス低下         | 中     | 低       | 非同期保存、プログレス表示を実装             |
| 権限エラー                 | 中     | 低       | 書き込み権限チェック、エラーハンドリング強化 |

---

## 8. 参照情報

### 関連ドキュメント

- [チャット履歴永続化 API設計書](../chat-history-persistence/api-design.md)
- [ChatHistoryExportコンポーネント設計書](../chat-history-persistence/component-design.md)
- [UI統合設計書](../chat-history-persistence/ui-integration-design.md)

### 関連ファイル

- `apps/desktop/src/components/chat/ChatHistoryExport.tsx`
- `packages/shared/src/features/chat-history/chat-history-service.ts`
- `apps/desktop/src/renderer/views/ChatHistoryView/index.tsx`

### 参考資料

- [Apple Human Interface Guidelines - Dialogs](https://developer.apple.com/design/human-interface-guidelines/)
- [Electron File System API](https://www.electronjs.org/docs/latest/api/dialog)

---

## 9. 備考

### レビュー指摘の原文

```
Phase 7最終レビューにて、チャット履歴機能の将来拡張として
ワークスペース連携の必要性が指摘された。

ユーザー要望:
「このチャットの履歴をワークスペースの方に渡せたりできるようなシステムを構築したいです。
このチャットでやり取りした成果物をワークスペースの方に保存するような新規作成して
そちらの方に保存するというような形を取りたいです。」
```

### 補足事項

- ワークスペース機能の基本実装状況を確認してから着手すること
- コードブロック保存は言語検出に基づいて適切な拡張子を提案すること
- 将来のRAG検索機能との連携を見据えた設計を心がけること

### 関連タスク

- TASK-CHAT-HISTORY-001: チャット履歴永続化機能（完了）
- TASK-WS-CHAT-EDIT-001: ワークスペースファイルのチャット編集機能

---

## 変更履歴

| バージョン | 日付       | 変更内容                      | 変更者             |
| ---------- | ---------- | ----------------------------- | ------------------ |
| 1.0.0      | 2025-12-11 | 初版作成                      | @product-manager   |
| 1.1.0      | 2025-12-23 | Mitasukテンプレート準拠に拡充 | Phase 9 タスク記録 |
