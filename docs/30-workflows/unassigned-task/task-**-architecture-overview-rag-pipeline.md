# HybridRAG パイプライン アーキテクチャ概要

## 概要

このドキュメントは、**HybridRAG**（GraphRAG + VectorRAG統合）に基づくファイル変換システムの全体アーキテクチャを説明する。8つのタスク（CONV-01〜CONV-08）で構成され、最高精度（90%+）のRAG検索を実現する。

### 採用理由（ベンチマーク実証済み）

| 方式          | 正解率   | 許容含む | 出典         |
| ------------- | -------- | -------- | ------------ |
| VectorRAG単体 | 57.50%   | ~70%     | Lettria 2025 |
| GraphRAG単体  | 81.67%   | 90%+     | Lettria 2025 |
| **HybridRAG** | **90%+** | **95%+** | AWS/Lettria  |

## システム構成図（HybridRAG統合版）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Electron Desktop App                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                      │
│  │   CONV-01    │    │   CONV-05    │    │     UI       │                      │
│  │ ファイル選択  │    │ 履歴/ログ管理 │    │  Components  │                      │
│  └──────┬───────┘    └──────────────┘    └──────────────┘                      │
│         │                                                                       │
│         ▼                                                                       │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │
│  │   CONV-02    │───▶│   CONV-06    │───▶│   CONV-08    │───▶│   CONV-07    │ │
│  │ 変換エンジン  │    │ 埋め込み生成  │    │ グラフ構築   │    │ HybridRAG   │ │
│  │              │    │ + エンティティ │    │ (NEW)        │    │   検索       │ │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘    └──────┬───────┘ │
│         │                   │                   │                   │          │
│         ▼                   ▼                   ▼                   ▼          │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │                         CONV-03 / CONV-04                                │  │
│  │                  JSONスキーマ & データベース基盤                           │  │
│  │                                                                          │  │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ │  │
│  │  │  files    │ │conversions│ │  chunks   │ │ entities  │ │ relations │ │  │
│  │  │ テーブル   │ │ テーブル   │ │ テーブル   │ │ テーブル   │ │ テーブル   │ │  │
│  │  └───────────┘ └───────────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ │  │
│  │                                    │             │             │        │  │
│  │            ┌───────────────────────┴─────────────┴─────────────┘        │  │
│  │            │                                                            │  │
│  │    ┌───────▼───────┐    ┌───────────────┐    ┌───────────────┐         │  │
│  │    │     FTS5      │    │    DiskANN    │    │ Knowledge Graph│         │  │
│  │    │  (キーワード)  │    │   (ベクトル)   │    │   (グラフDB)   │         │  │
│  │    └───────────────┘    └───────────────┘    └───────────────┘         │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│                          Turso / libSQL (SQLite互換)                            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │           外部サービス                    │
                    │                                         │
                    │  ┌───────────┐  ┌───────────────────┐  │
                    │  │ Qwen3     │  │ Cohere Rerank 4   │  │
                    │  │ Embedding │  │                   │  │
                    │  └───────────┘  └───────────────────┘  │
                    │                                         │
                    │  ┌───────────┐  ┌───────────────────┐  │
                    │  │ LLM       │  │ Entity Extractor  │  │
                    │  │ (Claude)  │  │ (NER/関係抽出)     │  │
                    │  └───────────┘  └───────────────────┘  │
                    └─────────────────────────────────────────┘
```

## タスク依存関係

```
CONV-01 (ファイル選択)
    │
    ▼
CONV-02 (変換エンジン) ◄────┐
    │                       │
    ▼                       │
CONV-03 (JSONスキーマ) ─────┤  並行実装可
    │                       │
    ▼                       │
CONV-04 (データベース) ◄────┘
    │
    ├────────────────────────┐
    ▼                        ▼
CONV-05 (履歴/ログ)     CONV-06 (埋め込み + エンティティ抽出)
                             │
                             ▼
                        CONV-08 (Knowledge Graph構築) ← NEW
                             │
                             ▼
                        CONV-07 (HybridRAG検索)
```

## 実装順序（推奨）

| 順序 | タスクID | タスク名                    | 依存             | 備考                      |
| ---- | -------- | --------------------------- | ---------------- | ------------------------- |
| 1    | CONV-01  | ファイル選択機能            | なし             | 最初に実装                |
| 2    | CONV-03  | JSONスキーマ定義            | なし             | CONV-02と並行可           |
| 3    | CONV-02  | ファイル変換エンジン        | CONV-01, CONV-03 | コア機能                  |
| 4    | CONV-04  | データベース基盤            | CONV-03          | FTS5/DiskANN/Graph含む    |
| 5    | CONV-05  | 履歴/ログ管理               | CONV-04          | CONV-06と並行可           |
| 6    | CONV-06  | 埋め込み + エンティティ抽出 | CONV-04          | NER・関係抽出追加         |
| 7    | CONV-08  | **Knowledge Graph構築**     | CONV-06          | **NEW: グラフDB構築**     |
| 8    | CONV-07  | **HybridRAG検索エンジン**   | CONV-08          | 3検索統合 + 4段階フィルタ |

## データフロー

### 1. ファイル取り込みフロー（HybridRAG対応）

```
[ユーザー]
    │
    │ ファイル選択
    ▼
┌─────────────┐
│  CONV-01    │  ファイル情報取得
│ FileSelector │  (パス、サイズ、形式)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  CONV-02    │  ファイル内容読み込み
│ Converter   │  形式変換 (→JSON)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  CONV-04    │  conversions テーブル保存
│ Repository  │  バージョン管理 (is_latest)
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│                    CONV-06                          │
│           埋め込み + エンティティ抽出                │
│                                                     │
│  ┌─────────────────┐    ┌─────────────────┐        │
│  │ Proposition分割  │    │  NER/関係抽出   │        │
│  │ (Dense X方式)    │    │  (エンティティ)  │        │
│  └────────┬────────┘    └────────┬────────┘        │
│           │                      │                  │
│  ┌────────▼────────┐    ┌────────▼────────┐        │
│  │ Contextual      │    │ Entity List    │        │
│  │ Embedding生成   │    │ + Relations    │        │
│  └────────┬────────┘    └────────┬────────┘        │
└───────────┼──────────────────────┼──────────────────┘
            │                      │
            ▼                      ▼
┌───────────────────┐    ┌───────────────────────────┐
│    CONV-04        │    │        CONV-08            │
│   chunks保存      │    │   Knowledge Graph構築      │
│ FTS5/DiskANN更新  │    │  エンティティ・関係保存     │
│                   │    │  コミュニティ検出・要約     │
└───────────────────┘    └───────────────────────────┘
```

### 2. HybridRAG検索フロー（4段階パイプライン）

```
[ユーザークエリ]
       │
       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CONV-07                                        │
│                        HybridRAG Search Engine                              │
│                                                                             │
│  ════════════════════════════════════════════════════════════════════════  │
│  ║                    Stage 1: 並列トリプル検索                           ║  │
│  ════════════════════════════════════════════════════════════════════════  │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│  │  BM25検索       │  │ ベクトル検索    │  │ グラフ検索       │           │
│  │  (FTS5)         │  │ (DiskANN)       │  │ (Knowledge Graph)│           │
│  │                 │  │                 │  │                 │           │
│  │ ・キーワード完全一致│  │ ・セマンティック │  │ ・エンティティ探索│           │
│  │ ・固有名詞検索  │  │ ・意味的類似性  │  │ ・関係性トラバース│           │
│  │ ・HyDE合成クエリ│  │ ・Contextual   │  │ ・コミュニティ要約│           │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘           │
│           │                   │                    │                      │
│           └───────────────────┼────────────────────┘                      │
│                               ▼                                            │
│                    ┌─────────────────────┐                                │
│                    │    RRF Fusion       │  候補 100件統合                 │
│                    │  (3ソース統合)       │                                │
│                    └──────────┬──────────┘                                │
│                               │                                            │
│  ════════════════════════════════════════════════════════════════════════  │
│  ║                    Stage 2: Cross-Encoder Reranking                  ║  │
│  ════════════════════════════════════════════════════════════════════════  │
│                               │                                            │
│                    ┌──────────▼──────────┐                                │
│                    │  Cohere Rerank 4    │  Top 30件に絞り込み            │
│                    │  / Qwen3-Reranker   │  (+48% 検索品質向上)           │
│                    └──────────┬──────────┘                                │
│                               │                                            │
│  ════════════════════════════════════════════════════════════════════════  │
│  ║                    Stage 3: Corrective RAG (CRAG)                    ║  │
│  ════════════════════════════════════════════════════════════════════════  │
│                               │                                            │
│                    ┌──────────▼──────────┐                                │
│                    │  関連性評価         │                                │
│                    │  Correct/Ambiguous/ │  不適切な結果を除外            │
│                    │  Incorrect 判定     │  必要時Web検索フォールバック    │
│                    └──────────┬──────────┘                                │
│                               │                                            │
│  ════════════════════════════════════════════════════════════════════════  │
│  ║                    Stage 4: 意図マッチング + Sufficient Context      ║  │
│  ════════════════════════════════════════════════════════════════════════  │
│                               │                                            │
│                    ┌──────────▼──────────┐                                │
│                    │  LLM意図判定        │  最終 5-10件選定              │
│                    │  + コンテキスト充足性│  (+2-10% 正解率向上)          │
│                    │    評価 (93%精度)   │  ハルシネーション抑制          │
│                    └──────────┬──────────┘                                │
│                               │                                            │
└───────────────────────────────┼──────────────────────────────────────────────┘
                                │
                                ▼
                       [高精度検索結果 (90%+ 正解率)]
```

### 検索モード別ルーティング

| クエリタイプ            | 主要検索手法   | 例                                       |
| ----------------------- | -------------- | ---------------------------------------- |
| **ローカル/具体的**     | BM25 + Vector  | 「エラーコード TS-999の解決方法」        |
| **セマンティック**      | Vector + Graph | 「認証システムの仕組み」                 |
| **グローバル/テーマ**   | Graph主体      | 「このドキュメント全体の主要テーマは？」 |
| **関係性/マルチホップ** | Graph + Vector | 「AとBの関係は？AがCに影響する理由は？」 |

## 技術スタック

### データベース（HybridRAG対応）

| コンポーネント      | 技術              | 用途                       |
| ------------------- | ----------------- | -------------------------- |
| メインDB            | Turso / libSQL    | SQLite互換、エッジ対応     |
| ORM                 | Drizzle ORM       | 型安全なDB操作             |
| 全文検索            | FTS5              | BM25キーワード検索         |
| ベクトル検索        | DiskANN (libSQL)  | コサイン類似度検索         |
| **Knowledge Graph** | **libSQL + 自前** | **エンティティ・関係管理** |

### Knowledge Graph テーブル構造

```sql
-- エンティティテーブル
CREATE TABLE entities (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,           -- person, organization, concept, etc.
  description TEXT,
  embedding BLOB,               -- エンティティ埋め込み
  metadata JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 関係テーブル
CREATE TABLE relations (
  id TEXT PRIMARY KEY,
  source_entity_id TEXT NOT NULL,
  target_entity_id TEXT NOT NULL,
  relation_type TEXT NOT NULL,   -- belongs_to, related_to, causes, etc.
  weight REAL DEFAULT 1.0,
  metadata JSON,
  FOREIGN KEY (source_entity_id) REFERENCES entities(id),
  FOREIGN KEY (target_entity_id) REFERENCES entities(id)
);

-- コミュニティテーブル（GraphRAG用）
CREATE TABLE communities (
  id TEXT PRIMARY KEY,
  level INTEGER NOT NULL,        -- 階層レベル
  summary TEXT,                  -- LLM生成の要約
  summary_embedding BLOB,
  member_entity_ids JSON,        -- 所属エンティティID配列
  parent_community_id TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- チャンク-エンティティ関連
CREATE TABLE chunk_entities (
  chunk_id TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  mention_count INTEGER DEFAULT 1,
  PRIMARY KEY (chunk_id, entity_id)
);
```

### 埋め込みモデル（2025年12月時点推奨）

| モデル                 | 用途                 | 次元数 | 備考                        |
| ---------------------- | -------------------- | ------ | --------------------------- |
| **Qwen3-Embedding-8B** | 本番環境（精度重視） | 4096   | MTEB多言語1位、100+言語対応 |
| Voyage-3-large         | 本番環境             | 1024   | 最高精度、多言語対応        |
| OpenAI 3-large         | 本番環境             | 3072   | 汎用性高、安定              |
| BGE-M3                 | セルフホスト         | 1024   | オンプレミス向け            |
| EmbeddingGemma         | オンデバイス         | 768    | Electron離線対応            |

### チャンキング戦略

| ドキュメントタイプ | 戦略         | トークン数 | オーバーラップ |
| ------------------ | ------------ | ---------- | -------------- |
| 技術文書           | hierarchical | 1024/256   | 親子連携       |
| 一般記事           | semantic     | 256-512    | 10-20%         |
| FAQ                | sentence     | 文単位     | 1-2文          |
| コード             | fixed        | 512        | 50トークン     |

## パフォーマンス目標

| 指標             | 目標値             | 備考                       |
| ---------------- | ------------------ | -------------------------- |
| 検索レイテンシ   | < 100ms            | 1000件データ、ハイブリッド |
| 埋め込み生成     | < 5分/1000チャンク | バッチ処理                 |
| ファイル変換     | < 5秒/1MB          | テキスト系ファイル         |
| インデックス更新 | < 1秒/チャンク     | 増分更新                   |

## セキュリティ考慮事項

1. **APIキー管理**: 埋め込みAPI（OpenAI/Voyage等）のキーは暗号化保存
2. **ローカルファースト**: オフライン時はEmbeddingGemmaにフォールバック
3. **データ分離**: ワークスペースごとにデータを論理分離
4. **入力検証**: ファイル形式・サイズの厳格な検証

## 拡張ポイント

### 将来対応予定

- PDF/Word/Excel変換（CONV-02拡張）
- 外部ベクトルDB連携（Pinecone, Weaviate等）
- マルチモーダル埋め込み（画像、音声）
- クエリキャッシュ・検索履歴分析
- A/Bテストによるパラメータ自動最適化

### 次世代RAGアーキテクチャ（2025年研究動向）

#### Agentic RAG

マルチエージェントによる自律的な検索・推論パイプライン。

```
┌─────────────────────────────────────────────────────┐
│                   Agentic RAG                       │
│                                                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │ Planning │  │ Retrieval│  │ Reasoning│           │
│  │  Agent   │─▶│  Agent   │─▶│  Agent   │           │
│  └─────────┘  └─────────┘  └─────────┘           │
│       │            │            │                  │
│       ▼            ▼            ▼                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │  Tool   │  │ Memory  │  │ Output  │           │
│  │  Use    │  │ Module  │  │Generator│           │
│  └─────────┘  └─────────┘  └─────────┘           │
└─────────────────────────────────────────────────────┘
```

**特徴**:

- 目標推論と自己方向付け
- 反復的な検索・改善サイクル
- マルチエージェント協調
- 参考: [Agentic RAG Survey (arXiv:2501.09136)](https://arxiv.org/abs/2501.09136)

#### GraphRAG（Microsoft）

ナレッジグラフを活用した構造化検索。

```
┌─────────────────────────────────────────────────────┐
│                    GraphRAG                         │
│                                                     │
│  ドキュメント → 知識グラフ抽出 → コミュニティ検出     │
│       │              │                │            │
│       ▼              ▼                ▼            │
│  ┌─────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ エンティティ│  │   関係性    │  │ コミュニティ │   │
│  │   抽出    │  │   マッピング │  │   要約      │   │
│  └─────────┘  └─────────────┘  └─────────────┘   │
│                                                     │
│  【グローバルクエリ対応】                            │
│  「データセットの主要テーマは？」→ コミュニティ要約検索 │
└─────────────────────────────────────────────────────┘
```

**特徴**:

- グローバル/テーマ的クエリに強い（従来RAGの弱点を補完）
- 階層的なコミュニティ構造
- エンティティ間の関係性を活用
- 参考: [Microsoft GraphRAG](https://github.com/microsoft/graphrag)

#### Self-RAG / Corrective RAG

自己反省と修正を行う適応型RAG。

| アプローチ         | 特徴                                        | ユースケース         |
| ------------------ | ------------------------------------------- | -------------------- |
| **Self-RAG**       | 検索要否の自己判断、反復改善                | 探索的研究、長文生成 |
| **Corrective RAG** | 関連性評価、不十分時のWeb検索フォールバック | 精度重視のQA         |
| **Adaptive RAG**   | クエリ複雑性に応じた戦略切り替え            | 汎用システム         |

### 採用技術の主要参考文献（2025年12月）

| 技術                 | 出典             | 効果                 |
| -------------------- | ---------------- | -------------------- |
| Contextual Retrieval | Anthropic        | 検索失敗率67%削減    |
| Sufficient Context   | Google ICLR 2025 | 正解率2-10%向上      |
| Late Chunking        | Jina AI          | コンテキスト保持向上 |
| Hybrid Search (RRF)  | 業界標準         | 精度10-20%向上       |
| Reranking            | Databricks研究   | 検索品質48%向上      |

### プラグインアーキテクチャ

各コンポーネントはプラグイン形式で拡張可能:

```typescript
// コンバーター追加
class PdfConverter implements FileConverter { ... }
converterFactory.register('pdf', PdfConverter);

// 埋め込みプロバイダー追加
class CustomEmbeddingProvider implements EmbeddingProvider { ... }
embeddingFactory.register('custom', CustomEmbeddingProvider);

// 検索戦略追加
class GraphSearchStrategy implements SearchStrategy { ... }
searchService.addStrategy('graph', GraphSearchStrategy);
```

## 関連ドキュメント

- [CONV-01: ファイル選択機能](../completed-tasks/task-01-file-selection.md)
- [CONV-02: ファイル変換エンジン](./task-02-file-conversion-engine.md)
- [CONV-03: JSONスキーマ定義](./task-03-json-schema-definition.md)
- [CONV-04: データベース基盤](./task-04-database-version-management.md)
- [CONV-05: 履歴/ログ管理](./task-05-history-log-management.md)
- [CONV-06: 埋め込み + エンティティ抽出](./task-06-embedding-generation-pipeline.md)
- [CONV-07: HybridRAG検索エンジン](./task-07-hybrid-search-engine.md)
- **[CONV-08: Knowledge Graph構築](./task-08-knowledge-graph-construction.md)** ← NEW

## 参考文献

| 技術                 | 出典                                                                                                                          | 効果                |
| -------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| HybridRAG            | [AWS/Lettria](https://aws.amazon.com/blogs/machine-learning/improving-retrieval-augmented-generation-accuracy-with-graphrag/) | 90%+ 正解率         |
| GraphRAG             | [Microsoft](https://github.com/microsoft/graphrag)                                                                            | 81.67% → 90%+       |
| Contextual Retrieval | [Anthropic](https://www.anthropic.com/news/contextual-retrieval)                                                              | 検索失敗率67%削減   |
| Dense X Retrieval    | [EMNLP 2024](https://arxiv.org/abs/2312.06648)                                                                                | Proposition精度向上 |
| Sufficient Context   | [Google ICLR 2025](https://arxiv.org/abs/2411.06037)                                                                          | 正解率2-10%向上     |
| Reranking            | [Databricks](https://www.databricks.com/blog/reranking-mosaic-ai-vector-search-faster-smarter-retrieval-rag-agents)           | 検索品質48%向上     |

## 更新履歴

| 日付       | 更新内容                                                                         | 担当                        |
| ---------- | -------------------------------------------------------------------------------- | --------------------------- |
| 2025-12-15 | 初版作成（RAGアーキテクチャ統合）                                                | .claude/agents/logic-dev.md |
| 2025-12-15 | 最新論文反映（Contextual Retrieval, CRAG, GraphRAG等）                           | .claude/agents/logic-dev.md |
| 2025-12-15 | **HybridRAG統合版に全面改訂（CONV-08追加、90%+精度目標）**                       | .claude/agents/logic-dev.md |
| 2025-12-25 | **CONV-04-01完了: Drizzle ORM基盤実装（chat_sessions/messages、9インデックス）** | Manual (T-09-1)             |
