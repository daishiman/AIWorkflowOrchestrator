# プロフィールエクスポート機能拡張 - タスク指示書

## メタ情報

| 項目             | 内容                               |
| ---------------- | ---------------------------------- |
| タスクID         | TASK-EXPORT-ENH-001                |
| タスク名         | プロフィールエクスポート機能の拡張 |
| 分類             | 改善                               |
| 対象機能         | User Profile Enhancement           |
| 優先度           | 中                                 |
| 見積もり規模     | 中規模                             |
| ステータス       | 未実施                             |
| 発見元           | Phase 8（手動テスト検証）          |
| 発見日           | 2024-12-11                         |
| 発見エージェント | 手動テスト実行者                   |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

User Profile Enhancement機能の一部として、プロフィールエクスポート機能を実装した。
現在のエクスポート内容には以下が含まれている：

- 表示名
- タイムゾーン
- ロケール
- 通知設定
- ユーザー設定
- 連携プロバイダー一覧
- アカウント作成日
- プラン情報

しかし、手動テストで以下の追加要望が出された：

- AIプロバイダーAPIキーの登録状態（キー自体はマスク）
- 将来的に追加されるユーザー設定項目の拡張性確保

### 1.2 問題点・課題

- 現在のエクスポートにはAIプロバイダーの登録状態が含まれていない
- ユーザーが別デバイスに移行する際、どのプロバイダーを設定済みか分からない
- 将来的な設定項目の拡張に対応できる設計が必要

### 1.3 放置した場合の影響

- ユーザーがデバイス移行時に設定状況を把握できない
- サポート問い合わせ時に現在の設定状態を確認しづらい
- 将来の設定項目追加時に毎回エクスポート機能の修正が必要

---

## 2. 何を達成するか（What）

### 2.1 目的

プロフィールエクスポートに以下の情報を追加し、ユーザーの設定状態を網羅的に把握できるようにする：

1. AIプロバイダー登録状態（APIキー自体は含まない）
2. 将来の拡張に対応した設計

### 2.2 最終ゴール

1. エクスポートJSONにAIプロバイダー情報が含まれる
2. APIキーなどの機密情報はマスク/除外される
3. 将来の設定項目追加時に最小限の変更で対応可能

### 2.3 スコープ

#### 含むもの

- AIプロバイダー登録状態の追加（registered: boolean）
- 最終検証日時の追加（lastValidatedAt）
- エクスポートデータスキーマの拡張
- インポート時の互換性維持（新フィールドはオプショナル）

#### 含まないもの

- APIキー自体のエクスポート（セキュリティ上禁止）
- インポート時のAPIキー復元（別途キー入力が必要）
- 暗号化されたAPIキーのバックアップ機能

### 2.4 成果物

| 種別   | 成果物                  | 配置先                     |
| ------ | ----------------------- | -------------------------- |
| 修正   | profileHandlers.ts      | apps/desktop/src/main/ipc/ |
| 修正   | auth.ts (types)         | packages/shared/types/     |
| 修正   | auth.ts (schemas)       | packages/shared/schemas/   |
| テスト | profileHandlers.test.ts | apps/desktop/src/main/ipc/ |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- APIキー管理機能が実装済みであること
- apiKeyHandlers.tsが正常に動作していること

### 3.2 依存タスク

- なし（独立して実行可能）

### 3.3 必要な知識・スキル

- TypeScript
- Electron IPC通信
- Zodバリデーション
- セキュリティ（機密情報の取り扱い）

### 3.4 推奨アプローチ

1. apiKeyHandlers.tsのlistメソッドを参照してプロバイダー状態を取得
2. エクスポートデータにAIプロバイダー情報を追加
3. スキーマ定義を更新（オプショナルフィールドとして）
4. テストケースを追加

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件確認
Phase 3: テスト作成
Phase 4: 実装
Phase 6: 品質保証
```

### Phase 0: 要件確認

#### 目的

現在のAPIキー管理機能の実装状態を確認する。

#### 使用エージェント

- **エージェント**: @Explore
- **選定理由**: コードベース調査

#### 成果物

| 成果物       | 内容                                |
| ------------ | ----------------------------------- |
| 調査レポート | APIキー管理機能の現在の実装状態確認 |

#### 完了条件

- [ ] apiKeyHandlers.tsのlist機能が確認されている
- [ ] ProviderStatusの型定義が把握されている

---

### Phase 3: テスト作成

#### 目的

AIプロバイダー情報を含むエクスポートのテストを作成する。

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:generate-unit-tests apps/desktop/src/main/ipc/profileHandlers.ts
```

- **参照**: `.claude/commands/ai/command_list.md`

#### 使用エージェント

- **エージェント**: .claude/agents/unit-tester.md
- **選定理由**: エクスポート機能のユニットテスト作成
- **参照**: `.claude/agents/agent_list.md`

#### 完了条件

- [ ] AIプロバイダー情報を含むエクスポートのテストが作成されている
- [ ] テストが失敗することを確認（Red状態）

---

### Phase 4: 実装

#### 目的

エクスポート機能にAIプロバイダー情報を追加する。

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:refactor apps/desktop/src/main/ipc/profileHandlers.ts
```

- **参照**: `.claude/commands/ai/command_list.md`

#### 使用エージェント

- **エージェント**: .claude/agents/logic-dev.md
- **選定理由**: ビジネスロジック実装
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名             | 活用方法                       |
| -------------------- | ------------------------------ |
| .claude/skills/type-safety-patterns/SKILL.md | 型安全なエクスポートデータ構築 |
| .claude/skills/api-client-patterns/SKILL.md  | APIキー状態取得の実装          |

- **参照**: `.claude/skills/skill_list.md`

#### 実装内容

```typescript
// エクスポートデータに追加する情報
interface ExportedAIProviderStatus {
  provider: string; // "openai" | "anthropic" | "google" | "xai"
  registered: boolean; // APIキーが登録されているか
  lastValidatedAt: string | null; // 最終検証日時（ISO 8601）
}

// エクスポートデータ
const exportData: ProfileExportData = {
  // ... 既存フィールド
  aiProviders: [
    { provider: "openai", registered: true, lastValidatedAt: "2024-..." },
    { provider: "anthropic", registered: false, lastValidatedAt: null },
    // ...
  ],
};
```

#### 完了条件

- [ ] AIプロバイダー情報がエクスポートに含まれる
- [ ] APIキー自体は含まれていない（セキュリティ確認）
- [ ] テストが成功する（Green状態）

---

### Phase 6: 品質保証

#### 目的

修正後のコード品質を検証する。

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:run-all-tests --coverage
/ai:lint --fix
```

- **参照**: `.claude/commands/ai/command_list.md`

#### 完了条件

- [ ] 全テスト成功
- [ ] Lintエラーなし
- [ ] 型エラーなし

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] エクスポートJSONにaiProvidersフィールドが含まれる
- [ ] 各プロバイダーのregistered状態が正しい
- [ ] 最終検証日時が含まれる（ある場合）
- [ ] APIキー自体は含まれていない

### 品質要件

- [ ] 全ユニットテスト成功
- [ ] Lintエラーなし
- [ ] 型エラーなし

### ドキュメント要件

- [ ] エクスポートデータ形式のドキュメント更新

---

## 6. 検証方法

### テストケース

1. OpenAIのAPIキーが登録されている場合、registered: trueになる
2. Anthropicが未登録の場合、registered: falseになる
3. lastValidatedAtが正しいISO 8601形式である
4. エクスポートファイルにAPIキー文字列が含まれていない

### 検証手順

1. 設定画面でAPIキーを登録/削除
2. エクスポートを実行
3. JSONファイルを開いてaiProvidersフィールドを確認
4. APIキー文字列が含まれていないことを確認

---

## 7. リスクと対策

| リスク                 | 影響度 | 発生確率 | 対策                             |
| ---------------------- | ------ | -------- | -------------------------------- |
| APIキー漏洩            | 高     | 低       | 登録状態のみ出力、キー自体は除外 |
| 互換性問題             | 中     | 低       | オプショナルフィールドとして追加 |
| apiKeyHandlersとの依存 | 中     | 低       | 依存関係を明確化、モック対応     |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/30-workflows/user-profile-enhancement/` - User Profile Enhancement実装ドキュメント
- `docs/30-workflows/api-key-management/` - APIキー管理機能ドキュメント

### 関連ファイル

- `apps/desktop/src/main/ipc/profileHandlers.ts`
- `apps/desktop/src/main/ipc/apiKeyHandlers.ts`
- `packages/shared/types/auth.ts`
- `packages/shared/types/api-keys.ts`

---

## 9. 備考

### レビュー指摘の原文（該当する場合）

```
プロフィールに含んでいる内容がこれだけですか？今の現状のプロフィールの内容だけだと不十分だと思います。
今ユーザーが持っている情報に関して、全て出力するようにしてほしいです。
ただし、APIキーの設定などはマスクした状態で出力するようにしてほしいです。
連携しているサービスに関しての情報も記述しておくようにしておいてください。
システム上問題があるようなものはマスクしておいてください。
将来的にここにどういう情報を入れたらいいかっていうところも管理したいかなと思っています。
```

### 補足事項

- 現在の実装では連携プロバイダー情報（OAuth）は既に含まれている
- AIプロバイダー情報の追加が主な対応内容
- 将来的な拡張は、このタスク完了後に別タスクとして検討

### 将来追加を検討する情報

以下は将来的にエクスポートに含めることを検討：

1. **ワークフロー設定**
   - カスタムワークフロー定義
   - 実行履歴サマリー

2. **UIカスタマイズ設定**
   - テーマ設定
   - レイアウト設定

3. **キーボードショートカット設定**
   - カスタムショートカット

4. **プラグイン設定**
   - インストール済みプラグイン一覧
   - プラグイン個別設定

これらの情報追加は、各機能実装時に合わせて行う。
