# チャット履歴管理 - 機能要件定義書

## 概要

### 目的

AIチャットの会話履歴を永続化し、フォルダ構造で整理・検索できるようにする。

### 背景

現在のChatSliceはメモリ内のみで履歴を保持しており、アプリ再起動で消失する。ユーザーが過去の会話を参照・整理できる機能が必要。

### スコープ

- チャットセッションの永続化
- フォルダによる階層的な整理
- タイトル・内容による検索
- セッション間の切り替え

---

## 機能要件

### FR-CH-001: チャットセッション管理

#### 説明

個別のチャット会話をセッションとして管理する。

#### 受け入れ基準

- [ ] 新規チャットセッションを作成できる
- [ ] セッションにタイトルを設定できる（自動生成 + 手動編集）
- [ ] セッションを削除できる
- [ ] セッション一覧を表示できる
- [ ] セッションを選択して会話を再開できる
- [ ] セッションの作成日時・更新日時が記録される

#### データモデル

```typescript
interface ChatSession {
  id: string; // UUID
  title: string; // セッションタイトル
  folderId: string | null; // 所属フォルダID（nullはルート）
  messages: ChatMessage[]; // メッセージ配列
  createdAt: Date; // 作成日時
  updatedAt: Date; // 更新日時
  metadata?: {
    aiProvider?: string; // 使用AIプロバイダー
    totalTokens?: number; // 累計トークン数
  };
}

interface ChatMessage {
  id: string;
  role: "user" | "assistant";
  content: string;
  timestamp: Date;
  isStreaming?: boolean;
}
```

---

### FR-CH-002: フォルダ管理

#### 説明

チャットセッションをフォルダで階層的に整理する。

#### 受け入れ基準

- [ ] フォルダを作成できる
- [ ] フォルダ名を編集できる
- [ ] フォルダを削除できる（中身ごと削除 or ルートに移動を選択）
- [ ] フォルダをネストできる（最大3階層）
- [ ] セッションをフォルダ間で移動できる（ドラッグ&ドロップ）
- [ ] フォルダを展開・折りたたみできる

#### データモデル

```typescript
interface ChatFolder {
  id: string; // UUID
  name: string; // フォルダ名
  parentId: string | null; // 親フォルダID（nullはルート）
  order: number; // 表示順序
  createdAt: Date;
  updatedAt: Date;
  isExpanded?: boolean; // UI状態（展開/折りたたみ）
}
```

---

### FR-CH-003: 検索機能

#### 説明

チャット履歴をタイトル・内容で検索する。

#### 受け入れ基準

- [ ] セッションタイトルで検索できる
- [ ] メッセージ内容で全文検索できる
- [ ] 検索結果をハイライト表示する
- [ ] 検索結果からセッションにジャンプできる
- [ ] 検索はリアルタイム（インクリメンタル）で行う
- [ ] 検索対象フォルダを指定できる（オプション）

#### 検索仕様

- 部分一致検索
- 大文字小文字を区別しない
- 日本語対応（形態素解析なし、単純マッチング）
- 検索結果は更新日時の降順でソート

---

### FR-CH-004: 自動タイトル生成

#### 説明

チャット開始時に最初のメッセージからタイトルを自動生成する。

#### 受け入れ基準

- [ ] 最初のユーザーメッセージから自動的にタイトルを生成する
- [ ] タイトルは最大30文字（超過時は省略）
- [ ] 自動生成されたタイトルは後から編集可能
- [ ] 「新規チャット」がデフォルトタイトル

---

### FR-CH-005: データ永続化

#### 説明

チャット履歴をローカルストレージに永続化する。

#### 受け入れ基準

- [ ] アプリ終了時に自動保存される
- [ ] アプリ起動時に自動復元される
- [ ] メッセージ追加ごとに自動保存される（デバウンス: 1秒）
- [ ] 保存エラー時にユーザーに通知する
- [ ] エクスポート機能（JSON形式）
- [ ] インポート機能（JSON形式）

#### 永続化方法

- electron-storeを使用
- 暗号化は不要（機密情報なし）
- ストレージパス: `userData/chat-history.json`

---

## 非機能要件

### NFR-CH-001: パフォーマンス

- セッション一覧表示: 100ms以内
- 検索応答: 200ms以内（1000セッションまで）
- セッション切り替え: 100ms以内

### NFR-CH-002: データ制限

- 1セッションあたり最大メッセージ数: 1000件
- 1メッセージあたり最大文字数: 100,000文字
- 総セッション数: 制限なし（ディスク容量による）
- 総フォルダ数: 100フォルダ

### NFR-CH-003: アクセシビリティ

- キーボードナビゲーション対応
- スクリーンリーダー対応
- フォーカス管理

---

## UI/UX要件

### サイドバーレイアウト

```
┌─────────────────────────────────┐
│ [🔍 検索...]                    │
├─────────────────────────────────┤
│ [+ 新規チャット]                │
├─────────────────────────────────┤
│ 📁 プロジェクトA                │
│   ├─ 💬 API設計の相談           │
│   └─ 💬 バグ修正について         │
│ 📁 学習                         │
│   └─ 💬 TypeScript入門          │
│ 💬 一般的な質問                 │
│ 💬 今日のチャット               │
└─────────────────────────────────┘
```

### インタラクション

- 右クリックでコンテキストメニュー（名前変更、削除、移動）
- ダブルクリックで名前編集
- ドラッグ&ドロップでフォルダ移動

---

## IPCチャネル定義

```typescript
// チャネル名
const CHAT_HISTORY_CHANNELS = {
  // セッション操作
  SESSION_CREATE: "chat:session:create",
  SESSION_GET: "chat:session:get",
  SESSION_GET_ALL: "chat:session:getAll",
  SESSION_UPDATE: "chat:session:update",
  SESSION_DELETE: "chat:session:delete",

  // フォルダ操作
  FOLDER_CREATE: "chat:folder:create",
  FOLDER_GET_ALL: "chat:folder:getAll",
  FOLDER_UPDATE: "chat:folder:update",
  FOLDER_DELETE: "chat:folder:delete",

  // 検索
  SEARCH: "chat:search",

  // エクスポート/インポート
  EXPORT: "chat:export",
  IMPORT: "chat:import",
} as const;
```

---

## ユースケース

### UC-CH-001: 新規チャットを開始する

1. ユーザーが「新規チャット」ボタンをクリック
2. 新しいセッションが作成される（タイトル: "新規チャット"）
3. チャットビューが新しいセッションに切り替わる
4. ユーザーがメッセージを入力・送信
5. 最初のメッセージからタイトルが自動生成される

### UC-CH-002: 過去のチャットを検索・再開する

1. ユーザーが検索ボックスにキーワードを入力
2. リアルタイムで検索結果が表示される
3. ユーザーが検索結果のセッションをクリック
4. チャットビューが選択されたセッションに切り替わる
5. 過去のメッセージが表示され、会話を継続できる

### UC-CH-003: チャットをフォルダで整理する

1. ユーザーが「新規フォルダ」を作成
2. フォルダ名を入力
3. 既存のセッションをドラッグ&ドロップでフォルダに移動
4. フォルダを展開/折りたたみして表示を整理

---

## 依存関係

### 既存コンポーネント

- `ChatSlice` - 現在のチャット状態管理（拡張が必要）
- `ChatView` - チャット表示コンポーネント（サイドバー追加が必要）
- `storeHandlers` - electron-store操作（新規チャネル追加が必要）

### 新規コンポーネント

- `ChatHistorySidebar` - 履歴サイドバー（organism）
- `ChatSessionItem` - セッション項目（molecule）
- `ChatFolderItem` - フォルダ項目（molecule）
- `ChatSearchInput` - 検索入力（molecule）
- `chatHistorySlice` - 履歴状態管理（store slice）
- `chatHistoryHandlers` - IPCハンドラー（main process）
