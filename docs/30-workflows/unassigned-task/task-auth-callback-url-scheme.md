# èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã‚¹ã‚­ãƒ¼ãƒ ä¿®æ­£ - ã‚¿ã‚¹ã‚¯å®Ÿè¡Œä»•æ§˜æ›¸

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…ƒã®æŒ‡ç¤º

```
èªè¨¼æ©Ÿèƒ½ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã‚¹ã‚­ãƒ¼ãƒ ï¼ˆaiworkflow://auth/callbackï¼‰ãŒ
OSã«ç™»éŒ²ã•ã‚Œã¦ãŠã‚‰ãšã€èªè¨¼å®Œäº†å¾Œã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ã€‚
ç¾åœ¨ã¯ä¸€æ™‚çš„ã«èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹ãŒã€å°†æ¥çš„ã«èªè¨¼æ©Ÿèƒ½ã‚’å¾©æ´»ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
```

## ãƒ¡ã‚¿æƒ…å ±

| é …ç›®         | å†…å®¹                            |
| ------------ | ------------------------------- |
| ã‚¿ã‚¹ã‚¯ID     | TASK-AUTH-CALLBACK-001          |
| Worktreeãƒ‘ã‚¹ | `.worktrees/task-{{timestamp}}` |
| ãƒ–ãƒ©ãƒ³ãƒå   | `task-{{timestamp}}`            |
| ã‚¿ã‚¹ã‚¯å     | èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã‚¹ã‚­ãƒ¼ãƒ ä¿®æ­£ |
| åˆ†é¡         | ãƒã‚°ä¿®æ­£ãƒ»æ©Ÿèƒ½æ”¹å–„              |
| å¯¾è±¡æ©Ÿèƒ½     | èªè¨¼                            |
| å„ªå…ˆåº¦       | ä¸­                              |
| è¦‹ç©ã‚‚ã‚Šè¦æ¨¡ | ä¸­è¦æ¨¡                          |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹   | æœªå®Ÿæ–½                          |
| ä½œæˆæ—¥       | 2025-12-26                      |

---

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

### ç›®çš„

Electron ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® OAuth èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã€ã‚«ã‚¹ã‚¿ãƒ URLã‚¹ã‚­ãƒ¼ãƒ ï¼ˆ`aiworkflow://`ï¼‰ã‚’OSã«ç™»éŒ²ã—ã€èªè¨¼ãƒ•ãƒ­ãƒ¼å®Œäº†å¾Œã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ããƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

### èƒŒæ™¯

ç¾çŠ¶ã€Supabase OAuthèªè¨¼å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLï¼ˆ`aiworkflow://auth/callback#access_token=...`ï¼‰ãŒã€OSã«URLã‚¹ã‚­ãƒ¼ãƒ ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼š

```
URL aiworkflow://auth/callback#access_token=... ã‚’é–‹ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
```

ã“ã‚Œã«ã‚ˆã‚Šã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‰ãšã€èªè¨¼ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã—ãªã„ã€‚

**ä¸€æ™‚çš„ãªå¯¾ç­–**:

- `devMockAuth.ts` ã® `isDevMode()` ã‚’å¼·åˆ¶çš„ã« `true` ã«è¨­å®š
- ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆdaishimanju@gmail.comï¼‰ã§èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
- å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿æŒã—ã¦å°†æ¥ã®èªè¨¼æ©Ÿèƒ½å¾©æ´»ã«å‚™ãˆã‚‹

### æœ€çµ‚ã‚´ãƒ¼ãƒ«

- ã‚«ã‚¹ã‚¿ãƒ URLã‚¹ã‚­ãƒ¼ãƒ  `aiworkflow://` ãŒOSã«æ­£ã—ãç™»éŒ²ã•ã‚Œã‚‹
- OAuthèªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ­£ã—ãæ¸¡ã•ã‚Œã‚‹
- é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å®Ÿéš›ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã«ç§»è¡Œã§ãã‚‹
- æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨é€£å‹•ã™ã‚‹

### æˆæœç‰©ä¸€è¦§

| ç¨®åˆ¥         | æˆæœç‰©               | é…ç½®å…ˆ                                       |
| ------------ | -------------------- | -------------------------------------------- |
| ç’°å¢ƒ         | Git Worktreeç’°å¢ƒ     | `.worktrees/task-{{timestamp}}`              |
| æ©Ÿèƒ½         | URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²æ©Ÿèƒ½  | `apps/desktop/electron-builder.config.js`    |
| æ©Ÿèƒ½         | Deep Link ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ | `apps/desktop/src/main/index.ts`             |
| æ©Ÿèƒ½         | èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† | `apps/desktop/src/main/ipc/authHandlers.ts`  |
| ãƒ†ã‚¹ãƒˆ       | URLã‚¹ã‚­ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ    | `apps/desktop/src/**/*.test.ts`              |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | è¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ     | `docs/30-workflows/auth-callback-urlscheme/` |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ     | `docs/30-workflows/auth-callback-urlscheme/` |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ   | `docs/30-workflows/auth-callback-urlscheme/` |
| PR           | GitHub Pull Request  | GitHub UI                                    |

---

## å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«

æœ¬ä»•æ§˜æ›¸ã®ã‚³ãƒãƒ³ãƒ‰é¸å®šã¯ä»¥ä¸‹ã‚’å‚ç…§ï¼š

- `docs/00-requirements/master_system_design.md` - ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
- `docs/00-requirements/17-security-guidelines.md` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- `.claude/commands/ai/command_list.md` - /ai:ã‚³ãƒãƒ³ãƒ‰å®šç¾©
- `.kamui/prompt/merge-prompt.txt` - Git/PRãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

---

## ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚µãƒãƒªãƒ¼

| ID     | ãƒ•ã‚§ãƒ¼ã‚º | ã‚µãƒ–ã‚¿ã‚¹ã‚¯å                  | è²¬å‹™                               | ä¾å­˜     |
| ------ | -------- | ----------------------------- | ---------------------------------- | -------- |
| T--1-1 | Phase -1 | Git Worktreeç’°å¢ƒä½œæˆãƒ»åˆæœŸåŒ–  | Git Worktreeç’°å¢ƒã®ä½œæˆã¨åˆæœŸåŒ–     | ãªã—     |
| T-00-1 | Phase 0  | æ©Ÿèƒ½è¦ä»¶å®šç¾©                  | URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²æ©Ÿèƒ½ã®è¦ä»¶ã‚’æ˜æ–‡åŒ–  | T--1-1   |
| T-01-1 | Phase 1  | URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²è¨­è¨ˆ           | electron-builderè¨­å®šã®è¨­è¨ˆ         | T-00-1   |
| T-01-2 | Phase 1  | Deep Linkãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­è¨ˆ       | main ãƒ—ãƒ­ã‚»ã‚¹ã§ã®URLå—ä¿¡å‡¦ç†è¨­è¨ˆ   | T-00-1   |
| T-01-3 | Phase 1  | èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†è¨­è¨ˆ      | ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºãƒ»æ¤œè¨¼ãƒ»çŠ¶æ…‹æ›´æ–°ã®è¨­è¨ˆ | T-00-1   |
| T-02-1 | Phase 2  | è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼                  | è¦ä»¶ãƒ»è¨­è¨ˆã®å¦¥å½“æ€§æ¤œè¨¼             | T-01-1~3 |
| T-03-1 | Phase 3  | URLã‚¹ã‚­ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆä½œæˆ         | URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²ã®æ¤œè¨¼ãƒ†ã‚¹ãƒˆä½œæˆ    | T-02-1   |
| T-03-2 | Phase 3  | Deep Linkãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆä½œæˆ | URLå—ä¿¡å‡¦ç†ã®ãƒ†ã‚¹ãƒˆä½œæˆ            | T-02-1   |
| T-03-3 | Phase 3  | èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆä½œæˆ    | ãƒˆãƒ¼ã‚¯ãƒ³å‡¦ç†ã®ãƒ†ã‚¹ãƒˆä½œæˆ           | T-02-1   |
| T-04-1 | Phase 4  | URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²å®Ÿè£…           | electron-builder.config.js ã®è¨­å®š  | T-03-1   |
| T-04-2 | Phase 4  | Deep Linkãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…       | mainãƒ—ãƒ­ã‚»ã‚¹ã®URLå—ä¿¡å‡¦ç†å®Ÿè£…      | T-03-2   |
| T-04-3 | Phase 4  | èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Ÿè£…      | ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºãƒ»æ¤œè¨¼ãƒ»çŠ¶æ…‹æ›´æ–°ã®å®Ÿè£… | T-03-3   |
| T-04-4 | Phase 4  | devMockAuth.ts å¾©å…ƒ           | ä¸€æ™‚çš„ãªä¿®æ­£ã‚’å…ƒã«æˆ»ã™             | T-04-1~3 |
| T-05-1 | Phase 5  | ã‚³ãƒ¼ãƒ‰ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°        | ã‚³ãƒ¼ãƒ‰å“è³ªã®æ”¹å–„                   | T-04-1~4 |
| T-06-1 | Phase 6  | å“è³ªä¿è¨¼                      | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»å“è³ªãƒã‚§ãƒƒã‚¯           | T-05-1   |
| T-07-1 | Phase 7  | æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼                  | å…¨ä½“çš„ãªå“è³ªãƒ»æ•´åˆæ€§æ¤œè¨¼           | T-06-1   |
| T-08-1 | Phase 8  | æ‰‹å‹•ãƒ†ã‚¹ãƒˆæ¤œè¨¼                | OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®æ‰‹å‹•ç¢ºèª      | T-07-1   |
| T-09-1 | Phase 9  | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°              | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç­‰ã®æ›´æ–°   | T-08-1   |
| T-10-1 | Phase 10 | ã‚³ãƒŸãƒƒãƒˆä½œæˆ                  | å·®åˆ†ç¢ºèªãƒ»ã‚³ãƒŸãƒƒãƒˆä½œæˆ             | T-09-1   |
| T-10-2 | Phase 10 | PRä½œæˆ                        | PRä½œæˆãƒ»CIç¢ºèª                     | T-10-1   |

**ç·ã‚µãƒ–ã‚¿ã‚¹ã‚¯æ•°**: 20å€‹

---

## ç¾åœ¨ã®çŠ¶æ³ï¼ˆä¸€æ™‚çš„ãªä¿®æ­£å†…å®¹ï¼‰

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

**`apps/desktop/src/renderer/utils/devMockAuth.ts:22-31`**

```typescript
export function isDevMode(): boolean {
  // æœ¬ç•ªç’°å¢ƒã§ã¯å¸¸ã«false
  if (import.meta.env.PROD) {
    return false;
  }

  // ğŸ”§ ä¸€æ™‚çš„ãªä¿®æ­£: é–‹ç™ºç’°å¢ƒã§ã¯å¸¸ã«èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
  // TODO: èªè¨¼æ©Ÿèƒ½ã‚’å¾©æ´»ã•ã›ã‚‹éš›ã«ã“ã®è¡Œã‚’å‰Šé™¤
  // é–¢é€£ã‚¿ã‚¹ã‚¯: docs/30-workflows/unassigned-task/task-auth-callback-url-scheme.md
  return true;

  // ... ä»¥ä¸‹ã€æœ¬æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç¾åœ¨ã¯åˆ°é”ä¸èƒ½ï¼‰
}
```

**`apps/desktop/src/renderer/utils/devMockAuth.ts:82-90`**

```typescript
export const DEFAULT_MOCK_USER: MockUser = {
  id: "34d1ff23-db41-4201-9ede-4ba55b6ea202", // å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  email: "daishimanju@gmail.com", // å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  displayName: "Daishi Manju",
  avatarUrl: null,
  provider: "google" as OAuthProvider,
  createdAt: new Date().toISOString(),
  lastSignInAt: new Date().toISOString(),
};
```

### å¾©å…ƒæ‰‹é †ï¼ˆå°†æ¥ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œæ™‚ï¼‰

ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®ä¸€æ™‚ä¿®æ­£ã‚’å…ƒã«æˆ»ã™ï¼š

1. `devMockAuth.ts:31` ã® `return true;` ã‚’å‰Šé™¤
2. ãã®ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ãªã„æœ¬æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–
3. `DEFAULT_MOCK_USER` ã¯å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿æŒï¼ˆé€£å‹•ã®ãŸã‚å¤‰æ›´ä¸è¦ï¼‰

---

## Phase 0: è¦ä»¶å®šç¾©

### T-00-1: æ©Ÿèƒ½è¦ä»¶å®šç¾©

#### ç›®çš„

ã‚«ã‚¹ã‚¿ãƒ URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²ã¨OAuthèªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®è¦ä»¶ã‚’æ˜æ–‡åŒ–ã™ã‚‹ã€‚

#### æ©Ÿèƒ½è¦ä»¶

| ID     | è¦ä»¶                                                     | å„ªå…ˆåº¦ |
| ------ | -------------------------------------------------------- | ------ |
| FR-001 | `aiworkflow://` URLã‚¹ã‚­ãƒ¼ãƒ ã‚’OSã«ç™»éŒ²ã™ã‚‹                | å¿…é ˆ   |
| FR-002 | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«URLã‚¹ã‚­ãƒ¼ãƒ ã‚’é–¢é€£ä»˜ã‘ã‚‹          | å¿…é ˆ   |
| FR-003 | ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã‚’å—ä¿¡ã™ã‚‹                  | å¿…é ˆ   |
| FR-004 | URLã‹ã‚‰access_tokenã€refresh_tokenã€expires_atã‚’æŠ½å‡ºã™ã‚‹ | å¿…é ˆ   |
| FR-005 | æŠ½å‡ºã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¨­å®šã™ã‚‹           | å¿…é ˆ   |
| FR-006 | èªè¨¼æˆåŠŸå¾Œã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«è¡¨ç¤ºã™ã‚‹ | å¿…é ˆ   |
| FR-007 | èªè¨¼å¤±æ•—æ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹             | å¿…é ˆ   |
| FR-008 | æ—¢å­˜ã®ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆdaishimanju@gmail.comï¼‰ã¨é€£å‹•ã™ã‚‹  | å¿…é ˆ   |

#### éæ©Ÿèƒ½è¦ä»¶

| ID      | è¦ä»¶                                          | åŸºæº–å€¤    |
| ------- | --------------------------------------------- | --------- |
| NFR-001 | ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹                  | 500msä»¥å†… |
| NFR-002 | ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯          | å¿…é ˆ      |
| NFR-003 | macOSã€Windowsã€Linux ã§ã®URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²å¯¾å¿œ | å¿…é ˆ      |

#### ã‚¹ã‚³ãƒ¼ãƒ—å®šç¾©

**å«ã‚€ã‚‚ã®**:

- electron-builder ã«ã‚ˆã‚‹ URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²
- main ãƒ—ãƒ­ã‚»ã‚¹ã§ã® Deep Link ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…
- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æŠ½å‡ºãƒ»æ¤œè¨¼ãƒ»ä¿å­˜
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**å«ã¾ãªã„ã‚‚ã®**:

- OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼è‡ªä½“ã®å¤‰æ›´ï¼ˆSupabaseå´ï¼‰
- èªè¨¼UI ã®å¤‰æ›´
- è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚µãƒãƒ¼ãƒˆï¼ˆå˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰

#### æˆæœç‰©

| æˆæœç‰©     | ãƒ‘ã‚¹                                                                    | å†…å®¹                 |
| ---------- | ----------------------------------------------------------------------- | -------------------- |
| è¦ä»¶å®šç¾©æ›¸ | `docs/30-workflows/auth-callback-urlscheme/task-step00-requirements.md` | æ©Ÿèƒ½è¦ä»¶ãƒ»éæ©Ÿèƒ½è¦ä»¶ |

---

## Phase 1: è¨­è¨ˆ

### T-01-1: URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²è¨­è¨ˆ

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:setup-electron-config
```

#### ç›®çš„

electron-builder è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚«ã‚¹ã‚¿ãƒ URLã‚¹ã‚­ãƒ¼ãƒ ã‚’ç™»éŒ²ã™ã‚‹è¨­è¨ˆã‚’è¡Œã†ã€‚

#### å‚ç…§è³‡æ–™

- `apps/desktop/electron-builder.config.js` - æ—¢å­˜ã®Electron Builderè¨­å®š
- Electronå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: [Custom Protocol](https://www.electronjs.org/docs/latest/tutorial/launch-app-from-url-in-another-app)

#### è¨­è¨ˆå†…å®¹

**macOS**:

```json
{
  "protocols": [
    {
      "name": "AI Workflow Orchestrator",
      "schemes": ["aiworkflow"]
    }
  ]
}
```

**Windows**:

```json
{
  "protocols": {
    "name": "AI Workflow Orchestrator",
    "schemes": ["aiworkflow"]
  }
}
```

**Linux**:

```json
{
  "protocols": [
    {
      "name": "aiworkflow",
      "schemes": ["aiworkflow"]
    }
  ]
}
```

#### æˆæœç‰©

| æˆæœç‰©            | ãƒ‘ã‚¹                                                                        | å†…å®¹                       |
| ----------------- | --------------------------------------------------------------------------- | -------------------------- |
| URLã‚¹ã‚­ãƒ¼ãƒ è¨­è¨ˆæ›¸ | `docs/30-workflows/auth-callback-urlscheme/task-step01-urlscheme-design.md` | electron-builderè¨­å®šã®è¨­è¨ˆ |

---

### T-01-2: Deep Linkãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­è¨ˆ

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:design-ipc-handler
```

#### ç›®çš„

main ãƒ—ãƒ­ã‚»ã‚¹ã§ `aiworkflow://` URL ã‚’å—ä¿¡ã—ã€renderer ãƒ—ãƒ­ã‚»ã‚¹ã«è»¢é€ã™ã‚‹è¨­è¨ˆã‚’è¡Œã†ã€‚

#### è¨­è¨ˆå†…å®¹

**main ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ`apps/desktop/src/main/index.ts`ï¼‰**:

```typescript
// macOS/Windows: second-instance ã‚¤ãƒ™ãƒ³ãƒˆ
app.on("second-instance", (event, commandLine) => {
  const url = commandLine.find((arg) => arg.startsWith("aiworkflow://"));
  if (url) {
    handleAuthCallback(url);
  }
});

// macOS: open-url ã‚¤ãƒ™ãƒ³ãƒˆ
app.on("open-url", (event, url) => {
  event.preventDefault();
  if (url.startsWith("aiworkflow://auth/callback")) {
    handleAuthCallback(url);
  }
});

function handleAuthCallback(url: string) {
  // URLã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
  // renderer ãƒ—ãƒ­ã‚»ã‚¹ã«é€ä¿¡
  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«è¡¨ç¤º
}
```

#### æˆæœç‰©

| æˆæœç‰©                     | ãƒ‘ã‚¹                                                                       | å†…å®¹              |
| -------------------------- | -------------------------------------------------------------------------- | ----------------- |
| Deep Link ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­è¨ˆæ›¸ | `docs/30-workflows/auth-callback-urlscheme/task-step01-deeplink-design.md` | URLå—ä¿¡å‡¦ç†ã®è¨­è¨ˆ |

---

### T-01-3: èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†è¨­è¨ˆ

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:design-business-logic
```

#### ç›®çš„

å—ä¿¡ã—ãŸURLã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã—ã€Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¨­å®šã™ã‚‹å‡¦ç†ã‚’è¨­è¨ˆã™ã‚‹ã€‚

#### è¨­è¨ˆå†…å®¹

**ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºå‡¦ç†**:

```typescript
function extractTokensFromUrl(url: string): {
  access_token: string;
  refresh_token: string;
  expires_at: number;
} | null {
  const urlObj = new URL(url);
  const hash = urlObj.hash.substring(1); // # ã‚’é™¤å»
  const params = new URLSearchParams(hash);

  const access_token = params.get("access_token");
  const refresh_token = params.get("refresh_token");
  const expires_at = params.get("expires_at");

  if (!access_token || !refresh_token || !expires_at) {
    return null;
  }

  return {
    access_token,
    refresh_token,
    expires_at: parseInt(expires_at, 10),
  };
}
```

**Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š**:

```typescript
async function setAuthSession(tokens: Tokens): Promise<void> {
  const { data, error } = await supabase.auth.setSession({
    access_token: tokens.access_token,
    refresh_token: tokens.refresh_token,
  });

  if (error) {
    throw new Error(`Auth session failed: ${error.message}`);
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const user = data.user;

  // Store ã«ä¿å­˜ï¼ˆæ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨é€£å‹•ï¼‰
  // daishimanju@gmail.com ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ä¸€è‡´ã•ã›ã‚‹
}
```

#### æˆæœç‰©

| æˆæœç‰©                     | ãƒ‘ã‚¹                                                                       | å†…å®¹               |
| -------------------------- | -------------------------------------------------------------------------- | ------------------ |
| èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†è¨­è¨ˆæ›¸ | `docs/30-workflows/auth-callback-urlscheme/task-step01-callback-design.md` | ãƒˆãƒ¼ã‚¯ãƒ³å‡¦ç†ã®è¨­è¨ˆ |

---

## Phase 2: è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒˆ

### T-02-1: è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼

#### Claude Code ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰

```
/ai:review-architecture
```

#### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**

- [ ] ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªæŠ½å‡ºãƒ»æ¤œè¨¼ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] CSRFæ”»æ’ƒã¸ã®å¯¾ç­–ãŒã‚ã‚‹
- [ ] URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹

**ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ äº’æ›æ€§**

- [ ] macOSã€Windowsã€Linux ã§å‹•ä½œã™ã‚‹è¨­è¨ˆã§ã‚ã‚‹
- [ ] å„OSã®ä»•æ§˜å·®ç•°ãŒè€ƒæ…®ã•ã‚Œã¦ã„ã‚‹

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

- [ ] ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºå¤±æ•—æ™‚ã®å‡¦ç†ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

---

## Phase 3-10: å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆãƒ»PRä½œæˆ

ï¼ˆä»¥ä¸‹ã€æ¨™æº–çš„ãªTDDãƒ•ãƒ­ãƒ¼ãƒ»å“è³ªä¿è¨¼ãƒ»æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ»PRä½œæˆã®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

è©³ç´°ã¯ `docs/00-requirements/task-orchestration-specification.md` ã®æ¨™æº–ãƒ•ãƒ­ãƒ¼ã‚’å‚ç…§ã€‚

---

## å®Œäº†æ¡ä»¶ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ©Ÿèƒ½å®Ÿè£…

- [ ] `aiworkflow://` URLã‚¹ã‚­ãƒ¼ãƒ ãŒOSã«ç™»éŒ²ã•ã‚Œã‚‹
- [ ] OAuthèªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¸¡ã•ã‚Œã‚‹
- [ ] æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆdaishimanju@gmail.comï¼‰ã¨é€£å‹•ã™ã‚‹
- [ ] devMockAuth.ts ã®ä¸€æ™‚ä¿®æ­£ãŒå…ƒã«æˆ»ã•ã‚Œã¦ã„ã‚‹

### å“è³ªä¿è¨¼

- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹
- [ ] å‹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¦ã„ã‚‹
- [ ] macOSã€Windowsã€Linux ã§URLã‚¹ã‚­ãƒ¼ãƒ ãŒå‹•ä½œã™ã‚‹

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹

### PR

- [ ] PRãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] CI/CDãŒæˆåŠŸã—ã¦ã„ã‚‹

---

## ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯                            | å½±éŸ¿åº¦ | å¯¾ç­–                                 |
| --------------------------------- | ------ | ------------------------------------ |
| OSé–“ã§ã®URLã‚¹ã‚­ãƒ¼ãƒ ç™»éŒ²æ–¹æ³•ã®å·®ç•° | é«˜     | å„OSã”ã¨ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½               |
| æ—¢å­˜ã®èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã®ç«¶åˆ      | ä¸­     | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸Šæ›¸ããƒ­ã‚¸ãƒƒã‚¯ã®æ…é‡ãªå®Ÿè£… |
| ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°  | ä¸­     | ã‚¢ãƒ—ãƒªèµ·å‹•å¾…æ©Ÿå‡¦ç†ã®å®Ÿè£…             |
| ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ            | ä½     | refresh_token ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°å®Ÿè£…     |

---

## æŠ€è¡“å‚è€ƒè³‡æ–™

### Electronå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Custom Protocol Handler](https://www.electronjs.org/docs/latest/tutorial/launch-app-from-url-in-another-app)
- [Deep Linking](https://www.electronjs.org/docs/latest/tutorial/launch-app-from-url-in-another-app)

### Supabaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [OAuth with PKCE flow](https://supabase.com/docs/guides/auth/server-side/oauth-with-pkce-flow-for-ssr)
- [Session Management](https://supabase.com/docs/reference/javascript/auth-setsession)

### electron-builder

- [Protocol Schemes Configuration](https://www.electron.build/configuration/configuration#Configuration-protocols)

---

## å‚™è€ƒ

### ä¸€æ™‚çš„ãªä¿®æ­£ã®å¾©å…ƒæ–¹æ³•

æœ¬ã‚¿ã‚¹ã‚¯å®Ÿè¡Œæ™‚ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§ä¸€æ™‚ä¿®æ­£ã‚’å¾©å…ƒã™ã‚‹ï¼š

1. `devMockAuth.ts:31` ã® `return true;` ã‚’å‰Šé™¤
2. ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ï¼ˆç¾åœ¨ã¯unreachable codeï¼‰
   ```typescript
   // E2Eç’°å¢ƒãƒ•ãƒ©ã‚°
   if (import.meta.env.VITE_E2E_MODE === "true") {
     return true;
   }
   // ... ä»¥ä¸‹ç¶šã
   ```

### é–¢é€£ã™ã‚‹æ—¢å­˜å®Ÿè£…

- `apps/desktop/src/renderer/components/AuthGuard/index.tsx` - èªè¨¼ã‚¬ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- `apps/desktop/src/renderer/views/AuthView/index.tsx` - èªè¨¼ç”»é¢
- `apps/desktop/src/main/ipc/authHandlers.ts` - èªè¨¼IPCãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- `apps/desktop/src/renderer/store/slices/authSlice.ts` - èªè¨¼çŠ¶æ…‹ç®¡ç†

---

## å„ªå…ˆåº¦ã®ç†ç”±

**ä¸­å„ªå…ˆåº¦**ã¨ã—ã¦ã„ã‚‹ç†ç”±:

1. **ç¾åœ¨ã®å›é¿ç­–ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹**: ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆãŒå¯èƒ½
2. **ä»–ã®æ©Ÿèƒ½å®Ÿè£…ãŒå„ªå…ˆ**: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ©Ÿèƒ½ãªã©ã€ã‚³ã‚¢æ©Ÿèƒ½ã®å®Ÿè£…ã‚’å„ªå…ˆ
3. **å°†æ¥çš„ã«ã¯å¿…é ˆ**: æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å‰ã«ã¯å¿…ãšä¿®æ­£ãŒå¿…è¦

---

## é–¢é€£ã‚¿ã‚¹ã‚¯

- `task-chat-system-prompt.md` - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šæ©Ÿèƒ½ï¼ˆæœ¬ã‚¿ã‚¹ã‚¯ã®å‰æï¼‰
- å°†æ¥ã®èªè¨¼æ©Ÿèƒ½æ‹¡å¼µã‚¿ã‚¹ã‚¯ï¼ˆè¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€SSOç­‰ï¼‰
