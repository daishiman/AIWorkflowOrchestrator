# chunks FTS5品質改善 - タスク指示書

## メタ情報

| 項目         | 内容                                  |
| ------------ | ------------------------------------- |
| タスクID     | task-chunks-fts5-quality-improvements |
| タスク名     | chunks FTS5品質改善実施               |
| 分類         | 改善                                  |
| 対象機能     | RAG変換システム（chunks FTS5）        |
| 優先度       | 低                                    |
| 見積もり規模 | 小規模                                |
| ステータス   | 未実施                                |
| 発見元       | Phase 7: 最終レビューゲート           |
| 発見日       | 2025-12-26                            |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

chunks FTS5実装（Phase 0-9）では、最終レビューでPASS判定を獲得し、すべての機能要件を満たした。しかし、レビューで以下のMINOR改善提案が指摘されている：

1. **テスト命名規約の不統一**: 日本語形式と英語should形式が混在
2. **エラーメッセージのハードコード**: 国際化（i18n）対応の準備が未実施
3. **手動テストの手動実行**: 継続的な品質保証のための自動化が未実施

これらは機能に影響しない改善項目だが、長期的なプロジェクト保守性に影響する。

### 1.2 問題点・課題

現状の品質上の課題：

| 問題項目                       | 詳細                                             | 影響範囲     |
| ------------------------------ | ------------------------------------------------ | ------------ |
| テスト命名規約の不統一         | 日本語と英語が混在し、一貫性が欠ける             | 可読性       |
| エラーメッセージのハードコード | Zodエラーメッセージが日本語固定                  | 国際化対応   |
| 手動テストの手動実行           | 毎回手動で実行が必要、リグレッション検出が遅れる | 品質保証効率 |

### 1.3 放置した場合の影響

1. **保守性の低下**: テストコードの可読性が低く、後続開発者が理解しにくい
2. **国際化対応の遅延**: 将来の多言語対応時に大規模リファクタリングが必要
3. **リグレッションリスク**: 手動テストの実行漏れによるバグの見逃し

---

## 2. 何を達成するか（What）

### 2.1 目的

chunks FTS5実装の**長期的な保守性と拡張性**を向上させる。

### 2.2 最終ゴール

以下の3つの改善を実施し、プロジェクトの品質基盤を強化する：

1. **テスト命名規約の統一**: プロジェクト全体で一貫した命名規則を適用
2. **エラーメッセージの国際化対応**: i18n基盤の準備とエラーメッセージの外部化
3. **手動テストの自動化**: CI/CDパイプラインへの統合

### 2.3 スコープ

#### 含むもの

- テスト命名規約の統一（chunks関連テスト81件）
- Zodエラーメッセージの外部化
- 手動テストスクリプトの統合テスト化
- CI/CDパイプラインへの組み込み

#### 含まないもの

- プロジェクト全体のテストリファクタリング（chunks関連のみ）
- 実際の多言語翻訳（i18n基盤の準備のみ）
- 新機能の追加

### 2.4 成果物

| 成果物               | パス                                                                          |
| -------------------- | ----------------------------------------------------------------------------- |
| テスト命名規約ガイド | `docs/30-workflows/rag-conversion-system/test-naming-convention.md`           |
| i18n基盤設計書       | `docs/30-workflows/rag-conversion-system/i18n-design-chunks-fts5.md`          |
| 統合テストスイート   | `packages/shared/src/db/integration/__tests__/chunks-fts-integration.test.ts` |
| 改善サマリーレポート | `docs/30-workflows/rag-conversion-system/quality-improvements-chunks-fts5.md` |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- chunks FTS5実装（Phase 0-9）が完了している
- すべてのテストがパスしている（100%カバレッジ）
- 最終レビューでPASS判定を獲得している

### 3.2 依存タスク

- **完了必須**: chunks FTS5実装（Phase 0-9）
- **並行可能**: `task-chunks-fts5-performance-testing.md`（パフォーマンステスト）

### 3.3 必要な知識・スキル

| 知識・スキル   | レベル | 説明                           |
| -------------- | ------ | ------------------------------ |
| Vitest         | 初級   | テスト記述の基本               |
| Zod            | 初級   | スキーマ定義とエラーメッセージ |
| i18n基礎       | 初級   | 国際化の基本概念               |
| GitHub Actions | 初級   | CI/CD基本設定                  |

### 3.4 推奨アプローチ

各改善項目を独立したタスクとして順次実施する。

**メリット**:

- リスクが低い
- 各改善の効果を個別に検証可能
- 中断・再開が容易

**手順**:

1. テスト命名規約の統一
2. エラーメッセージの国際化基盤準備
3. 手動テストの自動化

---

## 4. 実行手順

### Phase構成

```
Phase 1: テスト命名規約の統一
Phase 2: エラーメッセージの国際化基盤準備
Phase 3: 手動テストの自動化
Phase 4: レビューと文書化
```

### Phase 1: テスト命名規約の統一

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> タスクに最適なコマンドを `.claude/commands/ai/command_list.md` から選定して実行してください

```
/ai:code-review-complete packages/shared/src/db
```

- **参照**: `.claude/commands/ai/command_list.md`
- **選定方法**: コマンドリストの「トリガーキーワード」と「目的」を参照し、タスクに最も適したコマンドを選択

#### 目的

chunks関連テストの命名規約を統一し、可読性を向上させる

#### 成果物

- `test-naming-convention.md` - テスト命名規約ガイド
- リファクタリング済みテストコード（81テストケース）

#### 完了条件

- [ ] テスト命名規約ガイドが作成されている
- [ ] chunks関連テスト81件がすべて統一形式である（英語should形式推奨）
- [ ] すべてのテストがパスしている

---

### Phase 2: エラーメッセージの国際化基盤準備

#### Claude Code スラッシュコマンド

```
/ai:design-architecture i18n-foundation
```

#### 目的

Zodエラーメッセージを外部化し、将来の多言語対応に備える

#### 成果物

- `i18n-design-chunks-fts5.md` - i18n基盤設計書
- `error-messages.ts` - エラーメッセージ外部化
- 更新済みZodスキーマ

#### 完了条件

- [ ] i18n基盤設計書が作成されている
- [ ] エラーメッセージが外部化されている
- [ ] 既存のテストがすべてパスしている
- [ ] エラーメッセージが英語で表示される（デフォルト）

---

### Phase 3: 手動テストの自動化

#### Claude Code スラッシュコマンド

```
/ai:create-test integration
```

#### 目的

手動テストスクリプトを統合テストとしてCI/CDパイプラインに組み込む

#### 成果物

- `chunks-fts-integration.test.ts` - 統合テストスイート（15項目）
- 更新済みCI/CD設定（該当する場合）

#### 完了条件

- [ ] 統合テストスイートが作成されている
- [ ] 15項目すべてが自動テストとして実行できる
- [ ] ローカルで統合テストがパスしている
- [ ] CI/CDで統合テストが自動実行される（該当する場合）

---

### Phase 4: レビューと文書化

#### Claude Code スラッシュコマンド

```
/ai:update-all-docs
```

#### 目的

改善内容を文書化し、レビューを実施する

#### 成果物

- `quality-improvements-chunks-fts5.md` - 改善サマリーレポート
- 更新済みREADME.md

#### 完了条件

- [ ] 改善サマリーレポートが作成されている
- [ ] README.mdが更新されている
- [ ] すべてのテストがパスしている
- [ ] コードレビューが完了している

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] テスト命名規約が統一されている（81テストケース）
- [ ] エラーメッセージが外部化されている
- [ ] 統合テストスイートが作成されている（15項目）

### 品質要件

- [ ] すべてのテストがパスしている（リグレッションなし）
- [ ] テストカバレッジが維持されている（100%）
- [ ] コードスメルが発生していない
- [ ] 統合テストの実行時間が許容範囲内である（< 5分）

### ドキュメント要件

- [ ] テスト命名規約ガイドが作成されている
- [ ] i18n基盤設計書が作成されている
- [ ] 改善サマリーレポートが作成されている
- [ ] README.mdが更新されている

---

## 6. 検証方法

### テストケース

#### テスト命名規約の検証

```bash
# 統一形式の確認（should形式以外が出力されないことを確認）
grep -r "it(" packages/shared/src/db/**/__tests__/*.test.ts | grep -v "should"
```

#### エラーメッセージ国際化の検証

- エラーメッセージが外部化されているか確認
- ハードコードされた文字列が残っていないか確認
- デフォルトで英語エラーメッセージが表示されるか確認

#### 統合テストの検証

```bash
# ローカル実行
pnpm --filter @repo/shared test:integration

# CI実行（GitHub Actions）
# PRを作成してCI結果を確認
```

### 検証手順

1. テスト実行
   - 全テストがパスすることを確認
   - カバレッジが維持されていることを確認

2. コードレビュー
   - 変更内容の確認
   - リグレッションチェック

3. ドキュメントレビュー
   - ガイドラインの妥当性確認
   - 完全性の確認

---

## 7. リスクと対策

| リスク                     | 影響度 | 発生確率 | 対策                                         |
| -------------------------- | ------ | -------- | -------------------------------------------- |
| テストリファクタリング失敗 | 中     | 低       | 段階的な変更、コミット単位を小さく           |
| i18n基盤の設計ミス         | 中     | 低       | シンプルな設計、将来拡張性を確保             |
| 統合テストの不安定性       | 高     | 中       | テストデータの分離、テスト前にクリーンアップ |
| CI/CDパイプラインの遅延    | 低     | 低       | 実行時間の最適化、並列実行                   |

---

## 8. 参照情報

### 関連ドキュメント

- [requirements-chunks-fts5.md](../rag-conversion-system/requirements-chunks-fts5.md) - 要件定義書
- [final-review-chunks-fts5.md](../rag-conversion-system/final-review-chunks-fts5.md) - 最終レビューレポート（MINOR改善提案）
- [manual-test-report-chunks-fts5.md](../rag-conversion-system/manual-test-report-chunks-fts5.md) - 手動テストレポート
- [README.md](../rag-conversion-system/README.md) - chunks FTS5実装サマリー

### 参考資料

- [Vitest公式ドキュメント](https://vitest.dev/)
- [Zod公式ドキュメント](https://zod.dev/)
- [zod-i18n-map](https://github.com/aiji42/zod-i18n) - Zod国際化ライブラリ

---

## 9. 備考

### レビュー指摘の原文（該当する場合）

```
Phase 7（最終レビューゲート）での改善提案（MINOR - 対応任意）:

提案1: テスト命名規約の統一
現状:
- 日本語形式: it("should have correct table name", ...)
- 英語should形式: it("initializeChunksFts creates FTS5 table", ...)

提案: プロジェクト全体でどちらかに統一
影響: なし（機能に影響しない）
優先度: 低

提案2: パフォーマンスベンチマークテストの追加
→ task-chunks-fts5-performance-testing.md として分離

提案3: エラーメッセージの国際化
現状:
z.string().min(1, "検索クエリは必須です"); // 日本語

提案: エラーメッセージの外部化（i18n対応準備）
影響: なし（将来の拡張性向上）
優先度: 低
```

### 補足事項

- 本タスクは最終レビュー（Phase 7）で「MINOR改善提案」として指摘された項目のうち、品質関連を抽出したもの
- 優先度は「低」だが、プロジェクトの長期的な保守性に寄与
- `task-chunks-fts5-performance-testing.md`（パフォーマンステスト）と並行実施可能
- 機能に影響しないため、リグレッションリスクは低い
