# chunks FTS5パフォーマンステスト - タスク指示書

## メタ情報

| 項目         | 内容                                 |
| ------------ | ------------------------------------ |
| タスクID     | task-chunks-fts5-performance-testing |
| タスク名     | chunks FTS5パフォーマンステスト実施  |
| 分類         | パフォーマンス                       |
| 対象機能     | RAG変換システム（chunks FTS5）       |
| 優先度       | 中                                   |
| 見積もり規模 | 中規模                               |
| ステータス   | 未実施                               |
| 発見元       | Phase 8: 手動テスト実施              |
| 発見日       | 2025-12-26                           |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

chunks FTS5実装（Phase 0-9）では、基本的な機能テストと手動テストを実施し、100%のテストカバレッジを達成した。しかし、テストデータ規模が小さく（手動テストでは3チャンクのみ）、実運用時のパフォーマンス検証が未実施である。

実際のRAGシステムでは数千〜数万チャンクを扱うため、大量データでの検索性能、インデックス効果、エッジケース（日本語全文検索、特殊文字）の動作確認が必要である。

### 1.2 問題点・課題

現状のテストでは以下が不明確：

| 問題項目           | 詳細                                         | 影響範囲                 |
| ------------------ | -------------------------------------------- | ------------------------ |
| 大量データ検索速度 | 10,000チャンク規模でのFTS5検索パフォーマンス | ユーザー体験             |
| インデックス効果   | インデックス最適化が実際に効いているか       | データベース性能         |
| 日本語全文検索精度 | unicode61トークナイザーの日本語対応が十分か  | 検索品質                 |
| 特殊文字の処理     | 絵文字、記号、制御文字の処理が正しいか       | データ整合性             |
| メモリ使用量       | 大量データ検索時のメモリフットプリント       | リソース効率             |
| 並行検索性能       | 複数ユーザーによる同時検索のスケーラビリティ | システムスケーラビリティ |

### 1.3 放置した場合の影響

1. **ユーザー体験の低下**: 検索が遅延し、RAGシステムの実用性が損なわれる
2. **スケーラビリティ問題**: データ増加に伴いシステムが破綻する可能性
3. **予期しないエラー**: エッジケースでの動作不良がプロダクション環境で発生
4. **技術的負債**: パフォーマンス問題の修正コストが後から高騰

---

## 2. 何を達成するか（What）

### 2.1 目的

chunks FTS5実装の**実運用時のパフォーマンス特性**を明らかにし、**本番環境での使用可否**を判定する。

### 2.2 最終ゴール

以下の3つの成果物を作成し、実運用判断の根拠とする：

1. **パフォーマンスベンチマークレポート**: 大量データでの検索性能測定結果
2. **エッジケーステストレポート**: 日本語・特殊文字の処理検証結果
3. **パフォーマンス改善提案書**: ボトルネックと対策の提示（該当する場合）

### 2.3 スコープ

#### 含むもの

- 大量データ（10,000チャンク）での検索パフォーマンステスト
- インデックス効果の検証
- 日本語全文検索の精度検証
- 特殊文字（絵文字、記号）の処理検証
- メモリ使用量の測定
- 並行検索のストレステスト

#### 含まないもの

- 本番環境へのデプロイ
- ベクトル検索との比較
- 他の全文検索エンジン（Elasticsearch等）との比較
- チャンキング戦略の最適化

### 2.4 成果物

| 成果物                                   | パス                                                                             |
| ---------------------------------------- | -------------------------------------------------------------------------------- |
| パフォーマンスベンチマークレポート       | `docs/30-workflows/rag-conversion-system/performance-benchmark-chunks-fts5.md`   |
| エッジケーステストレポート               | `docs/30-workflows/rag-conversion-system/edge-case-test-chunks-fts5.md`          |
| パフォーマンス改善提案書（該当する場合） | `docs/30-workflows/unassigned-task/task-chunks-fts5-performance-improvements.md` |
| ベンチマークテストスイート               | `packages/shared/src/db/queries/__tests__/chunks-search.bench.ts`                |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- chunks FTS5実装（Phase 0-9）が完了している
- すべてのテストがパスしている（100%カバレッジ）
- 手動テスト（15項目）がすべて成功している
- Node.js v22.x以上がインストールされている
- libSQL/Turso環境が利用可能

### 3.2 依存タスク

- **完了必須**: chunks FTS5実装（Phase 0-9）
- **並行可能**: `task-chunks-fts5-quality-improvements.md`（品質改善）

### 3.3 必要な知識・スキル

| 知識・スキル         | レベル | 説明                                   |
| -------------------- | ------ | -------------------------------------- |
| SQLite FTS5          | 中級   | FTS5の仕組みとパフォーマンス特性の理解 |
| パフォーマンステスト | 中級   | ベンチマーク設計、統計的分析           |
| TypeScript/Vitest    | 中級   | テストコードの記述                     |
| libSQL/Drizzle ORM   | 初級   | 基本的なクエリ実行                     |
| 日本語NLP基礎        | 初級   | トークナイザーの仕組み理解             |

### 3.4 推奨アプローチ

小規模→中規模→大規模の順にデータ量を増やしながら段階的に検証する。

**メリット**:

- ボトルネックの早期発見
- 安全な検証フロー
- データ量とパフォーマンスの相関が明確

**手順**:

1. 1,000チャンクでベースライン測定
2. 5,000チャンクで中規模検証
3. 10,000チャンクで大規模検証
4. 各段階で性能劣化を分析

---

## 4. 実行手順

### Phase構成

```
Phase 1: 環境準備とベースライン測定（1,000チャンク）
Phase 2: スケーラビリティ検証（5,000 / 10,000チャンク）
Phase 3: エッジケーステスト（日本語・特殊文字）
Phase 4: 並行検索ストレステスト
Phase 5: レポート作成と判定
```

### Phase 1: 環境準備とベースライン測定

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> タスクに最適なコマンドを `.claude/commands/ai/command_list.md` から選定して実行してください

```
/ai:create-test benchmarks
```

- **参照**: `.claude/commands/ai/command_list.md`
- **選定方法**: コマンドリストの「トリガーキーワード」と「目的」を参照し、タスクに最も適したコマンドを選択

#### 目的

テスト環境を構築し、小規模データでのベースラインを確立する

#### 成果物

- `chunks-search.bench.ts` - ベンチマークテストスイート
- `generate-test-chunks.ts` - テストデータジェネレーター
- ベースライン測定結果（1,000チャンク）

#### 完了条件

- [ ] ベンチマークテストが正常に実行できる
- [ ] 1,000チャンクのテストデータが生成できる
- [ ] ベースライン測定結果が記録されている

---

### Phase 2: スケーラビリティ検証

#### Claude Code スラッシュコマンド

```
/ai:run-all-tests --benchmark
```

#### 目的

データ量増加に伴う性能劣化を測定し、インデックス効果を検証する

#### 成果物

- 5,000チャンク測定結果
- 10,000チャンク測定結果
- スケーラビリティ分析グラフ

#### 完了条件

- [ ] 5,000チャンクと10,000チャンクのテストが完了している
- [ ] インデックス効果が定量的に示されている
- [ ] スケーラビリティ曲線が作成されている

---

### Phase 3: エッジケーステスト

#### Claude Code スラッシュコマンド

```
/ai:write-spec edge-case-testing
```

#### 目的

日本語全文検索と特殊文字の処理を検証する

#### 成果物

- エッジケーステストスイート
- 日本語検索精度レポート
- 特殊文字処理レポート

#### 完了条件

- [ ] 日本語検索の精度が80%以上である
- [ ] 特殊文字の処理が正しく動作している
- [ ] 長文テキストが正常に検索できる

---

### Phase 4: 並行検索ストレステスト

#### Claude Code スラッシュコマンド

```
/ai:code-review-complete stress-test
```

#### 目的

複数ユーザーによる同時検索のスケーラビリティを検証する

#### 成果物

- 並行検索ストレステスト結果
- レスポンスタイム分布グラフ

#### 完了条件

- [ ] 10並行リクエストで平均応答時間が100ms以内
- [ ] データベースロック競合が発生していない

---

### Phase 5: レポート作成と判定

#### Claude Code スラッシュコマンド

```
/ai:update-all-docs
```

#### 目的

測定結果を分析し、実運用可否を判定する

#### 成果物

- `performance-benchmark-chunks-fts5.md`
- `edge-case-test-chunks-fts5.md`
- `task-chunks-fts5-performance-improvements.md`（該当する場合）

#### 完了条件

- [ ] 全測定結果が文書化されている
- [ ] 実運用可否の判定が明記されている
- [ ] 改善提案が具体的である（該当する場合）

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] ベンチマークテストスイートが作成されている
- [ ] 1,000 / 5,000 / 10,000チャンクのテストが完了している
- [ ] 日本語全文検索の精度が80%以上である
- [ ] 特殊文字の処理が正常に動作している
- [ ] 並行検索のストレステストが完了している

### 品質要件

- [ ] 検索速度が合格基準を満たしている
  - 10,000チャンク: キーワード検索 < 100ms
  - 10,000チャンク: フレーズ検索 < 100ms
  - 10,000チャンク: NEAR検索 < 150ms
- [ ] 並行検索で平均応答時間が100ms以内（10並行）
- [ ] インデックス効果が定量的に示されている
- [ ] データベースロック競合が発生していない

### ドキュメント要件

- [ ] パフォーマンスベンチマークレポートが作成されている
- [ ] エッジケーステストレポートが作成されている
- [ ] 実運用可否の判定が明記されている
- [ ] 改善提案が作成されている（該当する場合）

---

## 6. 検証方法

### テストケース

#### 検索速度の合格基準

| データ量       | 検索種別   | 合格基準（平均） | 備考                 |
| -------------- | ---------- | ---------------- | -------------------- |
| 1,000チャンク  | キーワード | < 20ms           | ベースライン         |
| 5,000チャンク  | キーワード | < 50ms           | 線形スケール想定     |
| 10,000チャンク | キーワード | < 100ms          | 実運用許容範囲       |
| 10,000チャンク | フレーズ   | < 100ms          | 実運用許容範囲       |
| 10,000チャンク | NEAR       | < 150ms          | NEAR検索は許容範囲広 |

#### 並行検索の合格基準

| 並行数 | 平均応答時間 | 95パーセンタイル | 備考           |
| ------ | ------------ | ---------------- | -------------- |
| 10     | < 100ms      | < 200ms          | 小規模同時接続 |
| 50     | < 200ms      | < 500ms          | 中規模同時接続 |
| 100    | < 500ms      | < 1000ms         | 大規模同時接続 |

### 検証手順

1. ベンチマークテストの実行

   ```bash
   pnpm --filter @repo/shared test:bench
   ```

2. スケーラビリティ測定
   - 1,000チャンク → 5,000チャンク → 10,000チャンクの順に測定
   - 各段階で性能劣化率を算出

3. エッジケーステスト
   - 日本語検索精度の測定（80%以上で合格）
   - 特殊文字処理の確認

4. 並行検索ストレステスト
   - 10 / 50 / 100並行リクエストでの応答時間測定

---

## 7. リスクと対策

| リスク                   | 影響度 | 発生確率 | 対策                                   |
| ------------------------ | ------ | -------- | -------------------------------------- |
| 大量データ生成失敗       | 中     | 低       | 段階的生成、エラーハンドリング強化     |
| パフォーマンス基準未達成 | 高     | 中       | インデックス最適化、クエリチューニング |
| 日本語検索精度不足       | 中     | 中       | トークナイザー変更検討                 |
| 並行検索でのロック競合   | 高     | 低       | WALモード有効化、接続プール調整        |
| メモリ不足               | 高     | 低       | ページネーション導入、結果数制限       |

---

## 8. 参照情報

### 関連ドキュメント

- [requirements-chunks-fts5.md](../rag-conversion-system/requirements-chunks-fts5.md) - 要件定義書
- [design-chunks-fts5.md](../rag-conversion-system/design-chunks-fts5.md) - FTS5設計書
- [manual-test-report-chunks-fts5.md](../rag-conversion-system/manual-test-report-chunks-fts5.md) - 手動テストレポート
- [final-review-chunks-fts5.md](../rag-conversion-system/final-review-chunks-fts5.md) - 最終レビューレポート
- [README.md](../rag-conversion-system/README.md) - chunks FTS5実装サマリー

### 参考資料

- [SQLite FTS5公式ドキュメント](https://www.sqlite.org/fts5.html)
- [Vitest Benchmark API](https://vitest.dev/guide/features.html#benchmarking)

---

## 9. 備考

### レビュー指摘の原文（該当する場合）

```
Phase 8（手動テスト）実施後の推奨事項:

短期対応:
1. 大量データでのパフォーマンステスト
   - 10,000チャンク規模での検索パフォーマンス測定
   - インデックス最適化の効果検証

2. エッジケーステストの追加
   - 日本語全文検索の検証
   - 特殊文字（絵文字、記号）の処理確認

長期対応:
1. ベンチマークテストスイート構築
   - 継続的なパフォーマンス監視
   - リグレッション検出

2. 手動テストの自動化
   - 統合テストスイートへの組み込み
   - CI/CDパイプラインでの実行
```

### 補足事項

- 本タスクは最終レビュー（Phase 7）で「MINOR改善提案」として指摘された項目のうち、パフォーマンス関連を抽出したもの
- 優先度は「中」だが、実運用前には必須の検証項目
- `task-chunks-fts5-quality-improvements.md`（品質改善タスク）と並行実施可能
