# Vimモード・キーバインド機能 - タスク指示書

## メタ情報

| 項目             | 内容                        |
| ---------------- | --------------------------- |
| タスクID         | TASK-VIM-MODE-001           |
| タスク名         | Vimモード・キーバインド機能 |
| 分類             | 新規機能                    |
| 対象機能         | エディター                  |
| 優先度           | 中                          |
| 見積もり規模     | 大規模                      |
| ステータス       | 未実施                      |
| 発見元           | ユーザー要望                |
| 発見日           | 2025-12-11                  |
| 発見エージェント | .claude/agents/product-manager.md            |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

Vimは多くの開発者に愛用されているエディターであり、そのキーバインドとモーダル編集は非常に効率的なテキスト編集を可能にする。Vimに慣れたユーザーにとって、Vimキーバインドなしのエディターは生産性が大幅に低下する。

### 1.2 問題点・課題

- Vimユーザーが使い慣れた操作ができない
- マウスに頼った編集は効率が低い
- 競合エディターではVimモードが標準的に提供されている
- ユーザー層の拡大に制限がある

### 1.3 放置した場合の影響

- Vimユーザーがツールを採用しない
- 開発者ユーザー層へのリーチが限定される
- 競合製品と比較して機能的に劣る
- パワーユーザーの離脱

---

## 2. 何を達成するか（What）

### 2.1 目的

エディターにVimモードを実装し、Vimユーザーが使い慣れた操作でテキスト編集できるようにする。

### 2.2 最終ゴール

- Vimの主要なモード（Normal, Insert, Visual, Command）をサポート
- 基本的なVimキーバインドが動作する
- Vimモードのオン/オフをユーザー設定で切り替え可能
- カスタムキーマッピングのサポート（オプション）

### 2.3 スコープ

#### 含むもの

**モードサポート**

- Normal モード（デフォルト）
- Insert モード
- Visual モード（文字選択）
- Visual Line モード（行選択）
- Visual Block モード（矩形選択）
- Command-line モード（:コマンド）

**基本モーション**

- `h`, `j`, `k`, `l` - 基本カーソル移動
- `w`, `b`, `e` - 単語単位移動
- `0`, `$`, `^` - 行頭/行末移動
- `gg`, `G` - ファイル先頭/末尾
- `{`, `}` - 段落移動
- `f`, `F`, `t`, `T` - 文字検索移動
- `/`, `?` - 検索

**編集コマンド**

- `i`, `I`, `a`, `A`, `o`, `O` - Insert モード切替
- `d`, `c`, `y`, `p`, `P` - 削除/変更/ヤンク/ペースト
- `dd`, `cc`, `yy` - 行操作
- `x`, `X` - 文字削除
- `r`, `R` - 置換
- `u`, `Ctrl+r` - アンドゥ/リドゥ
- `.` - 直前の操作を繰り返し

**テキストオブジェクト**

- `iw`, `aw` - 単語
- `i"`, `a"`, `i'`, `a'` - クォート内
- `i(`, `a(`, `i{`, `a{`, `i[`, `a[` - 括弧内
- `it`, `at` - HTMLタグ内

**Exコマンド（基本）**

- `:w` - 保存
- `:q`, `:q!` - 終了
- `:wq`, `:x` - 保存して終了
- `:%s/old/new/g` - 置換
- `:set` - 設定

**ユーザー設定**

- Vimモードのオン/オフ
- `jj` でInsertモード終了などのカスタムマッピング

#### 含まないもの

- Vimscript/Luaによるプラグイン拡張
- マクロ記録・再生（将来対応）
- レジスタの完全実装（基本的な無名レジスタのみ）
- 全てのVimコマンド（主要なもののみ）

### 2.4 成果物

- Vimモードエンジン
- キーバインド処理ロジック
- モード表示UI（ステータスバー）
- ユーザー設定UIの拡張
- 関連するユニットテスト
- Vimキーバインドリファレンスドキュメント

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- プロジェクトの開発環境がセットアップ済み
- エディターコンポーネント（Monaco Editor等）が実装済み
- ユーザー設定機能が実装済み

### 3.2 依存タスク

- なし（独立したタスク）

### 3.3 必要な知識・スキル

- React/TypeScript
- Vimの操作・概念理解
- キーイベント処理
- 状態機械（State Machine）パターン
- Monaco Editor API（使用している場合）

### 3.4 推奨アプローチ

1. Vimモードエンジンのアーキテクチャ設計
2. 状態機械によるモード管理
3. キーシーケンス処理の実装
4. 基本モーションから段階的に実装
5. テキストオブジェクトの実装
6. Exコマンドの実装

**ライブラリの検討**

- Monaco Editor使用時: `monaco-vim` パッケージの活用を検討
- CodeMirror使用時: `@replit/codemirror-vim` の活用を検討

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件定義（サポートするVimコマンドの決定）
Phase 1: 設計
  - T-01-1: Vimモードエンジンアーキテクチャ設計
  - T-01-2: キーバインドマッピング設計
  - T-01-3: モード表示UI設計
Phase 2: 設計レビューゲート
Phase 3: テスト作成（TDD: Red）
Phase 4: 実装（TDD: Green）
  - T-04-1: モード管理実装
  - T-04-2: 基本モーション実装
  - T-04-3: 編集コマンド実装
  - T-04-4: テキストオブジェクト実装
  - T-04-5: Exコマンド実装
  - T-04-6: ユーザー設定実装
Phase 5: リファクタリング（TDD: Refactor）
Phase 6: 品質保証
Phase 7: 最終レビューゲート
Phase 8: 手動テスト検証
Phase 9: ドキュメント更新
```

### 主要な使用エージェント

- **.claude/agents/arch-police.md**: Vimモードエンジンのアーキテクチャ設計
- **.claude/agents/logic-dev.md**: キーバインド・モード管理ロジックの実装
- **.claude/agents/ui-designer.md**: モード表示UI・設定UIの設計
- **.claude/agents/unit-tester.md**: TDDでのテスト作成
- **.claude/agents/e2e-tester.md**: Vimキーバインドの統合テスト

---

## 5. 手動テストケース

| No  | カテゴリ   | テスト項目       | 操作手順                | 期待結果                       |
| --- | ---------- | ---------------- | ----------------------- | ------------------------------ |
| 1   | モード切替 | Normal → Insert  | `i` を押す              | Insertモードに切り替わる       |
| 2   | モード切替 | Insert → Normal  | `Escape` を押す         | Normalモードに戻る             |
| 3   | モード切替 | Normal → Visual  | `v` を押す              | Visualモードに切り替わる       |
| 4   | モーション | 基本移動         | `h`, `j`, `k`, `l`      | カーソルが移動する             |
| 5   | モーション | 単語移動         | `w`, `b`, `e`           | 単語単位で移動する             |
| 6   | 編集       | 行削除           | `dd`                    | 現在行が削除される             |
| 7   | 編集       | ヤンク＆ペースト | `yy` → `p`              | 行がコピー＆ペーストされる     |
| 8   | 編集       | 単語内削除       | `diw`                   | カーソル位置の単語が削除される |
| 9   | 編集       | アンドゥ         | `u`                     | 直前の操作が取り消される       |
| 10  | 編集       | 繰り返し         | `.`                     | 直前の編集操作が繰り返される   |
| 11  | 検索       | 前方検索         | `/` → 文字入力 → Enter  | 検索結果にジャンプ             |
| 12  | Exコマンド | 保存             | `:w` → Enter            | ファイルが保存される           |
| 13  | Exコマンド | 置換             | `:%s/old/new/g` → Enter | 全ての該当箇所が置換される     |
| 14  | 設定       | Vimモードオフ    | 設定でVimモードをオフ   | 通常のキーバインドに戻る       |
| 15  | UI         | モード表示       | モードを切り替える      | ステータスバーにモード表示     |

---

## 6. 完了条件チェックリスト

### 機能要件

**モードサポート**

- [ ] Normalモードが動作する
- [ ] Insertモードが動作する
- [ ] Visualモード（文字選択）が動作する
- [ ] Visual Lineモード（行選択）が動作する
- [ ] Command-lineモードが動作する

**基本操作**

- [ ] `h`, `j`, `k`, `l` で移動できる
- [ ] `w`, `b`, `e` で単語移動できる
- [ ] `dd`, `yy`, `p` が動作する
- [ ] `u`, `Ctrl+r` でアンドゥ/リドゥできる
- [ ] `/` で検索できる

**テキストオブジェクト**

- [ ] `iw`, `aw` が動作する
- [ ] `i"`, `i(` 等が動作する

**Exコマンド**

- [ ] `:w` で保存できる
- [ ] `:q` で終了できる
- [ ] `:%s` で置換できる

**ユーザー設定**

- [ ] Vimモードのオン/オフが切り替えられる
- [ ] 現在のモードが表示される

### 品質要件

- [ ] 全テストがPASS
- [ ] Lintエラーなし
- [ ] 型エラーなし
- [ ] キー入力の遅延がない

---

## 7. リスクと対策

| リスク             | 影響度 | 発生確率 | 対策                                 |
| ------------------ | ------ | -------- | ------------------------------------ |
| キーバインドの競合 | 高     | 高       | Vimモード専用のキーハンドラー        |
| 実装の複雑さ       | 高     | 高       | 既存ライブラリの活用、段階的実装     |
| パフォーマンス低下 | 中     | 中       | 効率的なキーイベント処理             |
| Vimとの動作の違い  | 中     | 高       | 主要コマンドに絞って完全互換を目指す |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン

### 参考資料

- [Vim Documentation](https://vimdoc.sourceforge.net/)
- [Monaco Vim](https://github.com/brijeshb42/monaco-vim)
- [CodeMirror Vim](https://github.com/replit/codemirror-vim)
- [VS Code Vim Extension](https://github.com/VSCodeVim/Vim)

---

## 9. 備考

### レビュー指摘の原文

```
別タスクとしてVImのマインド操作も、VIM機能も追加してほしいです。
```

### 補足事項

- Monaco EditorやCodeMirror使用時は既存のVim拡張を活用することを推奨
- 全てのVimコマンドの実装は現実的でないため、主要コマンドに絞る
- デフォルトはVimモード「オフ」を推奨（一般ユーザーの混乱を防ぐ）
- モード表示は常に見える位置に配置（ステータスバー推奨）
- `jj` でEscapeなどのカスタムマッピングは人気があるため優先対応
