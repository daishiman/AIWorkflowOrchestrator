# アクセス制御強化 - タスク指示書

## メタ情報

| 項目             | 内容                               |
| ---------------- | ---------------------------------- |
| タスクID         | SECURITY-001                       |
| タスク名         | チャット履歴機能のアクセス制御強化 |
| 分類             | セキュリティ                       |
| 対象機能         | chat-history（セッション管理）     |
| 優先度           | 高                                 |
| 見積もり規模     | 小規模                             |
| ステータス       | 未実施                             |
| 発見元           | Phase 6 - セキュリティ監査         |
| 発見日           | 2024-12-23                         |
| 発見エージェント | @sec-auditor                       |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

セキュリティ監査（T-06-2）で、チャット履歴機能のアクセス制御に以下の不備が発見されました：

**検出箇所**:

```typescript
// packages/shared/src/features/chat-history/chat-history-service.ts

// Line 91-93: セッションID単独でアクセス可能
async getSession(id: string): Promise<ChatSession | null> {
  return this.sessionRepository.findById(id);
}

// Line 114-123: 所有者確認なしでセッション削除可能
async deleteSession(id: string): Promise<boolean> {
  // userIdによる認可チェックなし
  const messages = await this.messageRepository.findBySessionId(id);
  // ...
}
```

現在の実装では、セッションIDさえ分かれば誰でもそのセッションにアクセス・削除できる状態です。

### 1.2 問題点・課題

**OWASP A01: Broken Access Control** に該当する脆弱性：

1. **水平権限昇格のリスク**: 他ユーザーのセッションIDを推測/入手した場合、そのユーザーのチャット履歴を閲覧・削除できる
2. **認可チェックの欠如**: リソース所有者（userId）との照合がない
3. **設計上の不備**: サービス層でユーザーIDを受け取る設計になっていない

### 1.3 放置した場合の影響

**セキュリティ影響度**: Medium（CVSS 5.5）

- **機密性侵害**: 他ユーザーのチャット履歴が閲覧される
- **整合性侵害**: 不正にセッションが削除される
- **可用性侵害**: 重要なチャット履歴が失われる
- **コンプライアンスリスク**: OWASP Top 10違反

**緩和要因**（現時点）:

- デスクトップアプリでローカル実行（外部攻撃リスク低）
- シングルユーザー環境（マルチテナント未対応）
- UUID v4で推測困難（2^122の組み合わせ）

**将来リスク**:

- マルチユーザー機能実装時に致命的な脆弱性となる
- Web版リリース時に深刻なセキュリティインシデント発生可能性

---

## 2. 何を達成するか（What）

### 2.1 目的

チャット履歴機能のすべてのデータアクセスメソッドに、リソース所有者（userId）による認可チェックを追加し、OWASP A01: Broken Access Controlを完全に解消する。

### 2.2 最終ゴール

- ✅ すべてのセッションアクセスメソッドでuserID検証が実装されている
- ✅ 他ユーザーのセッションにアクセスした場合、UnauthorizedErrorが発生する
- ✅ OWASP A01準拠が達成されている
- ✅ 既存テストが全て成功している（リグレッションなし）
- ✅ 認可エラーのテストケースが追加されている

### 2.3 スコープ

#### 含むもの

- `getSession()` メソッドへのuserID検証追加
- `deleteSession()` メソッドへのuserID検証追加
- `updateSession()` メソッドへのuserID検証追加
- `exportToMarkdown()`, `exportToJson()` メソッドへのuserID検証追加
- `searchSessions()` メソッドの認可ロジック確認
- UnauthorizedErrorカスタムエラークラスの作成
- 認可失敗時のテストケース追加

#### 含まないもの

- 認証機能の実装（将来タスク）
- セッショントークンの管理
- ロールベースアクセス制御（RBAC）
- 監査ログ機能

### 2.4 成果物

| 種別         | 成果物                  | 配置先                                                                             |
| ------------ | ----------------------- | ---------------------------------------------------------------------------------- |
| 機能         | UnauthorizedErrorクラス | `packages/shared/src/features/chat-history/errors.ts`                              |
| 機能         | 認可チェック機能        | `packages/shared/src/features/chat-history/chat-history-service.ts`                |
| テスト       | 認可失敗テストケース    | `packages/shared/src/features/chat-history/__tests__/chat-history-service.test.ts` |
| ドキュメント | セキュリティ対応記録    | `docs/30-workflows/chat-history-persistence/security-improvements.md`              |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- Phase 6: 品質保証が完了していること
- セキュリティ監査レポート（security-audit-report.md）が作成済み
- 既存テストがすべて成功していること

### 3.2 依存タスク

- T-06-2: セキュリティ監査（完了）

### 3.3 必要な知識・スキル

- OWASP Top 10（特にA01: Broken Access Control）
- TypeScriptエラーハンドリングパターン
- Drizzle ORM
- Vitest（ユニットテスト）
- Clean Architecture（認可の実装レイヤー）

### 3.4 推奨アプローチ

**設計方針**: Fail-Secure原則

- 認可チェックは「明示的な許可」のみを通す
- デフォルトは拒否（Deny by Default）

**実装方針**: 段階的な導入

1. エラークラス作成 → テスト作成 → 実装 のTDDサイクル
2. 各メソッドを個別に対応（影響範囲を限定）
3. 既存テストの互換性維持（シグネチャ変更は慎重に）

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件定義（認可要件）
Phase 1: 設計（エラークラス・認可ロジック設計）
Phase 2: 設計レビューゲート
Phase 3: テスト作成（TDD: Red）
Phase 4: 実装（TDD: Green）
Phase 5: リファクタリング
Phase 6: 品質保証
Phase 7: 最終レビューゲート
Phase 8: 手動テスト検証
Phase 9: ドキュメント更新
```

---

### Phase 0: 要件定義

#### T-00-1: 認可要件定義

##### 目的

アクセス制御強化の機能要件・非機能要件を明確化する。

##### 背景

OWASP A01違反を解消するため、リソースレベル認可の要件を定義する必要がある。

##### 責務（単一責務）

認可機能の要件を定義する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:define-requirements security-authorization
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@auth-specialist`
- **選定理由**: 認証・認可のセキュリティ設計に精通し、OAuth、JWT、RBACなどの実装経験が豊富
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                      | 活用方法                             |
| ----------------------------- | ------------------------------------ |
| rbac-implementation           | リソースレベル認可の設計パターン参照 |
| security-configuration-review | 認可設定のベストプラクティス確認     |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物     | パス                                                                       | 内容                           |
| ---------- | -------------------------------------------------------------------------- | ------------------------------ |
| 認可要件書 | `docs/30-workflows/chat-history-persistence/requirements-authorization.md` | 認可機能の機能要件・非機能要件 |

##### 完了条件

- [ ] 機能要件が明確に定義されている
- [ ] 非機能要件（パフォーマンス影響）が記載されている
- [ ] エラーレスポンス仕様が定義されている
- [ ] 認可失敗時の振る舞いが明確である

##### 依存関係

- **前提**: T-06-2（セキュリティ監査完了）
- **後続**: T-01-1（認可ロジック設計）

---

### Phase 1: 設計

#### T-01-1: エラークラス・認可ロジック設計

##### 目的

認可失敗時のエラークラスと、各メソッドへの認可チェック追加方法を設計する。

##### 背景

既存のメソッドシグネチャとの互換性を保ちつつ、認可チェックを導入する必要がある。

##### 責務（単一責務）

認可ロジックを設計する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:design-architecture authorization-logic
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@auth-specialist`
- **選定理由**: 認可ロジックの実装パターンに精通
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                      | 活用方法                   |
| ----------------------------- | -------------------------- |
| rbac-implementation           | リソースレベル認可パターン |
| clean-architecture-principles | レイヤー適切性の確認       |
| error-handling-strategies     | エラークラス設計           |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物 | パス                                                                 | 内容                               |
| ------ | -------------------------------------------------------------------- | ---------------------------------- |
| 設計書 | `docs/30-workflows/chat-history-persistence/design-authorization.md` | エラークラス設計、認可ロジック設計 |

##### 完了条件

- [ ] UnauthorizedErrorクラスの設計が完了している
- [ ] 各メソッドへの認可チェック追加方法が明確である
- [ ] 既存メソッドシグネチャとの互換性が考慮されている
- [ ] パフォーマンス影響が評価されている

##### 依存関係

- **前提**: T-00-1
- **後続**: T-02-1

---

### Phase 2: 設計レビューゲート

#### T-02-1: 認可設計レビュー

##### 目的

実装前に認可ロジック設計の妥当性を検証し、問題を早期発見する。

##### 背景

認可の実装ミスはセキュリティインシデントに直結するため、Shift Left原則に基づいて設計段階でレビューする。

##### レビュー参加エージェント

| エージェント     | レビュー観点         | 選定理由                               |
| ---------------- | -------------------- | -------------------------------------- |
| @sec-auditor     | OWASP準拠確認        | セキュリティ脆弱性検出の専門家         |
| @auth-specialist | 認可ロジック妥当性   | 認証・認可実装のベストプラクティス知識 |
| @arch-police     | アーキテクチャ整合性 | Clean Architectureレイヤー違反の検出   |

- **参照**: `.claude/agents/agent_list.md`

##### レビューチェックリスト

**セキュリティ観点** (@sec-auditor)

- [ ] OWASP A01準拠が達成されるか
- [ ] 認可バイパスの可能性がないか
- [ ] エラーメッセージから情報漏洩しないか
- [ ] Fail-Secure設計が適用されているか

**認可ロジック妥当性** (@auth-specialist)

- [ ] 認可チェックのタイミングが適切か
- [ ] 認可ルールが明確に定義されているか
- [ ] エッジケースが考慮されているか

**アーキテクチャ整合性** (@arch-police)

- [ ] 認可ロジックが適切なレイヤーに配置されているか
- [ ] 依存関係逆転の原則(DIP)が守られているか
- [ ] 既存設計との整合性があるか

##### レビュー結果

- **判定**: {{PASS/MINOR/MAJOR}}
- **指摘事項**: {{指摘内容}}
- **対応方針**: {{対応内容}}

##### 戻り先決定（MAJORの場合）

| 問題の種類 | 戻り先              |
| ---------- | ------------------- |
| 要件の問題 | Phase 0（要件定義） |
| 設計の問題 | Phase 1（設計）     |

##### 完了条件

- [ ] 全レビュー観点で問題なし、またはMINOR指摘のみ
- [ ] MINOR指摘への対応が完了している
- [ ] Phase 3（テスト作成）へ進行可能

##### 依存関係

- **前提**: T-01-1
- **後続**: T-03-1

---

### Phase 3: テスト作成（TDD: Red）

#### T-03-1: 認可エラーテスト作成

##### 目的

認可失敗時の振る舞いを検証するテストを、実装前に作成する。

##### 背景

TDD原則に基づき、期待される動作を先に定義することで、実装品質を担保する。

##### 責務（単一責務）

認可失敗シナリオのテストを作成する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:generate-unit-tests authorization-failure
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@unit-tester`
- **選定理由**: TDD原則に基づくテスト設計の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                | 活用方法                         |
| ----------------------- | -------------------------------- |
| tdd-principles          | Red-Green-Refactorサイクルの適用 |
| boundary-value-analysis | 境界値・異常系テストケース設計   |
| test-doubles            | モック・スタブによる依存分離     |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物         | パス                                                                        | 内容                   |
| -------------- | --------------------------------------------------------------------------- | ---------------------- |
| ユニットテスト | `packages/shared/src/features/chat-history/__tests__/authorization.test.ts` | 認可エラーテストケース |

##### TDD検証: Red状態確認

```bash
pnpm --filter @repo/shared test:run chat-history
```

- [ ] テストが失敗することを確認（Red状態）
- [ ] UnauthorizedErrorが未定義で失敗する
- [ ] 認可チェックが未実装で成功する（期待: 失敗）

##### 完了条件

- [ ] 以下のテストケースが実装されている：
  - [ ] `getSession()`: 他ユーザーのセッションアクセス時にUnauthorizedErrorを投げる
  - [ ] `deleteSession()`: 他ユーザーのセッション削除時にUnauthorizedErrorを投げる
  - [ ] `updateSession()`: 他ユーザーのセッション更新時にUnauthorizedErrorを投げる
  - [ ] `exportToMarkdown()`: 他ユーザーのエクスポート時にUnauthorizedErrorを投げる
  - [ ] `exportToJson()`: 他ユーザーのエクスポート時にUnauthorizedErrorを投げる
  - [ ] 正常系: 所有者がアクセスした場合は正常動作する
- [ ] テストがRed状態（失敗）である

##### 依存関係

- **前提**: T-02-1
- **後続**: T-04-1

---

### Phase 4: 実装（TDD: Green）

#### T-04-1: UnauthorizedErrorクラス実装

##### 目的

認可失敗時の専用エラークラスを実装する。

##### 背景

標準Errorではエラー種別の判定が困難なため、カスタムエラークラスを作成する。

##### 責務（単一責務）

UnauthorizedErrorクラスを実装する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:implement error-classes
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@logic-dev`
- **選定理由**: ビジネスロジック層の実装に精通
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名                  | 活用方法                         |
| ------------------------- | -------------------------------- |
| error-handling-strategies | カスタムエラークラス実装パターン |
| type-safety-patterns      | TypeScript型安全なエラー設計     |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物       | パス                                                  | 内容                        |
| ------------ | ----------------------------------------------------- | --------------------------- |
| エラークラス | `packages/shared/src/features/chat-history/errors.ts` | UnauthorizedErrorクラス定義 |

##### TDD検証: 部分Green状態確認

```bash
pnpm --filter @repo/shared test:run chat-history
```

- [ ] UnauthorizedErrorのインポートエラーが解消
- [ ] 認可チェック未実装のため一部テストは失敗継続（期待通り）

##### 完了条件

- [ ] UnauthorizedErrorクラスが実装されている
- [ ] エラーメッセージが分かりやすい
- [ ] スタックトレースが適切に保持される
- [ ] 型定義がエクスポートされている

##### 依存関係

- **前提**: T-03-1
- **後続**: T-04-2

---

#### T-04-2: 認可チェック実装

##### 目的

各メソッドにuserID検証ロジックを追加し、テストをGreen状態にする。

##### 背景

TDDサイクルのGreenフェーズとして、テストを通すための最小限の実装を行う。

##### 責務（単一責務）

認可チェックロジックを実装する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:implement authorization-logic
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@auth-specialist`
- **選定理由**: 認可ロジック実装のベストプラクティス知識
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名             | 活用方法                         |
| -------------------- | -------------------------------- |
| rbac-implementation  | リソースレベル認可の実装パターン |
| clean-code-practices | 可読性の高い実装                 |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物       | パス                                                                | 内容                     |
| ------------ | ------------------------------------------------------------------- | ------------------------ |
| 認可ロジック | `packages/shared/src/features/chat-history/chat-history-service.ts` | 各メソッドの認可チェック |

##### 実装対象メソッド

```typescript
// 修正対象
async getSession(id: string, requestUserId: string): Promise<ChatSession | null>
async deleteSession(id: string, requestUserId: string): Promise<boolean>
async updateSession(id: string, requestUserId: string, data: UpdateChatSession): Promise<boolean>
async exportToMarkdown(sessionId: string, requestUserId: string, options?: ExportOptions): Promise<string>
async exportToJson(sessionId: string, requestUserId: string, options?: ExportOptions): Promise<string>
```

##### TDD検証: Green状態確認

```bash
pnpm --filter @repo/shared test:run chat-history
```

- [ ] すべてのテストが成功することを確認（Green状態）
- [ ] 認可失敗テストが成功する
- [ ] 正常系テストも継続成功する

##### 完了条件

- [ ] すべての対象メソッドに認可チェックが実装されている
- [ ] 他ユーザーのアクセス時にUnauthorizedErrorを投げる
- [ ] 所有者のアクセス時は正常動作する
- [ ] 既存テストが全て成功している

##### 依存関係

- **前提**: T-04-1
- **後続**: T-05-1

---

### Phase 5: リファクタリング

#### T-05-1: 認可ロジックのリファクタリング

##### 目的

動作を変えずにコード品質を改善する。

##### 背景

重複する認可チェックロジックを共通化し、保守性を向上させる。

##### 責務（単一責務）

認可ロジックをリファクタリングする。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:refactor authorization-logic
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@code-quality`
- **選定理由**: Nicholas C. Zakas哲学に基づくClean Code実践の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名               | 活用方法                    |
| ---------------------- | --------------------------- |
| refactoring-techniques | Extract Method、DRY原則適用 |
| clean-code-practices   | 可読性・保守性向上          |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物                     | パス                                                                | 内容                     |
| -------------------------- | ------------------------------------------------------------------- | ------------------------ |
| リファクタリング済みコード | `packages/shared/src/features/chat-history/chat-history-service.ts` | 共通化された認可ロジック |

##### TDD検証: 継続Green確認

```bash
pnpm --filter @repo/shared test:run chat-history
```

- [ ] リファクタリング後もテストが成功することを確認

##### 完了条件

- [ ] 認可チェックロジックが共通化されている
- [ ] コードの重複が排除されている
- [ ] 可読性が向上している
- [ ] すべてのテストが継続成功している

##### 依存関係

- **前提**: T-04-2
- **後続**: T-06-1

---

### Phase 6: 品質保証

#### T-06-1: 認可機能の品質保証

##### 目的

実装された認可機能が品質基準を満たすことを検証する。

##### 背景

セキュリティ機能は品質基準が特に重要なため、包括的な検証を実施する。

##### 責務（単一責務）

品質ゲート基準を検証する。

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:run-all-tests --coverage
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@unit-tester`
- **選定理由**: TDD原則に基づくテスト実行・カバレッジ分析の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 活用スキル

| スキル名               | 活用方法          |
| ---------------------- | ----------------- |
| tdd-principles         | TDD品質基準の検証 |
| test-coverage-analysis | カバレッジ分析    |

- **参照**: `.claude/skills/skill_list.md`

##### 成果物

| 成果物         | パス                                                                      | 内容                   |
| -------------- | ------------------------------------------------------------------------- | ---------------------- |
| テストレポート | `docs/30-workflows/chat-history-persistence/authorization-test-report.md` | テスト結果・カバレッジ |

##### 完了条件

- [ ] 全ユニットテストが成功している
- [ ] 認可チェックのカバレッジが100%である
- [ ] Lintエラーがゼロである
- [ ] 型エラーがゼロである

##### 依存関係

- **前提**: T-05-1
- **後続**: T-07-1

---

### Phase 7: 最終レビューゲート

#### T-07-1: 認可実装の最終レビュー

##### 目的

実装完了後、全体的な品質・セキュリティを検証する。

##### 背景

自動テストでは検出できない設計判断やベストプラクティス違反を確認する。

##### レビュー参加エージェント

| エージェント  | レビュー観点         | 選定理由                   |
| ------------- | -------------------- | -------------------------- |
| @sec-auditor  | セキュリティ最終確認 | OWASP準拠の最終検証        |
| @code-quality | コード品質確認       | Clean Code原則への準拠確認 |
| @unit-tester  | テスト品質確認       | テストケースの網羅性確認   |

- **参照**: `.claude/agents/agent_list.md`

##### レビューチェックリスト

**セキュリティ** (@sec-auditor)

- [ ] OWASP A01が完全に解消されているか
- [ ] 認可バイパスの可能性が排除されているか
- [ ] エラーハンドリングが適切か

**コード品質** (@code-quality)

- [ ] Clean Code原則に準拠しているか
- [ ] SOLID原則に準拠しているか
- [ ] 可読性・保守性が確保されているか

**テスト品質** (@unit-tester)

- [ ] テストカバレッジが100%か
- [ ] 境界値・異常系のテストがあるか
- [ ] テストの可読性・保守性が確保されているか

##### レビュー結果

- **判定**: {{PASS/MINOR/MAJOR}}
- **指摘事項**: {{指摘内容}}
- **未完了タスク数**: {{未完了タスク数}}件

##### 戻り先決定（MAJOR/CRITICALの場合）

| 問題の種類       | 戻り先  |
| ---------------- | ------- |
| 要件の問題       | Phase 0 |
| 設計の問題       | Phase 1 |
| テスト設計の問題 | Phase 3 |
| 実装の問題       | Phase 4 |
| コード品質の問題 | Phase 5 |

##### 完了条件

- [ ] 全レビュー観点で問題なし、またはMINOR指摘のみ
- [ ] MINOR指摘への対応が完了している
- [ ] Phase 8（手動テスト）へ進行可能

##### 依存関係

- **前提**: T-06-1
- **後続**: T-08-1

---

### Phase 8: 手動テスト検証

#### T-08-1: 認可機能の手動検証

##### 目的

自動テストでは検証できない実環境での認可動作を手動で確認する。

##### 背景

実際のアプリケーション動作において、認可エラーが適切にユーザーに伝わることを確認する必要がある。

##### テスト分類

統合テスト

##### 使用エージェント

- **エージェント**: `@e2e-tester`
- **選定理由**: ユーザー視点での動作確認の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 手動テストケース

| No  | カテゴリ | テスト項目               | 前提条件                     | 操作手順                                                     | 期待結果                                   | 実行結果 | 備考 |
| --- | -------- | ------------------------ | ---------------------------- | ------------------------------------------------------------ | ------------------------------------------ | -------- | ---- |
| 1   | 認可成功 | 所有者がセッションを表示 | ログイン済み、セッション存在 | 1. チャット履歴一覧を開く<br>2. 自分のセッションを選択       | セッション詳細が表示される                 |          |      |
| 2   | 認可成功 | 所有者がセッションを削除 | ログイン済み、セッション存在 | 1. 自分のセッションを選択<br>2. 削除ボタンをクリック         | 削除確認ダイアログ → 削除成功              |          |      |
| 3   | 認可成功 | 所有者がエクスポート     | ログイン済み、セッション存在 | 1. 自分のセッションを開く<br>2. エクスポートボタンをクリック | エクスポートダイアログ → ダウンロード成功  |          |      |
| 4   | 異常系   | エラーメッセージ表示     | -                            | 認可エラー発生時                                             | 「アクセス権限がありません」メッセージ表示 |          |      |

##### テスト実行手順

1. デスクトップアプリを起動
2. テストユーザーでログイン
3. 上記テストケースを順次実行
4. 結果を記録
5. 発見された問題を未完了タスクとして記録

##### 成果物

| 成果物         | パス                                                                      | 内容               |
| -------------- | ------------------------------------------------------------------------- | ------------------ |
| 手動テスト結果 | `docs/30-workflows/chat-history-persistence/manual-test-authorization.md` | 手動テスト実行結果 |

##### 完了条件

- [ ] すべての手動テストケースが実行済み
- [ ] すべてのテストケースがPASS
- [ ] 発見された不具合が修正済みまたは未完了タスクとして記録済み

##### 依存関係

- **前提**: T-07-1
- **後続**: T-09-1

---

### Phase 9: ドキュメント更新

#### T-09-1: システムドキュメント更新

##### 目的

実装した認可機能を、システム要件ドキュメントに反映する。

##### 前提条件

- [ ] Phase 6の品質ゲートをすべて通過
- [ ] Phase 7の最終レビューゲートを通過
- [ ] Phase 8の手動テストが完了
- [ ] すべてのテストが成功

##### 更新対象ドキュメント

| ドキュメント                                     | 更新内容                       |
| ------------------------------------------------ | ------------------------------ |
| `docs/00-requirements/17-security-guidelines.md` | 認可機能の追加を記載           |
| `docs/00-requirements/07-error-handling.md`      | UnauthorizedErrorの追加を記載  |
| `docs/00-requirements/05-architecture.md`        | 認可レイヤーの追加を概要で記載 |

##### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
/ai:update-all-docs
```

- **参照**: `.claude/commands/ai/command_list.md`

##### 使用エージェント

- **エージェント**: `@spec-writer`
- **選定理由**: システムドキュメント更新の専門家
- **参照**: `.claude/agents/agent_list.md`

##### 更新原則

- 概要のみ記載（詳細な実装説明は不要）
- システム構築に必要十分な情報のみ追記
- 既存ドキュメントの構造・フォーマットを維持
- Single Source of Truth原則を遵守

##### 完了条件

- [ ] 全対象ドキュメントが更新されている
- [ ] 追記内容が概要レベルである
- [ ] 既存フォーマットが維持されている

##### 依存関係

- **前提**: T-08-1
- **後続**: なし（完了）

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] すべての対象メソッドに認可チェックが実装されている
- [ ] UnauthorizedErrorクラスが実装されている
- [ ] 他ユーザーのアクセス時にエラーを投げる
- [ ] 所有者のアクセス時は正常動作する

### 品質要件

- [ ] 全ユニットテスト成功
- [ ] 認可チェックのカバレッジ100%
- [ ] Lintエラー0件
- [ ] 型エラー0件
- [ ] 手動テスト全件PASS

### セキュリティ要件

- [ ] OWASP A01が解消されている
- [ ] 認可バイパスの可能性が排除されている
- [ ] エラーメッセージから情報漏洩がない

### ドキュメント要件

- [ ] システムドキュメントが更新されている
- [ ] テストレポートが作成されている

---

## 6. 検証方法

### テストケース

**ユニットテスト**:

```bash
pnpm --filter @repo/shared test:run chat-history
```

**E2Eテスト** (将来):

```bash
pnpm --filter @repo/desktop test:e2e
```

### 検証手順

1. ユニットテストを実行し、全テスト成功を確認
2. カバレッジレポートで認可ロジックが100%カバーされていることを確認
3. 手動テストで実際の動作を確認
4. セキュリティ監査を再実行し、OWASP A01が解消されたことを確認

---

## 7. リスクと対策

| リスク                   | 影響度 | 発生確率 | 対策                                               |
| ------------------------ | ------ | -------- | -------------------------------------------------- |
| 既存テストの互換性破壊   | 高     | 中       | メソッドシグネチャ変更前に既存呼び出し箇所を全調査 |
| パフォーマンス劣化       | 中     | 低       | 認可チェックは最小限のDB問い合わせで実装           |
| エラーハンドリング漏れ   | 高     | 低       | 全メソッドで統一的なエラーハンドリング実装         |
| レビュー指摘による手戻り | 中     | 中       | Phase 2, 7のレビューゲートで早期発見               |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/30-workflows/chat-history-persistence/security-audit-report.md` - セキュリティ監査レポート
- `docs/00-requirements/17-security-guidelines.md` - セキュリティガイドライン
- `.claude/agents/auth-specialist.md` - 認証・認可専門エージェント
- `.claude/skills/rbac-implementation/SKILL.md` - RBAC実装パターン

### 参考資料

- [OWASP A01: Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- [OWASP Authorization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html)
- [Clean Architecture - Use Case Layer](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

## 9. 備考

### レビュー指摘の原文

```
### 1. A01: アクセス制御の不備（Medium）

**重大度**: Medium
**CVSS**: 5.5 (AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N)

**検出箇所**:
packages/shared/src/features/chat-history/chat-history-service.ts
- Line 91-93: セッションID単独でアクセス可能
- Line 114-123: 所有者確認なしでセッション削除可能

**リスク**: 他ユーザーのセッションIDを推測/入手した場合、不正なアクセスが可能

**推奨対策**:
各メソッドにrequestUserIdパラメータを追加し、session.userIdとの照合を実装する
```

### 補足事項

**実装上の注意点**:

1. メソッドシグネチャ変更による既存コードへの影響を慎重に確認
2. 認可チェックは必ずDB問い合わせ後、データ返却前に実施
3. エラーメッセージは「セッションが見つかりません」ではなく「アクセス権限がありません」とする（情報漏洩防止）

**段階的な実装方針**:

1. 新規メソッド追加（後方互換性維持）
2. 既存メソッドからの移行（deprecation警告）
3. 既存メソッド削除（メジャーバージョンアップ時）
