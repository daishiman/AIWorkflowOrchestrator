# チャット内LLMモデル切り替え機能 - タスク指示書

## メタ情報

| 項目             | 内容                            |
| ---------------- | ------------------------------- |
| タスクID         | TASK-CHAT-LLM-SWITCH-001        |
| タスク名         | チャット内LLMモデル切り替え機能 |
| 分類             | 新規機能                        |
| 対象機能         | チャット                        |
| 優先度           | 高                              |
| 見積もり規模     | 中規模                          |
| ステータス       | 未実施                          |
| 発見元           | ユーザー要望                    |
| 発見日           | 2025-12-11                      |
| 発見エージェント | @product-manager                |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

異なるLLMはそれぞれ得意分野が異なる。一つのチャットセッション内で、タスクに応じてLLMを切り替えることで、最適な回答を得られる。例えば、コード生成はClaude、一般的な質問はGPT-4といった使い分けが可能になる。

### 1.2 問題点・課題

- 一つのチャットで複数LLMを使い分けられない
- LLM切り替え時にコンテキストが失われる
- タスクに最適なLLMを選択できない

### 1.3 放置した場合の影響

- LLMの強みを活かせない
- ユーザーの作業効率が低下
- 複数LLMを活用するワークフローが構築できない

---

## 2. 何を達成するか（What）

### 2.1 目的

一つのチャットセッション内で、メッセージごとに異なるLLMを選択・切り替えできるようにする。切り替え後もシステムプロンプトと会話履歴が引き継がれる。

### 2.2 最終ゴール

- メッセージ送信時のLLM選択UI
- 会話履歴の引き継ぎ（LLM切り替え後も以前の会話を参照）
- システムプロンプトの維持
- 各メッセージにどのLLMが使用されたかを表示

### 2.3 スコープ

#### 含むもの

**LLMプロバイダー対応**

- OpenAI（GPT-4, GPT-4o, GPT-3.5）
- Anthropic（Claude 3.5, Claude 3）
- Google（Gemini Pro, Gemini Ultra）
- ローカルLLM（Ollama等）- 将来対応

**切り替え機能**

- メッセージ送信前のLLM選択ドロップダウン
- デフォルトLLMの設定
- 会話履歴のLLM間共有
- システムプロンプトの維持

**表示機能**

- 各メッセージにLLMアイコン/ラベル表示
- LLMごとの色分け（オプション）

#### 含まないもの

- 同時に複数LLMへの送信（別タスク）
- LLMの自動選択
- コスト最適化のための自動ルーティング

### 2.4 成果物

- LLM選択UI
- マルチLLMチャットロジック
- 会話履歴の統合管理
- 関連するユニットテスト

---

## 3. 主要な使用エージェント

- **@ui-designer**: LLM選択UIの設計
- **@gateway-dev**: LLM API統合
- **@state-manager**: 会話状態管理
- **@arch-police**: マルチLLMアーキテクチャ設計

---

## 4. 完了条件チェックリスト

- [ ] メッセージ送信時にLLMを選択できる
- [ ] 切り替え後も会話履歴が参照される
- [ ] システムプロンプトがLLM切り替え後も維持される
- [ ] 各メッセージに使用LLMが表示される
- [ ] デフォルトLLMを設定できる

---

## 5. 備考

### レビュー指摘の原文

```
チャット内で複数のLLMのモデルを選択できるようにしてほしいです。
例えば、一つのチャットで1回目はClaudeを使って、2回目はOpenAIを使うというように切り替えができるようにしてほしいです。
切り替えた内容でもシステムプロンプトや以前のチャットの情報は渡せるようにしてほしいです。
```

### 関連タスク

- TASK-CHAT-SYSPROMPT-001: システムプロンプト設定機能
- TASK-CHAT-SPLIT-COMPARE-001: 画面分割LLM比較機能
