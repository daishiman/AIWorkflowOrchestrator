# 自動保存機能 - タスク指示書

## メタ情報

| 項目             | 内容               |
| ---------------- | ------------------ |
| タスクID         | TASK-AUTO-SAVE-001 |
| タスク名         | 自動保存機能       |
| 分類             | 新規機能           |
| 対象機能         | エディター・設定   |
| 優先度           | 中                 |
| 見積もり規模     | 小規模             |
| ステータス       | 未実施             |
| 発見元           | ユーザー要望       |
| 発見日           | 2025-12-11         |
| 発見エージェント | .claude/agents/product-manager.md   |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

ファイル編集中に保存を忘れてデータを失うリスクがある。自動保存機能があれば、ユーザーは編集に集中でき、予期せぬ終了時にもデータが保護される。一方で、意図しない変更が自動保存されることを好まないユーザーもいるため、オン/オフの切り替えが必要である。

### 1.2 問題点・課題

- 保存し忘れによるデータ損失リスク
- 手動保存の手間
- クラッシュ時のデータ復旧ができない
- ユーザーごとに保存スタイルの好みが異なる

### 1.3 放置した場合の影響

- ユーザーの作業データが失われる可能性
- ユーザー体験（UX）の悪化
- 競合エディターと比較して機能的に劣る
- ユーザーからの信頼低下

---

## 2. 何を達成するか（What）

### 2.1 目的

ファイル編集時の自動保存機能を実装し、ユーザー設定で有効/無効を切り替えられるようにする。

### 2.2 最終ゴール

- ファイル変更時に自動保存される
- 自動保存のオン/オフをユーザー設定で切り替え可能
- 自動保存の遅延時間（デバウンス）を設定可能
- 自動保存時の視覚的フィードバック
- 未保存状態の明確な表示

### 2.3 スコープ

#### 含むもの

**自動保存機能**

- ファイル変更検知後の自動保存
- デバウンス処理（連続入力中は保存しない）
- 保存中/保存完了のステータス表示
- エラー時のリトライ処理

**ユーザー設定**

- 自動保存のオン/オフトグル
- 自動保存の遅延時間設定（例: 1秒、3秒、5秒）
- フォーカスアウト時の自動保存オプション

**UI/UX**

- 未保存状態のインジケーター（タブにドット表示等）
- 保存中のローディング表示
- 保存完了の通知（控えめなフィードバック）

#### 含まないもの

- バージョン履歴管理
- クラウド同期
- 競合解決機能
- 自動バックアップ（別タスクとして検討）

### 2.4 成果物

- 自動保存ロジック
- ユーザー設定UIの拡張
- 保存状態表示コンポーネント
- 関連するユニットテスト
- 技術ドキュメント

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- プロジェクトの開発環境がセットアップ済み
- エディターコンポーネントが実装済み
- ユーザー設定機能が実装済み

### 3.2 依存タスク

- なし（独立したタスク）

### 3.3 必要な知識・スキル

- React/TypeScript
- Electron（ファイルシステム操作）
- デバウンス/スロットリングパターン
- 状態管理（Zustand等）

### 3.4 推奨アプローチ

1. 自動保存ロジックの設計（デバウンス処理）
2. ユーザー設定スキーマの拡張
3. 設定UIの実装
4. 保存状態表示の実装
5. エラーハンドリングの実装

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件定義
Phase 1: 設計
  - T-01-1: 自動保存ロジック設計
  - T-01-2: ユーザー設定スキーマ設計
  - T-01-3: UI設計
Phase 2: 設計レビューゲート
Phase 3: テスト作成（TDD: Red）
Phase 4: 実装（TDD: Green）
  - T-04-1: 自動保存ロジック実装
  - T-04-2: ユーザー設定拡張
  - T-04-3: 保存状態UI実装
Phase 5: リファクタリング（TDD: Refactor）
Phase 6: 品質保証
Phase 7: 最終レビューゲート
Phase 8: 手動テスト検証
Phase 9: ドキュメント更新
```

### 主要な使用エージェント

- **.claude/agents/logic-dev.md**: 自動保存ロジックの実装
- **.claude/agents/ui-designer.md**: 設定UI・保存状態表示の設計
- **.claude/agents/state-manager.md**: 状態管理の設計
- **.claude/agents/unit-tester.md**: TDDでのテスト作成

---

## 5. 手動テストケース

| No  | カテゴリ | テスト項目           | 操作手順                         | 期待結果                   |
| --- | -------- | -------------------- | -------------------------------- | -------------------------- |
| 1   | 自動保存 | 変更後の自動保存     | ファイルを編集                   | 設定秒数後に自動保存       |
| 2   | 自動保存 | 連続入力中の保存抑制 | 連続して文字入力                 | 入力停止後に1回だけ保存    |
| 3   | 設定     | 自動保存オフ         | 設定でオフに変更                 | 自動保存されない           |
| 4   | 設定     | 遅延時間変更         | 遅延時間を変更                   | 変更した時間後に保存       |
| 5   | 設定     | フォーカスアウト保存 | エディターからフォーカス移動     | 即座に保存                 |
| 6   | UI       | 未保存インジケーター | ファイルを編集（自動保存オフ時） | タブに未保存マーク表示     |
| 7   | UI       | 保存中表示           | 自動保存トリガー                 | 保存中のインジケーター表示 |
| 8   | エラー   | 保存失敗時のリトライ | 保存エラーを発生させる           | リトライ後エラー通知       |

---

## 6. 完了条件チェックリスト

### 機能要件

- [ ] ファイル変更後に自動保存される
- [ ] 自動保存のオン/オフを設定で切り替えられる
- [ ] 遅延時間を設定できる
- [ ] フォーカスアウト時の自動保存を設定できる
- [ ] 未保存状態が視覚的に分かる
- [ ] 保存中/保存完了のフィードバックがある

### 品質要件

- [ ] 全テストがPASS
- [ ] Lintエラーなし
- [ ] 型エラーなし
- [ ] パフォーマンスに影響がない

---

## 7. リスクと対策

| リスク                         | 影響度 | 発生確率 | 対策                               |
| ------------------------------ | ------ | -------- | ---------------------------------- |
| 意図しない変更の保存           | 中     | 中       | オフ設定、アンドゥ機能             |
| 保存エラーでデータ損失         | 高     | 低       | リトライ、エラー通知、バックアップ |
| 頻繁な保存でパフォーマンス低下 | 中     | 中       | 適切なデバウンス設定               |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン
- `packages/shared/types/settings.ts` - ユーザー設定型定義

### 参考資料

- [VS Code Auto Save](https://code.visualstudio.com/docs/editor/codebasics#_save-auto-save)

---

## 9. 備考

### レビュー指摘の原文

```
ファイル変換したら自動保存するか、自動保存のオンオフ機能を追加してほしいです。
自動保存したい場合は、ユーザー設定の方で切り替えられるようにしておきたいです。
```

### 補足事項

- VS Codeのような自動保存体験を目指す
- デフォルトは「オン」を推奨（遅延時間1秒程度）
- 設定は即座に反映される（アプリ再起動不要）
