# 大容量ファイル対応（ストリーミング処理） - タスク指示書

## メタ情報

| 項目         | 内容                                     |
| ------------ | ---------------------------------------- |
| タスクID     | CONV-DEBT-003                            |
| タスク名     | 大容量ファイル対応（ストリーミング処理） |
| 分類         | 改善/パフォーマンス                      |
| 対象機能     | ConversionService、全コンバーター        |
| 優先度       | 低                                       |
| 見積もり規模 | 中規模（約12時間）                       |
| ステータス   | 未実施                                   |
| 発見元       | Phase 7 最終アーキテクチャレビュー       |
| 発見日       | 2025-12-25                               |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

現在のRAG Conversion Systemは、ファイル全体をメモリに読み込んで処理する同期的なアプローチを採用しています。

**レビュー指摘の原文**:

```
制限事項: 同期処理 - 非同期ストリーミング未対応
影響範囲: ConversionService - 超大容量ファイルでメモリ枯渇の可能性

Phase 8手動テスト:
大容量ファイル（10MB超）のパフォーマンスは未検証
```

現状の検証済みファイルサイズは1MB以下であり、10MB超のファイルでのメモリ使用量と処理時間が不明です。

### 1.2 問題点・課題

**問題1: メモリ枯渇リスク**

大容量ファイル（50MB）を同時5件処理する場合：

- 必要メモリ = 50MB × 5 × 3倍（処理オーバーヘッド） = 750MB
- Node.jsヒープメモリ上限に到達する可能性

**問題2: 処理時間の予測不能性**

- < 1MB: 検証済み（3-400ms）
- 1-10MB: 未検証
- > 10MB: 未検証

タイムアウト（60秒）で処理が中断される可能性があります。

**問題3: UX（ユーザー体験）の低下**

大容量ファイル処理時に進捗が見えず、キャンセルもできません。

### 1.3 放置した場合の影響

**短期的影響**:

- 大容量ファイル（>10MB）の変換失敗
- メモリエラーによるアプリクラッシュ

**長期的影響**:

- 大規模コードベースのインデックス化が不可能
- ログファイル解析の制限

---

## 2. 何を達成するか（What）

### 2.1 目的

Node.js Streamを活用したストリーミング処理により、大容量ファイル（10MB超）を効率的に変換可能にする。

### 2.2 最終ゴール

- ストリーミング処理: ファイルを1MBチャンクに分割して段階的に処理
- メモリ効率: 10MB超のファイルでもメモリ使用量を一定に保つ
- 進捗通知: onProgressコールバックで処理進捗をリアルタイム通知
- キャンセル対応: AbortSignalによる処理途中での中断
- パフォーマンス目標: 10MBファイル<5秒、50MBファイル<30秒
- 後方互換性: 既存convert()メソッドは変更なし

### 2.3 スコープ

#### 含むもの

- `convertStream()` メソッド追加（新規API）
- チャンク処理（1MBチャンク、設定可能）
- 進捗通知機能（onProgressコールバック）
- AbortSignal対応（キャンセル機能）
- メモリ管理（GC促進、メモリ監視）
- パフォーマンステスト（10MB, 50MB, 100MB）

#### 含まないもの

- Worker Threads統合（別タスク）
- バイナリファイルのストリーミング
- ネットワークストリーム対応（HTTP経由）
- リアルタイム変換（ファイル監視との統合）

### 2.4 成果物

| 成果物                      | パス                                                                                | 内容                          |
| --------------------------- | ----------------------------------------------------------------------------------- | ----------------------------- |
| 拡張されたConversionService | `packages/shared/src/services/conversion/conversion-service.ts`                     | convertStream()追加           |
| Stream対応BaseConverter     | `packages/shared/src/services/conversion/base-converter.ts`                         | doConvertStream()テンプレート |
| ストリーミングテスト        | `packages/shared/src/services/conversion/__tests__/streaming.test.ts`               | 機能テスト                    |
| パフォーマンステスト        | `packages/shared/src/services/conversion/__manual-tests__/benchmark-large-files.ts` | 大容量ファイルベンチマーク    |
| API仕様更新                 | `docs/30-api/conversion-service.md`                                                 | convertStream() API           |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- AST-based解析移行完了（CONV-DEBT-002）推奨
- Node.js Stream APIの理解
- Promise/async-awaitの理解

### 3.2 依存タスク

- なし（独立タスク、ただしCONV-DEBT-002完了後が推奨）

### 3.3 必要な知識・スキル

- Node.js Stream API（ReadableStream, createReadStream）
- AbortController/AbortSignal
- メモリ管理とガベージコレクション

### 3.4 推奨アプローチ

段階的な実装アプローチ：

1. まず小ファイル（<1MB）でストリーミングAPIを実装・検証
2. チャンク境界の処理を実装（オーバーラップ読み込み）
3. 進捗通知機能を追加
4. AbortSignal対応を追加
5. 大容量ファイル（10MB, 50MB）でパフォーマンステスト

---

## 4. 実行手順

### Phase構成

```
Phase 1: ストリーミングAPI設計（型定義）
Phase 2: チャンク処理実装（TDD Red）
Phase 3: テスト実装・成功（TDD Green）
Phase 4: 進捗通知・キャンセル機能追加
Phase 5: メモリ管理実装
Phase 6: パフォーマンステスト（10MB, 50MB）
Phase 7: ドキュメント更新
Phase 8: 品質ゲート確認
```

### Phase 1: ストリーミングAPI設計

#### Claude Code スラッシュコマンド

```
手動実装（型定義追加）
```

#### 目的

convertStream()メソッドのシグネチャとStreamOptions型を定義

#### 成果物

types.tsにStreamOptions, ProgressInfo型追加

#### 完了条件

- [ ] StreamOptions型定義完了
- [ ] ProgressInfo型定義完了
- [ ] TypeScriptエラー: 0

---

### Phase 2: チャンク処理実装

#### Claude Code スラッシュコマンド

```
/ai:generate-unit-tests
```

#### 目的

Node.js Stream APIを使用したチャンク単位のファイル読み込みと処理を実装

#### 成果物

conversion-service.tsにconvertStream()メソッド実装

#### 完了条件

- [ ] createReadStream()でファイル読み込み実装
- [ ] for await...ofでチャンク処理実装
- [ ] チャンク結合ロジック実装

---

### Phase 3: テスト実装・成功

#### 目的

ストリーミング機能の正常動作を検証

#### 成果物

streaming.test.ts（15テストケース）

#### 完了条件

- [ ] 小ファイル（<1MB）: 既存convertと結果一致
- [ ] 中ファイル（1-10MB）: チャンク処理の正確性
- [ ] 全15テストPASS

---

### Phase 4: 進捗通知・キャンセル機能追加

#### 目的

UX向上のための進捗表示とキャンセル機能を実装

#### 完了条件

- [ ] onProgressコールバック実装
- [ ] AbortSignal対応実装
- [ ] 進捗率計算（0-100%）実装

---

### Phase 5: メモリ管理実装

#### 目的

メモリ使用量を一定に保つ仕組みを実装

#### 完了条件

- [ ] チャンク処理後のGC促進実装
- [ ] メモリ監視ログ実装
- [ ] メモリ増加<100MBを確認

---

### Phase 6: パフォーマンステスト

#### 目的

大容量ファイルでの性能目標達成を検証

#### 完了条件

- [ ] 10MBファイル: <5秒達成
- [ ] 50MBファイル: <30秒達成
- [ ] メモリ使用量: 一定（<100MB増加）

---

### Phase 7: ドキュメント更新

#### Claude Code スラッシュコマンド

```
/ai:update-all-docs
```

#### 目的

API仕様とマニュアルを更新

#### 完了条件

- [ ] docs/30-api/conversion-service.md作成
- [ ] docs/40-manuals/rag-conversion-guide.md更新

---

### Phase 8: 品質ゲート確認

#### Claude Code スラッシュコマンド

```
/ai:lint --fix
```

#### 完了条件

- [ ] ESLint 0エラー
- [ ] TypeScript 0エラー
- [ ] 全テストPASS
- [ ] ビルド成功

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] convertStream()メソッド実装済み
- [ ] チャンクサイズ設定可能（デフォルト: 1MB）
- [ ] 進捗コールバック機能実装済み
- [ ] AbortSignal対応済み
- [ ] メモリ使用量が一定（チャンクサイズの3倍以内）
- [ ] 既存convert()メソッド変更なし（後方互換性）

### 品質要件

- [ ] 新規15テスト全てPASS
- [ ] 既存201テスト全てPASS
- [ ] テストカバレッジ100%維持
- [ ] ESLint/TypeScriptエラー: 0
- [ ] ビルド成功

### ドキュメント要件

- [ ] API仕様作成済み
- [ ] 使用例追加済み
- [ ] パフォーマンスガイド追加済み

---

## 6. 検証方法

### テストケース

**機能テスト（10ケース）**:

- 小ファイル（<1MB）: 既存convertと結果一致
- 中ファイル（1-10MB）: チャンク処理の正確性
- 大ファイル（10MB）: 5秒以内で完了
- 超大ファイル（50MB）: 30秒以内で完了
- 進捗コールバックが呼ばれる
- 進捗率が0→100まで変化
- AbortSignalでキャンセル可能
- キャンセル後のクリーンアップ
- 複数同時ストリーミング（5件）
- エラー発生時のリソース解放

**パフォーマンステスト（3ケース）**:

- 10MBファイル: <5秒
- 50MBファイル: <30秒
- メモリ使用量: <100MB増加

**後方互換性テスト（2ケース）**:

- 既存convert()は変更なし
- 既存201テスト全てPASS

### 検証手順

1. テストデータ生成（10MB, 50MB, 100MBファイル）
2. ストリーミングテスト実行: `pnpm test streaming.test.ts`
3. パフォーマンステスト実行: `pnpm tsx benchmark-large-files.ts`
4. メモリ使用量確認: process.memoryUsage()
5. 既存テスト実行: `pnpm test`

---

## 7. リスクと対策

| リスク                   | 影響度 | 発生確率 | 対策                                   |
| ------------------------ | ------ | -------- | -------------------------------------- |
| チャンク境界での構文分割 | 高     | 高       | オーバーラップ読み込み、行単位分割     |
| メモリリーク             | 高     | 中       | 明示的GC、メモリ監視ログ               |
| パフォーマンス目標未達   | 中     | 中       | Worker Threads検討、チャンクサイズ調整 |
| 後方互換性の破壊         | 高     | 低       | 既存API維持、テストで厳格チェック      |

---

## 8. 参照情報

### 関連ドキュメント

- [05-architecture.md](../../00-requirements/05-architecture.md) - 5.2A.7 技術的負債
- [02-non-functional-requirements.md](../../00-requirements/02-non-functional-requirements.md) - 1.4 パフォーマンス要件

### 参考資料

- [Node.js Stream API Documentation](https://nodejs.org/api/stream.html)
- [Node.js File System Streams](https://nodejs.org/api/fs.html#fs_fs_createreadstream_path_options)

---

## 9. 備考

### レビュー指摘の原文（該当する場合）

```
Phase 7 最終アーキテクチャレビュー - 技術的負債リスト

ID: CONV-DEBT-003
内容: 大容量ファイル対応（ストリーミング）
優先度: Low
見積工数: 12h
```

### 補足事項

- ストリーミング対応により、大容量ログファイルや大規模コードベースの一括インデックス化が可能になります
- チャンク境界での構文分割は、オーバーラップ読み込み（各チャンク末尾1KBを重複）で対処します
- メモリ使用量のモニタリングを実装し、閾値超過時は警告ログを出力します
