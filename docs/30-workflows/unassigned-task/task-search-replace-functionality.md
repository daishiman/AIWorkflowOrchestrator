# 検索・置換機能 - タスク指示書

## メタ情報

| 項目             | 内容                       |
| ---------------- | -------------------------- |
| タスクID         | TASK-SEARCH-REPLACE-001    |
| タスク名         | 検索・置換機能             |
| 分類             | 新規機能                   |
| 対象機能         | エディター・ワークスペース |
| 優先度           | 高                         |
| 見積もり規模     | 中規模                     |
| ステータス       | 未実施                     |
| 発見元           | ユーザー要望               |
| 発見日           | 2025-12-11                 |
| 発見エージェント | .claude/agents/product-manager.md           |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

テキストエディターの基本機能として、検索と置換は必須の機能である。現在、ファイル内での文字検索や置換ができず、外部エディターを使用する必要がある。また、ワークスペース全体での検索・置換も開発効率を大きく向上させる機能である。

### 1.2 問題点・課題

- ファイル内での文字検索ができない
- 文字列の置換ができない
- ワークスペース全体での検索ができない
- リファクタリング時に複数ファイルの一括置換ができない
- 外部ツールへの依存が必要

### 1.3 放置した場合の影響

- エディターとしての基本機能が欠落
- ユーザーの作業効率が大幅に低下
- 競合製品と比較して機能的に劣る
- 開発・編集作業が煩雑になる

---

## 2. 何を達成するか（What）

### 2.1 目的

ファイル内およびワークスペース全体での検索・置換機能を実装し、効率的なテキスト編集を可能にする。

### 2.2 最終ゴール

**ファイル内検索・置換**

- Ctrl+F で検索パネルを表示
- 検索結果のハイライト表示
- 次/前の検索結果への移動
- 単一置換・全置換
- 正規表現対応
- 大文字/小文字区別オプション
- 単語単位検索オプション

**ワークスペース検索・置換**

- Ctrl+Shift+F でワークスペース検索パネルを表示
- ファイルをまたいだ検索結果一覧
- 検索結果からファイルへのジャンプ
- ワークスペース全体での置換
- 除外パターン設定（node_modules等）
- ファイルタイプフィルタ

### 2.3 スコープ

#### 含むもの

**ファイル内検索**

- インクリメンタル検索
- 検索結果ハイライト
- 検索結果数表示
- 次/前への移動（F3/Shift+F3）
- 検索履歴

**ファイル内置換**

- 単一置換
- 全置換
- 置換プレビュー
- 正規表現キャプチャグループ対応

**ワークスペース検索**

- 全文検索
- ファイル名検索
- 検索結果のグルーピング（ファイル別）
- コンテキスト表示（前後の行）
- 検索結果の折りたたみ

**ワークスペース置換**

- 複数ファイル一括置換
- 置換前の確認ダイアログ
- 置換結果のプレビュー
- 元に戻す機能

#### 含まないもの

- セマンティック検索（RAG機能で対応）
- シンボル検索（Go to Definition等）
- 画像内テキストの検索
- バイナリファイル内の検索

### 2.4 成果物

- ファイル内検索UIコンポーネント
- ワークスペース検索UIコンポーネント
- 検索・置換ロジック
- 関連するユニットテスト・E2Eテスト
- キーボードショートカット設定
- 技術ドキュメント

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- プロジェクトの開発環境がセットアップ済み
- エディターコンポーネントが実装済み
- ファイルツリーコンポーネントが実装済み

### 3.2 依存タスク

- なし（独立したタスク）

### 3.3 必要な知識・スキル

- React/TypeScript
- テキスト検索アルゴリズム
- 正規表現
- Electron（ファイルシステムアクセス）
- UI/UXデザイン

### 3.4 推奨アプローチ

1. ファイル内検索から実装開始
2. 検索UIコンポーネントの設計
3. 検索ロジックの実装
4. 置換機能の追加
5. ワークスペース検索への拡張
6. パフォーマンス最適化

---

## 4. 実行手順

### Phase構成

```
Phase 0: 要件定義
Phase 1: 設計
  - T-01-1: ファイル内検索UI設計
  - T-01-2: ワークスペース検索UI設計
  - T-01-3: 検索エンジン設計
Phase 2: 設計レビューゲート
Phase 3: テスト作成（TDD: Red）
  - T-03-1: 検索ロジックのテスト
  - T-03-2: 検索UIのテスト
Phase 4: 実装（TDD: Green）
  - T-04-1: ファイル内検索実装
  - T-04-2: ファイル内置換実装
  - T-04-3: ワークスペース検索実装
  - T-04-4: ワークスペース置換実装
Phase 5: リファクタリング（TDD: Refactor）
Phase 6: 品質保証
Phase 7: 最終レビューゲート
Phase 8: 手動テスト検証
Phase 9: ドキュメント更新
```

### 主要な使用エージェント

- **.claude/agents/ui-designer.md**: 検索UI/UXの設計・実装
- **.claude/agents/logic-dev.md**: 検索・置換ロジックの実装
- **.claude/agents/unit-tester.md**: TDDでのテスト作成
- **.claude/agents/frontend-tester.md**: UIコンポーネントのテスト

---

## 5. 手動テストケース

| No  | カテゴリ     | テスト項目       | 操作手順                | 期待結果                         |
| --- | ------------ | ---------------- | ----------------------- | -------------------------------- |
| 1   | ファイル検索 | 基本検索         | Ctrl+F → 文字入力       | 該当箇所がハイライト             |
| 2   | ファイル検索 | 次の検索結果     | F3 または Enter         | 次の結果に移動                   |
| 3   | ファイル検索 | 大文字小文字区別 | オプション切り替え      | 区別された検索結果               |
| 4   | ファイル検索 | 正規表現検索     | 正規表現オプションON    | パターンマッチ                   |
| 5   | ファイル置換 | 単一置換         | 置換ボタンクリック      | 現在の選択が置換される           |
| 6   | ファイル置換 | 全置換           | すべて置換ボタン        | 全ての該当箇所が置換             |
| 7   | WS検索       | 基本検索         | Ctrl+Shift+F → 文字入力 | ファイル別に結果表示             |
| 8   | WS検索       | ファイルジャンプ | 検索結果をクリック      | 該当ファイル・行に移動           |
| 9   | WS検索       | 除外パターン     | node_modules除外設定    | 除外されたファイルは検索されない |
| 10  | WS置換       | 複数ファイル置換 | 置換実行                | 確認後、複数ファイルが置換       |

---

## 6. 完了条件チェックリスト

### 機能要件

**ファイル内検索・置換**

- [ ] Ctrl+F で検索パネルが表示される
- [ ] インクリメンタル検索が動作する
- [ ] 検索結果がハイライトされる
- [ ] 次/前の結果に移動できる
- [ ] 単一置換が動作する
- [ ] 全置換が動作する
- [ ] 正規表現検索が動作する
- [ ] 大文字/小文字区別オプションが動作する

**ワークスペース検索・置換**

- [ ] Ctrl+Shift+F でワークスペース検索が開く
- [ ] ファイルをまたいだ検索結果が表示される
- [ ] 検索結果からファイルにジャンプできる
- [ ] 除外パターンが設定できる
- [ ] ワークスペース全体の置換が動作する

### 品質要件

- [ ] 全テストがPASS
- [ ] Lintエラーなし
- [ ] 型エラーなし
- [ ] 大きなファイルでもパフォーマンスが許容範囲内

---

## 7. リスクと対策

| リスク                     | 影響度 | 発生確率 | 対策                           |
| -------------------------- | ------ | -------- | ------------------------------ |
| 大きなファイルでの遅延     | 高     | 中       | 仮想スクロール、非同期検索     |
| 多数ファイルでのWS検索遅延 | 中     | 高       | インデックス化、ストリーミング |
| 正規表現のReDoS攻撃        | 高     | 低       | タイムアウト設定、パターン検証 |
| 置換での予期せぬ変更       | 高     | 中       | プレビュー、アンドゥ機能       |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン

### 参考資料

- [VS Code Search](https://code.visualstudio.com/docs/editor/codebasics#_search-and-replace)
- [Monaco Editor Find Widget](https://microsoft.github.io/monaco-editor/)

---

## 9. 備考

### レビュー指摘の原文

```
編集しているファイル内での文字検索、置換などできるようにしてほしいです。
あとはこのワークスペース全体での文字の検索、置換もできるようにしてほしいです。
```

### 補足事項

- VS Codeのような使い勝手を目指す
- キーボードショートカットは標準的なものを採用
- 検索履歴の永続化も検討
