# OAuth認証エラー時のUX改善 - タスク指示書

## メタ情報

| 項目             | 内容                      |
| ---------------- | ------------------------- |
| タスクID         | UX-001                    |
| タスク名         | OAuth認証エラー時のUX改善 |
| 分類             | 改善                      |
| 対象機能         | OAuth認証（Desktop）      |
| 優先度           | 中                        |
| 見積もり規模     | 小規模                    |
| ステータス       | 未実施                    |
| 発見元           | ユーザー要望（Phase 9）   |
| 発見日           | 2025-12-22                |
| 発見エージェント | -                         |

---

## 1. なぜこのタスクが必要か（Why）

### 1.1 背景

現在のOAuth認証エラー時、ユーザーに表示されるエラーメッセージが不親切で、次のアクションが不明確です。

### 1.2 問題点・課題

**現在のエラー表示**:

- エラーメッセージが技術的すぎる（「OAuth initiation failed」等）
- エラー理由が不明確
- リトライ方法が提示されない
- エラーが発生したことすら気づかない場合がある

### 1.3 放置した場合の影響

| 影響領域     | 影響度 | 説明                               |
| ------------ | ------ | ---------------------------------- |
| ユーザー体験 | High   | ユーザーが問題を解決できない       |
| サポート負荷 | Medium | 同じ問題の問い合わせが増加         |
| 離脱率       | Medium | エラー時にアプリ使用を諦める可能性 |

---

## 2. 何を達成するか（What）

### 2.1 目的

OAuth認証エラー時に、ユーザーが理解しやすいエラーメッセージと、明確なアクションを提示する。

### 2.2 最終ゴール

- ✅ ユーザーフレンドリーなエラーメッセージ表示
- ✅ エラー理由の明確化（ネットワークエラー、認証拒否等）
- ✅ リトライボタン実装
- ✅ サポート情報へのリンク

### 2.3 スコープ

#### 含むもの

- エラーダイアログUI実装
- エラー種別の判定ロジック
- リトライボタン実装
- エラーメッセージの改善

#### 含まないもの

- エラーログの構造化（DEBT-CODE-001として別タスク）
- セッション自動リフレッシュ（UX-002として別タスク）

### 2.4 成果物

| 種別 | 成果物                    | 配置先                                                |
| ---- | ------------------------- | ----------------------------------------------------- |
| 実装 | ErrorDialogコンポーネント | `apps/desktop/src/renderer/components/ErrorDialog/`   |
| 実装 | authSlice修正             | `apps/desktop/src/renderer/store/slices/authSlice.ts` |
| 実装 | AuthView修正              | `apps/desktop/src/renderer/views/AuthView/`           |

---

## 3. どのように実行するか（How）

### 3.1 前提条件

- [ ] ログイン機能復旧プロジェクト（T-02-1〜T-09-1）が完了していること
- [ ] OAuth認証が正常に動作していること

### 3.2 依存タスク

**推奨（先に完了推奨）**:

- DEBT-CODE-002（エラーメッセージ一元管理）

**同時実施可能なタスク**:

- すべてのセキュリティ関連タスク
- DEBT-CODE-001（構造化ログ）

### 3.3 必要な知識・スキル

- React コンポーネント実装
- Zustand 状態管理
- UX/UIデザイン原則
- エラーハンドリングベストプラクティス

### 3.4 推奨アプローチ

1. **エラー種別の明確化**: ネットワークエラー、認証拒否、タイムアウト等を判別
2. **ユーザー向けメッセージ**: 技術用語を避け、平易な言葉で説明
3. **明確なアクション**: 「もう一度試す」ボタンを提示
4. **サポート情報**: 問題が解決しない場合のヘルプリンク

---

## 4. 実行手順

### Phase構成

```
Phase 1: エラー種別判定ロジック実装
  ↓
Phase 2: ErrorDialogコンポーネント実装
  ↓
Phase 3: リトライ機能実装
  ↓
Phase 4: テスト実行
```

---

### Phase 1: エラー種別判定ロジック実装

#### 目的

エラーオブジェクトからエラー種別を判定するロジックを実装する。

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
@logic-dev エラー種別判定ロジックを実装してください。

要件:
- エラー種別の定義（NETWORK_ERROR, AUTH_DENIED, TIMEOUT等）
- エラーオブジェクトから種別を判定
- 種別ごとにユーザー向けメッセージをマッピング

ファイル: apps/desktop/src/renderer/utils/errorClassifier.ts（新規）
```

#### 使用エージェント

- **エージェント**: .claude/agents/logic-dev.md
- **選定理由**: ビジネスロジック実装の専門家。エラー判定ロジックの実装に最適。
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名             | 活用方法             |
| -------------------- | -------------------- |
| .claude/skills/clean-code-practices/SKILL.md | 高品質なロジック実装 |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物              | パス                                                 | 内容                   |
| ------------------- | ---------------------------------------------------- | ---------------------- |
| errorClassifier実装 | `apps/desktop/src/renderer/utils/errorClassifier.ts` | エラー種別判定ロジック |

#### 完了条件

- [ ] errorClassifier.ts実装完了
- [ ] エラー種別定義完了
- [ ] ESLint/TypeScriptエラーなし

---

### Phase 2: ErrorDialogコンポーネント実装

#### 目的

ユーザーフレンドリーなエラーダイアログUIを実装する。

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
@ui-designer ErrorDialogコンポーネントを実装してください。

要件:
- エラー種別ごとに適切なアイコン・色表示
- ユーザー向けメッセージ表示
- リトライボタン
- ヘルプリンク

ファイル: apps/desktop/src/renderer/components/ErrorDialog/（新規）
```

#### 使用エージェント

- **エージェント**: .claude/agents/ui-designer.md
- **選定理由**: UIコンポーネント実装の専門家。
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名              | 活用方法                   |
| --------------------- | -------------------------- |
| .claude/skills/custom-hooks-patterns/SKILL.md | Reactカスタムフック実装    |
| .claude/skills/clean-code-practices/SKILL.md  | 高品質なコンポーネント実装 |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物                    | パス                                                | 内容               |
| ------------------------- | --------------------------------------------------- | ------------------ |
| ErrorDialogコンポーネント | `apps/desktop/src/renderer/components/ErrorDialog/` | エラーダイアログUI |

#### 完了条件

- [ ] ErrorDialog実装完了
- [ ] エラー種別ごとの表示実装完了
- [ ] リトライボタン実装完了
- [ ] ESLint/TypeScriptエラーなし

---

### Phase 3: リトライ機能実装

#### 目的

リトライボタンクリック時に、同じプロバイダーで再度OAuth認証を試行する。

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
@logic-dev リトライ機能を実装してください。

要件:
- authSliceにretryLogin()アクション追加
- ErrorDialogからretryLogin()を呼び出し
- リトライ回数制限（3回まで）

ファイル:
- apps/desktop/src/renderer/store/slices/authSlice.ts（修正）
- apps/desktop/src/renderer/components/ErrorDialog/（修正）
```

#### 使用エージェント

- **エージェント**: .claude/agents/logic-dev.md
- **選定理由**: ビジネスロジック実装の専門家。
- **参照**: `.claude/agents/agent_list.md`

#### 活用スキル

| スキル名             | 活用方法             |
| -------------------- | -------------------- |
| .claude/skills/state-lifting/SKILL.md        | Zustand状態管理      |
| .claude/skills/clean-code-practices/SKILL.md | 高品質なロジック実装 |

- **参照**: `.claude/skills/skill_list.md`

#### 成果物

| 成果物        | パス                                                  | 内容             |
| ------------- | ----------------------------------------------------- | ---------------- |
| authSlice修正 | `apps/desktop/src/renderer/store/slices/authSlice.ts` | retryLogin()実装 |

#### 完了条件

- [ ] retryLogin()実装完了
- [ ] リトライ回数制限実装完了
- [ ] ESLint/TypeScriptエラーなし

---

### Phase 4: テスト実行

#### 目的

エラーダイアログとリトライ機能が正しく動作することを確認する。

#### テストケース

| No  | カテゴリ | テスト項目             | 操作手順                 | 期待結果             |
| --- | -------- | ---------------------- | ------------------------ | -------------------- |
| 1   | 正常系   | エラーダイアログ表示   | OAuth認証失敗させる      | エラーダイアログ表示 |
| 2   | 正常系   | リトライボタンクリック | リトライボタンをクリック | 再度OAuth認証開始    |
| 3   | 異常系   | リトライ回数上限       | 3回リトライ失敗          | リトライボタン無効化 |

#### 実行手順

1. `pnpm --filter @repo/desktop preview` でアプリを起動
2. 意図的にエラーを発生させる（ネットワーク切断等）
3. エラーダイアログが表示されることを確認
4. リトライボタンをクリックして動作確認

#### 完了条件

- [ ] 全3テストケースがPASS
- [ ] エラーダイアログが正しく表示される
- [ ] リトライ機能が正常に動作する

---

## 5. 完了条件チェックリスト

### 機能要件

- [ ] errorClassifier実装完了
- [ ] ErrorDialog実装完了
- [ ] リトライ機能実装完了

### 品質要件

- [ ] 全手動テスト成功（3テストケース）
- [ ] ESLint/TypeScriptエラーゼロ
- [ ] UI/UXレビュー通過

### ドキュメント要件

- [ ] 必要に応じてUI/UXガイドライン更新

---

## 6. 検証方法

### テストケース

#### 手動テスト

1. エラーダイアログ表示確認
2. リトライボタン動作確認
3. エラーメッセージの分かりやすさ確認

### 検証手順

```bash
# アプリ起動
pnpm --filter @repo/desktop preview

# エラー発生テスト
# 1. ネットワークを切断してログイン試行
# 2. エラーダイアログ表示確認
# 3. リトライボタンクリック確認
```

---

## 7. リスクと対策

| リスク                   | 影響度 | 発生確率 | 対策                         | 対応サブタスク |
| ------------------------ | ------ | -------- | ---------------------------- | -------------- |
| エラー種別判定の精度不足 | Medium | Medium   | 実際のエラーでテストして調整 | Phase 1        |
| リトライボタンの連打     | Low    | Medium   | リトライ中はボタンを無効化   | Phase 3        |

---

## 8. 参照情報

### 関連ドキュメント

- `docs/00-requirements/16-ui-ux-guidelines.md` - UI/UXガイドライン
- `apps/desktop/src/renderer/views/AuthView/` - 現在のログイン画面

### 参考資料

- [Error Message Guidelines](https://www.nngroup.com/articles/error-message-guidelines/)
- [UX Best Practices for Error States](https://uxdesign.cc/how-to-write-good-error-messages-858e4551cd4)

---

## 9. 備考

### 補足事項

- エラーメッセージは非技術的な言葉で記述
- エラー発生時の推奨アクションを明記
- 深刻なエラーの場合は、サポートへの連絡方法を提示
