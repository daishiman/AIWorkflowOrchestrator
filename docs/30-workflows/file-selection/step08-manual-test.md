# ファイル選択機能（CONV-01）手動テスト仕様書

## メタ情報

| 項目       | 内容                       |
| ---------- | -------------------------- |
| 機能名     | ファイル選択機能           |
| タスクID   | CONV-01                    |
| 作成日     | 2024-12-16                 |
| テスト環境 | macOS / Electron Desktop   |
| 前提条件   | アプリが正常に起動すること |

---

## テスト環境準備

### 1. 開発サーバー起動

```bash
eval "$(fnm env)" && fnm use 22
cd /Users/dm/dev/dev/個人開発/AIWorkflowOrchestrator/.worktrees/task-1765842949405-aa697d/apps/desktop
pnpm dev
```

### 2. テスト用ファイル準備

以下のテストファイルを任意のディレクトリに用意してください：

| ファイル名            | サイズ    | 用途                   |
| --------------------- | --------- | ---------------------- |
| test-document.txt     | 1KB程度   | テキストファイルテスト |
| test-image.png        | 100KB程度 | 画像ファイルテスト     |
| test-document.pdf     | 500KB程度 | PDFファイルテスト      |
| test-spreadsheet.xlsx | 100KB程度 | Excelファイルテスト    |
| large-file.zip        | 15MB以上  | サイズ制限テスト       |

---

## テストケース一覧

### カテゴリ1: FileSelectorコンポーネント表示

> **注意**: FileSelectorコンポーネントは現在どのビューにも配置されていないため、
> 開発者ツールのコンソールから直接APIをテストするか、
> 一時的にビューに配置して確認してください。

| No  | テスト項目             | 前提条件       | 操作手順                           | 期待結果                                 | 実行結果 | 備考 |
| --- | ---------------------- | -------------- | ---------------------------------- | ---------------------------------------- | -------- | ---- |
| 1-1 | ドロップゾーン表示     | アプリ起動済み | FileSelectorが配置された画面を開く | ドロップゾーンが表示される               | □        |      |
| 1-2 | ファイル選択ボタン表示 | 1-1完了        | 画面を確認                         | 「ファイルを選択」ボタンが表示される     | □        |      |
| 1-3 | フィルター選択表示     | 1-1完了        | 画面を確認                         | フィルタードロップダウンが表示される     | □        |      |
| 1-4 | data-testid属性確認    | 1-1完了        | 開発者ツールでDOM確認              | `data-testid="file-selector"` が存在する | □        |      |

---

### カテゴリ2: ファイル選択ダイアログ（IPC通信）

> **テスト方法**: 開発者ツール > Console で以下を実行

```javascript
// ファイル選択ダイアログを開く
await window.electronAPI.fileSelection.openDialog({
  filterCategory: "all",
  multiSelections: true,
});
```

| No  | テスト項目         | 前提条件       | 操作手順                                     | 期待結果                                                                | 実行結果 | 備考 |
| --- | ------------------ | -------------- | -------------------------------------------- | ----------------------------------------------------------------------- | -------- | ---- |
| 2-1 | ダイアログが開く   | アプリ起動済み | 上記コードを実行                             | ファイル選択ダイアログが表示される                                      | □        |      |
| 2-2 | 単一ファイル選択   | 2-1完了        | 1つのファイルを選択して「開く」              | `{ success: true, data: { canceled: false, filePaths: [...] } }` が返る | □        |      |
| 2-3 | 複数ファイル選択   | 2-1完了        | Cmd+クリックで複数ファイルを選択して「開く」 | 複数のファイルパスが配列で返る                                          | □        |      |
| 2-4 | キャンセル         | 2-1完了        | ダイアログで「キャンセル」をクリック         | `{ success: true, data: { canceled: true, filePaths: [] } }` が返る     | □        |      |
| 2-5 | フィルター: all    | アプリ起動済み | `filterCategory: 'all'` で実行               | すべてのファイルが選択可能                                              | □        |      |
| 2-6 | フィルター: office | アプリ起動済み | `filterCategory: 'office'` で実行            | docx, xlsx, pptx, pdf のみ選択可能                                      | □        |      |
| 2-7 | フィルター: text   | アプリ起動済み | `filterCategory: 'text'` で実行              | txt, md, json, csv のみ選択可能                                         | □        |      |
| 2-8 | フィルター: image  | アプリ起動済み | `filterCategory: 'image'` で実行             | png, jpg, gif, webp のみ選択可能                                        | □        |      |

---

### カテゴリ3: ファイルメタデータ取得

```javascript
// 単一ファイルのメタデータ取得
await window.electronAPI.fileSelection.getMetadata({
  filePath: "/path/to/your/test-file.txt",
});

// 複数ファイルのメタデータ取得
await window.electronAPI.fileSelection.getMultipleMetadata({
  filePaths: ["/path/to/file1.txt", "/path/to/file2.pdf"],
});
```

| No  | テスト項目                 | 前提条件             | 操作手順                             | 期待結果                                     | 実行結果 | 備考 |
| --- | -------------------------- | -------------------- | ------------------------------------ | -------------------------------------------- | -------- | ---- |
| 3-1 | 単一ファイルメタデータ取得 | テストファイル準備済 | `getMetadata` を実行                 | name, path, size, extension, isFile 等が返る | □        |      |
| 3-2 | 複数ファイルメタデータ取得 | テストファイル準備済 | `getMultipleMetadata` を実行         | files配列に各ファイルのメタデータが含まれる  | □        |      |
| 3-3 | 存在しないファイル         | なし                 | 存在しないパスで `getMetadata` 実行  | エラーレスポンスが返る                       | □        |      |
| 3-4 | ファイルサイズ確認         | テストファイル準備済 | 既知サイズのファイルでメタデータ取得 | sizeが正しいバイト数で返る                   | □        |      |

---

### カテゴリ4: パス検証

```javascript
// パス検証
await window.electronAPI.fileSelection.validatePath({
  filePath: "/path/to/test-file.txt",
});
```

| No  | テスト項目           | 前提条件             | 操作手順                       | 期待結果                                                      | 実行結果 | 備考 |
| --- | -------------------- | -------------------- | ------------------------------ | ------------------------------------------------------------- | -------- | ---- |
| 4-1 | 存在するファイル     | テストファイル準備済 | 存在するファイルパスで実行     | `{ exists: true, isFile: true, isDirectory: false }` が返る   | □        |      |
| 4-2 | 存在するディレクトリ | なし                 | 存在するディレクトリパスで実行 | `{ exists: true, isFile: false, isDirectory: true }` が返る   | □        |      |
| 4-3 | 存在しないパス       | なし                 | 存在しないパスで実行           | `{ exists: false, isFile: false, isDirectory: false }` が返る | □        |      |

---

### カテゴリ5: セキュリティ機能

#### 5.1 パストラバーサル防止（SEC-M3）

```javascript
// パストラバーサル攻撃のテスト
await window.electronAPI.fileSelection.getMetadata({
  filePath: "/Users/../../../etc/passwd",
});

await window.electronAPI.fileSelection.getMultipleMetadata({
  filePaths: ["/normal/path.txt", "/path/../../../etc/passwd"],
});
```

| No  | テスト項目                            | 前提条件       | 操作手順                             | 期待結果                                | 実行結果 | 備考 |
| --- | ------------------------------------- | -------------- | ------------------------------------ | --------------------------------------- | -------- | ---- |
| 5-1 | getMetadataでパストラバーサル         | アプリ起動済み | `..` を含むパスで実行                | エラーが返る（Path traversal detected） | □        |      |
| 5-2 | getMultipleMetadataでパストラバーサル | アプリ起動済み | 配列内に `..` を含むパスを含めて実行 | 該当パスのみエラー、他は正常処理        | □        |      |
| 5-3 | validatePathでパストラバーサル        | アプリ起動済み | `..` を含むパスで実行                | エラーが返る                            | □        |      |

#### 5.2 危険拡張子フィルター（SEC-M2）

| No  | テスト項目                   | 前提条件       | 操作手順                                     | 期待結果                            | 実行結果 | 備考 |
| --- | ---------------------------- | -------------- | -------------------------------------------- | ----------------------------------- | -------- | ---- |
| 5-4 | exe ファイルがフィルタされる | アプリ起動済み | ダイアログで .exe ファイルを選択しようとする | .exe ファイルが選択肢に表示されない | □        |      |
| 5-5 | bat ファイルがフィルタされる | アプリ起動済み | ダイアログで .bat ファイルを選択しようとする | .bat ファイルが選択肢に表示されない | □        |      |
| 5-6 | ps1 ファイルがフィルタされる | アプリ起動済み | ダイアログで .ps1 ファイルを選択しようとする | .ps1 ファイルが選択肢に表示されない | □        |      |

#### 5.3 レート制限（SEC-M4）

```javascript
// 連続リクエストテスト（開発者ツールで実行）
for (let i = 0; i < 15; i++) {
  console.log(
    `Request ${i + 1}:`,
    await window.electronAPI.fileSelection.openDialog({
      filterCategory: "all",
    }),
  );
}
```

| No  | テスト項目              | 前提条件       | 操作手順                 | 期待結果                     | 実行結果 | 備考 |
| --- | ----------------------- | -------------- | ------------------------ | ---------------------------- | -------- | ---- |
| 5-7 | 1秒間に10回以内は成功   | アプリ起動済み | 10回連続でopenDialog実行 | すべて成功                   | □        |      |
| 5-8 | 1秒間に11回目以降は制限 | アプリ起動済み | 15回連続でopenDialog実行 | 11回目以降でレート制限エラー | □        |      |
| 5-9 | 1秒後にリセット         | 5-8完了        | 1秒待機後に再度実行      | 正常に動作する               | □        |      |

---

### カテゴリ6: UIコンポーネント操作

> **注意**: FileSelectorがビューに配置されている場合のテスト

| No  | テスト項目                 | 前提条件         | 操作手順                                   | 期待結果                                 | 実行結果 | 備考 |
| --- | -------------------------- | ---------------- | ------------------------------------------ | ---------------------------------------- | -------- | ---- |
| 6-1 | ファイル選択ボタンクリック | FileSelector表示 | 「ファイルを選択」ボタンをクリック         | ファイル選択ダイアログが開く             | □        |      |
| 6-2 | ファイル選択後リスト表示   | 6-1完了          | ファイルを選択して「開く」                 | 選択ファイル一覧が表示される             | □        |      |
| 6-3 | ファイル削除ボタン         | 6-2完了          | ファイル横の×ボタンをクリック              | 該当ファイルがリストから削除される       | □        |      |
| 6-4 | 「すべてクリア」ボタン     | 6-2完了          | 「すべてクリア」ボタンをクリック           | すべてのファイルがリストから削除される   | □        |      |
| 6-5 | フィルター変更             | FileSelector表示 | フィルタードロップダウンで「オフィス」選択 | フィルターが変更される                   | □        |      |
| 6-6 | ローディング表示           | FileSelector表示 | ファイル選択中                             | ローディングスピナーが表示される         | □        |      |
| 6-7 | エラーメッセージ表示       | FileSelector表示 | エラーが発生した場合                       | エラーメッセージが赤いバナーで表示される | □        |      |
| 6-8 | エラーメッセージ閉じる     | 6-7完了          | エラーバナーの×ボタンをクリック            | エラーメッセージが消える                 | □        |      |

---

### カテゴリ7: ドラッグ&ドロップ

| No  | テスト項目           | 前提条件         | 操作手順                             | 期待結果                             | 実行結果 | 備考 |
| --- | -------------------- | ---------------- | ------------------------------------ | ------------------------------------ | -------- | ---- |
| 7-1 | ドラッグオーバー表示 | FileSelector表示 | ファイルをドロップゾーン上にドラッグ | ドロップゾーンがハイライトされる     | □        |      |
| 7-2 | 単一ファイルドロップ | 7-1の状態        | 1つのファイルをドロップ              | ファイルがリストに追加される         | □        |      |
| 7-3 | 複数ファイルドロップ | FileSelector表示 | 複数ファイルを同時にドロップ         | すべてのファイルがリストに追加される | □        |      |
| 7-4 | ドラッグリーブ       | 7-1の状態        | ファイルをドロップゾーン外に移動     | ハイライトが解除される               | □        |      |

---

### カテゴリ8: アクセシビリティ

| No  | テスト項目                   | 前提条件         | 操作手順                 | 期待結果                                                      | 実行結果 | 備考 |
| --- | ---------------------------- | ---------------- | ------------------------ | ------------------------------------------------------------- | -------- | ---- |
| 8-1 | キーボードでボタンフォーカス | FileSelector表示 | Tabキーでフォーカス移動  | 「ファイルを選択」ボタンにフォーカスが当たる                  | □        |      |
| 8-2 | Enterキーでボタン実行        | 8-1完了          | Enterキーを押す          | ファイル選択ダイアログが開く                                  | □        |      |
| 8-3 | aria-label属性               | FileSelector表示 | 開発者ツールでDOM確認    | ドロップゾーンに `aria-label="ファイルドロップゾーン"` がある | □        |      |
| 8-4 | aria-busy属性                | ローディング中   | 開発者ツールでDOM確認    | ドロップゾーンに `aria-busy="true"` がある                    | □        |      |
| 8-5 | スクリーンリーダー通知       | ファイル選択後   | スクリーンリーダーを使用 | 「X件のファイルが選択されています」と読み上げられる           | □        |      |

---

### カテゴリ9: エラーハンドリング

| No  | テスト項目        | 前提条件       | 操作手順                                      | 期待結果                                | 実行結果 | 備考 |
| --- | ----------------- | -------------- | --------------------------------------------- | --------------------------------------- | -------- | ---- |
| 9-1 | 空のfilePaths配列 | アプリ起動済み | `getMultipleMetadata({ filePaths: [] })` 実行 | バリデーションエラーが返る              | □        |      |
| 9-2 | 100件超のファイル | アプリ起動済み | 101件のパスで `getMultipleMetadata` 実行      | バリデーションエラーが返る（最大100件） | □        |      |
| 9-3 | 1000文字超のパス  | アプリ起動済み | 1001文字以上のパスで `getMetadata` 実行       | バリデーションエラーが返る              | □        |      |
| 9-4 | 空文字のパス      | アプリ起動済み | `getMetadata({ filePath: '' })` 実行          | バリデーションエラーが返る              | □        |      |

---

## テスト結果サマリー

| カテゴリ                  | 総数   | Pass | Fail | Skip |
| ------------------------- | ------ | ---- | ---- | ---- |
| 1. コンポーネント表示     | 4      |      |      |      |
| 2. ファイル選択ダイアログ | 8      |      |      |      |
| 3. メタデータ取得         | 4      |      |      |      |
| 4. パス検証               | 3      |      |      |      |
| 5. セキュリティ機能       | 9      |      |      |      |
| 6. UIコンポーネント操作   | 8      |      |      |      |
| 7. ドラッグ&ドロップ      | 4      |      |      |      |
| 8. アクセシビリティ       | 5      |      |      |      |
| 9. エラーハンドリング     | 4      |      |      |      |
| **合計**                  | **49** |      |      |      |

---

## 発見された問題

| No  | 発見日 | カテゴリ | テストNo | 問題内容 | 重要度 | ステータス |
| --- | ------ | -------- | -------- | -------- | ------ | ---------- |
|     |        |          |          |          |        |            |

---

## 備考

### 制限事項

1. **FileSelectorのビュー配置**: FileSelectorコンポーネントは現在どのビューにも配置されていないため、UIテスト（カテゴリ6, 7, 8の一部）は一時的にコンポーネントを配置するか、開発者ツールでのAPIテストで代替してください。

2. **危険拡張子テスト**: macOSでは .exe, .bat 等のファイルを作成してテストする必要があります。

3. **レート制限テスト**: テスト間で1秒以上待機してからテストを実行してください。

### 参考ドキュメント

- [コアインターフェース仕様 - FileSelection API](../../00-requirements/06-core-interfaces.md#69-fileselection-api)
- [セキュリティガイドライン - ファイル選択セキュリティ](../../00-requirements/17-security-guidelines.md#179-ファイル選択セキュリティ)
