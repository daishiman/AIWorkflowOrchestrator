# システムプロンプト設定機能 - 要件定義書

## メタ情報

| 項目           | 内容                    |
| -------------- | ----------------------- |
| ドキュメントID | REQ-CHAT-SYSPROMPT-001  |
| 作成日         | 2025-12-25              |
| ステータス     | ドラフト                |
| 関連タスク     | TASK-CHAT-SYSPROMPT-001 |

---

## 1. ユーザーからの元の要望

```
チャットの方でシステムプロンプトを入れれるようにしておいてほしいです。
```

---

## 2. 背景と目的

### 2.1 背景

LLMとのチャットにおいて、システムプロンプトはAIの振る舞いや専門性を定義する重要な要素である。現状の Knowledge Studio チャット機能では、システムプロンプトをユーザーがカスタマイズする手段がなく、以下の課題がある：

1. **柔軟性の欠如**: 用途に応じたAIの振る舞い調整ができない
2. **プロンプトエンジニアリングの制限**: 高度なプロンプト技術を活用できない
3. **再利用性の問題**: 有効なプロンプトを保存・再利用できない

### 2.2 目的

チャット機能にシステムプロンプト設定UIを実装し、ユーザーがAIの振る舞いをカスタマイズできるようにする。これにより、特定の用途（翻訳、プログラミング支援、ライティング支援等）に最適化されたAIアシスタントを構築可能にする。

---

## 3. ユーザーストーリー

### US-001: システムプロンプトの入力・編集

```
As a ユーザー
I want to チャット画面でシステムプロンプトを入力・編集できる
So that AIの振る舞いを自分の用途に合わせてカスタマイズできる
```

**受け入れ基準**:

- [ ] システムプロンプト入力エリアがチャット画面に表示される
- [ ] Markdown形式でシステムプロンプトを記述できる
- [ ] システムプロンプトを空にした場合、デフォルトの振る舞いになる

### US-002: システムプロンプトの適用

```
As a ユーザー
I want to 設定したシステムプロンプトがLLMに適用される
So that AIが私の指定した役割・制約に従って回答する
```

**受け入れ基準**:

- [ ] メッセージ送信時にシステムプロンプトがLLMに送信される
- [ ] AIの回答がシステムプロンプトの指示に従っている
- [ ] システムプロンプト変更後の次のメッセージから新しいプロンプトが適用される

### US-003: プロンプトテンプレートの保存

```
As a ユーザー
I want to 作成したシステムプロンプトをテンプレートとして保存できる
So that 有効なプロンプトを再利用できる
```

**受け入れ基準**:

- [ ] 現在のシステムプロンプトをテンプレートとして保存できる
- [ ] テンプレートに名前を付けて管理できる
- [ ] 保存したテンプレートがアプリ再起動後も保持される

### US-004: プロンプトテンプレートの読み込み

```
As a ユーザー
I want to 保存したテンプレートを読み込んでシステムプロンプトに適用できる
So that よく使うプロンプトを素早く設定できる
```

**受け入れ基準**:

- [ ] テンプレート一覧から選択して読み込める
- [ ] プリセットテンプレート（翻訳、プログラミング支援等）が用意されている
- [ ] テンプレート読み込み時に確認なしで現在のプロンプトが上書きされる

### US-005: LLM切り替え時のシステムプロンプト維持

```
As a ユーザー
I want to LLMプロバイダー/モデルを切り替えてもシステムプロンプトが維持される
So that モデル切り替え時に再設定の手間がない
```

**受け入れ基準**:

- [ ] LLMプロバイダー切り替え後もシステムプロンプトが保持される
- [ ] モデル切り替え後もシステムプロンプトが保持される
- [ ] セッション間でシステムプロンプトが維持される

---

## 4. 機能要件

### 4.1 システムプロンプト入力・編集機能

| ID     | 要件                                                      | 優先度 |
| ------ | --------------------------------------------------------- | ------ |
| FR-001 | システムプロンプト入力用のテキストエリアを提供する        | 必須   |
| FR-002 | Markdown形式でのプロンプト記述をサポートする              | 必須   |
| FR-003 | システムプロンプトの文字数制限（上限: 4000文字）を設ける  | 必須   |
| FR-004 | 入力中のリアルタイム文字数カウントを表示する              | 推奨   |
| FR-005 | システムプロンプト入力エリアの表示/非表示を切り替えられる | 必須   |

### 4.2 テンプレート管理機能

| ID     | 要件                                             | 優先度 |
| ------ | ------------------------------------------------ | ------ |
| FR-006 | システムプロンプトをテンプレートとして保存できる | 必須   |
| FR-007 | テンプレートに名前（最大50文字）を付けられる     | 必須   |
| FR-008 | 保存済みテンプレートを一覧表示できる             | 必須   |
| FR-009 | テンプレートを選択して読み込める                 | 必須   |
| FR-010 | テンプレートを削除できる                         | 必須   |
| FR-011 | プリセットテンプレートを提供する（最低3種類）    | 必須   |
| FR-012 | テンプレートをエクスポート/インポートできる      | 将来   |

### 4.3 状態管理機能

| ID     | 要件                                                           | 優先度 |
| ------ | -------------------------------------------------------------- | ------ |
| FR-013 | チャットセッションごとにシステムプロンプトを管理する           | 必須   |
| FR-014 | LLMプロバイダー/モデル切り替え時もシステムプロンプトを維持する | 必須   |
| FR-015 | アプリ再起動時に最後に使用したシステムプロンプトを復元する     | 推奨   |

### 4.4 LLM連携機能

| ID     | 要件                                                        | 優先度 |
| ------ | ----------------------------------------------------------- | ------ |
| FR-016 | チャットメッセージ送信時にシステムプロンプトをLLMに送信する | 必須   |
| FR-017 | 各LLMプロバイダーのシステムプロンプト形式に対応する         | 必須   |

---

## 5. 非機能要件

### 5.1 パフォーマンス要件

| ID      | 要件                                 | 基準値    |
| ------- | ------------------------------------ | --------- |
| NFR-001 | システムプロンプト保存時のレスポンス | 100ms以内 |
| NFR-002 | テンプレート一覧読み込み時間         | 200ms以内 |
| NFR-003 | テンプレート読み込み（適用）時間     | 50ms以内  |

### 5.2 UX要件

| ID      | 要件                                                                   |
| ------- | ---------------------------------------------------------------------- |
| NFR-004 | システムプロンプト入力エリアはチャット画面から簡単にアクセスできること |
| NFR-005 | 入力中の操作を妨げない配置であること                                   |
| NFR-006 | 視覚的フィードバック（保存成功、エラー等）を提供すること               |
| NFR-007 | キーボードショートカットでの操作をサポートすること（将来）             |

### 5.3 データ永続性要件

| ID      | 要件                                                         |
| ------- | ------------------------------------------------------------ |
| NFR-008 | テンプレートはローカルストレージ（electron-store）に保存する |
| NFR-009 | データフォーマットはJSON形式とする                           |
| NFR-010 | データ破損時のフォールバック（デフォルト値復元）を実装する   |

### 5.4 セキュリティ要件

| ID      | 要件                                                                  |
| ------- | --------------------------------------------------------------------- |
| NFR-011 | システムプロンプトに機密情報（APIキー等）を含めないよう警告を表示する |
| NFR-012 | テンプレートデータは平文で保存（暗号化不要、機密性低）                |

---

## 6. スコープ定義

### 6.1 スコープ内（含むもの）

- システムプロンプト入力テキストエリア
- プロンプトテンプレートのプリセット（翻訳、プログラミング支援、ライティング支援）
- カスタムテンプレートの保存・読み込み・削除
- チャットセッションへのシステムプロンプト関連付け
- Markdown形式でのプロンプト記述
- LLMへのシステムプロンプト送信

### 6.2 スコープ外（含まないもの）

| 機能                             | 理由               | 将来実装予定   |
| -------------------------------- | ------------------ | -------------- |
| プロンプトの自動生成             | 機能複雑度が高い   | 検討中         |
| プロンプトの品質評価             | AI機能が必要       | 検討中         |
| 外部プロンプトライブラリとの連携 | 外部依存が増える   | 検討中         |
| チーム間でのテンプレート共有     | クラウド同期が必要 | 将来バージョン |
| バージョン履歴管理               | 機能複雑度が高い   | 将来バージョン |

---

## 7. UI仕様概要

### 7.1 システムプロンプト入力エリアの配置

```
+------------------------------------------+
|  チャットヘッダー                        |
+------------------------------------------+
|  [システムプロンプト設定] ボタン         |
+------------------------------------------+
|  システムプロンプト入力エリア（展開時）  |
|  +--------------------------------------+|
|  | [テンプレート選択 ▼] [保存] [クリア] ||
|  +--------------------------------------+|
|  | テキストエリア                       ||
|  | （Markdown対応、4000文字制限）       ||
|  |                                      ||
|  | 文字数: 0 / 4000                     ||
|  +--------------------------------------+|
+------------------------------------------+
|  チャットメッセージ一覧                  |
|  ...                                     |
+------------------------------------------+
|  メッセージ入力エリア                    |
+------------------------------------------+
```

### 7.2 テンプレート選択ドロップダウン

```
+----------------------------+
| テンプレートを選択         |
+----------------------------+
| --- プリセット ---         |
| 翻訳アシスタント           |
| プログラミング支援         |
| ライティング支援           |
+----------------------------+
| --- カスタム ---           |
| マイテンプレート1          |
| マイテンプレート2          |
+----------------------------+
| [+ 現在のプロンプトを保存] |
+----------------------------+
```

---

## 8. データ構造

### 8.1 システムプロンプト型

```typescript
interface SystemPrompt {
  content: string; // プロンプト本文（最大4000文字）
  updatedAt: Date; // 最終更新日時
}
```

### 8.2 テンプレート型

```typescript
interface PromptTemplate {
  id: string; // ユニークID（UUID v4）
  name: string; // テンプレート名（最大50文字）
  content: string; // プロンプト本文（最大4000文字）
  isPreset: boolean; // プリセットフラグ
  createdAt: Date; // 作成日時
  updatedAt: Date; // 最終更新日時
}
```

### 8.3 ストレージ構造

```json
{
  "systemPrompt": {
    "current": {
      "content": "...",
      "updatedAt": "2025-12-25T00:00:00.000Z"
    }
  },
  "promptTemplates": {
    "presets": [
      {
        "id": "preset-translator",
        "name": "翻訳アシスタント",
        "content": "あなたは翻訳アシスタントです...",
        "isPreset": true,
        "createdAt": "2025-01-01T00:00:00.000Z",
        "updatedAt": "2025-01-01T00:00:00.000Z"
      }
    ],
    "custom": []
  }
}
```

---

## 9. プリセットテンプレート

### 9.1 翻訳アシスタント

```markdown
あなたは多言語翻訳アシスタントです。

## 役割

- ユーザーから提供されたテキストを指定された言語に翻訳する
- 自然で読みやすい翻訳を心がける

## 制約

- 翻訳以外の質問には「翻訳リクエストをお待ちしています」と回答する
- 翻訳元言語と翻訳先言語を明示する

## 出力形式

**翻訳元（{言語}）**: {原文}
**翻訳先（{言語}）**: {翻訳文}
```

### 9.2 プログラミング支援

```markdown
あなたはプログラミング支援アシスタントです。

## 役割

- コードの説明、デバッグ支援、リファクタリング提案を行う
- ベストプラクティスに基づいたアドバイスを提供する

## 制約

- コード例を提示する際は、適切なコメントを付与する
- セキュリティリスクのある実装は警告する

## 出力形式

- コードブロックにはシンタックスハイライト用の言語指定を付ける
- 長いコードは分割して説明する
```

### 9.3 ライティング支援

```markdown
あなたはライティング支援アシスタントです。

## 役割

- 文章の校正、推敲、改善提案を行う
- 文体やトーンに関するアドバイスを提供する

## 制約

- 原文の意図を尊重する
- 過度な修正は避け、必要最小限の提案に留める

## 出力形式

- 修正箇所は明確に示す
- 修正理由を簡潔に説明する
```

---

## 10. 既存システムとの整合性

### 10.1 影響を受けるコンポーネント

| コンポーネント | ファイルパス                                          | 変更内容                         |
| -------------- | ----------------------------------------------------- | -------------------------------- |
| ChatSlice      | `apps/desktop/src/renderer/store/slices/chatSlice.ts` | systemPrompt状態の追加           |
| ChatView       | `apps/desktop/src/components/chat/`                   | システムプロンプト入力UIの追加   |
| LLM連携        | `apps/desktop/src/features/chat/`                     | システムプロンプト送信処理の追加 |

### 10.2 既存のChatSlice構造

```typescript
// 現状の構造
interface ChatSlice {
  chatMessages: ChatMessage[];
  chatInput: string;
  isSending: boolean;
  ragConnectionStatus: RagConnectionStatus;
  // ... actions
}

// 追加が必要な状態
interface ChatSlice {
  // ... existing
  systemPrompt: string; // 新規追加
  // ... actions
  setSystemPrompt: (prompt: string) => void; // 新規追加
}
```

---

## 11. 受け入れ基準チェックリスト

### 機能要件

- [ ] システムプロンプトを入力・編集できる
- [ ] プロンプトテンプレートを保存できる（名前付き）
- [ ] プロンプトテンプレートを読み込める
- [ ] プロンプトテンプレートを削除できる
- [ ] プリセットテンプレート（3種類以上）が利用できる
- [ ] チャットセッションにシステムプロンプトが適用される
- [ ] LLMの回答がシステムプロンプトに従っている
- [ ] LLM切り替え時もシステムプロンプトが維持される

### 非機能要件

- [ ] システムプロンプト保存が100ms以内に完了する
- [ ] テンプレート一覧読み込みが200ms以内に完了する
- [ ] アプリ再起動後もテンプレートデータが保持される
- [ ] UIが既存のチャット画面と統一感がある

---

## 12. リスクと対策

| リスク                                              | 影響度 | 対策                               |
| --------------------------------------------------- | ------ | ---------------------------------- |
| システムプロンプトが長すぎてLLMのコンテキストを圧迫 | 中     | 文字数制限（4000文字）を設定       |
| プロンプトインジェクション攻撃                      | 低     | ローカルアプリのため影響限定的     |
| テンプレートデータの破損                            | 中     | デフォルト値へのフォールバック実装 |
| LLMプロバイダー間でのプロンプト形式の差異           | 低     | 各プロバイダー用のアダプターを実装 |

---

## 13. 次のアクション

1. **Phase 1: 設計** - UI設計、状態管理設計、テンプレート管理設計を実施
2. **設計完了後** - 設計レビューゲート（Phase 2）で妥当性を検証
3. **実装開始** - TDD（テスト先行）で実装を進める

---

## 更新履歴

| 日付       | 版  | 変更内容 | 作成者 |
| ---------- | --- | -------- | ------ |
| 2025-12-25 | 1.0 | 初版作成 | Claude |
