# チャット用システムプロンプト設定機能 - タスク実行仕様書

## ユーザーからの元の指示

```
チャットの方でシステムプロンプトを入れれるようにしておいてほしいです。
```

## メタ情報

| 項目         | 内容                                 |
| ------------ | ------------------------------------ |
| タスクID     | TASK-CHAT-SYSPROMPT-001              |
| Worktreeパス | `.worktrees/task-{{timestamp}}`      |
| ブランチ名   | `task-{{timestamp}}`                 |
| タスク名     | チャット用システムプロンプト設定機能 |
| 分類         | 新規機能                             |
| 対象機能     | チャット                             |
| 優先度       | 高                                   |
| 見積もり規模 | 小規模                               |
| ステータス   | 未実施                               |
| 作成日       | 2025-12-25                           |

---

## タスク概要

### 目的

チャット機能にシステムプロンプトを設定できるUIを実装し、ユーザーがAIの振る舞いをカスタマイズできるようにする。これにより、特定の用途に最適化されたAIアシスタントを構築可能にする。

### 背景

LLMとのチャットにおいて、システムプロンプトはAIの振る舞いや専門性を定義する重要な要素である。現状ではシステムプロンプトをカスタマイズできないため、用途に応じたAIの振る舞い調整ができず、プロンプトエンジニアリングの柔軟性が低い状態にある。

### 最終ゴール

- ユーザーがチャット画面からシステムプロンプトを入力・編集できる
- プロンプトテンプレートを保存・読み込みできる
- チャットセッションごとにシステムプロンプトが管理される
- LLM切り替え時もシステムプロンプトが維持される

### 成果物一覧

| 種別         | 成果物                         | 配置先                                  |
| ------------ | ------------------------------ | --------------------------------------- |
| 環境         | Git Worktree環境               | `.worktrees/task-{{timestamp}}`         |
| 機能         | システムプロンプト設定UI       | `apps/desktop/src/components/chat/`     |
| 機能         | プロンプトテンプレート管理機能 | `apps/desktop/src/features/chat/`       |
| 機能         | システムプロンプト状態管理     | `apps/desktop/src/stores/chat/`         |
| テスト       | ユニットテスト                 | `apps/desktop/src/**/*.test.ts`         |
| ドキュメント | 要件ドキュメント               | `docs/30-workflows/chat-system-prompt/` |
| ドキュメント | 設計ドキュメント               | `docs/30-workflows/chat-system-prompt/` |
| ドキュメント | 手動テストレポート             | `docs/30-workflows/chat-system-prompt/` |
| PR           | GitHub Pull Request            | GitHub UI                               |

---

## 参照ファイル

本仕様書のコマンド選定は以下を参照：

- `docs/00-requirements/master_system_design.md` - システム要件
- `.claude/commands/ai/command_list.md` - /ai:コマンド定義
- `.kamui/prompt/merge-prompt.txt` - Git/PRワークフロー

---

## タスク分解サマリー

| ID     | フェーズ | サブタスク名                 | 責務                                     | 依存                           |
| ------ | -------- | ---------------------------- | ---------------------------------------- | ------------------------------ |
| T--1-1 | Phase -1 | Git Worktree環境作成・初期化 | Git Worktree環境の作成と初期化           | なし                           |
| T-00-1 | Phase 0  | 機能要件定義                 | システムプロンプト設定機能の要件を明文化 | T--1-1                         |
| T-01-1 | Phase 1  | UI設計                       | システムプロンプト入力UIの設計           | T-00-1                         |
| T-01-2 | Phase 1  | 状態管理設計                 | プロンプト状態管理の設計                 | T-00-1                         |
| T-01-3 | Phase 1  | テンプレート管理設計         | プロンプトテンプレート管理の設計         | T-00-1                         |
| T-02-1 | Phase 2  | 設計レビュー                 | 要件・設計の妥当性検証                   | T-01-1, T-01-2, T-01-3         |
| T-03-1 | Phase 3  | UI コンポーネントテスト作成  | システムプロンプト入力UIのテスト作成     | T-02-1                         |
| T-03-2 | Phase 3  | 状態管理テスト作成           | プロンプト状態管理のテスト作成           | T-02-1                         |
| T-03-3 | Phase 3  | テンプレート管理テスト作成   | テンプレート管理機能のテスト作成         | T-02-1                         |
| T-04-1 | Phase 4  | UI コンポーネント実装        | システムプロンプト入力UIの実装           | T-03-1                         |
| T-04-2 | Phase 4  | 状態管理実装                 | プロンプト状態管理の実装                 | T-03-2                         |
| T-04-3 | Phase 4  | テンプレート管理実装         | テンプレート管理機能の実装               | T-03-3                         |
| T-04-4 | Phase 4  | LLM連携実装                  | LLMへのシステムプロンプト送信実装        | T-04-2                         |
| T-05-1 | Phase 5  | コードリファクタリング       | コード品質の改善                         | T-04-1, T-04-2, T-04-3, T-04-4 |
| T-06-1 | Phase 6  | 品質保証                     | テスト実行・品質チェック                 | T-05-1                         |
| T-07-1 | Phase 7  | 最終レビュー                 | 全体的な品質・整合性検証                 | T-06-1                         |
| T-08-1 | Phase 8  | 手動テスト検証               | UI/UX・実環境動作の手動確認              | T-07-1                         |
| T-09-1 | Phase 9  | ドキュメント更新             | master_system_design.md等の更新          | T-08-1                         |
| T-09-2 | Phase 9  | 未完了タスク記録             | 追加タスクの記録                         | T-08-1                         |
| T-10-1 | Phase 10 | コミット作成                 | 差分確認・コミット作成                   | T-09-1, T-09-2                 |
| T-10-2 | Phase 10 | PR作成                       | PR作成・CI確認                           | T-10-1                         |

**総サブタスク数**: 22個

---

## 実行フロー図

```mermaid
graph TD
    START[タスク開始] --> T--1[Phase -1: 環境準備]
    T--1 --> T-00[Phase 0: 要件定義]
    T-00 --> T-01[Phase 1: 設計]
    T-01 --> T-02[Phase 2: 設計レビューゲート]
    T-02 --> T-03[Phase 3: テスト作成]
    T-03 --> T-04[Phase 4: 実装]
    T-04 --> T-05[Phase 5: リファクタリング]
    T-05 --> T-06[Phase 6: 品質保証]
    T-06 --> T-07[Phase 7: 最終レビューゲート]
    T-07 --> T-08[Phase 8: 手動テスト]
    T-08 --> T-09[Phase 9: ドキュメント更新]
    T-09 --> T-10[Phase 10: PR作成・CI確認]
    T-10 --> END[マージ準備完了]

    T-02 -->|MAJOR| T-01
    T-02 -->|MAJOR: 要件| T-00
    T-07 -->|MAJOR| T-05
    T-07 -->|MAJOR: 実装| T-04
    T-07 -->|MAJOR: テスト| T-03
    T-07 -->|MAJOR: 設計| T-01
    T-07 -->|CRITICAL| T-00
```

---

## Phase -1: 環境準備（Git Worktree作成）

### T--1-1: Git Worktree環境作成・初期化

#### 目的

タスク実装用の独立したGit Worktree環境を作成し、本体ブランチに影響を与えずに開発を進める。

#### 背景

複数タスクの並行開発や実験的な変更のため、各タスクごとに独立したWorktreeで作業を行う必要がある。
これにより、本体ブランチを保護し、タスク間の干渉を防ぐ。

#### 責務（単一責務）

Git Worktree環境の作成と初期化のみを担当する。

#### Claude Code スラッシュコマンド（該当する場合）

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
# 現時点では専用のスラッシュコマンドは存在しません
# 以下のBashコマンドを使用してください
```

- **参照**: `.claude/commands/ai/command_list.md`

#### 実行手順

**1. タスク識別子の生成**

```bash
TASK_ID="task-$(date +%Y%m%d-%H%M%S)"
echo "Generated Task ID: $TASK_ID"
```

**2. Git Worktreeの作成**

```bash
WORKTREE_PATH=".worktrees/$TASK_ID"
git worktree add "$WORKTREE_PATH" -b "$TASK_ID"
```

**3. Worktreeディレクトリへ移動**

```bash
cd "$WORKTREE_PATH"
pwd  # 現在のディレクトリを確認
```

**4. 環境確認**

```bash
# ブランチ確認
git branch --show-current

# Git状態確認
git status

# 依存関係インストール（必要に応じて）
pnpm install

# ビルド確認
pnpm --filter @repo/desktop build
```

#### 成果物

| 成果物           | パス                            | 内容                             |
| ---------------- | ------------------------------- | -------------------------------- |
| Git Worktree環境 | `.worktrees/task-{{timestamp}}` | 独立した作業ディレクトリ         |
| 新規ブランチ     | `task-{{timestamp}}`            | タスク専用ブランチ               |
| 初期化済み環境   | -                               | 依存関係インストール・ビルド完了 |

#### 完了条件

- [ ] Git Worktreeが正常に作成されている
- [ ] 新規ブランチが作成されている（`git branch --show-current`で確認）
- [ ] Worktreeディレクトリへ移動済み
- [ ] 依存関係がインストールされている（`node_modules/`が存在）
- [ ] ビルドが成功する（`pnpm --filter @repo/desktop build`が成功）
- [ ] Git状態がクリーンである（`git status`で未コミット変更なし）

#### 依存関係

- **前提**: なし（最初のフェーズ）
- **後続**: Phase 0（要件定義）

#### トラブルシューティング

**問題: Worktree作成失敗**

```bash
# 原因確認
git worktree list  # 既存Worktree確認

# 対策: 既存のWorktreeを削除
git worktree remove <worktree-path>
```

**問題: ビルド失敗**

```bash
# 原因確認
pnpm why <package-name>  # 依存関係確認

# 対策: 依存関係再インストール
rm -rf node_modules pnpm-lock.yaml
pnpm install
```

---

## Phase 0: 要件定義

### T-00-1: 機能要件定義

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください
> タスクに最適なコマンドを

```
/ai:gather-requirements

```

- **選定方法**: コマンドリストの「トリガーキーワード」と「目的」を参照し、タスクに最も適したコマンドを選択
- **注**: 要件定義には `/ai:gather-requirements` または `/ai:write-spec` を使用

#### 目的

システムプロンプト設定機能の要件を明文化し、実装すべき機能の範囲と受け入れ基準を明確にする。

#### 背景

ユーザーからの要望は「システムプロンプトを入れれるようにする」という抽象的な表現であり、具体的な機能仕様・UI仕様・振る舞いを詳細化する必要がある。

#### 責務（単一責務）

システムプロンプト設定機能に関する要件の定義と明文化のみを担当する。

#### 成果物

| 成果物     | パス                                                               | 内容                               |
| ---------- | ------------------------------------------------------------------ | ---------------------------------- |
| 要件定義書 | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md` | 機能要件・非機能要件・受け入れ基準 |

#### 完了条件

- [ ] 機能要件が具体的に定義されている
- [ ] 非機能要件（パフォーマンス、UX等）が定義されている
- [ ] UI仕様の概要が記載されている
- [ ] スコープ（含む/含まない）が明記されている
- [ ] 受け入れ基準が検証可能な形で定義されている
- [ ] ユーザーストーリーが記載されている

#### 依存関係

- **前提**: T--1-1（Git Worktree環境作成）
- **後続**: Phase 1（設計）

---

## Phase 1: 設計

### T-01-1: UI設計

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```

/ai:create-component

```

- **選定方法**: `.claude/commands/ai/command_list.md` から UI 設計関連コマンドを選定
- **注**: UI設計には `/ai:create-component` を使用（設計フェーズでコンポーネント構造を定義）

#### 目的

システムプロンプト入力UIの構造・配置・インタラクションを設計する。

#### 背景

チャット画面にシステムプロンプト設定UIを追加する必要があり、既存のチャットUIとの整合性を保ちながら、使いやすいインターフェースを設計する必要がある。

#### 責務（単一責務）

UI/UXの設計のみを担当する（状態管理やビジネスロジックは含まない）。

#### 参照資料

| 参照資料   | パス                                                               | 内容     |
| ---------- | ------------------------------------------------------------------ | -------- |
| 要件定義書 | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md` | 機能要件 |

#### 成果物

| 成果物   | パス                                                            | 内容                                                 |
| -------- | --------------------------------------------------------------- | ---------------------------------------------------- |
| UI設計書 | `docs/30-workflows/chat-system-prompt/task-step01-ui-design.md` | コンポーネント構造・レイアウト・インタラクション設計 |

#### 完了条件

- [ ] コンポーネント構造が定義されている
- [ ] レイアウト（配置・サイズ）が明確である
- [ ] ユーザーインタラクションフローが設計されている
- [ ] 既存UIとの整合性が考慮されている
- [ ] アクセシビリティが考慮されている

#### 依存関係

- **前提**: T-00-1（機能要件定義）
- **後続**: T-02-1（設計レビュー）

---

### T-01-2: 状態管理設計

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```

/ai:setup-state-management

```

- **選定方法**: `.claude/commands/ai/command_list.md` から状態管理設計関連コマンドを選定

#### 目的

システムプロンプトの状態管理（Zustand store）の設計を行う。

#### 背景

システムプロンプトはチャットセッションごとに管理され、LLM切り替え時も維持される必要があるため、適切な状態管理設計が必要である。

#### 責務（単一責務）

状態管理の設計のみを担当する（UI実装やテンプレート管理は含まない）。

#### 参照資料

| 参照資料   | パス                                                               | 内容     |
| ---------- | ------------------------------------------------------------------ | -------- |
| 要件定義書 | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md` | 機能要件 |

#### 成果物

| 成果物         | パス                                                               | 内容                |
| -------------- | ------------------------------------------------------------------ | ------------------- |
| 状態管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-state-design.md` | Zustand storeの設計 |

#### 完了条件

- [ ] Zustand storeの構造が定義されている
- [ ] 状態とアクションが明確である
- [ ] セッションごとの状態管理方針が明確である
- [ ] LLM切り替え時の状態維持方法が設計されている
- [ ] 既存のチャット状態管理との整合性が考慮されている

#### 依存関係

- **前提**: T-00-1（機能要件定義）
- **後続**: T-02-1（設計レビュー）

---

### T-01-3: テンプレート管理設計

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```

/ai:design-domain-model

```

- **選定方法**: `.claude/commands/ai/command_list.md` からデータモデル設計関連コマンドを選定

#### 目的

プロンプトテンプレートの保存・読み込み機能の設計を行う。

#### 背景

ユーザーがカスタムプロンプトを再利用できるよう、テンプレートとして保存・読み込みできる仕組みが必要である。

#### 責務（単一責務）

テンプレート管理機能の設計のみを担当する。

#### 参照資料

| 参照資料   | パス                                                               | 内容     |
| ---------- | ------------------------------------------------------------------ | -------- |
| 要件定義書 | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md` | 機能要件 |

#### 成果物

| 成果物                 | パス                                                                  | 内容                               |
| ---------------------- | --------------------------------------------------------------------- | ---------------------------------- |
| テンプレート管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-template-design.md` | テンプレートのデータ構造・保存方法 |

#### 完了条件

- [ ] テンプレートのデータ構造が定義されている
- [ ] 保存先（ファイルシステム/DB）が明確である
- [ ] プリセットテンプレートの仕様が定義されている
- [ ] テンプレートのCRUD操作が設計されている

#### 依存関係

- **前提**: T-00-1（機能要件定義）
- **後続**: T-02-1（設計レビュー）

---

## Phase 2: 設計レビューゲート

### T-02-1: 設計レビュー

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```

/ai:review-architecture

```

- **選定方法**: `.claude/commands/ai/command_list.md` からアーキテクチャレビュー関連コマンドを選定

#### 目的

実装開始前に要件・設計の妥当性を検証し、問題を早期発見する。

#### 背景

設計ミスが実装後に発見されると修正コストが大幅に増加するため、「Shift Left」原則に基づき問題を早期に検出する。

#### 責務（単一責務）

設計レビューと問題の特定のみを担当する。

#### 参照資料

| 参照資料               | パス                                                                  | 内容                 |
| ---------------------- | --------------------------------------------------------------------- | -------------------- |
| 要件定義書             | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`    | 機能要件             |
| UI設計書               | `docs/30-workflows/chat-system-prompt/task-step01-ui-design.md`       | UI設計               |
| 状態管理設計書         | `docs/30-workflows/chat-system-prompt/task-step01-state-design.md`    | 状態管理設計         |
| テンプレート管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-template-design.md` | テンプレート管理設計 |

#### レビューチェックリスト

**要件の妥当性**

- [ ] 要件が明確で曖昧さがない
- [ ] スコープが適切に定義されている
- [ ] 受け入れ基準が検証可能である

**設計の妥当性**

- [ ] UI設計が要件を満たしている
- [ ] 状態管理設計が適切である
- [ ] テンプレート管理設計が適切である
- [ ] 既存システムとの整合性がある

**実装可能性**

- [ ] 技術的に実装可能である
- [ ] パフォーマンス要件を満たせる
- [ ] セキュリティリスクがない

**保守性**

- [ ] コードが保守しやすい構造である
- [ ] テストが書きやすい設計である

#### レビュー結果

- **判定**: {{PASS/MINOR/MAJOR/CRITICAL}}
- **指摘事項**: {{指摘内容}}
- **対応方針**: {{対応内容}}

#### 戻り先決定（MAJORの場合）

| 問題の種類                 | 戻り先                         |
| -------------------------- | ------------------------------ |
| 要件の問題                 | Phase 0（要件定義）            |
| UI設計の問題               | T-01-1（UI設計）               |
| 状態管理設計の問題         | T-01-2（状態管理設計）         |
| テンプレート管理設計の問題 | T-01-3（テンプレート管理設計） |

#### 成果物

| 成果物               | パス                                                                | 内容                   |
| -------------------- | ------------------------------------------------------------------- | ---------------------- |
| 設計レビューレポート | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md` | レビュー結果・指摘事項 |

#### 完了条件

- [ ] すべてのレビュー観点が確認されている
- [ ] レビュー結果が文書化されている
- [ ] 指摘事項がすべて対応されている（PASS判定の場合）
- [ ] 次フェーズへ進む判断が明確である

#### 依存関係

- **前提**: T-01-1, T-01-2, T-01-3（設計フェーズすべて）
- **後続**: Phase 3（テスト作成） または 問題に応じた戻り先

---

## Phase 3: テスト作成 (TDD: Red)

### T-03-1: UI コンポーネントテスト作成

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```

/ai:generate-component-tests

```

- **選定方法**: `.claude/commands/ai/command_list.md` からコンポーネントテスト生成関連コマンドを選定

#### 目的

システムプロンプト入力UIコンポーネントのテストを実装より先に作成する。

#### 背景

TDDのRed-Green-Refactorサイクルに従い、期待される動作を検証するテストを先に作成することで、実装の品質を担保する。

#### 責務（単一責務）

UIコンポーネントのテスト作成のみを担当する。

#### 参照資料

| 参照資料             | パス                                                                | 内容         |
| -------------------- | ------------------------------------------------------------------- | ------------ |
| 要件定義書           | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`  | 機能要件     |
| UI設計書             | `docs/30-workflows/chat-system-prompt/task-step01-ui-design.md`     | UI設計       |
| 設計レビューレポート | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md` | レビュー結果 |

#### 成果物

| 成果物                 | パス                                          | 内容               |
| ---------------------- | --------------------------------------------- | ------------------ |
| UIコンポーネントテスト | `apps/desktop/src/components/chat/*.test.tsx` | Vitestテストコード |

#### TDD検証: Red状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが失敗することを確認（Red状態）

#### 完了条件

- [ ] テストファイルが作成されている
- [ ] テストケースが要件を網羅している
- [ ] テストが実行可能である
- [ ] テストが失敗することを確認済み（Red状態）

#### 依存関係

- **前提**: T-02-1（設計レビュー）
- **後続**: T-04-1（UIコンポーネント実装）

---

### T-03-2: 状態管理テスト作成

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:generate-unit-tests
```

- **選定方法**: `.claude/commands/ai/command_list.md` からユニットテスト生成関連コマンドを選定

#### 目的

システムプロンプト状態管理（Zustand store）のテストを実装より先に作成する。

#### 背景

状態管理の正しさを保証するため、テストを先に作成する。

#### 責務（単一責務）

状態管理のテスト作成のみを担当する。

#### 参照資料

| 参照資料             | パス                                                                | 内容         |
| -------------------- | ------------------------------------------------------------------- | ------------ |
| 要件定義書           | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`  | 機能要件     |
| 状態管理設計書       | `docs/30-workflows/chat-system-prompt/task-step01-state-design.md`  | 状態管理設計 |
| 設計レビューレポート | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md` | レビュー結果 |

#### 成果物

| 成果物         | パス                                     | 内容               |
| -------------- | ---------------------------------------- | ------------------ |
| 状態管理テスト | `apps/desktop/src/stores/chat/*.test.ts` | Vitestテストコード |

#### TDD検証: Red状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが失敗することを確認（Red状態）

#### 完了条件

- [ ] テストファイルが作成されている
- [ ] テストケースが状態管理の振る舞いを網羅している
- [ ] テストが実行可能である
- [ ] テストが失敗することを確認済み（Red状態）

#### 依存関係

- **前提**: T-02-1（設計レビュー）
- **後続**: T-04-2（状態管理実装）

---

### T-03-3: テンプレート管理テスト作成

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:generate-unit-tests
```

- **選定方法**: `.claude/commands/ai/command_list.md` からユニットテスト生成関連コマンドを選定

#### 目的

プロンプトテンプレート管理機能のテストを実装より先に作成する。

#### 背景

テンプレートのCRUD操作の正しさを保証するため、テストを先に作成する。

#### 責務（単一責務）

テンプレート管理機能のテスト作成のみを担当する。

#### 参照資料

| 参照資料               | パス                                                                  | 内容                 |
| ---------------------- | --------------------------------------------------------------------- | -------------------- |
| 要件定義書             | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`    | 機能要件             |
| テンプレート管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-template-design.md` | テンプレート管理設計 |
| 設計レビューレポート   | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md`   | レビュー結果         |

#### 成果物

| 成果物                 | パス                                       | 内容               |
| ---------------------- | ------------------------------------------ | ------------------ |
| テンプレート管理テスト | `apps/desktop/src/features/chat/*.test.ts` | Vitestテストコード |

#### TDD検証: Red状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが失敗することを確認（Red状態）

#### 完了条件

- [ ] テストファイルが作成されている
- [ ] テストケースがテンプレート管理機能を網羅している
- [ ] テストが実行可能である
- [ ] テストが失敗することを確認済み（Red状態）

#### 依存関係

- **前提**: T-02-1（設計レビュー）
- **後続**: T-04-3（テンプレート管理実装）

---

## Phase 4: 実装 (TDD: Green)

### T-04-1: UI コンポーネント実装

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:create-component
```

- **選定方法**: `.claude/commands/ai/command_list.md` から UI 実装関連コマンドを選定

#### 目的

テストを通すための最小限のUIコンポーネント実装を行う。

#### 背景

TDD のGreenフェーズとして、作成したテストを成功させるコードを実装する。

#### 責務（単一責務）

UIコンポーネントの実装のみを担当する。

#### 参照資料

| 参照資料             | パス                                                                | 内容         |
| -------------------- | ------------------------------------------------------------------- | ------------ |
| 要件定義書           | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`  | 機能要件     |
| UI設計書             | `docs/30-workflows/chat-system-prompt/task-step01-ui-design.md`     | UI設計       |
| 設計レビューレポート | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md` | レビュー結果 |

#### 成果物

| 成果物           | パス                                                      | 内容                     |
| ---------------- | --------------------------------------------------------- | ------------------------ |
| UIコンポーネント | `apps/desktop/src/components/chat/SystemPromptEditor.tsx` | システムプロンプト入力UI |

#### TDD検証: Green状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが成功することを確認（Green状態）

#### 完了条件

- [ ] UIコンポーネントが実装されている
- [ ] テストが成功する（Green状態）
- [ ] 型エラーがない
- [ ] Lint エラーがない

#### 依存関係

- **前提**: T-03-1（UIコンポーネントテスト作成）
- **後続**: T-05-1（リファクタリング）

---

### T-04-2: 状態管理実装

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:implement-business-logic
```

- **選定方法**: `.claude/commands/ai/command_list.md` からロジック実装関連コマンドを選定

#### 目的

テストを通すための最小限の状態管理実装を行う。

#### 背景

TDD のGreenフェーズとして、作成したテストを成功させる状態管理コードを実装する。

#### 責務（単一責務）

状態管理の実装のみを担当する。

#### 参照資料

| 参照資料             | パス                                                                | 内容         |
| -------------------- | ------------------------------------------------------------------- | ------------ |
| 要件定義書           | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`  | 機能要件     |
| 状態管理設計書       | `docs/30-workflows/chat-system-prompt/task-step01-state-design.md`  | 状態管理設計 |
| 設計レビューレポート | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md` | レビュー結果 |

#### 成果物

| 成果物        | パス                                                | 内容                       |
| ------------- | --------------------------------------------------- | -------------------------- |
| Zustand store | `apps/desktop/src/stores/chat/systemPromptStore.ts` | システムプロンプト状態管理 |

#### TDD検証: Green状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが成功することを確認（Green状態）

#### 完了条件

- [ ] Zustand storeが実装されている
- [ ] テストが成功する（Green状態）
- [ ] 型エラーがない
- [ ] Lint エラーがない

#### 依存関係

- **前提**: T-03-2（状態管理テスト作成）
- **後続**: T-05-1（リファクタリング）

---

### T-04-3: テンプレート管理実装

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:implement-business-logic
```

- **選定方法**: `.claude/commands/ai/command_list.md` からロジック実装関連コマンドを選定

#### 目的

テストを通すための最小限のテンプレート管理実装を行う。

#### 背景

TDD のGreenフェーズとして、作成したテストを成功させるテンプレート管理コードを実装する。

#### 責務（単一責務）

テンプレート管理機能の実装のみを担当する。

#### 参照資料

| 参照資料               | パス                                                                  | 内容                 |
| ---------------------- | --------------------------------------------------------------------- | -------------------- |
| 要件定義書             | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`    | 機能要件             |
| テンプレート管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-template-design.md` | テンプレート管理設計 |
| 設計レビューレポート   | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md`   | レビュー結果         |

#### 成果物

| 成果物                     | パス                                                | 内容                 |
| -------------------------- | --------------------------------------------------- | -------------------- |
| テンプレート管理モジュール | `apps/desktop/src/features/chat/templateManager.ts` | テンプレートCRUD機能 |

#### TDD検証: Green状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが成功することを確認（Green状態）

#### 完了条件

- [ ] テンプレート管理機能が実装されている
- [ ] テストが成功する（Green状態）
- [ ] 型エラーがない
- [ ] Lint エラーがない

#### 依存関係

- **前提**: T-03-3（テンプレート管理テスト作成）
- **後続**: T-05-1（リファクタリング）

---

### T-04-4: LLM連携実装

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:create-api-gateway
```

- **選定方法**: `.claude/commands/ai/command_list.md` から統合実装関連コマンドを選定

#### 目的

設定されたシステムプロンプトをLLMに送信する機能を実装する。

#### 背景

システムプロンプトが設定されても、LLMに送信されなければ意味がない。チャットメッセージ送信時にシステムプロンプトを含める実装が必要である。

#### 責務（単一責務）

LLMへのシステムプロンプト送信機能の実装のみを担当する。

#### 参照資料

| 参照資料       | パス                                                               | 内容         |
| -------------- | ------------------------------------------------------------------ | ------------ |
| 要件定義書     | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md` | 機能要件     |
| 状態管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-state-design.md` | 状態管理設計 |

#### 成果物

| 成果物        | パス                                  | 内容                       |
| ------------- | ------------------------------------- | -------------------------- |
| LLM連携コード | `apps/desktop/src/features/chat/*.ts` | システムプロンプト送信機能 |

#### TDD検証: Green状態確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが成功することを確認（Green状態）

#### 完了条件

- [ ] LLM連携機能が実装されている
- [ ] テストが成功する（Green状態）
- [ ] 型エラーがない
- [ ] Lint エラーがない
- [ ] システムプロンプトがLLMに正しく送信される

#### 依存関係

- **前提**: T-04-2（状態管理実装）
- **後続**: T-05-1（リファクタリング）

---

## Phase 5: リファクタリング (TDD: Refactor)

### T-05-1: コードリファクタリング

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:refactor
```

- **選定方法**: `.claude/commands/ai/command_list.md` からリファクタリング関連コマンドを選定

#### 目的

動作を変えずにコード品質を改善する。

#### 背景

Green状態を達成したコードを、保守性・可読性・パフォーマンスの観点から改善する。

#### 責務（単一責務）

コード品質の改善のみを担当する（機能追加は含まない）。

#### 参照資料

| 参照資料   | パス                          | 内容                    |
| ---------- | ----------------------------- | ----------------------- |
| 実装コード | `apps/desktop/src/**/*.ts(x)` | Phase 4で実装したコード |

#### 成果物

| 成果物                     | パス                          | 内容                 |
| -------------------------- | ----------------------------- | -------------------- |
| リファクタリング後のコード | `apps/desktop/src/**/*.ts(x)` | 品質改善されたコード |

#### 検証: テスト継続成功確認

```bash
pnpm --filter @repo/desktop test
```

- [ ] テストが継続して成功することを確認

#### 完了条件

- [ ] コードの重複が排除されている
- [ ] 命名が適切である
- [ ] コードの複雑度が適切である
- [ ] テストが継続して成功する
- [ ] 型エラーがない
- [ ] Lint エラーがない

#### 依存関係

- **前提**: T-04-1, T-04-2, T-04-3, T-04-4（実装フェーズすべて）
- **後続**: T-06-1（品質保証）

---

## Phase 6: 品質保証

### T-06-1: 品質保証

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:analyze-code-quality
```

- **選定方法**: `.claude/commands/ai/command_list.md` から品質チェック関連コマンドを選定

#### 目的

定義された品質基準をすべて満たすことを検証する。

#### 背景

実装が完了しても、品質基準を満たさなければマージできない。自動テスト、型チェック、Lint、カバレッジ等をすべて確認する。

#### 責務（単一責務）

品質基準の検証のみを担当する。

#### 参照資料

| 参照資料   | パス                          | 内容                                  |
| ---------- | ----------------------------- | ------------------------------------- |
| 実装コード | `apps/desktop/src/**/*.ts(x)` | Phase 5でリファクタリングされたコード |

#### 品質ゲート

- **機能検証**: 自動テストの完全成功
- **コード品質**: Lint/型チェッククリア
- **テスト網羅性**: カバレッジ基準達成
- **セキュリティ**: 重大な脆弱性の不在

#### 成果物

| 成果物       | パス                                                                 | 内容             |
| ------------ | -------------------------------------------------------------------- | ---------------- |
| 品質レポート | `docs/30-workflows/chat-system-prompt/task-step06-quality-report.md` | 品質チェック結果 |

#### 完了条件

- [ ] すべてのテストが成功している
- [ ] 型チェックが成功している（`pnpm typecheck`）
- [ ] Lint チェックが成功している（`pnpm lint`）
- [ ] ビルドが成功している（`pnpm --filter @repo/desktop build`）
- [ ] テストカバレッジが基準を満たしている
- [ ] セキュリティスキャンで重大な問題がない

#### 依存関係

- **前提**: T-05-1（リファクタリング）
- **後続**: T-07-1（最終レビュー）

---

## Phase 7: 最終レビューゲート

### T-07-1: 最終レビュー

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:code-review-complete
```

- **選定方法**: `.claude/commands/ai/command_list.md` から最終レビュー関連コマンドを選定

#### 目的

実装完了後、ドキュメント更新前に全体的な品質・整合性を検証する。

#### 背景

Phase 6の自動検証だけでは検出できない設計判断やベストプラクティス違反を確認する。

#### 責務（単一責務）

最終レビューと問題の特定のみを担当する。

#### 参照資料

| 参照資料               | パス                                                                  | 内容                 |
| ---------------------- | --------------------------------------------------------------------- | -------------------- |
| 要件定義書             | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`    | 機能要件             |
| UI設計書               | `docs/30-workflows/chat-system-prompt/task-step01-ui-design.md`       | UI設計               |
| 状態管理設計書         | `docs/30-workflows/chat-system-prompt/task-step01-state-design.md`    | 状態管理設計         |
| テンプレート管理設計書 | `docs/30-workflows/chat-system-prompt/task-step01-template-design.md` | テンプレート管理設計 |
| 設計レビューレポート   | `docs/30-workflows/chat-system-prompt/task-step02-design-review.md`   | 設計レビュー結果     |
| 品質レポート           | `docs/30-workflows/chat-system-prompt/task-step06-quality-report.md`  | 品質チェック結果     |

#### レビューチェックリスト

**要件充足性**

- [ ] すべての要件が実装されている
- [ ] 受け入れ基準をすべて満たしている

**設計との整合性**

- [ ] 実装が設計書に従っている
- [ ] 設計からの逸脱がある場合、正当な理由がある

**コード品質**

- [ ] Clean Code原則に従っている
- [ ] SOLID原則に従っている
- [ ] 適切なエラーハンドリングがある

**テスト品質**

- [ ] テストが要件を網羅している
- [ ] テストが保守しやすい

**ドキュメント**

- [ ] コードコメントが適切である
- [ ] 必要な設計判断が文書化されている

#### レビュー結果

- **判定**: {{PASS/MINOR/MAJOR/CRITICAL}}
- **指摘事項**: {{指摘内容}}
- **対応方針**: {{対応内容}}

#### 戻り先決定（MAJORの場合）

| 問題の種類       | 戻り先                      |
| ---------------- | --------------------------- |
| 要件の問題       | Phase 0（要件定義）         |
| 設計の問題       | Phase 1（設計）             |
| テスト設計の問題 | Phase 3（テスト作成）       |
| 実装の問題       | Phase 4（実装）             |
| コード品質の問題 | Phase 5（リファクタリング） |

#### 成果物

| 成果物               | パス                                                               | 内容             |
| -------------------- | ------------------------------------------------------------------ | ---------------- |
| 最終レビューレポート | `docs/30-workflows/chat-system-prompt/task-step07-final-review.md` | 最終レビュー結果 |

#### 完了条件

- [ ] すべてのレビュー観点が確認されている
- [ ] レビュー結果が文書化されている
- [ ] 指摘事項がすべて対応されている（PASS判定の場合）
- [ ] 次フェーズへ進む判断が明確である

#### 依存関係

- **前提**: T-06-1（品質保証）
- **後続**: Phase 8（手動テスト） または 問題に応じた戻り先

---

## Phase 8: 手動テスト検証

### T-08-1: 手動テスト検証

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:generate-e2e-tests
```

- **選定方法**: `.claude/commands/ai/command_list.md` からテスト計画生成関連コマンドを選定

#### 目的

自動テストでは検証できないユーザー体験・UI/UX・実環境動作を手動で確認し、実際のユーザー視点での品質を担保する。

#### 背景

自動テストはロジックの正しさを検証するが、以下は手動確認が必要：

- 実際のユーザー操作フロー
- 視覚的なUI/UXの確認
- LLMとの実際の連携
- エッジケースやコーナーケース

#### 責務（単一責務）

手動テストの実施と結果の記録のみを担当する。

#### 参照資料

| 参照資料   | パス                                                               | 内容     |
| ---------- | ------------------------------------------------------------------ | -------- |
| 要件定義書 | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md` | 機能要件 |
| UI設計書   | `docs/30-workflows/chat-system-prompt/task-step01-ui-design.md`    | UI設計   |

#### 手動テストケース

| No  | カテゴリ | テスト項目             | 前提条件                           | 操作手順                                 | 期待結果                                     | 実行結果 | 備考 |
| --- | -------- | ---------------------- | ---------------------------------- | ---------------------------------------- | -------------------------------------------- | -------- | ---- |
| 1   | 機能     | システムプロンプト入力 | チャット画面を開く                 | システムプロンプト入力欄にテキストを入力 | テキストが入力される                         |          |      |
| 2   | 機能     | システムプロンプト適用 | システムプロンプトを入力済み       | チャットメッセージを送信                 | LLMがシステムプロンプトに従った応答をする    |          |      |
| 3   | 機能     | テンプレート保存       | システムプロンプトを入力済み       | テンプレート保存ボタンをクリック         | テンプレートが保存される                     |          |      |
| 4   | 機能     | テンプレート読み込み   | テンプレートが保存済み             | テンプレート選択・読み込み               | システムプロンプトがテンプレートの内容になる |          |      |
| 5   | 機能     | LLM切り替え時の維持    | システムプロンプトを設定済み       | LLMを切り替える                          | システムプロンプトが維持される               |          |      |
| 6   | UI/UX    | レイアウト確認         | チャット画面を開く                 | システムプロンプト入力UIを確認           | UIが適切に配置されている                     |          |      |
| 7   | UI/UX    | レスポンシブ確認       | ウィンドウサイズを変更             | 各サイズでUIを確認                       | レイアウトが崩れない                         |          |      |
| 8   | 異常系   | 空のプロンプト         | システムプロンプトを空にする       | チャットメッセージを送信                 | デフォルトの動作になる                       |          |      |
| 9   | 異常系   | 長いプロンプト         | 非常に長いシステムプロンプトを入力 | チャットメッセージを送信                 | エラーまたは適切な警告が表示される           |          |      |

#### 成果物

| 成果物             | パス                                                                      | 内容           |
| ------------------ | ------------------------------------------------------------------------- | -------------- |
| 手動テストレポート | `docs/30-workflows/chat-system-prompt/task-step08-manual-test-results.md` | 手動テスト結果 |

#### 完了条件

- [ ] すべてのテストケースが実行されている
- [ ] すべてのテストケースが合格している
- [ ] 不具合がある場合は修正されている
- [ ] テスト結果が文書化されている

#### 依存関係

- **前提**: T-07-1（最終レビュー）
- **後続**: Phase 9（ドキュメント更新）

---

## Phase 9: ドキュメント更新

### T-09-1: ドキュメント更新

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
/ai:update-all-docs
```

- **選定方法**: `.claude/commands/ai/command_list.md` からドキュメント更新関連コマンドを選定

#### 目的

システム要件ドキュメントを更新し、システム全体の最新状態を反映する。

#### 背景

実装された機能をシステム要件ドキュメントに反映させることで、ドキュメントとコードの整合性を保つ。

#### 責務（単一責務）

docs/00-requirements/配下のドキュメント更新のみを担当する。

#### 参照資料

| 参照資料             | パス                                                                      | 内容             |
| -------------------- | ------------------------------------------------------------------------- | ---------------- |
| 要件定義書           | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`        | 機能要件         |
| 設計ドキュメント     | `docs/30-workflows/chat-system-prompt/task-step01-*.md`                   | 各種設計書       |
| 品質レポート         | `docs/30-workflows/chat-system-prompt/task-step06-quality-report.md`      | 品質チェック結果 |
| 最終レビューレポート | `docs/30-workflows/chat-system-prompt/task-step07-final-review.md`        | 最終レビュー結果 |
| 手動テストレポート   | `docs/30-workflows/chat-system-prompt/task-step08-manual-test-results.md` | 手動テスト結果   |

#### 更新対象ドキュメント

| ドキュメント     | パス                                           | 更新内容                             |
| ---------------- | ---------------------------------------------- | ------------------------------------ |
| システム設計書   | `docs/00-requirements/master_system_design.md` | システムプロンプト設定機能の追加     |
| チャット機能仕様 | `docs/00-requirements/04-features.md`          | システムプロンプト設定機能の仕様追加 |

#### スキル参照セクション更新

- **requirements-skill-map.json** を参照して、影響を受けるスキルを特定
- 各スキルの **Requirements References** セクションを更新

例: `docs/00-requirements/04-features.md` を更新した場合

- `requirements-skill-map.json` で確認 → `"state-manager"`, `"ui-designer"` などがマッピングされている
- `.claude/skills/state-manager/SKILL.md` の Requirements References セクションを確認・更新
- `.claude/skills/ui-designer/SKILL.md` の Requirements References セクションを確認・更新

#### 成果物

| 成果物                   | パス                                           | 内容                               |
| ------------------------ | ---------------------------------------------- | ---------------------------------- |
| 更新されたシステム設計書 | `docs/00-requirements/master_system_design.md` | システムプロンプト機能を含む最新版 |
| 更新された機能仕様       | `docs/00-requirements/04-features.md`          | システムプロンプト機能仕様         |

#### 完了条件

- [ ] すべての対象ドキュメントが更新されている
- [ ] ドキュメントの整合性が保たれている
- [ ] スキル参照セクションが更新されている
- [ ] 変更内容が明確に記載されている

#### 依存関係

- **前提**: T-08-1（手動テスト検証）
- **後続**: T-09-2（未完了タスク記録）

---

### T-09-2: 未完了タスク・追加タスク記録

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです
> ⚠️ Worktreeディレクトリ (`.worktrees/task-{{timestamp}}`) 内で実行してください

```
# 専用のスラッシュコマンドは存在しないため、手動で実施
# 実装中に発見された追加タスクを docs/30-workflows/unassigned-task/ に記録
```

- **選定方法**: `.claude/commands/ai/command_list.md` に該当コマンドなし（手動対応）

#### 目的

実装中に発見された追加タスクや改善点を記録し、今後の作業として残す。

#### 背景

実装中に「今回のスコープ外だが将来的に必要」となるタスクが見つかることがある。これらを記録しておくことで、将来的な改善につなげる。

#### 責務（単一責務）

追加タスクの記録のみを担当する。

#### 参照資料

| 参照資料             | パス                                                                      | 内容                               |
| -------------------- | ------------------------------------------------------------------------- | ---------------------------------- |
| 要件定義書           | `docs/30-workflows/chat-system-prompt/task-step00-requirements.md`        | 機能要件（スコープ外の項目を含む） |
| 最終レビューレポート | `docs/30-workflows/chat-system-prompt/task-step07-final-review.md`        | 最終レビューで発見された改善点     |
| 手動テストレポート   | `docs/30-workflows/chat-system-prompt/task-step08-manual-test-results.md` | 手動テストで発見された改善点       |

#### 出力先

`docs/30-workflows/unassigned-task/`

#### 記録対象タスク一覧

- プロンプトの自動生成機能（スコープ外だった機能）
- プロンプトの品質評価機能（スコープ外だった機能）
- 外部プロンプトライブラリとの連携（スコープ外だった機能）
- その他、実装中に発見された改善点

#### ファイル命名規則

- 要件系: `requirements-{{機能領域}}.md`
- 改善系: `task-{{改善領域}}-improvements.md`

#### 指示書としての品質基準

生成されるタスク指示書は以下を満たすこと：

**Why（なぜ必要か）**

- [ ] 背景が明確に記述されている
- [ ] 問題点・課題が具体的に説明されている
- [ ] 放置した場合の影響が記載されている

**What（何を達成するか）**

- [ ] 目的が明確に定義されている
- [ ] 最終ゴールが具体的に記述されている
- [ ] スコープ（含む/含まない）が明記されている
- [ ] 成果物が一覧化されている

**How（どのように実行するか）**

- [ ] 前提条件が明記されている
- [ ] 依存タスクが特定されている
- [ ] 必要な知識・スキルが記載されている
- [ ] 推奨アプローチが説明されている

**実行手順**

- [ ] フェーズ構成が明確である
- [ ] 各フェーズにClaude Codeスラッシュコマンド（/ai:xxx形式）が記載されている
- [ ] 各フェーズの成果物・完了条件が定義されている

**検証・完了**

- [ ] 完了条件チェックリストがある
- [ ] テストケース/検証方法が記載されている
- [ ] リスクと対策が検討されている

#### 成果物

| 成果物           | パス                                          | 内容                 |
| ---------------- | --------------------------------------------- | -------------------- |
| 追加タスク指示書 | `docs/30-workflows/unassigned-task/task-*.md` | 今後実施すべきタスク |

#### 完了条件

- [ ] すべての追加タスクが記録されている
- [ ] タスク指示書が品質基準を満たしている
- [ ] タスクの優先度が明記されている

#### 依存関係

- **前提**: T-08-1（手動テスト検証）
- **後続**: T-10-1（コミット作成）

---

## Phase 10: PR作成・CI確認・マージ準備

### T-10-1: 差分確認・コミット作成

#### Claude Code スラッシュコマンド

> ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

```
# コミット作成
/ai:commit

# その後、PR作成が必要な場合は
/ai:create-pr
```

#### 目的

Worktreeディレクトリ内での変更を確認し、適切なコミットメッセージでコミットを作成する。

#### 背景

Git Worktree環境での作業が完了したため、変更をコミットしてPR作成の準備をする。

#### 責務（単一責務）

コミット作成のみを担当する。

#### 実行手順

**1. Worktreeディレクトリ内で差分確認**

```bash
# 現在のディレクトリ確認
pwd  # .worktrees/task-XXX であることを確認

# 変更ファイル確認
git status

# 詳細な差分確認
git diff
```

**2. 変更内容を分析し、適切なコミットメッセージを生成**

Conventional Commitsタイプ:

- `feat`: 新機能
- `fix`: バグ修正
- `refactor`: リファクタリング
- `docs`: ドキュメント
- `test`: テスト
- `chore`: その他（依存関係更新等）
- `ci`: CI/CD

スコープ例: `chat`, `features`, `shared`, `api`, `db`, `docs`, `config`

subject: 50文字以内、現在形・命令形

**3. コミット前チェック（Pre-commit hookが自動実行）**

```bash
# 手動で確認する場合
pnpm typecheck  # 型チェック
pnpm lint       # ESLint
pnpm test       # テスト実行
```

**4. コミット実行**

```bash
git add .
git commit -m "$(cat <<'EOF'
feat(chat): システムプロンプト設定機能を追加

- システムプロンプト入力UIの実装
- プロンプトテンプレート管理機能
- チャットセッションごとのシステムプロンプト管理
- LLM切り替え時のシステムプロンプト維持

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 (1M context) <noreply@anthropic.com>
EOF
)"
```

#### 成果物

| 成果物      | 内容                               |
| ----------- | ---------------------------------- |
| Gitコミット | Conventional Commits形式のコミット |

#### 完了条件

- [ ] git statusで変更内容を確認済み
- [ ] Conventional Commits形式でコミット作成済み
- [ ] Claude Code署名が含まれている

#### 依存関係

- **前提**: T-09-1, T-09-2（ドキュメント更新）
- **後続**: T-10-2（PR作成）

---

### T-10-2: PR作成

#### 目的

GitHub Pull Requestを作成し、CI確認を実施する。

#### 背景

Worktree環境での実装が完了し、本体ブランチへのマージ準備をする。

#### 責務（単一責務）

PR作成とCI確認のみを担当する。

#### 実行手順

**1. ブランチプッシュ**

```bash
git push -u origin <branch-name>
```

**2. PR作成（テンプレート使用）**

```bash
gh pr create --title "feat(chat): システムプロンプト設定機能を追加" --body "$(cat <<'EOF'
## 概要

チャット機能にシステムプロンプトを設定できるUIを実装し、ユーザーがAIの振る舞いをカスタマイズできるようにしました。

## 変更内容

- システムプロンプト入力UIコンポーネントの実装
- Zustand storeによるシステムプロンプト状態管理
- プロンプトテンプレート管理機能（保存・読み込み）
- LLMへのシステムプロンプト送信機能
- チャットセッションごとのシステムプロンプト管理
- LLM切り替え時のシステムプロンプト維持

## 変更タイプ

- [ ] 🐛 バグ修正 (bug fix)
- [x] ✨ 新機能 (new feature)
- [ ] 🔨 リファクタリング (refactoring)
- [ ] 📝 ドキュメント (documentation)
- [ ] 🧪 テスト (test)
- [ ] 🔧 設定変更 (configuration)
- [ ] 🚀 CI/CD (continuous integration)

## テスト

- [x] ユニットテスト実行 (`pnpm test`)
- [x] 型チェック実行 (`pnpm typecheck`)
- [x] ESLint チェック実行 (`pnpm lint`)
- [x] ビルド確認 (`pnpm build`)
- [x] 手動テスト実施

## 関連 Issue

Closes #

## 破壊的変更

- [ ] この PR には破壊的変更が含まれます

## チェックリスト

- [x] コードが既存のスタイルに従っている
- [x] 必要に応じてドキュメントを更新した
- [x] 新規・変更機能にテストを追加した
- [x] すべてのテストがローカルで成功する
- [x] Pre-commit hooks が成功する

---

🤖 Generated with [Claude Code](https://claude.com/claude-code)
EOF
)" --base main
```

#### 成果物

| 成果物              | 内容                             |
| ------------------- | -------------------------------- |
| GitHub Pull Request | PRが作成され、レビュー可能な状態 |

#### 完了条件

- [ ] ブランチがリモートにプッシュされている
- [ ] PRが正常に作成されている
- [ ] PR本文が適切に記載されている
- [ ] CI/CDが成功している
- [ ] ユーザーにマージ可能を通知している

#### 依存関係

- **前提**: T-10-1（コミット作成）
- **後続**: なし（タスク完了）

---

## 完了条件チェックリスト

### 機能実装

- [ ] システムプロンプトを入力・編集できる
- [ ] プロンプトテンプレートを保存・読み込みできる
- [ ] チャットセッションにシステムプロンプトが適用される
- [ ] LLM切り替え時もシステムプロンプトが維持される

### 品質保証

- [ ] すべてのテストが成功している
- [ ] 型チェックが成功している
- [ ] Lint チェックが成功している
- [ ] ビルドが成功している
- [ ] 手動テストがすべて合格している

### ドキュメント

- [ ] システム設計書が更新されている
- [ ] 機能仕様が更新されている
- [ ] スキル参照セクションが更新されている

### PR

- [ ] PRが作成されている
- [ ] CI/CDが成功している
- [ ] レビュー可能な状態である

---

## 備考

### 元の指示書

元のタスク指示書は `docs/30-workflows/completed-tasks/task-chat-system-prompt.md` に保存されています。

### スコープ外機能（将来実装予定）

- プロンプトの自動生成
- プロンプトの品質評価
- 外部プロンプトライブラリとの連携

### 参考情報

- システムプロンプトはMarkdown形式で記述可能
- テンプレートはJSON形式で保存
- LLM APIの仕様に応じてシステムプロンプトの送信方法を調整
