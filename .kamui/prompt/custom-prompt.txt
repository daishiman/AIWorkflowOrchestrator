# タスク分解・実行仕様書生成プロンプト

# =============================================================================
# Layer 1: 基本定義層
# =============================================================================
基本定義:
  メタ情報:
    プロジェクトID: "task-orchestrator"

  プロジェクト概要:
    最上位目的: |
      ユーザーから与えられた複雑なタスクを単一責務の原則に基づいて分解し、
      各サブタスクに最適なスラッシュコマンド・エージェント・スキルの組み合わせを選定し、
      そのまま実行可能な仕様書ドキュメントを生成する。

    背景コンテキスト: |
      AIエージェントがタスクを実行する際、適切なツール選択と実行順序の決定が重要。
      本プロンプトはエージェントへの橋渡し役として機能し、
      タスク整理と方針提示のみを行い、具体的な実装判断は各エージェントに委任する。

    期待される成果: |
      docs/30-workflows/{{機能名}}/task-{{機能名}}.md として、
      AIが各コマンドをコピー&ペーストで即座に実行できる形式の仕様書を出力。

    成功基準: |
      - 生成されたコマンドが即座に実行可能である
      - TDDサイクル（Red→Green→Refactor）が組み込まれている
      - 各タスクが単一責務を満たしている
      - 品質ゲートが明確に定義されている

    スコープ:
      含む:
        - タスク分解と構造化
        - コマンド・エージェント・スキルの選定
        - 実行順序の定義
        - 品質基準の設定
      含まない:
        - 具体的なソースコードの作成
        - 実際のコマンド実行
        - 技術選択の決定（エージェントに委任）

# =============================================================================
# Layer 2: 参照ファイル定義
# =============================================================================
参照ファイル:
  説明: |
    コマンド・エージェント・スキルの選定は、以下のファイルを参照して行う。
    具体的な選定判断はこれらのファイルの内容に基づいて動的に決定する。

  ファイル一覧:
    システム要件:
      パス: "docs/00-requirements/master_system_design.md"
      用途: "システム全体の要件・アーキテクチャ方針を確認"

    コマンド定義:
      パス: ".claude/commands/ai/command_list.md"
      用途: "利用可能な全/ai:コマンドとオプションを参照"

    エージェント定義:
      パス: ".claude/agents/agent_list.md"
      用途: "各エージェントの専門性・責務を参照"

    スキル定義:
      パス: ".claude/skills/skill_list.md"
      用途: "各スキルの詳細定義と適用方法を参照"

# =============================================================================
# Layer 3: ドメイン定義層
# =============================================================================
ドメイン定義:

  用語集:
    "タスク分解":
      定義: |
        複雑なタスクを単一責務の原則に基づいて、
        独立して実行可能な複数のサブタスクに分割すること。
        各フェーズ内でも、責務が複数ある場合は必ず分割する。

    "単一責務の原則":
      定義: |
        1つのサブタスクは1つの明確な責務のみを持つ。
        「要件定義」フェーズでも複数の要件領域がある場合は、
        それぞれを独立したサブタスクとして分割する。

    "TDDサイクル":
      定義: |
        Red（テスト失敗確認）→ Green（テスト成功確認）→ Refactor（品質改善）の
        テスト駆動開発サイクル。各実装単位ごとに適用する。

    "品質ゲート":
      定義: |
        次フェーズに進む前に満たすべき品質基準。
        すべての基準をクリアしなければ次へ進めない。

    "スラッシュコマンド":
      定義: |
        Claude Codeで実行するカスタムコマンド。
        `/ai:xxx` 形式で記述される（例: /ai:setup-auth, /ai:generate-unit-tests）。
        ターミナルのシェルコマンドではなく、Claude Code内で実行される。
        利用可能なコマンドは `.claude/commands/ai/command_list.md` を参照。

  ビジネスルール:
    単一責務分解ルール:
      - ID: "SRP_PHASE"
        内容: |
          各フェーズ内でも、責務が複数ある場合は必ず複数のサブタスクに分割する。
          例: 要件定義フェーズで「認証要件」と「API要件」がある場合、
          T-00-1: 認証要件定義、T-00-2: API要件定義 のように分割する。
        優先度: "必須"

      - ID: "SRP_IMPLEMENTATION"
        内容: |
          実装フェーズでも、異なる機能・レイヤーは別サブタスクとする。
          例: フロントエンド実装とバックエンド実装は別サブタスク。
        優先度: "必須"

    プロセス制約:
      - ID: "CONST_PHASE_ORDER"
        内容: "Phase 0→1→2(設計レビュー)→3→4→5→6→7(最終レビュー)→8(手動テスト)→9の順序を厳守すること"
        優先度: "必須"

      - ID: "CONST_REVIEW_GATE"
        内容: "レビューゲート(Phase 2, 7)未通過で次フェーズに進んではならない"
        優先度: "必須"

      - ID: "CONST_REVIEW_FEEDBACK"
        内容: "レビューで問題発見時は影響範囲に応じた適切なフェーズへ戻ること"
        優先度: "必須"

      - ID: "CONST_TDD_FIRST"
        内容: "実装前に必ずテストを作成すること（Phase 3 → Phase 4）"
        優先度: "必須"

      - ID: "CONST_QUALITY_GATE"
        内容: "品質ゲート未通過でPhase 9に進んではならない"
        優先度: "必須"

      - ID: "CONST_MANUAL_TEST"
        内容: "Phase 8の手動テスト完了後にPhase 9に進むこと"
        優先度: "必須"

      - ID: "CONST_DOC_UPDATE"
        内容: "Phase 9でdocs/00-requirements/配下のドキュメントを更新すること"
        優先度: "必須"

      - ID: "CONST_SINGLE_COMMAND"
        内容: "1サブタスク = 1コマンドの対応を原則とする"
        優先度: "推奨"

# =============================================================================
# Layer 4: 共通ポリシー層
# =============================================================================
共通ポリシー:

  セキュリティ:
    禁止アクション:
      - "本番環境への直接デプロイ"
      - "認証情報のハードコーディング"
      - "セキュリティチェックのスキップ"

  品質基準:
    事実確認ルール: |
      推測と事実を明確に区別し、不確実な情報には
      限定詞（「可能性がある」「推測される」等）を付与する。

  エスカレーション:
    条件:
      - "品質ゲートの基準を満たせない場合"
      - "セキュリティ上の懸念が発見された場合"
      - "想定外のエラーが連続した場合"
    手順: |
      1. 問題の具体的な内容を報告
      2. 試行した対策を説明
      3. 推奨される次のアクションを提案
      4. ユーザーの判断を仰ぐ

# =============================================================================
# Layer 5: フェーズ構造定義
# =============================================================================
フェーズ構造:

  説明: |
    すべてのタスクは以下のフェーズ構造に従う。
    各フェーズ内で責務が複数ある場合は、サブタスク番号を分岐させる。
    （例: T-00-1, T-00-2, T-00-3 のように）

  フェーズ一覧:

    Phase_0:
      名称: "要件定義"
      ID接頭辞: "T-00"
      目的: |
        タスクの目的、スコープ、受け入れ基準を明文化する。
        複数の要件領域がある場合は、それぞれ独立したサブタスクとして定義する。
      分割基準: |
        - 機能領域ごと（認証、API、UI等）
        - ステークホルダーごと（ユーザー向け、管理者向け等）
        - 非機能要件ごと（パフォーマンス、セキュリティ等）
      成果物: "docs/30-workflows/{{機能名}}/task-step{{N}}-{{要件定義名}}.md 配下の要件ドキュメント"
      参照: ".claude/agents/agent_list.md から要件分析系エージェントを選定"

    Phase_1:
      名称: "設計"
      ID接頭辞: "T-01"
      目的: |
        要件を実現可能な構造に落とし込む。
        設計対象ごとに独立したサブタスクとして定義する。
      分割基準: |
        - 設計領域ごと（アーキテクチャ、API、DB、UI等）
        - コンポーネントごと
        - レイヤーごと（ドメイン、アプリケーション、インフラ等）
      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+1}}-{{設計名}}.md"
      参照: ".claude/agents/agent_list.md から設計系エージェントを選定"

    Phase_2:
      名称: "設計レビューゲート"
      ID接頭辞: "T-02"
      目的: |
        実装開始前に要件・設計の妥当性を複数エージェントで検証する。
        問題を早期発見し、実装フェーズでの手戻りを最小化する。
      背景: |
        設計ミスが実装後に発見されると修正コストが大幅に増加する。
        「Shift Left」原則に基づき、問題を可能な限り早期に検出する。

      レビュー観点:
        要件充足性:
          担当: "@req-analyst"
          チェック項目:
            - "要件が明確かつ検証可能か"
            - "スコープが適切に定義されているか"
            - "受け入れ基準が具体的か"

        アーキテクチャ整合性:
          担当: "@arch-police"
          チェック項目:
            - "クリーンアーキテクチャのレイヤー違反がないか"
            - "依存関係逆転の原則(DIP)が守られているか"
            - "既存設計との整合性があるか"

        ドメインモデル妥当性:
          担当: "@domain-modeler"
          チェック項目:
            - "ユビキタス言語が適切に使用されているか"
            - "エンティティ・値オブジェクトの境界が適切か"
            - "ドメインルールが正しく表現されているか"

        セキュリティ設計:
          担当: "@sec-auditor"
          チェック項目:
            - "セキュリティ上の考慮漏れがないか"
            - "認証・認可の設計が適切か"
            - "データ保護の方針が明確か"

      レビュー結果判定:
        PASS: "全レビュー観点で問題なし → Phase 3へ進行"
        MINOR: "軽微な指摘あり → 指摘対応後Phase 3へ進行"
        MAJOR: "重大な問題あり → 影響範囲に応じて戻り先を決定"

      戻り先決定基準:
        要件の問題: "Phase 0（要件定義）へ戻る"
        設計の問題: "Phase 1（設計）へ戻る"
        両方の問題: "Phase 0（要件定義）へ戻る"

      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+2}}-design-review.md"
      参照: ".claude/agents/agent_list.md から要件・設計・セキュリティ系エージェントを選定"

    Phase_3:
      名称: "テスト作成 (TDD: Red)"
      ID接頭辞: "T-03"
      目的: |
        期待される動作を検証するテストを実装より先に作成する。
        テスト対象の機能・レイヤーごとにサブタスクを分割する。
      分割基準: |
        - テスト種別ごと（ユニット、統合、E2E等）
        - 機能ごと
        - レイヤーごと（フロントエンド、バックエンド等）
      検証: "テストを実行してRed（失敗）を確認"
      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+3}}-{{テスト設計名}}.md"
      参照: ".claude/agents/agent_list.md からテスト系エージェントを選定"

    Phase_4:
      名称: "実装 (TDD: Green)"
      ID接頭辞: "T-04"
      目的: |
        テストを通すための最小限の実装を行う。
        実装対象の機能・レイヤーごとにサブタスクを分割する。
      分割基準: |
        - 機能ごと
        - レイヤーごと（フロントエンド、バックエンド、インフラ等）
        - コンポーネントごと
      検証: "テストを実行してGreen（成功）を確認"
      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+4}}-{{実装名}}.md"
      参照: ".claude/agents/agent_list.md から実装系エージェントを選定"

    Phase_5:
      名称: "リファクタリング (TDD: Refactor)"
      ID接頭辞: "T-05"
      目的: |
        動作を変えずにコード品質を改善する。
        改善対象の領域ごとにサブタスクを分割する。
      分割基準: |
        - 改善領域ごと（命名、構造、重複排除等）
        - レイヤーごと
        - コンポーネントごと
      検証: "テストを再実行して継続成功を確認"
      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+5}}-{{リファクタリング名}}.md"
      参照: ".claude/agents/agent_list.md から品質系エージェントを選定"

    Phase_6:
      名称: "品質保証"
      ID接頭辞: "T-06"
      目的: |
        定義された品質基準をすべて満たすことを検証する。
        検証領域ごとにサブタスクを分割する。
      分割基準: |
        - 検証種別ごと（テスト実行、Lint、型チェック、セキュリティ等）
      品質ゲート:
        - "機能検証: 自動テストの完全成功"
        - "コード品質: Lint/型チェッククリア"
        - "テスト網羅性: カバレッジ基準達成"
        - "セキュリティ: 重大な脆弱性の不在"
      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+6}}-{{レポート名}}.md"
      参照: ".claude/agents/agent_list.md からQA/セキュリティ系エージェントを選定"

    Phase_7:
      名称: "最終レビューゲート"
      ID接頭辞: "T-07"
      目的: |
        実装完了後、ドキュメント更新前に全体的な品質・整合性を検証する。
        複数の専門エージェントによる多角的レビューで見落としを防ぐ。
      背景: |
        Phase 6の自動検証だけでは検出できない設計判断や
        ベストプラクティス違反を人間的視点で確認する。

      レビュー観点:
        コード品質:
          担当: "@code-quality"
          チェック項目:
            - "コーディング規約への準拠"
            - "可読性・保守性の確保"
            - "適切なエラーハンドリング"
            - "過度な複雑性の有無"

        アーキテクチャ遵守:
          担当: "@arch-police"
          チェック項目:
            - "実装がアーキテクチャ設計に従っているか"
            - "レイヤー間の依存関係が適切か"
            - "SOLID原則への準拠"

        テスト品質:
          担当: "@unit-tester"
          チェック項目:
            - "テストカバレッジが十分か"
            - "テストケースが適切に設計されているか"
            - "境界値・異常系のテストがあるか"
            - "テストの可読性・保守性"

        セキュリティ:
          担当: "@sec-auditor"
          チェック項目:
            - "OWASP Top 10への対応"
            - "入力検証・サニタイズの実装"
            - "認証・認可の適切な実装"
            - "機密情報の適切な取り扱い"

        パフォーマンス:
          担当: "@sre-observer"
          チェック項目:
            - "N+1問題等のパフォーマンス問題の有無"
            - "適切なログ出力の実装"
            - "監視・メトリクス収集の準備"

        未完了タスク指示書作成:
          担当: "レビューで発見した課題に最適なエージェントを選定"
          説明: |
            レビューで発見されたMINOR指摘やスコープ外の改善点を
            未完了タスクとして記録する。各課題の性質に応じて
            最適なエージェントを選定し、そのエージェントが
            「100人中100人が実行可能な品質」の指示書を作成する。

          エージェント選定基準:
            セキュリティ課題: "@sec-auditor, @electron-security"
            アーキテクチャ課題: "@arch-police"
            コード品質課題: "@code-quality"
            テスト課題: "@unit-tester, @e2e-tester"
            パフォーマンス課題: "@sre-observer"
            UI/UX課題: "@ui-designer"
            API課題: "@api-doc-writer"
            データベース課題: "@db-architect"
            要件課題: "@req-analyst"
            仕様書作成: "@spec-writer"

          作成フロー:
            1. "レビューで課題を発見"
            2. "課題の性質を分類（セキュリティ/アーキテクチャ/品質等）"
            3. "課題に最適なエージェントを選定"
            4. "選定されたエージェントが指示書を作成"
            5. "@spec-writerが指示書の品質を検証"

          指示書品質チェック項目:
            - "Why（なぜ必要か）が明確に記述されているか"
            - "What（何を達成するか）が具体的に定義されているか"
            - "How（どのように実行するか）が詳細に説明されているか"
            - "Claude Codeスラッシュコマンド（/ai:xxx形式）・エージェント・スキルが選定されているか"
            - "完了条件が検証可能な形で定義されているか"
            - "前提条件・依存関係が明記されているか"
            - "テストケース/検証方法が記載されているか"
            - "リスクと対策が検討されているか"

          出力規則:
            出力先: "docs/30-workflows/unassigned-task/"
            命名規則:
              要件系: "requirements-{{機能領域}}.md"
              改善系: "task-{{改善領域}}-improvements.md"

      対象領域別追加レビュー:
        フロントエンド:
          担当: "@ui-designer, @frontend-tester"
          チェック項目:
            - "アクセシビリティ(WCAG)への準拠"
            - "レスポンシブデザインの実装"
            - "ユーザビリティの確保"

        バックエンドAPI:
          担当: "@api-doc-writer"
          チェック項目:
            - "API設計の一貫性"
            - "エラーレスポンスの適切性"
            - "バージョニング戦略"

        データベース:
          担当: "@db-architect, @dba-mgr"
          チェック項目:
            - "スキーマ設計の妥当性"
            - "インデックス設計の適切性"
            - "マイグレーションの安全性"

        Electron:
          担当: "@electron-security"
          チェック項目:
            - "IPC通信のセキュリティ"
            - "CSP設定の適切性"
            - "自動更新機能の安全性"

      レビュー結果判定:
        PASS: "全レビュー観点で問題なし → Phase 8へ進行"
        MINOR: "軽微な指摘あり → 指摘対応後Phase 8へ進行（Phase 5内で修正可能）"
        MAJOR: "重大な問題あり → 影響範囲に応じて戻り先を決定"
        CRITICAL: "致命的な問題あり → Phase 0へ戻りユーザーと要件を再確認"

      戻り先決定基準:
        要件の問題: "Phase 0（要件定義）へ戻る"
        設計の問題: "Phase 1（設計）へ戻る"
        テスト設計の問題: "Phase 3（テスト作成）へ戻る"
        実装の問題: "Phase 4（実装）へ戻る"
        コード品質の問題: "Phase 5（リファクタリング）へ戻る"

      エスカレーション条件:
        - "戻り先の判断が困難な場合"
        - "複数フェーズにまたがる問題の場合"
        - "要件自体の見直しが必要な場合"
        手順: "ユーザーに問題を報告し、戻り先と対応方針を協議する"

      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+7}}-final-review.md"
      参照: ".claude/agents/agent_list.md からQA/セキュリティ/対象領域別エージェントを選定"

    Phase_8:
      名称: "手動テスト検証"
      ID接頭辞: "T-08"
      目的: |
        自動テストでは検証できないユーザー体験・UI/UX・実環境動作を
        手動で確認し、実際のユーザー視点での品質を担保する。
      背景: |
        自動テストはロジックの正しさを検証するが、以下は手動確認が必要：
        - 実際のユーザー操作フロー
        - 視覚的なUI/UXの確認
        - 外部サービスとの実際の連携
        - エッジケースやコーナーケース
        - パフォーマンスの体感確認

      手動テスト分類:
        機能テスト:
          説明: "実装した機能が要件通りに動作するか確認"
          観点:
            - "正常系: 期待通りの入力で期待通りの結果が得られるか"
            - "異常系: 不正な入力や操作に対して適切にエラー処理されるか"
            - "境界値: 上限/下限値での動作は正常か"
            - "状態遷移: 各状態間の遷移は正しく行われるか"

        UI/UXテスト:
          説明: "ユーザーインターフェースの使いやすさ・視覚的正しさを確認"
          観点:
            - "レイアウト: 要素の配置は適切か、崩れはないか"
            - "レスポンシブ: 各画面サイズで正しく表示されるか"
            - "フィードバック: 操作結果がユーザーに適切に伝わるか"
            - "エラー表示: エラーメッセージは分かりやすいか"
            - "ローディング: 処理中の表示は適切か"

        統合テスト:
          説明: "外部サービス・他コンポーネントとの連携を確認"
          観点:
            - "API連携: 外部APIとの通信は正常か"
            - "認証連携: OAuth等の認証フローは正常か"
            - "データ永続化: DBへの保存・読み込みは正常か"
            - "ファイル操作: アップロード・ダウンロードは正常か"

        リグレッションテスト:
          説明: "既存機能への影響がないことを確認"
          観点:
            - "既存機能: 変更前と同様に動作するか"
            - "関連機能: 関連する機能に影響はないか"

      テストケーステンプレート:
        説明: |
          各テストケースは以下の形式で記述する。
          テスト実行者が迷わず実行できる粒度で記述すること。

        形式: |
          | No | カテゴリ | テスト項目 | 前提条件 | 操作手順 | 期待結果 | 実行結果 | 備考 |
          |----|----------|-----------|----------|----------|----------|----------|------|

      成果物: "docs/30-workflows/{{機能名}}/task-step{{N+8}}-manual-test.md"
      参照: ".claude/agents/agent_list.md からQA系エージェントを選定"

      完了条件:
        - "すべての手動テストケースが実行済み"
        - "すべてのテストケースがPASS（または既知の問題として記録）"
        - "発見された不具合が修正済みまたは未完了タスクとして記録済み"

    Phase_9:
      名称: "ドキュメント更新・未完了タスク記録"
      ID接頭辞: "T-09"
      目的: |
        1. タスク完了後、実装した内容をシステム要件ドキュメントに反映する
        2. レビューで発見された未完了タスク・追加タスクを記録する
      前提条件: |
        - Phase 6の品質ゲートをすべて通過していること
        - Phase 7の最終レビューゲートを通過していること
        - Phase 8の手動テストが完了していること
        - すべてのテストが成功していること

      サブフェーズ:
        Phase_9_1:
          名称: "システムドキュメント更新"
          更新対象: "docs/00-requirements/ 配下の関連ドキュメント"
          更新原則:
            - "概要のみ記載（詳細な実装説明は不要）"
            - "システム構築に必要十分な情報のみ追記"
            - "既存ドキュメントの構造・フォーマットを維持"
            - "Single Source of Truth原則を遵守（重複記載禁止）"
          更新判断基準: |
            以下の場合にドキュメント更新が必要：

            【概要・目的の変更】
            - プロジェクト概要・ビジョンの変更 → 01-overview.md
            - システム全体設計の変更 → master_system_design.md

            【非機能要件の変更】
            - パフォーマンス要件の変更 → 02-non-functional-requirements.md
            - セキュリティ要件の変更 → 02-non-functional-requirements.md
            - 可用性・信頼性要件の変更 → 02-non-functional-requirements.md
            - スケーラビリティ要件の変更 → 02-non-functional-requirements.md

            【技術スタックの変更】
            - 新しいライブラリ/フレームワークの追加 → 03-technology-stack.md
            - 依存関係の変更 → 03-technology-stack.md
            - ビルドツール/開発ツールの変更 → 03-technology-stack.md

            【構造・アーキテクチャの変更】
            - ディレクトリ構造の変更 → 04-directory-structure.md
            - 新しいエンティティ/テーブルの追加 → 05-architecture.md
            - レイヤー構造の変更 → 05-architecture.md
            - コンポーネント間依存関係の変更 → 05-architecture.md

            【インターフェースの変更】
            - コアインターフェースの追加/変更 → 06-core-interfaces.md
            - 型定義の追加/変更 → 06-core-interfaces.md

            【エラーハンドリングの変更】
            - エラーコードの追加 → 07-error-handling.md
            - エラーハンドリング戦略の変更 → 07-error-handling.md

            【APIの変更】
            - 新しいAPIエンドポイントの追加 → 08-api-design.md
            - APIレスポンス形式の変更 → 08-api-design.md
            - 認証/認可フローの変更 → 08-api-design.md

            【エージェント機能の変更】
            - ローカルエージェント機能の追加/変更 → 09-local-agent.md
            - エージェント間通信の変更 → 09-local-agent.md

            【Discord Bot機能の変更】
            - Botコマンドの追加/変更 → 10-discord-bot.md
            - Bot連携機能の変更 → 10-discord-bot.md

            【プラグインの変更】
            - 新しい機能プラグインの追加 → 11-plugin-development.md
            - プラグインAPIの変更 → 11-plugin-development.md

            【デプロイメントの変更】
            - デプロイ手順の変更 → 12-deployment.md
            - インフラ構成の変更 → 12-deployment.md
            - CI/CDパイプラインの変更 → 12-deployment.md

            【環境変数の変更】
            - 新しい環境変数の追加 → 13-environment-variables.md
            - 環境変数の削除/変更 → 13-environment-variables.md

            【ワークフローの変更】
            - タスクワークフローの変更 → 14-task-workflow-specification.md
            - 状態遷移の変更 → 14-task-workflow-specification.md

            【データベースの変更】
            - テーブル/スキーマの追加/変更 → 15-database-design.md
            - インデックス設計の変更 → 15-database-design.md
            - マイグレーション戦略の変更 → 15-database-design.md

            【UI/UXの変更】
            - UIコンポーネントの追加 → 16-ui-ux-guidelines.md
            - デザインシステムの変更 → 16-ui-ux-guidelines.md
            - アクセシビリティ対応の変更 → 16-ui-ux-guidelines.md

            【セキュリティの変更】
            - セキュリティポリシーの変更 → 17-security-guidelines.md
            - 認証/認可実装の変更 → 17-security-guidelines.md
            - 脆弱性対策の追加 → 17-security-guidelines.md

            【用語の変更】
            - 新しい用語の追加 → 99-glossary.md
            - ユビキタス言語の変更 → 99-glossary.md

          実行コマンド: "/ai:update-all-docs"

        Phase_9_2:
          名称: "未完了タスク・追加タスク記録"
          出力先: "docs/30-workflows/unassigned-task/"
          目的: |
            レビューで発見された未対応の課題や、スコープ外だが将来対応が必要な
            タスクを、誰でも実行可能な粒度でドキュメント化する。
          ファイル命名規則:
            要件系: "requirements-{{機能領域}}.md"
            改善系: "task-{{改善領域}}-improvements.md"
          記録基準: |
            以下のいずれかに該当する場合に記録する：
            - Phase 7レビューでMINOR判定された未対応項目
            - Phase 8手動テストで発見されたが今回スコープ外の改善点
            - 将来的に必要となる拡張機能
            - 技術的負債として認識された項目
          品質基準: |
            100人中100人が同じ理解でタスクを実行できる粒度で記述する。
            AIがタスクの性質に応じて最適な情報を動的に生成する。

      成果物:
        - "docs/00-requirements/ 配下の更新されたドキュメント"
        - "docs/30-workflows/unassigned-task/ 配下の未完了タスクドキュメント"
      参照: ".claude/agents/agent_list.md からtechnical-writer, spec-writerエージェントを選定"

# =============================================================================
# Layer 6: 出力テンプレート
# =============================================================================
出力テンプレート:

  ファイル配置: "docs/30-workflows/{{機能名}}/task-step{{N}}-{{機能名}}.md"

  未完了タスクテンプレート:
    ファイル配置: "docs/30-workflows/unassigned-task/{{ファイル名}}.md"
    説明: |
      このテンプレートは「指示書」として機能する。
      受け手（人間またはAI）がこのドキュメントを読むだけで、
      タスクの全体像を理解し、具体的なアクションを実行できる粒度で記述する。
      100人中100人が同じ理解でタスクを実行できることを目標とする。

      具体的な内容はAIがタスクの性質に応じて変数に代入する。

    テンプレート: |
      # {{タスク名}} - タスク指示書

      ## メタ情報

      | 項目 | 内容 |
      |------|------|
      | タスクID | {{タスクID}} |
      | タスク名 | {{タスク名}} |
      | 分類 | {{要件/改善/バグ修正/リファクタリング/セキュリティ/パフォーマンス}} |
      | 対象機能 | {{対象機能}} |
      | 優先度 | {{高/中/低}} |
      | 見積もり規模 | {{大規模/中規模/小規模}} |
      | ステータス | 未実施 |
      | 発見元 | {{発見元フェーズ}} |
      | 発見日 | {{YYYY-MM-DD}} |
      | 発見エージェント | {{エージェント名}} |

      ---

      ## 1. なぜこのタスクが必要か（Why）

      ### 1.1 背景
      {{このタスクが必要になった背景・コンテキスト}}

      ### 1.2 問題点・課題
      {{現状の問題点や解決すべき課題}}

      ### 1.3 放置した場合の影響
      {{このタスクを実施しない場合に起こりうる問題}}

      ---

      ## 2. 何を達成するか（What）

      ### 2.1 目的
      {{このタスクで達成すべき具体的な目的}}

      ### 2.2 最終ゴール
      {{達成すべき具体的な最終状態}}

      ### 2.3 スコープ
      #### 含むもの
      {{スコープ内の項目}}

      #### 含まないもの
      {{スコープ外の項目}}

      ### 2.4 成果物
      {{このタスク完了時に生成される成果物一覧}}

      ---

      ## 3. どのように実行するか（How）

      ### 3.1 前提条件
      {{このタスクを開始する前に満たすべき条件}}

      ### 3.2 依存タスク
      {{先に完了している必要があるタスク}}

      ### 3.3 必要な知識・スキル
      {{このタスクを実行するために必要な技術的知識}}

      ### 3.4 推奨アプローチ
      {{推奨される実装アプローチの概要}}

      ---

      ## 4. 実行手順

      ### Phase構成
      ```
      {{フェーズ構成の概要}}
      ```

      {{#each フェーズ}}
      ### Phase {{番号}}: {{フェーズ名}}

      #### 目的
      {{このフェーズの目的}}

      #### Claude Code スラッシュコマンド
      > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

      ```
      {{スラッシュコマンド}}
      ```
      - **参照**: `.claude/commands/ai/command_list.md`

      #### 使用エージェント
      - **エージェント**: {{エージェント名}}
      - **選定理由**: {{選定理由}}
      - **参照**: `.claude/agents/agent_list.md`

      #### 活用スキル
      | スキル名 | 活用方法 |
      |----------|----------|
      {{スキル一覧}}
      - **参照**: `.claude/skills/skill_list.md`

      #### 成果物
      {{このフェーズの成果物}}

      #### 完了条件
      {{このフェーズの完了条件}}

      ---
      {{/each}}

      ## 5. 完了条件チェックリスト

      ### 機能要件
      {{機能要件の完了条件チェックリスト}}

      ### 品質要件
      {{品質要件の完了条件チェックリスト}}

      ### ドキュメント要件
      {{ドキュメント要件の完了条件チェックリスト}}

      ---

      ## 6. 検証方法

      ### テストケース
      {{実施すべきテストケース}}

      ### 検証手順
      {{完了を確認するための検証手順}}

      ---

      ## 7. リスクと対策

      | リスク | 影響度 | 発生確率 | 対策 |
      |--------|--------|----------|------|
      {{リスク一覧}}

      ---

      ## 8. 参照情報

      ### 関連ドキュメント
      {{関連するドキュメントへのリンク}}

      ### 参考資料
      {{参考となる外部資料やリンク}}

      ---

      ## 9. 備考

      ### レビュー指摘の原文（該当する場合）
      ```
      {{レビュー指摘の原文}}
      ```

      ### 補足事項
      {{その他の補足情報}}

  テンプレート: |
    # {{機能名}} - タスク実行仕様書

    ## ユーザーからの元の指示
    ```
    {{ユーザーの元の指示文をそのまま記載}}
    ```

    ## メタ情報

    | 項目 | 内容 |
    |------|------|
    | タスクID | {{タスクID}} |
    | タスク名 | {{タスク名}} |
    | 分類 | {{要件/改善/バグ修正/リファクタリング/セキュリティ/パフォーマンス}} |
    | 対象機能 | {{対象機能}} |
    | 優先度 | {{高/中/低}} |
    | 見積もり規模 | {{大規模/中規模/小規模}} |
    | ステータス | 未実施 |
    | 発見元 | {{発見元フェーズ}} |
    | 発見日 | {{YYYY-MM-DD}} |
    | 発見エージェント | {{エージェント名}} |

    ---

    ## タスク概要

    ### 目的
    {{このタスクで達成すべき目的を詳細に記述}}

    ### 背景
    {{このタスクが必要になった背景・コンテキストを詳細に記述}}

    ### 最終ゴール
    {{達成すべき具体的な最終状態}}

    ### 成果物一覧
    | 種別 | 成果物 | 配置先 |
    |------|--------|--------|
    | 機能 | {{機能成果物}} | {{パス}} |
    | ドキュメント | {{ドキュメント成果物}} | {{パス}} |
    | 品質 | {{テスト・品質レポート}} | {{パス}} |

    ---

    ## 参照ファイル

    本仕様書のコマンド・エージェント・スキル選定は以下を参照：
    - `docs/00-requirements/master_system_design.md` - システム要件
    - `.claude/commands/ai/command_list.md` - /ai:コマンド定義
    - `.claude/agents/agent_list.md` - エージェント定義
    - `.claude/skills/skill_list.md` - スキル定義

    ---

    ## タスク分解サマリー

    | ID | フェーズ | サブタスク名 | 責務 | 依存 |
    |----|----------|--------------|------|------|
    {{#each サブタスク}}
    | {{ID}} | {{フェーズ}} | {{名称}} | {{責務}} | {{依存}} |
    {{/each}}

    **総サブタスク数**: {{サブタスク数}}個

    ---

    ## 実行フロー図

    ```mermaid
    graph TD
        {{#each フローノード}}
        {{ノード定義}}
        {{/each}}

        {{#each フロー接続}}
        {{接続定義}}
        {{/each}}
    ```

    ---

    ## Phase 0: 要件定義

    {{#each Phase0サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### 責務（単一責務）
    {{このサブタスクが担う唯一の責務}}

    #### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 活用スキル
    | スキル名 | 活用方法 |
    |----------|----------|
    {{#each スキル}}
    | {{スキル名}} | {{活用方法}} |
    {{/each}}
    - **参照**: `.claude/skills/skill_list.md`

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 1: 設計

    {{#each Phase1サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### 責務（単一責務）
    {{このサブタスクが担う唯一の責務}}

    #### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 活用スキル
    | スキル名 | 活用方法 |
    |----------|----------|
    {{#each スキル}}
    | {{スキル名}} | {{活用方法}} |
    {{/each}}
    - **参照**: `.claude/skills/skill_list.md`

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 2: 設計レビューゲート

    {{#each 設計レビューサブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### レビュー参加エージェント
    | エージェント | レビュー観点 | 選定理由 |
    |-------------|-------------|----------|
    {{#each 参加エージェント}}
    | {{エージェント名}} | {{レビュー観点}} | {{選定理由}} |
    {{/each}}
    - **参照**: `.claude/agents/agent_list.md`

    #### レビューチェックリスト
    {{#each レビュー観点}}
    **{{観点名}}** ({{担当エージェント}})
    {{#each チェック項目}}
    - [ ] {{項目}}
    {{/each}}
    {{/each}}

    #### レビュー結果
    - **判定**: {{判定結果}}
    - **指摘事項**: {{指摘内容}}
    - **対応方針**: {{対応内容}}

    #### 戻り先決定（MAJORの場合）
    | 問題の種類 | 戻り先 |
    |-----------|--------|
    {{#each 戻り先基準}}
    | {{問題種類}} | {{戻り先フェーズ}} |
    {{/each}}

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 3: テスト作成 (TDD: Red)

    {{#each Phase3サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### 責務（単一責務）
    {{このサブタスクが担う唯一の責務}}

    #### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 活用スキル
    | スキル名 | 活用方法 |
    |----------|----------|
    {{#each スキル}}
    | {{スキル名}} | {{活用方法}} |
    {{/each}}
    - **参照**: `.claude/skills/skill_list.md`

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### TDD検証: Red状態確認
    ```bash
    {{テスト実行コマンド}}
    ```
    - [ ] テストが失敗することを確認（Red状態）

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 4: 実装 (TDD: Green)

    {{#each Phase4サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### 責務（単一責務）
    {{このサブタスクが担う唯一の責務}}

    #### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 活用スキル
    | スキル名 | 活用方法 |
    |----------|----------|
    {{#each スキル}}
    | {{スキル名}} | {{活用方法}} |
    {{/each}}
    - **参照**: `.claude/skills/skill_list.md`

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### TDD検証: Green状態確認
    ```bash
    {{テスト実行コマンド}}
    ```
    - [ ] テストが成功することを確認（Green状態）

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 5: リファクタリング (TDD: Refactor)

    {{#each Phase5サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### 責務（単一責務）
    {{このサブタスクが担う唯一の責務}}

    #### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 活用スキル
    | スキル名 | 活用方法 |
    |----------|----------|
    {{#each スキル}}
    | {{スキル名}} | {{活用方法}} |
    {{/each}}
    - **参照**: `.claude/skills/skill_list.md`

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### TDD検証: 継続Green確認
    ```bash
    {{テスト実行コマンド}}
    ```
    - [ ] リファクタリング後もテストが成功することを確認

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 6: 品質保証

    {{#each Phase6サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### 責務（単一責務）
    {{このサブタスクが担う唯一の責務}}

    #### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 活用スキル
    | スキル名 | 活用方法 |
    |----------|----------|
    {{#each スキル}}
    | {{スキル名}} | {{活用方法}} |
    {{/each}}
    - **参照**: `.claude/skills/skill_list.md`

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## 品質ゲートチェックリスト


    ### 機能検証
    - [ ] 全ユニットテスト成功
    - [ ] 全統合テスト成功
    - [ ] 全E2Eテスト成功

    ### コード品質
    - [ ] Lintエラーなし
    - [ ] 型エラーなし
    - [ ] コードフォーマット適用済み

    ### テスト網羅性
    - [ ] カバレッジ基準達成

    ### セキュリティ
    - [ ] 脆弱性スキャン完了
    - [ ] 重大な脆弱性なし

    ---

    ## Phase 7: 最終レビューゲート

    {{#each 最終レビューサブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### レビュー参加エージェント
    | エージェント | レビュー観点 | 選定理由 |
    |-------------|-------------|----------|
    {{#each 参加エージェント}}
    | {{エージェント名}} | {{レビュー観点}} | {{選定理由}} |
    {{/each}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 対象領域別追加レビュー（該当する場合のみ）
    {{#if 追加レビュー}}
    | 対象領域 | エージェント | レビュー観点 |
    |---------|-------------|-------------|
    {{#each 追加レビュー}}
    | {{対象領域}} | {{エージェント名}} | {{レビュー観点}} |
    {{/each}}
    {{/if}}

    #### レビューチェックリスト
    {{#each レビュー観点}}
    **{{観点名}}** ({{担当エージェント}})
    {{#each チェック項目}}
    - [ ] {{項目}}
    {{/each}}
    {{/each}}

    #### 未完了タスク指示書作成（該当する場合）

    {{#if 未完了タスク}}
    ##### 発見された課題と担当エージェント
    | 課題ID | 課題名 | 分類 | 担当エージェント | 選定理由 |
    |--------|--------|------|------------------|----------|
    {{#each 未完了タスク}}
    | {{課題ID}} | {{課題名}} | {{分類}} | {{担当エージェント}} | {{選定理由}} |
    {{/each}}

    ##### 指示書作成フロー
    1. 各担当エージェントが課題に対する指示書を作成
    2. @spec-writerが指示書の品質を検証
    3. 品質基準を満たさない場合は担当エージェントが修正

    ##### 指示書出力先
    `docs/30-workflows/unassigned-task/`

    ##### 各課題の指示書概要
    {{#each 未完了タスク指示書}}
    ###### {{課題ID}}: {{課題名}}
    - **担当エージェント**: {{担当エージェント}}
    - **出力ファイル**: {{出力ファイルパス}}
    - **Why（なぜ必要か）**: {{背景概要}}
    - **What（何を達成するか）**: {{目的概要}}
    - **How（どのように実行するか）**: {{実行方針概要}}
    {{/each}}

    ##### 指示書品質検証結果
    | 課題ID | Why | What | How | スラッシュコマンド | 完了条件 | 検証方法 | 判定 |
    |--------|-----|------|-----|-------------------|----------|----------|------|
    {{#each 指示書品質検証}}
    | {{課題ID}} | {{Why}} | {{What}} | {{How}} | {{スラッシュコマンド}} | {{完了条件}} | {{検証方法}} | {{判定}} |
    {{/each}}
    {{/if}}

    #### レビュー結果
    - **判定**: {{判定結果}}
    - **指摘事項**: {{指摘内容}}
    - **対応方針**: {{対応内容}}
    - **未完了タスク数**: {{未完了タスク数}}件

    #### 戻り先決定（MAJOR/CRITICALの場合）
    | 問題の種類 | 戻り先 |
    |-----------|--------|
    {{#each 戻り先基準}}
    | {{問題種類}} | {{戻り先フェーズ}} |
    {{/each}}

    #### エスカレーション条件
    {{#each エスカレーション条件}}
    - {{条件}}
    {{/each}}

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 8: 手動テスト検証

    {{#each 手動テストサブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的の詳細説明}}

    #### 背景
    {{このサブタスクが必要な背景}}

    #### テスト分類
    {{テスト分類: 機能テスト/UI・UXテスト/統合テスト/リグレッションテスト}}

    #### 使用エージェント
    - **エージェント**: {{エージェント名}}
    - **選定理由**: {{選定理由}}
    - **参照**: `.claude/agents/agent_list.md`

    #### 手動テストケース

    | No | カテゴリ | テスト項目 | 前提条件 | 操作手順 | 期待結果 | 実行結果 | 備考 |
    |----|----------|-----------|----------|----------|----------|----------|------|
    {{#each テストケース}}
    | {{No}} | {{カテゴリ}} | {{テスト項目}} | {{前提条件}} | {{操作手順}} | {{期待結果}} | {{実行結果}} | {{備考}} |
    {{/each}}

    #### テスト実行手順
    {{#each テスト実行手順}}
    {{番号}}. {{手順}}
    {{/each}}

    #### 成果物
    | 成果物 | パス | 内容 |
    |--------|------|------|
    {{#each 成果物}}
    | {{名称}} | {{パス}} | {{内容}} |
    {{/each}}

    #### 完了条件
    {{#each 完了条件}}
    - [ ] {{条件}}
    {{/each}}

    #### 依存関係
    - **前提**: {{前提サブタスク}}
    - **後続**: {{後続サブタスク}}

    ---
    {{/each}}

    ## Phase 9: ドキュメント更新・未完了タスク記録

    {{#each Phase9サブタスク}}
    ### {{ID}}: {{名称}}

    #### 目的
    {{目的}}

    #### 前提条件
    - [ ] Phase 6の品質ゲートをすべて通過
    - [ ] Phase 7の最終レビューゲートを通過
    - [ ] Phase 8の手動テストが完了
    - [ ] すべてのテストが成功

    ---

    #### サブタスク 9.1: システムドキュメント更新

    ##### 更新対象ドキュメント
    {{更新対象ドキュメント}}

    ##### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    /ai:update-all-docs
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    ##### 使用エージェント
    {{エージェント情報}}

    ##### 更新原則
    - 概要のみ記載（詳細な実装説明は不要）
    - システム構築に必要十分な情報のみ追記
    - 既存ドキュメントの構造・フォーマットを維持
    - Single Source of Truth原則を遵守

    ---

    #### サブタスク 9.2: 未完了タスク・追加タスク記録

    ##### 出力先
    `docs/30-workflows/unassigned-task/`

    ##### 記録対象タスク一覧
    {{記録対象タスク一覧}}

    ##### ファイル命名規則
    - 要件系: `requirements-{{機能領域}}.md`
    - 改善系: `task-{{改善領域}}-improvements.md`

    ##### Claude Code スラッシュコマンド
    > ⚠️ 以下はターミナルコマンドではなく、Claude Code内で実行するスラッシュコマンドです

    ```
    {{スラッシュコマンド}}
    ```
    - **参照**: `.claude/commands/ai/command_list.md`

    ##### 使用エージェント
    {{エージェント情報}}

    ##### 活用スキル
    {{スキル情報}}

    ##### 指示書としての品質基準
    生成されるタスク指示書は以下を満たすこと：

    **Why（なぜ必要か）**
    - [ ] 背景が明確に記述されている
    - [ ] 問題点・課題が具体的に説明されている
    - [ ] 放置した場合の影響が記載されている

    **What（何を達成するか）**
    - [ ] 目的が明確に定義されている
    - [ ] 最終ゴールが具体的に記述されている
    - [ ] スコープ（含む/含まない）が明記されている
    - [ ] 成果物が一覧化されている

    **How（どのように実行するか）**
    - [ ] 前提条件が明記されている
    - [ ] 依存タスクが特定されている
    - [ ] 必要な知識・スキルが記載されている
    - [ ] 推奨アプローチが説明されている

    **実行手順**
    - [ ] フェーズ構成が明確である
    - [ ] 各フェーズにClaude Codeスラッシュコマンド（/ai:xxx形式）が記載されている
    - [ ] 使用エージェント・スキルが選定されている
    - [ ] 各フェーズの成果物・完了条件が定義されている

    **検証・完了**
    - [ ] 完了条件チェックリストがある
    - [ ] テストケース/検証方法が記載されている
    - [ ] リスクと対策が検討されている

    ##### 各タスクの詳細
    {{各タスク詳細}}

    ---

    #### 完了条件
    {{完了条件}}

    ---
    {{/each}}

    ## リスクと対策

    | リスク | 影響度 | 発生確率 | 対策 | 対応サブタスク |
    |--------|--------|----------|------|----------------|
    {{#each リスク}}
    | {{リスク内容}} | {{影響度}} | {{確率}} | {{対策}} | {{対応ID}} |
    {{/each}}

    ---

    ## 前提条件

    {{#each 前提条件}}
    - {{条件}}
    {{/each}}

    ---

    ## 備考

    ### 技術的制約
    {{#each 技術的制約}}
    - {{制約}}
    {{/each}}

    ### 参考資料
    {{#each 参考資料}}
    - {{資料}}
    {{/each}}

# =============================================================================
# Layer 7: 実行ルール
# =============================================================================
実行ルール:

  必須事項:
    - "ユーザーからの元の指示文を必ず冒頭に記載する"
    - "各サブタスクの目的・背景を詳細に記述する"
    - "Phase 0（要件定義）は必ず含める"
    - "Phase 2（設計レビューゲート）は必ず含める"
    - "TDDサイクル（Phase 3→4→5）は必ず含める"
    - "品質ゲート（Phase 6）は必ず含める"
    - "Phase 7（最終レビューゲート）は必ず含める"
    - "Phase 8（手動テスト検証）は必ず含める"
    - "ドキュメント更新・未完了タスク記録（Phase 9）は必ず含める"
    - "各フェーズ内でも単一責務で複数サブタスクに分割する"
    - "スラッシュコマンド・エージェント・スキルは参照ファイルから選定する"
    - "各スラッシュコマンドは/ai:プレフィックス付きのClaude Code形式で記述する（ターミナルコマンドではない）"
    - "docs/00-requirements/master_system_design.md の「ディレクトリ構造」を遵守する"
    - "レビューで問題発見時は影響範囲に応じた適切なフェーズへ戻る"
    - "未完了タスクはdocs/30-workflows/unassigned-task/に記録する"
    - "未完了タスクは100人中100人が実行可能な粒度で記述する"

  禁止事項:
    - "具体的なソースコードの作成"
    - "Phase 0をスキップする"
    - "レビューゲート（Phase 2, 7）をスキップする"
    - "手動テスト（Phase 8）をスキップする"
    - "テストより先に実装する"
    - "品質ゲート未通過でPhase 9に進む"
    - "レビューゲート未通過で次フェーズに進む"
    - "Phase 9をスキップする"
    - "TDDサイクルを逆転させる"
    - "複数の責務を1つのサブタスクに混在させる"
    - "ドキュメントに詳細な実装説明を記載する（概要のみ）"
    - "レビュー指摘を無視して進行する"

  AIへの委任事項:
    - "具体的な技術選択"
    - "実装の詳細設計"
    - "テストケースの具体的な記述"
    - "コード品質メトリクスの具体的な目標値"

# =============================================================================
# 開始トリガー
# =============================================================================
開始トリガー: |
  ユーザーが具体的なタスク内容を提供した時点で、以下のフローで仕様書を生成する：

  1. ユーザーの元の指示を保存（最優先）
  2. 参照ファイルを読み込み、利用可能なコマンド・エージェント・スキルを把握
  3. タスクタイプを特定（新規機能/バグ修正/リファクタリング等）
  4. 各フェーズ内で単一責務に基づいてサブタスクを分解
  5. 各サブタスクに最適なコマンド・エージェント・スキルを選定
  6. 各サブタスクの目的・背景を詳細に記述
  7. 依存関係を整理
  8. テンプレートに従って仕様書を作成

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  参照ファイル:
  - docs/00-requirements/master_system_design.md
  - .claude/commands/command_list.md
  - .claude/agents/agent_list.md
  - .claude/skills/skill_list.md
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ユーザーからのタスクを待機中...
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
