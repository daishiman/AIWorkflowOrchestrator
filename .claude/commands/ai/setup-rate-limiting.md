---
description: |
  APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…ã—ã€
  DoSæ”»æ’ƒã‚„ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’é˜²å¾¡ã—ã¾ã™ã€‚

  ğŸ¤– èµ·å‹•ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:
  - Phase 1-3: `.claude/agents/sec-auditor.md` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–è¨­è¨ˆ
  - Phase 2: `.claude/agents/gateway-dev.md` - APIã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤å®Ÿè£…

  ğŸ“š åˆ©ç”¨å¯èƒ½ã‚¹ã‚­ãƒ«ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‚ç…§ï¼‰:
  **sec-auditorç”¨:**
  - `.claude/skills/rate-limiting/SKILL.md` - Token Bucketã€Leaky Bucketã€Sliding Window
  - `.claude/skills/security-configuration-review/SKILL.md` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒ¬ãƒ“ãƒ¥ãƒ¼

  **gateway-devç”¨:**
  - `.claude/skills/api-client-patterns/SKILL.md` - APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
  - `.claude/skills/retry-strategies/SKILL.md` - ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ã€ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼
  - `.claude/skills/http-best-practices/SKILL.md` - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

  âš™ï¸ ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®è¨­å®š:
  - argument-hint: "[rate-limit]"ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å€¤: 100/hour, 10/minuteç­‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100/hourï¼‰
  - allowed-tools: ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ç”¨
    â€¢ Read: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèªã€æ—¢å­˜è¨­å®šç¢ºèªç”¨
    â€¢ Write: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç”Ÿæˆç”¨
    â€¢ Edit: æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£ç”¨
    â€¢ Bash: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨
  - model: sonnetï¼ˆæ¨™æº–çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ã‚¿ã‚¹ã‚¯ï¼‰

  ğŸ“‹ æˆæœç‰©:
  - `src/middleware/rate-limit.ts`ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰
  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
  - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å®šç¾©

  ğŸ¯ ãƒ¬ãƒ¼ãƒˆåˆ¶é™æˆ¦ç•¥:
  - Token Bucket: ãƒãƒ¼ã‚¹ãƒˆè¨±å®¹å‹
  - Leaky Bucket: å‡ä¸€æµé‡å‹
  - Sliding Window: ç²¾å¯†åˆ¶å¾¡å‹

  ãƒˆãƒªã‚¬ãƒ¼ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: rate limiting, ãƒ¬ãƒ¼ãƒˆåˆ¶é™, throttling, DoSå¯¾ç­–, APIåˆ¶é™
argument-hint: "[rate-limit]"
allowed-tools:
  - Read
  - Write
  - Edit
  - Bash
model: sonnet
---

# /ai:setup-rate-limiting - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…

**ç›®çš„**: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…ã—ã€DoSæ”»æ’ƒã€ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã€APIã®éå‰°ä½¿ç”¨ã‚’é˜²å¾¡ã—ã¾ã™ã€‚

**ãƒˆãƒªã‚¬ãƒ¼ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: rate limiting, ãƒ¬ãƒ¼ãƒˆåˆ¶é™, throttling, DoSå¯¾ç­–, ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–, APIåˆ¶é™, ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™, æµé‡åˆ¶å¾¡

---

## ğŸ“‹ å¼•æ•°ä»•æ§˜

- **$1 (rate-limit)**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™å€¤
  - å½¢å¼: `<æ•°å€¤>/<å˜ä½>`
  - å˜ä½: `second`, `minute`, `hour`, `day`
  - ä¾‹: `100/hour`, `10/minute`, `1000/day`
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `100/hour`

**ä½¿ç”¨ä¾‹**:

```bash
/ai:setup-rate-limiting
/ai:setup-rate-limiting 10/minute
/ai:setup-rate-limiting 1000/day
/ai:setup-rate-limiting 5/second
```

---

## ğŸ¯ å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼ˆ3ãƒ•ã‚§ãƒ¼ã‚ºæ§‹é€ ï¼‰

### Phase 1: æº–å‚™ãƒ»è¦ä»¶åˆ†æ

**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•**:

```
`.claude/agents/sec-auditor.md` ã¨ `.claude/agents/gateway-dev.md` ã‚’èµ·å‹•ã—ã€ä»¥ä¸‹ã‚’ä¾é ¼:
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™å€¤: $1 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100/hour)
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®åˆ†æï¼ˆNext.js/Express/Fastifyç­‰ï¼‰
- æ—¢å­˜ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ã®ç¢ºèª
- ä¿è­·å¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç‰¹å®š
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™æˆ¦ç•¥ã®é¸å®š
```

**ã‚¹ã‚­ãƒ«å‚ç…§** (Phase 1):

- `.claude/skills/project-architecture-integration/SKILL.md`: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç†è§£
- `.claude/skills/rate-limiting-strategies/SKILL.md`: ãƒ¬ãƒ¼ãƒˆåˆ¶é™æˆ¦ç•¥

**æœŸå¾…æˆæœç‰©**:

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã®ç‰¹å®š
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…æ–¹é‡ï¼ˆRedis/In-Memory/Upstashç­‰ï¼‰
- ä¿è­·å¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒªã‚¹ãƒˆ
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ç²’åº¦ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«/ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥/ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ï¼‰

---

### Phase 2: ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…

**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•**:

```
`.claude/agents/gateway-dev.md` ã¨ `.claude/agents/sec-auditor.md` ã‚’èµ·å‹•ã—ã€ä»¥ä¸‹ã‚’ä¾é ¼:
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é¸å®šãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè£…
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥è¨­å®šã®é©ç”¨
- ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
```

**ã‚¹ã‚­ãƒ«å‚ç…§** (Phase 2):

- `.claude/skills/rate-limiting-strategies/SKILL.md`: å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
- `.claude/skills/best-practices-curation/SKILL.md`: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

**å®Ÿè£…å†…å®¹**:

```
ã€Next.js ã®å ´åˆã€‘
- middleware.ts: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: @upstash/ratelimit, next-rate-limit

ã€Express ã®å ´åˆã€‘
- src/middleware/rate-limit.middleware.ts: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: express-rate-limit, rate-limiter-flexible

ã€Fastify ã®å ´åˆã€‘
- src/plugins/rate-limit.plugin.ts: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
- æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: @fastify/rate-limit

ã€å…±é€šã€‘
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: src/config/rate-limit.config.ts
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼: ã‚«ã‚¹ã‚¿ãƒ 429ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ç²’åº¦**:

```
ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€‘
- å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ä¸€å¾‹é©ç”¨
- DDoSå¯¾ç­–ã«æœ‰åŠ¹

ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€‘
- /api/auth/login: 5/minuteï¼ˆãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–ï¼‰
- /api/data: 100/hourï¼ˆé€šå¸¸APIï¼‰
- /api/public: 1000/hourï¼ˆå…¬é–‹APIï¼‰

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€‘
- IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ™ãƒ¼ã‚¹ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰
- APIã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹
```

**æœŸå¾…æˆæœç‰©**:

- å®Œå…¨ã«å‹•ä½œã™ã‚‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥è¨­å®š
- ã‚«ã‚¹ã‚¿ãƒ 429ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

---

### Phase 3: æ¤œè¨¼ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ

**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•**:

```
`.claude/agents/sec-auditor.md` ã‚’èµ·å‹•ã—ã€ä»¥ä¸‹ã‚’ä¾é ¼:
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å‹•ä½œæ¤œè¨¼
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ä½œæˆ
- é‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
```

**ã‚¹ã‚­ãƒ«å‚ç…§** (Phase 3):

- `.claude/skills/rate-limiting-strategies/SKILL.md`: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
- `.claude/skills/best-practices-curation/SKILL.md`: é‹ç”¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

**æˆæœç‰©**:

- `docs/security/rate-limiting-setup.md`: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
  - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¨­å®šæ–¹æ³•
  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
  - Redisã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®šï¼ˆå¿…è¦ãªå ´åˆï¼‰
- `docs/security/rate-limiting-operations.md`: é‹ç”¨ã‚¬ã‚¤ãƒ‰
  - ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ–¹æ³•
  - ãƒ¬ãƒ¼ãƒˆåˆ¶é™å€¤ã®èª¿æ•´åŸºæº–
  - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- `scripts/test-rate-limit.sh`: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

---

## ğŸ” æ¤œè¨¼é …ç›®

å®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- [ ] 429ã‚¨ãƒ©ãƒ¼ãŒæ­£ã—ãè¿”ã•ã‚Œã‚‹
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™å€¤ãŒä»•æ§˜é€šã‚Šå‹•ä½œã—ã¦ã„ã‚‹
- [ ] ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ãŒ `docs/security/` ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- [ ] TypeScriptå‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ï¼ˆ`pnpm run type-check`ï¼‰

---

## ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éæ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```json
{
  "error": "Too Many Requests",
  "message": "Rate limit exceeded. Please try again later.",
  "retryAfter": 3600,
  "limit": 100,
  "remaining": 0,
  "reset": 1732886400
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼**:

```
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1732886400
Retry-After: 3600
```

---

## ğŸ“š é–¢é€£ã‚³ãƒãƒ³ãƒ‰

- `/ai:security-audit api` - APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- `/ai:setup-auth` - èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ï¼‰
- `/ai:scan-vulnerabilities` - DoSè„†å¼±æ€§ã®æ¤œå‡º

---

## ğŸ“ å‚è€ƒè³‡æ–™

**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä»•æ§˜**:

- `.claude/agents/sec-auditor.md`: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
- `.claude/agents/gateway-dev.md`: APIã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤é–‹ç™ºã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

**ã‚¹ã‚­ãƒ«ä»•æ§˜**:

- `.claude/skills/rate-limiting-strategies/SKILL.md`: ãƒ¬ãƒ¼ãƒˆåˆ¶é™æˆ¦ç•¥
- `.claude/skills/best-practices-curation/SKILL.md`: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

---

## âš™ï¸ æ¨å¥¨è¨­å®š

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥æ¨å¥¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™**:

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ        | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ç†ç”±                 |
| --------------------- | ---------- | -------------------- |
| `/api/auth/login`     | 5/minute   | ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­– |
| `/api/auth/register`  | 3/hour     | ã‚¹ãƒ‘ãƒ ç™»éŒ²å¯¾ç­–       |
| `/api/password/reset` | 3/hour     | ãƒªã‚»ãƒƒãƒˆæ‚ªç”¨å¯¾ç­–     |
| `/api/data`           | 100/hour   | é€šå¸¸APIä¿è­·          |
| `/api/public`         | 1000/hour  | å…¬é–‹API              |
| `/api/admin`          | 10/minute  | ç®¡ç†APIä¿è­·          |

**ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ¨å¥¨**:

- **é–‹ç™ºç’°å¢ƒ**: In-Memoryï¼ˆupstash-redis, memory-cacheï¼‰
- **æœ¬ç•ªç’°å¢ƒ**: Redis/Upstash Redisï¼ˆåˆ†æ•£ç’°å¢ƒå¯¾å¿œï¼‰
