# ユースケース関係性ガイド

## 概要

ユースケース間の関係性を適切にモデリングすることで、
機能の再利用性を高め、複雑なシステムを整理できます。

## 3つの関係性

### 1. 包含関係（Include）

**定義**: あるユースケースが別のユースケースを必ず実行する関係

**記法**: `--<<include>>-->`

**特徴**:

- 被包含ユースケースは必ず実行される
- 共通機能の抽出に使用
- 被包含ユースケースは単独で意味を持たなくてよい

**使用場面**:

- 認証チェックなど、複数のユースケースで必ず行う処理
- データ検証など、再利用可能な共通処理

**例**:

```
[商品を購入] --<<include>>--> [ユーザー認証]
[商品をカートに追加] --<<include>>--> [ユーザー認証]
[注文履歴を確認] --<<include>>--> [ユーザー認証]
```

**正しい使い方**:

- ✅ 複数のユースケースで常に必要な機能
- ❌ オプションの機能（extendを使う）

### 2. 拡張関係（Extend）

**定義**: 条件が満たされた場合に追加される関係

**記法**: `--<<extend>>-->`（矢印は基本ユースケースへ向かう）

**特徴**:

- 条件付きで実行される
- 基本ユースケースに影響を与えずに機能追加
- 拡張ポイント（Extension Point）を明示

**使用場面**:

- オプション機能
- 例外的な処理
- 将来の機能拡張

**例**:

```
[商品を購入] <--<<extend>>-- [クーポンを適用]
    (拡張ポイント: 支払い前)
    条件: クーポンコードが入力された場合

[商品を購入] <--<<extend>>-- [ギフト包装を選択]
    (拡張ポイント: 配送オプション)
    条件: ギフト包装オプションが選択された場合
```

**正しい使い方**:

- ✅ 条件付きのオプション機能
- ❌ 必須の機能（includeを使う）

### 3. 汎化関係（Generalization）

**定義**: ユースケース間の継承関係

**記法**: `----▷`（白三角矢印、子から親へ）

**特徴**:

- 親ユースケースの特殊化
- 子ユースケースは親の振る舞いを継承
- 子は親の振る舞いをオーバーライド可能

**使用場面**:

- 支払い方法の違い（クレジットカード、銀行振込など）
- ログイン方法の違い（パスワード、SSO、生体認証など）

**例**:

```
        [支払いを処理]
            △
           /|\
          / | \
         /  |  \
[クレジット] [銀行振込] [電子マネー]
```

## 関係性の選択ガイド

```
この機能は...
├─ 常に実行される？ → include
├─ 条件付きで実行される？ → extend
└─ 親の特殊化？ → 汎化
```

### 判断フロー

```
Q1: この機能は呼び出し元に必須か？
├─ Yes → Q2へ
└─ No（オプション）→ extend

Q2: 複数のユースケースで使用されるか？
├─ Yes → include
└─ No → Q3へ

Q3: 親子関係があるか？
├─ Yes（is-a関係）→ 汎化
└─ No → 関係なし（単独ユースケース）
```

## パターン集

### パターン1: 認証の共通化（include）

```
                    [ユーザー認証]
                         △
                        /|\
                       / | \
[注文する]─────────────┘  |  └─────────────[プロフィール更新]
                          |
                  [ウィッシュリスト管理]
```

### パターン2: オプション機能（extend）

```
[商品を購入]
    │
    ├──(拡張ポイント: 割引適用)──◁─[クーポン適用]
    │                              条件: クーポンあり
    │
    ├──(拡張ポイント: 配送選択)──◁─[お急ぎ便選択]
    │                              条件: 対象地域
    │
    └──(拡張ポイント: 支払い)────◁─[分割払い選択]
                                   条件: 高額商品
```

### パターン3: 支払い方法の汎化

```
            [支払いを処理]
                 △
        ┌───────┼───────┐
        │       │       │
[カード決済] [銀行振込] [コンビニ決済]
                             △
                      ┌──────┴──────┐
                      │             │
                [セブン支払い] [ローソン支払い]
```

### パターン4: 複合パターン

```
[商品を注文]
    │
    ├──<<include>>──[在庫確認]
    │
    ├──<<include>>──[ユーザー認証]
    │
    └──(拡張ポイント: 支払い選択)
            │
            ◁──<<extend>>──[ポイント利用]
                              条件: ポイントあり
            │
            ▽
      [支払いを処理]
            △
        ┌───┴───┐
   [カード決済] [銀行振込]
```

## よくある間違い

### 1. includeとextendの混同

**間違い**:

```
[商品を購入] --<<include>>--> [クーポン適用]
```

クーポン適用はオプションなのでincludeは不適切

**正解**:

```
[商品を購入] <--<<extend>>-- [クーポン適用]
    条件: クーポンコードが入力された場合
```

### 2. 過度な分解

**間違い**:

```
[商品を購入]
  --<<include>>--> [商品を選択]
  --<<include>>--> [カートに追加]
  --<<include>>--> [配送先入力]
  --<<include>>--> [支払い方法選択]
  --<<include>>--> [注文確定]
```

**正解**:
これらはユースケースの内部ステップであり、
別ユースケースとして抽出する必要はない。
共通で再利用される場合のみincludeを使用。

### 3. extend矢印の方向間違い

**間違い**:

```
[商品を購入] --<<extend>>--> [クーポン適用]
```

**正解**:

```
[クーポン適用] --<<extend>>--> [商品を購入]
```

extendの矢印は拡張元から基本ユースケースへ向かう

### 4. 汎化の誤用

**間違い**:

```
[ユーザー管理]
      △
  ┌───┴───┐
[ユーザー作成] [ユーザー削除]
```

これは汎化ではなく、単に関連するユースケース

**正解**:
作成と削除は管理の「特殊化」ではないため、
汎化関係は不適切。個別のユースケースとする。

## チェックリスト

### include使用時

- [ ] 被包含ユースケースは必ず実行されるか？
- [ ] 複数のユースケースで再利用されるか？
- [ ] 抽出により理解が容易になるか？

### extend使用時

- [ ] 拡張ポイントは明確か？
- [ ] 条件は明確に定義されているか？
- [ ] 基本ユースケースは拡張なしで完結するか？

### 汎化使用時

- [ ] is-a関係が成立するか？
- [ ] 子ユースケースは親の特殊化か？
- [ ] 子ユースケースは独立して意味を持つか？

## 関係性の記述フォーマット

### includeの記述

```markdown
## 包含関係

### [ベースUC] includes [被包含UC]

**理由**: [なぜこの機能を抽出したか]
**使用場面**: [どの時点で実行されるか]
```

### extendの記述

```markdown
## 拡張関係

### [拡張UC] extends [ベースUC]

**拡張ポイント**: [ベースUCのどの時点]
**条件**: [いつ拡張が実行されるか]
**理由**: [なぜ拡張として定義したか]
```

### 汎化の記述

```markdown
## 汎化関係

### [親UC]

├── [子UC1]: [差分の説明]
├── [子UC2]: [差分の説明]
└── [子UC3]: [差分の説明]

**共通点**: [親から継承する振る舞い]
**相違点**: [各子での違い]
```
