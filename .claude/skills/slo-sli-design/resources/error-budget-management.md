# エラーバジェット管理

## エラーバジェットの概念

### 基本的な考え方

**信頼性のコスト**:
- 99% → 99.9%: 大きなコスト増
- 99.9% → 99.99%: さらに大きなコスト増
- 100%: 実質的に不可能

**エラーバジェットの役割**:
信頼性と開発速度のトレードオフを定量化し、意思決定を支援

### エラーバジェットとは

**定義**:
SLOを満たしながら許容されるエラーの量

**計算式**:
```
エラーバジェット = (1 - SLO) × 総リクエスト数
```

**例**:
```
SLO: 99.9% (可用性)
30日間の総リクエスト数: 10,000,000

エラーバジェット = (1 - 0.999) × 10,000,000
                = 0.001 × 10,000,000
                = 10,000リクエスト

→ 30日間で10,000回までのエラーを許容
```

## エラーバジェット消費追跡

### リアルタイム追跡

**必要な指標**:
1. 現在のエラー数（cumulative）
2. 総エラーバジェット
3. 残りバジェット
4. 消費率（%）
5. 消費ペース（1日あたり）
6. 予測枯渇日

**計算例**:
```
測定開始: 2025-11-01
現在: 2025-11-15 (15日経過)
測定期間: 30日間

総エラーバジェット: 10,000
現在のエラー数: 3,000
残りバジェット: 7,000
消費率: 30%
消費ペース: 3,000 / 15 = 200エラー/日
予測枯渇日: 7,000 / 200 = 35日後 → 測定期間内に収まる ✅
```

### ダッシュボード可視化

**必須パネル**:
1. エラーバジェット残量ゲージ
2. 消費ペースグラフ（時系列）
3. 予測枯渇日表示
4. SLO達成状況（達成/違反）

**Grafana パネル例**:
```
Panel 1: Error Budget Remaining
  Type: Gauge
  Query: (error_budget_total - error_count_30d) / error_budget_total * 100
  Thresholds: Green (> 50%), Yellow (25-50%), Red (< 25%)

Panel 2: Error Budget Burn Rate
  Type: Graph
  Query: rate(error_count[1h])
  Alert: Burn rate > sustainable_rate

Panel 3: SLO Status
  Type: Stat
  Query: availability_30d
  Thresholds: Green (>= SLO), Red (< SLO)
```

## エラーバジェットポリシー

### 段階的対応フレームワーク

#### ステージ1: グリーンゾーン (残量 > 50%)

**状態**: 健全

**アクション**:
- 通常の開発速度を維持
- 新機能のデプロイ続行
- パフォーマンス改善は通常の優先度

**開発チームへのメッセージ**:
「エラーバジェットは十分にあります。通常通り開発を進めてください。」

#### ステージ2: イエローゾーン (残量 25-50%)

**状態**: 注意

**アクション**:
- 新機能デプロイを慎重化（段階的ロールアウト）
- カナリアリリースの期間を延長
- テストカバレッジの強化
- 信頼性改善タスクの優先度を上げる

**開発チームへのメッセージ**:
「エラーバジェットが減少中です。デプロイは慎重に行い、信頼性改善を優先してください。」

#### ステージ3: オレンジゾーン (残量 10-25%)

**状態**: 警告

**アクション**:
- 新機能デプロイを一時凍結
- 信頼性改善のみにフォーカス
- 根本原因分析を徹底実施
- SLO達成に向けた緊急対策会議

**開発チームへのメッセージ**:
「エラーバジェットが枯渇寸前です。新機能開発を停止し、信頼性改善に集中してください。」

#### ステージ4: レッドゾーン (残量 < 10%)

**状態**: 緊急

**アクション**:
- すべての変更を凍結（信頼性改善を除く）
- インシデント対応モード
- 経営層へのエスカレーション
- ポストモーテム実施と再発防止策策定

**開発チームへのメッセージ**:
「エラーバジェットが枯渇しました。すべての開発を停止し、信頼性回復に全力を注いでください。」

### ポリシー適用の自動化

**アラート設定**:
```yaml
alerts:
  - name: ErrorBudgetYellow
    condition: error_budget_remaining < 0.50
    severity: warning
    notification: slack_channel
    message: "⚠️ エラーバジェット残量50%未満。新機能デプロイは慎重に。"

  - name: ErrorBudgetOrange
    condition: error_budget_remaining < 0.25
    severity: high
    notification: slack_channel, pagerduty
    message: "🚨 エラーバジェット残量25%未満。新機能デプロイを凍結してください。"

  - name: ErrorBudgetRed
    condition: error_budget_remaining < 0.10
    severity: critical
    notification: slack_channel, pagerduty, email_executives
    message: "🔴 エラーバジェット残量10%未満。緊急対応が必要です。"
```

## バーンレート（Burn Rate）

### 概念

**バーンレート**: エラーバジェットの消費速度

**計算式**:
```
バーンレート = 現在のエラー率 / 許容エラー率
```

**例**:
```
SLO: 99.9% (許容エラー率 0.1%)
現在のエラー率: 0.5%

バーンレート = 0.5% / 0.1% = 5倍

→ 許容の5倍の速度でバジェットを消費中
→ このペースでは 30日 / 5 = 6日でバジェット枯渇
```

### バーンレートアラート

**マルチウィンドウアラート**:

**短期ウィンドウ（1時間）**:
```
バーンレート > 14.4 → 2日でバジェット枯渇
```

**長期ウィンドウ（6時間）**:
```
バーンレート > 6.0 → 5日でバジェット枯渇
```

**アラート設定例**:
```yaml
- name: FastBurn
  condition: |
    (
      (1 - availability_1h) / (1 - slo_target) > 14.4
      and
      (1 - availability_6h) / (1 - slo_target) > 14.4
    )
  severity: critical
  message: "🚨 エラーバジェットが急速消費中（2日で枯渇予測）"

- name: SlowBurn
  condition: |
    (
      (1 - availability_24h) / (1 - slo_target) > 3
      and
      (1 - availability_3d) / (1 - slo_target) > 3
    )
  severity: warning
  message: "⚠️ エラーバジェットが持続的に消費中（10日で枯渇予測）"
```

## SLO レビューとリセット

### 定期レビュー

**月次レビュー**:
- SLO達成状況の確認
- エラーバジェット消費パターンの分析
- インシデント原因の振り返り

**四半期レビュー**:
- SLO妥当性の評価
- 必要に応じてSLO目標値の調整
- 新しいSLI追加の検討

### エラーバジェットリセット

**ローリングウィンドウ方式**:
```
測定期間: 過去30日間（ローリング）
→ 毎日、31日前のデータが除外され、新しいデータが追加

利点: 滑らかな変化、月初リセットによるゲーミング防止
```

**カレンダーベース方式**:
```
測定期間: 月初〜月末
→ 毎月1日にリセット

欠点: 月末に駆け込みデプロイのインセンティブ（ゲーミング）
```

**推奨**: ローリングウィンドウ方式

## エラーバジェット消費の内訳分析

### 原因別分類

**計画的消費**:
- 新機能デプロイ（予期されるエラー）
- メンテナンス作業

**非計画的消費**:
- インシデント
- 外部依存の障害
- バグ

**分析例**:
```
総消費: 3,000エラー
├─ 計画的消費: 500エラー (17%)
│  ├─ 新機能デプロイA: 300
│  └─ メンテナンス: 200
└─ 非計画的消費: 2,500エラー (83%)
   ├─ インシデント#123: 1,500
   ├─ 外部API障害: 800
   └─ バグ#456: 200
```

### 改善アクション

**計画的消費の削減**:
- カナリアリリースの強化
- ステージング環境でのテスト強化

**非計画的消費の削減**:
- インシデントのポストモーテム実施
- 根本原因の修正
- モニタリング強化

## ツールとダッシュボード

### Prometheus + Grafana

**エラーバジェット計算**:
```
# 総エラーバジェット（30日間）
error_budget_total = (1 - slo_target) * sum(increase(http_requests_total[30d]))

# 現在のエラー数
error_count_30d = sum(increase(http_requests_total{status=~"5.."}[30d]))

# 残りバジェット
error_budget_remaining = error_budget_total - error_count_30d

# 消費率
error_budget_consumed_percentage = (error_count_30d / error_budget_total) * 100
```

### Datadog

**SLO機能**:
```yaml
slo:
  name: "API Availability"
  type: "metric"
  thresholds:
    - target: 99.9
      timeframe: 30d
  query:
    numerator: "sum:http.requests{status:2xx,status:3xx}.as_count()"
    denominator: "sum:http.requests{*}.as_count()"
```

## ベストプラクティス

1. **明確なポリシー**: バジェット枯渇時の対応を事前定義
2. **リアルタイム追跡**: ダッシュボードで常時可視化
3. **原因分析**: 計画的/非計画的消費を分類
4. **定期レビュー**: SLO妥当性を継続評価
5. **チーム共有**: エラーバジェット状況を全員が把握

## アンチパターン

❌ **SLO設定だけ**: エラーバジェット管理なし
✅ **統合管理**: SLO + エラーバジェット + ポリシー

❌ **手動追跡**: スプレッドシートで手動計算
✅ **自動追跡**: Prometheus/Datadogで自動計算

❌ **無視**: バジェット枯渇でも開発続行
✅ **厳格適用**: ポリシーに従い開発速度を調整
