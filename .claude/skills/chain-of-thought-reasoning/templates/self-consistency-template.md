# Self-Consistencyテンプレート

## 概要

Self-Consistency（自己一貫性）は、同じ問題に対して
複数の推論パスを生成し、最も一貫した回答を選択する手法です。

## 基本テンプレート

### シングルプロンプト版

```markdown
# タスク
以下の問題を3つの異なる方法で解いてください。
最後に、最も信頼できる回答を選択してください。

# 問題
{{problem}}

# 解法1

## アプローチ
[アプローチの説明]

## 推論
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

## 回答1
[回答]

---

# 解法2

## アプローチ
[別のアプローチの説明]

## 推論
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

## 回答2
[回答]

---

# 解法3

## アプローチ
[さらに別のアプローチの説明]

## 推論
1. [ステップ1]
2. [ステップ2]

## 回答3
[回答]

---

# 回答の比較

| 解法 | 回答 | 信頼度 |
|------|------|--------|
| 1 | ... | 高/中/低 |
| 2 | ... | 高/中/低 |
| 3 | ... | 高/中/低 |

# 最終回答
回答: [最も一貫している回答]
理由: [選択理由]
```

### 使用例

```markdown
# タスク
以下の問題を3つの異なる方法で解いてください。
最後に、最も信頼できる回答を選択してください。

# 問題
ある店で、定価の20%引きで商品を買うと2400円でした。
この商品の定価はいくらですか？

# 解法1

## アプローチ
割引後の価格から逆算

## 推論
1. 20%引き = 80%の価格
2. 2400円 = 定価 × 0.80
3. 定価 = 2400 ÷ 0.80 = 3000円

## 回答1
3000円

---

# 解法2

## アプローチ
方程式を使う

## 推論
1. 定価をxとする
2. x - 0.2x = 2400
3. 0.8x = 2400
4. x = 3000

## 回答2
3000円

---

# 解法3

## アプローチ
比を使う

## 推論
1. 80% : 2400円 = 100% : ?円
2. ? = 2400 × 100 ÷ 80
3. ? = 3000

## 回答3
3000円

---

# 回答の比較

| 解法 | 回答 | 信頼度 |
|------|------|--------|
| 1 | 3000円 | 高 |
| 2 | 3000円 | 高 |
| 3 | 3000円 | 高 |

# 最終回答
回答: 3000円
理由: 3つの異なるアプローチで同じ結果が得られ、高い一貫性
```

## マルチパス版テンプレート

### API実装用

```typescript
interface SelfConsistencyConfig {
  numPaths: number;       // 推論パス数（推奨: 3-5）
  temperature: number;    // 多様性用（推奨: 0.5-0.7）
  threshold: number;      // 採用閾値（推奨: 0.6）
}

const basePrompt = `
問題: {{problem}}

段階的に考えて解いてください。

思考プロセス:
1. ...
2. ...
3. ...

最終回答: [回答のみを記載]
`;

async function selfConsistency(
  problem: string,
  config: SelfConsistencyConfig
): Promise<{
  answer: string;
  confidence: number;
  paths: string[];
}> {
  // 複数パスを生成
  const paths = await Promise.all(
    Array(config.numPaths).fill(null).map(() =>
      generateResponse(basePrompt.replace('{{problem}}', problem), {
        temperature: config.temperature
      })
    )
  );

  // 回答を抽出
  const answers = paths.map(extractAnswer);

  // 多数決
  const counts = countAnswers(answers);
  const [topAnswer, topCount] = getTopAnswer(counts);

  return {
    answer: topAnswer,
    confidence: topCount / config.numPaths,
    paths: paths
  };
}
```

### プロンプト分離版

**パス生成プロンプト**:
```markdown
問題: {{problem}}

この問題を独自のアプローチで解いてください。
他の解法を意識せず、あなたなりの方法で考えてください。

思考プロセス:
```

**集約プロンプト**:
```markdown
以下は同じ問題に対する複数の解答です。
最も正しいと思われる回答を選び、その理由を説明してください。

問題: {{problem}}

解答1:
{{path_1}}

解答2:
{{path_2}}

解答3:
{{path_3}}

分析:
- 解答1の評価: [正確性、論理性]
- 解答2の評価: [正確性、論理性]
- 解答3の評価: [正確性、論理性]

最終回答: [選択した回答]
選択理由: [理由]
```

## 加重Self-Consistency

### 信頼度加重テンプレート

```markdown
# 問題
{{problem}}

# 解法と信頼度

## 解法1
[推論プロセス]
回答: [回答]
この解法の信頼度: [0-100]%
理由: [信頼度の根拠]

## 解法2
[推論プロセス]
回答: [回答]
この解法の信頼度: [0-100]%
理由: [信頼度の根拠]

## 解法3
[推論プロセス]
回答: [回答]
この解法の信頼度: [0-100]%
理由: [信頼度の根拠]

# 加重評価

| 回答 | 出現回数 | 加重スコア |
|------|---------|-----------|
| ... | ... | Σ(信頼度) |

# 最終回答
加重スコアが最も高い回答: [回答]
総合信頼度: [計算値]%
```

## 条件付きSelf-Consistency

### 回答不一致時の処理

```markdown
# 問題
{{problem}}

# 複数解法の実行
[解法1-3を実行]

# 一致性チェック

IF すべての回答が一致:
  → 最終回答: [一致した回答]
  → 信頼度: 高

ELIF 2つ以上の回答が一致:
  → 最終回答: [多数派の回答]
  → 信頼度: 中
  → 少数派の分析: [なぜ異なる結果になったか]

ELSE すべての回答が異なる:
  → 追加の解法を実行（解法4-5）
  → 再度集計
  → それでも不一致の場合:
    → 最終回答: [最も論理的な回答]
    → 信頼度: 低
    → 警告: 「回答に不確実性があります」
```

## ドメイン別テンプレート

### 数学問題用

```markdown
# 数学問題
{{problem}}

# 解法1: 代数的アプローチ
[方程式を使った解法]
計算: ...
回答1: ...

# 解法2: 算術的アプローチ
[四則演算を使った解法]
計算: ...
回答2: ...

# 解法3: 図形/視覚的アプローチ
[図や表を使った解法]
説明: ...
回答3: ...

# 検算
各回答を元の問題に代入して検証:
- 回答1: [検算結果]
- 回答2: [検算結果]
- 回答3: [検算結果]

# 最終回答
検算を通過した回答: [回答]
```

### 論理問題用

```markdown
# 論理問題
{{problem}}

# 推論1: 順方向推論
前提から結論へ:
[推論ステップ]
結論1: ...

# 推論2: 逆方向推論
結論を仮定して矛盾を探す:
[推論ステップ]
結論2: ...

# 推論3: 場合分け
すべてのケースを列挙:
- ケースA: [結果]
- ケースB: [結果]
- ケースC: [結果]
結論3: ...

# 論理的整合性チェック
- 推論1と2の整合性: [一致/不一致]
- 場合分けの網羅性: [完全/不完全]

# 最終回答
最も論理的に堅牢な結論: [回答]
```

## パラメータ推奨設定

```yaml
self_consistency_params:
  simple_tasks:
    num_paths: 3
    temperature: 0.5
    threshold: 0.67  # 2/3以上の一致

  moderate_tasks:
    num_paths: 5
    temperature: 0.6
    threshold: 0.60  # 3/5以上の一致

  complex_tasks:
    num_paths: 7
    temperature: 0.7
    threshold: 0.57  # 4/7以上の一致

  high_precision:
    num_paths: 9
    temperature: 0.5
    threshold: 0.67  # 6/9以上の一致
```

## トラブルシューティング

### 回答が収束しない場合

1. **Temperatureを下げる**: 0.7 → 0.5
2. **パス数を増やす**: 3 → 5 → 7
3. **問題を単純化**: サブ問題に分割
4. **追加の制約を提供**: より具体的な指示

### 誤った回答に収束する場合

1. **検証ステップを追加**: 各解法に検算を含める
2. **異なるアプローチを強制**: 「異なる方法で」と明示
3. **専門家ペルソナを使用**: 「数学の専門家として」
