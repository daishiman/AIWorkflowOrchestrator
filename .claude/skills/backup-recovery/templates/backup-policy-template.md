# バックアップポリシー

## 文書情報

| 項目 | 内容 |
|------|------|
| 文書名 | [プロジェクト名] バックアップポリシー |
| バージョン | 1.0 |
| 作成日 | YYYY-MM-DD |
| 最終更新 | YYYY-MM-DD |
| 承認者 | [承認者名] |
| 次回レビュー | YYYY-MM-DD |

## 1. 目的

本ポリシーは、[プロジェクト名]のデータベースバックアップに関する
方針、手順、責任を定義し、データ損失リスクを最小化することを目的とする。

## 2. 適用範囲

### 対象システム
- [ ] 本番データベース
- [ ] ステージング環境
- [ ] 開発環境

### 対象データ
| データ分類 | 説明 | 例 |
|-----------|------|-----|
| クリティカル | 損失が事業継続に直接影響 | 取引データ、ユーザー認証情報 |
| 重要 | 損失が業務効率に影響 | ユーザープロファイル、設定 |
| 標準 | 再作成可能だが手間がかかる | ログ、分析データ |
| 低重要度 | 容易に再作成可能 | キャッシュ、一時データ |

## 3. バックアップ目標

### RPO（Recovery Point Objective）

| データ分類 | RPO目標 | バックアップ頻度 |
|-----------|---------|-----------------|
| クリティカル | [  ]分 | 継続的/PITR |
| 重要 | [  ]時間 | [  ]時間毎 |
| 標準 | [  ]時間 | 日次 |
| 低重要度 | [  ]日 | 週次 |

### RTO（Recovery Time Objective）

| データ分類 | RTO目標 | 復旧手順 |
|-----------|---------|---------|
| クリティカル | [  ]時間 | 自動フェイルオーバー |
| 重要 | [  ]時間 | 手動フェイルオーバー |
| 標準 | [  ]時間 | バックアップからの復旧 |
| 低重要度 | [  ]日 | バックアップからの復旧 |

## 4. バックアップ戦略

### 4.1 多層防御モデル

```
Layer 1: 自動バックアップ（クラウドサービス）
├── 種類: [完全/増分/差分]
├── 頻度: [頻度を記入]
├── 保持期間: [日数]日
└── 担当: [担当者/チーム]

Layer 2: PITR（Point-in-Time Recovery）
├── 有効: [はい/いいえ]
├── 保持期間: [日数]日
└── 粒度: [秒/分/時間]

Layer 3: 検証
├── 頻度: [頻度を記入]
├── 方法: [テスト復旧/整合性チェック]
└── 担当: [担当者/チーム]

Layer 4: オフサイト
├── 場所: [リージョン/場所]
├── 頻度: [頻度を記入]
├── 暗号化: [はい/いいえ]
└── 保持期間: [日数]日
```

### 4.2 バックアップスケジュール

| 種類 | 時刻 | 曜日 | 保持期間 |
|------|------|------|---------|
| 完全バックアップ | [時刻] | [曜日] | [日数]日 |
| 増分バックアップ | [時刻] | 毎日 | [日数]日 |
| トランザクションログ | 継続 | 継続 | [日数]日 |

## 5. バックアップ手順

### 5.1 自動バックアップ

```yaml
# 自動バックアップ設定
schedule:
  full_backup:
    cron: "0 2 * * 0"  # 毎週日曜2:00
    retention: 30d

  incremental:
    cron: "0 2 * * 1-6"  # 月-土 2:00
    retention: 7d
```

### 5.2 手動バックアップ

重要な変更前には手動バックアップを実施する：

```bash
# Neonの場合
neon branches create --name backup_$(date +%Y%m%d_%H%M%S)

# pg_dumpの場合
pg_dump -h [host] -U [user] -d [database] -f backup_$(date +%Y%m%d).sql
```

## 6. 保持ポリシー

| バックアップ種類 | 保持期間 | 削除方法 |
|-----------------|---------|---------|
| 日次バックアップ | [  ]日 | 自動 |
| 週次バックアップ | [  ]週 | 自動 |
| 月次バックアップ | [  ]ヶ月 | 自動 |
| 年次バックアップ | [  ]年 | 手動確認後 |

## 7. セキュリティ要件

### 7.1 暗号化

- [ ] 保存時暗号化（at-rest）: [暗号化方式]
- [ ] 転送時暗号化（in-transit）: [暗号化方式]
- [ ] 暗号化キー管理: [管理方法]

### 7.2 アクセス制御

| 役割 | バックアップ作成 | バックアップ読取 | 復旧実行 |
|------|-----------------|-----------------|---------|
| DBA | ✅ | ✅ | ✅ |
| SRE | ✅ | ✅ | ✅ |
| 開発者 | ❌ | 制限付き | ❌ |
| 運用 | ❌ | ❌ | ❌ |

## 8. 検証手順

### 8.1 定期検証

| 検証項目 | 頻度 | 担当 | 記録場所 |
|---------|------|------|---------|
| バックアップ整合性 | 週次 | [担当] | [場所] |
| 復旧テスト | 月次 | [担当] | [場所] |
| 完全復旧ドリル | 四半期 | [担当] | [場所] |

### 8.2 検証チェックリスト

- [ ] バックアップファイルが存在するか
- [ ] ファイルサイズが期待値か
- [ ] 復旧テストが成功するか
- [ ] 復旧時間がRTO内か
- [ ] データ整合性が保たれているか

## 9. 役割と責任

| 役割 | 責任 |
|------|------|
| DBA | バックアップ設定、監視、復旧実行 |
| SRE | インフラ管理、自動化、アラート対応 |
| 技術リード | ポリシーレビュー、承認 |
| オンコール | 障害時の初期対応 |

## 10. 監視とアラート

### 10.1 監視項目

| 項目 | 閾値 | アラートレベル |
|------|------|--------------|
| バックアップ成功率 | < 100% | Critical |
| バックアップ遅延 | > [  ]分 | Warning |
| ストレージ使用量 | > 80% | Warning |
| 保持期間超過 | あり | Info |

### 10.2 通知先

| アラートレベル | 通知先 | 方法 |
|--------------|--------|------|
| Critical | [通知先] | [方法] |
| Warning | [通知先] | [方法] |
| Info | [通知先] | [方法] |

## 11. 例外処理

ポリシーからの逸脱が必要な場合：

1. 逸脱理由を文書化
2. [承認者]の承認を取得
3. 期限付きで例外を適用
4. 定期的に例外をレビュー

## 12. 変更履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|---------|--------|
| 1.0 | YYYY-MM-DD | 初版作成 | [承認者] |

## 13. 承認

| 役職 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| [役職] | [氏名] | | YYYY-MM-DD |
| [役職] | [氏名] | | YYYY-MM-DD |
