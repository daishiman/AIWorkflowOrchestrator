# DDDビルディングブロック概要

## DDDの戦術的パターン体系

ドメイン駆動設計（DDD）は、戦略的設計と戦術的設計の2つのレベルで構成されます。
このドキュメントでは、戦術的パターン（ビルディングブロック）の全体像を解説します。

## ビルディングブロック一覧

### 1. エンティティ (Entity)

**定義**: 一意な識別子によって識別されるオブジェクト

**特徴**:
- ライフサイクルを持つ
- 属性が変化しても同一性を維持
- 識別子は不変

**責務**:
- 自身の不変条件を保護
- ビジネスロジックをカプセル化
- 状態遷移を制御

### 2. 値オブジェクト (Value Object)

**定義**: 属性の組み合わせで識別されるオブジェクト

**特徴**:
- 不変（Immutable）
- 置換可能（同じ値なら交換可能）
- 副作用のない振る舞い

**責務**:
- 概念を型として表現
- 自己検証（コンストラクタ）
- 値の操作メソッド提供

### 3. 集約 (Aggregate)

**定義**: データ変更の単位として扱われるオブジェクトのクラスタ

**特徴**:
- トランザクション整合性の境界
- 集約ルートを持つ
- 外部からは集約ルートのみ参照可能

**責務**:
- 不変条件の保護
- 内部エンティティへのアクセス制御
- 整合性の維持

### 4. ドメインサービス (Domain Service)

**定義**: エンティティや値オブジェクトに自然に属さないドメインロジック

**特徴**:
- ステートレス
- ドメイン層に配置
- ドメイン用語で命名

**責務**:
- 複数エンティティにまたがる操作
- ドメインの「活動」を表現
- ビジネスルールの実装

### 5. リポジトリ (Repository)

**定義**: 集約の永続化と取得を抽象化するインターフェース

**特徴**:
- コレクション風インターフェース
- インターフェースはドメイン層
- 実装はインフラストラクチャ層

**責務**:
- 永続化の詳細を隠蔽
- 集約の取得と保存
- クエリの抽象化

### 6. ファクトリ (Factory)

**定義**: 複雑なオブジェクトやAggregateの生成を担当

**特徴**:
- 生成ロジックの隔離
- 不変条件の保証
- 複雑な初期化の簡略化

**責務**:
- オブジェクトの生成
- 生成時のバリデーション
- 整合性のある初期状態の保証

### 7. ドメインイベント (Domain Event)

**定義**: ドメインで起きた重要な出来事を表現するオブジェクト

**特徴**:
- 不変
- 過去形で命名
- タイムスタンプを持つ

**責務**:
- 状態変化の記録
- 集約間の疎結合な連携
- 監査証跡の提供

## ビルディングブロックの関係性

```
┌─────────────────────────────────────────┐
│            ドメイン層                    │
│                                         │
│  ┌─────────────┐   ┌─────────────┐     │
│  │   集約      │   │ ドメイン    │     │
│  │  ┌───────┐  │   │ サービス    │     │
│  │  │Entity │  │   │             │     │
│  │  │  +    │  │   └─────────────┘     │
│  │  │Value  │  │                        │
│  │  │Object │  │   ┌─────────────┐     │
│  │  └───────┘  │   │ ファクトリ  │     │
│  └─────────────┘   └─────────────┘     │
│         ↑                               │
│         │  ┌─────────────┐              │
│         └──│ Repository  │(Interface)   │
│            │ Interface   │              │
│            └─────────────┘              │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│        インフラストラクチャ層            │
│                                         │
│    ┌─────────────────────────┐          │
│    │ Repository Implementation │         │
│    │  (Drizzle, SQL, etc.)    │          │
│    └─────────────────────────┘          │
└─────────────────────────────────────────┘
```

## 選択基準

### Entity vs Value Object

| 基準 | Entity | Value Object |
|------|--------|--------------|
| 同一性 | IDで識別 | 属性で識別 |
| ライフサイクル | あり | なし |
| 可変性 | 可変 | 不変 |
| 例 | User, Order | Email, Money |

### Domain Service vs Entity Method

| 基準 | Domain Service | Entity Method |
|------|---------------|--------------|
| 所属 | 複数エンティティにまたがる | 1つのエンティティに属する |
| 状態 | ステートレス | エンティティの状態を操作 |
| 例 | 料金計算サービス | 注文の状態遷移 |

### Factory vs Constructor

| 基準 | Factory | Constructor |
|------|---------|-------------|
| 複雑さ | 複雑な生成ロジック | シンプルな初期化 |
| 選択肢 | 複数の生成パターン | 単一の生成方法 |
| 集約 | 集約全体の整合性 | 単一オブジェクト |

## 層別配置

| ビルディングブロック | 配置層 | パス例 |
|---------------------|-------|-------|
| Entity | ドメイン層 | `src/shared/core/entities/` |
| Value Object | ドメイン層 | `src/shared/core/entities/` |
| Aggregate | ドメイン層 | `src/shared/core/entities/` |
| Domain Service | ドメイン層 | `src/shared/core/entities/` |
| Repository Interface | ドメイン層 | `src/shared/core/interfaces/` |
| Repository Impl | インフラ層 | `src/shared/infrastructure/` |
| Factory | ドメイン層 | `src/shared/core/entities/` |
| Domain Event | ドメイン層 | `src/shared/core/events/` |

## プロジェクト固有のマッピング

### ハイブリッドアーキテクチャ対応

```
src/
├── shared/                    # 共有層
│   ├── core/                  # ドメイン層（技術非依存）
│   │   ├── entities/          # Entity, Value Object, Aggregate
│   │   ├── interfaces/        # Repository Interface
│   │   └── errors/            # Domain Errors
│   └── infrastructure/        # インフラ層
│       └── repositories/      # Repository Implementation
└── features/                  # 機能別垂直スライス
    └── {feature}/
        └── domain/            # 機能固有のドメイン要素
```

## 参考文献

- 『エリック・エヴァンスのドメイン駆動設計』第2部: モデル駆動設計のビルディングブロック
- 『実践ドメイン駆動設計』第4章〜第12章
- 『ドメイン駆動設計入門』全章
