# 3層開示モデル詳細ガイド

## 概要

3層開示モデルは、情報を3つの階層に分けて段階的に提供することで、
トークン効率と知識の深さを両立させる設計原則です。

## 3層の定義

### レベル1: メタデータ層（常時ロード）

**目的**: スキル選択の判断材料を提供

**構成要素**:

- `name`: スキル識別子
- `description`: 概要、専門分野、使用タイミング
- `version`: バージョン番号

**トークン目標**: 約100トークン

**設計基準**:

- [ ] descriptionは4-8行か？
- [ ] 具体的なトリガー条件が3つ以上あるか？
- [ ] キーワードが適切に含まれているか？

**役割**:

```
ユーザーのプロンプト
    ↓
Claude がメタデータを評価
    ↓
適合するスキルを選択
    ↓
SKILL.md本文をロード
```

---

### レベル2: 本文層（必要時ロード）

**目的**: タスク実行に必要な知識を提供

**構成要素**:

- 概要
- いつ使うか
- 前提条件
- ワークフロー（Phase 1-3以上）
- ベストプラクティス
- リソースへの参照

**トークン目標**: <500行（約3,000トークン）

**設計基準**:

- [ ] 「いつ使うか」セクションが具体的か？
- [ ] ワークフローが段階的（3段階以上）か？
- [ ] 各Phaseでリソース参照が明示されているか？
- [ ] 適切な例が2-3個含まれているか？

**役割**:

```
スキルが選択される
    ↓
SKILL.md本文をロード
    ↓
ワークフローとベストプラクティスを取得
    ↓
必要に応じてリソースを参照
```

---

### レベル3: リソース層（参照時ロード）

**目的**: 深い専門知識を提供

**構成要素**:

- 詳細トピックファイル（各<500行）
- スクリプト（検証、自動化）
- テンプレート（再利用可能フォーマット）
- アセット（スキーマ、サンプル）

**トークン目標**: 各ファイル<500行（約3,000トークン）

**設計基準**:

- [ ] トピックごとに明確に分割されているか？
- [ ] SKILL.mdから参照可能か？
- [ ] 独立して理解可能か？
- [ ] 各ファイルが500行以内か？

**役割**:

```
Phase実行中に詳細が必要
    ↓
対応するリソースを参照
    ↓
深い専門知識を取得
    ↓
タスクに適用
```

---

## トークン削減効果

### 従来方式（全一括ロード）

```
すべての情報を1つのファイルに含める

例: database-design-all-in-one.md
- スキーマ設計: 500行
- インデックス設計: 400行
- クエリ最適化: 450行
- トランザクション管理: 350行

総計: 1,700行 ≈ 10,000トークン
```

**問題点**:

- 常に10,000トークンを消費
- 不要な情報も常にロードされる
- コンテキストウィンドウを圧迫

---

### Progressive Disclosure方式

```
レベル1: metadata（常時）
name + description: 100トークン

レベル2: SKILL.md本文（必要時）
概要 + ワークフロー + 参照指示: 3,000トークン

レベル3: resources/（参照時）
- schema-design.md: 3,000トークン（必要時のみ）
- indexing-strategies.md: 2,500トークン（必要時のみ）
- query-optimization.md: 2,700トークン（必要時のみ）
- turso-best-practices.md: 2,100トークン（必要時のみ）
```

**シナリオ別トークン使用量**:

**シナリオA: スキーマ設計のみ**

```
メタデータ + SKILL.md + schema-design.md
= 100 + 3,000 + 3,000
= 6,100トークン
```

**シナリオB: インデックス設計のみ**

```
メタデータ + SKILL.md + indexing-strategies.md
= 100 + 3,000 + 2,500
= 5,600トークン
```

**削減効果**:

- 従来: 常に10,000トークン
- Progressive Disclosure: 5,600-6,100トークン
- **削減率: 40-44%**

---

## 情報配置の判断基準

### メタデータ層に配置すべき情報

**配置基準**:

- [ ] スキル選択の判断に必要か？
- [ ] 100トークン以内で表現できるか？
- [ ] トリガーとなるキーワードを含むか？

**例**:

```yaml
✅ 配置すべき:
  - スキルの核心的機能（1-2文）
  - 主要な使用シナリオ（3-5項目）
  - トリガーキーワード

❌ 配置すべきでない:
  - 詳細な手順
  - 具体的なコード例
  - トラブルシューティング
```

---

### 本文層（SKILL.md）に配置すべき情報

**配置基準**:

- [ ] タスク実行に必須か？
- [ ] すべてのユーザーに必要か？
- [ ] 500行以内で説明できるか？

**例**:

```markdown
✅ 配置すべき:

- 概要（2-3段落）
- ワークフロー（Phase 1-3）
- 基本的なベストプラクティス
- 簡単な例（2-3個）
- リソースへの参照指示

❌ 配置すべきでない:

- 詳細な理論的背景
- 高度な応用例
- すべてのエッジケース
- 大量のトラブルシューティング
```

---

### リソース層に配置すべき情報

**配置基準**:

- [ ] 詳細で専門的な知識か？
- [ ] 特定のシナリオでのみ必要か？
- [ ] 独立したトピックとして分離可能か？

**例**:

```markdown
✅ 配置すべき:

- 理論的背景の詳細
- 高度な応用パターン
- 特殊なエッジケース
- 詳細なトラブルシューティング
- 包括的な参考文献

❌ 配置すべきでない:

- 基本的な概要
- 必須のワークフロー
- すべてのユーザーに必要な情報
```

---

## 参照フローの設計

### パターン1: 直接参照

```markdown
## Phase 1: スキーマ設計

[基本的な説明]

詳細は `resources/schema-design.md` を参照してください。
```

**特徴**:

- シンプルで明確
- ユーザーが能動的に参照

---

### パターン2: 条件付き参照

```markdown
## Phase 2: インデックス設計

基本的なインデックス設計は以下の手順で行います:

1. カーディナリティの確認
2. クエリパターンの分析
3. インデックスタイプの選択

高度なインデックス戦略（GIN、GiST、部分インデックス等）については
`resources/advanced-indexing.md` を参照してください。
```

**特徴**:

- 基本は本文に含む
- 高度な内容はリソースに分離
- 段階的な学習をサポート

---

### パターン3: 選択的参照

```markdown
## リソースへの参照

トピック別の詳細情報:

- **スキーマ設計**: `resources/schema-design.md`
  - 正規化の詳細
  - JSONB活用パターン

- **インデックス戦略**: `resources/indexing-strategies.md`
  - インデックスタイプの選択
  - パフォーマンスチューニング

- **クエリ最適化**: `resources/query-optimization.md`
  - N+1問題の回避
  - JOIN戦略

必要なトピックを選択して参照してください。
```

**特徴**:

- ユーザーが必要なトピックを選択
- 目次として機能
- トークン効率が最大

---

## ベストプラクティス

### 設計時

1. **最小限から始める**: メタデータ層の設計に最も時間をかける
2. **段階的に詳細化**: SKILL.md → リソースの順で作成
3. **参照を明確に**: どのリソースにどの情報があるか明示

### 運用時

1. **発動率を測定**: テストプロンプトで検証
2. **トークン使用量をモニタリング**: 定期的にチェック
3. **ユーザーフィードバックを収集**: 情報が見つかりやすいか確認

### 最適化時

1. **descriptionを最優先**: 発動率に最も影響
2. **冗長性を排除**: DRY原則を徹底
3. **リソース参照を最適化**: 必要最小限の参照

---

## 参考文献

- **『Progressive Disclosure in User Interface Design』** Jakob Nielsen
  - 段階的開示の理論的基盤

- **『Information Architecture for the Web and Beyond』** Louis Rosenfeld他著
  - 情報組織化の原則
