# デプロイパターン詳細

## 概要

このドキュメントでは、主要なデプロイパターンの詳細と選択基準を説明します。

## Blue-Green デプロイ

### 概念

```
                 ┌─────────────────┐
                 │  Load Balancer  │
                 └────────┬────────┘
                          │
           ┌──────────────┴──────────────┐
           │                             │
           ▼                             ▼
    ┌─────────────┐               ┌─────────────┐
    │   Blue      │               │   Green     │
    │  (現行)     │               │  (新版)     │
    │             │               │             │
    │  v1.0.0     │               │  v1.1.0     │
    └─────────────┘               └─────────────┘
```

### 特徴

| 項目 | 詳細 |
|------|------|
| ダウンタイム | なし（瞬時切替） |
| ロールバック | 即座（DNS/LB切替のみ） |
| リソース | 2倍必要 |
| 複雑性 | 中程度 |
| テスト | 本番同等環境で事前テスト可能 |

### 実装フロー

```
1. Green環境を準備
2. 新バージョンをGreenにデプロイ
3. Greenでスモークテスト実行
4. トラフィックをGreenに切替
5. Blueを待機状態に維持
6. 問題発生時：Blueに即座に戻す
```

### 適用条件

- [x] ダウンタイムが許容されない
- [x] 即座のロールバックが必要
- [x] リソースコストが許容される
- [x] 本番同等の事前テストが必要

### Railwayでの実現

Railwayは自動的にBlue-Green的なデプロイを実現：

```
1. 新コンテナをビルド・起動
2. ヘルスチェック成功を確認
3. トラフィックを新コンテナに切替
4. 旧コンテナを停止
```

## Canary デプロイ

### 概念

```
                 ┌─────────────────┐
                 │  Load Balancer  │
                 │   (トラフィック分割)  │
                 └────────┬────────┘
                          │
           ┌──────────────┴──────────────┐
           │ 90%                     10% │
           ▼                             ▼
    ┌─────────────┐               ┌─────────────┐
    │   Stable    │               │   Canary    │
    │  v1.0.0     │               │  v1.1.0     │
    │             │               │  (新版)     │
    └─────────────┘               └─────────────┘
```

### 特徴

| 項目 | 詳細 |
|------|------|
| ダウンタイム | なし |
| ロールバック | 段階的（トラフィック調整） |
| リソース | 少量追加 |
| 複雑性 | 高（トラフィック管理が必要） |
| テスト | 本番トラフィックでの実証 |

### 実装フロー

```
1. Canary環境を準備（小規模）
2. 新バージョンをCanaryにデプロイ
3. トラフィックの5-10%をCanaryに向ける
4. メトリクスを監視
5. 問題なければトラフィックを段階的に増加
   5% → 10% → 25% → 50% → 100%
6. 問題発生時：Canaryへのトラフィックを0%に
```

### 段階的ロールアウト例

```yaml
# 段階的トラフィック増加
stages:
  - name: canary-5
    traffic_percentage: 5
    duration: 10m

  - name: canary-25
    traffic_percentage: 25
    duration: 30m

  - name: canary-50
    traffic_percentage: 50
    duration: 1h

  - name: full-rollout
    traffic_percentage: 100
```

### 適用条件

- [x] リスクを最小化したい
- [x] 段階的なフィードバックが必要
- [x] トラフィック管理の仕組みがある
- [x] メトリクス監視が整備されている

## Rolling デプロイ

### 概念

```
時点1:  [v1] [v1] [v1] [v1]  ← 全てv1
           ↓
時点2:  [v2] [v1] [v1] [v1]  ← 1つをv2に更新
           ↓
時点3:  [v2] [v2] [v1] [v1]  ← 2つをv2に更新
           ↓
時点4:  [v2] [v2] [v2] [v1]  ← 3つをv2に更新
           ↓
時点5:  [v2] [v2] [v2] [v2]  ← 全てv2に完了
```

### 特徴

| 項目 | 詳細 |
|------|------|
| ダウンタイム | 最小（インスタンス単位） |
| ロールバック | 段階的（逆順でロール） |
| リソース | 追加不要（同じリソース内で） |
| 複雑性 | 低 |
| 互換性 | v1とv2の共存が必要 |

### 実装フロー

```
1. インスタンス1を停止
2. インスタンス1を新バージョンで起動
3. ヘルスチェック確認
4. インスタンス2を停止
5. 以下繰り返し...
```

### パラメータ設定

```yaml
rolling_update:
  max_unavailable: 1      # 同時に停止できる最大数
  max_surge: 1            # 追加で起動できる最大数
  health_check_grace_period: 30s
```

### 適用条件

- [x] リソース効率を重視
- [x] 旧版と新版の共存が可能
- [x] 漸進的な更新が許容される
- [x] データベーススキーマの互換性がある

## 再作成（Recreate）デプロイ

### 概念

```
時点1:  [v1] [v1] [v1] [v1]  ← 全てv1
           ↓
時点2:  [  ] [  ] [  ] [  ]  ← 全て停止
           ↓
時点3:  [v2] [v2] [v2] [v2]  ← 全てv2で起動
```

### 特徴

| 項目 | 詳細 |
|------|------|
| ダウンタイム | あり |
| ロールバック | 新デプロイが必要 |
| リソース | 同等 |
| 複雑性 | 最低 |
| 互換性 | 不要（クリーンな切替） |

### 適用条件

- [x] ダウンタイムが許容される
- [x] シンプルな運用を優先
- [x] v1とv2の共存が不可能
- [x] 開発/ステージング環境

## パターン選択フローチャート

```
ダウンタイム許容？
├─ Yes → Recreate
└─ No
    └─ リソース2倍OK？
        ├─ Yes → Blue-Green
        └─ No
            └─ トラフィック分割可能？
                ├─ Yes → Canary
                └─ No → Rolling
```

## 比較表

| パターン | ダウンタイム | ロールバック速度 | リソースコスト | 複雑性 | 推奨用途 |
|---------|------------|----------------|---------------|-------|---------|
| Blue-Green | なし | 即座 | 高（2倍） | 中 | 本番、重要サービス |
| Canary | なし | 段階的 | 低～中 | 高 | 大規模、リスク重視 |
| Rolling | 最小 | 段階的 | 低 | 低 | 一般的なサービス |
| Recreate | あり | 遅い | 低 | 最低 | 開発、許容環境 |

## Railwayでの実装

### デフォルト動作

Railwayは自動的に以下を実現：

```
1. 新コンテナのビルド
2. 新コンテナの起動
3. ヘルスチェック（設定時）
4. トラフィック切替
5. 旧コンテナ停止
```

これは実質的にBlue-Greenに近い動作です。

### ヘルスチェック設定

```json
{
  "deploy": {
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 30
  }
}
```

### 手動ロールバック

```
Railway Dashboard → Deployments → 前のデプロイを選択 → Rollback
```

## ベストプラクティス

### すべてのパターン共通

1. **ヘルスチェックの実装**
   - アプリケーションレベルのヘルスチェック
   - 依存サービスの確認

2. **メトリクス監視**
   - エラー率
   - レスポンスタイム
   - リソース使用率

3. **ロールバック計画**
   - 手順の文書化
   - 自動ロールバック条件の定義

4. **段階的リリース**
   - 小さな変更を頻繁に
   - 大きな変更は分割

### パターン固有

**Blue-Green**:
- 環境の同期を維持
- データベース移行に注意

**Canary**:
- メトリクス閾値を明確に定義
- 自動進行/ロールバックを設定

**Rolling**:
- API互換性を維持
- セッション管理に注意
