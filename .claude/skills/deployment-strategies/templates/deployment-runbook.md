# デプロイメントランブック

## 概要

このランブックは、本番環境へのデプロイ手順を標準化するためのものです。

---

## デプロイ前チェックリスト

### コード品質

- [ ] すべてのテストが通過している
- [ ] 型チェックがエラーなし
- [ ] Lintエラーがない
- [ ] PRレビューが完了している

### 環境準備

- [ ] 環境変数が設定されている
- [ ] データベースマイグレーションが準備されている
- [ ] 外部サービスの接続情報が最新

### コミュニケーション

- [ ] チームにデプロイ予定を通知
- [ ] 必要に応じてメンテナンス通知

---

## デプロイ手順

### 1. 事前確認

```bash
# 現在の状態確認
git status
git log --oneline -5

# CI/CDステータス確認
gh run list --limit 5
```

### 2. デプロイ実行

#### Railway（推奨）

```bash
# プロジェクト確認
railway status

# デプロイ実行（mainブランチへのpush）
git push origin main

# または手動デプロイ
railway up
```

#### GitHub Actions経由

```bash
# ワークフロー手動実行
gh workflow run deploy.yml

# 実行状況確認
gh run watch
```

### 3. デプロイ監視

```bash
# Railwayログ監視
railway logs --tail

# ヘルスチェック
curl -s https://your-app.railway.app/api/health | jq
```

### 4. 動作確認

```bash
# スモークテスト実行
npx tsx scripts/smoke-test.ts https://your-app.railway.app

# 手動確認項目
# - ログイン機能
# - 主要機能の動作
# - 外部API連携
```

---

## 緊急時対応

### ロールバック手順

```bash
# Railway自動ロールバック
railway rollback

# Git手動ロールバック
git revert HEAD
git push origin main
```

### エスカレーション

| レベル | 条件         | 対応                        |
| ------ | ------------ | --------------------------- |
| L1     | 軽微なバグ   | 次回デプロイで修正          |
| L2     | 機能障害     | 即時ロールバック検討        |
| L3     | サービス停止 | 即時ロールバック + 緊急対応 |

### 連絡先

- **テックリード**: [連絡先]
- **インフラ担当**: [連絡先]
- **プロダクトオーナー**: [連絡先]

---

## デプロイ後確認

### 5分後チェック

- [ ] アプリケーション起動確認
- [ ] ヘルスチェック成功
- [ ] エラーログなし

### 30分後チェック

- [ ] エラーレート正常
- [ ] レスポンスタイム正常
- [ ] ユーザーからのフィードバックなし

### 翌日チェック

- [ ] 夜間バッチ処理成功
- [ ] メトリクス異常なし
- [ ] デプロイ完了報告

---

## トラブルシューティング

### デプロイ失敗

```bash
# ビルドログ確認
railway logs --build

# 一般的な原因
# - 依存関係のインストール失敗
# - TypeScriptコンパイルエラー
# - 環境変数の不足
```

### 起動失敗

```bash
# ランタイムログ確認
railway logs --tail 100

# 一般的な原因
# - ポート設定の問題
# - データベース接続エラー
# - メモリ不足
```

### パフォーマンス低下

```bash
# メトリクス確認
# - CPU使用率
# - メモリ使用量
# - レスポンスタイム

# 対応
# - スケールアップ検討
# - キャッシュ設定確認
# - クエリ最適化
```

---

## 付録

### 環境別URL

| 環境       | URL                         |
| ---------- | --------------------------- |
| Production | https://app.example.com     |
| Staging    | https://staging.example.com |
| Preview    | https://pr-xxx.example.com  |

### 重要なエンドポイント

| エンドポイント      | 用途           |
| ------------------- | -------------- |
| `/api/health`       | ヘルスチェック |
| `/api/health/ready` | 準備状態確認   |
| `/api/health/live`  | 生存確認       |
