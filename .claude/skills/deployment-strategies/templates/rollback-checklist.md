# ロールバックチェックリスト

## デプロイ前確認

### 準備状態
- [ ] 前回の安定バージョンが特定されている
- [ ] ロールバック手順が文書化されている
- [ ] 関係者に通知済み
- [ ] モニタリングダッシュボードを開いている

### 技術的準備
- [ ] データベースマイグレーションの互換性確認
- [ ] API互換性の確認（破壊的変更がないか）
- [ ] 設定ファイルの互換性確認
- [ ] キャッシュ無効化の計画

---

## デプロイ中監視

### ヘルスチェック（デプロイ後5分）
- [ ] アプリケーションが起動している
- [ ] ヘルスエンドポイントが200を返す
- [ ] 基本的なスモークテストが通過

### メトリクス監視（デプロイ後15分）
- [ ] エラーレートが閾値内（< 1%）
- [ ] レスポンスタイムが正常（p99 < 500ms）
- [ ] CPU/メモリ使用量が想定内
- [ ] アクティブ接続数が正常

### ビジネスメトリクス（デプロイ後30分）
- [ ] ユーザーログイン成功
- [ ] 主要機能の動作確認
- [ ] 外部API連携の正常動作

---

## ロールバック判断基準

### 即時ロールバック（自動）
```
条件:
- ヘルスチェック3回連続失敗
- エラーレート > 5%
- アプリケーション起動失敗
```

### 手動ロールバック判断
```
検討条件:
- エラーレート 1-5% が10分継続
- p99レスポンスタイム > 1000ms が5分継続
- ユーザーからの複数クレーム
- データ不整合の検出
```

---

## ロールバック実行手順

### Railway環境

```bash
# 1. 現在のデプロイ状態確認
railway status

# 2. 前回の成功デプロイにロールバック
railway rollback

# 3. ロールバック完了を確認
railway logs --tail
```

### 手動ロールバック（Git）

```bash
# 1. 安定バージョンを確認
git log --oneline -10

# 2. 安定バージョンにチェックアウト
git checkout <stable-commit-hash>

# 3. 強制デプロイ（注意して実行）
git push origin HEAD:main --force
```

---

## ロールバック後確認

### 即時確認（5分以内）
- [ ] アプリケーションが正常起動
- [ ] ヘルスチェック成功
- [ ] エラーレートが正常化

### 詳細確認（30分以内）
- [ ] 全機能の動作確認
- [ ] データ整合性の確認
- [ ] ユーザーへの影響範囲特定

### 事後対応
- [ ] インシデントレポート作成
- [ ] 根本原因分析（RCA）実施
- [ ] 再発防止策の検討
- [ ] 次回デプロイ計画の見直し

---

## データベースロールバック考慮事項

### マイグレーション互換性マトリクス

| シナリオ | 対応 |
|---------|------|
| カラム追加のみ | 安全にロールバック可能 |
| カラム削除 | ロールバック前にデータ復旧が必要 |
| カラム名変更 | 両方向マイグレーションが必要 |
| テーブル削除 | バックアップからの復旧が必要 |

### 安全なマイグレーション戦略

```
1. 追加的変更を優先
2. 削除は次回デプロイで実行
3. 変更は「追加 → 移行 → 削除」の3段階で
```

---

## コミュニケーションテンプレート

### ロールバック開始通知

```
🔄 ロールバック開始

時刻: [YYYY-MM-DD HH:MM]
理由: [簡潔な理由]
影響: [影響範囲]
予想復旧時間: [時間]

担当: [名前]
```

### ロールバック完了通知

```
✅ ロールバック完了

時刻: [YYYY-MM-DD HH:MM]
復旧バージョン: [バージョン/コミット]
影響時間: [分]
影響ユーザー数: [概算]

次のアクション: [RCA実施予定など]
```
