# マイグレーション実行チェックリスト

## 基本情報

| 項目                   | 内容                             |
| ---------------------- | -------------------------------- |
| **日付**               | {{YYYY-MM-DD}}                   |
| **担当者**             | {{名前}}                         |
| **マイグレーション名** | {{マイグレーション名}}           |
| **対象環境**           | ☐ 開発 / ☐ ステージング / ☐ 本番 |
| **予想実行時間**       | {{分}}                           |

---

## 1. 変更内容の確認

### 1.1 DDL変更の種類

- [ ] テーブル作成
- [ ] テーブル削除
- [ ] カラム追加
- [ ] カラム削除
- [ ] カラム名変更
- [ ] データ型変更
- [ ] 制約追加（NOT NULL、UNIQUE、FK）
- [ ] 制約削除
- [ ] インデックス追加
- [ ] インデックス削除

### 1.2 変更の詳細

```sql
-- マイグレーションSQL
{{マイグレーションSQL}}
```

### 1.3 影響範囲

| テーブル       | 行数（概算） | ロック予想時間 |
| -------------- | ------------ | -------------- |
| {{テーブル名}} | {{行数}}     | {{秒}}         |

---

## 2. リスク評価

### 2.1 リスクチェック

| 項目                      | 確認         | 備考 |
| ------------------------- | ------------ | ---- |
| 大量データ更新（>10万行） | ☐ Yes / ☐ No |      |
| テーブルロック発生        | ☐ Yes / ☐ No |      |
| 後方互換性なし            | ☐ Yes / ☐ No |      |
| ロールバック困難          | ☐ Yes / ☐ No |      |
| 本番固有のデータ依存      | ☐ Yes / ☐ No |      |

### 2.2 リスクレベル

- [ ] 🟢 低: 軽微な変更、即座にロールバック可能
- [ ] 🟡 中: 複数ステップ必要、計画的なロールバック
- [ ] 🔴 高: データ移行を伴う、ダウンタイムの可能性

---

## 3. 事前準備

### 3.1 バックアップ

- [ ] データベースフルバックアップ取得
- [ ] 対象テーブルのスナップショット取得

```sql
-- バックアップ確認
SELECT pg_backup_start_time();
```

### 3.2 ステージング検証

- [ ] ステージング環境で実行済み
- [ ] 実行時間: {{秒}}
- [ ] エラーなし確認

### 3.3 ロールバック手順

```sql
-- ロールバックSQL
{{ロールバックSQL}}
```

### 3.4 関係者への通知

- [ ] 開発チームへ通知
- [ ] インフラチームへ通知
- [ ] 必要に応じてユーザーへ通知

---

## 4. 実行前確認

### 4.1 システム状態

```sql
-- アクティブ接続数
SELECT count(*) FROM pg_stat_activity
WHERE state = 'active';

-- ロック状態
SELECT * FROM pg_locks WHERE NOT granted;

-- レプリケーション遅延
SELECT client_addr, state,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as lag_bytes
FROM pg_stat_replication;
```

### 4.2 実行タイミング

- [ ] 低トラフィック時間帯（推奨: {{時間}}）
- [ ] デプロイスケジュールと調整済み
- [ ] 緊急連絡先の確認

---

## 5. 実行ログ

### 5.1 実行コマンド

```bash
# Drizzle Kitの場合
pnpm drizzle-kit push:pg

# 直接SQLの場合
psql -h {{host}} -U {{user}} -d {{database}} -f migration.sql
```

### 5.2 実行結果

| 項目       | 値              |
| ---------- | --------------- |
| 開始時刻   | {{HH:MM:SS}}    |
| 終了時刻   | {{HH:MM:SS}}    |
| 実行時間   | {{秒}}          |
| ステータス | ☐ 成功 / ☐ 失敗 |

### 5.3 実行ログ

```
{{実行ログ}}
```

---

## 6. 実行後確認

### 6.1 スキーマ検証

```sql
-- テーブル構造確認
\d {{テーブル名}}

-- 制約確認
SELECT conname, contype
FROM pg_constraint
WHERE conrelid = '{{テーブル名}}'::regclass;

-- インデックス確認
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = '{{テーブル名}}';
```

### 6.2 データ整合性

```sql
-- レコード数確認
SELECT count(*) FROM {{テーブル名}};

-- NULL値確認（NOT NULL追加時）
SELECT count(*) FROM {{テーブル名}} WHERE {{カラム}} IS NULL;
```

### 6.3 アプリケーション動作

- [ ] API疎通確認
- [ ] クリティカルパス動作確認
- [ ] エラーログ確認

---

## 7. 問題発生時の対応

### 7.1 ロールバック判断基準

- [ ] マイグレーション実行エラー
- [ ] アプリケーションエラー急増
- [ ] パフォーマンス著しい低下
- [ ] データ不整合の検出

### 7.2 ロールバック実行

```bash
# ロールバック実行
psql -h {{host}} -U {{user}} -d {{database}} -f rollback.sql
```

### 7.3 エスカレーション

| 状況       | 連絡先                     |
| ---------- | -------------------------- |
| 軽微な問題 | 開発リーダー: {{名前}}     |
| 重大な問題 | インフラリーダー: {{名前}} |
| 緊急事態   | CTO: {{名前}}              |

---

## 8. 完了確認

### 8.1 最終チェック

- [ ] スキーマ変更が反映されている
- [ ] アプリケーションが正常動作している
- [ ] パフォーマンスに問題がない
- [ ] ドキュメントを更新した

### 8.2 承認

| 役割       | 名前     | 承認日時 |
| ---------- | -------- | -------- |
| 実行者     | {{名前}} | {{日時}} |
| レビュアー | {{名前}} | {{日時}} |

---

## 備考

{{追加のメモや注意点}}
