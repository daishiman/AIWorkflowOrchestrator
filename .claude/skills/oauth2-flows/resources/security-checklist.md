# OAuth 2.0 セキュリティチェックリスト

## 認可リクエストフェーズ

### 必須セキュリティ項目

- [ ] **State Parameter実装**: CSRF対策として必須
  - 32文字以上のランダム文字列
  - 暗号学的に安全な乱数生成器使用
  - セッションまたはセキュアストレージに保存

- [ ] **Redirect URI検証**: オープンリダイレクタ防止
  - 完全一致検証（ホワイトリスト方式）
  - ワイルドカード使用禁止
  - スキーム（https://）も含めた検証
  - 本番環境ではHTTPS必須

- [ ] **Scope最小化**: 最小権限の原則
  - 本当に必要なスコープのみ要求
  - ユーザーに権限の詳細を説明
  - 段階的権限要求の検討

- [ ] **PKCE実装**（SPA/モバイルアプリ）:
  - Code Verifier生成（43-128文字）
  - Code Challenge生成（S256方式）
  - code_challenge_method="S256"指定

## トークン交換フェーズ

### 必須セキュリティ項目

- [ ] **Client Secret保護**:
  - サーバーサイドのみで使用
  - 環境変数で管理
  - バージョン管理システムにコミットしない
  - 定期的にローテーション

- [ ] **認可コード検証**:
  - 一度のみ使用可能
  - 有効期限チェック（通常10分）
  - 再利用検出と拒否

- [ ] **HTTPS通信**:
  - トークン交換は必ずHTTPS
  - 証明書検証を無効化しない
  - TLS 1.2以上使用

- [ ] **エラーハンドリング**:
  - 詳細なエラー情報を漏らさない
  - ユーザーフレンドリーなメッセージ
  - セキュリティイベントをログに記録

## トークン使用フェーズ

### 必須セキュリティ項目

- [ ] **Token Storage**:
  - ❌ localStorage使用禁止（XSS脆弱）
  - ✅ HttpOnly Cookie推奨
  - ✅ メモリ保存（SPA）
  - Cookie属性: Secure, HttpOnly, SameSite

- [ ] **Token Transmission**:
  - Authorization Headerで送信
  - `Bearer ${accessToken}`形式
  - URLパラメータでの送信禁止

- [ ] **Token Validation**:
  - トークン有効期限チェック
  - トークン署名検証（JWT）
  - スコープ検証（API呼び出し時）

- [ ] **Token Expiration**:
  - アクセストークン: 短命（15分-1時間）
  - リフレッシュトークン: 長命（30日-90日）
  - 期限切れ時の自動リフレッシュ

## CSRF対策（多層防御）

- [ ] **State Parameter**: OAuth 2.0レベルのCSRF対策
- [ ] **SameSite Cookie**: Cookie送信制限（Lax/Strict）
- [ ] **CSRFトークン**: アプリケーションレベルの追加保護
- [ ] **Origin/Referer検証**: リクエスト元の検証

## XSS対策

- [ ] **Content Security Policy**: スクリプト実行制限
- [ ] **入力サニタイゼーション**: ユーザー入力のエスケープ
- [ ] **HttpOnly Cookie**: JavaScriptからのアクセス防止
- [ ] **出力エンコーディング**: HTML/JS/URLコンテキストに応じた適切なエスケープ

## セッションセキュリティ

- [ ] **Session Fixation対策**:
  - ログイン成功時にセッションID再生成
  - 認証前後でセッションIDを変更

- [ ] **Session Hijacking対策**:
  - Secure Cookie属性（HTTPS必須）
  - HttpOnly Cookie属性（XSS防止）
  - セッションタイムアウト実装
  - デバイス/IP変更検出

- [ ] **Concurrent Session Control**:
  - 同時ログイン数制限（必要に応じて）
  - 異常なセッションアクティビティ検出

## プロバイダー設定

- [ ] **Callback URL設定**:
  - 開発環境と本番環境で分離
  - HTTPSを使用（本番環境）
  - 完全一致で登録（パス含む）

- [ ] **Client Credentials管理**:
  - Client IDは公開情報として扱う
  - Client Secretは機密情報として厳重管理
  - 環境変数で管理、.envは.gitignoreに含める

- [ ] **Scope設定**:
  - プロバイダーが提供するスコープを確認
  - 必要最小限のスコープを要求
  - スコープの詳細をユーザーに説明

## エラーハンドリング

- [ ] **認可エラー**:
  - `error`パラメータをチェック
  - `error_description`を記録
  - ユーザーに適切なメッセージ表示

- [ ] **トークンエラー**:
  - HTTPステータスコード確認
  - エラーレスポンス解析
  - リトライ戦略実装（一時的障害）

- [ ] **ネットワークエラー**:
  - タイムアウト設定（10秒推奨）
  - Exponential Backoff実装
  - Circuit Breaker検討（連続失敗時）

## ロギングとモニタリング

- [ ] **認証イベントログ**:
  - 認証開始、成功、失敗を記録
  - ユーザーID、プロバイダー、タイムスタンプ
  - 失敗理由（エラーコード）

- [ ] **セキュリティイベント**:
  - State mismatch検出
  - 認可コード再利用検出
  - 異常なトークン更新パターン

- [ ] **パフォーマンスメトリクス**:
  - 認証フロー完了時間
  - トークン交換レスポンスタイム
  - 認証成功率

## コンプライアンス

- [ ] **OAuth 2.0仕様準拠**:
  - RFC 6749に準拠
  - RFC 7636（PKCE）準拠（該当する場合）
  - OAuth 2.0 Security Best Current Practice準拠

- [ ] **プライバシー**:
  - ユーザーデータの最小収集
  - データ保持期間の定義
  - ユーザーによるアクセス許可取り消し機能

- [ ] **アクセシビリティ**:
  - ログインフローのWCAG準拠
  - スクリーンリーダー対応
  - キーボードナビゲーション対応

## デプロイ前チェック

### 環境変数

- [ ] `OAUTH_CLIENT_ID`が設定されているか？
- [ ] `OAUTH_CLIENT_SECRET`が設定されているか（サーバーサイドのみ）？
- [ ] `OAUTH_REDIRECT_URI`が正しいか？
- [ ] 本番と開発で環境変数が分離されているか？

### プロバイダー設定

- [ ] OAuth 2.0プロバイダーにアプリケーションが登録されているか？
- [ ] Redirect URIが登録されているか？
- [ ] スコープが承認されているか？

### セキュリティ設定

- [ ] HTTPS証明書が有効か（本番環境）？
- [ ] セキュリティヘッダーが設定されているか？
- [ ] CSRF対策が実装されているか？
- [ ] XSS対策が実装されているか？

### テスト

- [ ] 正常系フローのE2Eテストがパスしているか？
- [ ] エラーケースのテストがパスしているか？
- [ ] セキュリティテストがパスしているか？

## トラブルシューティングガイド

### デバッグ手法

1. **ブラウザDevToolsでネットワークタブ確認**:
   - 認可リクエストのパラメータ
   - コールバックURLのパラメータ
   - トークンリクエスト/レスポンス

2. **認可サーバーのログ確認**:
   - エラーコードとエラーメッセージ
   - IPアドレスとユーザーエージェント

3. **ステップバイステップ検証**:
   - State生成 → 保存 → 検証
   - Code Verifier生成 → Code Challenge生成 → 検証
   - 認可コード取得 → トークン交換

### よくある問題

**"invalid_grant"エラー**:

- 認可コードが期限切れ（通常10分）
- 認可コードが再利用された
- redirect_uriが一致しない

**"invalid_client"エラー**:

- Client IDまたはClient Secretが不正
- Client Secretが漏洩していないか確認

**"State mismatch"エラー**:

- セッションストレージの保存/取得ロジック確認
- 同一ブラウザセッションでフロー完結しているか確認

## まとめ

**OAuth 2.0実装の成功基準**:

1. ✅ 適切なフロー選択（サーバーサイド/SPA/モバイル）
2. ✅ PKCEによるパブリッククライアント保護
3. ✅ State ParamによるCSRF対策
4. ✅ セキュアなトークンストレージ
5. ✅ 包括的なエラーハンドリング
6. ✅ 十分なテストカバレッジ

**参照**:

- 実装テンプレート: `.claude/skills/oauth2-flows/templates/`
- 検証スクリプト: `.claude/skills/oauth2-flows/scripts/`
