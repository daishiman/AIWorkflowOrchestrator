# 要件定義書: [プロジェクト名/機能名]

**バージョン**: 1.0.0
**作成日**: YYYY-MM-DD
**最終更新**: YYYY-MM-DD
**作成者**: [名前]
**レビュー者**: [名前]
**承認者**: [名前]

---

## 1. 概要

### 1.1 目的
[このドキュメントの目的と対象読者]

### 1.2 背景
[プロジェクトの背景、ビジネスゴール]

### 1.3 スコープ
**含まれるもの**:
- [スコープに含まれる機能や領域]

**含まれないもの**:
- [明示的にスコープ外とするもの]

---

## 2. ステークホルダー

### 2.1 プライマリステークホルダー
| ロール | 名前 | 責任 | 連絡先 |
|--------|------|------|--------|
| プロジェクトオーナー | [名前] | 最終意思決定 | [email] |
| プロダクトマネージャー | [名前] | 要件定義、優先順位付け | [email] |

### 2.2 セカンダリステークホルダー
| ロール | 名前 | 関与内容 | 連絡先 |
|--------|------|---------|--------|
| 開発リーダー | [名前] | 技術実現可能性評価 | [email] |
| QAリーダー | [名前] | テスト戦略策定 | [email] |

---

## 3. ビジネス要求

### 3.1 ビジネスゴール
[達成したいビジネス上の目標]

### 3.2 成功基準
| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| [KPI名] | [目標] | [測定方法] |

### 3.3 制約

#### 技術スタック制約
- **フロントエンド**: Next.js 15.x (App Router), React, TypeScript 5.x
- **バックエンド**: Node.js 22.x LTS
- **データベース**: Neon (PostgreSQL + pgvector), Drizzle ORM
- **AI統合**: Vercel AI SDK 4.x (OpenAI, Anthropic, Google, xAI対応)
- **外部連携**: discord.js 14.x, googleapis
- **デプロイ**: Railway (Nixpacks), GitHub Actions
- **パッケージマネージャー**: pnpm 9.x
- **テスト**: Vitest 2.x, Playwright

#### アーキテクチャ制約（必須遵守）
- **Clean Architecture原則**: 依存関係は外→内（Infrastructure → Application → Domain）
- **ハイブリッド構造**:
  - 共通インフラ: `src/shared/core/` (ドメインルール、外部依存ゼロ)
  - 共通サービス: `src/shared/infrastructure/` (DB, AI, Discord等の共通接続)
  - 機能プラグイン: `src/features/[機能名]/` (垂直スライス、機能間依存禁止)
  - API層: `src/app/` (Next.js App Router)
- **依存関係ルール**: ESLint boundaries プラグインで強制
- **機能独立性**: features/ 内の各機能は相互依存禁止、共通インフラのみ利用可

#### 開発プロセス制約（必須遵守）
- **Specification-Driven Development**: 仕様書（本ドキュメント）を正本とし、実装はその変換結果
- **TDD必須**: すべての機能追加は以下の順序で実施
  1. 仕様書作成（`docs/20-specifications/features/[機能名].md`）
  2. テスト作成（`features/[機能名]/__tests__/executor.test.ts`）
  3. Red（テスト失敗確認）
  4. スキーマ定義（`schema.ts`）
  5. Executor実装（`executor.ts`）
  6. Green（テストパス確認）
  7. Refactor（コード改善）
- **テストピラミッド**: 静的テスト（100%） > ユニットテスト（60%+） > 統合テスト（主要フロー） > E2E（クリティカルパス）

#### その他の制約
- **スケジュール制約**: [リリース予定日、マイルストーン]
- **予算制約**: [予算上限、リソース制約]
- **法規制**: [準拠すべき法規制、標準]

---

## 4. 機能要件

### FR-001: [機能名]

**優先度**: Must have / Should have / Could have / Won't have

**概要**:
[機能の簡潔な説明]

**詳細**:
[機能の詳細な説明]

**前提条件**:
- [実行前に満たすべき条件]

**入力**:
| 項目 | 型 | 必須 | 制約 | 例 |
|------|-----|------|------|-----|
| [項目名] | [型] | Yes/No | [制約] | [例] |

**出力**:
| 項目 | 型 | 制約 | 例 |
|------|-----|------|-----|
| [項目名] | [型] | [制約] | [例] |

**処理フロー**:
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

**ビジネスルール**:
- [BR-001]: [ルール記述]

**受け入れ基準**:

**シナリオ1: [正常系の名前]**
- **Given**: [前提条件]
- **When**: [実行するアクション]
- **Then**: [期待される結果]

**シナリオ2: [異常系の名前]**
- **Given**: [前提条件]
- **When**: [実行するアクション]
- **Then**: [期待される結果]

**関連要件**: [他の要件とのリンク]

---

## 5. 非機能要件

### NFR-001: パフォーマンス

**カテゴリ**: Performance

**要件**:
[非機能要件の記述]

**測定指標**:
| 指標 | 目標値 | 測定方法 | 測定タイミング |
|------|--------|---------|--------------|
| API応答時間 | <200ms (95%ile) | APM監視 | 常時 |
| スループット | >1000 req/sec | 負荷テスト | リリース前 |

**優先度**: High / Medium / Low

**関連機能要件**: FR-001, FR-002

---

## 6. ユースケース

### UC-001: [ユースケース名]

**ID**: UC-001
**アクター**: [プライマリアクター]、[セカンダリアクター]
**ゴール**: [ユーザーが達成したいこと]

**事前条件**:
- [実行前に満たすべき状態]

**基本フロー**（正常系）:
1. [アクター]が[アクション]
2. システムが[応答]
3. ...

**代替フロー**（異常系・分岐）:
- 2a. [条件]の場合: [代替処理]

**例外フロー**（エラー）:
- E1. [エラー条件]: [エラー処理]

**事後条件**:
- [実行後の期待状態]

**関連要件**: FR-001, NFR-001

---

## 7. データモデル

### 7.1 エンティティ定義

**Entity: User**

| 属性名 | 型 | 必須 | 制約 | 説明 |
|--------|-----|------|------|------|
| id | UUID | Yes | Primary Key | ユーザーID |
| email | String | Yes | Unique, Email Format | メールアドレス |
| name | String | Yes | 1-100文字 | ユーザー名 |
| created_at | Timestamp | Yes | Auto | 作成日時 |

### 7.2 関連図
[ER図またはテキストベースの関連記述]

---

## 8. 用語集

### 8.1 プロジェクト固有の用語（必須定義）

| 用語 | 定義 | 補足 |
|------|------|------|
| **Workflow** | システムが実行する一連の処理単位 | DBの`workflows`テーブルに対応、type識別子で機能を特定 |
| **Executor** | Workflowを実行するクラス | `IWorkflowExecutor`インターフェースを実装、features/各機能に配置 |
| **Registry** | type文字列とExecutorクラスの対応表 | `features/registry.ts`で管理、新機能追加時に登録 |
| **Local Agent** | PC上で動作するファイル監視・同期プログラム | PM2で常駐、Chokidarでファイル監視、Railway APIと通信 |
| **ハイブリッドアーキテクチャ** | shared（共通インフラ）とfeatures（機能プラグイン）を組み合わせた構造 | 垂直スライスと水平レイヤーの両立 |
| **垂直スライス** | 機能ごとに必要な全要素（schema, executor, tests）を1フォルダに集約する設計手法 | features/各機能で適用 |
| **shared/core/** | 複数機能で共有するドメインルール（エンティティ、インターフェース、エラー） | 外部依存ゼロ、純粋なビジネスロジック |
| **shared/infrastructure/** | 複数機能で共有する外部サービス接続（DB, AI, Discord） | 共通インフラ、features/から利用 |
| **pgvector** | PostgreSQLのベクトル検索拡張 | AI埋め込みベクトルの保存と類似検索、Neonでネイティブサポート |
| **JSONB** | PostgreSQLの柔軟なJSON型カラム | workflows.input_payload/output_payloadで使用、スキーマレス設計 |
| **TDD** | Test-Driven Development（テスト駆動開発） | 仕様書 → テスト → 実装の順序を必須とする開発手法 |

### 8.2 技術用語

| 用語 | 定義 | 補足 |
|------|------|------|
| **Neon** | Serverless PostgreSQL | 自動スケーリング、Railway統合 |
| **Railway** | 本システムのホスティング環境 | Nixpacksビルダー、Git連動デプロイ |
| **Nixpacks** | Railwayのビルダー | Dockerfile不要、自動コンテナ化 |
| **構造化ログ** | JSON形式のログ | request_id/workflow_id/user_idで追跡可能 |
| **一時ストレージ** | Railwayの/tmpディレクトリ | 再デプロイ時に削除、永続化不要 |
| **ソフトデリート** | deleted_atカラムで論理削除する手法 | 物理削除せず、データ復旧可能 |
| **サーキットブレーカー** | 外部API障害時に一時的に呼び出しを遮断し、システム全体を保護するパターン | 将来対応、連続5回失敗で回路オープン |

### 8.3 カスタム用語（プロジェクト固有で追加）

| 用語 | 定義 | 補足 |
|------|------|------|
| [用語名] | [定義] | [補足説明] |

---

## 9. 前提と依存関係

### 9.1 前提
- [プロジェクトの前提条件]

### 9.2 依存関係
| 要件ID | 依存先要件ID | 依存関係の説明 |
|--------|------------|--------------|
| FR-002 | FR-001 | FR-001の完了後に実装可能 |

---

## 10. リスクと対策

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 | 責任者 |
|---------|----------|--------|---------|------|--------|
| R-001 | [リスク] | High/Medium/Low | High/Medium/Low | [対策] | [名前] |

---

## 11. 要件追跡マトリクス

| 要件ID | 機能要件 | 非機能要件 | ユースケース | 受け入れ基準 | ステータス |
|--------|---------|-----------|------------|------------|----------|
| FR-001 | ユーザー登録 | NFR-001 | UC-001 | AC-001-1, AC-001-2 | 確定 |
| FR-002 | ログイン | NFR-002 | UC-002 | AC-002-1 | レビュー中 |

**ステータス定義**:
- **Draft**: 初稿、未レビュー
- **レビュー中**: レビュー依頼済み
- **確定**: レビュー完了、承認済み
- **保留**: 意思決定待ち
- **却下**: スコープ外

---

## 12. レビュー履歴

| 日付 | バージョン | レビュー者 | コメント | 対応状況 |
|------|----------|----------|---------|---------|
| YYYY-MM-DD | 0.9 | [名前] | [コメント] | 対応完了 |

---

## 13. 承認

| ロール | 名前 | 署名 | 日付 |
|--------|------|------|------|
| プロジェクトオーナー | [名前] | [署名] | YYYY-MM-DD |
| プロダクトマネージャー | [名前] | [署名] | YYYY-MM-DD |

---

## 付録A: 画面遷移図
[画面遷移図またはテキストベースの遷移記述]

## 付録B: API仕様概要
[API仕様の概要または詳細仕様書へのリンク]

## 付録C: 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|----------|------|--------|---------|
| 1.0.0 | YYYY-MM-DD | [名前] | 初版作成 |
