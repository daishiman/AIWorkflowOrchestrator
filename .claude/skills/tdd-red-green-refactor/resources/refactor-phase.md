# Refactor Phase（リファクタリングフェーズ）

## 概要

Refactorフェーズは、TDDサイクルの3番目のステップです。
テストがグリーンの状態を維持しながら、コードを改善します。

## 目的

- コードの可読性を向上させる
- 重複を排除する
- 設計を改善する
- 技術的負債を返済する

## 手順

### Step 1: 改善点の特定

コードの問題点を特定する。

**チェック項目**:
- 重複コードはないか？
- 命名は適切か？
- 構造は理解しやすいか？
- 関数は小さいか？

### Step 2: 一つずつ改善

一度に一つの改善を行う。

**プロセス**:
1. 改善を適用
2. テストを実行
3. グリーンを確認
4. 次の改善へ

### Step 3: テストの確認

すべてのテストがグリーンのままであることを確認する。

## リファクタリングの種類

### 重複の排除

同じコードが複数箇所にある場合、共通関数に抽出する。

**判断基準**:
- 3回以上の重複
- 概念的に同じ処理

### 命名の改善

変数名、関数名をより明確にする。

**判断基準**:
- 名前だけで意図が分かるか？
- ドメイン用語を使っているか？

### 構造の改善

コードの構造を整理する。

**手法**:
- Extract Method
- Extract Variable
- Inline Variable/Method

### 設計の改善

より良い設計パターンを適用する。

**判断基準**:
- 変更に対して柔軟か？
- テストしやすいか？
- 責任が明確か？

## Refactorフェーズのルール

### テストを壊さない

すべてのテストがグリーンのまま維持する。

**もしテストが壊れたら**:
1. 直前の変更を取り消す
2. より小さなステップで再試行

### 振る舞いを変えない

外部から見た振る舞いは変更しない。

**確認方法**:
- テストがすべて通る
- 入力と出力が同じ

### 小さなステップ

一度に一つの改善だけを行う。

**理由**:
- 問題が起きた時に原因を特定しやすい
- 常に動作する状態を維持

## チェックリスト

### リファクタリング前

- [ ] テストがすべてグリーンか？
- [ ] 改善すべき点を特定したか？
- [ ] 一つの改善に絞ったか？

### リファクタリング後

- [ ] テストがすべてグリーンか？
- [ ] コードが改善されたか？
- [ ] 次の改善点はあるか？

## リファクタリングの優先順位

### 高優先度

1. 重複の排除
2. 明らかに分かりにくい命名の改善
3. 長すぎるメソッドの分割

### 中優先度

4. 設計パターンの適用
5. パフォーマンスの改善
6. コメントをコードで表現

### 低優先度

7. スタイルの統一
8. 微細な命名の改善

## 避けるべきこと

### 新機能の追加

**問題**: リファクタリングと称して新機能を追加

**対処**: 新機能は新しいRed-Green-Refactorサイクルで

### 大きな変更

**問題**: 一度に大きなリファクタリングを行う

**対処**: 小さなステップに分割

### テストなしのリファクタリング

**問題**: テストを無視してリファクタリング

**対処**: 常にテストを実行して確認
