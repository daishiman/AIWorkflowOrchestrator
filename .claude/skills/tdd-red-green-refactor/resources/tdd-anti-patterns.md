# TDDアンチパターン

## 概要

TDDを実践する際に陥りがちなアンチパターンと、その対処法を解説します。

## プロセスに関するアンチパターン

### 1. テストを後から書く（Test After）

**症状**: 実装を先に書いてから、後でテストを追加する

**問題**:

- テスト可能な設計にならない
- テストが実装に引きずられる
- カバレッジは高いが品質が低い

**対処**:

- 必ずテストを先に書く
- 「テストなしで実装を始めない」をルール化

### 2. 複数のテストを一度に書く

**症状**: 10個のテストを書いてから実装を始める

**問題**:

- 最初のテストを通すのに時間がかかる
- テストと実装の対応が不明確
- モチベーション低下

**対処**:

- 一つずつテスト→実装を繰り返す
- 小さな成功を積み重ねる

### 3. リファクタリングをスキップ

**症状**: Green後すぐに次のテストへ進む

**問題**:

- 技術的負債が蓄積
- コードが徐々に劣化
- 後での改善が困難

**対処**:

- Greenになったら必ずRefactorフェーズを設ける
- 「今は良いけど後で」を避ける

## テストに関するアンチパターン

### 4. 脆いテスト（Fragile Test）

**症状**: 実装の小さな変更でテストが壊れる

**問題**:

- テストのメンテナンスコストが高い
- リファクタリングを躊躇
- テストへの信頼低下

**対処**:

- 実装詳細ではなく振る舞いをテスト
- 過度なモック使用を避ける
- パブリックAPIをテスト

### 5. 遅いテスト（Slow Test）

**症状**: テストの実行に時間がかかる

**問題**:

- フィードバックループが長い
- テスト実行を避けるようになる
- CI/CDが遅くなる

**対処**:

- 外部依存をモックに置換
- テストを並列実行
- 不要なセットアップを削減

### 6. 不安定なテスト（Flaky Test）

**症状**: 同じコードで時々失敗する

**問題**:

- テストへの信頼低下
- 失敗を無視するようになる
- デバッグに時間がかかる

**原因と対処**:

- 時間依存: 固定の時間を使用
- 順序依存: テストの独立性を確保
- 非同期処理: 適切な待機を実装

### 7. 神のテスト（God Test）

**症状**: 一つのテストで多くのことを検証

**問題**:

- 失敗時に原因特定が困難
- テストが理解しにくい
- メンテナンスが困難

**対処**:

- 一つのテストは一つのことだけを検証
- テストを分割

## 設計に関するアンチパターン

### 8. テスト不可能な設計

**症状**: テストを書くのが困難な設計

**問題**:

- モックが困難
- 依存関係が複雑
- セットアップが大量に必要

**原因**:

- 依存性の直接生成
- グローバル状態
- 密結合

**対処**:

- 依存性注入を使用
- インターフェースに依存
- 単一責任原則を守る

### 9. 過剰なモック（Mock Hell）

**症状**: モックだらけのテスト

**問題**:

- テストが実装詳細に依存
- 実際の動作と乖離
- リファクタリングが困難

**対処**:

- 必要最小限のモック
- 統合テストとのバランス
- テストダブルの種類を適切に選択

## カバレッジに関するアンチパターン

### 10. カバレッジ至上主義

**症状**: カバレッジ100%を目標にする

**問題**:

- 無意味なテストが増える
- コストが高い
- 真に重要なテストが埋もれる

**対処**:

- 重要な振る舞いを優先
- 80%程度を目標に
- カバレッジよりも品質

### 11. アサーションなしのテスト

**症状**: カバレッジのためだけに書かれたテスト

**問題**:

- 何も検証していない
- 偽のセキュリティ
- バグを見逃す

**対処**:

- 各テストに明確なアサーション
- テストの目的を明確に

## チェックリスト

### TDD実践時

- [ ] テストを先に書いているか？
- [ ] 一度に一つのテストだけを書いているか？
- [ ] Refactorフェーズを行っているか？

### テスト品質

- [ ] テストは高速か？
- [ ] テストは安定しているか？
- [ ] テストは一つのことだけを検証しているか？
- [ ] テストは振る舞いをテストしているか？
