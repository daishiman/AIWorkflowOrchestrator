# テスト安定性チェックリスト

このチェックリストを使用して、E2Eテストの安定性を体系的に検証し、フレーキーテストを防止します。

---

## 目次

1. [テスト設計の安定性](#テスト設計の安定性)
2. [データ管理の安定性](#データ管理の安定性)
3. [タイミングと待機の安定性](#タイミングと待機の安定性)
4. [外部依存の安定性](#外部依存の安定性)
5. [並列実行の安定性](#並列実行の安定性)
6. [環境設定の安定性](#環境設定の安定性)

---

## テスト設計の安定性

### 基本原則

- [ ] **テストは独立している**: 他のテストの実行順序や結果に依存しない
- [ ] **テストは冪等性がある**: 同じテストを複数回実行しても同じ結果
- [ ] **テストは決定的である**: 実行ごとに異なる結果を返さない
- [ ] **テストは単一責任**: 1つのテストで1つの機能/シナリオのみを検証

### 非決定性のチェック

- [ ] **時刻依存を排除**: `new Date()`や`Date.now()`を直接使用していない
- [ ] **ランダム性を排除**: `Math.random()`やランダムな要素選択を使用していない
- [ ] **固定値を使用**: テストデータは明示的に定義されている
- [ ] **環境依存を排除**: ローカル、CI、ステージングで同じ結果

### セレクター安定性

- [ ] **安定したセレクター**: `data-testid`や`role`などの安定した属性を使用
- [ ] **脆弱なセレクターを避ける**: CSSクラスや要素の順序に依存しない
- [ ] **テキストコンテンツの注意**: 多言語対応やUIコピーの変更に影響されない

```typescript
// ✅ 良い例: data-testidを使用
await page.click('[data-testid="submit-button"]');

// ⚠️ 悪い例: CSSクラスに依存
await page.click(".btn.btn-primary.submit");

// ⚠️ 悪い例: 要素の順序に依存
await page.click("button >> nth=2");
```

---

## データ管理の安定性

### テストデータの一意性

- [ ] **一意のメールアドレス**: タイムスタンプやUUIDで一意性を確保
- [ ] **一意のリソース名**: プロジェクト名、タスク名などが他のテストと衝突しない
- [ ] **一意のID**: データベースの主キー、UUID、カスタムIDが重複しない
- [ ] **Worker ID使用**: 並列実行時にワーカーごとに異なるデータセット

### クリーンアップ

- [ ] **beforeEach/afterEachでクリーンアップ**: テスト前後で確実にデータを削除
- [ ] **Fixtureで自動クリーンアップ**: 手動管理ではなく、自動化されたクリーンアップ
- [ ] **外部キー制約を考慮**: 削除順序が正しい（子 → 親）
- [ ] **トランザクションロールバック**: データベーステストではロールバックを活用

### Seedingの安定性

- [ ] **決定的なSeeding**: Seedingの結果が毎回同じ
- [ ] **並列実行対応**: 並列実行時にSeedingが競合しない
- [ ] **適切なSeeding戦略**: API、DB、Fixtureのいずれかを適切に選択

```typescript
// ✅ 良い例: 一意性を確保したSeeding
const uniqueEmail = `user_${Date.now()}_${Math.random().toString(36).slice(2)}@test.com`;

// ❌ 悪い例: 固定のメールアドレス
const email = "testuser@test.com"; // 並列実行で衝突
```

---

## タイミングと待機の安定性

### 適切な待機戦略

- [ ] **`waitForTimeout`を使用しない**: 固定待機時間ではなく、条件ベースの待機
- [ ] **Playwrightの自動待機を活用**: `expect`と`locator`が自動的に待機
- [ ] **明示的な待機**: 必要に応じて`waitForSelector`、`waitForResponse`を使用
- [ ] **タイムアウト値が適切**: 環境に応じた適切なタイムアウト（10〜30秒）

### 非同期処理の待機

- [ ] **APIレスポンスを待つ**: `waitForResponse`でAPIの完了を確認
- [ ] **ネットワークアイドルを待つ**: `waitUntil: 'networkidle'`で非同期処理の完了を確認
- [ ] **要素の状態を待つ**: `toBeVisible()`, `toBeEnabled()`で要素が操作可能になるまで待機
- [ ] **アニメーション完了を待つ**: アニメーション無効化またはアニメーション完了を待機

```typescript
// ✅ 良い例: 条件ベースの待機
await expect(page.locator(".data")).toBeVisible({ timeout: 30000 });

// ❌ 悪い例: 固定待機時間
await page.waitForTimeout(3000);
```

---

## 外部依存の安定性

### 外部API

- [ ] **外部APIをモック**: MSW（Mock Service Worker）で外部APIをモック
- [ ] **レート制限対策**: モックまたはリトライロジックで対応
- [ ] **ネットワークエラー処理**: 外部APIの障害に対してリトライ
- [ ] **認証トークン管理**: トークンの有効期限や更新ロジックを考慮

### サードパーティサービス

- [ ] **外部サービスをモック**: 決済、認証、CDNなどをモック
- [ ] **テスト環境用のサービス**: Stripe Test Mode、Auth0 Dev Tenant
- [ ] **フォールバック**: 外部サービス障害時の代替手段

```typescript
// ✅ 良い例: MSWで外部APIをモック
import { http, HttpResponse } from "msw";
import { setupServer } from "msw/node";

const server = setupServer(
  http.get("https://api.external.com/data", () => {
    return HttpResponse.json({ data: "mocked" });
  }),
);

test.beforeAll(() => server.listen());
test.afterAll(() => server.close());
```

---

## 並列実行の安定性

### データ分離

- [ ] **テストごとに独立したデータ**: 並列実行時にデータが競合しない
- [ ] **一意のプレフィックス/タグ**: タイムスタンプやworker IDでデータを分離
- [ ] **テナント分離**: マルチテナントアプリケーションではテナントごとに分離
- [ ] **名前空間パターン**: テストごとに専用の名前空間を使用

### リソース競合

- [ ] **共有リソースを使用しない**: グローバル状態や共有ファイルに依存しない
- [ ] **排他制御**: 必要に応じてロックやセマフォを使用
- [ ] **Worker数の制限**: CI環境ではworker数を制限（2〜4個）

```typescript
// ✅ 良い例: Worker IDで分離
const uniqueEmail = `user_w${testInfo.parallelIndex}_${Date.now()}@test.com`;

// ❌ 悪い例: 固定リソースに依存
const sharedFile = "./shared-data.json"; // 並列実行で競合
```

---

## 環境設定の安定性

### 環境変数

- [ ] **必須の環境変数が設定されている**: `BASE_URL`, `DATABASE_URL`など
- [ ] **環境ごとの設定**: ローカル、CI、ステージングで適切な値
- [ ] **デフォルト値**: 環境変数が未設定でもテストが動作するようデフォルト値を提供

### データベース

- [ ] **テスト専用DB**: 本番データベースを使用しない
- [ ] **マイグレーション実行**: テスト前にスキーマを最新に
- [ ] **接続プール管理**: 接続リークを防ぐ

### ブラウザとビューポート

- [ ] **ヘッドレスモード**: CI環境ではヘッドレスモードで実行
- [ ] **固定ビューポート**: テストごとに一貫したビューポートサイズ
- [ ] **タイムゾーン固定**: `TZ=UTC`で統一

```typescript
// playwright.config.ts
export default defineConfig({
  use: {
    baseURL: process.env.BASE_URL || "http://localhost:3000",
    viewport: { width: 1280, height: 720 }, // 固定
    timezoneId: "UTC", // UTC固定
    locale: "ja-JP",
  },
});
```

---

## チェックリストの使い方

### 新規テスト作成時

1. **このチェックリストを参照**: すべての項目を確認
2. **最低限のチェック**: テスト設計、データ管理、タイミングの3セクションは必須
3. **並列実行テスト**: ローカルで`--workers=4`で実行して確認

### 既存テストのレビュー時

1. **フレーキーテストを特定**: 失敗履歴を確認
2. **チェックリストで診断**: どの項目が不足しているか確認
3. **優先度付け**: クリティカルな項目から修正

### CI/CDパイプライン

1. **リトライ設定**: `retries: 2`を設定
2. **トレース記録**: `trace: 'on-first-retry'`で失敗原因を記録
3. **並列実行制限**: `workers: 2`でリソース制約を考慮

---

## 安定性スコアリング

各セクションの達成率を計算し、安定性スコアを算出します。

| セクション | 達成項目 / 総項目 | 達成率 |
| ---------- | ----------------- | ------ |
| テスト設計 | X / Y             | %      |
| データ管理 | X / Y             | %      |
| タイミング | X / Y             | %      |
| 外部依存   | X / Y             | %      |
| 並列実行   | X / Y             | %      |
| 環境設定   | X / Y             | %      |

**総合安定性スコア**: 平均達成率

**目標**:

- **90%以上**: 優れた安定性
- **75-89%**: 良好、いくつかの改善点あり
- **60-74%**: 要改善、フレーキーテストのリスクあり
- **60%未満**: 緊急改善が必要

---

## まとめ

このチェックリストを使用して、E2Eテストの安定性を体系的に向上させることができます。

**推奨アプローチ**:

1. 新規テスト作成時にチェックリストを確認
2. フレーキーテスト発生時にチェックリストで診断
3. 定期的に既存テストをレビュー
4. CI/CDパイプラインで安定性スコアを追跡

安定したテストは、開発速度と品質の両立に不可欠です。
