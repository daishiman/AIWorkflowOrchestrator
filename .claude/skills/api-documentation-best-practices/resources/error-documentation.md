# エラードキュメンテーション

## 概要

APIのエラーレスポンスを明確に文書化し、API利用者がエラー発生時に適切に対処できるようにします。

## エラーレスポンス形式

### 標準フォーマット

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "人間が読めるエラーメッセージ",
    "details": {},
    "requestId": "req_abc123"
  }
}
```

| フィールド | 型 | 必須 | 説明 |
|:-----------|:---|:----:|:-----|
| `code` | string | ○ | 機械処理用のエラーコード |
| `message` | string | ○ | 人間が読めるメッセージ |
| `details` | object | - | 追加のエラー情報 |
| `requestId` | string | - | リクエスト追跡用ID |

## HTTPステータスコード

### 4xx クライアントエラー

| コード | 名前 | 用途 |
|:-------|:-----|:-----|
| 400 | Bad Request | リクエスト形式不正、バリデーションエラー |
| 401 | Unauthorized | 認証が必要、トークン無効 |
| 403 | Forbidden | 権限不足 |
| 404 | Not Found | リソースが存在しない |
| 409 | Conflict | リソースの競合（重複など） |
| 422 | Unprocessable Entity | セマンティックエラー |
| 429 | Too Many Requests | レート制限超過 |

### 5xx サーバーエラー

| コード | 名前 | 用途 |
|:-------|:-----|:-----|
| 500 | Internal Server Error | サーバー内部エラー |
| 502 | Bad Gateway | 外部サービス接続エラー |
| 503 | Service Unavailable | サービス一時停止 |
| 504 | Gateway Timeout | 外部サービスタイムアウト |

## エラーコード一覧

### 認証・認可エラー

| コード | HTTP | 説明 | 対処方法 |
|:-------|:-----|:-----|:---------|
| `UNAUTHORIZED` | 401 | 認証が必要 | 有効なトークンを取得 |
| `TOKEN_EXPIRED` | 401 | トークン期限切れ | トークンを更新 |
| `INVALID_TOKEN` | 401 | トークンが無効 | 再認証 |
| `FORBIDDEN` | 403 | 権限不足 | 管理者に権限付与を依頼 |

### バリデーションエラー

| コード | HTTP | 説明 | 対処方法 |
|:-------|:-----|:-----|:---------|
| `VALIDATION_ERROR` | 400 | 入力値不正 | detailsを確認し修正 |
| `MISSING_FIELD` | 400 | 必須フィールド欠落 | 必須項目を追加 |
| `INVALID_FORMAT` | 400 | 形式不正 | 正しい形式で入力 |

### リソースエラー

| コード | HTTP | 説明 | 対処方法 |
|:-------|:-----|:-----|:---------|
| `NOT_FOUND` | 404 | リソース未検出 | IDを確認 |
| `ALREADY_EXISTS` | 409 | リソース重複 | 別の値を使用 |
| `CONFLICT` | 409 | 状態の競合 | 最新状態を取得して再試行 |

### システムエラー

| コード | HTTP | 説明 | 対処方法 |
|:-------|:-----|:-----|:---------|
| `INTERNAL_ERROR` | 500 | 内部エラー | しばらく後に再試行 |
| `SERVICE_UNAVAILABLE` | 503 | サービス停止中 | Retry-Afterを確認 |
| `RATE_LIMIT_EXCEEDED` | 429 | レート制限 | 待機後に再試行 |

## バリデーションエラーの詳細

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値が不正です",
    "details": [
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "有効なメールアドレス形式で入力してください",
        "value": "invalid-email"
      },
      {
        "field": "age",
        "code": "OUT_OF_RANGE",
        "message": "年齢は0〜150の範囲で入力してください",
        "value": -5
      }
    ]
  }
}
```

## リトライ戦略

### リトライ可能なエラー

| コード | リトライ | 戦略 |
|:-------|:--------:|:-----|
| 429 | ○ | Retry-Afterヘッダーに従う |
| 500 | ○ | 指数バックオフ（最大3回） |
| 502 | ○ | 指数バックオフ |
| 503 | ○ | Retry-Afterヘッダーに従う |
| 504 | ○ | 指数バックオフ |

### リトライ不可のエラー

| コード | 理由 |
|:-------|:-----|
| 400 | リクエスト修正が必要 |
| 401 | 認証情報の更新が必要 |
| 403 | 権限の変更が必要 |
| 404 | リソースが存在しない |
