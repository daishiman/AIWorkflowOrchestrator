# インデックス設計チェックリストテンプレート

## 基本情報

| 項目                     | 内容                    |
| ------------------------ | ----------------------- |
| **日付**                 | {{YYYY-MM-DD}}          |
| **対象テーブル**         | {{テーブル名}}          |
| **テーブル行数（推定）** | {{行数}}                |
| **主要ユースケース**     | {{OLTP / OLAP / Mixed}} |

---

## 1. 必須インデックスチェック

### 主キー・ユニーク制約

- [ ] 主キーが定義されている
- [ ] 主キーのデータ型は適切か（UUID vs SERIAL）
- [ ] 必要なユニーク制約が設定されている

### 外部キー

| 外部キーカラム  | インデックス有無 | 備考     |
| --------------- | ---------------- | -------- |
| {{column_name}} | ☐ 有 / ☐ 無      | {{備考}} |
| {{column_name}} | ☐ 有 / ☐ 無      | {{備考}} |

**重要**: すべての外部キーカラムにインデックスが必要

---

## 2. クエリパターン分析

### 主要クエリの列挙

| クエリ名 | 頻度      | WHERE条件 | ORDER BY   | 推奨インデックス |
| -------- | --------- | --------- | ---------- | ---------------- |
| {{名前}} | {{回/日}} | {{条件}}  | {{カラム}} | {{インデックス}} |
| {{名前}} | {{回/日}} | {{条件}}  | {{カラム}} | {{インデックス}} |

### WHERE句分析

| カラム     | 演算子            | 頻度         | カーディナリティ | インデックス候補 |
| ---------- | ----------------- | ------------ | ---------------- | ---------------- |
| {{column}} | {{=, <, >, IN等}} | {{高/中/低}} | {{高/中/低}}     | ☐ Yes / ☐ No     |

### JOIN条件分析

| 結合カラム | 結合先テーブル | 頻度         | インデックス有無 |
| ---------- | -------------- | ------------ | ---------------- |
| {{column}} | {{table}}      | {{高/中/低}} | ☐ 有 / ☐ 無      |

---

## 3. インデックスタイプ選択

### 各カラムのインデックスタイプ決定

| カラム     | データ型 | 用途              | 選択タイプ             | 理由     |
| ---------- | -------- | ----------------- | ---------------------- | -------- |
| {{column}} | {{type}} | {{検索/ソート等}} | ☐ 標準 / ☐ 式 / ☐ 部分 | {{理由}} |

### JSON カラム（該当する場合）

| カラム     | 抽出パス   | 式インデックス   | 備考     |
| ---------- | ---------- | ---------------- | -------- |
| {{column}} | {{$.path}} | ☐ json_extract() | {{備考}} |

---

## 4. 複合インデックス設計

### 複合インデックス候補

| インデックス名 | カラム順序           | 対象クエリ   | 理由                       |
| -------------- | -------------------- | ------------ | -------------------------- |
| {{idx_name}}   | {{col1, col2, col3}} | {{クエリ名}} | {{選択性順、カバリング等}} |

### カラム順序の検証

```
インデックス: idx_{{table}}_{{col1}}_{{col2}}

クエリ1: WHERE {{col1}} = ? AND {{col2}} = ?  → ✓ 使用される
クエリ2: WHERE {{col1}} = ?                    → ✓ 使用される
クエリ3: WHERE {{col2}} = ?                    → ✗ 使用されない（別インデックス要検討）
```

---

## 5. 部分インデックス検討

### 候補

| インデックス名 | 条件                  | 対象行の割合 | 効果                     |
| -------------- | --------------------- | ------------ | ------------------------ |
| {{idx_name}}   | `WHERE {{condition}}` | {{割合}}%    | {{サイズ削減、速度向上}} |

### よくある部分インデックスパターン

- [ ] `WHERE deleted_at IS NULL` - アクティブレコードのみ
- [ ] `WHERE status = 'active'` - 特定ステータスのみ
- [ ] `WHERE created_at > '{{date}}'` - 最近のデータのみ

---

## 6. カーディナリティ検証

### 選択性の確認

```sql
-- 以下のクエリで各カラムの選択性を確認（SQLite）
SELECT
  '{{column_name}}' AS column_name,
  CAST(COUNT(DISTINCT {{column_name}}) AS REAL) / CAST(COUNT(*) AS REAL) AS selectivity,
  COUNT(DISTINCT {{column_name}}) AS unique_values,
  COUNT(*) AS total_rows
FROM {{table_name}};
```

### 結果

| カラム     | 選択性   | ユニーク値数 | 総行数 | 評価         |
| ---------- | -------- | ------------ | ------ | ------------ |
| {{column}} | {{0.xx}} | {{数}}       | {{数}} | {{高/中/低}} |

---

## 7. パフォーマンス影響評価

### 読み取りパフォーマンス

| クエリ       | 現在の実行時間 | 予想改善 | 優先度       |
| ------------ | -------------- | -------- | ------------ |
| {{クエリ名}} | {{ms}}         | {{ms}}   | {{高/中/低}} |

### 書き込みパフォーマンス影響

| インデックス | 影響を受ける操作         | 許容度            |
| ------------ | ------------------------ | ----------------- |
| {{idx_name}} | INSERT / UPDATE / DELETE | ☐ 許容 / ☐ 要検討 |

### ストレージ影響

| インデックス | 推定サイズ | テーブルサイズ比 |
| ------------ | ---------- | ---------------- |
| {{idx_name}} | {{MB}}     | {{%}}            |

---

## 8. インデックス命名

### 命名規則確認

- [ ] プレフィックスが適切（idx*, uniq*, \_expr, \_partial サフィックス）
- [ ] テーブル名が含まれている
- [ ] カラム名が含まれている
- [ ] 一貫した命名パターンに従っている

### 最終インデックス一覧

| インデックス名                  | タイプ   | カラム  | 条件                       |
| ------------------------------- | -------- | ------- | -------------------------- |
| `idx_{{table}}_{{col}}`         | 標準     | {{col}} | -                          |
| `idx_{{table}}_{{col}}_expr`    | 式       | {{式}}  | -                          |
| `idx_{{table}}_{{col}}_partial` | 部分     | {{col}} | `WHERE deleted_at IS NULL` |
| `uniq_{{table}}_{{col}}`        | ユニーク | {{col}} | -                          |

---

## 9. 実装計画

### 作成順序

1. [ ] {{インデックス1}} - 優先度: 高
2. [ ] {{インデックス2}} - 優先度: 中
3. [ ] {{インデックス3}} - 優先度: 低

### SQLite インデックス作成の注意

- [ ] インデックス作成中はテーブルがロックされる（書き込み不可）
- [ ] 大規模テーブルでは作成時間を考慮
- [ ] トランザクション内での作成を検討

### ロールバック計画

```sql
-- ロールバック用SQL
DROP INDEX IF EXISTS {{idx_name}};

-- または ANALYZE の再実行
ANALYZE;
```

---

## 10. 監視計画

### 作成後の検証項目

- [ ] EXPLAIN QUERY PLAN で使用を確認
- [ ] sqlite_master でインデックス一覧を確認
- [ ] インデックスサイズが想定内か確認（PRAGMA index_info）
- [ ] クエリパフォーマンスが改善されたか確認（.timer on）

### 定期レビュー

- [ ] 未使用インデックスの確認（EXPLAIN QUERY PLAN で検証）
- [ ] 重複インデックスの確認（四半期）
- [ ] 新規クエリパターンへの対応（随時）
- [ ] ANALYZE の定期実行（統計情報の更新）

---

## 承認

| 役割               | 名前     | 承認日   |
| ------------------ | -------- | -------- |
| 開発者             | {{名前}} | {{日付}} |
| DBA / テックリード | {{名前}} | {{日付}} |
