name: Deploy to Railway

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Triggersï¼ˆãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  push:
    branches:
      - main # â†’ production environment
      - staging # â†’ staging environment
      - develop # â†’ development environment

  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - development
          - staging
          - production

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Environment Variablesï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒ™ãƒ«ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

env:
  NODE_VERSION: "20.x"
  PNPM_VERSION: "8"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Jobs
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate 1: Secret Scanï¼ˆæ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secret-scan:
    name: ğŸ” Secret Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´å–å¾—

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail on detection
        if: failure()
        run: |
          echo "ğŸš¨ Secrets detected in repository!"
          echo "Please remove secrets and rotate them immediately"
          exit 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate 2: Lint & Type Checkï¼ˆé™çš„è§£æï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ“ Lint & Type Check
    runs-on: ubuntu-latest
    needs: secret-scan

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Run Type Check
        run: pnpm run type-check

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate 3: Testsï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate 4: Buildï¼ˆãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

      - name: Validate build output
        run: |
          if [ ! -d ".next" ] && [ ! -d "dist" ]; then
            echo "âŒ Build output directory not found"
            exit 1
          fi
          echo "âœ… Build output validated"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deployment: ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒˆé€šéå¾Œ
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [secret-scan, lint, test, build]

    # ç’°å¢ƒã‚’å‹•çš„ã«æ±ºå®š
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/staging' && 'staging' || 'development') }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: pnpm install -g @railway/cli

      - name: Validate environment
        run: |
          echo "Deploying to: ${{ github.environment }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Deploy to Railway
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Railwayã«ãƒ‡ãƒ—ãƒ­ã‚¤
          railway up --detach

          # ãƒ‡ãƒ—ãƒ­ã‚¤URLå–å¾—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          DEPLOY_URL=$(railway status --json | jq -r '.url')
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Run migrations
        if: success()
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Railwayã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          railway run pnpm run db:migrate

      - name: Validate deployment
        if: success()
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç¢ºèªï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼‰
          DEPLOY_URL="${{ steps.deploy.outputs.url }}"
          if [ -n "$DEPLOY_URL" ]; then
            curl -f "$DEPLOY_URL/api/health" || exit 1
            echo "âœ… Deployment health check passed"
          fi

      - name: Notify success
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âœ… Deployment Successful\",
                \"description\": \"Deployed to **${{ github.environment }}**\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"[\`${GITHUB_SHA:0:7}\`](${{ github.event.head_commit.url }})\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"

      - name: Notify failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ Deployment Failed\",
                \"description\": \"Failed to deploy to **${{ github.environment }}**\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\"},
                  {\"name\": \"Workflow\", \"value\": \"[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\"}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Security Best Practicesï¼ˆã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«é©ç”¨ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# âœ… å®Ÿè£…æ¸ˆã¿ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–:
# 1. å“è³ªã‚²ãƒ¼ãƒˆï¼ˆSecret Scan â†’ Lint â†’ Test â†’ Build â†’ Deployï¼‰
# 2. ç’°å¢ƒåˆ†é›¢ï¼ˆenvironmentè¨­å®šã§ç’°å¢ƒåˆ¥Secretsä½¿ç”¨ï¼‰
# 3. Secretéœ²å‡ºé˜²æ­¢ï¼ˆGitHub ActionsãŒè‡ªå‹•ãƒã‚¹ã‚¯ï¼‰
# 4. æœ¬ç•ªç’°å¢ƒä¿è­·ï¼ˆEnvironment protection rulesæ¨å¥¨ï¼‰
# 5. ç›£æŸ»è¨¼è·¡ï¼ˆGitHub Actionså®Ÿè¡Œãƒ­ã‚°ï¼‰

# ğŸ” è¿½åŠ æ¨å¥¨è¨­å®šï¼ˆGitHub Settingsï¼‰:
# 1. Branch protection rulesï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒï¼‰:
#    - Require pull request reviews (1+ approvals)
#    - Require status checks to passï¼ˆä¸Šè¨˜ã™ã¹ã¦ã®ã‚¸ãƒ§ãƒ–ï¼‰
#    - Include administratorsï¼ˆç®¡ç†è€…ã‚‚éµå®ˆï¼‰
#
# 2. Environment protection rulesï¼ˆproductionï¼‰:
#    - Required reviewers: @devops-team
#    - Wait timer: 5 minutesï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
#    - Deployment branches: main only
#
# 3. Repository settings:
#    - Allow force pushes: Disabled
#    - Allow deletions: Disabled

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Customization Guideï¼ˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¬ã‚¤ãƒ‰ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ–¹æ³•:
#
# 1. ãƒˆãƒªã‚¬ãƒ¼èª¿æ•´:
#    - ãƒ–ãƒ©ãƒ³ãƒåã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã‚‹
#    - ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¿½åŠ ï¼ˆon: push: tags: ['v*']ï¼‰
#
# 2. ç’°å¢ƒè¿½åŠ :
#    - QAç’°å¢ƒã€DRç’°å¢ƒç­‰ã‚’è¿½åŠ 
#    - å„ç’°å¢ƒã«GitHub Environment Secretsã‚’è¨­å®š
#
# 3. é€šçŸ¥å…ˆå¤‰æ›´:
#    - Discordä»¥å¤–ï¼ˆSlackã€Emailç­‰ï¼‰ã«å¤‰æ›´
#    - è¤‡æ•°é€šçŸ¥å…ˆã‚’è¿½åŠ 
#
# 4. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¼·åŒ–:
#    - /api/healthä»¥å¤–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚‚ç¢ºèª
#    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèªã‚’è¿½åŠ 
#
# 5. Rollbackæ©Ÿèƒ½è¿½åŠ :
#    - ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
#    - å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®å¾©å¸°ã‚¸ãƒ§ãƒ–
