# 外部キー設計チェックリスト

## 基本情報

| 項目 | 内容 |
|------|------|
| **日付** | {{YYYY-MM-DD}} |
| **設計者** | {{名前}} |
| **テーブル名（子）** | {{子テーブル名}} |
| **参照テーブル（親）** | {{親テーブル名}} |
| **外部キーカラム** | {{カラム名}} |
| **関係の説明** | {{関係の簡潔な説明}} |

---

## 1. 関係性の分析

### 1.1 関係の種類

- [ ] **1対多（One-to-Many）**: 1つの親に複数の子
- [ ] **多対多（Many-to-Many）**: 中間テーブルを介した関係
- [ ] **1対1（One-to-One）**: 1つの親に1つの子
- [ ] **自己参照**: 同一テーブル内での親子関係

### 1.2 依存関係の強さ

| 質問 | 回答 |
|------|------|
| 親なしで子は存在できますか？ | ☐ Yes / ☐ No |
| 親が削除されたら子も不要ですか？ | ☐ Yes / ☐ No |
| 子は複数の親を持ちますか？ | ☐ Yes / ☐ No |
| 関連は後から変更可能ですか？ | ☐ Yes / ☐ No |

### 1.3 関係の分類

依存関係の強さに基づいて分類してください：

- [ ] **Composition（強い所有）**: 親が子を完全に所有、ライフサイクル共有
- [ ] **Aggregation（弱い所有）**: 親が子を参照、独立したライフサイクル
- [ ] **Association（関連）**: 相互参照、両方が独立

---

## 2. CASCADE動作の選択

### 2.1 ON DELETE 動作

| 動作 | 選択 | 理由 |
|------|------|------|
| CASCADE | ☐ | 親削除時に子も削除 |
| SET NULL | ☐ | 親削除時に外部キーをNULLに |
| RESTRICT | ☐ | 子が存在する場合、親削除を禁止 |
| NO ACTION | ☐ | 遅延チェック（DEFERRABLE用） |
| SET DEFAULT | ☐ | 親削除時にデフォルト値を設定 |

**選択理由**: {{CASCADE動作を選択した理由}}

### 2.2 ON UPDATE 動作

| 動作 | 選択 | 理由 |
|------|------|------|
| CASCADE | ☐ | 親キー更新時に子も更新（推奨） |
| RESTRICT | ☐ | 親キー更新を禁止 |

**注記**: 主キーにUUIDを使用している場合、ON UPDATEは通常不要。

### 2.3 決定マトリックス確認

| 質問 | 回答 | 推奨動作 |
|------|------|----------|
| 子は親なしで意味を持ちますか？ | ☐ Yes → SET NULL / ☐ No → CASCADE/RESTRICT |
| 監査ログ/履歴要件がありますか？ | ☐ Yes → RESTRICT / ☐ No → CASCADE可能 |
| 大量の子レコードが存在する可能性は？ | ☐ Yes → バッチ処理検討 / ☐ No → CASCADE可能 |
| ソフトデリートを使用しますか？ | ☐ Yes → RESTRICT / ☐ No → CASCADE可能 |

---

## 3. NULL許可設定

### 3.1 外部キーのNULL許可

- [ ] **NOT NULL**: 関連が必須（親が必ず存在）
- [ ] **NULL許可**: 関連がオプショナル

**決定基準**:
- ON DELETE SET NULLを使用する場合 → NULL許可必須
- ビジネスルールで関連が必須の場合 → NOT NULL

### 3.2 Drizzle ORM定義

```typescript
// NOT NULL（関連必須）
{{columnName}}: uuid('{{column_name}}')
  .notNull()
  .references(() => {{parentTable}}.id, {
    onDelete: '{{onDelete}}',
    onUpdate: 'cascade',
  }),

// NULL許可（関連オプショナル）
{{columnName}}: uuid('{{column_name}}')
  .references(() => {{parentTable}}.id, {
    onDelete: '{{onDelete}}',
    onUpdate: 'cascade',
  }),
```

---

## 4. インデックス設計

### 4.1 外部キーインデックス

外部キーカラムにはインデックスが**必須**です。

- [ ] 外部キーカラムにインデックスを設定した

```typescript
// インデックス定義
(table) => ({
  {{columnName}}Idx: index('idx_{{tableName}}_{{columnName}}')
    .on(table.{{columnName}}),
})
```

### 4.2 複合インデックスの検討

外部キーと他のカラムを組み合わせた検索が頻繁な場合：

- [ ] 複合インデックスを検討した
- [ ] 不要と判断した

```typescript
// 複合インデックス例
(table) => ({
  // 外部キー + ステータスでの検索が多い場合
  {{columnName}}StatusIdx: index('idx_{{tableName}}_{{columnName}}_status')
    .on(table.{{columnName}}, table.status),
})
```

---

## 5. 循環参照チェック

### 5.1 循環参照の有無

この外部キーにより循環参照が発生しないか確認：

- [ ] 循環参照は発生しない
- [ ] 循環参照が発生するが、対策済み

**循環参照の例**: A → B → C → A

### 5.2 循環参照への対策（該当する場合）

- [ ] NULL許可による打破
- [ ] 関係テーブルへの分離
- [ ] 自己参照テーブルとして設計
- [ ] アプリケーション層での制御

---

## 6. ソフトデリート統合

### 6.1 ソフトデリートの使用

- [ ] このテーブルでソフトデリートを使用する
- [ ] このテーブルでソフトデリートを使用しない

### 6.2 ソフトデリート時の考慮事項（該当する場合）

| 確認項目 | 状態 |
|----------|------|
| ON DELETE RESTRICTを選択した | ☐ |
| アプリケーション層でソフトデリート伝播を実装した | ☐ |
| アクティブレコードのみのインデックスを設定した | ☐ |
| クエリでdeletedAt IS NULLフィルタを使用する | ☐ |

```typescript
// ソフトデリート対応インデックス
(table) => ({
  active{{ColumnName}}Idx: index('idx_{{tableName}}_active_{{columnName}}')
    .on(table.{{columnName}})
    .where(sql`deleted_at IS NULL`),
})
```

---

## 7. 制約命名

### 7.1 外部キー制約名

推奨パターン: `fk_{{childTable}}_{{parentTable}}`

- [ ] 命名規則に従った制約名を設定した

```typescript
// 明示的な制約名
(table) => ({
  {{parentTable}}Fk: foreignKey({
    name: 'fk_{{childTable}}_{{parentTable}}',
    columns: [table.{{columnName}}],
    foreignColumns: [{{parentTable}}.id],
  })
    .onDelete('{{onDelete}}')
    .onUpdate('cascade'),
})
```

---

## 8. テスト計画

### 8.1 テストケース

| テストケース | 期待結果 | 確認 |
|-------------|----------|------|
| 親を作成し、子を追加 | 成功 | ☐ |
| 存在しない親IDで子を作成 | 外部キーエラー | ☐ |
| 子が存在する親を削除（CASCADE） | 親子両方削除 | ☐ |
| 子が存在する親を削除（SET NULL） | 親削除、子のFKがNULL | ☐ |
| 子が存在する親を削除（RESTRICT） | エラー、削除失敗 | ☐ |
| 親のID更新（CASCADE） | 子のFKも更新 | ☐ |

### 8.2 パフォーマンステスト

- [ ] 大量の子レコードでの削除パフォーマンスを確認した
- [ ] 外部キーでのJOINクエリパフォーマンスを確認した

---

## 9. ドキュメンテーション

### 9.1 設計決定の記録

**関係の説明**:
{{親テーブルと子テーブルの関係を詳細に説明}}

**CASCADE動作の選択理由**:
{{選択したCASCADE動作の理由を説明}}

**ソフトデリートの考慮**:
{{ソフトデリートを使用する/しない理由}}

### 9.2 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|----------|--------|
| {{日付}} | 初期設計 | {{名前}} |

---

## 10. 最終確認

### 10.1 チェックリスト

| 項目 | 確認 |
|------|------|
| 関係の種類と強さを分析した | ☐ |
| 適切なCASCADE動作を選択した | ☐ |
| NULL許可設定を確認した | ☐ |
| 外部キーインデックスを設定した | ☐ |
| 循環参照がないことを確認した | ☐ |
| ソフトデリート要件を考慮した | ☐ |
| 制約名を設定した | ☐ |
| テスト計画を作成した | ☐ |
| 設計決定をドキュメント化した | ☐ |

### 10.2 承認

| 役割 | 名前 | 承認日 |
|------|------|--------|
| 設計者 | {{名前}} | {{日付}} |
| レビュアー | {{名前}} | {{日付}} |
| DBA | {{名前}} | {{日付}} |
