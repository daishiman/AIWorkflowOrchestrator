# ロックファイル形式

## 概要

各パッケージマネージャーは独自のロックファイル形式を使用し、
依存関係の正確なバージョンとソースを記録します。

## pnpm-lock.yaml

### 構造

```yaml
lockfileVersion: "9.0"

settings:
  autoInstallPeers: true
  excludeLinksFromLockfile: false

importers:
  .:
    dependencies:
      lodash:
        specifier: ^4.17.21
        version: 4.17.21
    devDependencies:
      typescript:
        specifier: ^5.0.0
        version: 5.3.3

packages:
  lodash@4.17.21:
    resolution:
      integrity: sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==
    engines:
      node: ">=0.1.0"

snapshots:
  lodash@4.17.21: {}
```

### 主要セクション

| セクション        | 説明                                   |
| ----------------- | -------------------------------------- |
| `lockfileVersion` | ロックファイル形式のバージョン         |
| `settings`        | pnpmの設定                             |
| `importers`       | 各パッケージの依存関係（モノレポ対応） |
| `packages`        | パッケージのメタデータと解決情報       |
| `snapshots`       | パッケージの依存関係のスナップショット |

### 特徴

- **YAML形式**: 人間が読みやすい
- **コンテンツアドレス**: 整合性チェック用のハッシュ
- **モノレポ対応**: `importers`で各パッケージの依存を管理
- **strict-peer-dependencies**: ピア依存の厳格な管理

### バージョン履歴

| lockfileVersion | pnpmバージョン | 主な変更                   |
| --------------- | -------------- | -------------------------- |
| 9.0             | pnpm 9.x       | 新形式、パフォーマンス改善 |
| 6.0             | pnpm 8.x       | スナップショット導入       |
| 5.4             | pnpm 7.x       | インポーター形式の改善     |

## package-lock.json (pnpm)

### 構造

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "my-project",
      "version": "1.0.0",
      "dependencies": {
        "lodash": "^4.17.21"
      }
    },
    "node_modules/lodash": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
      "integrity": "sha512-v2kDE...",
      "license": "MIT"
    }
  }
}
```

### 主要フィールド

| フィールド        | 説明                                      |
| ----------------- | ----------------------------------------- |
| `lockfileVersion` | ロックファイル形式のバージョン（1, 2, 3） |
| `requires`        | 依存関係の追跡を有効化                    |
| `packages`        | パッケージ情報（v2/v3形式）               |
| `dependencies`    | 従来形式の依存ツリー（v1のみ）            |

### バージョン履歴

| lockfileVersion | npmバージョン | 主な変更                      |
| --------------- | ------------- | ----------------------------- |
| 3               | pnpm 9.x      | package形式のみ、依存関係削除 |
| 2               | pnpm 7.x-8.x  | packagesとdependencies両方    |
| 1               | pnpm 5.x-6.x  | 従来の階層形式                |

### 特徴

- **JSON形式**: 機械処理しやすい
- **resolved**: パッケージの取得元URL
- **integrity**: SRIハッシュ（sha512）
- **フラット構造**: node_modules下のパスをキーとして使用

## yarn.lock

### 構造 (Classic Yarn)

```
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1

lodash@^4.17.21:
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==
```

### 構造 (Yarn Berry / v2+)

```yaml
__metadata:
  version: 8
  cacheKey: 10c0

"lodash@pnpm:^4.17.21":
  version: 4.17.21
  resolution: "lodash@pnpm:4.17.21"
  checksum: 10c0/d8cbea072bb08655bb4c989da...
  languageName: node
  linkType: hard
```

### 特徴

- **Classic (v1)**: カスタムテキスト形式
- **Berry (v2+)**: YAML形式
- **チェックサム**: 整合性確認用ハッシュ
- **PnPサポート**: Plug'n'Play用の追加情報

## 形式間の比較

| 特徴           | pnpm-lock.yaml | package-lock.json | yarn.lock      |
| -------------- | -------------- | ----------------- | -------------- |
| 形式           | YAML           | JSON              | カスタム/YAML  |
| 可読性         | 高             | 中                | 中             |
| ファイルサイズ | 小             | 大                | 中             |
| モノレポ対応   | ネイティブ     | ワークスペース    | ワークスペース |
| 整合性チェック | SHA512         | SRI               | SHA512         |

## 移行ガイド

### pnpm → pnpm

```bash
# 1. pnpm の依存をクリーン
rm -rf node_modules package-lock.json

# 2. pnpm でインストール
pnpm import  # package-lock.json から変換
# または
pnpm install
```

### yarn → pnpm

```bash
# 1. yarn の依存をクリーン
rm -rf node_modules yarn.lock

# 2. pnpm でインストール
pnpm import  # yarn.lock から変換
# または
pnpm install
```

### pnpm → pnpm

```bash
# 1. pnpm の依存をクリーン
rm -rf node_modules pnpm-lock.yaml

# 2. pnpm でインストール
pnpm install
```

## チェックリスト

### ロックファイル管理

- [ ] 適切なパッケージマネージャーを選択したか？
- [ ] ロックファイルをバージョン管理に含めているか？
- [ ] チーム全体で同じパッケージマネージャーを使用しているか？
- [ ] lockfileVersionが最新か確認したか？

### 移行時

- [ ] node_modulesを削除したか？
- [ ] 旧ロックファイルを削除したか？
- [ ] 新しいロックファイルが正しく生成されたか？
- [ ] 全テストが通過したか？
