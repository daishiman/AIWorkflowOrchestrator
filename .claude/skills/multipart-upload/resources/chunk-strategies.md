# チャンク分割戦略

## 概要

大容量ファイルを効率的にアップロードするためのチャンク分割戦略。
ネットワーク状況とサーバー制約に応じた最適なチャンクサイズ決定方法を提供します。

## チャンクサイズ決定アルゴリズム

### ファイルサイズベース

| ファイルサイズ | 推奨チャンクサイズ | 理由                       |
| -------------- | ------------------ | -------------------------- |
| < 10MB         | 分割なし           | オーバーヘッドが支配的     |
| 10MB-100MB     | 5MB                | バランスが良い             |
| 100MB-500MB    | 10MB               | 効率と安定性のバランス     |
| 500MB-1GB      | 20MB               | 効率を優先                 |
| > 1GB          | 50MB               | メモリ効率と効率のバランス |

### ネットワーク品質による調整

```
高速・安定（10Mbps超、エラー率<1%）:
  → 標準サイズの1.5倍（効率優先）

中速・普通（1-10Mbps、エラー率1-5%）:
  → 標準サイズ（バランス）

低速・不安定（<1Mbps、エラー率>5%）:
  → 標準サイズの0.5倍（信頼性優先）
```

## チャンク境界の計算

### 基本計算

```typescript
function calculateChunks(fileSize: number, chunkSize: number) {
  const totalChunks = Math.ceil(fileSize / chunkSize);
  const chunks: ChunkInfo[] = [];

  for (let i = 0; i < totalChunks; i++) {
    const start = i * chunkSize;
    const end = Math.min(start + chunkSize, fileSize);
    chunks.push({
      index: i,
      start,
      end,
      size: end - start,
    });
  }

  return { totalChunks, chunks };
}
```

### 考慮事項

1. **最後のチャンク**: 残りサイズに応じて調整
2. **バイト境界**: 正確なバイト位置で分割
3. **メモリ制限**: 各チャンクがメモリに収まること

## 並列アップロード

### 並列数の決定

| ネットワーク状況 | 推奨並列数 | 理由           |
| ---------------- | ---------- | -------------- |
| LAN/高速回線     | 4-6        | 帯域を最大活用 |
| 一般的な回線     | 2-3        | バランス重視   |
| モバイル/不安定  | 1          | 信頼性優先     |

### 順序管理

- チャンクインデックスをメタデータに含める
- サーバー側で順序を組み立て直す
- 欠損チャンクの検出と再送

## 再開可能アップロード

### 状態管理

```typescript
interface UploadState {
  uploadId: string; // アップロードセッションID
  filePath: string; // ファイルパス
  fileHash: string; // ファイル全体のハッシュ
  totalChunks: number; // 総チャンク数
  completedChunks: number[]; // 完了したチャンクインデックス
  lastUpdated: Date; // 最終更新時刻
}
```

### 再開プロセス

1. **状態の確認**: 保存された状態を読み込み
2. **完了チャンクの検証**: サーバーに確認
3. **未完了チャンクの特定**: 送信が必要なチャンクを列挙
4. **再送開始**: 未完了チャンクから再開

## サーバー制約への対応

### 確認すべき制約

- **最大リクエストサイズ**: サーバーの受信制限
- **同時接続数**: コネクション制限
- **タイムアウト**: サーバー側のタイムアウト設定
- **レート制限**: 単位時間あたりのリクエスト数

### 適応戦略

1. サーバー制限を事前に確認
2. チャンクサイズを制限内に調整
3. 並列数を接続制限内に抑制
4. タイムアウトを考慮した転送計画
