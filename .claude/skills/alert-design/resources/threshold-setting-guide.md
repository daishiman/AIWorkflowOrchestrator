# 閾値設定ガイド

## 閾値設計の基本原則

### 原則1: データ駆動

**アンチパターン**:
❌ 「CPU80%で良さそう」（勘）

**ベストプラクティス**:
✅ 過去データ分析 → 統計的根拠

### 原則2: 適応性

**アンチパターン**:
❌ 固定閾値（常にCPU > 80%）

**ベストプラクティス**:
✅ 時間帯、曜日、トラフィックパターンに応じた動的閾値

### 原則3: 持続性

**アンチパターン**:
❌ 瞬間的な値で即座にアラート

**ベストプラクティス**:
✅ 5分間継続した場合のみアラート発火

## 統計的閾値設定

### 正規分布ベース

**前提**: データが正規分布に従う場合

**計算式**:
```
閾値 = 平均 + k × 標準偏差

k = 2: 95%の値が範囲内（5%がアラート）
k = 3: 99.7%の値が範囲内（0.3%がアラート）
```

**例**:
```
過去30日のエラー率:
- 平均: 0.05%
- 標準偏差: 0.02%

Warning閾値 = 0.05% + 2 × 0.02% = 0.09% (P95相当)
Critical閾値 = 0.05% + 3 × 0.02% = 0.11% (P99.7相当)
```

**Prometheusクエリ**:
```
# 平均 + 2σ
error_rate
>
avg_over_time(error_rate[30d]) + 2 * stddev_over_time(error_rate[30d])
```

### パーセンタイルベース

**前提**: データが正規分布に従わない場合（ロングテール）

**計算式**:
```
Warning閾値 = P95
Critical閾値 = P99
```

**例**:
```
過去30日のレイテンシ:
- P50: 100ms
- P95: 300ms
- P99: 500ms
- P99.9: 2000ms

Warning閾値 = 300ms (P95)
Critical閾値 = 500ms (P99)
```

**Prometheusクエリ**:
```
# P95レイテンシ
histogram_quantile(0.95,
  rate(http_request_duration_seconds_bucket[5m])
)
```

## 適応的閾値

### 時間帯別閾値

**背景**:
トラフィックは時間帯で大きく変動

**実装**:
```
# 過去1週間の同時刻帯の平均+2σ
threshold = avg_over_time(metric[1w] offset 1w) + 2 * stddev_over_time(metric[1w] offset 1w)
```

**例**:
```
CPU使用率:
- 深夜2時: 平均30% → 閾値50% (30% + 2×10%)
- 日中14時: 平均70% → 閾値90% (70% + 2×10%)
```

### 曜日別閾値

**背景**:
平日と週末でトラフィックパターンが異なる

**実装**:
```
# 曜日を考慮した閾値
IF day_of_week IN (Saturday, Sunday):
  threshold = weekend_baseline + 2σ
ELSE:
  threshold = weekday_baseline + 2σ
```

### トラフィック連動閾値

**背景**:
トラフィック増加時はエラー数も比例して増加

**実装**:
```
# エラー率（割合）で評価
error_rate = errors / total_requests

# トラフィック絶対値ではなく、割合で閾値設定
alert: error_rate > 0.01  # 1%
```

## 閾値調整プロセス

### 初期設定

**ステップ1**: 過去データ収集（最低30日間）
**ステップ2**: 統計分析（平均、標準偏差、パーセンタイル）
**ステップ3**: 初期閾値設定（P95またはP99）
**ステップ4**: ドライラン（アラート発火をログに記録のみ、通知なし）
**ステップ5**: 誤検知率評価（目標 < 5%）
**ステップ6**: 本番適用

### 継続的調整

**月次レビュー**:
```
1. 誤検知率を計算
2. 目標（< 5%）と比較
3. 高い場合は閾値を緩和
4. 低すぎる場合（< 1%）は閾値を厳格化
```

**トラフィック変化対応**:
```
トラフィックが2倍に増加
→ 閾値も再計算が必要
→ 最新30日データで統計分析し直し
```

## 閾値設定例

### CPU使用率

**固定閾値（非推奨）**:
```
❌ CPU > 80%
```

**適応的閾値（推奨）**:
```
✅ CPU > avg_1w + 2σ
✅ CPU > P95_same_hour_last_week
```

### メモリ使用率

**閾値**:
```
Warning: 85%
Critical: 95%
```

**理由**:
メモリは一度上がると下がりにくい → 早めに警告

### エラー率

**閾値**:
```
Warning: > 0.5% (通常の2倍)
Critical: > 1% (SLO違反)
```

### レイテンシ

**閾値**:
```
Warning: P95 > 300ms
Critical: P99 > 500ms (SLO違反)
```

### ディスク使用率

**閾値**:
```
Warning: 80%
Critical: 90%
```

**理由**:
ディスク満杯はシステム停止につながる → 早めに警告

## ベストプラクティス

1. **データ駆動**: 過去データ分析で統計的根拠
2. **適応性**: 時間帯・曜日・トラフィックに応じた動的調整
3. **持続性**: 一時的変動を無視（5分間継続条件）
4. **定期レビュー**: 月次で閾値妥当性を評価
5. **ドライラン**: 本番適用前にテスト実施

## アンチパターン

❌ **勘ベース**: 「80%で良さそう」
✅ **データベース**: 過去データのP95を閾値に

❌ **固定**: 常にCPU > 80%
✅ **適応的**: avg_1w + 2σ

❌ **即座発火**: 瞬間値でアラート
✅ **持続条件**: 5分継続でアラート
