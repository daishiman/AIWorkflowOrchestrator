# Extract Method

## 概要

Extract Methodは最も基本的で頻繁に使用されるリファクタリング技法です。
長大なメソッドから意味のあるコードブロックを新しいメソッドとして抽出します。

## 適用条件

- [ ] メソッドが30行を超えている
- [ ] コードブロックにコメントで説明を付けている
- [ ] 同じロジックが複数箇所に重複している
- [ ] 一つのメソッドが複数の責務を持っている

## 判断プロセス

```
長大なメソッドを発見
  ↓
[質問1] このコードブロックは独立した意味を持つか？
  ├─ Yes → メソッドとして抽出可能
  └─ No → 他のリファクタリングを検討
  ↓
[質問2] 適切な名前を付けられるか？
  ├─ Yes → 意味のあるメソッドになる
  └─ No → 抽出単位を再検討
  ↓
[質問3] 抽出後、元のメソッドは理解しやすくなるか？
  ├─ Yes → Extract Methodを実行
  └─ No → 抽出範囲を調整
```

## 手順

### Step 1: 抽出範囲の特定

独立した意味を持つコードブロックを特定する。

**良い抽出候補**:

- コメントで説明されているブロック
- ループの中身
- 条件分岐の各ブランチ
- 計算ロジック

### Step 2: 依存関係の分析

抽出するコードが参照する変数を特定する。

**変数の分類**:

- **入力**: 抽出コード内で読み取られる変数 → パラメータに
- **出力**: 抽出コード内で変更される変数 → 戻り値に
- **ローカル**: 抽出コード内でのみ使用 → 新メソッド内に移動

### Step 3: 新メソッドの作成

意図を表す名前で新メソッドを作成する。

**命名規則**:

- 動詞で始める（calculate, validate, format）
- 何をするかを明確に表現
- 抽象度を元のメソッドと合わせる

### Step 4: 呼び出しの置換

元のコードを新メソッドの呼び出しに置換する。

### Step 5: テスト実行

振る舞いが変わっていないことを確認する。

## 抽出パターン

### パターン1: パラメータなし、戻り値なし

副作用のみを持つコードブロック（ログ出力、状態変更など）

**判断基準**:

- 抽出コードが外部変数を読み書きしない
- 副作用（ログ、通知など）のみを行う

### パターン2: パラメータあり、戻り値なし

入力を受け取り、副作用を行うコードブロック

**判断基準**:

- 外部変数を読み取る
- 計算結果を返さない

### パターン3: パラメータなし、戻り値あり

内部で計算し結果を返すコードブロック

**判断基準**:

- 外部変数を読み取らない
- 計算結果を返す

### パターン4: パラメータあり、戻り値あり

入力を受け取り、計算結果を返すコードブロック（最も一般的）

**判断基準**:

- 外部変数を読み取る
- 計算結果を返す

## 複数戻り値の対処

抽出コードが複数の変数を変更する場合:

### 選択肢1: オブジェクト/タプルで返す

関連する値をまとめて返す。

### 選択肢2: 出力パラメータを使用

参照渡しで値を変更する（言語によっては非推奨）。

### 選択肢3: 抽出範囲を変更

複数の小さなメソッドに分割する。

## アンチパターン

### 過度に細かい抽出

**問題**: 1-2行のコードを抽出して逆に読みにくくなる

**対処**: 意味のある単位で抽出する

### 不適切な命名

**問題**: doSomething, process, handle などの曖昧な名前

**対処**: 具体的な動作を表す名前を使用

### 抽象度の不統一

**問題**: 高レベルと低レベルの操作が混在

**対処**: 同じ抽象度レベルで統一

## チェックリスト

### 実行前

- [ ] 対象コードにテストが存在するか？
- [ ] 抽出範囲が明確に定義されているか？
- [ ] 適切な名前を付けられるか？

### 実行後

- [ ] テストが通るか？
- [ ] 元のメソッドの可読性が向上したか？
- [ ] 新メソッドは単一の責務を持つか？
- [ ] 名前が意図を適切に表現しているか？

## 関連リファクタリング

- **Inline Method**: Extract Methodの逆操作
- **Extract Variable**: 式の一部を変数に抽出
- **Replace Temp with Query**: 一時変数をメソッドに置換
