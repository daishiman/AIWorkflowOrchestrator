# エッジケースパターン集

## 概要

エッジケースは、通常の使用では発生しにくいが、
発生した場合にシステムの信頼性に影響を与える境界的な状況です。
このガイドでは、見落としやすいエッジケースのパターンを提供します。

## 入力データのエッジケース

### 1. 文字列

| パターン | 例 | 検証すべきこと |
|---------|---|--------------|
| 空文字列 | `""` | 必須チェック、表示 |
| 空白のみ | `"   "` | トリム処理 |
| 最大長 | 255文字 | 切り捨て、エラー |
| 最大長+1 | 256文字 | 拒否されるか |
| 特殊文字 | `<script>`, `'`, `"` | XSS対策 |
| Unicode | 絵文字、日本語 | エンコーディング |
| 改行 | `\n`, `\r\n` | 処理、表示 |
| NULL文字 | `\0` | セキュリティ |

**テストシナリオ例**:
```gherkin
Scenario Outline: ユーザー名入力の境界値
  Given 登録フォームが表示されている
  When ユーザー名に<input>を入力する
  Then <expected_result>

  Examples:
    | input | expected_result |
    | ""    | 「必須項目です」エラーが表示される |
    | "   " | 「必須項目です」エラーが表示される |
    | "a"   | 正常に受け付けられる |
    | 50文字 | 正常に受け付けられる |
    | 51文字 | 「50文字以内で入力してください」エラーが表示される |
    | "<script>" | 「使用できない文字が含まれています」エラーが表示される |
```

### 2. 数値

| パターン | 例 | 検証すべきこと |
|---------|---|--------------|
| ゼロ | `0` | 除算、表示、計算 |
| 負数 | `-1` | 範囲チェック |
| 最小値 | `MIN_INT` | オーバーフロー |
| 最大値 | `MAX_INT` | オーバーフロー |
| 小数 | `0.1 + 0.2` | 浮動小数点誤差 |
| 科学記法 | `1e10` | パース処理 |
| 文字混入 | `123abc` | バリデーション |

**テストシナリオ例**:
```gherkin
Scenario: 数量のゼロ入力
  Given 商品をカートに追加済みである
  When 数量を0に変更する
  Then カートから商品が削除される
    Or エラー「1以上の数量を入力してください」が表示される

Scenario: 金額計算の境界値
  Given 税率が10%である
  When 999円の商品を購入する
  Then 税込価格は1099円（端数切り上げ）である
```

### 3. 日付・時刻

| パターン | 例 | 検証すべきこと |
|---------|---|--------------|
| うるう年 | 2024/2/29 | 日付計算 |
| 月末 | 1/31, 2/28 | 月跨ぎ計算 |
| 年末年始 | 12/31→1/1 | 年跨ぎ処理 |
| 夏時間 | DST切替 | タイムゾーン |
| 過去日 | 昨日 | 範囲チェック |
| 未来日 | 100年後 | 範囲チェック |
| エポック | 1970/1/1 | 特殊値 |
| 2038年問題 | 2038/1/19 | 32bitシステム |

**テストシナリオ例**:
```gherkin
Scenario: うるう年の誕生日
  Given 2024年2月29日生まれのユーザーがいる
  When 2025年2月28日に年齢を計算する
  Then 年齢は0歳（誕生日前）と表示される

Scenario: 月末の予約
  Given 今日が1月31日である
  When 「1ヶ月後」に予約する
  Then 予約日は2月28日（または29日）である
```

### 4. ファイル

| パターン | 例 | 検証すべきこと |
|---------|---|--------------|
| 0バイト | 空ファイル | アップロード処理 |
| 上限サイズ | 10MB | 制限チェック |
| 上限超過 | 11MB | エラーハンドリング |
| 不正拡張子 | .exe | セキュリティ |
| 偽装拡張子 | malware.jpg | MIMEタイプチェック |
| 長いファイル名 | 255文字 | ファイルシステム |
| 特殊文字名 | `file<>.txt` | サニタイズ |

## 状態のエッジケース

### 1. 同時実行

```gherkin
Scenario: 同時編集の競合
  Given ユーザーAとユーザーBが同じ文書を開いている
  When ユーザーAが保存する
    And 直後にユーザーBが保存する
  Then ユーザーBに競合警告が表示される
    And どちらの変更を採用するか選択できる

Scenario: 同時購入による在庫不足
  Given 商品の在庫が1個である
  When 2人のユーザーが同時に購入を試みる
  Then 1人は購入成功
    And もう1人は「在庫切れ」エラーが表示される
```

### 2. セッション

```gherkin
Scenario: セッションタイムアウト中の操作
  Given ユーザーがフォームを入力中である
  When セッションが期限切れになる
    And 「送信」ボタンをクリックする
  Then ログインページにリダイレクトされる
    And 入力内容は一時保存される
    And 再ログイン後に入力を復元できる

Scenario: 複数タブでのログアウト
  Given ユーザーが複数タブでサイトを開いている
  When 1つのタブでログアウトする
  Then すべてのタブでログアウト状態になる
```

### 3. ネットワーク

```gherkin
Scenario: 送信中のネットワーク切断
  Given ユーザーがフォームを送信中である
  When ネットワークが切断される
  Then 送信失敗のメッセージが表示される
    And 「再試行」ボタンが表示される
    And データは失われない

Scenario: 低速ネットワーク
  Given ネットワーク速度が極端に遅い（2G相当）
  When ページを読み込む
  Then 30秒以内にタイムアウトする
    And 適切なエラーメッセージが表示される
```

## 権限のエッジケース

```gherkin
Scenario: 操作中の権限剥奪
  Given ユーザーが管理者として記事を編集中である
  When 別の管理者がユーザーの権限を剥奪する
    And ユーザーが保存を試みる
  Then 「権限がありません」エラーが表示される
    And 編集内容は下書きとして保存される

Scenario: 削除されたリソースへのアクセス
  Given ユーザーAが文書のURLを知っている
  When ユーザーBが文書を削除する
    And ユーザーAがURLにアクセスする
  Then 404エラーページが表示される
    And 「このリソースは削除されました」メッセージが表示される
```

## UIのエッジケース

### 1. 表示

```gherkin
Scenario: 長いテキストの表示
  Given ユーザー名が50文字である
  When ヘッダーにユーザー名を表示する
  Then テキストは省略記号（...）で切り詰められる
    And ホバーで全文が表示される

Scenario: 空の一覧表示
  Given 検索結果が0件である
  When 一覧画面を表示する
  Then 「該当するデータがありません」メッセージが表示される
    And 新規作成への導線が表示される
```

### 2. レスポンシブ

```gherkin
Scenario: 極端に狭い画面
  Given 画面幅が320pxである
  When ダッシュボードを表示する
  Then すべてのコンテンツが閲覧可能である
    And 横スクロールは発生しない

Scenario: 画面回転
  Given ユーザーが縦向きでフォーム入力中である
  When 画面を横向きに回転する
  Then 入力内容は保持される
    And フォーカスは維持される
```

## データ整合性のエッジケース

```gherkin
Scenario: 親データ削除時の子データ
  Given 部署に10人の社員が所属している
  When 部署を削除しようとする
  Then 「所属社員がいるため削除できません」エラーが表示される
    Or 確認ダイアログで社員の処理方法を選択できる

Scenario: 循環参照の防止
  Given カテゴリAがカテゴリBの親である
  When カテゴリBをカテゴリAの親に設定しようとする
  Then 「循環参照のため設定できません」エラーが表示される
```

## エッジケース発見チェックリスト

### 入力関連
- [ ] 空/NULL値
- [ ] 最小値/最大値
- [ ] 境界値±1
- [ ] 不正な形式
- [ ] 特殊文字/Unicode

### 状態関連
- [ ] 同時実行
- [ ] セッション期限切れ
- [ ] ネットワーク障害
- [ ] 権限変更

### データ関連
- [ ] 空のコレクション
- [ ] 大量データ
- [ ] 削除されたデータへの参照
- [ ] 循環参照

### 時間関連
- [ ] タイムアウト
- [ ] 日付境界（月末、年末）
- [ ] タイムゾーン
- [ ] 夏時間

### UI関連
- [ ] 長いテキスト
- [ ] 空の状態
- [ ] ローディング状態
- [ ] エラー状態
