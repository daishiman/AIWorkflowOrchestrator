# テスト可能性ガイド

## 概要

テスト可能な受け入れ基準は、自動テストや手動テストで検証できる具体的な条件を持ちます。
このガイドでは、曖昧な基準を測定可能で検証可能な形に変換する方法を提供します。

## テスト可能性の4つの特性

### 1. 具体性（Specificity）

**定義**: 曖昧さがなく、具体的な値や条件が定義されている

**良い例**:
```gherkin
Then 応答時間は200ms以内である
Then エラーメッセージ「メールアドレスは必須です」が表示される
Then 検索結果は最大20件表示される
```

**悪い例**:
```gherkin
Then 応答が速い
Then エラーが表示される
Then 検索結果が表示される
```

### 2. 測定可能性（Measurability）

**定義**: 数値や客観的な基準で測定できる

**測定可能な指標例**:
| 分野 | 測定可能な表現 |
|-----|--------------|
| パフォーマンス | 200ms以内、1000リクエスト/秒 |
| 容量 | 最大10MB、100文字以内 |
| 精度 | 小数点以下2桁、99.9%正確 |
| 時間 | 5分以内、24時間後 |

### 3. 観測可能性（Observability）

**定義**: 結果を外部から観測・確認できる

**観測可能**:
- 画面に表示されるメッセージ
- HTTPステータスコード
- ログ出力
- メール送信
- ファイル作成

**観測困難**:
- 内部変数の値
- メモリ状態
- 「システムが理解する」

### 4. 再現可能性（Reproducibility）

**定義**: 同じ条件で同じ結果が得られる

**再現可能にするために**:
- 前提条件を完全に定義
- 外部依存を制御または模擬
- タイミング依存を排除

## 曖昧→具体 変換パターン

### パターン1: 形容詞の数値化

| 曖昧 | 質問 | 具体化 |
|-----|------|-------|
| 速い | 何秒以内？ | 200ms以内 |
| 多い | 何件以上？ | 100件以上 |
| 大きい | 何MB？ | 最大50MB |
| 短い | 何文字？ | 50文字以内 |
| 最近 | いつから？ | 過去7日以内 |

### パターン2: 動詞の具体化

| 曖昧 | 質問 | 具体化 |
|-----|------|-------|
| 処理される | 何が起きる？ | DBに保存される |
| 通知される | どのように？ | メールが送信される |
| 検証される | どのように？ | エラーメッセージが表示される |
| 更新される | 何が変わる？ | 最終更新日時が現在時刻になる |

### パターン3: 主語の明確化

| 曖昧 | 質問 | 具体化 |
|-----|------|-------|
| ユーザー | どのユーザー？ | 管理者ロールのユーザー |
| システム | どの部分？ | 認証サービス |
| データ | どのデータ？ | ユーザープロフィール情報 |

## 検証方法の設計

### UI検証

```gherkin
# 要素の存在
Then 「保存」ボタンが表示される
Then エラーメッセージが赤色で表示される

# 自動テスト実装例
expect(page.getByRole('button', { name: '保存' })).toBeVisible();
expect(page.getByText('エラー')).toHaveCSS('color', 'rgb(255, 0, 0)');
```

### API検証

```gherkin
# レスポンス検証
Then HTTPステータスコード200が返される
Then レスポンスボディにユーザーIDが含まれる

# 自動テスト実装例
expect(response.status()).toBe(200);
expect(await response.json()).toHaveProperty('userId');
```

### データ検証

```gherkin
# DB検証
Then ユーザーテーブルに新規レコードが追加される
Then 注文ステータスが「確定」に更新される

# 自動テスト実装例
const user = await db.users.findByEmail('test@example.com');
expect(user).toBeDefined();
expect(order.status).toBe('confirmed');
```

### 非同期検証

```gherkin
# イベント検証
Then 5秒以内にメールが送信される
Then 通知がプッシュされる

# 自動テスト実装例
await expect(async () => {
  const email = await mailServer.getLatestEmail();
  expect(email.to).toBe('user@example.com');
}).toPass({ timeout: 5000 });
```

## テスト可能性チェックリスト

### 前提条件（Given）
- [ ] 初期状態が明確に定義されているか？
- [ ] 必要なデータが特定されているか？
- [ ] 外部依存が制御可能か？

### アクション（When）
- [ ] 実行するアクションが1つに絞られているか？
- [ ] アクションが具体的か？
- [ ] トリガー条件が明確か？

### 期待結果（Then）
- [ ] 結果が観測可能か？
- [ ] 成功/失敗の判定が明確か？
- [ ] タイミングが定義されているか（必要な場合）？

## テスト種別との対応

### 単体テスト向き
```gherkin
Given 有効なメールアドレス文字列
When バリデーション関数に渡す
Then trueが返される
```

### 統合テスト向き
```gherkin
Given ユーザーデータが入力されている
When 登録APIを呼び出す
Then DBにユーザーが作成される
  And 確認メールが送信される
```

### E2Eテスト向き
```gherkin
Given ユーザーがログインページにいる
When 認証情報を入力してログインする
Then ホームページが表示される
  And ユーザー名がヘッダーに表示される
```

### 手動テスト向き
```gherkin
Given 複雑なビジネスシナリオ
When 複数のシステムを横断する操作
Then 主観的な判断が必要な結果
```

## テスト不可能な基準の対処

### 1. 主観的な基準

**問題**: 「使いやすい」「見やすい」「分かりやすい」

**対処法**:
- ユーザビリティテストの指標に変換
- 具体的な操作数やクリック数で測定
- ユーザー調査のスコアで測定

```gherkin
# 変換前
Then UIが使いやすい

# 変換後
Then 3クリック以内で目的の操作が完了できる
Then ユーザビリティテストで80%以上が「簡単」と評価
```

### 2. 内部状態の基準

**問題**: 「キャッシュが更新される」「メモリが解放される」

**対処法**:
- 外部から観測可能な結果に変換
- ログ出力を追加
- 監視メトリクスで確認

```gherkin
# 変換前
Then キャッシュが無効化される

# 変換後
Then 同じリクエストで最新データが返される
Then キャッシュ無効化ログが出力される
```

### 3. タイミング依存の基準

**問題**: 「リアルタイムで反映」「すぐに表示」

**対処法**:
- 具体的な時間を定義
- イベント駆動で検証
- ポーリングで確認

```gherkin
# 変換前
Then 変更がリアルタイムで反映される

# 変換後
Then 変更が500ms以内に画面に反映される
Then WebSocketイベントが送信される
```

## 自動化しやすい基準の書き方

### ローカライズ可能
```gherkin
# 良い（テストでは定数を使用）
Then エラーメッセージ「ERROR_EMAIL_REQUIRED」が表示される

# より良い（日本語と英語両対応）
Then エラーコード「E001」に対応するメッセージが表示される
```

### データ独立性
```gherkin
# 悪い（特定のデータに依存）
Given ユーザーID=123のユーザーが存在する

# 良い（テストで作成）
Given テスト用ユーザーが作成されている
```

### べき等性
```gherkin
# テストが何度実行しても同じ結果になる
Given 既存のデータがクリアされている
When テストデータを作成する
Then 期待通りの結果が得られる
```

## 基準品質スコアリング

| 項目 | 重み | 評価基準 |
|-----|------|---------|
| 具体性 | 30% | 曖昧な表現がないか |
| 測定可能性 | 25% | 数値で表現されているか |
| 観測可能性 | 25% | 外部から確認できるか |
| 再現可能性 | 20% | 同じ結果が得られるか |

**目標スコア**: 80%以上
