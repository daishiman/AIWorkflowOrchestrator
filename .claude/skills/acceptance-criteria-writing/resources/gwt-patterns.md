# Given-When-Then パターン集

## 概要

Given-When-Then（GWT）形式は、受け入れ基準を構造化して記述するための標準的なフォーマットです。
BDD（Behavior Driven Development）の一部として広く使用されています。

## 基本構造

```gherkin
Given [前提条件]
When [アクション/トリガー]
Then [期待結果]
```

### 各部の役割

| 部分  | 役割                 | 質問                         |
| ----- | -------------------- | ---------------------------- |
| Given | 前提条件・初期状態   | どのような状態から始まるか？ |
| When  | トリガー・アクション | ユーザーは何をするか？       |
| Then  | 期待結果・検証       | 何が起こるべきか？           |

## 拡張構文

### And / But

条件や結果が複数ある場合に使用：

```gherkin
Given ユーザーがログイン済みである
  And カートに商品が3個入っている
  And クーポンコードを持っている
When 「購入手続き」をクリックする
Then 注文確認ページが表示される
  And 合計金額が正しく計算される
  But 在庫切れ商品はエラー表示される
```

### Background

複数のシナリオで共通の前提条件：

```gherkin
Background:
  Given ユーザーがログイン済みである
  And システムが正常稼働している

Scenario: 商品購入
  When ...
  Then ...

Scenario: 商品返品
  When ...
  Then ...
```

### Scenario Outline（データ駆動テスト）

同じシナリオを異なるデータで実行：

```gherkin
Scenario Outline: ログイン検証
  Given ユーザーがログインページにいる
  When ユーザー名"<username>"とパスワード"<password>"を入力する
  Then "<result>"が表示される

  Examples:
    | username | password | result |
    | user1    | pass123  | ホーム画面 |
    | user1    | wrong    | エラーメッセージ |
    | invalid  | pass123  | エラーメッセージ |
```

## パターン集

### 1. 認証パターン

**正常ログイン**:

```gherkin
Scenario: 正しい認証情報でのログイン
  Given ユーザーがログインページにいる
    And 有効なアカウントが存在する
  When ユーザーが正しいメールとパスワードを入力する
    And 「ログイン」ボタンをクリックする
  Then ホームページにリダイレクトされる
    And ウェルカムメッセージが表示される
    And セッションが開始される
```

**認証失敗**:

```gherkin
Scenario: 誤ったパスワードでのログイン
  Given ユーザーがログインページにいる
    And 有効なアカウントが存在する
  When ユーザーが正しいメールと誤ったパスワードを入力する
    And 「ログイン」ボタンをクリックする
  Then エラーメッセージ「認証情報が正しくありません」が表示される
    And ログインページに留まる
    And 失敗回数がカウントされる
```

**アカウントロック**:

```gherkin
Scenario: 複数回の認証失敗によるロック
  Given ユーザーがログインページにいる
    And ログイン失敗が4回記録されている
  When ユーザーが5回目の誤った認証を試みる
  Then アカウントがロックされる
    And 「アカウントがロックされました」メッセージが表示される
    And パスワードリセットリンクが表示される
```

### 2. CRUD操作パターン

**作成**:

```gherkin
Scenario: 新規ユーザー作成
  Given 管理者がユーザー管理画面にいる
  When 「新規作成」ボタンをクリックする
    And 必須項目をすべて入力する
    And 「保存」ボタンをクリックする
  Then 新しいユーザーが作成される
    And 成功メッセージが表示される
    And ユーザー一覧に新規ユーザーが表示される
```

**参照**:

```gherkin
Scenario: ユーザー詳細の参照
  Given ユーザー一覧が表示されている
    And 少なくとも1人のユーザーが存在する
  When ユーザー名をクリックする
  Then ユーザー詳細画面が表示される
    And すべてのユーザー情報が表示される
```

**更新**:

```gherkin
Scenario: ユーザー情報の更新
  Given ユーザー詳細画面が表示されている
  When 「編集」ボタンをクリックする
    And メールアドレスを変更する
    And 「保存」ボタンをクリックする
  Then 変更が保存される
    And 成功メッセージが表示される
    And 更新されたメールアドレスが表示される
```

**削除**:

```gherkin
Scenario: ユーザーの削除
  Given ユーザー詳細画面が表示されている
  When 「削除」ボタンをクリックする
    And 確認ダイアログで「確認」をクリックする
  Then ユーザーが削除される
    And ユーザー一覧にリダイレクトされる
    And 削除されたユーザーは表示されない
```

### 3. バリデーションパターン

**必須項目**:

```gherkin
Scenario: 必須項目未入力
  Given フォームが表示されている
  When 必須項目を空のまま「送信」をクリックする
  Then フォームは送信されない
    And 未入力の必須項目にエラーが表示される
    And エラーメッセージ「必須項目です」が表示される
```

**フォーマット検証**:

```gherkin
Scenario Outline: メールアドレスの形式検証
  Given 登録フォームが表示されている
  When メールアドレス欄に"<email>"を入力する
    And フォーカスを外す
  Then "<validation_result>"

  Examples:
    | email           | validation_result |
    | test@example.com | エラーなし |
    | invalid-email   | エラー「正しいメール形式で入力してください」 |
    | @example.com    | エラー「正しいメール形式で入力してください」 |
```

**境界値**:

```gherkin
Scenario Outline: パスワード文字数制限
  Given パスワード設定フォームが表示されている
  When <length>文字のパスワードを入力する
  Then <result>

  Examples:
    | length | result |
    | 7      | エラー「8文字以上必要です」 |
    | 8      | エラーなし |
    | 20     | エラーなし |
    | 21     | エラー「20文字以下にしてください」 |
```

### 4. 権限パターン

**権限なしアクセス**:

```gherkin
Scenario: 管理者機能への一般ユーザーアクセス
  Given 一般ユーザーでログインしている
  When 管理者画面のURLに直接アクセスする
  Then アクセス拒否される
    And 「権限がありません」メッセージが表示される
    And ホーム画面にリダイレクトされる
```

**ロールベースアクセス**:

```gherkin
Scenario Outline: ロールベースの機能アクセス
  Given <role>ロールでログインしている
  When <action>を実行する
  Then <result>

  Examples:
    | role   | action         | result |
    | admin  | ユーザー削除   | 成功する |
    | editor | ユーザー削除   | 拒否される |
    | viewer | ユーザー削除   | 拒否される |
    | editor | 記事編集       | 成功する |
    | viewer | 記事編集       | 拒否される |
```

### 5. 非同期処理パターン

**ローディング状態**:

```gherkin
Scenario: データ読み込み中の表示
  Given ダッシュボードにアクセスする
  When データが読み込み中である
  Then ローディングインジケーターが表示される
    And ユーザー操作は一時的に無効になる
  When データの読み込みが完了する
  Then ローディングインジケーターが消える
    And データが正しく表示される
```

**タイムアウト**:

```gherkin
Scenario: API応答タイムアウト
  Given ユーザーが検索を実行する
  When API応答が30秒を超える
  Then タイムアウトエラーが表示される
    And 「再試行」ボタンが表示される
    And ユーザーは操作を続行できる
```

### 6. 通知パターン

**リアルタイム通知**:

```gherkin
Scenario: 新規メッセージの通知
  Given ユーザーがダッシュボードにいる
    And 通知設定が有効である
  When 別のユーザーがメッセージを送信する
  Then 通知アイコンに未読数が表示される
    And 通知音が鳴る（設定による）
    And プッシュ通知が表示される
```

## 記述のベストプラクティス

### すべきこと

1. **具体的に書く**
   - ✅ `Then エラーメッセージ「パスワードが短すぎます」が表示される`
   - ❌ `Then エラーが表示される`

2. **ユーザー視点で書く**
   - ✅ `When ユーザーが「保存」ボタンをクリックする`
   - ❌ `When システムがPOSTリクエストを受け取る`

3. **検証可能にする**
   - ✅ `Then 応答時間が200ms以内である`
   - ❌ `Then 応答が速い`

4. **独立性を保つ**
   - 各シナリオは他のシナリオに依存しない

### 避けるべきこと

1. **実装詳細を含めない**
   - ❌ `When データベースにINSERTされる`
   - ❌ `Then CSSクラス"error"が追加される`

2. **複数の振る舞いを1つにしない**
   - ❌ 1つのシナリオで作成、更新、削除すべてをテスト

3. **曖昧な表現を避ける**
   - ❌ `Then 適切に処理される`
   - ❌ `Then 正しく動作する`

## チェックリスト

- [ ] Given: 前提条件は明確か？
- [ ] When: アクションは1つか？
- [ ] Then: 検証可能な結果か？
- [ ] 正常系と異常系があるか？
- [ ] 境界値がカバーされているか？
- [ ] ユーザー視点で書かれているか？
