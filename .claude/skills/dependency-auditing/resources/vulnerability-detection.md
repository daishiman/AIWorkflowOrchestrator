# 脆弱性検出方法

## 概要

依存関係の脆弱性を検出するには、複数のツールとアプローチを組み合わせた
多層的な検出戦略が効果的です。

## パッケージマネージャー内蔵ツール

### npm audit

**基本コマンド**:
```bash
# 脆弱性のスキャン
npm audit

# JSON形式で出力
npm audit --json

# 本番依存のみ
npm audit --production

# 自動修正を試行
npm audit fix

# 破壊的変更を許可した修正
npm audit fix --force
```

**出力の読み方**:
```
┌───────────────┬──────────────────────────────────────────────────────────────┐
│ High          │ Prototype Pollution                                          │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Package       │ lodash                                                        │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Patched in    │ >=4.17.21                                                     │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Dependency of │ my-package                                                    │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ Path          │ my-package > other-package > lodash                           │
├───────────────┼──────────────────────────────────────────────────────────────┤
│ More info     │ https://github.com/advisories/GHSA-...                        │
└───────────────┴──────────────────────────────────────────────────────────────┘
```

### pnpm audit

**基本コマンド**:
```bash
# 脆弱性のスキャン
pnpm audit

# JSON形式で出力
pnpm audit --json

# 本番依存のみ
pnpm audit --prod

# 修正を適用
pnpm audit --fix
```

**pnpmの特徴**:
- より厳格な依存関係解決
- ホイスティングの制限によるセキュリティ向上
- パフォーマンスの優位性

### yarn audit

**基本コマンド**:
```bash
# 脆弱性のスキャン
yarn audit

# JSON形式で出力
yarn audit --json

# 重大度でフィルタ
yarn audit --level high
```

## サードパーティツール

### Snyk

**インストールと使用**:
```bash
# インストール
npm install -g snyk

# 認証
snyk auth

# スキャン
snyk test

# 継続的なモニタリング
snyk monitor

# 自動修正PR生成
snyk wizard
```

**Snykの特徴**:
- 商用グレードの脆弱性データベース
- 独自の脆弱性研究チーム
- 修正PRの自動生成
- ライセンスコンプライアンスチェック

### OWASP Dependency-Check

**使用方法**:
```bash
# Dockerで実行
docker run --rm \
  -v $(pwd):/src \
  owasp/dependency-check \
  --scan /src \
  --format HTML \
  --out /src/reports

# CLI版
dependency-check.sh --scan . --format HTML
```

**特徴**:
- オープンソース
- 多言語対応（Java、.NET、Node.js、Python等）
- NVDデータベースとの連携
- CI/CD統合が容易

### Trivy

**使用方法**:
```bash
# ファイルシステムスキャン
trivy fs .

# package-lock.jsonのスキャン
trivy fs --scanners vuln package-lock.json

# コンテナイメージのスキャン
trivy image myapp:latest

# JSON出力
trivy fs --format json .
```

**特徴**:
- 高速なスキャン
- コンテナと依存関係の両方に対応
- SBOM生成機能
- CI/CDへの統合が容易

### Grype

**使用方法**:
```bash
# インストール
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# スキャン
grype dir:.

# SBOM からスキャン
grype sbom:./sbom.json

# JSON出力
grype dir:. -o json
```

**特徴**:
- 軽量で高速
- SBOM標準に対応
- Syftとの連携

## 検出戦略

### 多層防御アプローチ

```
┌─────────────────────────────────────────────────────────────┐
│                    開発ワークフロー                          │
├─────────────────────────────────────────────────────────────┤
│  ローカル開発  │    CI/CD     │   定期スキャン   │  監視    │
├─────────────────────────────────────────────────────────────┤
│  pre-commit   │  PR チェック  │  週次/日次      │  アラート │
│  hook         │              │  スキャン       │          │
└─────────────────────────────────────────────────────────────┘
```

### レイヤー1: ローカル開発

**pre-commitフック**:
```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "Running security audit..."
npm audit --audit-level=high

if [ $? -ne 0 ]; then
  echo "Security vulnerabilities found. Please fix before committing."
  exit 1
fi
```

### レイヤー2: CI/CDパイプライン

**GitHub Actions例**:
```yaml
name: Security Audit

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - run: pnpm audit --audit-level=high
```

### レイヤー3: 定期スキャン

**cronジョブ例**:
```bash
# 毎日午前3時にスキャン
0 3 * * * cd /app && npm audit --json > /var/log/npm-audit-$(date +\%Y\%m\%d).json
```

### レイヤー4: 継続的監視

**Dependabot設定**:
```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "daily"
    open-pull-requests-limit: 10
```

## 検出結果の解析

### 直接依存 vs 推移的依存

```
依存関係ツリー:
my-project
├── express (直接依存)
│   └── body-parser
│       └── qs (推移的依存) ← 脆弱性
└── lodash (直接依存) ← 脆弱性
```

**直接依存の脆弱性**:
- 即座に対応可能
- package.jsonを更新

**推移的依存の脆弱性**:
- 親パッケージの更新が必要
- overrides/resolutionsで強制更新
- パッチが出るまで待つ必要がある場合も

### 脆弱性の実際の影響評価

**評価チェックリスト**:
- [ ] 脆弱なコードパスは実際に実行されるか？
- [ ] 攻撃に必要な前提条件は満たされているか？
- [ ] 入力データは攻撃者が制御可能か？
- [ ] 影響を受ける機能は本番環境で使用されているか？

## 検出結果の優先順位付け

### 優先度マトリックス

| 重大度 | エクスプロイト有 | エクスプロイト無 |
|-------|----------------|-----------------|
| Critical | 🔴 即座 | 🟠 24時間以内 |
| High | 🟠 24時間以内 | 🟡 72時間以内 |
| Medium | 🟡 1週間以内 | 🟢 2週間以内 |
| Low | 🟢 次回リリース | ⚪ 計画的対応 |

### エクスプロイト情報の確認

**情報源**:
- Exploit Database: https://www.exploit-db.com/
- GitHub Advisory Database: https://github.com/advisories
- NVD: https://nvd.nist.gov/
- CVE Details: https://www.cvedetails.com/

## チェックリスト

### 脆弱性検出時
- [ ] 複数のツールでスキャンしたか？
- [ ] 直接/推移的依存を区別したか？
- [ ] CVSSスコアを確認したか？
- [ ] エクスプロイトの有無を確認したか？

### 継続的検出体制
- [ ] CI/CDに監査を統合したか？
- [ ] 定期スキャンを設定したか？
- [ ] アラート通知を設定したか？
- [ ] Dependabotを有効化したか？
