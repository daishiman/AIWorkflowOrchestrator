# 戦略選択ガイド

## 概要

適切なアップグレード戦略を選択することで、
リスクを最小化しながら効率的に依存関係を更新できます。

## 戦略選択マトリックス

### 更新タイプ × 条件

| 条件 | Patch更新 | Minor更新 | Major更新 |
|-----|----------|----------|----------|
| テストカバレッジ高(>80%) | 自動適用 | 段階的 | 計画的 |
| テストカバレッジ中(50-80%) | 段階的 | 計画的 | 慎重 |
| テストカバレッジ低(<50%) | 慎重 | 慎重 | 非推奨 |
| セキュリティパッチ | 即座 | 即座 | 計画的即座 |
| 破壊的変更あり | - | - | フィーチャーフラグ |

### 戦略の詳細

#### 自動適用

**条件**:
- Patchバージョンの更新
- 高いテストカバレッジ
- CI/CDが整備されている

**実行方法**:
```yaml
# Dependabot設定
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "daily"
    groups:
      patch-updates:
        patterns:
          - "*"
        update-types:
          - "patch"
```

#### 段階的アップグレード

**条件**:
- 複数パッケージの更新
- 十分なテストカバレッジ
- 定期的なメンテナンスサイクル

**実行手順**:
```bash
# 1. Patchを先に更新
pnpm update --latest

# 2. テスト
pnpm test

# 3. 次にMinorを更新（1パッケージずつ）
pnpm update package-name@latest

# 4. テスト
pnpm test
```

#### 計画的アップグレード

**条件**:
- Majorバージョンの更新
- 破壊的変更が含まれる
- 影響範囲が広い

**実行手順**:
1. アップグレード計画を作成
2. フィーチャーブランチで作業
3. 段階的に変更を適用
4. 十分なテストを実施
5. ステージングで検証
6. 本番にデプロイ

#### 即座のアップグレード

**条件**:
- Critical/Highの脆弱性
- パッチが利用可能
- ビジネスリスクが高い

**実行手順**:
```bash
# 1. 脆弱性を確認
pnpm audit

# 2. 影響を確認
pnpm why vulnerable-package

# 3. 更新を適用
pnpm update vulnerable-package

# 4. 最小限のテスト
pnpm test --bail

# 5. 即座にデプロイ
```

#### 慎重なアップグレード

**条件**:
- テストカバレッジが低い
- 影響範囲が不明
- リスクが高い

**実行手順**:
1. 先にテストを追加
2. 小さな変更から開始
3. 各ステップで検証
4. 問題があれば即ロールバック

#### フィーチャーフラグ型

**条件**:
- 大きな破壊的変更
- 段階的なロールアウトが必要
- A/Bテストが必要

**実装**:
```javascript
// フィーチャーフラグの設定
const useNewVersion = process.env.USE_NEW_LIB === 'true';

// 条件付きインポート
const lib = useNewVersion
  ? require('new-lib')
  : require('old-lib');
```

## リスク評価フレームワーク

### リスクスコアの計算

```
リスクスコア = (変更タイプ × 影響範囲 × (1 - テストカバレッジ)) / 10

変更タイプ:
- Patch: 1
- Minor: 3
- Major: 7

影響範囲:
- 1ファイル: 1
- 1モジュール: 3
- プロジェクト全体: 7

テストカバレッジ: 0.0 - 1.0
```

### リスクスコアに基づく戦略選択

| リスクスコア | 推奨戦略 |
|------------|---------|
| 0-1 | 自動適用 |
| 1-3 | 段階的 |
| 3-5 | 計画的 |
| 5-7 | フィーチャーフラグ |
| 7+ | 専用プロジェクト |

## パッケージタイプ別の戦略

### フレームワーク（React, Vue, Angular等）

**特徴**:
- 影響範囲が広い
- エコシステム全体に影響
- Majorアップグレードは慎重に

**推奨戦略**:
- Patch/Minor: 段階的
- Major: フィーチャーフラグ + 専用ブランチ

### ユーティリティライブラリ（lodash, date-fns等）

**特徴**:
- 影響範囲が限定的
- APIが安定している
- 更新頻度が低い

**推奨戦略**:
- Patch: 自動適用
- Minor/Major: 段階的

### 開発ツール（TypeScript, ESLint等）

**特徴**:
- ビルドプロセスに影響
- 型定義が変わる可能性
- CIに影響

**推奨戦略**:
- Patch: 自動適用
- Minor: 段階的（CIで検証）
- Major: 計画的（専用ブランチ）

### セキュリティ関連（認証, 暗号化等）

**特徴**:
- セキュリティに直接影響
- 慎重な検証が必要
- ロールバックが困難な場合も

**推奨戦略**:
- セキュリティパッチ: 即座
- 機能追加: 計画的
- Major: フィーチャーフラグ

## 意思決定フローチャート

```
開始
  │
  ▼
セキュリティパッチか？ ─Yes→ 即座に適用 → 終了
  │No
  ▼
テストカバレッジは60%以上か？ ─No→ テストを追加してから検討
  │Yes
  ▼
Patchバージョンか？ ─Yes→ 自動適用 → 終了
  │No
  ▼
Minorバージョンか？ ─Yes→ 段階的アップグレード → 終了
  │No
  ▼
Majorバージョンか？
  │Yes
  ▼
破壊的変更は大きいか？ ─Yes→ フィーチャーフラグ型
  │No                          → 終了
  ▼
計画的アップグレード → 終了
```

## チェックリスト

### 戦略選択前
- [ ] 更新タイプ（Patch/Minor/Major）を確認したか？
- [ ] テストカバレッジを確認したか？
- [ ] 影響範囲を評価したか？
- [ ] リスクスコアを計算したか？

### 戦略選択時
- [ ] 条件に合った戦略を選択したか？
- [ ] ロールバック計画を立てたか？
- [ ] 必要なリソースを見積もったか？
- [ ] タイムラインを設定したか？
