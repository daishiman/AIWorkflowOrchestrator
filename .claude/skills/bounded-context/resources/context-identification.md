# コンテキストの特定方法

## 概要

境界付けられたコンテキストを適切に特定することは、DDDの成功に不可欠です。
このドキュメントでは、コンテキストを発見・特定するための実践的な手法を解説します。

## コンテキスト特定の手法

### 1. 言語の境界を見つける

**最も重要な指標**: 同じ用語が異なる意味を持つ場所

```
例: 「顧客」という用語

販売コンテキスト:
  - 購入履歴を持つ
  - 支払い方法を管理
  - ポイントを蓄積

サポートコンテキスト:
  - サポートチケットを発行
  - 満足度スコアを持つ
  - 優先度レベルを持つ

配送コンテキスト:
  - 配送先住所のみ重要
  - 配送履歴を管理
  - 在宅時間の希望
```

**発見方法**:
1. ドメインエキスパートとの会話で用語の違いに注目
2. 「その文脈では○○はどういう意味ですか？」と質問
3. 同じ用語が異なる属性を持つ場合を記録

### 2. イベントストーミング

**手法**: ドメインイベントを洗い出し、境界を発見

**プロセス**:
1. オレンジ色の付箋にドメインイベントを書き出す
   - 「注文が確定された」
   - 「支払いが完了した」
   - 「商品が出荷された」

2. イベントを時系列に並べる

3. イベントのグループを特定
   - 関連するイベントをまとめる
   - 責任を持つアクターを特定

4. グループ間の境界を見つける
   - イベントの流れが変わる場所
   - 異なるチームが関与する場所

```
┌─────────────────────────────────────────────────────────────┐
│ 販売コンテキスト                                             │
│ ┌─────────┐   ┌─────────┐   ┌─────────┐                    │
│ │カートに  │→│注文が   │→│支払いが │                    │
│ │追加された│   │確定された│   │完了した │                    │
│ └─────────┘   └─────────┘   └────┬────┘                    │
└───────────────────────────────────┼────────────────────────┘
                                    │ ← コンテキスト境界
┌───────────────────────────────────┼────────────────────────┐
│ 配送コンテキスト                   ↓                        │
│ ┌─────────┐   ┌─────────┐   ┌─────────┐                    │
│ │出荷指示が│→│商品が   │→│配達が   │                    │
│ │作成された│   │出荷された│   │完了した │                    │
│ └─────────┘   └─────────┘   └─────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

### 3. ビジネスケイパビリティ分析

**手法**: ビジネスが提供する能力を分析

**ステップ**:
1. ビジネスケイパビリティをリストアップ
   - 販売管理
   - 顧客管理
   - 在庫管理
   - 配送管理
   - 請求管理

2. 各ケイパビリティの責任を明確化
   - データオーナーシップ
   - プロセスオーナーシップ
   - 意思決定権限

3. ケイパビリティ間の関係を分析
   - 依存関係
   - データフロー
   - コミュニケーションパターン

### 4. 組織構造の分析

**手法**: チームや部門の境界を参考にする（コンウェイの法則）

```
組織構造:
├── 営業部
│   └── → 販売コンテキスト
├── 物流部
│   └── → 配送コンテキスト
├── カスタマーサポート部
│   └── → サポートコンテキスト
└── 経理部
    └── → 請求コンテキスト
```

**注意点**:
- 組織構造が必ずしも最適な境界とは限らない
- ドメインの境界を優先し、必要なら組織を調整
- しかし現実的には組織との整合性も重要

### 5. データのライフサイクル分析

**手法**: データの作成・更新・削除のパターンを分析

**観点**:
- 誰がデータを作成するか？
- 誰がデータを更新するか？
- データの整合性要件は？
- データの保持期間は？

```
例: 注文データのライフサイクル

販売コンテキスト:
  - 作成: 顧客による注文
  - 更新: 支払い状況、キャンセル
  - 削除: 通常は削除しない（論理削除）

配送コンテキスト:
  - 参照: 配送に必要な情報のみ
  - 独自データ: 配送ステータス、追跡情報

分析コンテキスト:
  - 参照: 集計・統計のため
  - 形式: 非正規化されたデータ
```

## コンテキスト境界の判断基準

### 分割すべき兆候

| 兆候 | 説明 |
|-----|------|
| 用語の衝突 | 同じ用語が異なる意味を持つ |
| 異なる変更理由 | 別々のビジネス要因で変更される |
| 異なるチーム | 別のチームが責任を持つ |
| 異なるスケール要件 | パフォーマンス要件が大きく異なる |
| 異なるリリースサイクル | デプロイの頻度やタイミングが異なる |

### 分割すべきでない兆候

| 兆候 | 説明 |
|-----|------|
| 強いトランザクション結合 | 同一トランザクションでの更新が必要 |
| 密結合したモデル | 常に一緒に変更される |
| 小さすぎる境界 | 独立した意味を持たない |
| 人工的な分割 | ビジネス上の意味がない |

## 実践的なワークショップ

### ステップ1: ドメインイベントの洗い出し（30分）

```
参加者: ドメインエキスパート、開発者
準備物: 付箋、ホワイトボード

1. 「システムで何が起こりますか？」と質問
2. 過去形でイベントを書き出す
   - 「注文が作成された」
   - 「支払いが処理された」
   - 「商品が出荷された」
3. すべてのイベントを壁に貼る
```

### ステップ2: イベントのグループ化（20分）

```
1. 関連するイベントを近くに配置
2. 自然なグループを見つける
3. グループに名前を付ける
4. グループ間の関係を線で結ぶ
```

### ステップ3: 境界の議論（30分）

```
1. 各グループの境界を検討
2. 質問する:
   - 「このイベントはどのグループに属しますか？」
   - 「この2つのグループは別々であるべきですか？」
   - 「この境界を越えるときに何が起こりますか？」
3. 境界を明確な線で示す
```

### ステップ4: 検証（20分）

```
1. 各コンテキストの責任を確認
2. チーム編成との整合性を確認
3. 技術的な制約を考慮
4. 最終的な境界を合意
```

## チェックリスト

### コンテキスト境界の検証

- [ ] 用語の意味がコンテキスト内で一貫しているか？
- [ ] 独立して変更・デプロイできるか？
- [ ] チームが明確に責任を持てるか？
- [ ] 過度に小さくなっていないか？
- [ ] ビジネス上の意味があるか？
- [ ] データのオーナーシップが明確か？
