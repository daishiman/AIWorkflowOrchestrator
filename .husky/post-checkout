#!/bin/sh
# post-checkout ãƒ•ãƒƒã‚¯
# worktreeãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚ã«LaunchServicesã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢

# HooksãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
[ -n "$HUSKY" ] || exit 0

# macOSã®ã¿ã§å®Ÿè¡Œ
if [ "$(uname)" != "Darwin" ]; then
  exit 0
fi

# worktreeã‹ã©ã†ã‹ã‚’ç¢ºèª
if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  WORKTREE_ROOT=$(git rev-parse --show-toplevel)

  # .worktreesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã‹ã©ã†ã‹ã‚’ç¢ºèª
  if echo "$WORKTREE_ROOT" | grep -q ".worktrees"; then
    echo "ğŸ”§ [post-checkout] Worktree detected, clearing LaunchServices cache..."

    # LaunchServicesã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã€ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
    /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -kill -r -domain local -domain system -domain user > /dev/null 2>&1 &

    # .envã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ç¢ºèªãƒ»ä½œæˆ
    PROJECT_ROOT=$(cd "$WORKTREE_ROOT/../.." && pwd)
    if [ ! -L "$WORKTREE_ROOT/apps/desktop/.env" ] && [ -f "$PROJECT_ROOT/.env" ]; then
      echo "ğŸ”§ [post-checkout] Creating .env symlink..."
      ln -sf "$PROJECT_ROOT/.env" "$WORKTREE_ROOT/apps/desktop/.env"
    fi

    echo "âœ… [post-checkout] Worktree setup complete"
  fi
fi
