#!/bin/sh
# pre-push hook: ãƒ—ãƒƒã‚·ãƒ¥å‰ã«CIç›¸å½“ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
# --no-verify ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½

echo "ğŸ” Running pre-push CI validation..."

# é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ã§æ¤œè¨¼ï¼ˆãƒ“ãƒ«ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
# ãƒ•ãƒ«ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆã¯ ./scripts/validate-ci.sh ã‚’ç›´æ¥å®Ÿè¡Œ

# 1. Lint ãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Checking lint..."
if ! pnpm lint; then
    echo "âŒ Lint failed. Push aborted."
    echo "ğŸ’¡ Fix lint errors or use 'git push --no-verify' to skip."
    exit 1
fi

# 2. TypeScript å‹ãƒã‚§ãƒƒã‚¯
echo "ğŸ”§ Checking types..."
if ! pnpm --filter @repo/shared build > /dev/null 2>&1; then
    echo "âŒ Shared package build failed. Push aborted."
    exit 1
fi

if ! pnpm typecheck; then
    echo "âŒ Type check failed. Push aborted."
    echo "ğŸ’¡ Fix type errors or use 'git push --no-verify' to skip."
    exit 1
fi

# 3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
echo "ğŸ§ª Running tests..."
if ! pnpm --filter @repo/shared test:run && pnpm --filter @repo/desktop test:run; then
    echo "âŒ Tests failed. Push aborted."
    echo "ğŸ’¡ Fix failing tests or use 'git push --no-verify' to skip."
    exit 1
fi

echo "âœ… All pre-push checks passed!"
